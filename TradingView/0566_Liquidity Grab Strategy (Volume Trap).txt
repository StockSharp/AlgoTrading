//@version=5
strategy("Liquidity Grab Strategy (Volume Trap)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// === INPUTS ===
volLength = input.int(20, title="Volume MA Length")
volFlatThreshold = input.float(0.05, title="Max Volume Deviation (%)")
fvgLookback = input.int(3, title="FVG Lookback Bars")

// === VOLUME CONDITIONS ===
vol = volume
volMA = ta.sma(vol, volLength)
volFlat = math.abs(vol - volMA) / volMA < volFlatThreshold

// === LIQUIDITY GRAB CONDITIONS ===
isBearishBreak = close[1] > close[2] and close < close[1] and close < low[1] and close[1] < close[2]
liquidityGrab = isBearishBreak and volFlat

// === FAIR VALUE GAP LOGIC ===
fvgTop = high[1]
fvgBottom = low[2]
fvgExists = close[2] < open[1] and close > fvgTop and liquidityGrab

// === ENTRY, SL, TP ===
entryPrice = fvgBottom
stopLoss   = fvgBottom - (fvgTop - fvgBottom)
takeProfit = high[1]

// === PLOT LEVELS FOR VISUAL BACKTESTING ===
plotshape(fvgExists, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plot(entryPrice, title="Entry Price", color=color.green, linewidth=1, style=plot.style_linebr)
plot(stopLoss, title="Stop Loss", color=color.red, linewidth=1, style=plot.style_linebr)
plot(takeProfit, title="Take Profit", color=color.blue, linewidth=1, style=plot.style_linebr)

// === STRATEGY TRADE EXECUTION ===
if fvgExists
    strategy.entry("Long", strategy.long, limit=entryPrice)
    strategy.exit("TP/SL", from_entry="Long", limit=takeProfit, stop=stopLoss)