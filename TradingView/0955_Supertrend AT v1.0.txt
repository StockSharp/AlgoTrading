// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TradingFactory_

//@version=6
strategy("Supertrend AT v1.0", overlay=true, fill_orders_on_standard_ohlc = true,
 commission_value = 0.05, commission_type = strategy.commission.percent,
 default_qty_type = strategy.percent_of_equity, default_qty_value = 100,
 process_orders_on_close = true,
 margin_long = 0.1, margin_short = 0.1,
 pyramiding = 1)
import TradingView/ta/10

//input
start_time = input.time(timestamp("2000-01-01 09:00 +09:00"), title = "START", group = "Auto Trade Setting", display = display.none)
end_time = input.time(timestamp("2099-12-31 09:00 +09:00"), title = "END", group = "Auto Trade Setting", display = display.none)
commission_value = input.float(0.05, title = "commission(%)", group = "Auto Trade Setting", tooltip = "Please enter the same commission in the properties tab.\nì†ì„±íƒ­ì— ì»¤ë¯¸ì…˜ë„ ë™ì¼í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.", display = display.none)/100
round = input.int(4, title = "market decimal place", group = "Auto Trade Setting", tooltip = "If the minimum trading unit of the exchange is '0.0001', it is 4, and if it is '0.001', it is 3.\nê±°ë˜ì†Œì˜ ìµœì†Œ ê±°ë˜ ë‹¨ìœ„ê°€ '0.0001'ì´ë©´ 4ì´ê³ , '0.001'ì´ë©´ 3ì…ë‹ˆë‹¤.", display = display.none)
RPT = input.float(2, title = "RPT(%)", group = "Auto Trade Setting", tooltip = "Risk per transaction, reduction ratio to total capital to bear losses in one transaction\nê±°ë˜ë‹¹ ìœ„í—˜, 1íšŒ ê±°ë˜ì‹œ ì†í•´ë¥¼ ê°ìˆ˜í•  ì „ì²´ ìë³¸ì— ëŒ€í•œ ê°ì†Œ ë¹„ìœ¨")/100
RR = input.float(3, title = "RR", group = "Auto Trade Setting", step = 0.1, tooltip = "Profit and Loss ratio, the ratio of profits to losses\nì†ìµë¹„, ì†í•´ê¸ˆì— ëŒ€í•œ ìµì ˆê¸ˆì˜ ë¹„ìœ¨")
Long = input.bool(true, title = "LONG POSITION /", group = "Auto Trade Setting", inline = "1")
Short = input.bool(false, title = "SHORT POSITION", group = "Auto Trade Setting", inline = "1")

supertrend_factor = input.float(3, title = "Factor", display = display.none, group = "Supertrend", inline = "1")
supertrend_length = input.int(10, title = "Length", display = display.none, group = "Supertrend", inline = "1")

show_readme = input.bool(false, title = "Show Guide", group = "ETC..", inline = "readme")
guide_language = input.string("English", title = "", options = ["English","í•œêµ­ì–´"], group = "ETC..", inline = "readme", display = display.none)
English = guide_language == "English"

//variable
var float long_stop = na
var float short_stop = na

var float entry_price = na
var float stop_price = na
var float target_prcie = na

//indicator
[supertrend, dir] = ta.supertrend(supertrend_factor, supertrend_length)

if dir > 0
    if na(long_stop)
        long_stop := low
    else if low < long_stop
        long_stop := low
else
    long_stop := na

if dir < 0
    if na(short_stop)
        short_stop := high
    else if high > short_stop
        short_stop := high
else
    short_stop := na

//strategy
if time >= start_time and time < end_time
    if strategy.opentrades == 0
        stop_price := na
        target_prcie := na
        entry_price := na

    if dir < 0 and dir[1] > 0 and strategy.opentrades == 0 and Long
        qty = math.round((strategy.equity * RPT) / ((close - long_stop[1]) + (close + long_stop[1]) * commission_value), round)
        limit = (strategy.equity * RPT * RR / qty + close * (1 + commission_value)) / (1 - commission_value)
        stop_price := long_stop[1]
        target_prcie := limit
        entry_price := close
        strategy.entry("Long", strategy.long, comment = English ? "LONG Entry" : "ë¡± ì§„ì…", qty = qty)
        strategy.exit("Long_Exit", "Long", limit = limit, stop = long_stop[1], comment_profit = English ? "LONG Profit" : "ë¡± ìµì ˆ", comment_loss = English ? "LONG Loss" : "ë¡± ì†ì ˆ")


    if dir > 0 and dir[1] < 0 and strategy.opentrades == 0 and Short
        qty = math.round(strategy.equity * RPT / ((short_stop[1] - close) + (close + short_stop[1]) * commission_value), round)
        limit = (close * (1 - commission_value) - strategy.equity * RPT * RR / qty) / (1 + commission_value)
        stop_price := short_stop[1]
        target_prcie := limit
        entry_price := close
        strategy.entry("Short", strategy.short, qty = qty, comment = English ? "SHORT Entry" : "ìˆ ì§„ì…")
        strategy.exit("Short_Exit","Short", limit = limit, stop = short_stop[1], comment_profit = English ? "SHORT Profit" : "ìˆ ìµì ˆ", comment_loss = English ? "SHORT Loss" : "ìˆ ì†ì ˆ")

if time >= end_time and time[1] < end_time
    alert("Auto Trade Termination", freq = alert.freq_once_per_bar)

//plot
plot(dir > 0 ? supertrend : na, color = color.rgb(255, 0, 0), style = plot.style_linebr, display = display.pane, linewidth = 2, title = "Down trend")
plot(dir < 0 ? supertrend : na, color = color.rgb(0, 255, 0), style = plot.style_linebr, display = display.pane, linewidth = 2, title = 'Up trend')

plot(entry_price, title = "Entry Price", color = color.yellow, style = plot.style_steplinebr)
plot(target_prcie, title = "Target Price", color = color.green, style = plot.style_steplinebr)
plot(stop_price, title = "Stop Price", color = color.red, style = plot.style_steplinebr)

//label
var label target_label = label.new(na, na, English ? "Target Price" : "ëª©í‘œê°€", style = label.style_label_left, color = color.rgb(0,0,0,100), size = size.small, textcolor = color.green)
var label entry_label = label.new(na, na, English ? "Entry Price" : "ì§„ì…ê°€", style = label.style_label_left, color = color.rgb(0,0,0,100), size = size.small, textcolor = color.yellow)
var label stop_label = label.new(na, na, English ? "Stop Price" : "ì†ì ˆê°€", style = label.style_label_left, color = color.rgb(0,0,0,100), size = size.small, textcolor = color.red)

label.set_xy(target_label, bar_index, target_prcie)
label.set_xy(entry_label, bar_index, entry_price)
label.set_xy(stop_label, bar_index, stop_price)

//table
var table info = table.new(position = position.bottom_right, columns = 2, rows = 2, frame_width = 2, border_width = 2)
table.cell(info, 0, 0, text = English ? "Current Open Profit" : "í˜„ì¬ í¬ì§€ì…˜ ì´ìµ", text_color = chart.fg_color, text_halign = text.align_right)
table.cell(info, 1, 0, text = str.tostring(math.round(strategy.openprofit, 4)), text_color = strategy.openprofit > 0 ? color.green : color.red, text_halign = text.align_left)
table.cell(info, 0, 1, text = English ? "Current Equity" : "í˜„ì¬ ìë³¸ê°€ì¹˜", text_color = chart.fg_color, text_halign = text.align_right)
table.cell(info, 1, 1, text = str.tostring(math.round(strategy.equity, 4)), text_color = chart.fg_color, text_halign = text.align_left)

if show_readme
    var table readme = table.new(position = position.middle_right, columns = 1, rows = 10, bgcolor = color.white, border_width = 2, border_color = color.black)

    text_readme = English ? "Guide" : "ì„¤ëª…ì„œ"

    text_terminology_1 = English ? "ğŸ“˜Term\n\n" : "ğŸ“˜ìš©ì–´\n\n"
    text_terminology_2 = English ? "RPT : Risk per transaction, reduction ratio to total capital to bear losses in one transaction\n" : "RPT : ê±°ë˜ë‹¹ ìœ„í—˜, 1íšŒ ê±°ë˜ì‹œ ì†í•´ë¥¼ ê°ìˆ˜í•  ì „ì²´ ìë³¸ì— ëŒ€í•œ ê°ì†Œ ë¹„ìœ¨\n"
    text_terminology_3 = English ? "RR : Profit and Loss ratio, the ratio of profits to losses" : "RR : ì†ìµë¹„, ì†í•´ê¸ˆì— ëŒ€í•œ ìµì ˆê¸ˆì˜ ë¹„ìœ¨"

    text_strategy_1 = English ? "ğŸ“•Strategy Overview\n\n" : "ğŸ“•ì „ëµ ê°œìš”\n\n"
    text_strategy_2 = English ? "This strategy is an entry strategy in the event of a trend shift based on the 'Supertrend' auxiliary indicator.\n" : "ì´ ì „ëµì€ 'Supertrend' ë³´ì¡°ì§€í‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì¶”ì„¸ ì „í™˜ ì‹œ ì§„ì… ì „ëµì…ë‹ˆë‹¤.\n"
    text_strategy_3 = English ? "  â— Entering LONG position when Supertrend Turns From Downward To Upward\n" : "  â— Supertrendê°€ í•˜ë½ì¶”ì„¸ì—ì„œ ìƒìŠ¹ì¶”ì„¸ë¡œ ì „í™˜ë  ë•Œ LONG í¬ì§€ì…˜ ì§„ì…\n"
    text_strategy_4 = English ? "  â— Entering Short Position When Supertrend Turns From Upward To Downward\n" : "  â— Supertrendê°€ ìƒìŠ¹ì¶”ì„¸ì—ì„œ í•˜ë½ì¶”ì„¸ìœ¼ë¡œ ì „í™˜ë  ë•Œ ìˆ í¬ì§€ì…˜ ì§„ì…\n"
    text_strategy_5 = English ? "Losses and profits are set according to the specified profit and loss ratio and the stop level based on the previous Supertrend." : "ì†ì ˆê³¼ ìµì ˆì€ ì§€ì •ëœ ì†ìµë¹„ ë° ì§ì „ Supertrend ê¸°ì¤€ ìŠ¤íƒ‘ ë ˆë²¨ì— ë”°ë¼ ì„¤ì •ë©ë‹ˆë‹¤."

    //text_readme_4 = "\nâ—† "
    text_readme_1 = English ? "ğŸ“—Read!\n\n" : "ğŸ“—ì½ì–´ë³´ì„¸ìš”!\n\n"
    text_readme_2 = English ? "â—† The entry quantity is calculated to be equal to the total asset * risk per transaction in the event of a loss (including transaction fees)\n" : "â—† ì§„ì… ìˆ˜ëŸ‰ì€ ì†ì ˆì‹œ ì „ì²´ ìì‚° * ê±°ë˜ë‹¹ ìœ„í—˜ë§Œí¼ì˜ ì†í•´ê°€ ë˜ë„ë¡ ê³„ì‚°ë©ë‹ˆë‹¤.(ê±°ë˜ ìˆ˜ìˆ˜ë£Œ í¬í•¨í•˜ì—¬ ê³„ì‚°)\n"
    text_readme_3 = English ? "â—† The target price is calculated based on the actual loss and profit/loss ratio (including transaction fees), not on the price difference" : "â—† ëª©í‘œê°€ëŠ” ê°€ê²© ì°¨ì´ê°€ ì•„ë‹Œ, ì‹¤ì œ ì†í•´ê¸ˆì™€ ì‹¤ì œ ìˆ˜ìµê¸ˆì˜ ì†ìµë¹„ì— ë§ì¶”ì–´ ê³„ì‚°ë©ë‹ˆë‹¤.(ê±°ë˜ìˆ˜ìˆ˜ë£Œí¬í•¨)"
    text_readme_4 = English ? "\nâ—† Please set it up well because it includes calculations considering exchange fees! (Check input tab, properties tab)" : "\nâ—† ê±°ë˜ì†Œ ìˆ˜ìˆ˜ë£Œë¥¼ ê³ ë ¤í•œ ê³„ì‚°ì´ í¬í•¨ë˜ì–´ ìˆê¸°ë•Œë¬¸ì— ì„¤ì •ì„ ì˜í•´ì£¼ì„¸ìš”!(ì¸í’‹íƒ­, ì†ì„±íƒ­ í™•ì¸)"
    text_readme_5 = English ? "\nâ—† In automatic transactions, you need to accurately match the number of decimal places on the exchange to operate normally." : "\nâ—† ìë™ë§¤ë§¤ì‹œì—ëŠ” ê±°ë˜ì†Œ ì†Œìˆ˜ì  ìë¦¬ìˆ˜ë¥¼ ì •í™•íˆ ë§ì¶°ì£¼ì…”ì•¼ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤."
    text_readme_6 = English ? "\n     â”” If the signal quantity is less than the minimum unit of the exchange, the exchange recognizes it as an error." : "\n    â”” ì‹œê·¸ë„ ìˆ˜ëŸ‰ì´ ê±°ë˜ì†Œ ìµœì†Œë‹¨ìœ„ë³´ë‹¤ ì‘ì€ ê²½ìš° ê±°ë˜ì†Œì—ì„œ ì˜¤ë¥˜ë¡œ ì¸ì‹í•©ë‹ˆë‹¤."

    table.cell(readme, 0, 0, text = text_readme, text_color = color.rgb(0, 0, 0), text_halign = text.align_center, text_valign = text.align_center, text_formatting = text.format_bold)
    table.cell(readme, 0, 1, text = text_terminology_1+text_terminology_2+text_terminology_3, text_color = color.rgb(0, 0, 0), text_halign = text.align_left)
    table.cell(readme, 0, 2, text = text_strategy_1+text_strategy_2+text_strategy_3+text_strategy_4+text_strategy_5, text_color = color.rgb(0, 0, 0), text_halign = text.align_left)
    table.cell(readme, 0, 3, text = text_readme_1+text_readme_2+text_readme_3+text_readme_4+text_readme_5+text_readme_6, text_color = color.rgb(0, 0, 0), text_halign = text.align_left)

//Long
//(ì§„ì…ê°€ - ì†ì ˆê°€) * ìˆ˜ëŸ‰ + (ì§„ì…ê°€ + ì†ì ˆê°€) * ìˆ˜ìˆ˜ë£Œ * ìˆ˜ëŸ‰ = ìì‚° * RPT
//((ì§„ì…ê°€ - ì†ì ˆê°€) + (ì§„ì…ê°€ + ì†ì ˆê°€) * ìˆ˜ìˆ˜ë£Œ) * ìˆ˜ëŸ‰ = ìì‚° * RPT
//ìˆ˜ëŸ‰ = ìì‚° * RPT / ((ì§„ì…ê°€ - ì†ì ˆê°€) + (ì§„ì…ê°€ + ì†ì ˆê°€) * ìˆ˜ìˆ˜ë£Œ)

//(ìµì ˆê°€ - ì§„ì…ê°€) * ìˆ˜ëŸ‰ - (ìµì ˆê°€ + ì§„ì…ê°€) * ìˆ˜ìˆ˜ë£Œ * ìˆ˜ëŸ‰ = ìì‚° * RPT * RR
//ìµì ˆê°€ - ì§„ì…ê°€ - ìµì ˆê°€ * ìˆ˜ìˆ˜ë£Œ - ì§„ì…ê°€ * ìˆ˜ìˆ˜ë£Œ = ìì‚° * RPT * RR / ìˆ˜ëŸ‰
//ìµì ˆê°€ * (1 - ìˆ˜ìˆ˜ë£Œ) - ì§„ì…ê°€ * (1 + ìˆ˜ìˆ˜ë£Œ) = ìì‚° * RPT * RR / ìˆ˜ëŸ‰
//ìµì ˆê°€ = (ìì‚° * RPT * RR / ìˆ˜ëŸ‰ + ì§„ì…ê°€ * (1 + ìˆ˜ìˆ˜ë£Œ)) / (1 - ìˆ˜ìˆ˜ë£Œ)


//Short
//(ì†ì ˆê°€ - ì§„ì…ê°€) * ìˆ˜ëŸ‰ + (ì§„ì…ê°€ + ì†ì ˆê°€) * ìˆ˜ìˆ˜ë£Œ * ìˆ˜ëŸ‰ = ìì‚° * RPT
//((ì†ì ˆê°€ - ì§„ì…ê°€) + (ì§„ì…ê°€ + ì†ì ˆê°€) * ìˆ˜ìˆ˜ë£Œ) * ìˆ˜ëŸ‰ = ìì‚° * RPT
//ìˆ˜ëŸ‰ = ìì‚° * RPT / ((ì†ì ˆê°€ - ì§„ì…ê°€) + (ì§„ì…ê°€ + ì†ì ˆê°€) * ìˆ˜ìˆ˜ë£Œ)

//(ì§„ì…ê°€ - ìµì ˆê°€) * ìˆ˜ëŸ‰ - (ì§„ì…ê°€ + ìµì ˆê°€) * ìˆ˜ìˆ˜ë£Œ * ìˆ˜ëŸ‰ = ìì‚° * RPT * RR
//ì§„ì…ê°€ - ìµì ˆê°€ - ì§„ì…ê°€ * ìˆ˜ìˆ˜ë£Œ - ìµì ˆê°€ * ìˆ˜ìˆ˜ë£Œ = ìì‚° * RPT * RR / ìˆ˜ëŸ‰
//ì§„ì…ê°€ * (1-ìˆ˜ìˆ˜ë£Œ) - ìµì ˆê°€*(1 + ìˆ˜ìˆ˜ë£Œ) = ìì‚° * RPT * RR / ìˆ˜ëŸ‰
//ì§„ì…ê°€ * (1-ìˆ˜ìˆ˜ë£Œ) - ìì‚° * RPT * RR / ìˆ˜ëŸ‰ = ìµì ˆê°€*(1 + ìˆ˜ìˆ˜ë£Œ)
//ìµì ˆê°€ = (ì§„ì…ê°€ * (1-ìˆ˜ìˆ˜ë£Œ) - ìì‚° * RPT * RR / ìˆ˜ëŸ‰) / (1 + ìˆ˜ìˆ˜ë£Œ)