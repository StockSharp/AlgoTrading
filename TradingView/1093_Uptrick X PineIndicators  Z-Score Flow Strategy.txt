// This work is licensed under an Attribution-ShareAlike 4.0 International License (CC BY-SA 4.0)
// https://creativecommons.org/licenses/by-sa/4.0/
// © Uptrick X PineIndicators

//@version=6
strategy("Uptrick X PineIndicators: Z-Score Flow Strategy", overlay=true, initial_capital=10000, currency=currency.USD, default_qty_type=strategy.percent_of_equity, default_qty_value=30, pyramiding=0)

// ===== INPUTS from Original Indicator ===== //
zLen            = input.int(100, "Z-Score Period")
emaTrendLen     = input.int(50, "EMA Trend Filter")
rsiLen          = input.int(14, "RSI Length")
rsiEmaLen       = input.int(8, "EMA of RSI Period")
zBuyLevel       = input.float(-2.0, "Z-Score Buy Threshold")
zSellLevel      = input.float(2.0, "Z-Score Sell Threshold")
cooldownBars    = input.int(10, "Cooldown (Bars)")
slopeIndex      = input.int(30, "Slope Sensitivity (Bars)", minval=1)
showMeanLine    = input.bool(true, "Show Z-Score Mean Line")

// ===== CORE CALCULATIONS ===== //
basis       = ta.sma(close, zLen)
stdev       = ta.stdev(close, zLen)
zscore      = (close - basis) / stdev
emaTrend    = ta.ema(close, emaTrendLen)
rsi         = ta.rsi(close, rsiLen)
rsiEma      = ta.ema(rsi, rsiEmaLen)
rsiEmaSlope = rsiEma - rsiEma[1]

isUptrend   = close > emaTrend
isDowntrend = close < emaTrend

// ===== SINGLE-SIGNAL RSI ZONE LOCKOUT ===== //
var bool canBuy  = true
var bool canSell = true

if rsiEma > 30
    canBuy := true
if rsiEma < 70
    canSell := true

rsiBuyConfirm  = rsiEma < 30 and rsiEmaSlope > 0 and canBuy
rsiSellConfirm = rsiEma > 70 and rsiEmaSlope < 0 and canSell

rawBuy  = zscore < zBuyLevel and isDowntrend and rsiBuyConfirm
rawSell = zscore > zSellLevel and isUptrend and rsiSellConfirm

if rawBuy
    canBuy := false
if rawSell
    canSell := false

// ===== COOLDOWN LOGIC ===== //
var int lastBuyBar  = na
var int lastSellBar = na

buySignal  = rawBuy and (na(lastSellBar) or bar_index - lastSellBar > cooldownBars)
sellSignal = rawSell and (na(lastBuyBar) or bar_index - lastBuyBar > cooldownBars)

if buySignal
    lastBuyBar := bar_index
if sellSignal
    lastSellBar := bar_index

// ===== COLOR & PLOTTING DEFINITIONS ===== //
bullColor  = color.rgb(92, 240, 215)       // #5CF0D7
bearColor  = color.rgb(179, 42, 195)       // #B32AC3
flatColor  = color.rgb(136, 136, 136)       // gray

bullShadow = color.rgb(92, 240, 215, 50)
bearShadow = color.rgb(179, 42, 195, 50)
flatShadow = color.new(flatColor, 80)

slopeColor  = basis > basis[slopeIndex] ? bullColor : basis < basis[slopeIndex] ? bearColor : flatColor
shadowColor = basis > basis[slopeIndex] ? bullShadow : basis < basis[slopeIndex] ? bearShadow : flatShadow

// ===== PLOT Z-SCORE MEAN LINE + SHADOW ===== //
plot(showMeanLine ? basis : na, "Z-Mean Shadow", color=shadowColor, linewidth=10)
plot(showMeanLine ? basis : na, "Z-Mean", color=slopeColor, linewidth=2)

// ===== GRADIENT FILL: Z-Mean to Price ===== //
showGradient = input.bool(true, "Show Gradient to Price")

// Define gradient color stops
bullTopColor  = chart.bg_color  // Top = brighter teal
bullBottomColor = #369081f2  // Bottom = almost transparent

bearTopColor  = chart.bg_color  // Top = stronger purple
bearBottomColor = #64176cf2  // Bottom = nearly clear

// Define fill zones
priceAbove = close > basis
priceBelow = close < basis

// Gradient when price is below the mean (bullish zone)
fill(
     plot1=plot(showGradient and priceBelow ? basis : na, title="Bull Basis", display=display.none),
     plot2=plot(showGradient and priceBelow ? close : na, title="Bull Price", display=display.none),
     top_value=close,
     bottom_value=basis,
     top_color=bearTopColor,
     bottom_color=bearBottomColor
 )

// Gradient when price is above the mean (bearish zone)
fill(
     plot1=plot(showGradient and priceAbove ? close : na, title="Bear Price", display=display.none),
     plot2=plot(showGradient and priceAbove ? basis : na, title="Bear Basis", display=display.none),
     top_value=close,
     bottom_value=basis,
     top_color=bullTopColor,
     bottom_color=bullBottomColor
 )

// ===== SIGNAL LABELS ===== //
plotshape(buySignal,
     title="𝓑𝓾𝔂",
     location=location.belowbar,
     color=bullColor,
     style=shape.labelup,
     text="𝓤𝓹",
     textcolor=color.black,
     size=size.small)

plotshape(sellSignal,
     title="𝓢𝓮𝓵𝓵",
     location=location.abovebar,
     color=bearColor,
     style=shape.labeldown,
     text="𝓓𝓸𝔀𝓷",
     textcolor=color.white,
     size=size.small)

// ===== TRADE MANAGEMENT INPUTS ===== //
tradeMode  = input.string("Standard", "Trade Mode", options=["Standard", "Zero Cross", "Trend Reversal"])
enableLong  = input.bool(true, "Enable Long Trades")
enableShort = input.bool(true, "Enable Short Trades")

// ===== STRATEGY ORDER EXECUTION ===== //
if tradeMode == "Standard"
    // Standard mode: use the original signals.
    if enableLong and buySignal
        strategy.entry("Long", strategy.long)
    if enableLong and sellSignal
        strategy.close("Long")

    if enableShort and sellSignal
        strategy.entry("Short", strategy.short)
    if enableShort and buySignal
        strategy.close("Short")
else if tradeMode == "Zero Cross"
    // Zero Cross Mode: trade when the raw z-score crosses 0.
    zeroCrossUp   = ta.crossover(zscore, 0)
    zeroCrossDown = ta.crossunder(zscore, 0)

    if zeroCrossUp
        if enableShort
            strategy.close("Short")
        if enableLong
            strategy.entry("Long", strategy.long)
    if zeroCrossDown
        if enableLong
            strategy.close("Long")
        if enableShort
            strategy.entry("Short", strategy.short)
else if tradeMode == "Trend Reversal"
    // Trend Reversal Mode: trade based on the indicator's color change (from bullish to bearish or vice versa)
    bullishCondition = basis > basis[slopeIndex]
    bearishCondition = basis < basis[slopeIndex]
    trendBullishReversal = bearishCondition[1] and bullishCondition    // War vorher bearish, jetzt bullish.
    trendBearishReversal = bullishCondition[1] and bearishCondition    // War vorher bullish, jetzt bearish.

    if trendBullishReversal
        if enableShort
            strategy.close("Short")
        if enableLong
            strategy.entry("Long", strategy.long)
    if trendBearishReversal
        if enableLong
            strategy.close("Long")
        if enableShort
            strategy.entry("Short", strategy.short)

// ===== ALERTS ===== //
alertcondition(buySignal, title="Buy Alert", message="📈 Z-Score Flow Buy Signal")
alertcondition(sellSignal, title="Sell Alert", message="📉 Z-Score Flow Sell Signal")