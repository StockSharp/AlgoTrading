//@version=6
strategy("15m Asia Gold ORB Strategy [TP/SL Labels + R FIXED]", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

current_year = year(time)
current_month = month(time)
current_day = dayofmonth(time)

// === Time Settings (UTC) ===
asia_start = timestamp("UTC", current_year, current_month, current_day, 0, 0)
asia_end   = timestamp("UTC", current_year, current_month, current_day, 6, 0)
trade_start = timestamp("UTC", current_year, current_month, current_day, 6, 0)
trade_end   = timestamp("UTC", current_year, current_month, current_day, 10, 0)

in_asia = time >= asia_start and time < asia_end
in_trade_time = time >= trade_start and time < trade_end

// === Capture Asia Range ===
var float asia_high = na
var float asia_low = na

if in_asia
    asia_high := na(asia_high) ? high : math.max(asia_high, high)
    asia_low := na(asia_low) ? low : math.min(asia_low, low)
else if not in_asia and not na(asia_high)
    asia_high := na
    asia_low := na

plot(asia_high, color=color.green, title="Asia High")
plot(asia_low, color=color.red, title="Asia Low")

// === Entry Conditions ===
long_condition = close > asia_high and in_trade_time and not na(asia_high)
short_condition = close < asia_low and in_trade_time and not na(asia_low)

// === Risk and Reward ===
range_size = asia_high - asia_low
risk = range_size
reward = range_size * 2

// === Stop Loss / Take Profit Prices ===
long_sl = close - risk
long_tp = close + reward

short_sl = close + risk
short_tp = close - reward

// === Track Direction of Trade ===
var string last_direction = na
var int last_trade_id = na

// === Execute Trades ===
if long_condition
    strategy.entry("Long", strategy.long)
    last_direction := "long"
    strategy.exit("Exit Long", from_entry="Long", stop=long_sl, limit=long_tp)

if short_condition
    strategy.entry("Short", strategy.short)
    last_direction := "short"
    strategy.exit("Exit Short", from_entry="Short", stop=short_sl, limit=short_tp)

// === Entry Markers ===
plotshape(long_condition, title="Long Entry", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plotshape(short_condition, title="Short Entry", location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL")

// === TP/SL Labels with R-multiple ===
var int last_checked_trade_index = na

trade_closed = strategy.closedtrades > 0
current_index = strategy.closedtrades - 1

if trade_closed and (na(last_checked_trade_index) or current_index != last_checked_trade_index)
    profit = strategy.closedtrades.profit(current_index)
    qty = strategy.closedtrades.size(current_index)
    result_r = profit / (risk * qty)
    r_text = str.tostring(result_r, "#.##") + "R"
    label_text = result_r >= 0 ? "TP Hit (" + r_text + ")" : "SL Hit (" + r_text + ")"

    // Place label depending on trade direction
    if last_direction == "long"
        label.new(bar_index, high, label_text, style=label.style_label_down, color=result_r >= 0 ? color.green : color.red, textcolor=color.white, size=size.small)
    else if last_direction == "short"
        label.new(bar_index, low, label_text, style=label.style_label_up, color=result_r >= 0 ? color.green : color.red, textcolor=color.white, size=size.small)

    // Update tracker so we donâ€™t double-label
    last_checked_trade_index := current_index