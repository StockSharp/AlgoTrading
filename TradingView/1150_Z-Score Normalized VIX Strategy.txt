//@version=6
strategy("Z-Score Normalized VIX Strategy", overlay = false, initial_capital=20000, pyramiding=0, commission_type=strategy.commission.cash_per_contract, commission_value=0.05, slippage=1)

// Z-Score function
zscore(src, length) =>
    mean = ta.sma(src, length)
    std = ta.stdev(src, length)
    std != 0 ? (src - mean) / std : 0

// Inputs
zscore_length = input.int(6, title = "Z-Score Lookback Period for VIX")
threshold = input.float(1, title = "Z-Score Threshold for Entry", step = 0.1)

// Checkbox Inputs for VIX Indices
use_vix = input.bool(true, title = "Use VIX")
use_vix3m = input.bool(true, title = "Use VIX3M")
use_vix9d = input.bool(true, title = "Use VIX9D")
use_vvix = input.bool(true, title = "Use VVIX")

// Volatility indices with lookahead bias protection
vix   = request.security("CBOE:VIX", "D", close, barmerge.gaps_off, barmerge.lookahead_off)
vix3m = request.security("CBOE:VIX3M", "D", close, barmerge.gaps_off, barmerge.lookahead_off)
vix9d = request.security("CBOE:VIX9D", "D", close, barmerge.gaps_off, barmerge.lookahead_off)
vvix  = request.security("CBOE:VVIX", "D", close, barmerge.gaps_off, barmerge.lookahead_off)

// Z-Score Normalization for selected indices
z_vix   = use_vix   ? zscore(vix, zscore_length)   : na
z_vix3m = use_vix3m ? zscore(vix3m, zscore_length) : na
z_vix9d = use_vix9d ? zscore(vix9d, zscore_length) : na
z_vvix  = use_vvix  ? zscore(vvix, zscore_length)  : na

// Calculate combined Z-Score correctly
float zscore_sum = 0
int count = 0

// Add each z-score to the sum if it's selected and valid
if use_vix and not na(z_vix)
    zscore_sum := zscore_sum + z_vix
    count := count + 1
if use_vix3m and not na(z_vix3m)
    zscore_sum := zscore_sum + z_vix3m
    count := count + 1
if use_vix9d and not na(z_vix9d)
    zscore_sum := zscore_sum + z_vix9d
    count := count + 1
if use_vvix and not na(z_vvix)
    zscore_sum := zscore_sum + z_vvix
    count := count + 1

// Calculate the combined Z-Score if count > 0
float combined_zscore = count > 0 ? zscore_sum / count : na

// Entry Condition: Long when the Z-Score is below the threshold
long_condition = not na(combined_zscore) and combined_zscore < -threshold  // Negativ fÃ¼r bearish VIX, bullish Markt

// Exit Condition: Close the position when the Z-Score exceeds the threshold
exit_condition = not na(combined_zscore) and combined_zscore > -threshold

// Execute the Strategy
if long_condition
    strategy.entry("Long", strategy.long)

if exit_condition
    strategy.close("Long")

// Plotting the combined Z-Score
plot(combined_zscore, title = "Combined Z-Score", color = color.rgb(0, 128, 255), linewidth = 2)

// Line
hline(threshold, "Short Threshold", color = color.rgb(255, 0, 0), linestyle = hline.style_dashed)