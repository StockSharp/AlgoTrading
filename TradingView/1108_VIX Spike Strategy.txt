//@version=6
strategy("VIX Spike Strategy", overlay=false, initial_capital=20000, pyramiding=0, commission_type=strategy.commission.cash_per_contract, commission_value=0.05, slippage=1)

// --- Parameters ---
vix_symbol = input.symbol("CBOE:VIX", "VIX Symbol")  // Symbol for the VIX
stddev_length = input.int(15, title="Standard Deviation Length", minval=1)  // Length for calculating standard deviation
stddev_multiple = input.float(2.0, title="Standard Deviation Multiplier", minval=0.1, step=0.1)  // Multiplier for standard deviation
exit_periods = input.int(10, title="Exit Periods", minval=1)  // Number of periods after which to exit

// --- Data Loading ---
vix_rescaled = request.security(vix_symbol, timeframe.period, close)  // VIX data rescaled to the current timeframe

// --- Calculate VIX Standard Deviation ---
vix_stddev = ta.stdev(vix_rescaled, stddev_length)  // Calculate the standard deviation of the VIX over the specified period
vix_mean = ta.sma(vix_rescaled, stddev_length)  // Calculate the moving average of the VIX over the same period

// --- Entry Condition: VIX exceeds a certain number of standard deviations ---
long_entry_condition = vix_rescaled > (vix_mean + stddev_multiple * vix_stddev)  // VIX must be above the mean plus the multiple of the standard deviation

// --- Position Counter ---
var float entry_bar = na  // Variable to store the entry bar index

if long_entry_condition and strategy.position_size <= 0
    strategy.entry("Long SP500", strategy.long)  // Enter a long position with the maximum position size
    entry_bar := bar_index  // Set the entry bar index to the current bar

// Exit after the specified number of periods
exit_after_periods = na(entry_bar) ? false : (bar_index - entry_bar >= exit_periods)

if exit_after_periods
    strategy.close("Long SP500", comment="Exit after X periods")

// --- Visualization ---
plot(vix_rescaled, color=color.blue, title="VIX (Rescaled Timeframe)")  // Plot VIX in blue
plot(vix_mean, color=color.orange, title="VIX Moving Average (Rescaled Timeframe)")  // Plot VIX moving average in orange
plot(vix_mean + stddev_multiple * vix_stddev, color=color.red, title="VIX + X StdDev", linewidth=2)  // Plot VIX + standard deviation threshold in red
bgcolor(long_entry_condition ? color.new(color.green, 0) : na, title="Long Entry Background")  // Highlight background when entry condition is met