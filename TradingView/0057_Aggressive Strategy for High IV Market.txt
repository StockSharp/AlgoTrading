//@version=6
strategy("Aggressive Strategy for High IV Market", overlay=true)

// 用户输入
ema_fast_length = input.int(10, title="Fast EMA Length")
ema_slow_length = input.int(30, title="Slow EMA Length")
atr_length = input.int(14, title="ATR Length")
atr_mean_length = input.int(20, title="ATR Mean Length")
atr_std_length = input.int(20, title="ATR Std Dev Length")
risk_factor = input.float(0.01, title="Risk Factor")  // 单笔交易风险占账户资金的百分比
slippage = input.float(0.001, title="Slippage") // 假设滑点

// 计算EMA、ATR、均值、标准差
ema_fast = ta.ema(close, ema_fast_length)
ema_slow = ta.ema(close, ema_slow_length)
atr_value = ta.atr(atr_length)
atr_mean = ta.sma(atr_value, atr_mean_length)
atr_std = ta.stdev(atr_value, atr_std_length)

// 进场条件
long_condition = ta.crossover(ema_fast, ema_slow) and atr_value > (atr_mean + atr_std)
short_condition = ta.crossunder(ema_fast, ema_slow) and atr_value > (atr_mean + atr_std)

// 止损与止盈设置
long_stop_loss = close - 2 * atr_value  // 基于ATR的止损
long_take_profit = close + 4 * atr_value  // 基于ATR的止盈
short_stop_loss = close + 2 * atr_value  // 基于ATR的止损
short_take_profit = close - 4 * atr_value  // 基于ATR的止盈

// 动态仓位控制
position_size_calc = (strategy.equity * risk_factor) / (2 * atr_value)
position_size = math.min(position_size_calc, strategy.equity)  // 限制仓位不能大于账户总值

// 进场与出场信号
if (long_condition)
    strategy.entry("Long", strategy.long, qty=position_size)

if (short_condition)
    strategy.entry("Short", strategy.short, qty=position_size)

// 止损与止盈
strategy.exit("Take Profit/Stop Loss Long", "Long", stop=long_stop_loss, limit=long_take_profit)
strategy.exit("Take Profit/Stop Loss Short", "Short", stop=short_stop_loss, limit=short_take_profit)

// 绘制图表
plot(ema_fast, title="Fast EMA", color=color.blue, linewidth=2)
plot(ema_slow, title="Slow EMA", color=color.orange, linewidth=2)
plot(long_stop_loss, title="Long Stop Loss", color=color.red, linewidth=1, style=plot.style_line)
plot(long_take_profit, title="Long Take Profit", color=color.green, linewidth=1, style=plot.style_line)
plot(short_stop_loss, title="Short Stop Loss", color=color.red, linewidth=1, style=plot.style_line)
plot(short_take_profit, title="Short Take Profit", color=color.green, linewidth=1, style=plot.style_line)

// 显示信号
bgcolor(long_condition ? color.new(color.green, 90) : na, title="Long Signal Background")
bgcolor(short_condition ? color.new(color.red, 90) : na, title="Short Signal Background")