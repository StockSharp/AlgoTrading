// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© minusminus
//@version=5
strategy("Monthly Purchase Strategy with Dynamic Contract Size ", overlay=false, precision=0, calc_on_every_tick=true, initial_capital=10000, currency=currency.USD, slippage=1, commission_type=strategy.commission.cash_per_order, commission_value=5)

// Inputs
startDate = input.time(timestamp("2010-01-01 00:00"), title="Start Date")
percentOfEquity = input.float(0.03, title="Percentage of Equity per Purchase", minval=0.01, maxval=10, step=0.01) // Percentage of equity used for each purchase
buyDay = input.int(1, title="Buy Day of the Month")

// Calculations
var float highestEquity = na

// Update the highest equity value
if na(highestEquity) or strategy.equity > highestEquity
    highestEquity := strategy.equity

// Calculate the drawdown
drawdown = (highestEquity - strategy.equity) / highestEquity * 100

// Query the current date
currentMonth = month(time)

// Check if the current date is after the start date
isAfterStartDate = time >= startDate

// Calculate the contract size based on the percentage of equity
contractValue = strategy.equity * percentOfEquity
contractSize = int(contractValue / close)  // Contract size as an integer division

// Buy every month on the defined day
if isAfterStartDate and (dayofmonth(time) == buyDay)
    if contractSize > 0
        strategy.order("Buy", strategy.long, qty=contractSize)

// Plot the equity curve
plot(strategy.equity, title="Equity Curve", color=color.green, linewidth=2)

// Plot the drawdown as a negative bar chart
plot(-drawdown, title="Drawdown", color=color.red, style=plot.style_columns, linewidth=1, display=display.none)