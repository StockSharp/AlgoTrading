// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © DNSE

//@version=5
strategy(title = "DNSE VN301! SMA & EMA Cross Strategy", shorttitle = "VN301! Signals_DNSE S1", overlay = true, slippage = 1, backtest_fill_limits_assumption = 1, initial_capital = 100000000, default_qty_type = strategy.fixed, default_qty_value = 4, commission_type = strategy.commission.cash_per_order, commission_value = 2700, fill_orders_on_standard_ohlc = true, calc_on_order_fills = true, process_orders_on_close = true)

//Settings explaination: (Backtest) Contract code = VN301!, capital = 100M VND, constant order size = 4 contracts, min commission = 2,700VND/contract
//  Accounted for slippage of 1 tick for a more robust back-test result
//Giải thích setting: Mã HĐ Backtest = VN301!, vốn 100tr VND, mỗi lệnh vào 4 HĐ, phí tối thiểu = 2,700/HĐ
//  Trượt giá (Slippage) = 1 tick để kết quả back-test thực tế hơn

// Indicators, plotting SMA and EMA
// Vẽ đường EMA và SMA
float sma60 = ta.sma(close, 60)
float ema15 = ta.ema(close, 15)
plot(sma60, title = "SMA 60", color = color.white, linewidth = 1)
plot(ema15, title = "EMA 15", color = color.yellow, linewidth = 1)

// Input time settings, ensuring all orders are closed by 14:30, cut-off 5 minutes before continuous-trading session end.
// Tạo thêm điều kiện về thời gian, đảm bảo các vị thế được đóng hết trước 14:30, đóng lệnh 5 phút trước khi hết phiên khớp lệnh liên tục.
session_close_hour = input.int(14, title = "Session Close Hour (24-hour format)")
session_close_minute = input.int(30, title = "Session Close Minute")
minutes_before_close = input.int(5, title = "Minutes Before Session Close to Exit")
exit_hour = session_close_hour
exit_minute = session_close_minute - minutes_before_close
exit_hour := exit_minute < 0 ? exit_hour - 1 : exit_hour
exit_minute := exit_minute < 0 ? exit_minute + 60 : exit_minute
cutoff_time = (hour > exit_hour) or (hour == exit_hour and minute >= exit_minute)

// Long/Short Signals Generation Conditions
// Điều kiện để tạo tín hiệu Long/Short
longsignal = ta.crossover(ema15, sma60) and not cutoff_time
longstopsignal = ta.crossunder(ema15, sma60) and close <= ema15
shortsignal = ta.crossunder(ema15, sma60) and not cutoff_time
shortstopsignal = ta.crossover(ema15, sma60) and close >= ema15

// Maximum loss settings - Adjusting max loss level in ticks, set by 20 ticks (2 points) by default.
// Điều chỉnh mức cắt lỗ, mặc định là 20 ticks (2 điểm)
longmaxloss = 20
shortmaxloss = 20

// Entry and exit logic
// logic Điểm Vào và Điểm Ra/Cắt Lỗ
if (longsignal and close >= ema15)
    strategy.entry("Long", strategy.long)

if (longstopsignal or cutoff_time or longmaxloss)
    strategy.exit("Long Exit", from_entry="Long", loss=longmaxloss)

if (shortsignal and close <= ema15)
    strategy.entry("Short", strategy.short)

if (shortstopsignal or cutoff_time or shortmaxloss)
    strategy.exit("Short Exit", from_entry="Short", loss=shortmaxloss)

// Ensure all positions are closed before the session end
// Đóng toàn bộ vị thế cuối ngày, không giữ lệnh qua đêm
if cutoff_time
    strategy.close_all()