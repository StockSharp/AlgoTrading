//@version=5
strategy("Vegas Tunnel Strategy", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// === 参数设置 ===
emaFast = ta.ema(close, 12)
emaMedium = ta.ema(close, 25)
emaSlow = ta.ema(close, 144)
emaTunnel = ta.ema(close, 169)

riskRewardRatio = input.float(2.0, "风险回报比", step=0.1)
riskPercent = input.float(1.0, "每笔风险百分比", step=0.1)
useATR = input.bool(true, "使用ATR止损", inline="atr")
atrLength = input.int(14, "ATR长度", inline="atr")
atrMult = input.float(1.5, "ATR乘数", inline="atr")
atr = ta.atr(atrLength)

// === 隧道形态 ===
tunnelUp = emaSlow < emaTunnel
tunnelDown = emaSlow > emaTunnel

// === 多头入场条件 ===
longCond1 = close > emaSlow and close > emaTunnel and tunnelUp
longCond2 = emaFast > emaSlow and emaFast > emaTunnel

// === 空头入场条件 ===
shortCond1 = close < emaSlow and close < emaTunnel and tunnelDown
shortCond2 = emaFast < emaSlow and emaFast < emaTunnel

// === 止损与止盈计算 ===
entryPrice = strategy.position_avg_price
longStopLoss = useATR ? entryPrice - atrMult * atr : emaSlow
shortStopLoss = useATR ? entryPrice + atrMult * atr : emaSlow
longTakeProfit = entryPrice + (entryPrice - longStopLoss) * riskRewardRatio
shortTakeProfit = entryPrice - (shortStopLoss - entryPrice) * riskRewardRatio

// === 开仓逻辑 ===
// 多头开仓
if (longCond1 and longCond2)
    strategy.entry("Long", strategy.long)
    strategy.exit("TP/SL Long", from_entry="Long", stop=longStopLoss, limit=longTakeProfit)

// 空头开仓
if (shortCond1 and shortCond2)
    strategy.entry("Short", strategy.short)
    strategy.exit("TP/SL Short", from_entry="Short", stop=shortStopLoss, limit=shortTakeProfit)

// === 图形显示 ===
plot(emaFast, color=color.yellow, title="EMA 12")
plot(emaMedium, color=color.orange, title="EMA 25")
plot(emaSlow, color=color.green, title="EMA 144")
plot(emaTunnel, color=color.blue, title="EMA 169")
bgcolor(tunnelUp ? color.new(color.green, 85) : tunnelDown ? color.new(color.red, 85) : na)