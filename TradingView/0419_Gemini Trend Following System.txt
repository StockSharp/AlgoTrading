// Â© 2025 Google, Gemini
//@version=5
strategy("Gemini Trend Following System",
     overlay=true,
     initial_capital=50000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=20, // Using a larger position size for fewer, longer-term trades
     commission_type=strategy.commission.percent,
     commission_value=0.05,
     pyramiding = 0)

// --- I. USER INPUTS ---
ma_group = "Moving Averages"
sma50_len = input.int(50, "50-period SMA Length", group=ma_group)
sma200_len = input.int(200, "200-period SMA Length", group=ma_group)

perf_group = "Performance Filters (for Screening)"
roc_period = input.int(252, "Rate of Change Period (days)", group=perf_group, tooltip="Approx 1 year")
roc_min_perc = input.float(15.0, "Minimum Annual ROC %", group=perf_group, tooltip="Filters for stocks in strong long-term uptrends")

risk_group = "Risk Management"
use_catastrophic_stop = input.bool(true, "Use Catastrophic Stop Loss?", group=risk_group)

// --- II. CALCULATIONS ---
sma50 = ta.sma(close, sma50_len)
sma200 = ta.sma(close, sma200_len)
roc = (close - close[roc_period]) / close[roc_period] * 100

// --- III. LOGIC & CONDITIONS ---
// Define boolean conditions for our strategy rules.

// Regime Filter: Is the stock in a long-term uptrend?
// This is the most important condition for this strategy.
bool is_major_uptrend = sma50 > sma200 and roc > roc_min_perc and sma200 > sma200[20] // Ensure the 200 SMA itself is rising

// Entry Condition: Buy the dip
// We look for a pullback TO the 50 SMA, then a recovery.
bool pulled_back_to_50sma = ta.crossunder(close, sma50) // Did the price dip below the 50 SMA recently?
bool recovered_above_50sma = ta.crossover(close, sma50) // Did it just cross back above?

// We use ta.barssince to confirm the pullback happened within the last 10 bars.
bool entry_condition = is_major_uptrend and recovered_above_50sma and ta.barssince(pulled_back_to_50sma) < 10

// Exit Condition: The primary trend has failed.
bool trend_exit_condition = ta.crossunder(sma50, sma200) // The "Death Cross"

// --- IV. STRATEGY EXECUTION ---
// Define when to enter and exit trades.

// Entry Logic
if (entry_condition and strategy.position_size == 0)
    strategy.entry("Long", strategy.long, comment="Entry (Pullback Buy)")

    // Set a wide, catastrophic stop-loss below the 200-day SMA at time of entry
    if (use_catastrophic_stop)
        stop_loss_price = ta.lowest(low, 20)[1] < sma200 ? ta.lowest(low, 20)[1] : sma200[1]
        strategy.exit("SL Exit", from_entry="Long", stop=stop_loss_price)

// Trend Exit Logic
if (trend_exit_condition)
    strategy.close("Long", comment="Exit (Trend Failure)")

// --- V. VISUALS ---
// Plot indicators on the chart for easier analysis.
plot(sma50, "50 SMA", color=color.new(color.blue, 0), linewidth=2)
plot(sma200, "200 SMA", color=color.new(color.red, 0), linewidth=2)

// Highlight bars where an entry signal occurred
bgcolor(entry_condition ? color.new(color.teal, 80) : na, title="Entry Signal")
// Highlight bars where the trend exit signal occurred
bgcolor(trend_exit_condition and strategy.position_size > 0 ? color.new(color.maroon, 70) : na, title="Exit Signal")