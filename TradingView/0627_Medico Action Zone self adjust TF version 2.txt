// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Medico410

//@version=6
strategy('Medico Action Zone self adjust TF version 2', overlay = true, default_qty_type = strategy.percent_of_equity, default_qty_value = 100)

// --- Input ตั้งค่า ---
htf = input.timeframe('W', 'EMA Timeframe')
emaShortLen = input.int(12, 'EMA Short Length')
emaLongLen = input.int(26, 'EMA Long Length')
ema50Len = input.int(50, 'EMA 50 Length')
ema200Len = input.int(200, 'EMA 200 Length')

// --- EMA คำนวณบนกราฟ timeframe ปัจจุบัน (Smooth ไม่ repaint) ---
emaShort_cur = ta.ema(close, emaShortLen)
emaLong_cur = ta.ema(close, emaLongLen)
ema50_cur = ta.ema(close, ema50Len)
ema200_cur = ta.ema(close, ema200Len)

// --- EMA timeframe สูง ใช้ lookahead_on เพื่อเกาะกราฟ (repaint อาจเกิดขึ้น) ---
emaShort_tf = request.security(syminfo.tickerid, htf, ta.ema(close, emaShortLen), gaps = barmerge.gaps_off, lookahead = barmerge.lookahead_on)
emaLong_tf = request.security(syminfo.tickerid, htf, ta.ema(close, emaLongLen), gaps = barmerge.gaps_off, lookahead = barmerge.lookahead_on)
ema50_tf = request.security(syminfo.tickerid, htf, ta.ema(close, ema50Len), gaps = barmerge.gaps_off, lookahead = barmerge.lookahead_on)
ema200_tf = request.security(syminfo.tickerid, htf, ta.ema(close, ema200Len), gaps = barmerge.gaps_off, lookahead = barmerge.lookahead_on)
close_tf = request.security(syminfo.tickerid, htf, close, gaps = barmerge.gaps_off, lookahead = barmerge.lookahead_on)

// --- เลือก EMA ตาม timeframe ที่เลือก ---
emaShort = htf == timeframe.period ? emaShort_cur : emaShort_tf
emaLong = htf == timeframe.period ? emaLong_cur : emaLong_tf
ema50 = htf == timeframe.period ? ema50_cur : ema50_tf
ema200 = htf == timeframe.period ? ema200_cur : ema200_tf
closeHTF = htf == timeframe.period ? close : close_tf

// --- สัญญาณซื้อ/ขาย ---
buySignal = ta.crossover(emaShort, emaLong) and closeHTF > emaShort
sellSignal = ta.crossover(emaLong, emaShort) and closeHTF < emaLong

// --- ตัวแปรเก็บสถานะเทรนด์ ---
var int trend = na // 1=ขึ้น, -1=ลง

if buySignal
    trend := 1
    trend
else if sellSignal
    trend := -1
    trend

// --- Backtest Entry/Exit ---
if buySignal
    strategy.entry('Long', strategy.long)
if sellSignal
    strategy.close('Long')

// --- ปรับสีของแท่งเทียน (รวมทั้ง body และ wick)
candleColor = trend == 1 ? color.green : trend == -1 ? color.red : na

plotcandle(open, high, low, close, title = 'Trend Candle', color = candleColor, wickcolor = candleColor, bordercolor = candleColor)

// --- Plot EMA ---
plot(emaShort, title = 'EMA Short', color = color.aqua, linewidth = 2)
plot(emaLong, title = 'EMA Long', color = color.orange, linewidth = 2)
plot(ema50, title = 'EMA 50', color = color.purple, linewidth = 1)
plot(ema200, title = 'EMA 200', color = color.gray, linewidth = 1)

// --- แสดงสัญญาณ Buy/Sell ---
plotshape(buySignal, title = 'Buy Signal', location = location.belowbar, color = color.green, style = shape.labelup, text = 'BUY')
plotshape(sellSignal, title = 'Sell Signal', location = location.abovebar, color = color.red, style = shape.labeldown, text = 'SELL')

// --- ตาราง Screener ---
var table screenerTable = table.new(position.top_right, 1, 6, border_width = 1)

if barstate.islast
    table.cell(screenerTable, 0, 0, text = 'Ticker: ' + syminfo.ticker)
    table.cell(screenerTable, 0, 1, text = 'Trend: ' + (trend == 1 ? 'UP' : trend == -1 ? 'DOWN' : 'N/A'), text_color = trend == 1 ? color.green : trend == -1 ? color.red : color.gray)
    table.cell(screenerTable, 0, 2, text = 'EMA ' + str.tostring(emaShortLen) + ': ' + str.tostring(emaShort, format.mintick))
    table.cell(screenerTable, 0, 3, text = 'EMA ' + str.tostring(emaLongLen) + ': ' + str.tostring(emaLong, format.mintick))
    table.cell(screenerTable, 0, 4, text = 'EMA 50: ' + str.tostring(ema50, format.mintick))
    table.cell(screenerTable, 0, 5, text = 'EMA 200: ' + str.tostring(ema200, format.mintick))

// --- Alert Condition ---
alertcondition(buySignal, title = 'Buy Alert', message = 'สัญญาณซื้อ: EMA12 ตัดขึ้น EMA26')
alertcondition(sellSignal, title = 'Sell Alert', message = 'สัญญาณขาย: EMA12 ตัดลง EMA26')