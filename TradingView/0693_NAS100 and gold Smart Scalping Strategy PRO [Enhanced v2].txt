//@version=6
strategy("NAS100 Smart Scalping Strategy PRO [Enhanced v2]", overlay=true, default_qty_type=strategy.cash, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.03)

// === USER CONFIGURATION ===
accountCapital = input.float(5000, title="Account Capital ($)", minval=100)
riskPercent = input.float(1, title="Max Risk Per Trade (%)", minval=0.1, step=0.1)
atrMultiplierSL = input.float(1.0, title="Stop Loss ATR Multiplier", minval=0.5, maxval=3)
atrMultiplierTP = input.float(2.0, title="Take Profit ATR Multiplier", minval=1, maxval=5)
volumeSpikeMultiplier = input.float(1.5, title="Volume Spike Threshold (x Avg)", minval=1.2, maxval=3)
useTrendFilter = input.bool(true, title="Use 15m EMA200 Trend Filter")
useTrailingStop = input.bool(true, title="Use Trailing Stop")
cooldownMins = input.int(30, title="Cooldown Between Trades (mins)", minval=5)
exitOnOpposite = input.bool(true, title="Exit on Opposite Signal")

// === TIME FILTER ===
startHour = input.int(13, title="Session Start Hour (UTC)", minval=0, maxval=23)
endHour = input.int(20, title="Session End Hour (UTC)", minval=0, maxval=23)
hour = hour(time, "Etc/UTC")
tradeSession = (hour >= startHour and hour <= endHour)

// === INDICATORS ===
ema9 = ta.ema(close, 9)
vwap = ta.vwap
atr = ta.atr(14)
rsi = ta.rsi(close, 14)
vol = volume
avgVol = ta.sma(vol, 20)
volumeSpike = vol > avgVol * volumeSpikeMultiplier

ema200_15m = request.security(syminfo.tickerid, "15", ta.ema(close, 200))
trendBullish = close > ema200_15m
trendBearish = close < ema200_15m

// === BODY FILTER ===
bodyStrength = math.abs(close - open) > atr * 0.3

// === ENHANCED SETUPS ===
bullishSetup = close > open and
               close > ema9 and
               close > vwap and
               rsi > 50 and
               bodyStrength and
               (volumeSpike or barstate.isconfirmed)

bearishSetup = close < open and
               close < ema9 and
               close < vwap and
               rsi < 50 and
               bodyStrength and
               (volumeSpike or barstate.isconfirmed)

longCondition = bullishSetup and tradeSession
shortCondition = bearishSetup and tradeSession

longOK = useTrendFilter ? (longCondition and trendBullish) : longCondition
shortOK = useTrendFilter ? (shortCondition and trendBearish) : shortCondition

// === RISK & SIZING ===
riskAmount = accountCapital * (riskPercent / 100)
slPoints = atr * atrMultiplierSL
tpPoints = atr * atrMultiplierTP

// === COOLDOWN TIMER ===
var float lastTradeTime = na
canTrade = na(lastTradeTime) or (time - lastTradeTime) > cooldownMins * 60 * 1000

// === ENTRY / EXIT ===
if (longOK and canTrade)
    strategy.entry("Long", strategy.long, qty=riskAmount / slPoints)
    if useTrailingStop
        strategy.exit("Long Exit", "Long", stop=close - slPoints, limit=close + tpPoints, trail_points=tpPoints / 2, trail_offset=slPoints / 2)
    else
        strategy.exit("Long Exit", "Long", stop=close - slPoints, limit=close + tpPoints)
    lastTradeTime := time

if (shortOK and canTrade)
    strategy.entry("Short", strategy.short, qty=riskAmount / slPoints)
    if useTrailingStop
        strategy.exit("Short Exit", "Short", stop=close + slPoints, limit=close - tpPoints, trail_points=tpPoints / 2, trail_offset=slPoints / 2)
    else
        strategy.exit("Short Exit", "Short", stop=close + slPoints, limit=close - tpPoints)
    lastTradeTime := time

// === EXIT ON OPPOSITE (Optional) ===
if exitOnOpposite
    strategy.close("Long", immediately = shortOK)
    strategy.close("Short", immediately=longOK)

// === VISUALS ===
plot(ema9, color=color.orange, title="EMA 9", linewidth=2)
plot(vwap, color=color.blue, title="VWAP", linewidth=2)
plot(ema200_15m, color=color.purple, title="15m EMA 200", linewidth=2)

plotshape(longOK, title="Long Entry", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(shortOK, title="Short Entry", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// === ALERTS ===
alertcondition(longOK, title="Long Entry Alert", message="NAS100 Long: {{ticker}} @ {{close}}")
alertcondition(shortOK, title="Short Entry Alert", message="NAS100 Short: {{ticker}} @ {{close}}")