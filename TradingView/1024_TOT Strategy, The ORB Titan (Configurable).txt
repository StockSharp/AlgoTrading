//@version=6
strategy("TOT Strategy, The ORB Titan (Configurable)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// === INPUTS ===
// ORB & Session Time
startHour   = input.int(8, "ORB Start Hour (ET)", minval=0, maxval=23)
startMinute = input.int(30, "ORB Start Minute", minval=0, maxval=59)
endHour     = input.int(8, "ORB End Hour (ET)", minval=0, maxval=23)
endMinute   = input.int(45, "ORB End Minute", minval=0, maxval=59)
sessionEndHour = input.int(15, "Session End Hour (ET)", minval=0, maxval=23)

// Strategy Settings
maxTradesPerDay = input.int(2, "Max Trades Per Day", minval=1)
atrLength       = input.int(14, "ATR Length")
tpMultiplier    = input.float(3.0, "Take Profit (ATR Multiplier)", step=0.1)
emaFastLength   = input.int(9, "Fast EMA Length")
emaSlowLength   = input.int(21, "Slow EMA Length")

// ORB Box Styling
borderColor = input.color(color.white, "ORB Box Border")
fillColor   = input.color(color.new(color.white, 90), "ORB Box Fill")
showRangeBox = input.bool(true, "Show ORB Box")

// === TIME HANDLING ===
startTime = timestamp("America/Chicago", year, month, dayofmonth, startHour, startMinute)
endTime   = timestamp("America/Chicago", year, month, dayofmonth, endHour, endMinute)
rthStart  = timestamp("America/Chicago", year, month, dayofmonth, startHour, startMinute)
rthEnd    = timestamp("America/Chicago", year, month, dayofmonth, sessionEndHour, 0)
inRTH     = time >= rthStart and time < rthEnd
newDay    = dayofmonth != dayofmonth[1]

// === ORB LOGIC ===
var float orbHigh = na
var float orbLow = na
var bool orbSet = false
var box orbBox = na

if newDay
    orbHigh := na
    orbLow := na
    orbSet := false
    if not na(orbBox)
        box.delete(orbBox)
    orbBox := na

if time >= startTime and time < endTime
    orbHigh := na(orbHigh) ? high : math.max(orbHigh, high)
    orbLow := na(orbLow) ? low : math.min(orbLow, low)

if time >= endTime and not orbSet and not na(orbHigh) and not na(orbLow)
    orbSet := true
    if showRangeBox
        orbBox := box.new(left=bar_index, right=bar_index + 500, top=orbHigh, bottom=orbLow,
                          border_color=borderColor, bgcolor=fillColor, border_width=1)

// === INDICATORS ===
emaFast = ta.ema(close, emaFastLength)
emaSlow = ta.ema(close, emaSlowLength)
plot(emaFast, color=color.green, title="Fast EMA", linewidth=2)
plot(emaSlow, color=color.red, title="Slow EMA", linewidth=2)

// === VWAP (reset daily at 9:30 AM ET) ===
nySessionStart = timestamp("America/New_York", year, month, dayofmonth, 9, 30)
newSession = na(time[1]) ? false : time[1] < nySessionStart and time >= nySessionStart

var float vwapSum = na
var float vwapVol = na

if newSession or na(vwapSum)
    vwapSum := 0.0
    vwapVol := 0.0

vwapSum += ohlc4 * volume
vwapVol += volume

vwap = vwapVol > 0 ? vwapSum / vwapVol : na
plot(vwap, title="VWAP (OHLC4)", color=color.yellow, linewidth=2)

// === ENTRY CONDITIONS ===
atr = ta.atr(atrLength)

opensInside  = open <= orbHigh and open >= orbLow
closesAbove  = close > orbHigh
closesBelow  = close < orbLow

longCond  = inRTH and orbSet and opensInside and closesAbove and vwap < emaSlow and emaSlow < emaFast
shortCond = inRTH and orbSet and opensInside and closesBelow and vwap > emaSlow and emaSlow > emaFast

// === SL/TP LEVELS ===
longSL  = close - atr
longTP  = close + tpMultiplier * atr
shortSL = close + atr
shortTP = close - tpMultiplier * atr

// === DAILY TRADE LIMIT ===
var int tradeCount = 0
if newDay
    tradeCount := 0

newTrade = strategy.opentrades > strategy.opentrades[1]
if newTrade
    tradeCount += 1

canTrade = tradeCount < maxTradesPerDay

// === STRATEGY EXECUTION ===
if longCond and strategy.position_size == 0 and canTrade
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", from_entry="Long", stop=longSL, limit=longTP)

if shortCond and strategy.position_size == 0 and canTrade
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", from_entry="Short", stop=shortSL, limit=shortTP)

// === VISUAL SIGNALS ===
plotshape(longCond and canTrade, title="Buy Signal", location=location.belowbar, color=color.white,
          style=shape.labelup, text="BUY", textcolor=color.green)
plotshape(shortCond and canTrade, title="Sell Signal", location=location.abovebar, color=color.white,
          style=shape.labeldown, text="SELL", textcolor=color.red)