//@version=5
strategy("200 SMA +/- 5% Entry, -3% Exit Strategy (Since 2001)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// === Inputs ===
smaLength = input.int(200, title="SMA Period", minval=1)
entryThreshold = input.float(0.05, title="Entry Threshold (%)", step=0.01)
exitThreshold = input.float(0.03, title="Exit Threshold (%)", step=0.01)
startYear = 2001
startMonth = 1
startDay = 1

// === Time filter ===
startTime = timestamp(startYear, startMonth, startDay, 0, 0)
isAfterStart = time >= startTime

// === Calculations ===
sma200 = ta.sma(close, smaLength)
upperThreshold = sma200 * (1 + entryThreshold)
lowerThreshold = sma200 * (1 - exitThreshold)

// === Strategy Logic ===
enterLong = close > upperThreshold
exitLong = close < lowerThreshold

// === Entry/Exit Signal Tracking ===
var bool didBuy = false
var bool didSell = false

didBuy := false
didSell := false

if (isAfterStart)
    if (enterLong and strategy.position_size == 0)
        strategy.entry("Buy", strategy.long)

    if (exitLong and strategy.position_size > 0)
        strategy.close("Buy")

// Detect actual entry/exit execution
didBuy := strategy.opentrades == 1 and strategy.opentrades[1] == 0
didSell := strategy.opentrades == 0 and strategy.opentrades[1] == 1

// === Plotting ===
plot(sma200, title="200 SMA", color=color.rgb(255, 0, 242))
plot(upperThreshold, title="Entry Threshold (5% Above SMA)", color=color.rgb(0, 255, 8))
plot(lowerThreshold, title="Exit Threshold (3% Below SMA)", color=color.rgb(255, 0, 0))

// === Entry/Exit Markers ===
plotshape(didBuy, title="Buy Marker", location=location.belowbar, color=color.lime, style=shape.triangleup, size=size.large, text="BUY", textcolor=color.black)
plotshape(didSell, title="Sell Marker", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.large, text="SELL", textcolor=color.white)