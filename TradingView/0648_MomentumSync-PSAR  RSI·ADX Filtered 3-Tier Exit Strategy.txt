//@version=5
strategy("âœ… PSAR Early Entry & 3-Step Exit (No Labels)", overlay=true)

// === INPUTS ===
sarStart     = input.float(0.02, "SAR Start", step=0.01)
sarIncrement = input.float(0.02, "SAR Increment", step=0.01)
sarMax       = input.float(0.2,  "SAR Max", step=0.01)
rsiPeriod    = input.int(14, "RSI Period")
adxPeriod    = input.int(14, "ADX Period")

// === INDICATORS ===
psar = ta.sar(sarStart, sarIncrement, sarMax)
rsi  = ta.rsi(close, rsiPeriod)
[_, _, adx] = ta.dmi(adxPeriod, adxPeriod)

// === ENTRY CONDITIONS ===
psarBullishFlip = psar < close and psar[1] > close[1] and psar[2] > close[2]
rsiAdxOK        = rsi > 40 and adx > 18
buyCondition    = psarBullishFlip and rsiAdxOK

// === BUY ENTRY ===
if (buyCondition and strategy.position_size == 0)
    strategy.entry("Buy", strategy.long)

// === EXIT CONDITIONS ===
// Detect PSAR bearish flip AFTER BUY
psarBearishFlip = psar > close and psar[1] < close[1] and psar[2] < close[2]
var int bearishFlipBar = na

if (strategy.position_size > 0 and psarBearishFlip and na(bearishFlipBar))
    bearishFlipBar := bar_index

barsSinceBearishFlip = na(bearishFlipBar) ? na : bar_index - bearishFlipBar

exit1 = strategy.position_size > 0 and barsSinceBearishFlip == 1
exit2 = strategy.position_size > 0 and barsSinceBearishFlip == 2
exit3 = strategy.position_size > 0 and barsSinceBearishFlip == 3

// === EXIT SIGNALS ===
plotshape(exit1, location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small, title="Exit 1")
plotshape(exit2, location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small, title="Exit 2")
plotshape(exit3, location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small, title="Full Exit")

if (exit3)
    strategy.close("Buy")
    bearishFlipBar := na  // Reset for next trade

// === PLOTS ===
plot(psar, title="Parabolic SAR", style=plot.style_cross, color=color.orange)
bgcolor(psar < close ? color.new(color.green, 85) : na, title="Buy Background")

// === HELPER VISUALS ===
plotshape(rsi > 50 and adx > 18, title="RSI>50 & ADX>18", location=location.bottom, style=shape.cross, color=color.green, size=size.small)
plotshape(rsi <= 50 or adx <= 18, title="RSI<=50 or ADX<=18", location=location.bottom, style=shape.cross, color=color.red, size=size.small)