//@version=5
strategy("Breadth Thrust Strategy with Volatility Stop-Loss", overlay=false, precision=2, calc_on_every_tick=true, initial_capital=10000, currency=currency.USD, slippage=1, commission_type=strategy.commission.cash_per_order, commission_value=5)

// Input Parameters
length = input.int(10, title="Smoothing Length", minval=1)
threshold_low = input.float(0.4, title="Low Threshold", minval=0, maxval=1, step=0.01)
use_volume = input.bool(true, title="Include Volume in Calculation") // Checkbox to include volume
hold_periods = input.int(9, title="Hold Periods", minval=1) // Number of periods to hold the position
volatility_multiplier = input.float(5, title="Volatility Multiplier", minval=0.1) // Multiplier for the volatility-based stop-loss

// Load NYSE data
advancing_stocks = request.security("INDEX:ADVN", "D", close)
declining_stocks = request.security("INDEX:DECN", "D", close)
advancing_volume = request.security("INDEX:NVLU", "D", close)
declining_volume = request.security("INDEX:NVLD", "D", close)

// Calculate total number of stocks and volume
total_stocks = advancing_stocks + declining_stocks
total_volume = advancing_volume + declining_volume

// Breadth Ratio Calculation (based on stocks)
breadth_ratio = advancing_stocks / total_stocks

// Volume Ratio Calculation
volume_ratio = advancing_volume / total_volume

// Combined Breadth and Volume Ratio
combined_ratio = use_volume ? (breadth_ratio + volume_ratio) / 2 : breadth_ratio

// Smooth the Breadth Ratio and Combined Ratio
smoothed_combined = ta.sma(combined_ratio, length)

// Generate signals
long_signal = ta.crossover(smoothed_combined, threshold_low)
var float entry_price = na
var int entry_bar_index = na

// Calculate volatility using ATR (Average True Range)
atr = ta.atr(14) // 14-period ATR for volatility measure
var float stop_loss_level = na

if (long_signal)
    entry_price := close
    entry_bar_index := bar_index
    stop_loss_level := close - (volatility_multiplier * atr)
    strategy.entry("Long", strategy.long)

if (strategy.opentrades > 0)
    // Update stop-loss based on ATR
    stop_loss_level := math.max(stop_loss_level, close - (volatility_multiplier * atr))

    // Close position if the stop-loss level is hit
    if (low <= stop_loss_level)
        strategy.close("Long")

    // Close the position after the hold period
    if (bar_index - entry_bar_index >= hold_periods)
        strategy.close("Long")
        entry_price := na
        entry_bar_index := na
        stop_loss_level := na

// Plot the Breadth Ratio and Combined Ratio
plot(breadth_ratio, title="Breadth Ratio", color=color.blue, linewidth=1, display=display.none)
plot(volume_ratio, title="Volume Ratio", color=color.purple, linewidth=1, display=display.none)
plot(smoothed_combined, title="Smoothed Combined Ratio", color=color.white, linewidth=1)

// Draw horizontal lines for thresholds
hline(threshold_low, title="Low Threshold", color=color.red, linestyle=hline.style_dotted)

// Background color when position is open
bgcolor(strategy.opentrades > 0 ? color.new(color.green, 50) : na) // Green background when position is open