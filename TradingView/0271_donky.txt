//@version=5
strategy("الحمار الكادح", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// --- إعدادات المستخدم (يمكنك تغييرها من الشارت) ---
fast_length = input.int(10, title="Fast MA Length")
slow_length = input.int(30, title="Slow MA Length")

// تحديد الأهداف ووقف الخسارة بنسبة مئوية
take_profit_1_pct = input.float(3, title="Take Profit 1 (%)") / 100
take_profit_2_pct = input.float(6, title="Take Profit 2 (%)") / 100
stop_loss_pct = input.float(1, title="Stop Loss (%)") / 100

// --- حساب المتوسطات المتحركة ---
fast_ma = ta.sma(close, fast_length)
slow_ma = ta.sma(close, slow_length)

// --- تحديد إشارات الدخول ---
buy_signal = ta.crossover(fast_ma, slow_ma)
sell_signal = ta.crossunder(fast_ma, slow_ma)

// **التصحيح:** تعريف المتغيرات خارج الشروط لكي تكون متاحة للرسم (plotting)
var float tp1 = na
var float tp2 = na
var float sl = na

// --- تنفيذ أوامر الدخول والخروج ---
// الدخول في صفقة شراء
if buy_signal
    strategy.entry("Buy", strategy.long)
    // حساب الأهداف ووقف الخسارة لصفقات الشراء
    tp1 := strategy.position_avg_price * (1 + take_profit_1_pct)
    tp2 := strategy.position_avg_price * (1 + take_profit_2_pct)
    sl := strategy.position_avg_price * (1 - stop_loss_pct)

// الدخول في صفقة بيع
if sell_signal
    strategy.entry("Sell", strategy.short)
    // حساب الأهداف ووقف الخسارة لصفقات البيع
    tp1 := strategy.position_avg_price * (1 - take_profit_1_pct)
    tp2 := strategy.position_avg_price * (1 - take_profit_2_pct)
    sl := strategy.position_avg_price * (1 + stop_loss_pct)

// إغلاق الصفقات عند تحقق الأهداف أو وقف الخسارة
strategy.exit("Exit Buy", from_entry="Buy", profit=(tp1 - strategy.position_avg_price) / syminfo.mintick, loss=(strategy.position_avg_price - sl) / syminfo.mintick, qty_percent=50)
strategy.exit("Exit Buy 2", from_entry="Buy", profit=(tp2 - strategy.position_avg_price) / syminfo.mintick, loss=(strategy.position_avg_price - sl) / syminfo.mintick, qty_percent=50)

strategy.exit("Exit Sell", from_entry="Sell", profit=(strategy.position_avg_price - tp1) / syminfo.mintick, loss=(sl - strategy.position_avg_price) / syminfo.mintick, qty_percent=50)
strategy.exit("Exit Sell 2", from_entry="Sell", profit=(strategy.position_avg_price - tp2) / syminfo.mintick, loss=(sl - strategy.position_avg_price) / syminfo.mintick, qty_percent=50)

// --- رسم خطوط الأهداف ووقف الخسارة على الشارت (للتوضيح فقط) ---
plot(strategy.position_size > 0 ? tp1 : na, "Take Profit 1 (Buy)", color.new(color.green, 0), style=plot.style_stepline)
plot(strategy.position_size > 0 ? tp2 : na, "Take Profit 2 (Buy)", color.new(color.green, 0), style=plot.style_stepline)
plot(strategy.position_size > 0 ? sl : na, "Stop Loss (Buy)", color.new(color.red, 0), style=plot.style_stepline)

plot(strategy.position_size < 0 ? tp1 : na, "Take Profit 1 (Sell)", color.new(color.green, 0), style=plot.style_stepline)
plot(strategy.position_size < 0 ? tp2 : na, "Take Profit 2 (Sell)", color.new(color.green, 0), style=plot.style_stepline)
plot(strategy.position_size < 0 ? sl : na, "Stop Loss (Sell)", color.new(color.red, 0), style=plot.style_stepline)