//@version=5
strategy("Monthly Day Long Strategy with VIX and Risk Management", overlay=true)

// Custom inputs for days of the month, hold duration, VIX threshold, and risk management
entry_day = input.int(27, title="Entry Day of the Month", minval=1, maxval=31)
hold_duration_days = input.int(4, title="Hold Duration (Days)", minval=1, maxval=30)
vix_threshold = input.float(20.0, title="VIX Threshold", minval=0.0, maxval=100.0)  // Set a VIX threshold value

stop_loss_percentage = input.float(2.0, title="Stop Loss (%)", minval=0.0, step=0.1)
take_profit_percentage = input.float(5.0, title="Take Profit (%)", minval=0.0, step=0.1)

// Function to get the next Monday if the date falls on a weekend
next_weekday(date) =>
    day = dayofweek(date)
    if day == dayofweek.saturday
        date + 2 * 86400000
    else if day == dayofweek.sunday
        date + 1 * 86400000
    else
        date

// Variables to track the entry state
var bool entered = false
var int entry_timestamp = na // Declare entry_timestamp as an int and initialize with na

// Get current date and time in Eastern Time (New York)
current_time = timestamp("America/New_York", year, month, dayofmonth, hour, minute)

// Determine the target entry date
target_entry_date = timestamp("America/New_York", year, month, entry_day, 0, 0)

// Adjust entry date if it falls on a weekend
adjusted_entry_date = next_weekday(target_entry_date)

// Retrieve the VIX data
vix = request.security("CBOE:VIX", "D", close)

// Entry condition: Open a long position at the start of the day if it matches adjusted_entry_date
// and if the VIX is below the specified threshold
if not entered and (current_time >= adjusted_entry_date) and (current_time < adjusted_entry_date + 86400000) and (vix < vix_threshold)
    strategy.entry("Long", strategy.long)
    entry_timestamp := current_time
    entered := true

// Calculate the exit time based on hold duration
exit_time = entry_timestamp + hold_duration_days * 86400000

// Calculate stop-loss and take-profit prices
entry_price = strategy.opentrades.entry_price(0)
stop_loss_price = entry_price * (1 - stop_loss_percentage / 100)
take_profit_price = entry_price * (1 + take_profit_percentage / 100)

// Close the position if it's the exit time or if stop-loss/take-profit conditions are met
if entered
    if (current_time >= exit_time) or (low <= stop_loss_price) or (high >= take_profit_price)
        strategy.close("Long")
        entered := false

// Optional: Plot the VIX on the chart for reference
plot(vix, title="VIX", color=color.blue)
hline(vix_threshold, "VIX Threshold", color=color.red)