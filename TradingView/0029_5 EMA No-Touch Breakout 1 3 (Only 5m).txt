//@version=5
strategy("5 EMA No-Touch Breakout 1:3 (Only 5m)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=5, pyramiding=1, initial_capital=10000)

// === CHECK TF ===
is_five_min = timeframe.period == "5"
if not is_five_min
    var label tf_label = na
    label.delete(tf_label)
    tf_label := label.new(bar_index, high, "ðŸ”„ Switch to 5-min TF for valid signals", yloc=yloc.abovebar, style=label.style_label_down, color=color.yellow, textcolor=color.black, size=size.small)
else
    // remove any stale warning
    var label dummy = na
    // no-op to avoid unused

// === INPUTS ===
ema_period  = input.int(5, "EMA Period", minval=1)
reward_risk = input.float(3.0, "Reward : Risk", step=0.1)
show_labels = input.bool(true, "Show Entry/Exit Labels")

// === EMA ===
ema_val = ta.ema(close, ema_period)
plot(ema_val, title="5 EMA", linewidth=2, color=color.orange)

// === SETUP CANDLES ===
// Buy setup: candle fully below EMA (no touch)
buy_setup = high < ema_val
// Sell setup: candle fully above EMA (no touch)
sell_setup = low > ema_val

// === STATE ===
var float pending_long_high  = na
var float pending_long_low   = na
var float pending_short_low  = na
var float pending_short_high = na
var bool  long_ready         = false
var bool  short_ready        = false

if is_five_min
    if buy_setup
        pending_long_high := high
        pending_long_low  := low
        long_ready        := true
        short_ready       := false

    if sell_setup
        pending_short_low  := low
        pending_short_high := high
        short_ready        := true
        long_ready         := false

// === TRIGGERS ===
long_trigger  = is_five_min and long_ready and (high > pending_long_high)
short_trigger = is_five_min and short_ready and (low < pending_short_low)

// === STOP & TARGET ===
long_stop   = pending_long_low
long_target = close + (close - long_stop) * reward_risk

short_stop   = pending_short_high
short_target = close - (short_stop - close) * reward_risk

// === EXECUTE TRADES ===
if long_trigger
    strategy.entry("Long", strategy.long)
    strategy.exit("Long TP/SL", from_entry="Long", stop=long_stop, limit=long_target)
    if show_labels
        label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)
    long_ready := false

if short_trigger
    strategy.entry("Short", strategy.short)
    strategy.exit("Short TP/SL", from_entry="Short", stop=short_stop, limit=short_target)
    if show_labels
        label.new(bar_index, high, "SELL", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)
    short_ready := false

// === PLOT LEVELS ===
plot(long_ready and is_five_min ? pending_long_high : na, title="Pending Long Breakout Level", style=plot.style_line, linewidth=2, color=color.green)
plot(short_ready and is_five_min ? pending_short_low : na, title="Pending Short Breakout Level", style=plot.style_line, linewidth=2, color=color.red)

// === ALERTS ===
alertcondition(long_trigger, title="Long Entry", message="Long breakout entry triggered")
alertcondition(short_trigger, title="Short Entry", message="Short breakout entry triggered")
alertcondition(is_five_min and strategy.position_size > 0 and close >= long_target, title="Long Target Hit", message="Long target hit")
alertcondition(is_five_min and strategy.position_size < 0 and close <= short_target, title="Short Target Hit", message="Short target hit")
alertcondition(is_five_min and strategy.position_size > 0 and close <= long_stop, title="Long Stop Hit", message="Long stoploss hit")
alertcondition(is_five_min and strategy.position_size < 0 and close >= short_stop, title="Short Stop Hit", message="Short stoploss hit")