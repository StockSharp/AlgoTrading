//@version=5
strategy("Refined SMA/EMA Crossover with Ichimoku and 200 SMA Filter", overlay=true)

// Ichimoku Cloud settings
conversionPeriods = input.int(9, minval=1, title="Conversion Line Periods")
basePeriods = input.int(26, minval=1, title="Base Line Periods")
laggingSpan2Periods = input.int(52, minval=1, title="Lagging Span 2 Periods")
displacement = input.int(26, minval=1, title="Displacement")

donchian(len) => math.avg(ta.lowest(low, len), ta.highest(high, len))

conversionLine = donchian(conversionPeriods)
baseLine = donchian(basePeriods)
leadLine1 = math.avg(conversionLine, baseLine)
leadLine2 = donchian(laggingSpan2Periods)

// Plot Ichimoku Cloud
plot(conversionLine, color=color.blue, title="Conversion Line")
plot(baseLine, color=color.red, title="Base Line")
plot(close[displacement], offset= displacement + 1, color=color.green, title="Lagging Span")
p1 = plot(leadLine1[displacement], color=color.green, title="Lead 1")
p2 = plot(leadLine2[displacement], color=color.red, title="Lead 2")
fill(p1, p2, color=leadLine1 > leadLine2 ? color.new(color.green, 90) : color.new(color.red, 90))

// Define moving averages
smaLength = 28
sma50Length = 50
emaLength = 14
sma200Length = 200

sma = ta.sma(close, smaLength)
sma50 = ta.sma(close, sma50Length)
ema = ta.ema(close, emaLength)
sma200 = ta.sma(close, sma200Length)

// Define price conditions relative to the Ichimoku Cloud and 200 SMA
priceAboveLead1 = close > leadLine1
priceAboveLead2 = close > leadLine2
priceBelowLead1 = close < leadLine1
priceBelowLead2 = close < leadLine2
priceAboveSMA200 = close > sma200
priceBelowSMA200 = close < sma200

// Initialize variables to track if the buy or sell signal has been issued
var bool buySignalIssued = false
var bool sellSignalIssued = false

// Define crossover conditions
smaEmaCrossOutsideCloud = (ta.crossover(sma, ema) or ta.crossunder(sma, ema)) and (close > leadLine1 or close < leadLine2)

// Generate buy and sell signals immediately based on closing prices and SMA
buySignalCondition = priceAboveSMA200 and (priceAboveLead1 or priceAboveLead2)
sellSignalCondition = priceBelowSMA200 and (priceBelowLead1 or priceBelowLead2)

// Generate buy and sell signals immediately
if (buySignalCondition and not buySignalIssued)
    strategy.entry("Buy", strategy.long)
    buySignalIssued := true

if (sellSignalCondition and not sellSignalIssued)
    strategy.entry("Sell", strategy.short)
    sellSignalIssued := true

// Reset signal flags when a trade is closed
if (strategy.opentrades == 0)
    buySignalIssued := false
    sellSignalIssued := false

// Plot moving averages
plot(sma, color=color.blue, title="28 SMA")
plot(sma50, color=color.black, title="50 SMA")
plot(ema, color=color.orange, title="14 EMA")
plot(sma200, color=color.purple, title="200 SMA")

// Plot buy and sell signals
plotshape(series=buySignalCondition and not buySignalIssued, location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plotshape(series=sellSignalCondition and not sellSignalIssued, location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL")