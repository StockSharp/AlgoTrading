//@version=6
strategy("LANZ Strategy 3.0 [Backtest]", overlay=true, default_qty_type=strategy.cash, default_qty_value=100)

// === INPUT DE CONFIGURACI√ìN ===
fiboVersion = input.string("Optimized", title="Fibonacci Version", options=["Original", "Optimized"])

// === RANGO ASI√ÅTICO (18:00‚Äì01:15 NY) ===
var float refHigh = na
var float refLow = na
var int x = na
rangeSession = not na(time(timeframe.period, "1800-0115"))
newSession = rangeSession and not rangeSession[1]

refHigh := newSession ? high : rangeSession ? math.max(high, refHigh) : refHigh
refLow  := newSession ? low  : rangeSession ? math.min(low, refLow)  : refLow
x := newSession ? time : x

// === FRANJAS HORARIAS ===
decisionWindow = not na(time(timeframe.period, "0115-0215"))
entryWindow    = not na(time(timeframe.period, "0115-0800"))
expireWindow   = not na(time(timeframe.period, "0800-0801"))

// === VARIABLES DE CONTROL ===
var float entryPrice = na
var float tp = na
var float sl = na
var bool directionDefined = false
var bool isBuy = false
var bool tradeExecuted = false
var bool tradeExpired = false
var bool orderSent = false
var bool fallbackTriggered = false

// === REINICIO EN NUEVA SESI√ìN ===
if newSession
    entryPrice := na
    tp := na
    sl := na
    directionDefined := false
    isBuy := false
    tradeExecuted := false
    tradeExpired := false
    orderSent := false
    fallbackTriggered := false

// === DEFINICI√ìN DE DIRECCI√ìN Y NIVELES (ENTRE 01:15‚Äì02:15) ===
if decisionWindow and not directionDefined
    fiboRange = refHigh - refLow
    asiaMid = (refHigh + refLow) / 2
    isBuy := close < asiaMid
    entryPrice := isBuy ? refLow : refHigh
    tp := fiboVersion == "Original" ? (isBuy ? refLow + 2.25 * fiboRange : refHigh - 2.25 * fiboRange) : (isBuy ? refLow + 1.95 * fiboRange : refHigh - 1.95 * fiboRange)
    sl := fiboVersion == "Original" ? (isBuy ? refLow - 0.75 * fiboRange : refHigh + 0.75 * fiboRange) : (isBuy ? refLow - 0.65 * fiboRange : refHigh + 0.65 * fiboRange)
    directionDefined := true

// === ENV√çO DE ORDEN ===
canSendOrder = directionDefined and entryWindow and not tradeExecuted and not orderSent and not tradeExpired

if canSendOrder
    if isBuy
        strategy.entry("Buy", strategy.long, limit=entryPrice)
        strategy.exit("Buy Exit", from_entry="Buy", limit=tp, stop=sl)
    else
        strategy.entry("Sell", strategy.short, limit=entryPrice)
        strategy.exit("Sell Exit", from_entry="Sell", limit=tp, stop=sl)
    orderSent := true

// === DETECCI√ìN DE EJECUCI√ìN ===
if not tradeExecuted
    tradeExecuted := strategy.position_size != 0

// === FALLO DE ORDEN ORIGINAL A LAS 02:15 NY ===
fallbackTime = (hour == 2 and minute == 15)
if fallbackTime and not tradeExecuted and not fallbackTriggered and orderSent
    // Cancelar orden anterior para permitir reenv√≠o
    strategy.cancel("Buy")
    strategy.cancel("Sell")

    asiaMid = (refHigh + refLow) / 2
    currentBuy = close[1] < asiaMid  // ‚úÖ vela de las 02:00

    if currentBuy == isBuy
        label.new(bar_index, high, "‚úÖ", style=label.style_label_down, color=color.rgb(143, 0, 148), textcolor=color.white)
        orderSent := false
    else
        fiboRange = refHigh - refLow
        isBuy := not isBuy
        entryPrice := isBuy ? refLow : refHigh
        tp := fiboVersion == "Original" ? (isBuy ? refLow + 2.25 * fiboRange : refHigh - 2.25 * fiboRange) : (isBuy ? refLow + 1.95 * fiboRange : refHigh - 1.95 * fiboRange)
        sl := fiboVersion == "Original" ? (isBuy ? refLow - 0.75 * fiboRange : refHigh + 0.75 * fiboRange) : (isBuy ? refLow - 0.65 * fiboRange : refHigh + 0.65 * fiboRange)
        label.new(bar_index, high, "üîÑ", style=label.style_label_down, color=color.rgb(255, 166, 0), textcolor=color.white)
        orderSent := false
    directionDefined := true
    fallbackTriggered := true

// === CANCELACI√ìN AL LLEGAR A LAS 08:00 NY SI NO SE EJECUT√ì ===
if expireWindow and not tradeExecuted and not tradeExpired
    strategy.cancel("Buy")
    strategy.cancel("Sell")
    tradeExpired := true

// === CIERRE MANUAL A LAS 15:45 NY ===
if (hour == 15 and minute == 45) and tradeExecuted
    strategy.close("Buy")
    strategy.close("Sell")