//@version=6
strategy("RTB - Momentum Breakout Strategy V3", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=50)

// Parámetros ajustables
emaFastLen    = input.int(20, "EMA Rápida", minval=1)
emaSlowLen    = input.int(50, "EMA Lenta", minval=1)
rsiLen        = input.int(14, "Periodo RSI", minval=1)
rsiOverbought = input.int(70, "RSI Sobrecompra", minval=1, maxval=100)
rsiOversold   = input.int(30, "RSI Sobreventa", minval=1, maxval=100)
breakoutPeriod = input.int(5, "Periodos para Breakout", minval=1)
atrLen        = input.int(14, "Periodo ATR", minval=1)
atrMultSL     = input.float(1.5, "Multiplicador ATR Stop-Loss", step=0.1)
atrMultTrail  = input.float(1.5, "Multiplicador ATR Trailing Stop", step=0.1)

// Indicadores técnicos
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
rsi     = ta.rsi(close, rsiLen)
atr     = ta.atr(atrLen)

// Cálculo de soportes y resistencias
resistenciaReciente = ta.highest(high, breakoutPeriod)[1]
soporteReciente     = ta.lowest(low, breakoutPeriod)[1]

// Condiciones de entrada
tendenciaAlcista = emaFast > emaSlow
tendenciaBajista = emaFast < emaSlow
noSobrecompra    = rsi < rsiOverbought
noSobreventaExt  = rsi > rsiOversold

longCondition  = close > resistenciaReciente and tendenciaAlcista and noSobrecompra
shortCondition = close < soporteReciente and tendenciaBajista and noSobreventaExt

if (longCondition)
    strategy.entry("Long", strategy.long)
if (shortCondition)
    strategy.entry("Short", strategy.short)

// Gestión del Stop-Loss y Trailing Stop
if (strategy.position_size > 0)
    stopLong = strategy.position_avg_price - atr * atrMultSL
    strategy.exit("Exit Long", from_entry="Long", stop=stopLong, trail_points=atr * atrMultTrail, trail_offset=atr * atrMultTrail)
if (strategy.position_size < 0)
    stopShort = strategy.position_avg_price + atr * atrMultSL
    strategy.exit("Exit Short", from_entry="Short", stop=stopShort, trail_points=atr * atrMultTrail, trail_offset=atr * atrMultTrail)

// Visualización en el gráfico
plotshape(series=longCondition, location=location.belowbar, color=color.green, style=shape.triangleup, title="Entrada Long")
plotshape(series=shortCondition, location=location.abovebar, color=color.red, style=shape.triangledown, title="Entrada Short")

// === VISUALIZACIÓN DE SOPORTES Y RESISTENCIAS CON RUPTURAS (estilo punteado, gris) ===
plot(resistenciaReciente, title="Resistencia Reciente", color=color.gray, style=plot.style_steplinebr, linewidth=1)
plot(soporteReciente, title="Soporte Reciente", color=color.rgb(103, 103, 105), style=plot.style_steplinebr, linewidth=1)

rupturaAlcista = close > resistenciaReciente
rupturaBajista = close < soporteReciente

plotshape(rupturaAlcista, location=location.abovebar, style=shape.labelup, color=color.rgb(199, 201, 201), size=size.small, title="Breakout Alcista")
plotshape(rupturaBajista, location=location.belowbar, style=shape.labeldown, color=color.rgb(131, 131, 131), size=size.small, title="Breakout Bajista")


// === VISUALIZACIÓN SL Y TRAILING STOP ===
maxLookback = 100  // longitud fija de lookback para trailing dinámico
longHigh = ta.highest(high, maxLookback)
shortLow = ta.lowest(low, maxLookback)

var float trailingStop = na
var float stopLoss = na

if (strategy.position_size > 0)
    stopLoss := strategy.position_avg_price - atr * atrMultSL
    trailingStop := longHigh - atr * atrMultTrail
else if (strategy.position_size < 0)
    stopLoss := strategy.position_avg_price + atr * atrMultSL
    trailingStop := shortLow + atr * atrMultTrail
else
    stopLoss := na
    trailingStop := na

plot(stopLoss, title="Stop Loss", color=color.rgb(234, 125, 216), style=plot.style_stepline_diamond, linewidth=1)
plot(trailingStop, title="Trailing Stop", color=color.rgb(255, 0, 251), style=plot.style_stepline_diamond, linewidth=1)




// Alertas para Webhook
alertcondition(longCondition and strategy.position_size == 0, title="Alerta Entrada Long", message='{"symbol":"{{ticker}}", "qty":1, "side":"buy", "type":"market", "action":"entry"}')

alertcondition(shortCondition and strategy.position_size == 0, title="Alerta Entrada Short", message='{"symbol":"{{ticker}}", "qty":1, "side":"sell", "type":"market", "action":"entry"}')


salidaGeneral = (strategy.position_size[1] != 0 and strategy.position_size == 0)
alertcondition(salidaGeneral, title="Alerta Salida General", message='{"symbol":"{{ticker}}", "action":"close", "type":"market"}')