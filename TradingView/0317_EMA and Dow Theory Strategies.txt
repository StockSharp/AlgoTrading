//@version=6
strategy("EMA and Dow Theory Strategies", overlay=true, initial_capital = 1660, commission_type=strategy.commission.percent, commission_value=0.055, margin_long = 0.001, margin_short = 0.001, precision = 4)

// =====================
// ÂÖ•Âäõ
// =====================
// ÁèæÂú®„ÅÆÈäòÊüÑ„Åä„Çà„Å≥ÂèÇÁÖß„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆEMA
lenFast                         = input.int(47, "Fast EMA", group = " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ SETTINGS ]")
lenSlow                         = input.int(50, "Slow EMA", group = " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ SETTINGS ]")
idxlenFast                      = input.int(47, "Index Fast EMA", group = " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ SETTINGS ]")
idxlenSlow                      = input.int(50, "Index Slow EMA", group = " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ SETTINGS ]")

// Âà©Á¢∫„Åä„Çà„Å≥ÊêçÂàá„Çä„ÅÆÈñæÂÄ§
StopLoss                      = input.float(-5,"ÊêçÂàá„Çä", step=0.5, group = " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ TAKE PROFIT / STOP LOSS ]")
ScaleOut_Perc_onChangeColor     = input.float(65., "„Çπ„Ç±„Éº„É´Ë™øÊï¥„ÅÆÂâ≤Âêà", group = " ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ TAKE PROFIT / STOP LOSS ]")

// =====================
// „É¶„Éº„Ç∂„ÉºË®≠ÂÆöÔºö„ÉÜ„Éº„Éñ„É´„ÅÆ‰ΩçÁΩÆ
// =====================
ShowTradePnL                     = input.bool(true, "Áõ¥Ëøë„Éà„É¨„Éº„Éâ„ÅÆÊêçÁõä„É©„Éô„É´„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü", group=" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ STATS DISPLAY ]")
tablePositionInput               = input.string("Bottom Right", title="Áµ±Ë®à„ÉÜ„Éº„Éñ„É´„ÅÆ‰ΩçÁΩÆ", options=["Top Left", "Top Right", "Bottom Left", "Bottom Right"], group=" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[ STATS DISPLAY ]")

// =====================
// Ë®àÁÆóÂá¶ÁêÜ
// =====================
// ÁèæÂú®„ÅÆÈäòÊüÑ„Åä„Çà„Å≥ÂèÇÁÖß„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆEMAË®àÁÆó
this_ema1 = ta.ema(close, lenFast)
this_ema2 = ta.ema(close, lenSlow)

oth_price = request.security("CRYPTOCAP:OTHERS.D", timeframe.period, close, lookahead = barmerge.lookahead_off)
oth_ema1 = ta.ema(oth_price, idxlenFast)
oth_ema2 = ta.ema(oth_price, idxlenSlow)

var float Equity_AtStartTrade = na
var float TruePnL = na
TruePnL := na(Equity_AtStartTrade) ? na : ((strategy.equity / Equity_AtStartTrade) - 1.0) * 100.0
// =====================
// „Ç®„É≥„Éà„É™„ÉºÊù°‰ª∂
// =====================

// === Â§âÊï∞„ÅÆÂàùÊúüÂåñÔºàÊúÄ‰∏äÈÉ®„Å´ÈÖçÁΩÆÔºâ ===
var int rsiExitCount = 0
var bool waitForColorChange = false

goLong  = (this_ema1 >= this_ema2 and oth_ema1 < oth_ema2) or (this_ema1 > this_ema2)
goShort = (this_ema1 < this_ema2 and oth_ema1 > oth_ema2) or (this_ema1 < this_ema2)

// Áõ∏Èñ¢Áä∂ÊÖã„Å´Âü∫„Å•„ÅÑ„Å¶Ëâ≤„ÇíÂâ≤„ÇäÂΩì„Å¶„Çã
color_This = this_ema1 >= this_ema2 and oth_ema1 >= oth_ema2 ? color.lime : this_ema1 >= this_ema2 and oth_ema1 < oth_ema2 ?  color.teal : this_ema1 < this_ema2 and oth_ema1 > oth_ema2 ? color.maroon :  color.red

// üìå „Çπ„Ç§„É≥„Ç∞Ê§úÂá∫ÊúüÈñì„ÅÆË®≠ÂÆö
length = input.int(6, minval=1, title="„Çπ„Ç§„É≥„Ç∞Ê§úÂá∫ÊúüÈñì")
// ==============================
// üîç „Çπ„Ç§„É≥„Ç∞Âà§ÂÆöÔºàÁèæÊôÇÈñìË∂≥Ôºâ
// ==============================
isSwingHigh = high[length] == ta.highest(high, length * 2 + 1)
isSwingLow  = low[length] == ta.lowest(low, length * 2 + 1)

swingHighPrice = isSwingHigh ? high[length] : na
swingLowPrice  = isSwingLow  ? low[length]  : na

var float lastSwingHigh = na
var float lastSwingLow = na
lastSwingHigh := na(swingHighPrice) ? lastSwingHigh : swingHighPrice
lastSwingLow  := na(swingLowPrice)  ? lastSwingLow  : swingLowPrice

// ==============================
// üìä „Éà„É¨„É≥„ÉâÂà§ÂÆöÔºàÁèæÊôÇÈñìË∂≥Ôºâ
// ==============================
var int trend = 0  // 1 = ‰∏äÊòá, -1 = ‰∏ãÈôç, 0 = Êú™ÂÆö
if not na(lastSwingHigh) and close > lastSwingHigh and trend != 1
    trend := 1
if not na(lastSwingLow) and close < lastSwingLow and trend != -1
    trend := -1

// ==============================
// üñç „Çπ„Ç§„É≥„Ç∞„É©„Ç§„É≥ÊèèÁîª
// ==============================
plot(trend == -1 ? lastSwingHigh : na, title="„Çπ„Ç§„É≥„Ç∞„Éè„Ç§", color=color.red, linewidth=1)
plot(trend == 1 ? lastSwingLow  : na, title="„Çπ„Ç§„É≥„Ç∞„É≠„Éº", color=color.green, linewidth=1)

// ==============================
// üé® „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Çæ„Éº„É≥ÊèèÁîª
// ==============================
barPrice = close

// „Çπ„Ç§„É≥„Ç∞„Éè„Ç§ ‚Üí Ëµ§„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
swingHigh_base = trend == -1 ? lastSwingHigh : na
swingHigh_s1 = trend == -1 ? swingHigh_base - (swingHigh_base - barPrice) * 0.2 : na
swingHigh_s2 = trend == -1 ? swingHigh_base - (swingHigh_base - barPrice) * 0.4 : na
swingHigh_s3 = trend == -1 ? swingHigh_base - (swingHigh_base - barPrice) * 0.6 : na
swingHigh_s4 = trend == -1 ? swingHigh_base - (swingHigh_base - barPrice) * 0.8 : na
swingHigh_end = trend == -1 ? barPrice : na

swingHigh_p0 = plot(swingHigh_base, display=display.none)
swingHigh_p1 = plot(swingHigh_s1, display=display.none)
swingHigh_p2 = plot(swingHigh_s2, display=display.none)
swingHigh_p3 = plot(swingHigh_s3, display=display.none)
swingHigh_p4 = plot(swingHigh_s4, display=display.none)
swingHigh_p5 = plot(swingHigh_end,  display=display.none)

fill(swingHigh_p0, swingHigh_p1, color=color.new(color.red, 20))
fill(swingHigh_p1, swingHigh_p2, color=color.new(color.red, 40))
fill(swingHigh_p2, swingHigh_p3, color=color.new(color.red, 60))
fill(swingHigh_p3, swingHigh_p4, color=color.new(color.red, 80))
fill(swingHigh_p4, swingHigh_p5, color=color.new(color.red, 90))

// „Çπ„Ç§„É≥„Ç∞„É≠„Éº ‚Üí Á∑ë„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
swingLow_base = trend == 1 ? lastSwingLow : na
swingLow_s1 = trend == 1 ? swingLow_base + (barPrice - swingLow_base) * 0.2 : na
swingLow_s2 = trend == 1 ? swingLow_base + (barPrice - swingLow_base) * 0.4 : na
swingLow_s3 = trend == 1 ? swingLow_base + (barPrice - swingLow_base) * 0.6 : na
swingLow_s4 = trend == 1 ? swingLow_base + (barPrice - swingLow_base) * 0.8 : na
swingLow_end = trend == 1 ? barPrice : na

swingLow_p0 = plot(swingLow_base, display=display.none)
swingLow_p1 = plot(swingLow_s1, display=display.none)
swingLow_p2 = plot(swingLow_s2, display=display.none)
swingLow_p3 = plot(swingLow_s3, display=display.none)
swingLow_p4 = plot(swingLow_s4, display=display.none)
swingLow_p5 = plot(swingLow_end,  display=display.none)

fill(swingLow_p0, swingLow_p1, color=color.new(color.green, 20))
fill(swingLow_p1, swingLow_p2, color=color.new(color.green, 40))
fill(swingLow_p2, swingLow_p3, color=color.new(color.green, 60))
fill(swingLow_p3, swingLow_p4, color=color.new(color.green, 80))
fill(swingLow_p4, swingLow_p5, color=color.new(color.green, 90))

//‰∏ä‰ΩçË∂≥Âºï„Åç„Åæ„Åô

// ==============================
// üïí ‰∏ä‰ΩçË∂≥„Çπ„Ç§„É≥„Ç∞„Å®„Éà„É¨„É≥„ÉâÂà§ÂÆö
// ==============================
tf = timeframe.period
htf = tf == "1" ? "5" : tf == "3" ? "5" : tf == "5" ? "15" : tf == "15" ? "30" : tf == "30" ? "60" : tf == "60" ? "240" : tf == "240" ? "D" : tf == "D" ? "W" : tf == "W" ? "M" : tf == "M" ? "12M" : ""

htfSwingHigh = request.security(syminfo.tickerid, "240", ta.pivothigh(high, length, length) )
htfSwingLow  = request.security(syminfo.tickerid, "240", ta.pivotlow(low, length, length) )

var float lastHTFSwingHigh = na
var float lastHTFSwingLow  = na
lastHTFSwingHigh := na(htfSwingHigh) ? lastHTFSwingHigh : htfSwingHigh
lastHTFSwingLow  := na(htfSwingLow)  ? lastHTFSwingLow  : htfSwingLow

htfClose = request.security(syminfo.tickerid, "240", close)
var int htfTrend = 0
if not na(lastHTFSwingHigh) and htfClose > lastHTFSwingHigh and htfTrend != 1
    htfTrend := 1
if not na(lastHTFSwingLow) and htfClose < lastHTFSwingLow and htfTrend != -1
    htfTrend := -1

plot(htfTrend == -1 ? lastHTFSwingHigh : na, title="‰∏ä‰ΩçË∂≥„Çπ„Ç§„É≥„Ç∞„Éè„Ç§", color=color.fuchsia, linewidth=2)
plot(htfTrend == 1 ? lastHTFSwingLow  : na, title="‰∏ä‰ΩçË∂≥„Çπ„Ç§„É≥„Ç∞„É≠„Éº", color=color.aqua, linewidth=2)
//‰∏ä‰ΩçË∂≥Âºï„Åç„Åæ„Åô

// =====================
// „Ç§„Ç∞„Ç∏„ÉÉ„ÉàÊù°‰ª∂
// =====================

// „É™„Ç¢„É´„Çø„Ç§„É†„ÅÆÊêçÁõä„ÇíËøΩË∑°„Åó„ÄÅÂãïÁöÑ„Å™„Ç§„Ç∞„Ç∏„ÉÉ„Éà„ÇíÂÆüË°å„Åô„Çã
var PnL = 0.
LastTriggeredPrice = strategy.opentrades.entry_price(strategy.opentrades - 1)
if strategy.position_size > 0.0 and LastTriggeredPrice != 0.0
    PnL := ((close - LastTriggeredPrice) / LastTriggeredPrice) * 100.0
else if strategy.position_size < 0.0 and LastTriggeredPrice != 0.0
    PnL := ((LastTriggeredPrice - close) / LastTriggeredPrice) * 100.0

// ÂãïÁöÑ„Å™ÈÉ®ÂàÜÂà©Á¢∫„É≠„Ç∏„ÉÉ„ÇØ„ÄÅ„Ç´„Çπ„Çø„É†ÊêçÂàá„Çä„Åä„Çà„Å≥Âà©Á¢∫Ë®≠ÂÆö
var TruePnLToDisplay = PnL
var DontGo = ""

if (PnL < StopLoss) and math.abs(strategy.position_size) != 0.0
    if strategy.position_size > 0. and not goShort
        DontGo := "LONG"
        strategy.close("Long","STOPLOSS Long")
        alert('{"Symbol":"' + syminfo.ticker + '","Side":"Buy","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":false, "Vertion":"3"}', alert.freq_once_per_bar)
        rsiExitCount += 1
    if strategy.position_size < 0. and not goLong
        DontGo := "SHORT"
        strategy.close("Short","STOPLOSS Short")
        alert('{"Symbol":"' + syminfo.ticker + '","Side":"Sell","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":false, "Vertion":"3"}', alert.freq_once_per_bar)
        rsiExitCount += 1


// === Ëâ≤Âàá„ÇäÊõø„Åà„Åß„Ç®„É≥„Éà„É™„ÉºÂÜçË®±ÂèØ ===
if waitForColorChange and color_This != color_This[1]
    waitForColorChange := false
    rsiExitCount := 0

// RSIË®≠ÂÆö
rsiLength = input.int(14, title="RSIÊúüÈñì")
rsiOverbought = input.int(70, title="ÈÅéÁÜ±Ê∞¥Ê∫ñ")
rsiOversold = input.int(30, title="Â£≤„Çâ„Çå„Åô„ÅéÊ∞¥Ê∫ñ")

// RSI„ÅÆË®àÁÆó
rsi = ta.rsi(close, rsiLength)

// === „Ç®„É≥„Éà„É™„ÉºÊù°‰ª∂„Å´Âà∂Èôê„ÇíËøΩÂä† ===

canEnter = not waitForColorChange or rsiExitCount < 2


// „Éà„É¨„É≥„ÉâÊù°‰ª∂„ÅåÊîπÂñÑ„Åó„Åü„Å®„Åç„Å´„ÄåDontGo„Äç„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã
if DontGo == "LONG" and (color_This[1] == color.lime or color_This[1] == color.teal) and color_This != color.maroon
    DontGo := ""
if DontGo == "SHORT" and (color_This[1] == color.red or color_This[1] == color.maroon) and color_This != color.teal
    DontGo := ""

// „Éù„Ç∏„Ç∑„Éß„É≥„Åî„Å®„ÅÆÈáçË§á„Çπ„Ç±„Éº„É´„Ç¢„Ç¶„Éà„ÇíÈò≤Ê≠¢„Åô„Çã„Éï„É©„Ç∞
var Scaled = false

// „Éà„É¨„É≥„Éâ„ÅåÂº±„Åæ„Å£„Åü„Åå„Åæ„Å†Âà©Áõä„Åå„ÅÇ„Çã„Å®„Åç„Å´ÈÉ®ÂàÜÂà©Á¢∫„ÇíË°å„ÅÜ
if strategy.position_size > 0. and (color_This[1] == color.lime and color_This != color.lime) and PnL > 0.1 and not Scaled and not goShort
    strategy.close('Long', comment = "ScaleOut Long", qty_percent = 50)
    alert('{"Symbol":"' + syminfo.ticker + '","Side":"Buy","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":true, "Vertion":"3"}', alert.freq_once_per_bar)
    Scaled := true

if strategy.position_size < 0. and (color_This[1] == color.red and color_This != color.red) and PnL > 0.1 and not Scaled and not goLong
    strategy.close('Short', comment = "ScaleOut Short", qty_percent = 50)
    alert('{"Symbol":"' + syminfo.ticker + '","Side":"Sell","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":true, "Vertion":"3"}', alert.freq_once_per_bar)
    Scaled := true



// =======================
// „Ç®„É≥„Éà„É™„Éº / ÂèçËª¢
// =======================

if trend == 1 and strategy.position_size < 0
    strategy.close("Short","rsi70Signal")
    alert('{"Symbol":"' + syminfo.ticker + '","Side":"Sell","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":false, "Vertion":"3"}', alert.freq_once_per_bar)
    rsiExitCount += 1

if trend == -1 and strategy.position_size > 0
    strategy.close("Long","rsi70Signal")
    alert('{"Symbol":"' + syminfo.ticker + '","Side":"Buy","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":false, "Vertion":"3"}', alert.freq_once_per_bar)
    rsiExitCount += 1

// goLong / goShort „Å´RSIÊù°‰ª∂„ÇíÂèçÊò†
allowLong  = goLong
allowShort = goShort

if strategy.position_size <= 0. and allowLong and DontGo != "LONG" and canEnter
        // „ÇÇ„Åó„Ç∑„Éß„Éº„Éà„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åü„ÇâÂÖà„Å´„ÇØ„É≠„Éº„Ç∫
    if strategy.position_size < 0
        strategy.close("Short", comment = "Exit Short Before Long")
        alert('{"Symbol":"' + syminfo.ticker + '","Side":"Sell","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":false, "Vertion":"3"}', alert.freq_once_per_bar)

    if strategy.position_size == 0 and trend == 1  and rsi < rsiOverbought
        Equity_AtStartTrade := strategy.equity
        strategy.entry("Long", strategy.long)
        alert('{"Symbol":"' + syminfo.ticker + '","Side":"Buy","Price":' + str.tostring(close) + ',"Exit":false,"HalfExit":false, "Vertion":"3","Stop":'+str.tostring(0)+'}', alert.freq_once_per_bar_close)
        Scaled := false
        DontGo := ""
if strategy.position_size >= 0. and allowShort and DontGo != "SHORT" and canEnter
    // „ÇÇ„Åó„É≠„É≥„Ç∞„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åü„ÇâÂÖà„Å´„ÇØ„É≠„Éº„Ç∫
    if strategy.position_size > 0
        strategy.close("Long", comment = "Exit Long Before Short")
        alert('{"Symbol":"' + syminfo.ticker + '","Side":"Buy","Price":' + str.tostring(close) + ',"Exit":true,"HalfExit":false, "Vertion":"3"}', alert.freq_once_per_bar)

    if strategy.position_size == 0 and trend == -1 and rsi > rsiOversold
        Equity_AtStartTrade := strategy.equity
        strategy.entry("Short", strategy.short)
        alert('{"Symbol":"' + syminfo.ticker + '","Side":"Sell","Price":' + str.tostring(close) + ',"Exit":false,"HalfExit":false, "Vertion":"3","Stop":'+str.tostring(0)+'}', alert.freq_once_per_bar_close)
        Scaled := false
        DontGo := ""


//
//-----<VISUALS>-----------------------------------------------------------------------------------------------<>

// =====================
// „Éá„Éê„ÉÉ„Ç∞„Éó„É≠„ÉÉ„Éà
// =====================
// ÁèæÂú®„ÅÆÈäòÊüÑ„Åä„Çà„Å≥„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÈäòÊüÑ„ÅÆË≥áÁî£‰æ°ÂÄ§„ÇÑEMA„Å™„Å©„ÄÅÊúâÁî®„Å™„Éá„Éê„ÉÉ„Ç∞ÂÄ§„Çí„Éó„É≠„ÉÉ„Éà„Åô„Çã
plotchar(strategy.equity,"Ë≥áÁî£ÊÆãÈ´ò","",location.top,color=color.white)
plotchar(this_ema1,"this_ema1","",location.top,color=color.yellow)
plotchar(this_ema2,"this_ema2","",location.top,color=color.yellow)
plotchar(oth_ema1,"oth_ema1","",location.top,color=color.purple)
plotchar(oth_ema2,"oth_ema2","",location.top,color=color.purple)
colorPnL = PnL > 0.0? color.green : color.red
plotchar(PnL,"PnL","",location.top,color=colorPnL)
plotchar(TruePnL,"TruePnL","",location.top,color=color.aqua)

// =====================
// Áõ¥Ëøë„Éà„É¨„Éº„Éâ„ÅÆÊêçÁõä„Éó„É≠„ÉÉ„Éà
// =====================
// „ÉÅ„É£„Éº„Éà‰∏ä„Å´Áõ¥Ëøë„Éà„É¨„Éº„Éâ„ÅÆÊêçÁõäÔºàÔºÖÔºâ„ÇíË°®Á§∫„Åô„ÇãË¶ñË¶ö„É©„Éô„É´
//

rangeR = high - low
avgRangeR = ta.sma(rangeR, 20)
if strategy.closedtrades > 0
    lastTradeIndex = strategy.closedtrades - 1
    lastTradeProfit = strategy.closedtrades.profit_percent(lastTradeIndex)
    lastTradeEntryBar = strategy.closedtrades.exit_bar_index(lastTradeIndex)
    lastTradeDirection = strategy.closedtrades.size(lastTradeIndex)

    // Áõ¥Ëøë„ÅÆ„Éà„É¨„Éº„Éâ„Åå„Åì„ÅÆ„Éê„Éº„ÅßÊ±∫Ê∏à„Åï„Çå„ÅüÂ†¥Âêà
    if lastTradeEntryBar == bar_index
        tradeColor = TruePnLToDisplay > 0 ? color.green : color.red
        uscitaFinale = strategy.position_size == 0. or lastTradeDirection > 0.0 and strategy.position_size < 0. or lastTradeDirection < 0.0 and strategy.position_size > 0.
        _size = size.normal
        SO_PnL = TruePnLToDisplay * (ScaleOut_Perc_onChangeColor / 100.)
        Perc_PL = str.tostring(math.round(SO_PnL, 1)) + '%' + "\n(" + str.tostring(math.round(PnL[1],1)) + '%' + ")"
        text_color = color.black
        if uscitaFinale
            _size   := size.large
            Perc_PL := str.tostring(math.round(TruePnLToDisplay, 1)) + '%' + "\n(" + str.tostring(math.round(lastTradeProfit,1)) + '%' + ")"
            text_color := color.white
        TradePL_Y_pos = high+(avgRangeR*5)
        ProOPer = label.new(x = bar_index, y = TradePL_Y_pos, text = Perc_PL, color = tradeColor, textcolor = text_color, style = label.style_label_down, size = _size)
    else
        TruePnLToDisplay := TruePnL

// =====================
// ËÉåÊôØ„ÅÆËâ≤‰ªò„Åë
// =====================
// „Ç®„É≥„Éà„É™„Éº‰æ°Ê†º„Å®ÁµÇÂÄ§„ÅÆÈñì„ÅÆËÉåÊôØ„ÇíÂ°ó„Çä„Å§„Å∂„Åó„ÄÅ„Éù„Ç∏„Ç∑„Éß„É≥„ÅÆË¶ñË¶öÁöÑ„Å™ÁõÆÂÆâ„ÇíË°®Á§∫„Åô„Çã
lowestClose = ta.lowest(close, 10)
_css = strategy.position_size == 0.0 ? color.gray : strategy.position_size > 0.0 ? color.yellow : strategy.position_size < 0.0 ? color.purple :  na
plotBottom = LastTriggeredPrice
if strategy.position_size == 0.0
    _css := color.white
    plotBottom := lowestClose
_plot0 = plot(plotBottom, color=na)
_plot1 = plot(close, color=na)
fill(_plot0,_plot1,color.new(_css,70))

// EMA„Éà„É¨„É≥„Éâ„É©„Ç§„É≥„ÇíÂº∑Ë™øË°®Á§∫„Åô„Çã
plot(this_ema2,"This SlowEMA",color=color_This, linewidth = 2)
plot(this_ema1,"This SlowEMA",color=color_This, linewidth = 2)


//
// ============================================================================== ÊúÄÁµÇÁµ±Ë®à ========

// === ÊúÄÁµÇÁµ±Ë®àÔºàÁèæÂú®„ÅÆ„Éà„É¨„Éº„Éâ„ÇíÂê´„ÇÄÔºâ ===
totalTrades     = strategy.closedtrades + (strategy.opentrades > 0 ? 1 : 0)
winningTrades   = strategy.wintrades + (strategy.opentrades > 0 and strategy.openprofit > 0 ? 1 : 0)
losingTrades    = totalTrades - winningTrades
openProfit      = strategy.openprofit
netProfit       = strategy.netprofit + openProfit
netProfitPerc   = netProfit / strategy.initial_capital * 100
winRate         = totalTrades > 0 ? winningTrades / totalTrades * 100 : na
max_drawdown_percent = strategy.max_drawdown_percent

// ÁèæÂú®„ÅÆ„Éà„É¨„Éº„Éâ„ÅÆÊêçÁõäÔºàÔºÖÔºâ„ÇíË®àÁÆó„Åô„Çã
thisTradePnl    = strategy.opentrades > 0 ? strategy.openprofit : 0
thisTradePerc   = strategy.opentrades > 0 and strategy.opentrades.entry_price(0) > 0 ?  thisTradePnl / (strategy.opentrades.entry_price(0) * math.abs(strategy.opentrades.size(0))) * 100 : 0

// Âπ¥ÈñìÂà©Âõû„ÇäÔºàAPRÔºöÂπ¥ÁéáÊèõÁÆó„É™„Çø„Éº„É≥Ôºâ„ÇíË®àÁÆó„Åô„Çã
firstTradeTime  = strategy.closedtrades > 0 ? strategy.closedtrades.entry_time(0) : na
lastTradeTime   = timenow
daysRunning     = (lastTradeTime - firstTradeTime) / (1000 * 60 * 60 * 24)
daysRounded     = math.round(daysRunning)
apr             = daysRunning > 0 ? (math.pow((strategy.equity / strategy.initial_capital), (365 / daysRunning)) - 1) * 100 : na
Result           = str.tostring(math.round(strategy.equity / strategy.initial_capital,1)) + "x"
color_Result     = netProfit > 0 ? color.green : netProfit < 0 ? color.red : color.gray
icon_Result      = thisTradePnl > 0 ? "üíö" : thisTradePnl < 0 ? "üò°" :"üìä"

// === „Éâ„É≠„Éº„ÉÄ„Ç¶„É≥ÔºàDDÔºâ„ÄÅÂπ¥ÈñìÂà©Âõû„ÇäÔºàAPRÔºâ„ÄÅÊêçÁõäÔºàPnLÔºâ„Å´Âü∫„Å•„ÅèËâ≤ÂàÜ„Åë ===
ddColor = max_drawdown_percent <= 20  ? color.rgb(0, 255, 132)   :
          max_drawdown_percent <= 35  ? color.green  :
          max_drawdown_percent <= 50  ? color.white  :
          max_drawdown_percent <= 70  ? color.yellow :
          max_drawdown_percent <= 85  ? color.orange :
          max_drawdown_percent <= 99  ? color.red    : color.maroon

aprColor = apr > 500     ? color.rgb(0, 255, 132)   :
           apr > 100     ? color.green  :
           apr >= 0      ? color.white  :
           apr >= -20    ? color.yellow :
           apr >= -50    ? color.orange :
           apr >= -90    ? color.red    : color.maroon

thisTradeColor = thisTradePnl > 0 ? color.green : thisTradePnl < 0 ? color.red : color.gray
totalPnlColor  = netProfit > 0 ? color.green : netProfit < 0 ? color.red : color.gray
totalPnlPercColor = netProfitPerc > 0 ? color.green : netProfitPerc < 0 ? color.red : color.gray

apr_STR = str.tostring(apr, "#.##") + "%"
if apr > 100000
    apr_STR := "üí∞üí∞üí∞üí∞üí∞"