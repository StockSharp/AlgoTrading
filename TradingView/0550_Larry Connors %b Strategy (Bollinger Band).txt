// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © EdgeTools

//@version=5
strategy("Larry Connors %b Strategy (Bollinger Band)", overlay=false)

// Parameters for moving averages and Bollinger Bands
sma200 = ta.sma(close, 200)
length = 20  // Bollinger Band period
src = close  // Source for Bollinger Bands
mult = 2.0   // Bollinger Band standard deviation multiplier

// Calculate Bollinger Bands and %b
basis = ta.sma(src, length)
dev = ta.stdev(src, length)
upperBand = basis + mult * dev
lowerBand = basis - mult * dev
percentB = (close - lowerBand) / (upperBand - lowerBand)

// Conditions for the strategy
condition1 = close > sma200  // Condition 1: Close is above the 200-day moving average

// %b must be below 0.2 for the last three consecutive days
condition2 = percentB[2] < 0.2 and percentB[1] < 0.2 and percentB < 0.2

// Combined buy condition
buyCondition = condition1 and condition2

// Sell condition: %b closes above 0.8
sellCondition = percentB > 0.8

// Execute buy signal when buy condition is met
if buyCondition
    strategy.entry("Buy", strategy.long)

// Execute sell signal when the sell condition is met
if sellCondition
    strategy.close("Buy")

// Plotting Bollinger Bands
plot(upperBand, color=color.new(color.rgb(255, 0, 0), 50), title="Upper Bollinger Band")  // Red color with 50% transparency
plot(lowerBand, color=color.new(color.rgb(0, 255, 0), 50), title="Lower Bollinger Band")  // Green color with 50% transparency
plot(basis, color=color.rgb(0, 0, 255), title="Middle Bollinger Band")  // Blue color

// Plot %b value for visual confirmation
plot(percentB, color=color.rgb(128, 0, 128), linewidth=2, title="%b Value")  // Purple color

// Additional lines to improve visualization
hline(0.2, "Oversold (0.2)", color=color.rgb(255, 165, 0), linestyle=hline.style_dashed)  // Orange dashed line at 0.2
hline(0.8, "Overbought (0.8)", color=color.rgb(255, 105, 180), linestyle=hline.style_dashed)  // Pink dashed line at 0.8

// Set background color when a position is open
bgcolor(strategy.opentrades > 0 ? color.new(color.green, 50) : na)