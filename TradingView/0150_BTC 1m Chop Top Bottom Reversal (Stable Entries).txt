// BTC 1m Chop Top/Bottom Reversal Strategy - Optimized for Short-Term Swings

//@version=5
strategy("BTC 1m Chop Top/Bottom Reversal (Stable Entries + Trend Band)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10, calc_on_order_fills=true, calc_on_every_tick=true, pyramiding=7, commission_type=strategy.commission.percent, commission_value=0.06, process_orders_on_close=true)

// === INPUTS ===
emaLen = input.int(23, "EMA Period")
atrlength = input.int(55, "ATR Length")
atrMultiplier = input.float(4.4, "ATR Deviation Multiplier")
rsiLength = input.int(9, "RSI Length")
rsiOverbought = input.int(68, "RSI Overbought")
rsiOversold = input.int(28, "RSI Oversold")
macdFast = input.int(14, "MACD Fast")
macdSlow = input.int(44, "MACD Slow")
macdSignal = input.int(3, "MACD Signal")
// Volume spike inputs
volLookback = input.int(16, "Volume MA Length")
volSpikeMult = input.float(1.5, "Sell Spike Multiplier")

// === CALCULATIONS ===
// Volume spike detection
volMA = ta.sma(volume, volLookback)
sellSpike = (volume > volMA * volSpikeMult) and (close < open)

ema = ta.ema(close, emaLen)
atr = ta.atr(atrlength)
upperBand = ema + atrMultiplier * atr
lowerBand = ema - atrMultiplier * atr
rsi = ta.rsi(close, rsiLength)
[macdLine, macdSignalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)

// === ENTRY LOGIC ===
shortSetup = high > upperBand and rsi > rsiOverbought and macdHist < macdHist[1] and macdHist[1] > 0 and close < open
longSetup = low < lowerBand and rsi < rsiOversold and macdHist > macdHist[1] and macdHist[1] < 0 and close > open

shortConfirmed = shortSetup and not shortSetup[1]
longConfirmed = longSetup and not longSetup[1] and not sellSpike

if shortConfirmed
    strategy.entry("Short", strategy.short)
if longConfirmed
    strategy.entry("Long", strategy.long)

// === EXITS ===
shortTP = close * 0.9925
shortSL = close * 1.004
strategy.exit("Short Exit", from_entry="Short", limit=shortTP, stop=shortSL)

longTP = close * 1.0075
longSL = close * 0.996
strategy.exit("Long Exit", from_entry="Long", limit=longTP, stop=longSL)

// === TREND STRENGTH ZONE (Broader Smoothing) ===
trendScore = (macdHist - macdHist[1]) + (rsi - 50) / 25
trendBasis = ta.ema(trendScore, 30)  // Increased smoothing period from 10 to 30
bullishZone = trendBasis > 0.3       // Slightly lowered sensitivity thresholds
bearishZone = trendBasis < -0.3
neutralZone = not bullishZone and not bearishZone

trendColor = bullishZone ? color.new(color.green, 80) : bearishZone ? color.new(color.red, 80) : color.new(color.gray, 85)
bgcolor(trendColor, title="Trend Strength Zone")

// === VISUALS ===
plot(ema, title="EMA", color=color.orange)
plot(upperBand, title="Upper ATR Band", color=color.red)
plot(lowerBand, title="Lower ATR Band", color=color.green)
plotshape(shortConfirmed ? true : na, title="Short Entry", location=location.abovebar, style=shape.triangledown, color=color.red)
plotshape(longConfirmed ? true : na, title="Long Entry", location=location.belowbar, style=shape.triangleup, color=color.green)