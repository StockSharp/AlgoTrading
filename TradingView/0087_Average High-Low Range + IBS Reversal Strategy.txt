// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Botnet101

//@version=6
strategy('Average High-Low Range + IBS Reversal Strategy', overlay = true, default_qty_value = 100, default_qty_type = strategy.percent_of_equity, margin_long = 5, margin_short = 5, process_orders_on_close = true, precision = 4, calc_on_every_tick = true)

in_start_time = input.time(timestamp('1 Jan 2014'), title = 'Start Time', group = 'Time Settings')
in_end_time = input.time(timestamp('1 Jan 2099'), title = 'End Time', group = 'Time Settings')
in_window = time >= in_start_time and time <= in_end_time

length = input.int(20)
bars_below_threshold = input.int(defval=2)
ibs_buy_treshold = input.float(0.2, step=0.1)

hl_avg = ta.sma(high - low, length)
lower = ta.lowest(length)
upper = ta.highest(length)
basis = math.avg(upper, lower)

_ema = ta.ema(close, 5)
ibs = (close - low) / (high - low)
buy_threshold = upper - (2.5 * hl_avg)

plot(hl_avg, 'Upper', color = color.new(color.red, 0), linewidth = 1, force_overlay = true)
plot(buy_threshold, 'Lower', color = color.new(color.yellow, 0), linewidth = 1, force_overlay = true)

number_of_bars_below = ta.barssince(close>buy_threshold) >= bars_below_threshold
number_of_bars_above = ta.barssince(close<buy_threshold) >= bars_below_threshold

longCondition  = number_of_bars_below and in_window and ibs<ibs_buy_treshold
shortCondition = close>high[1]

if longCondition
    strategy.entry('long', strategy.long)
if shortCondition
    strategy.close_all()