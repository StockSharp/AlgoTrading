//@version=5
strategy("Supertrend Long-Only Strategy for QQQ", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// === Inputs ===
atrPeriod    = input.int(32, "ATR Period")
factor       = input.float(4.35, "ATR Multiplier", step=0.02)
changeATR    = input.bool(true, "Change ATR Calculation Method?")
showsignals  = input.bool(false, "Show Buy/Sell Signals?")
highlighting = input.bool(true, "Highlighter On/Off?")
barcoloring  = input.bool(true, "Bar Coloring On/Off?")

// === Date Range Filter ===
FromMonth = input.int(1, "From Month", minval = 1, maxval = 12)
FromDay   = input.int(1, "From Day", minval = 1, maxval = 31)
FromYear  = input.int(1995, "From Year", minval = 999)
ToMonth   = input.int(1, "To Month", minval = 1, maxval = 12)
ToDay     = input.int(1, "To Day", minval = 1, maxval = 31)
ToYear    = input.int(2050, "To Year", minval = 999)
start     = timestamp(FromYear, FromMonth, FromDay, 00, 00)
finish    = timestamp(ToYear, ToMonth, ToDay, 23, 59)
window    = (time >= start and time <= finish)

// === ATR Calculation ===
atrAlt = ta.sma(ta.tr, atrPeriod)
atr    = changeATR ? ta.atr(atrPeriod) : atrAlt

// === Supertrend Logic ===
src  = close
up   = src - factor * atr
up1  = nz(up[1], up)
up   := close[1] > up1 ? math.max(up, up1) : up

dn   = src + factor * atr
dn1  = nz(dn[1], dn)
dn   := close[1] < dn1 ? math.min(dn, dn1) : dn

var trend = 1
trend := nz(trend[1], 1)
trend := trend == -1 and close > dn1 ? 1 : trend == 1 and close < up1 ? -1 : trend

// === Entry/Exit Conditions ===
buySignal  = trend == 1 and trend[1] == -1
sellSignal = trend == -1 and trend[1] == 1

longCondition = buySignal and window
exitCondition = sellSignal and window

if (longCondition)
    strategy.entry("BUY", strategy.long)
if (exitCondition)
    strategy.close("BUY")

// === Supertrend Plots ===
upPlot = plot(trend == 1 ? up : na, title="Up Trend", style=plot.style_linebr, linewidth=2, color=color.green)
dnPlot = plot(trend == -1 ? dn : na, title="Down Trend", style=plot.style_linebr, linewidth=2, color=color.red)

// === Entry/Exit Markers ===


plotshape(buySignal and showsignals ? up : na, title="Buy",  text="Buy",  location=location.absolute, style=shape.labelup,   size=size.tiny, color=color.green, textcolor=color.white)
plotshape(sellSignal and showsignals ? dn : na, title="Sell", text="Sell", location=location.absolute, style=shape.labeldown, size=size.tiny, color=color.red,   textcolor=color.white)

// === Highlighter Fills ===
mPlot = plot(ohlc4, title="Mid", style=plot.style_circles, linewidth=0)
longFillColor  = highlighting and trend == 1 ? color.new(color.green, 80) : na
shortFillColor = highlighting and trend == -1 ? color.new(color.red, 80)   : na
fill(mPlot, upPlot, title="UpTrend Highlighter", color=longFillColor)
fill(mPlot, dnPlot, title="DownTrend Highlighter", color=shortFillColor)

// === Bar Coloring ===
buyBars  = ta.barssince(buySignal)
sellBars = ta.barssince(sellSignal)
barcol   = buyBars[1] < sellBars[1] ? color.green : buyBars[1] > sellBars[1] ? color.red : na
barcolor(barcoloring ? barcol : na)