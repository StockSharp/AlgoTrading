//@version=6
strategy("Parabolic SAR Strategy - Exit When SAR > Price AND Price < 11 MA", overlay=true)

// === Inputs ===
start     = input(0.02, "SAR Start")
increment = input(0.02, "SAR Increment")
maximum   = input(0.2, "SAR Maximum")
maPeriod  = input(11, "Exit MA Period")

// === Moving Average ===
sma11 = ta.sma(close, maPeriod)

// === SAR Variables ===
var bool uptrend     = false
var float EP         = na
var float SAR        = na
var float AF         = start
var float nextBarSAR = na

// === SAR Calculation ===
if bar_index > 0
    firstTrendBar = false
    SAR := nextBarSAR

    if bar_index == 1
        float prevSAR = na
        float prevEP = na
        lowPrev   = low[1]
        highPrev  = high[1]
        closeCur  = close
        closePrev = close[1]
        if closeCur > closePrev
            uptrend := true
            EP := high
            prevSAR := lowPrev
            prevEP := high
        else
            uptrend := false
            EP := low
            prevSAR := highPrev
            prevEP := low
        firstTrendBar := true
        SAR := prevSAR + start * (prevEP - prevSAR)

    if uptrend
        if SAR > low
            firstTrendBar := true
            uptrend := false
            SAR := math.max(EP, high)
            EP := low
            AF := start
    else
        if SAR < high
            firstTrendBar := true
            uptrend := true
            SAR := math.min(EP, low)
            EP := high
            AF := start

    if not firstTrendBar
        if uptrend and high > EP
            EP := high
            AF := math.min(AF + increment, maximum)
        else if not uptrend and low < EP
            EP := low
            AF := math.min(AF + increment, maximum)

    if uptrend
        SAR := math.min(SAR, low[1])
        if bar_index > 1
            SAR := math.min(SAR, low[2])
    else
        SAR := math.max(SAR, high[1])
        if bar_index > 1
            SAR := math.max(SAR, high[2])

    nextBarSAR := SAR + AF * (EP - SAR)

    // === Strategy Entry ===
    if barstate.isconfirmed
        if uptrend
            strategy.entry("ParSE", strategy.short, stop=nextBarSAR, comment="ParSE")
            strategy.cancel("ParLE")
        else
            strategy.entry("ParLE", strategy.long, stop=nextBarSAR, comment="ParLE")
            strategy.cancel("ParSE")

// === Exit Condition ===
// SAR is above price AND price is below 11-period MA
exitCondition = SAR > close and close < sma11 and strategy.opentrades > 0 and strategy.opentrades.entry_id(0) == "ParLE"

if exitCondition
    strategy.close("ParLE", comment="Exit: SAR > Price & Close < 11 MA")

// === Plot red flag using plotshape() ===
plotshape(exitCondition, title="Exit Flag", location=location.abovebar, color=color.red, style=shape.flag, size=size.small, text="Exit")

// === Plotting ===
plot(SAR, "SAR", style=plot.style_cross, linewidth=3, color=color.orange)
plot(nextBarSAR, "Next bar SAR", style=plot.style_cross, linewidth=3, color=color.aqua)
plot(sma11, "11 MA", color=color.yellow)

// === Highlight Buy Zone When SAR is Below Price ===
bgcolor(SAR < close ? color.new(color.green, 85) : na, title="SAR Below Price Highlight")