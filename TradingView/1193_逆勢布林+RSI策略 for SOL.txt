//@version=5
strategy("逆勢布林+RSI策略 for SOL", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// 布林通道參數
length = 20
src = close
mult = 2.0
basis = ta.sma(src, length)
dev = mult * ta.stdev(src, length)
upper = basis + dev
lower = basis - dev

// RSI
rsi = ta.rsi(close, 14)

// 時間條件（僅限週一到週五）
isWeekday = dayofweek >= dayofweek.monday and dayofweek <= dayofweek.friday

// 做多進場條件
longEntry = ta.crossover(close, lower) and rsi < 25 and isWeekday

// 做空進場條件
shortEntry = ta.crossunder(close, upper) and rsi > 79 and isWeekday

// 做多停利條件：收盤價上穿上軌
longTP = ta.crossover(close, upper)

// 做空停利條件：收盤價上穿中軌 or 跌幅 >= 3.5%
shortTP1 = ta.crossover(close, basis)
var float shortEntryPrice = na
shortTP2 = not na(shortEntryPrice) and (shortEntryPrice - close) / shortEntryPrice >= 0.035

// 做多停損條件：價格低於進場K棒與前一K棒最低價
var float longSLLevel = na
longSL = not na(longSLLevel) and close < longSLLevel

// 做空出場條件：任何一個停利條件觸發
shortTP = shortTP1 or shortTP2

// 做多進場
if (longEntry)
    longSLLevel := math.min(low, low[1])
    strategy.entry("Long", strategy.long)
    shortEntryPrice := na

// 做空進場
if (shortEntry)
    shortEntryPrice := close
    strategy.entry("Short", strategy.short)
    longSLLevel := na

// 多單停利/停損出場
if (strategy.position_size > 0)
    if (longTP)
        strategy.close("Long", comment="多單停利")
    else if (longSL)
        strategy.close("Long", comment="多單停損")

// 空單出場
if (strategy.position_size < 0 and shortTP)
    strategy.close("Short", comment="空單出場")

// 畫出布林通道
plot(upper, "上軌", color=color.red)
plot(basis, "中軌", color=color.gray)
plot(lower, "下軌", color=color.green)