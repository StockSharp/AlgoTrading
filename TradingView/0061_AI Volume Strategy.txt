//@version=6
strategy("AI Volume Strategy", overlay=true)

// === Parameters ===
volumeEmaLength = input.int(20, title="Volume EMA Length")
volumeMultiplier = input.float(2.0, title="Multiplier (for spike detection)")
exitBars = input.int(5, title="Exit After How Many Bars?", minval=1)  // Default exit after 5 bars
showVolumeEMA = input.bool(false, title="Show Volume EMA", tooltip="Check to show the Volume EMA on the chart")  // Default is false

// === Calculations ===
volumeEMA = ta.ema(volume, volumeEmaLength)
volumeSpike = volume > volumeEMA * volumeMultiplier

// Trend conditions â€“ simple MA to filter direction
priceMA = ta.ema(close, 50)
trendUp = close > priceMA
trendDown = close < priceMA

// Candle conditions (candle color)
isBullishCandle = close > open  // Bullish candle
isBearishCandle = close < open  // Bearish candle

// === Signals ===
buySignal = volumeSpike and trendUp and isBullishCandle
sellSignal = volumeSpike and trendDown and isBearishCandle

// Tracking bars since entry
var int barsSinceEntry = 0

// Entry logic
if buySignal
    strategy.entry("BUY", strategy.long)
    barsSinceEntry := 0  // Reset bars since entry after buying

if sellSignal
    strategy.entry("SELL", strategy.short)
    barsSinceEntry := 0  // Reset bars since entry after selling

// Count bars since entry
barsSinceEntry := barsSinceEntry + 1

// Exit condition after the specified number of bars
exitCondition = barsSinceEntry >= exitBars

// Close positions after the specified number of bars
if exitCondition
    strategy.close("BUY", comment="Exit after " + str.tostring(exitBars) + " bars")
    strategy.close("SELL", comment="Exit after " + str.tostring(exitBars) + " bars")

// === Visualization ===
plotshape(buySignal, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plotshape(sellSignal, title="Sell Signal", location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL")

// Conditionally plot the Volume EMA line based on user input
plot(showVolumeEMA ? volumeEMA : na, title="Volume EMA", color=color.orange)

// === Alerts ===
alertcondition(buySignal, title="Buy Alert", message="AI Volume Signal: BUY")
alertcondition(sellSignal, title="Sell Alert", message="AI Volume Signal: SELL")