//@version=5
strategy("EMA 5 Alert Candle Short", overlay=true)

// Define EMA
emaLength = 5
emaValue = ta.ema(close, emaLength)

// Risk Management Parameters
capital = 1000
riskPerTrade = 2  // Fixed risk per trade in dollars

// Check if previous candles touched EMA, but the current candle is far above EMA
candleTouchesEMA = low <= emaValue
alertCandle = not candleTouchesEMA[0] and candleTouchesEMA[1] and candleTouchesEMA[2] and candleTouchesEMA[3]

// Persistent Variables to Store Alert Levels
varip float validAlertLow = na
varip float validAlertHigh = na
varip bool isAlertActive = false
varip float positionSize = na
varip float capitalUsed = na

// When an alert candle is identified, store its high and low
if alertCandle
    validAlertLow := low
    validAlertHigh := high
    isAlertActive := true

// Calculate Position Sizing
if isAlertActive
    alertCandleRange = validAlertHigh - validAlertLow
    positionSize := riskPerTrade / alertCandleRange  // Shares or contracts
    capitalUsed := positionSize * validAlertLow      // Capital used in dollars

// Check if the next candle breaks the alert candle low (entry condition)
shortTrigger = isAlertActive and low < validAlertLow
if shortTrigger
    shortEntry = validAlertLow
    stopLoss = validAlertHigh
    target = shortEntry - (stopLoss - shortEntry)
    isAlertActive := false  // Disable alert after trade execution

    // Execute trade
    strategy.entry("Short", strategy.short, qty=positionSize, stop=shortEntry)
    strategy.exit("Take Profit", from_entry="Short", limit=target, stop=stopLoss)

    // Plot trade setup with dotted lines
    line.new(x1=bar_index, y1=shortEntry, x2=bar_index+1, y2=shortEntry, color=color.blue, width=2, style=line.style_dotted)
    line.new(x1=bar_index, y1=stopLoss, x2=bar_index+1, y2=stopLoss, color=color.red, width=2, style=line.style_dotted)
    line.new(x1=bar_index, y1=target, x2=bar_index+1, y2=target, color=color.green, width=2, style=line.style_dotted)

    // Display Capital Used on Chart
    label.new(x=bar_index, y=high, text="Capital: $" + str.tostring(capitalUsed, "#.##"), color=color.white, textcolor=color.black, size=size.small, style=label.style_label_down)

// Reset alert candle if next candle does not break low but also does not touch 5EMA
if not shortTrigger and not candleTouchesEMA[0]
    validAlertLow := low
    validAlertHigh := high
    isAlertActive := true

// Plot EMA
plot(emaValue, title="EMA 5", color=color.blue, linewidth=2)

// Mark alert candle
plotshape(alertCandle, location=location.abovebar, color=color.red, style=shape.labeldown, title="Alert Candle")