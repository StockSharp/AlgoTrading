//@version=5
strategy("SSL + Hama Scalping Strategy with Consolidation Detection", overlay=true)

// Parametry SSL Channel
sslPeriod = input.int(13, title="SSL Channel Period")
sslChannel = ta.sma(close, sslPeriod)
sslIsGreen = close > sslChannel
sslIsRed = close < sslChannel

// Parametry NSDT Hama Candles
hamaOpen = ta.ema(open, 25)
hamaHigh = ta.ema(high, 20)
hamaLow = ta.ema(low, 20)
hamaClose = ta.ema(close, 20)
hamaLine = ta.ema(close, 100)
hamaIsGreen = hamaClose > hamaLine
hamaIsRed = hamaClose < hamaLine

// Kolor świec Hama w zależności od trendu
bgcolor(hamaIsGreen ? color.green : color.red, transp=90)

// Parametry dla wykrywania konsolidacji z ATR
atrPeriod = input.int(14, title="ATR Period")
atrThreshold = input.float(0.003, title="ATR Threshold")  // Niższy próg dla bardziej precyzyjnego wykrywania konsolidacji
atrValue = ta.atr(atrPeriod)
isConsolidation = atrValue / close < atrThreshold

// Oznaczanie konsolidacji na wykresie żółtym tłem
bgcolor(isConsolidation ? color.new(color.yellow, 80) : na)

// Parametry zarządzania ryzykiem
takeProfitRR = input.float(1.0, title="Take Profit R:R Ratio")
stopLossBuffer = input.float(0.5, title="Stop Loss Buffer")

// Warunki wejścia na pozycję długą i krótką
longCondition = sslIsGreen and hamaIsGreen and close > hamaClose
shortCondition = sslIsRed and hamaIsRed and close < hamaClose

// Obliczenia TP i SL
longStopLoss = hamaLine * (1 - stopLossBuffer / 100)
shortStopLoss = hamaLine * (1 + stopLossBuffer / 100)
longTakeProfit = close * (1 + takeProfitRR / 100)
shortTakeProfit = close * (1 - takeProfitRR / 100)

// Wejście na pozycję długą z TP i SL
if (longCondition)
    strategy.entry("Long", strategy.long, stop=longStopLoss, limit=longTakeProfit)

// Wejście na pozycję krótką z TP i SL
if (shortCondition)
    strategy.entry("Short", strategy.short, stop=shortStopLoss, limit=shortTakeProfit)

// Zamknięcie na powrocie ceny do Hama Candles
if (longCondition and close <= hamaClose)
    strategy.close("Long")
if (shortCondition and close >= hamaClose)
    strategy.close("Short")

// Rysowanie wskaźników
plot(sslChannel, title="SSL Channel", color=color.blue, linewidth=2)
plot(hamaLine, title="Hama Line", color=color.purple, linewidth=1)