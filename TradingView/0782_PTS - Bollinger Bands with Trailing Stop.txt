//@version=5
strategy(title="PTS - Bollinger Bands with Trailing Stop", overlay=true, commission_type=strategy.commission.percent, commission_value=0.1, slippage=3, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

length = input.int(20, minval=1, title="BB Length")
mult = input.float(2.0, minval=0.001, maxval=50, title="BB StdDev")
maType = input.string("SMA", "Basis MA Type", options=["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
src = input(close, title="Source")
offset = input.int(0, "Offset", minval=-500, maxval=500, display=display.data_window)

startDate = input.time(timestamp("01 Jan 2018 00:00"), "Start Date")
endDate = input.time(timestamp("31 Dec 2069 23:59"), "End Date")

// Bollinger Bands Calculation
ma(source, length, _type) =>
    switch _type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

basis = ma(src, length, maType)
dev = mult * ta.stdev(src, length)
upper = basis + dev
lower = basis - dev

plot(basis, "Basis", color=#2962FF, offset=offset)
p1 = plot(upper, "Upper", color=#F23645, offset=offset)
p2 = plot(lower, "Lower", color=#089981, offset=offset)
fill(p1, p2, title="Background", color=color.rgb(33, 150, 243, 95))

// ATR for Dynamic Trailing Stop
atrLength = input.int(14, minval=1, title="ATR Length")
atrMultTrail = input.float(2.0, minval=0.1, title="ATR Multiplier for Trailing Stop")
atrValue = ta.atr(atrLength)
trailOffset = atrValue * atrMultTrail

// Entry and Exit Conditions
inDateRange = (time >= startDate) and (time <= endDate)

if inDateRange
    longCondition = (strategy.position_size == 0) and (close > upper)
    exitCondition = (strategy.position_size > 0) and (close < lower)

    if longCondition
        strategy.entry("Long", strategy.long)
        // Set Trailing Stop based on ATR
        strategy.exit("Exit Long", "Long", trail_price=close, trail_offset=trailOffset)
    else if exitCondition
        strategy.close("Long")