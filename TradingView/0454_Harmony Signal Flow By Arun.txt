//@version=5
strategy("Harmony Signal Flow By Arun", overlay=true)

// Custom metric settings
periodLength = input(5, title="RSI Period Length")  // Changed period to 5 for sensitivity
priceSource = close
customMetric = ta.rsi(priceSource, periodLength)  // Calculated custom metric

// Define threshold levels (generalized names)
lowerThreshold = input(30, title="Lower Threshold")
upperThreshold = input(70, title="Upper Threshold")

// Buy signal: customMetric crosses above lowerThreshold
buyCondition = ta.crossover(customMetric, lowerThreshold)

// Sell signal: customMetric crosses below upperThreshold
sellCondition = ta.crossunder(customMetric, upperThreshold)

// Stop-loss and target levels
buyStopLoss = input(100, title="Buy Stop-Loss")
buyTarget = input(150, title="Buy Target")
sellStopLoss = input(100, title="Sell Stop-Loss")
sellTarget = input(150, title="Sell Target")

// Initialize variables to check if target/stop-loss is hit
var bool tradeClosed = true  // Flag to allow a new trade only after closing the previous one

// Ensure only one order at a time, and only if previous trade is closed
if (strategy.position_size == 0 and tradeClosed) // No open positions and last trade closed
    if (buyCondition)
        strategy.entry("Buy", strategy.long)
        tradeClosed := false  // Mark trade as active
    else if (sellCondition)
        strategy.entry("Sell", strategy.short)
        tradeClosed := false  // Mark trade as active

// Manage stop-loss and target for buy position
if (strategy.position_size > 0) // Open buy position
    float stopLossBuy = strategy.position_avg_price - buyStopLoss
    float targetBuy = strategy.position_avg_price + buyTarget

    if (close <= stopLossBuy)
        strategy.close("Buy", comment="Stoploss Hit")
        tradeClosed := true  // Allow next trade
    else if (close >= targetBuy)
        strategy.close("Buy", comment="Target Hit")
        tradeClosed := true  // Allow next trade

// Manage stop-loss and target for sell position
if (strategy.position_size < 0) // Open sell position
    float stopLossSell = strategy.position_avg_price + sellStopLoss
    float targetSell = strategy.position_avg_price - sellTarget

    if (close >= stopLossSell)
        strategy.close("Sell", comment="Stoploss Hit")
        tradeClosed := true  // Allow next trade
    else if (close <= targetSell)
        strategy.close("Sell", comment="Target Hit")
        tradeClosed := true  // Allow next trade

// Close all positions by 3:25 PM
if (hour(timenow) == 15 and minute(timenow) == 25)
    strategy.close_all(comment="Close all positions at 3:25 PM")
    tradeClosed := true  // Reset for next day trades

// Plot buy/sell signals on the chart
plotshape(buyCondition, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plotshape(sellCondition, title="Sell Signal", location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL")

// Plot custom metric and thresholds
hline(lowerThreshold, "Lower Threshold", color=color.green)
hline(upperThreshold, "Upper Threshold", color=color.red)
plot(customMetric, "Custom Metric", color=color.blue)