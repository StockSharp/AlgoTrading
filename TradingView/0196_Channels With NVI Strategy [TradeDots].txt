// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© tradedots

//@version=5
strategy("Channels With NVI Strategy [TradeDots]", overlay=true, initial_capital = 10000, default_qty_type = strategy.percent_of_equity, default_qty_value = 60, pyramiding = 1, commission_type = strategy.commission.percent, commission_value = 0.01)

// define variable
bool stop_loss = false
bool take_profit = false

// get channel type
channel_type = input.string("BB", "", inline="CHANNEL", options=["BB", "KC"],group="STRATEGY")
channel_source = input(close, "", inline="CHANNEL", group="STRATEGY")
channel_length = input.int(20, "", inline="CHANNEL", minval=1,group="STRATEGY")
channel_mult = input.int(2, "", inline="CHANNEL", minval=1,group="STRATEGY")
channel_color = input(#9cff87, "", inline="CHANNEL",group="STRATEGY")

[middle, upper, lower] = if channel_type == "KC"
    ta.kc(channel_source, channel_length,channel_mult)
else
    ta.bb(channel_source, channel_length,channel_mult)

// plot channel bands
plot(upper, color = channel_color, title = "Upper Channel Line")
plot(lower, color = channel_color, title = "Lower Channel Line")

// set nvi length
input_ema_nvi_length = input.int(200, minval=1, title = "NVI Legnth: ", group = "STRATEGY")
ema_nvi = ta.ema(ta.nvi, input_ema_nvi_length)

// stop loss and take profit options
enable_stop_loss = input.bool(defval = false, title = "", inline = "SL", group = "SL AND TP")
input_stop_loss = input.float(defval = 0, step = 0.1, title = "Stop Loss (%)", inline = "SL", group = "SL AND TP")

enable_take_profit = input.bool(defval = false, title = "", inline = "TP", group = "SL AND TP")
input_take_profit = input.float(defval = 0, step = 0.1, title = "Take Profit (%)", inline = "TP", group = "SL AND TP")

// entry rand exit condition
longCondition = close < lower and ta.nvi > ema_nvi
closeLongCondition = ta.nvi < ema_nvi

// assign stop loss and take profit
stop_loss := strategy.position_avg_price * (1-input_stop_loss/100) > close and enable_stop_loss == true ? true : na
take_profit := strategy.position_avg_price * (1+input_take_profit/100) < close and enable_take_profit == true ? true : na

// run strategy
if barstate.isconfirmed
    if (longCondition) and strategy.opentrades == 0
        strategy.entry("Long", strategy.long)
        label.new(bar_index, low, "ðŸŸ¢ Long", color = #9cff87, style = label.style_label_up)

    if (closeLongCondition == true or (take_profit == true and enable_take_profit == true) or (stop_loss == true and enable_stop_loss == true)) and strategy.opentrades > 0
        strategy.close("Long")
        label.new(bar_index, high, "ðŸ”´ Close", color = #f9396a, style = label.style_label_down, textcolor = #ffffff)