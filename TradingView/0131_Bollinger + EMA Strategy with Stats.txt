//@version=5
strategy(title = "Bollinger + EMA Strategy with Stats",overlay = true,default_qty_type = strategy.percent_of_equity,default_qty_value = 10,initial_capital = 100000,commission_type = strategy.commission.percent,commission_value = 0.1)

// === 参数设置 ===
length = input.int(20, "BB Length")
mult_entry = input.float(2.0, "Entry StdDev Multiplier (x)", step=0.1)
mult_stop = input.float(3.0, "Stop StdDev Multiplier (y)", step=0.1)
ema_period = input.int(20, "EMA Exit Period")
show_stats = input.bool(true, "Show Performance Label")

// === 指标计算 ===
basis = ta.sma(close, length)
dev_entry = mult_entry * ta.stdev(close, length)
dev_stop = mult_stop * ta.stdev(close, length)

upper_entry = basis + dev_entry
lower_entry = basis - dev_entry
upper_stop = basis + dev_stop
lower_stop = basis - dev_stop
ema_exit = ta.ema(close, ema_period)

// === 入场 & 出场条件 ===
long_entry  = close < lower_entry
short_entry = close > upper_entry
long_exit   = close >= ema_exit
short_exit  = close <= ema_exit

// === 只允许一个方向持仓 ===
if long_entry and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", from_entry="Long", stop=lower_stop, limit=ema_exit)

if short_entry and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", from_entry="Short", stop=upper_stop, limit=ema_exit)

// === 画图 ===
plot(basis, "BB Basis", color=color.gray)
plot(upper_entry, "BB Upper", color=color.red)
plot(lower_entry, "BB Lower", color=color.green)
plot(ema_exit, "EMA Exit", color=color.orange)

// === 资金曲线 & 回撤 ===
equity = strategy.equity
plot(equity, "Equity Curve", color=color.teal)

var float peak = na
var float max_dd = na
peak := na(peak) ? equity : math.max(peak, equity)
dd = (equity - peak) / peak
max_dd := na(max_dd) ? dd : math.min(max_dd, dd)
plot(dd * 100, title="Drawdown (%)", color=color.red)


// === Label 显示统计信息 ===
if show_stats and bar_index == ta.highest(bar_index, 50)
    winrate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : na
    label_text = "Net Profit: " + str.tostring(strategy.netprofit, "#.##") + "\n" +
                 "Max DD: " + str.tostring(max_dd * 100, "#.##") + "%\n" +
                 "Win Rate: " + str.tostring(winrate, "#.##") + "%\n" +
                 "Trades: " + str.tostring(strategy.closedtrades)
    label.new(x=bar_index, y=high, text=label_text,
              style=label.style_label_right, color=color.gray, textcolor=color.white)