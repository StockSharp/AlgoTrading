//@version=6
strategy("Livermore-Seykota Breakout Strategy", overlay=true, pyramiding=0, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ----- Inputs -----
emaMainLen = input.int(50, title="EMA chính (ví dụ: 50)")
emaFastLen = input.int(20, title="EMA nhanh (Seykota)")
emaSlowLen = input.int(200, title="EMA chậm (Seykota)")
pivotLen = input.int(3, title="Bar trái/phải của pivot (Livermore)")
atrLen = input.int(14, title="ATR Length")
stopATRmult = input.float(3.0, title="Hệ số ATR cho stop-loss", step=0.1)
trailATRmult = input.float(2.0, title="Hệ số ATR cho trailing stop", step=0.1)
volSmaLen = input.int(20, title="SMA khối lượng")

// ----- Indicators -----
emaMain = ta.ema(close, emaMainLen)
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
volSMA = ta.sma(volume, volSmaLen)
atr = ta.atr(atrLen)

// ----- Livermore Pivot High/Low -----
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow(low, pivotLen, pivotLen)
var float lastPivotHigh = na
var float lastPivotLow = na
if (not na(ph))
    lastPivotHigh := ph
if (not na(pl))
    lastPivotLow := pl

// ----- Entry Conditions -----
// Breakout theo Livermore: giá vượt pivot cao trước đó và > EMA chính
buyCondition = not na(lastPivotHigh) and close > lastPivotHigh and close > emaMain
// Xu hướng chính (Seykota): EMA20 > EMA200 (trend up)
buyTrend = emaFast > emaSlow
// Xác nhận khối lượng: volume > SMA(volume)
buyVolume = volume > volSMA

// Breakout xuống theo Livermore: giá dưới pivot thấp trước đó và < EMA chính
sellCondition = not na(lastPivotLow) and close < lastPivotLow and close < emaMain
// Xu hướng chính (Seykota): EMA20 < EMA200 (trend down)
sellTrend = emaFast < emaSlow
// Xác nhận khối lượng cho short: volume > SMA(volume)
sellVolume = volume > volSMA

// Vào lệnh Long/Short khi thỏa mãn điều kiện trên
if (buyCondition and buyTrend and buyVolume)
    strategy.entry("Long", strategy.long)
if (sellCondition and sellTrend and sellVolume)
    strategy.entry("Short", strategy.short)

// ----- Stop-loss và trailing stop (Paul Tudor Jones style) -----
// Dừng lỗ ban đầu dựa trên ATR
stopLevelLong = strategy.position_avg_price - atr * stopATRmult
stopLevelShort = strategy.position_avg_price + atr * stopATRmult
// Trailing stop khoảng cách (tính theo ATR)
trailPoints = atr * trailATRmult

// Gán lệnh dừng và trailing
if (strategy.position_size > 0)  // Nếu đang ở thế long
    strategy.exit("Exit Long", from_entry="Long", stop=stopLevelLong, trail_points=0, trail_offset=trailPoints)
if (strategy.position_size < 0)  // Nếu đang ở thế short
    strategy.exit("Exit Short", from_entry="Short", stop=stopLevelShort, trail_points=0, trail_offset=trailPoints)