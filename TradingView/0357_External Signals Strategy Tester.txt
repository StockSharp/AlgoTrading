//@version=6
strategy("External Signals Strategy Tester", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// === Date Range Settings ===
startDate = input.time(timestamp("2024-11-01 00:00"), title="Start Date", group="Date Range")
endDate   = input.time(timestamp("2025-03-31 23:59"), title="End Date", group="Date Range")
inDateRange = time >= startDate and time <= endDate

// === Signal Inputs ===
longSignal  = input.source(title="Buy Signal", defval=close)
shortSignal = input.source(title="Sell Signal", defval=close)

// === Trade Settings ===
enableLong        = input.bool(true, "Enable Long")
enableShort       = input.bool(true, "Enable Short")
closeOnReverse    = input.bool(true, "Close on Opposite Signal")
reversePosition   = input.bool(false, "Reverse Position on Opposite Signal")

// === Risk Management (in %) ===
takeProfitPerc = input.float(2.0, "Take Profit (%)", step=0.1)
stopLossPerc   = input.float(1.0, "Stop Loss (%)", step=0.1)
breakevenPerc  = input.float(1.0, "BreakEven (%)", step=0.1)

// === Entry Conditions ===
longCondition  = ta.crossover(longSignal, 0)
shortCondition = ta.crossover(shortSignal, 0)

// === Position Reversal or Exit Logic ===
var bool reverseDone = false
reverseDone := false

if inDateRange
    // === Reverse from Short to Long ===
    if reversePosition and strategy.position_size < 0 and longCondition and enableLong
        strategy.close("Short", comment="Reverse to Long")
        strategy.entry("Long", strategy.long)
        reverseDone := true

    // === Reverse from Long to Short ===
    if reversePosition and strategy.position_size > 0 and shortCondition and enableShort
        strategy.close("Long", comment="Reverse to Short")
        strategy.entry("Short", strategy.short)
        reverseDone := true

    // === Close on opposite signal (if reversal is disabled) ===
    if not reversePosition and closeOnReverse
        if strategy.position_size > 0 and shortCondition
            strategy.close("Long", comment="Close on opposite signal (Short)")
        if strategy.position_size < 0 and longCondition
            strategy.close("Short", comment="Close on opposite signal (Long)")

    // === Standard Entries (only if no position and no reversal) ===
    if strategy.position_size == 0 and not reverseDone
        if enableLong and longCondition
            strategy.entry("Long", strategy.long)
        if enableShort and shortCondition
            strategy.entry("Short", strategy.short)

// === Position Management: TP / SL / BE ===
if strategy.position_size != 0
    entryPrice = strategy.position_avg_price
    profitPerc = (close - entryPrice) / entryPrice * 100 * (strategy.position_size < 0 ? -1 : 1)

    if takeProfitPerc > 0 and profitPerc >= takeProfitPerc
        strategy.close_all(comment="Take Profit")

    if stopLossPerc > 0 and profitPerc <= -stopLossPerc
        strategy.close_all(comment="Stop Loss")

    if breakevenPerc > 0 and profitPerc >= breakevenPerc
        if strategy.position_size > 0
            strategy.exit("BE Long", from_entry="Long", stop=entryPrice)
        else if strategy.position_size < 0
            strategy.exit("BE Short", from_entry="Short", stop=entryPrice)

// === Signal Visualization ===
plotshape(longCondition and inDateRange,  title="Buy Signal",  location=location.belowbar, color=color.green, style=shape.triangleup,   size=size.small)
plotshape(shortCondition and inDateRange, title="Sell Signal", location=location.abovebar, color=color.red,   style=shape.triangledown, size=size.small)