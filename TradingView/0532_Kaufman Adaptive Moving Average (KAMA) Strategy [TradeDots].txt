// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© tradedots

//@version=5
strategy("Kaufman Adaptive Moving Average (KAMA) Strategy [TradeDots]", overlay = true, max_lines_count = 500, max_boxes_count = 100, initial_capital = 10000, currency = currency.USD, commission_type = strategy.commission.percent, commission_value = 0.01, default_qty_type = strategy.percent_of_equity, default_qty_value = 80)

// KAMA Setup
lookback_period = input.int(10, title="Length", group="KAMA")
ma_source = input(close, "KAMA Soruce", group="KAMA")
fastma_length = input.int(5, "Fast MA Legnth", minval=1,group="KAMA")
slowma_length = input.int(50, "Slow MA Legnth", minval=1,group="KAMA")

// Strategy Setup
input_order_direction = input.string("Long", options = ["Long", "Short", "Long and Short"], title = "Order Direction", group = "Strategy")
kama_rising_perid = input.int(10, title="Rising Period", group="Strategy")
kama_falling_perid = input.int(10, title="Falling Period", group="Strategy")

pine_kama(source) =>
    price_change = math.abs(source - source[lookback_period])
    sum_price_change = math.sum(math.abs(source - source[1]), lookback_period)
    fastest = 2/(fastma_length + 1)
    slowest = 2/(slowma_length + 1)
    ER = price_change / sum_price_change
    SC =  math.pow((ER * (fastest-slowest) + slowest), 2)

    alpha = SC
    sum = 0.0
    sum := na(sum[1]) ? source : sum[1] + SC * (close - nz(sum[1]))

kama = pine_kama(ma_source)

if ta.rising(kama, kama_rising_perid)
    strategy.close("Short")
    if input_order_direction != "Short" and strategy.opentrades == 0
        strategy.entry("Long", strategy.long)
        label.new(bar_index, low, "ðŸŸ¢ Long", color = #9cff87, style = label.style_label_up)

else if ta.falling(kama, kama_falling_perid)
    strategy.close("Long")
    if input_order_direction != "Long" and strategy.opentrades == 0
        strategy.entry("Short", strategy.short)
        label.new(bar_index, high, "ðŸ”´ Short", color = #f9396a, style = label.style_label_down, textcolor = color.white)

// Check if position is closed (Print label if true)
is_pos_closed = (strategy.position_size[1] != 0 and strategy.position_size == 0)
is_short = strategy.position_size < 0
is_long = strategy.position_size > 0

if is_pos_closed and is_short[1]
    label.new(bar_index, low, "ðŸŸ¢ Close Short", color = #9cff87, style = label.style_label_up)

else if is_pos_closed and is_long[1]
    label.new(bar_index, high, "ðŸ”´ Close Long", color = #f9396a, style = label.style_label_down, textcolor = color.white)

closelinePlot = plot(close, "", display = display.none)
kamaPlot = plot(kama, title = "KAMA", color = #ffffff)
fill(kamaPlot, closelinePlot, math.max(kama,close), kama,color.new(#9cff87, 75), color.new(#9cff87, 60))
fill(kamaPlot, closelinePlot, kama, math.min(kama,close),color.new(#f9396a, 60), color.new(#f9396a, 75))