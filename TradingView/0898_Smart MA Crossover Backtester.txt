//@version=6
strategy("Improved MA Crossover Strategy", overlay=true)

// Input for Moving Averages
fastLength = input(9, title="Fast MA Length")
slowLength = input(21, title="Slow MA Length")

// ATR-based Stop Loss and Take Profit
atrMultiplier = input(2, title="ATR Multiplier for Stop Loss")
atr = ta.atr(14)
stopLoss = atr * atrMultiplier
takeProfit = atr * atrMultiplier * 2  // Risk-Reward Ratio of 1:2

// Calculate Moving Averages
fastMA = ta.sma(close, fastLength)
slowMA = ta.sma(close, slowLength)

// Trend Filter - 200 MA
trendMA = ta.sma(close, 200)
isBullishTrend = close > trendMA
isBearishTrend = close < trendMA

// Entry Conditions with Trend Filter
longCondition = ta.crossover(fastMA, slowMA) and isBullishTrend
shortCondition = ta.crossunder(fastMA, slowMA) and isBearishTrend

// Execute Trades with Stop Loss & Take Profit
if longCondition
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", from_entry="Long", stop=close - stopLoss, limit=close + takeProfit)

if shortCondition
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", from_entry="Short", stop=close + stopLoss, limit=close - takeProfit)

// Plot MAs on Chart
plot(fastMA, color=color.blue, title="Fast MA")
plot(slowMA, color=color.red, title="Slow MA")
plot(trendMA, color=color.green, title="Trend MA")