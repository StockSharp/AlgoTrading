# Стратегия Momentum M15

Стратегия является переносом советника MetaTrader 5 **Momentum-M15** (`Momentum-M15.mq5`). Она торгует свечи
таймфрейма 15 минут, используя смещённую скользящую среднюю и осциллятор Momentum, рассчитанный по ценам открытия.
Идея — откупать перепроданность, когда цена находится ниже смещённой средней, и шортить перекупленность при цене выше
средней. Для снижения риска предусмотрены фильтр гэпов и опциональный трейлинг-стоп.

## Особенности переноса

* Индикаторы собраны из готовых компонентов StockSharp: настраиваемая скользящая средняя (по умолчанию Smoothed) и
  стандартный индикатор `Momentum` с возможностью выбрать источник цены.
* Горизонтальное смещение средней воспроизводится с помощью буфера значений: стратегия хранит последние значения и
  возвращает то, что соответствовало `MaShift` закрытых свечей назад.
* Проверки монотонности Momentuma (функции `CheckMO_Up`/`CheckMO_Down`) реализованы через хранение только нужного числа
  последних значений, без полноценного массива историй.
* Логика блокировки после больших гэпов (`GapLevel`/`GapTimeout`) сохранена. Разница между открытием и закрытием
  предыдущей свечи пересчитывается в шаги цены на основе `Security.PriceStep`.
* Трейлинг-стоп реализован закрытием позиции по рынку при пробитии рассчитанного уровня — аналогично тому, как в MQL код
  модифицировал стоп-лосс через `PositionModify`.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TradeVolume` | Объём сделок. | `0.1` |
| `CandleType` | Основной таймфрейм. | `15m` |
| `MaPeriod` | Длина окна скользящей средней. | `26` |
| `MaShift` | Горизонтальное смещение средней (в барах). | `8` |
| `MaMethod` | Тип средней (`Simple`, `Exponential`, `Smoothed`, `Weighted`). | `Smoothed` |
| `MaPrice` | Тип цены для средней. | `Low` |
| `MomentumPeriod` | Длина окна Momentum. | `23` |
| `MomentumPrice` | Тип цены для Momentum. | `Open` |
| `MomentumThreshold` | Базовый уровень Momentum. | `100` |
| `MomentumShift` | Смещение порогов относительно базового уровня. | `-0.2` |
| `MomentumOpenLength` | Требуемая длина убывающей / возрастающей последовательности Momentum для входа. | `6` |
| `MomentumCloseLength` | Длина последовательности Momentum для выхода. | `10` |
| `GapLevel` | Минимальный положительный гэп (в шагах цены), после которого торги приостанавливаются. | `30` |
| `GapTimeout` | Количество баров паузы после выявленного гэпа. | `100` |
| `TrailingStop` | Расстояние трейлинг-стопа в шагах цены (0 — выключено). | `0` |

## Логика торговли

### Входы

* **Покупка** выполняется, когда:
  * Текущее значение Momentum меньше `MomentumThreshold + MomentumShift`.
  * Закрытие предыдущей свечи и открытие текущей ниже смещённой средней.
  * Momentum убывал на протяжении `MomentumOpenLength` последних баров.
* **Продажа** выполняется, когда:
  * Momentum превышает `MomentumThreshold - MomentumShift`.
  * Предыдущее закрытие и текущее открытие выше смещённой средней.
  * Momentum возрастал `MomentumOpenLength` баров подряд.

Позиция открывается только при отсутствии активных сделок и если торговля не заблокирована фильтром гэпов.

### Выходы

* **Длинная позиция** закрывается, если:
  * Momentum убывал `MomentumCloseLength` баров подряд, либо
  * Предыдущее закрытие опустилось ниже смещённой средней, либо
  * Цена пробила трейлинг-стоп (минимум свечи минус расстояние `TrailingStop`).
* **Короткая позиция** закрывается, если:
  * Momentum возрастал `MomentumCloseLength` баров подряд, либо
  * Предыдущее закрытие поднялось выше средней, либо
  * Цена пробила трейлинг-стоп (максимум свечи плюс расстояние `TrailingStop`).

### Фильтр гэпов

1. Рассчитывается разница между текущим открытием и предыдущим закрытием в шагах цены.
2. Если величина превышает `GapLevel`, счётчик ожидания устанавливается равным `GapTimeout`.
3. Пока счётчик больше нуля, торговля пропускается; значение уменьшается на единицу после каждой закрытой свечи.

## Важные замечания

* Все вычисления выполняются на закрытых свечах (`CandleStates.Finished`), поэтому сигнал реализуется на следующей свече
  после его появления — поведение сопоставимо с работой советника на первом тике нового бара.
* “Пипсы” из версии MetaTrader аппроксимируются через `Security.PriceStep`. При отсутствии корректного шага цены
  трейлинг-стоп и фильтр гэпов автоматически отключаются.
* Параметры источников данных для средней и Momentum независимы, что полностью повторяет оригинал.
* Стратегия не выставляет стоп-заявки. Закрытие по трейлинг-стопу выполняется рыночным ордером, как и в исходном коде.

## Рекомендации по применению

1. Назначьте нужный инструмент и убедитесь, что выбранный `CandleType` совпадает с таймфреймом тестирования (15 минут).
2. Настройте `TradeVolume` под торговый счёт.
3. При необходимости корректируйте `MomentumOpenLength` и `MomentumCloseLength`, управляя чувствительностью фильтра.
4. Для точного соответствия “пипсам” из MetaTrader сопоставьте `TrailingStop` и `GapLevel` с отношением шага цены к пипсу
   выбранного инструмента.
