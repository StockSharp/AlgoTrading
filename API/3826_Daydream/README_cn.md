# Daydream 策略

## 概览

**Daydream** 策略源自 MQL4 专家顾问 *Daydream by Cothool*。原始版本在 USD/JPY 的 H1 周期内运行：当价格收盘突破近期价格通道后入场，并通过虚拟的跟踪止盈锁定利润。StockSharp 实现保持了核心思想，使用 Donchian Channels 计算上下轨，通过 `BuyMarket` / `SellMarket` 发送市价单，并在策略内部维护虚拟止盈而不在交易所挂出真实委托。

主要特点：

- 任意时刻只有一个持仓，当蜡烛收盘位于上一根通道之外时才会反转方向。
- 止盈以“点”为单位虚拟跟踪，随着价格推进而收紧，一旦触发便立即平仓。
- 引入每根蜡烛只允许一次交易动作的限制，复刻 MQL4 中 `LastOrderTime` 的行为。

## 交易逻辑

1. 使用 `ChannelPeriod` 根已完成蜡烛构建 Donchian 通道，并保存上一根蜡烛的上下轨值。
2. 当蜡烛收盘价 **低于** 之前的下轨时：
   - 平掉当前空头仓位；
   - 在下一根蜡烛上按照 `OrderVolume` 开多头，并把虚拟止盈设置为 `close + TakeProfitPips * pipSize`。
3. 当蜡烛收盘价 **高于** 之前的上轨时：
   - 平掉当前多头仓位；
   - 在下一根蜡烛上开空头，把虚拟止盈设置为 `close - TakeProfitPips * pipSize`。
4. 持仓期间每根蜡烛都会收紧虚拟止盈。如果之后的收盘价触达该水平，则通过市价单退出。

点值由品种的 `PriceStep` 推导。例如日元货币对常见的 0.001 步长会被转换成 0.01 点，与 MetaTrader 一致。

## 参数说明

| 参数 | 描述 | 默认值 | 备注 |
|------|------|--------|------|
| `OrderVolume` | 每次开仓的交易量。 | `1` | 对应 MQL 中的 `Lots`。 |
| `ChannelPeriod` | Donchian 通道使用的完成蜡烛数量。 | `25` | 等同于原策略参数。 |
| `Slippage` | 允许的点差滑点。 | `3` | 为兼容保留，市价单不会使用。 |
| `TakeProfitPips` | 虚拟止盈与当前价格的距离（点）。 | `15` | 随价格移动自动收紧。 |
| `CandleType` | 计算 Donchian 通道所用的蜡烛类型。 | `1 小时` | 继承原策略推荐周期。 |

## 工作流程

```
蜡烛收盘
      │
      ├─► 更新 Donchian 通道（上一根上下轨）
      │
      ├─► 向下突破？──► 平空 → 下一根准备做多
      │
      ├─► 向上突破？──► 平多 → 下一根准备做空
      │
      └─► 按持仓方向收紧虚拟止盈
              └─► 价格触及目标？→ 立即平仓
```

## 使用建议

- 将策略附加到任意具有蜡烛数据的品种，默认参数适用于 USD/JPY H1。
- 策略始终保持单仓位，并阻止同一根蜡烛内的重复交易，以保持与 MQL4 行为一致。
- 止盈完全在代码中处理，触发时通过市价单离场，不会在交易所挂出真实止盈单。
- 如需切换时间框架，请调整 `CandleType`，并确保有足够历史数据以形成通道。

## 与 MQL4 版本的差异

- 使用内置 `DonchianChannels` 指标替代手工遍历高低点。
- 保留虚拟止盈和节流逻辑，但执行由 StockSharp 的市场单完成，无需处理 MT4 的订单票据。
- `Slippage` 参数仅为兼容保留，StockSharp 的市场执行不直接应用该值。

## 文件结构

- `CS/DaydreamStrategy.cs` — C# 策略实现。
- Python 版本尚未提供。
