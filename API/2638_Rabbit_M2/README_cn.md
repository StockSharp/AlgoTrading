# Rabbit M2 策略

## 概述
Rabbit M2 是一套顺势交易策略，结合了动量震荡指标、唐奇安通道突破以及自适应仓位管理。原版 MetaTrader 5 智能交易系统由 Peter Byrom 编写，通过 1 小时时间框架上的指数移动平均线 (EMA) 切换做多或做空模式。在允许的方向下，策略等待威廉指标 (%R) 穿越关键阈值，并使用商品通道指数 (CCI) 进行确认后才开仓。每笔交易都设置固定距离的止损和止盈，当价格突破相反方向的唐奇安通道边界时也会立即平仓。若一次平仓收益超过预设的盈利阈值，基础下单手数会按步长增加，同时盈利阈值翻倍，从而复刻原策略的递进加仓逻辑。

## 指标与行情
- **快速 EMA (40) 与慢速 EMA (80)**：基于 1 小时 K 线，用于判定趋势并在趋势反转时关闭仓位。
- **CCI (14)**：使用主时间框架的价格数据，确认市场是否处于超买或超卖状态。
- **Williams %R (50)**：同样基于主时间框架，当指标穿越 -20/-80 水平时给出触发信号。
- **唐奇安通道 (100)**：基于主时间框架计算，若价格突破过去 100 根 K 线的最高或最低，触发强制平仓。
- **固定止损与止盈**：距离开仓价 50 点 (根据 3/5 位报价自动换算为标准点值)。

策略需要两路行情：主时间框架用于 CCI、Williams %R 与唐奇安通道，另一路为 1 小时行情供 EMA 趋势过滤使用。

## 交易规则
### 趋势控制
1. 当 40 周期 EMA 跌破 80 周期 EMA 时，立即平掉所有多单，并且仅允许寻找做空机会。
2. 当 40 周期 EMA 上穿 80 周期 EMA 时，立即平掉所有空单，并且仅允许寻找做多机会。

### 入场条件
- **做空**
  - Williams %R 跌破 -20，且上一根数值位于 -20 与 0 之间。
  - CCI 高于卖出阈值 (默认 101)。
  - 当前处于允许做空的模式，且净头寸未达到 `MaxOpenPositions` 限制。
- **做多**
  - Williams %R 上穿 -80，且上一根数值位于 -100 与 -80 之间。
  - CCI 低于买入阈值 (默认 99)。
  - 当前处于允许做多的模式，且净头寸未达到 `MaxOpenPositions` 限制。

每次信号触发时，策略会先平掉反向持仓，再按照当前基础手数建立新仓位。

### 出场条件
1. 每根完成的 K 线都会检查止损与止盈：多单若最低价跌破止损或最高价触及止盈则平仓，空单规则相反。
2. 无论是否命中止损/止盈，只要价格收盘突破前 100 根 K 线的最高点（空单）或最低点（多单），立即平仓。
3. 趋势方向翻转（快 EMA 与慢 EMA 金叉/死叉）时，无条件清空持仓。

### 仓位管理
- 基础下单量由 `InitialVolume` (默认 0.01) 指定，并会自动遵循交易所的最小手数、步长与上限要求。
- 每当一次平仓的实际盈利大于 `BigWinTarget`，基础下单量增加 `VolumeStep`，同时盈利阈值翻倍，形成阶梯式放大利润的效果。
- `MaxOpenPositions` 控制净持仓倍数。在 StockSharp 版本中采用净持仓模式，达到上限前不会再追加仓位。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `CciSellLevel` | 101 | 触发做空前 CCI 必须达到的最小数值。 |
| `CciBuyLevel` | 99 | 触发做多前 CCI 允许的最大数值。 |
| `CciPeriod` | 14 | 主时间框架上 CCI 的周期。 |
| `DonchianPeriod` | 100 | 唐奇安通道的回溯长度。 |
| `MaxOpenPositions` | 1 | 以基础手数计的最大允许净头寸。 |
| `BigWinTarget` | 1.50 | 触发加仓所需的实际盈利（账户货币）。 |
| `VolumeStep` | 0.01 | 每次达标后增加的基础手数步长。 |
| `WprPeriod` | 50 | Williams %R 的周期。 |
| `FastEmaPeriod` | 40 | 1 小时趋势过滤的快速 EMA 周期。 |
| `SlowEmaPeriod` | 80 | 1 小时趋势过滤的慢速 EMA 周期。 |
| `TakeProfitPips` | 50 | 止盈距离（点）。 |
| `StopLossPips` | 50 | 止损距离（点）。 |
| `InitialVolume` | 0.01 | 启动时的基础下单量。 |
| `CandleType` | 15 分钟 K 线 | 主时间框架，供 CCI / Williams %R / 唐奇安通道计算。 |

## 实现说明
- StockSharp 版本通过监测 K 线高低点来模拟 MT5 的止损与止盈，而非挂出带保护的委托。
- 当标的价格精度为 3 位或 5 位小数时，会自动将最小报价步长乘以 10 来换算标准点值。
- 策略依赖成交回报更新实时盈亏 (PnL) 来判断“大赢”事件，请确保成交回报能正确回传到策略中。
