# Стратегия Rabbit M2

## Обзор
Rabbit M2 — это трендовая стратегия, объединяющая импульсные осцилляторы, выходы по каналу Дончиана и адаптивное управление объёмом. Оригинальный советник MetaTrader 5 от Peter Byrom переключает режимы покупок и продаж по сигнальным экспоненциальным средним (EMA) на часовом таймфрейме. Пока режим активен, стратегия ждёт разворота Williams %R, подтверждённого Commodity Channel Index (CCI), и только затем открывает позицию. Сделки защищаются фиксированными стоп-лоссом и тейк-профитом, а также закрываются при пробое противоположной границы канала Дончиана. После каждой прибыльной сделки с результатом выше заданного порога базовый объём увеличивается на шаг, а сам порог удваивается — так повторяется логика наращивания лота из MQL-версии.

## Индикаторы и данные
- **Быстрая EMA (40) и медленная EMA (80)** на часовом таймфрейме задают направление торговли и закрывают позиции при смене тренда.
- **CCI (14)** на основном таймфрейме подтверждает состояние перекупленности/перепроданности.
- **Williams %R (50)** на основном таймфрейме даёт триггер при пересечении уровней -20 и -80.
- **Канал Дончиана (100)** по основному таймфрейму используется для защитных выходов при пробое предыдущих максимумов/минимумов.
- **Фиксированные стоп и тейк** располагаются на расстоянии 50 пунктов от цены входа (пункт пересчитывается с учётом 3/5-значных котировок).

Необходимы два потока данных: основной таймфрейм для CCI, Williams %R и канала Дончиана, а также отдельный поток с часовыми свечами для трендового фильтра EMA.

## Торговые правила
### Управление режимом
1. Когда 40-периодная EMA на H1 опускается ниже 80-периодной, все длинные позиции закрываются, и разрешаются только короткие сделки.
2. Когда 40-периодная EMA поднимается выше 80-периодной, все короткие позиции закрываются, и разрешаются только длинные сделки.

### Условия входа
- **Короткая позиция**
  - Williams %R опускается ниже -20, причём предыдущее значение находилось между -20 и 0.
  - CCI выше уровня для продаж (по умолчанию 101).
  - Активен режим продаж, а текущий нетто-объём меньше лимита `MaxOpenPositions`.
- **Длинная позиция**
  - Williams %R поднимается выше -80, причём предыдущее значение находилось между -100 и -80.
  - CCI ниже уровня для покупок (по умолчанию 99).
  - Активен режим покупок, а текущий нетто-объём меньше лимита `MaxOpenPositions`.

При появлении сигнала стратегия закрывает противоположное плечо (если оно есть) и открывает новую позицию базовым объёмом.

### Условия выхода
1. На каждой завершённой свече проверяются стоп и тейк: длинные позиции закрываются при пробое стопа или достижении цели по максимуму свечи, короткие — зеркально.
2. Вне зависимости от стопа/тейка короткие позиции закрываются при закрытии выше предыдущего 100-периодного максимума, длинные — при закрытии ниже предыдущего минимума.
3. Пересечение EMA (смена режима) мгновенно ликвидирует открытую позицию.

### Управление объёмом
- Стартовый объём задаётся параметром `InitialVolume` (по умолчанию 0.01) и автоматически подгоняется под минимальный шаг и ограничения площадки.
- После каждой сделки с прибылью выше `BigWinTarget` базовый объём увеличивается на `VolumeStep`, а порог удваивается, что обеспечивает каскадное наращивание объёма.
- Параметр `MaxOpenPositions` ограничивает нетто-позицию. В версии для StockSharp позиции неттуются, поэтому при достижении лимита новые объёмы не добавляются до уменьшения экспозиции.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CciSellLevel` | 101 | Минимальное значение CCI для подтверждения продажи. |
| `CciBuyLevel` | 99 | Максимальное значение CCI для подтверждения покупки. |
| `CciPeriod` | 14 | Период CCI на основном таймфрейме. |
| `DonchianPeriod` | 100 | Длина окна канала Дончиана. |
| `MaxOpenPositions` | 1 | Максимальный нетто-объём в кратных базовому объёму. |
| `BigWinTarget` | 1.50 | Прибыль (в валюте счёта) для активации увеличения объёма. |
| `VolumeStep` | 0.01 | Шаг, на который растёт базовый объём после крупной прибыли. |
| `WprPeriod` | 50 | Период Williams %R. |
| `FastEmaPeriod` | 40 | Период быстрой EMA в трендовом фильтре (H1). |
| `SlowEmaPeriod` | 80 | Период медленной EMA в трендовом фильтре (H1). |
| `TakeProfitPips` | 50 | Дистанция тейк-профита в пунктах. |
| `StopLossPips` | 50 | Дистанция стоп-лосса в пунктах. |
| `InitialVolume` | 0.01 | Начальный базовый объём. |
| `CandleType` | 15-минутные свечи | Основной таймфрейм для CCI / Williams %R / Дончиана. |

## Особенности реализации
- В StockSharp стоп и тейк имитируются проверкой минимумов/максимумов свечей, а не защитными заявками на бирже.
- Размер пункта автоматически пересчитывается: если у инструмента 3 или 5 знаков после запятой, тик умножается на 10.
- Для определения «крупных выигрышей» стратегия опирается на обновление реализованного PnL, поэтому необходимо обеспечить доставку отчётов по сделкам в стратегию.
