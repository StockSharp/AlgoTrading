# Стратегия IBS RSI CCI v4 X2

## Описание

**IBS RSI CCI v4 X2** — портированная на StockSharp версия популярной MQ5 стратегии, построенной на сочетании индикаторов Internal Bar Strength (IBS), Relative Strength Index (RSI) и Commodity Channel Index (CCI). Стратегия работает в двух таймфреймах:

* медленный (по умолчанию 8 часов) задаёт направление торговли;
* быстрый (по умолчанию 1 час) формирует конкретные сигналы входа и выхода.

Для каждого таймфрейма рассчитывается композитный осциллятор. Значение осциллятора — это среднее арифметическое взвешенных IBS, RSI и CCI. Резкие скачки значения ограничиваются параметром-порогом, после чего данные проходят через диапазонную «обёртку» (максимум и минимум за окно с дополнительным сглаживанием). Сравнение текущего значения с усреднённой обёрткой и даёт сигналы пересечения.

## Логика торговли

1. **Определение тренда.** Если на медленном таймфрейме значение композитного индикатора выше сглаженной средней, стратегия считает, что на рынке восходящая тенденция, иначе — нисходящая.
2. **Получение сигнала.** На быстром таймфрейме анализируются две последних завершённых свечи. Только если предыдущая свеча поддерживает направление пересечения, сигнал признаётся валидным.
3. **Открытие позиций.**
   * Длинная позиция открывается, когда разрешены покупки, тренд бычий, а осциллятор подтверждает разворот вверх (композит опускается ниже обёртки, как в оригинальном индикаторе).
   * Короткая позиция открывается, когда разрешены продажи, тренд медвежий, а композит поднимается выше обёртки.
4. **Закрытие позиций.**
   * Флаги `_CloseLongOnSignalCross` и `_CloseShortOnSignalCross` позволяют закрывать позиции при обратном пересечении на быстром таймфрейме.
   * `_CloseLongOnTrendFlip` и `_CloseShortOnTrendFlip` закрывают позиции при смене тренда на медленном таймфрейме.
   * Защита позиции настраивается через `StartProtection` — значения стоп-лосса и тейк-профита берутся в пунктах и автоматически переводятся в абсолютное смещение цены.

## Параметры

| Параметр | Назначение |
| --- | --- |
| `OrderVolume` | Базовый объём сделки. При развороте позиция закрывается и открывается в обратном направлении одним ордером. |
| `TrendCandleType` / `SignalCandleType` | Тип свечей для трендового и сигнального таймфреймов. |
| `TrendIbsPeriod`, `SignalIbsPeriod` | Период сглаживания IBS. |
| `TrendIbsMaType`, `SignalIbsMaType` | Тип скользящей средней для сглаживания IBS (простая, экспоненциальная, сглаженная, взвешенная). |
| `TrendRsiPeriod`, `SignalRsiPeriod` | Период RSI. |
| `TrendRsiPrice`, `SignalRsiPrice` | Тип цены для расчёта RSI. |
| `TrendCciPeriod`, `SignalCciPeriod` | Период CCI. |
| `TrendCciPrice`, `SignalCciPrice` | Тип цены для расчёта CCI. |
| `TrendThreshold`, `SignalThreshold` | Порог ограничения резких изменений композитного индикатора. |
| `TrendRangePeriod`, `TrendSmoothPeriod` | Параметры диапазонной обёртки на медленном таймфрейме. |
| `SignalRangePeriod`, `SignalSmoothPeriod` | Параметры диапазонной обёртки на быстром таймфрейме. |
| `TrendSignalBar`, `SignalSignalBar` | Смещение по количеству завершённых свечей при чтении значений. |
| `AllowLongEntries`, `AllowShortEntries` | Разрешение на открытие длинных/коротких позиций. |
| `CloseLongOnTrendFlip`, `CloseShortOnTrendFlip` | Обязательное закрытие позиций при смене тренда. |
| `CloseLongOnSignalCross`, `CloseShortOnSignalCross` | Закрытие позиций при обратном пересечении на быстром таймфрейме. |
| `StopLossPoints`, `TakeProfitPoints` | Размер стоп-лосса и тейк-профита в пунктах (`PriceStep`). |

## Практические рекомендации

1. Перед запуском укажите инструмент и таймфреймы. Метод `GetWorkingSecurities` автоматически создаёт обе подписки.
2. Стартовые значения параметров полностью повторяют оригинальный MQ5 советник, что упрощает сравнение результатов.
3. При повышенной волатильности уменьшайте `Threshold` и периоды обёртки для ускорения реакции, и наоборот.
4. Встроенный расчёт CCI требует непрерывного потока свечей. При пропуске данных проверьте корректность входного ряда.
5. При наличии доступного окна графика стратегия отображает свечи сигнального таймфрейма и сделки, что помогает в отладке.

## Ограничения и риски

* Стратегия не содержит ограничений по времени торговли, фильтров по объёму и т. п. При необходимости добавьте их вручную.
* Если у инструмента неизвестный шаг цены, стоп-лосс и тейк-профит могут работать некорректно; в коде предусмотрено минимальное значение по умолчанию.
* Переворот позиции выполняется одним рыночным ордером. Убедитесь, что торговая площадка допускает такое поведение.
* В математике композитного индикатора используются отрицательные коэффициенты, как и в оригинале. Поэтому на графике пересечения могут казаться инвертированными — это ожидаемое поведение.

## Дальнейшее развитие

* Подберите разные комбинации таймфреймов и параметров, чтобы адаптировать стратегию под выбранный инструмент.
* Добавьте вывод значений композитного индикатора на график для визуального контроля.
* Расширьте блок управления рисками (дневные лимиты, трейлинг, частичное закрытие и т. д.).
* Используйте модуль оптимизации StockSharp для перебора параметров и сравнения результатов тестов.
