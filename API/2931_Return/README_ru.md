# Return Strategy
[English](README.md) | [中文](README_cn.md)

Эта реализация повторяет советник «Return Strategy». Стратегия ежедневно в заданный час строит симметричную сетку отложенных заявок на покупку и продажу вокруг текущей цены. Расстояние между уровнями задаётся в пунктах, а объём каждой заявки может фиксироваться напрямую либо рассчитываться из процента риска. После активации ордера позиция сопровождается фиксированным и трейлинговым стопом, контролируется суммарная плавающая прибыль и при достижении целевых условий все позиции и заявки закрываются.

Изначально алгоритм предназначался для неттинговых счетов и поиска возвратного движения после определённых часов. Перенос в StockSharp сохраняет структуру исходного робота и переводит управление заявками, защитой и капиталом на высокоуровневый API платформы.

## Логика работы

- **Подготовка сетки** – В момент `StartHour` проверяется отсутствие активных лимитных заявок и создаётся по `PendingOrderCount` заявок Buy Limit ниже и Sell Limit выше рынка. Первый уровень смещается на `DistancePips`, каждый следующий добавляет `StepPips` пунктов.
- **Управление риском** – Для каждой заявки можно задать фиксированный `OrderVolume` либо использовать расчёт на основе `RiskPercent`. Во втором случае объём выводится из доступного капитала и величины стопа так, чтобы суммарный риск сетки соответствовал выбранному проценту.
- **Стопы** – Сформированная позиция получает исходный стоп на расстоянии `StopLossPips`. Если `TrailingStopPips` больше нуля, после прохождения цены порога стоп подтягивается шагом `TrailingStepPips`.
- **Цель и выход из сессии** – Открытая прибыль пересчитывается в пунктах. При достижении `TotalProfitPips` стратегия инициирует закрытие всех позиций и ордеров. То же самое происходит в момент `EndHour`, а также каждый пятничный день вне зависимости от результата.
- **Истечение** – Отложенные заявки могут автоматически сниматься через `ExpirationHours`. Просроченные или отменённые ордера удаляются из списка, чтобы на следующий день можно было выставить новую сетку.

## Параметры

| Параметр | Описание |
| --- | --- |
| `StopLossPips` | Расстояние до стартового стоп-лосса в пунктах. |
| `StartHour` | Час (0–23), когда выставляется сетка ордеров. |
| `EndHour` | Час (0–23), в который закрываются все позиции и заявки. |
| `TotalProfitPips` | Цель по суммарной плавающей прибыли в пунктах. |
| `TrailingStopPips` | Расстояние трейлинг-стопа от цены. Ноль отключает трейлинг. |
| `TrailingStepPips` | Требуемое дополнительное движение цены для подтяжки трейлинг-стопа. Должно быть > 0 при включённом трейлинге. |
| `DistancePips` | Смещение первого лимитного ордера от текущей цены. |
| `StepPips` | Дополнительный шаг между соседними ордерами. |
| `PendingOrderCount` | Количество заявок Buy Limit и Sell Limit. |
| `ExpirationHours` | Время жизни отложенных ордеров в часах. Ноль — без истечения. |
| `OrderVolume` | Фиксированный объём для каждой заявки. Ноль включает риск-менеджмент по проценту. |
| `RiskPercent` | Процент капитала, распределяемый между всеми ордерами сетки, когда `OrderVolume` равен нулю. |
| `CandleType` | Тип свечей, используемых для тайминга и расчётов. |

## Дополнительная информация

- Пересчёт пункта повторяет логику MetaTrader: для инструментов с 3 и 5 знаками минимальный шаг умножается на 10.
- При расчёте по `RiskPercent` процент применяется ко всей сетке и делится между ордерами поровну.
- Встроена проверка параметров, совпадающая с исходным экспертом: часы должны лежать в диапазоне суток, трейлинг требует положительного шага, одновременно можно использовать либо фиксированный объём, либо процент риска.
- Комментарии в исходном коде даны на английском языке в соответствии с требованиями репозитория.
