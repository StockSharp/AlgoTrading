# Маркет-мейкер Bitex One

## Обзор
**Маркет-мейкер Bitex One** повторяет логику оригинального советника `BITEX.ONE MarketMaker.mq5`. Стратегия постоянно расставляет пары лимитных заявок вокруг опорной цены и удерживает одинаковое количество уровней по покупкам и продажам. Перенос выполнен на высокоуровневом API StockSharp: работа с заявками осуществляется через подписки на стакан и Level1, а нормализация объёмов/цен опирается на параметры инструмента (`PriceStep`, `VolumeStep`, `MinVolume`).

## Торговый алгоритм
1. Определяется *опорная цена* согласно параметру `PriceSource`. По умолчанию используется mark-price, но можно подключить основной стакан или внешний инструмент (индекс/mark-символ) через `LeadSecurity`.
2. Рассчитывается расстояние между уровнями как `ShiftCoefficient * leadPrice`, после чего создаётся симметричная сетка котировок выше и ниже опорной цены.
3. Суммарная экспозиция по каждой стороне ограничивается величиной `MaxVolumePerLevel * LevelCount`. Исполненные сделки моментально уменьшают доступный объём, поэтому сетка всегда учитывает текущую позицию.
4. Цены и объёмы нормализуются по минимальному шагу и шагу объёма. Если действующая заявка отклоняется от целевых значений больше, чем на 0.05% по цене или половину шага по объёму, она снимается и выставляется заново.
5. При остановке или сбросе стратегии все активные заявки удаляются для очистки книги заявок.

## Параметры
- `MaxVolumePerLevel` – максимальный объём на одном ценовом уровне. Ограничивает суммарную экспозицию и учитывает текущую позицию.
- `ShiftCoefficient` – относительное смещение от опорной цены для каждого уровня (`leadPrice ± shift * levelIndex`).
- `LevelCount` – количество уровней на сторону. Для каждого уровня выставляется одна покупка и одна продажа.
- `PriceSource` – тип источника опорной цены (`OrderBook`, `MarkPrice`, `IndexPrice`).
- `LeadSecurity` – дополнительный инструмент, из которого берётся внешняя цена (при необходимости). Если не задан, используется основной инструмент стратегии.

## Особенности конверсии
- Асинхронные операции MetaTrader (`SendAsync`, `ModifyAsync`, `RemoveOrderAsync`) заменены на вызовы `BuyLimit`/`SellLimit` с явной отменой заявок при выходе за допуски.
- Сохранена логика балансировки позиции (`max_pos * level_count ± position`), чтобы сетка оставалась центрированной относительно текущих позиций.
- Механизм выбора опорной цены воспроизводит оригинальные суффиксы (`символ`, `символm`, `символi`) посредством пары параметров `PriceSource` + `LeadSecurity`.
- Таймерные проверки MQL заменены реактивными вызовами, инициируемыми изменениями стакана, Level1 и позиций портфеля.

## Рекомендации по применению
- Проверьте, что поставщик данных отдаёт стакан или Level1 как по основному инструменту, так и по `LeadSecurity` (если он используется).
- При работе с mark/index-ценами заранее подпишитесь на соответствующий инструмент, чтобы опорная цена появилась сразу после запуска.
- При необходимости задействуйте внешние средства риск-менеджмента (например, защиту портфеля), если биржа предъявляет требования к соотношению котировок и сделок.
- Если после старта сетка не строится, убедитесь в наличии положительной опорной цены и правильной конфигурации соединения.
