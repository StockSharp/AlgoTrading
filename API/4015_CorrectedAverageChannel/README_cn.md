# 校正均线通道策略

## 概述
**校正均线通道策略** 是 MetaTrader 专家顾问 `e-CA-5` 的 C# 版本。策略在每根 K 线收盘后重新计算“校正均线”（Corrected Average）指标，只要价格向上或向下突破校正均线一定的西格玛偏移量，就会开仓。移植后的实现完全基于 StockSharp 的高级蜡烛图 API，使用市价单，并在策略内部管理止损、止盈和移动止损，以复制原始 EA 的行为。

## 校正均线指标
CA 指标结合了移动平均与波动率反馈，MetaTrader 版本提供三个输入：均线周期、均线类型和应用价格。StockSharp 版本的处理方式如下：

1. `MaTypeOption` 参数决定均线类型（SMA、EMA、SMMA、LWMA），`MaPeriod` 控制周期长度。
2. 使用同样周期的 `StandardDeviation` 指标衡量当前波动率。
3. 每当新的蜡烛完成时按以下步骤计算校正值：
   - 记 `M_t` 为最新一根 K 线的均线数值，`CA_{t-1}` 为上一根 K 线的校正值。
   - 计算 `v1 = StdDev_t^2`、`v2 = (CA_{t-1} - M_t)^2`。
   - 如果 `v2 <= 0` 或 `v2 < v1`，令校正系数 `k = 0`；否则 `k = 1 - v1 / v2`。
   - 更新 `CA_t = CA_{t-1} + k * (M_t - CA_{t-1})`。
   - 第一根有效 K 线直接使用均线数值作为初始校正值。

这一递推方式可在震荡期抑制均线的变化，同时在价格显著偏离时快速跟随。

## 交易逻辑
1. 策略订阅 `CandleType` 参数指定的蜡烛序列，并等待均线与标准差全部形成。
2. 当蜡烛收盘后，重新计算校正值，并将上一根蜡烛的收盘价与上一根校正值比较。
3. `SigmaBuyPoints` 与 `SigmaSellPoints` 会通过标的物的 `PriceStep` 转换为价格距离。
4. 入场条件基于上一根收盘价与最新校正值：
   - **做多**：若上一根收盘价低于“校正值 + 买入西格玛”，且当前收盘价收于该上轨之上，则买入。
   - **做空**：若上一根收盘价高于“校正值 − 卖出西格玛”，且当前收盘价收于该下轨之下，则卖出。
5. 策略始终保持净头寸为单向，不会在已有持仓时再次开仓。

由于移植版本基于收盘价运行，每根蜡烛仅触发一次决策，便于回测和在蜡烛级别的数据源上实盘交易。

## 风险控制
移植版本完整保留了原始 EA 的三种保护机制：

- **固定止损**：`StopLossPoints` 乘以价格步长得到入场价与止损价的距离，触发后以市价单平仓。
- **固定止盈**：`TakeProfitPoints` 转换为目标利润距离，价格达到时立即市价平仓。
- **移动止损**：当 `TrailingPoints` 大于 0 时，策略会跟踪浮动盈利；一旦盈利超过该距离，就在最新收盘价后方记录一条移动止损线。移动止损只会朝盈利方向推进，并受到 `TrailingStepPoints` 的限制，要求新止损至少比旧值多出指定步长。所有价格都会通过 `Security.ShrinkPrice` 对齐至交易所允许的最小跳动点。

任何保护性平仓都会重置内部风险状态。下一次进场时，策略会基于新的成交价重新计算止损、止盈以及移动止损，复刻 EA 修改订单保护的行为。

## 参数说明
| 参数 | 含义 |
| --- | --- |
| `OrderVolume` | 市价单开仓手数，必须大于 0。 |
| `TakeProfitPoints` | 止盈距离（价格步长单位，0 表示禁用）。 |
| `StopLossPoints` | 止损距离（价格步长单位，0 表示禁用）。 |
| `TrailingPoints` | 启动移动止损所需的盈利距离（价格步长单位）。 |
| `TrailingStepPoints` | 每次调整移动止损所需的最小额外盈利（价格步长单位）。 |
| `MaPeriod` | 移动平均与标准差的共同周期。 |
| `MaTypeOption` | 移动平均类型：SMA、EMA、SMMA、LWMA。 |
| `SigmaBuyPoints` | 在校正均线上方触发买入的西格玛偏移量。 |
| `SigmaSellPoints` | 在校正均线下方触发卖出的西格玛偏移量。 |
| `CandleType` | 用于计算指标和产生信号的蜡烛数据类型。 |

所有数值参数都调用了 `SetCanOptimize(true)`，可直接在 StockSharp 中进行参数优化。

## 使用建议
- 默认时间框架为 1 小时，可根据历史调优结果调整。
- 所有“点数”参数均使用 `PriceStep` 转换为真实价格距离；若标的未设置跳动点，则退化为 1，保证在指数或加密资产上也能合理运行。
- 策略仅在蜡烛结束时执行逻辑，如需更高分辨率请降低时间框架。
- 移动止损通过检测价格突破后使用市价单离场，与原始 EA 修改订单止损的思路一致，同时避免额外挂单。
- 根据任务要求，本次移植未提供 Python 版本。

## 与原始 EA 的差异
- 采用 StockSharp 的蜡烛 API，所有决策在蜡烛收盘时进行，而非逐笔报价。
- 策略保持单向净头寸，不会同时持有多空仓位，符合原始 EA 仅持单单的逻辑。
- 止损、止盈与移动止损通过市价单执行，而不是修改已有订单票据，在净头寸账户中能得到等效结果，同时契合 StockSharp 常见的策略结构。

上述改动在遵循仓位与风险管理准则的前提下，最大程度保留了 `e-CA-5` 的核心思想。
