# EES Hedger (расширенная версия)

## Обзор

Стратегия воспроизводит логику классического советника MetaTrader «EES Hedger». Каждый раз, когда на том же счёте внешний советник, трейдер или ручная операция открывает позицию, стратегия немедленно создаёт противоположный хедж с настраиваемым объёмом. Далее хедж сопровождается стоп-лоссом, тейк-профитом, переносом в безубыток и трейлинг-стопом, что позволяет нейтрализовать риск и сохранить прибыль, полученную на встречной сделке.

Стратегия не генерирует собственных сигналов: она только наблюдает за сделками счёта, реагирует на подходящие операции и управляет хеджем до тех пор, пока позиция не будет закрыта защитными заявками либо вручную.

## Логика работы

1. **Отслеживание внешних сделок**. Поток сделок счёта поступает через коннектор. Если заполнен параметр `OriginalOrderComment`, учитываются только операции с подходящим комментарием; при пустом значении хеджируются все сделки по инструменту. Сделки самой стратегии исключаются по идентификаторам транзакций.
2. **Создание хеджа**. После обнаружения подходящей сделки стратегия выставляет рыночный ордер противоположного направления и объёма `HedgeVolume`. Параметр `HedgerOrderComment` помогает отделить хеджевые заявки в отчётах.
3. **Управление рисками**. После исполнения хеджа выставляются защитные стоп- и тейк-ордеры на расстояниях, заданных в пипсах. Когда достигается условие безубытка, стоп переносится к цене входа плюс один пип. При включённом трейлинге стоп двигается дальше по мере развития благоприятного движения.
4. **Сброс состояния**. Когда позиция обнуляется (например, при ручном закрытии), все защитные ордера снимаются, а внутренние флаги очищаются — стратегия готова к следующему внешнему сигналу.

## Параметры

| Параметр | Описание |
|----------|----------|
| `HedgeVolume` | Объём встречной позиции. |
| `StopLossPips` | Расстояние от цены входа до стоп-ордера. |
| `TakeProfitPips` | Расстояние от цены входа до тейк-профита. |
| `TrailingStopPips` | Дистанция трейлинг-стопа; ноль отключает функцию. |
| `TrailingActivationPips` | Минимальная прибыль в пипсах, после которой трейлинг-стоп начинает двигаться. |
| `BreakEvenPips` | Прибыль в пипсах, необходимая для переноса стопа в безубыток. |
| `OriginalOrderComment` | Фильтр по комментарию исходных сделок; пустое значение — хеджировать все сделки. |
| `HedgerOrderComment` | Комментарий, присваиваемый хеджевым и защитным ордерам стратегии. |

## Практические рекомендации

- Запускайте стратегию на том же счёте, где работают исходные сделки. Только так она сможет увидеть внешние позиции и отреагировать на них.
- При использовании мостов MetaTrader убедитесь, что комментарий исходной заявки передаётся в StockSharp, иначе фильтр по комментарию работать не будет.
- Размер пипса автоматически вычисляется по шагу цены инструмента. Для пятизнаковых валютных котировок указанные значения переводятся в корректные ценовые приращения.
- Безубыток и трейлинг никогда не ухудшают позицию: стоп только приближается к текущей цене и не возвращается в убыточную область.
- Управление исходной позицией (закрытие, переворот и т. п.) остаётся за основным торговым решением.

## Порядок работы

1. Настройте параметры стратегии, особенно фильтры по комментариям и объём хеджа.
2. Запустите стратегию и убедитесь, что соединение с брокером активно. До появления внешней сделки стратегия находится в режиме ожидания.
3. Как только поступит подходящая сделка, проследите, как создаётся встречный ордер и выставляются защитные заявки в стакане.
4. Контролируйте работу безубытка и трейлинга, чтобы выбранные расстояния соответствовали спецификациям брокера.
5. По окончании работы остановите стратегию — все активные защитные ордера будут сняты автоматически.

## Ограничения

- Стратегия может хеджировать только те сделки, которые доступны в потоке коннектора. Невидимые операции остаются без реакции.
- Требования к минимальному лоту у разных брокеров различаются. Убедитесь, что `HedgeVolume` соответствует шагу объёма инструмента.
- Из-за мгновенной отправки рыночных ордеров в волатильный момент возможен проскальзывание. При необходимости увеличьте защитные расстояния, чтобы учесть этот риск.
