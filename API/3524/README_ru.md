# Набор стратегий Trailing Star

## Источник

Оригинальный пакет MetaTrader 5 «Trailing Star» (автор Pham Ngoc Vinh) включает два советника:

* **Trailing Star on Point** — активирует трейлинг-стоп, когда позиция получает заданное количество пунктов прибыли от цены входа.
* **Trailing Star on Price** — начинает сопровождение после достижения заранее заданного ценового уровня.

Оба советника перебирают все открытые позиции и вызывают `PositionModify`, чтобы подтянуть стоп-лосс на фиксированное расстояние от текущей цены Bid или Ask.

## Адаптация под StockSharp

В этом каталоге находятся две стратегии на базе высокоуровневого API StockSharp, повторяющие поведение оригинала:

* `TrailingStarPointStrategy` — использует метатрейдеровские пункты (points/pips) для определения момента активации и величины трейлинга. Как только лучшая цена Bid/Ask превышает среднюю цену входа на заданное количество пунктов, стратегия перерегистрирует защитный ордер.
* `TrailingStarPriceStrategy` — активируется, когда рынок пробивает фиксированную цену, и далее удерживает стоп на указанном расстоянии в пунктах.

Обе реализации работают по **Level1** данным, не используют дополнительные коллекции и опираются на стандартные методы нормализации цен и объёмов из базового класса `Strategy`. Стоп ордер перерегистрируется только в том случае, если новое значение улучшает позицию трейдера (стоп выше для лонга и ниже для шорта), что соответствует условиям MQL-версии.

### Учёт цены входа

`TrailingStarPointStrategy` восстанавливает среднюю цену входа по уведомлениям о собственных сделках (`OnNewMyTrade`):

* Сделки на покупку сперва сокращают текущий шорт, а затем пересчитывается средняя цена для лонга.
* Сделки на продажу сначала уменьшают лонговую позицию и только после этого обновляют цену входа для шорта.
* Когда чистая позиция становится равной нулю, стратегия сбрасывает всю накопленную информацию и отменяет защитный ордер.

Такой подход повторяет цикл `PositionsTotal()` и использование `POSITION_PRICE_OPEN` в MetaTrader.

`TrailingStarPriceStrategy` не отслеживает цену входа — необходимый порог задаёт пользователь.

### Работа с Level1 данными

Стратегии подписываются на Level1 через `SubscribeLevel1().Bind(...)`, получая лучшие цены Bid и Ask вместо структур `MqlTick`. Вычисления запускаются только после получения свежей котировки; при отсутствии данных обновление пропускается, что предотвращает ложные срабатывания на неликвидном рынке.

### Управление защитным ордером

Вместо `PositionModify` стратегии поддерживают единственный защитный ордер:

1. При отсутствии стопа выставляется новый `SellStop` (для длинной позиции) или `BuyStop` (для короткой).
2. Если ордер активен, он перерегистрируется только при улучшении цены.
3. Выполненный, отменённый или отклонённый ордер создаётся заново автоматически.

При закрытии позиции стратегия отменяет защитный ордер и очищает состояние, как и советник в MetaTrader, который просто игнорировал закрытые позиции.

## Параметры

| Стратегия | Параметр | Описание |
| --- | --- | --- |
| `TrailingStarPointStrategy` | `EntryPointPips` | Минимальная прибыль в пунктах, необходимая для активации трейлинга. |
| | `TrailingPointPips` | Дистанция между текущей ценой и стоп-ордером в пунктах. |
| `TrailingStarPriceStrategy` | `EntryPrice` | Цена, после пробоя которой включается сопровождение. |
| | `TrailingPointPips` | Дистанция между текущей ценой и стоп-ордером в пунктах. |

Параметры описаны через `StrategyParam<T>` и снабжены `SetDisplay`, поэтому доступны в интерфейсе и оптимизаторе StockSharp.

## Рекомендации по использованию

1. До запуска укажите нужный инструмент и портфель.
2. Убедитесь, что поставщик данных передаёт лучшие цены Bid/Ask в виде Level1 сообщений.
3. Настройте параметры, учитывая размер пункта конкретного инструмента. Стратегии автоматически переводят пункты MetaTrader в реальные шаги цены через `PriceStep` и точность инструмента.
4. Запустите стратегию — она будет сопровождать уже открытые позиции и не создаёт новых сделок самостоятельно.

> **Важно:** стратегии выполняют только защитную функцию. Для входа в рынок используйте другие стратегии или ручные операции.

## Отличия от оригинального MQL-кода

* Вместо `PositionModify` применяются защитные стоп-ордера `SellStop`/`BuyStop` StockSharp.
* Учёт позиции строится на событиях о сделках, без перебора глобального списка позиций.
* Каждая стратегия управляет одним инструментом, что соответствует архитектуре StockSharp (в MQL советник работал со всеми позициями одновременно).

Эти изменения сохраняют торговую логику, но делают реализацию нативной для StockSharp.
