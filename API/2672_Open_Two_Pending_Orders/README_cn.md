# 双向挂单策略

## 概述
该策略复刻了 MetaTrader 中的“Open Two Pending Orders”专家顾问，会同时在当前买卖价附近挂出买入止损单和卖出止损单。策略只针对单一标的，使用 StockSharp 的高层 API 订阅盘口、管理挂单并执行风险控制。一旦其中一张止损单被触发，另一张挂单会被取消，持仓随后通过固定止损、固定止盈以及可选的追踪止损进行管理。

## 交易逻辑
1. 订阅盘口数据，实时记录最优买价和最优卖价。
2. 当没有持仓或激活的入场挂单时，计算交易数量并放置两张止损单：
   - 买入止损价 = 卖价 + `EntryOffsetPoints × PriceStep`。
   - 卖出止损价 = 买价 − `EntryOffsetPoints × PriceStep`。
3. 某张止损单成交后：
   - 取消另一张挂单；
   - 记录成交价作为新的入场价；
   - 根据成交价及参数计算初始止损、止盈价格。
4. 持仓期间持续监控盘口：
   - 多头：当买价触及止损或止盈水平时市价平仓；
   - 空头：当卖价触及止损或止盈水平时市价平仓；
   - 当价格按照追踪距离有利波动后，启动追踪止损并随价格移动止损水平。
5. 持仓归零后重置内部状态，并重新挂出下一组双向止损单。

策略在保护水平被触及时使用市价单离场，从而在不依赖低层订单修改接口的情况下保持与原始 MQL 逻辑一致。

## 资金管理
策略支持两种头寸控制模式：
- **固定仓位**：按 `FixedVolume` 参数设定的数量下单。
- **资金管理**：启用后，依据组合净值、`RiskPercent` 百分比以及止损距离计算下单数量，并按照标的的最小变动和数量步长进行取整和限制。

## 参数说明
| 参数 | 说明 |
|------|------|
| `UseMoneyManagement` | 是否启用风险百分比仓位管理，默认 `true`。 |
| `RiskPercent` | 启用资金管理时，每笔交易风险占组合净值的百分比，默认 `2`。 |
| `FixedVolume` | 未启用资金管理时的固定下单量，默认 `1`。 |
| `StopLossPoints` | 入场价到止损位的价格步数，默认 `100`。 |
| `TakeProfitPoints` | 入场价到止盈位的价格步数，默认 `300`。 |
| `TrailingStopPoints` | 追踪止损的价格步数，设为 `0` 则关闭追踪，默认 `50`。 |
| `EntryOffsetPoints` | 入场挂单相对于买卖价的偏移步数，默认 `50`。 |
| `SlippagePoints` | 额外保留的滑点步数，目前仅用于提示，默认 `5`。 |

## 注意事项
- 策略依赖盘口深度数据，请确保所选标的提供 order book 信息。
- 止损与止盈通过盘口触发后立即以市价单执行，与原始 MQL EA 的行为保持一致。
- 追踪止损仅在价格朝有利方向移动超过设定距离后才会启用。
- 代码遵循项目规范：使用制表符缩进、英文注释及 StockSharp 高层 API。
