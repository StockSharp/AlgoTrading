# Стратегия Lot Fraction Adjuster

## Обзор
Пример повторяет вспомогательную функцию `afd.AdjustLotSize` из скрипта `MQL/8582`. В оригинале MetaTrader приводил желаемый объём заявки к минимальному шагу `MODE_LOTSTEP`, дополнительно ограничивал его указанным количеством фракций и выводил каждое промежуточное значение через цепочку `Alert`. Порт под StockSharp выполняет те же действия внутри стратегии: сразу после запуска она считывает `VolumeStep` инструмента, выполняет последовательность округлений, кеширует промежуточные результаты и публикует их через систему логирования.

В центре внимания находится именно нормализация объёма, а не торговая логика. Стратегия показывает, как получить метаданные о лотах из `Security`, как воспроизвести правила округления MetaTrader и как пользоваться `AddInfoLog`/`AddWarningLog` для диагностики.

## Логика подгонки объёма
1. Прочитать минимальный шаг объёма из `Security.VolumeStep`. Если значение отсутствует или не положительно, корректировка невозможна — стратегия записывает предупреждение и прекращает обработку.
2. Преобразовать требуемый объём (`InputLotSize`) в количество минимальных шагов, разделив его на шаг лота.
3. Округлить количество шагов до ближайшего целого с помощью `MidpointRounding.AwayFromZero`, чтобы поведение совпало с `MathRound` из MetaTrader.
4. Снизить округлённое значение до ближайшего кратного `Fractions`, используя `Math.Floor`. Это точная копия конструкции `MathFloor(MathRound(...) / Fractions) * Fractions` из MQL.
5. Умножить скорректированное количество шагов на размер шага и получить окончательный объём. Стратегия сохраняет итог и все промежуточные величины в полях и выводит их одной записью `AddInfoLog`. Если итоговый объём положителен, он также присваивается `Strategy.Volume`, чтобы вспомогательные методы заявок сразу использовали нормализованный размер.

Рассчитанные величины доступны через свойства только для чтения (`LotStep`, `StepsInput`, `StepsRounded`, `StepsOutput`, `AdjustedLotSize`), что упрощает автоматические проверки и визуализацию.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `InputLotSize` | `decimal` | `0.58` | Исходный объём заявки до нормализации. |
| `Fractions` | `int` | `2` | Количество минимальных шагов в одном допустимом блоке. Значения меньше `1` автоматически повышаются до `1`. |

## Поведение во время работы
- Метод `OnStarted` выполняет весь расчёт и записывает подробное сообщение с исходными данными, шагом лота, промежуточными счётчиками и конечным объёмом.
- При отсутствии корректного `VolumeStep` выводится предупреждение, а сохранённые значения остаются равными нулю.
- Если итоговый объём больше нуля, он копируется в свойство `Volume`, поэтому вызовы `BuyMarket()` и др. используют нормализованную величину.

## Отличия от MetaTrader
- В MetaTrader каждое значение показывалось отдельным `Alert`; StockSharp-версия агрегирует всё в одну запись `AddInfoLog` и применяет `AddWarningLog` для проблемных ситуаций.
- Вместо `MarketInfo(Symbol(), MODE_LOTSTEP)` используется `Security.VolumeStep`, поэтому стратегия работает с любым источником данных, который возвращает шаг объёма.
- Дополнительные свойства раскрывают промежуточные значения, чего не было в исходном коде, что облегчает тестирование и создание интерфейсов.

## Рекомендации по использованию
- Перед запуском убедитесь, что у выбранного инструмента заполнено поле `VolumeStep` (например, загрузив описание бумаги у брокера).
- Подберите значения `InputLotSize` и `Fractions` в соответствии с биржевыми требованиями. Например, `Fractions = 2` допускает только чётное количество минимальных шагов.
- Включите логирование или визуализацию, чтобы убедиться, что последовательность округлений совпадает с ожидаемой.

## Логируемые значения
Информационная запись выводит данные в том же порядке, что и `Alert` в MetaTrader:
- `AdjustedLotSize`
- `StepsOutput`
- `StepsRounded`
- `StepsInput`
- `LotStep`
- `Fractions`
- `InputLotSize`
