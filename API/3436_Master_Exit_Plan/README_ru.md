# Стратегия Master Exit Plan

## Обзор

`MasterExitPlanStrategy` переносит в StockSharp логику метатрейдеровского советника «Master Exit Plan». Стратегия не инициирует сделки – она управляет уже открытыми позициями: отслеживает несколько типов стопов, подтягивает отложенные заявки и закрывает все позиции при достижении заданной цели по капиталу.

Для воспроизведения вызовов `iOpen(symbol, PERIOD_M1, 1)` используется подписка на минутные свечи. Проверки выполняются раз в секунду через таймер стратегии, что соответствует `EventSetTimer(1)` в MQL4.

## Возможности

- **Целевая прибыль по капиталу** – закрывает все позиции при достижении заданного процента роста капитала.
- **Статические и динамические стопы** – контролирует расстояние от цены входа и уровни, привязанные к открытию последней минутной свечи.
- **Скрытые стопы** – закрывает позицию рыночными ордерами без выставления биржевых заявок.
- **Блок трейлинг-стопа** – активируется после фиксации минимальной прибыли и учитывает актуальный спред.
- **Трейлинг отложенных заявок** – переставляет buy stop и sell stop ближе к рынку.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `EnableTargetEquity` | Включить закрытие по целевой доходности. | `false` |
| `TargetEquityPercent` | Процент роста капитала для срабатывания. | `1` |
| `EnableStopLoss` | Активировать «жёсткий» стоп-лосс. | `false` |
| `StopLossPoints` | Расстояние жёсткого стопа в пунктах. | `2000` |
| `EnableDynamicStopLoss` | Привязать стоп к последней минутной свече. | `false` |
| `DynamicStopLossPoints` | Дистанция динамического стопа (пункты). | `2000` |
| `EnableHiddenStopLoss` | Включить скрытый статический стоп. | `false` |
| `HiddenStopLossPoints` | Дистанция скрытого статического стопа. | `800` |
| `EnableHiddenDynamicStopLoss` | Включить скрытый динамический стоп. | `false` |
| `HiddenDynamicStopLossPoints` | Дистанция скрытого динамического стопа. | `800` |
| `EnableTrailingStop` | Активировать блок трейлинг-стопа. | `false` |
| `TrailingStopPoints` | Дистанция трейлинга (пункты). | `5` |
| `TrailingTargetPercent` | Минимальный процент прибыли для активации. | `0.2` |
| `SureProfitPoints` | Дополнительный запас пунктов перед включением трейлинга. | `30` |
| `EnableTrailPendingOrders` | Переставлять активные stop-заявки. | `false` |
| `TrailPendingOrderPoints` | Отступ для трейлинга отложенных ордеров. | `10` |

## Рекомендации по использованию

1. Подключите стратегию к инструменту, где позиции открываются внешними модулями или вручную. Поле `Volume` должно соответствовать объёму, который следует закрывать при срабатывании защитных правил.
2. Портфель должен предоставлять `Portfolio.CurrentValue`. Это значение заменяет `AccountBalance` и `AccountEquity` из MetaTrader. Если оценка капитала недоступна, блок закрытия по цели не работает.
3. Для расчёта спреда стратегия использует лучшие котировки, поэтому необходимы данные уровня Level1.
4. Все защитные действия выполняются рыночными заявками. Биржевые стоп-приказы не выставляются, что повторяет «скрытый» характер оригинального советника.

## Отличия от версии MQL

- Вместо `OrderModify` стопы реализованы через постоянный контроль и принудительное закрытие позиции по рынку.
- Динамические уровни рассчитываются по последней завершённой минутной свече из подписки `SubscribeCandles`.
- Трейлинг отложенных ордеров не затрагивает внешние защитные заявки – стратегия их не создаёт.
- Для оценки капитала используется `Portfolio.CurrentValue` (резерв – `Portfolio.BeginValue`).

## Тестирование

Автоматические тесты не поставляются. Перед реальной торговлей прогоните стратегию в тестере StockSharp на исторических данных выбранного инструмента.
