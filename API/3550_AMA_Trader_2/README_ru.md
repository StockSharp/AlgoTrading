# Стратегия AMA Trader 2

## Описание
AMA Trader 2 повторяет логику одноимённого советника MetaTrader Владимира Карпутова. Стратегия сочетает адаптивную скользящую среднюю Кауфмана (AMA) и осциллятор RSI: покупки открываются при закрытии свечи выше AMA и одновременном падении RSI в зону перепроданности, продажи — при обратном сочетании. Добавочные усредняющие заявки отправляются фиксированным объёмом и ограничиваются параметрами управления риском (максимальное число позиций, минимальный шаг, трейлинг и т.д.).

## Предпосылки
- **Инструмент**: валютные пары/CFD с низкими спредами; допустимо использование на других ликвидных рынках с приемлемыми просадками при усреднении.
- **Данные**: стратегия работает по закрытию свечей выбранного таймфрейма (`CandleType`, по умолчанию 1 минута).
- **Сессия**: при необходимости торговля ограничивается временным окном `StartTime`–`EndTime` (UTC) с помощью флага `UseTimeWindow`.

## Индикаторы
1. **Kaufman Adaptive Moving Average (AMA)** — определяет направление тренда через длину усреднения и параметры быстрого/медленного сглаживания.
2. **Relative Strength Index (RSI)** — подтверждает экстремумы импульса. Количество последних значений для проверки задаёт `StepLength` (0 трактуется как 1, как и в оригинале).

## Торговый алгоритм
1. Обрабатываются только завершённые свечи, стратегия должна быть онлайн и иметь разрешение на торговлю.
2. При активированном временном фильтре сигналы вне окна игнорируются.
3. Очередь значений RSI обновляется, одновременно рассчитываются возможные сдвиги трейлинг-стопа.
4. **Лонг**: цена закрытия выше AMA и одно из проверяемых значений RSI ниже `RsiLevelDown`. Если текущий лонг убыточен, сначала отправляется усредняющая заявка, затем стандартный вход. **Шорт**: зеркальные условия (`RsiLevelUp`).
5. Параметры `MaxPositions`, `MinStep` и `OnlyOnePosition` ограничивают количество усреднений и повторные входы. При `CloseOpposite = true` сначала закрываются противоположные позиции, и только после их подтверждённого закрытия стратегия рассматривает новый вход.
6. Для каждого входа можно включать фиксированные `StopLoss`/`TakeProfit`, а также трейлинг с тремя параметрами: активация, дистанция и шаг подтяжки.

## Управление риском
- **Фиксированный объём**: все ордера отправляются объёмом `LotSize`.
- **Глубина усреднения**: `MaxPositions` ограничивает количество добавок в одном направлении.
- **Минимальный шаг**: параметр `MinStep` предотвращает открытие новых позиций слишком близко к предыдущим.
- **Защитные стопы**: опциональные stop-loss, take-profit и трейлинг-стоп повторяют инструменты защиты оригинального советника.
- **Противоположные позиции**: `CloseOpposite` принудительно закрывает встречные позиции, `OnlyOnePosition` запрещает хранить обе стороны одновременно.

## Параметры
| Параметр | Назначение |
|----------|------------|
| `CandleType` | Тип свечей/таймфрейм для расчёта индикаторов. |
| `LotSize` | Объём каждой рыночной заявки. |
| `RsiLength` | Период усреднения RSI. |
| `StepLength` | Количество последних значений RSI для проверки (0 → 1). |
| `RsiLevelUp` | Уровень перекупленности для шорт-сигналов. |
| `RsiLevelDown` | Уровень перепроданности для лонг-сигналов. |
| `AmaLength` | Длина AMA. |
| `AmaFastPeriod` | Быстрый коэффициент сглаживания AMA. |
| `AmaSlowPeriod` | Медленный коэффициент сглаживания AMA. |
| `StopLoss` | Дистанция защитного стопа (0 — выключено). |
| `TakeProfit` | Дистанция тейк-профита (0 — выключено). |
| `TrailingActivation` | Прибыль, необходимая для включения трейлинга. |
| `TrailingDistance` | Отступ трейлинг-стопа от цены. |
| `TrailingStep` | Минимальное улучшение для подтягивания трейлинга. |
| `MaxPositions` | Максимум добавок в одну сторону (0 — без ограничения). |
| `MinStep` | Минимальная дистанция между входами (0 — без проверки). |
| `CloseOpposite` | Закрывать противоположную позицию перед новым входом. |
| `OnlyOnePosition` | Запрет на новые входы при открытых позициях. |
| `UseTimeWindow` | Включить фильтр торгового окна. |
| `StartTime` | Начало торгового окна (UTC). |
| `EndTime` | Конец торгового окна (UTC). |

## Особенности реализации
- Используется только высокоуровневый API StockSharp: подписка на свечи через `SubscribeCandles`, передача значений индикаторов в делегат через `.Bind` без прямого обращения к буферам.
- Учёт позиций ведётся раздельно для лонгов и шортов, что позволяет оценивать плавающую прибыль/убыток при усреднении без вызова запрещённых агрегаторов.
- Трейлинг-стоп реализован через обновление стоп-лосса стратегии, без ручного управления заявками.
- Во избежание повторных входов в одном баре сохраняется время последней сделки для каждой стороны.

## Отличия от MetaTrader-версии
- Исключены параметры, связанные с magic number, отклонением, проверкой freeze/stops level и фиктивными выводами средств — эти функции обрабатываются инфраструктурой StockSharp либо не требуются.
- Стопы и цели рассчитываются от цены закрытия свечи, поскольку поток тиков в рамках данной реализации не используется.
- Автоматический расчёт объёма по проценту риска отсутствует: объём задаётся напрямую (`LotSize`).
