# TRAYLERv 策略

## 概述
**TRAYLERv 策略** 是 MetaTrader 4 专家顾问 *TRAYLERv* 的完整移植版本。原始 EA 的定位是“仓位管理器”而不是信号生成器：它持续监控现有持仓，利用比尔·威廉姆斯分形来调整保护性止损，同时提供一键清理挂单的能力。该 StockSharp 版本在保留原始逻辑的基础上，使用高级 API 管理订单并订阅蜡烛图数据。

策略本身**不会主动开仓**。仓位可由人工或其他策略创建，本策略随后接管止损与止盈的维护工作。所有参数名称与注释均继承自原 EA，方便已有经验的交易员快速对照。

## 交易逻辑
1. 订阅配置好的蜡烛序列（默认 1 分钟），仅在蜡烛收盘后记录数据。当累计到 5 根蜡烛时开始识别分形高点和低点，完全复刻 MT4 分形指标的计算方式。
2. 每当新的蜡烛在偶数分钟收盘时，检查当前净仓位：
   - **多头仓位**：在最近 `StopFractalDepth` 根蜡烛（默认 7）中查找最近的下分形。若找到，则在分形低点下方减去当前点差和两个最小价格步长后，放置或上移卖出止损单。如果没有有效分形，则回退到 3 根之前的蜡烛低点，同样减去两倍最小步长作为备用止损价。当多头持仓出现浮盈且启用止盈时，寻找最近 `TakeProfitFractalDepth` 根蜡烛（默认 21）的上分形，在其下方轻微扣减点差后挂出卖出限价单，复制原始 EA 的止盈处理。
   - **空头仓位**：完全对称地使用上分形追踪买入止损，使用下分形设置买入限价止盈，并在分形上方加点差与缓冲区以避免过早止损。
3. 如果 `DeleteAllPendingOrders` 为真，则策略会取消所有仍处于挂单状态的委托；若只希望清理当前合约的挂单，可启用 `DeleteOwnPendingOrders`。两个开关与原 EA 的“清理挂单”选项一一对应。
4. 当没有持仓时，策略会撤销自身登记的所有保护性订单，保持委托簿整洁。

## 风险管理
- 保护性订单使用 `SellStop`、`BuyStop`、`SellLimit` 与 `BuyLimit` 等市价方向的挂单函数，数量总是等于净头寸的绝对值。
- 止盈逻辑可单独开关。关闭 `UseTakeProfit` 会撤销已有的限价单，但追踪止损仍保持工作。
- 点差优先从最优买价与卖价推导；若行情暂不可用，则退而求其次使用最小价格步长，避免把订单贴在当前价位上。
- 所有价格都会按最小步长取整，同时体积会遵循 `VolumeStep`、`MinVolume`、`MaxVolume` 限制，确保委托完全符合交易所规则。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `OrderVolume` | 建议的默认开仓手数，保留原 EA 兼容性，在移植版中不直接使用。 | `0.1` |
| `DeleteAllPendingOrders` | 为 `true` 时，每根蜡烛收盘后取消所有挂单。 | `false` |
| `DeleteOwnPendingOrders` | 为 `true` 时，仅取消当前标的的挂单。 | `false` |
| `UseTakeProfit` | 启用基于分形的止盈逻辑；关闭时会撤销已有止盈单。 | `true` |
| `EnableSound` | MT4 遗留的声音开关，在 StockSharp 中仅为占位。 | `true` |
| `ShowCommentary` | 对应 MT4 图表注释的开关，移植版中仅保留配置项。 | `true` |
| `StopFractalDepth` | 搜索追踪止损分形时向前回溯的蜡烛数。 | `7` |
| `TakeProfitFractalDepth` | 搜索止盈分形时向前回溯的蜡烛数。 | `21` |
| `CandleType` | 主数据序列的蜡烛类型，默认 1 分钟。 | `1 分钟` |

## 实现要点
- 使用 `SubscribeCandles().Bind(...)` 高级接口，仅处理收盘蜡烛，既模拟了 MT4 每分钟巡检的行为，又避免在未完成数据上做决策。
- 通过维护滚动蜡烛快照列表手动计算分形，复刻 `iFractals` 指标的判定，不依赖额外的 StockSharp 指标对象。
- 价格统一按最小步长取整，数量自动适配合约的最小/最大下单限制，生成的委托可以直接提交。
- 未提供 Python 版本，目录中没有 `PY` 文件夹，以符合转换要求。
