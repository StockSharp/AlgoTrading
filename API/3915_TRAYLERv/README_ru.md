# Стратегия TRAYLERv

## Обзор
**TRAYLERv** — это перенос эксперта MetaTrader 4 *TRAYLERv*, который изначально выступал помощником по сопровождению сделок. Он не генерировал сигналы, а автоматически подтягивал защитные ордера и позволял быстро удалить все отложенные заявки. В версии для StockSharp реализовано то же поведение с использованием высокоуровневого API: стратегия подписывается на свечи, отслеживает фракталы Билла Уильямса и управляет ордерами через стандартные методы `Buy/Sell`.

Стратегия **не открывает позиции самостоятельно**. Предполагается, что сделки создаются вручную либо другим алгоритмом. После появления позиции TRAYLERv берёт на себя поддержку стопов и тейк-профитов по оригинальной логике, сохраняя названия параметров и их смысл.

## Логика работы
1. Подписка на выбранный тип свечей (по умолчанию минутные) и накопление истории. После появления пяти завершённых баров стратегия начинает фиксировать локальные максимумы и минимумы, точно повторяя расчёт MT4-индикатора `iFractals`.
2. После закрытия каждой свечи с чётной минутой проверяется текущая позиция:
   - **Длинная позиция**: ищется ближайший нисходящий фрактал в пределах `StopFractalDepth` баров (по умолчанию 7). Если найден, регистрируется или переносится стоп-заявка `SellStop` ниже минимума фрактала с учётом текущего спрэда и двух шагов цены. Если фрактала нет, берётся минимум бара трёх свечей назад и уменьшается на два шага. При наличии прибыли и включённом параметре `UseTakeProfit` ищется восходящий фрактал глубиной до `TakeProfitFractalDepth` (21 бар) и ставится `SellLimit` немного ниже уровня фрактала.
   - **Короткая позиция**: выполняются зеркальные действия — стоп перемещается по верхним фракталам, тейк-профит рассчитывается по нижним фракталам, а к цене добавляется запас над максимумом, чтобы исключить ложные срабатывания.
3. Включение `DeleteAllPendingOrders` приводит к отмене всех активных отложенных заявок на подключении. Параметр `DeleteOwnPendingOrders` ограничивает очистку только инструментом стратегии. Оба переключателя полностью соответствуют опциям MT4-советника.
4. При отсутствии позиции все защитные ордера, созданные стратегией, отменяются, чтобы не оставлять «хвостов» в стакане заявок.

## Управление рисками
- Защитные ордера выставляются функциями `SellStop`, `BuyStop`, `SellLimit`, `BuyLimit` с объёмом, равным абсолютной величине текущей позиции.
- Стопы и тейк-профиты независимы. Если выключить `UseTakeProfit`, лимитные ордера удаляются, но механизм подтягивания стопов продолжит работу.
- Для корректировки уровней используется текущий спрэд, вычисляемый по лучшим котировкам. Если он недоступен, применяется минимальный шаг цены, чтобы не ставить ордер прямо по рыночной стоимости.
- Перед регистрацией цены округляются к шагу цены инструмента, а объёмы приводятся к `VolumeStep` и учитывают ограничения `MinVolume`/`MaxVolume`.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `OrderVolume` | Рекомендованный объём позиции. Сохранён для совместимости, в расчётах не участвует. | `0.1` |
| `DeleteAllPendingOrders` | При значении `true` удаляет все отложенные заявки после каждой свечи. | `false` |
| `DeleteOwnPendingOrders` | При значении `true` удаляет только заявки по текущему инструменту. | `false` |
| `UseTakeProfit` | Включает управление тейк-профитом на основе фракталов. | `true` |
| `EnableSound` | Наследованный флаг звуковых уведомлений MT4, в версии StockSharp не используется. | `true` |
| `ShowCommentary` | Флаг отображения комментариев в MT4, оставлен для полноты настроек. | `true` |
| `StopFractalDepth` | Глубина поиска фрактала для подтягивания стоп-лосса. | `7` |
| `TakeProfitFractalDepth` | Глубина поиска фрактала для тейк-профита. | `21` |
| `CandleType` | Тип свечей, используемый в расчётах. По умолчанию — минутные. | `1 минута` |

## Особенности реализации
- Используется высокоуровневая подписка `SubscribeCandles().Bind(...)`, поэтому расчёты ведутся только по завершённым барам — так же, как это делал оригинальный советник на тиках.
- Фракталы рассчитываются вручную на основе списка последних свечей, что исключает необходимость подключать дополнительные индикаторы и повторяет поведение `iFractals` из MetaTrader.
- Все уровни проходят нормализацию к шагу цены, а объёмы — к шагу объёма. Это гарантирует, что сформированные ордера валидны для любой торговой площадки.
- Python-реализация не предусмотрена, поэтому папка `PY` отсутствует согласно требованиям по конвертации.
