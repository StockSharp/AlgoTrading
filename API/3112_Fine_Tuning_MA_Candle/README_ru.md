# Стратегия Exp Fine Tuning MA Candle

## Общее описание
- Конвертация эксперта MetaTrader 5 `Exp_FineTuningMACandle.mq5`, который торгует по изменению цвета индикатора *Fine Tuning MA Candle*.
- Использует высокоуровневый API StockSharp: подписка на свечи, вычисление индикатора через `BindEx`, исполнение заявок через методы `Strategy`.
- Сохраняет исходные флаги разрешения сделок и порядок «сначала закрыть, затем открыть», при этом учитывает асинхронную модель исполнения заявок в StockSharp.

## Индикатор Fine Tuning MA Candle
- Формирует синтетические свечи OHLC, усредняя последние `Length` реальных свечей по трём этапам весов.
  - Параметры `Rank1`, `Rank2`, `Rank3` задают степень изгиба весовых кривых, `Shift1`, `Shift2`, `Shift3` смешивают эти кривые с равномерным распределением.
  - Весовая функция симметрична: первая половина окна ускоряет значения к центру, вторая половина замедляет их удаление от центра.
  - После нормализации получаются сглаженные цены открытия, максимума, минимума и закрытия.
- Если модуль разницы между сглажёнными открытием и закрытием меньше `GapPoints` (переводится в шаг цены инструмента), открытие заменяется предыдущим синтетическим закрытием, устраняя ценовые разрывы.
- Цвет свечи принимает значение **2** при `Open < Close`, **0** при `Open > Close`, **1** при равенстве. Для торговой логики используется только поток цветов.
- Параметр `PriceShiftPoints` смещает синтетическую свечу вверх или вниз на заданное количество шагов цены.

## Правила торговли
- Сигналы вычисляются только на закрытых свечах. Стратегия хранит историю цветов и анализирует свечу, которая находится на `SignalBar` позиций левее от последней завершённой.
- **Переход в бычий цвет (2):**
  - Закрывает открытую короткую позицию, если разрешено `SellPosClose`.
  - После выхода в ноль, при разрешённом `BuyPosOpen`, отправляется рыночная заявка на покупку объёмом `Volume`. Если перед этим закрывался шорт, заявка на лонг ставится в очередь и отправляется после фактического обнуления позиции.
- **Переход в медвежий цвет (0):**
  - Закрывает открытую длинную позицию, если разрешено `BuyPosClose`.
  - Как только позиция обнулилась, при активном `SellPosOpen` отправляется рыночная заявка на продажу. Механизм отложенного входа идентичен варианту для лонга.
- Нейтральный цвет (1) не приводит к действиям.
- Одновременно поддерживается только одна позиция: стратегия не накапливает сделки и ожидает фактического закрытия перед разворотом.

## Управление рисками
- `StopLossPoints` и `TakeProfitPoints` задают расстояние в шагах цены. После исполнения рыночной заявки в обработчике `OnNewMyTrade` выставляются стоп и тейк-профит относительно фактической цены сделки.
- При закрытии позиции, а также при подготовке нового сигнала защиты автоматически снимаются, полностью повторяя логику вспомогательных функций из MQL.

## Параметры
| Имя | Описание |
| --- | --- |
| `CandleType` | Тип/таймфрейм свечей, по которым строится индикатор. |
| `Length` | Размер окна сглаживания (количество последних свечей). |
| `Rank1`, `Rank2`, `Rank3` | Степени, формирующие профиль весовых коэффициентов. |
| `Shift1`, `Shift2`, `Shift3` | Доли смешивания весовых функций с равномерным распределением. |
| `GapPoints` | Максимальная допустимая щель между синтетическими `Open` и `Close`, при превышении которой открытие заменяется прошлым закрытием. Значение задаётся в шагах цены. |
| `SignalBar` | Количество закрытых свечей, которые нужно пропустить от текущей; `1` соответствует последней завершённой свече. |
| `BuyPosOpen` / `SellPosOpen` | Разрешение на открытие длинных/коротких позиций. |
| `BuyPosClose` / `SellPosClose` | Разрешение на закрытие длинных/коротких позиций при противоположном цвете. |
| `StopLossPoints` | Расстояние до защитного стоп-ордера (в шагах цены). `0` отключает стоп. |
| `TakeProfitPoints` | Расстояние до тейк-профита (в шагах цены). `0` отключает тейк. |
| `PriceShiftPoints` | Вертикальное смещение синтетической свечи, выраженное в шагах цены. |

## Особенности реализации
- Применяется `BindEx`, так как кастомный индикатор возвращает комплексное значение с синтетическими ценами и цветом одновременно.
- Для детектирования смены цвета хранится не более `SignalBar + 2` последних значений, что избавляет от ненужного накопления данных.
- При смене направления стратегия сначала закрывает текущую позицию, затем открывает противоположную, дожидаясь подтверждения обнуления в `OnPositionChanged`, что точно повторяет шаги исходного эксперта.
