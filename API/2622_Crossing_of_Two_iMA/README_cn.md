# Crossing of Two iMA 策略
[English](README.md) | [Русский](README_ru.md)

该策略将 MetaTrader 5 上广受欢迎的 **“Crossing of two iMA”** 专家顾问完整迁移到 StockSharp 的高级 API。系统在两条可配置均线发生交叉时交易，并可选地通过第三条均线确认趋势方向。与原始 EA 一样，策略支持手动下单手数或基于账户风险百分比的动态仓位、`PriceLevelPips` 参数控制的类挂单入场方式，以及带有步进的追踪止损。

所有信号都在收盘完成的 K 线处计算，实现了 EA “等待新柱子” 的逻辑。`PriceLevelPips` 对应的挂单行为在内部模拟：策略跟踪蜡烛的最高价和最低价，当价格触发预设水平时立即入场，因此不会向交易所发送真实的 stop/limit 订单。多单触发条件分别对应买入止损和买入限价，空头触发条件与之对称。

## 交易规则

- **指标**
  - 第一条均线（周期、移位与算法均可配置）。
  - 第二条均线（同样可配置）。
  - 可选的第三条均线过滤器（`UseThirdMovingAverage = true`）。
- **入场条件**
  - **主交叉（柱 0 与柱 1）**
    - **多头**：当前柱第一均线从下向上穿过第二均线，上一柱仍位于下方。如果启用了过滤器，则第三均线必须低于第一均线。
    - **空头**：第一均线从上向下穿过第二均线，若启用过滤器，则第三均线需高于第一均线。
  - **补充交叉（柱 0 与柱 2）**
    - 捕捉在前两根柱之间发生的快速交叉。如果最近三根柱内已开仓，则忽略该信号，等价于原始 EA 的历史检查逻辑。
- **方向**：可做多亦可做空。
- **止损与目标**
  - 止损和止盈以点（pip）为单位输入，随后根据品种最小报价步长转换成价格距离，并对 3/5 位小数的货币对做与 EA 相同的调整。
  - 当 `TrailingStopPips > 0` 时启用追踪止损；价格每向有利方向推进至少 `TrailingStepPips` 点后，止损就向前移动固定距离。
- **`PriceLevelPips` 行为**
  - `0`：立即市价进场。
  - `< 0`：模拟止损挂单（多单高于当前价，空单低于当前价），止损和止盈同时按同样幅度平移。
  - `> 0`：模拟限价挂单（多单低于当前价，空单高于当前价），保护价位相应平移。

## 资金管理

- `UseFixedVolume = true` 时完全复现 EA 的“手动手数”模式：使用策略参数 `Volume`，并在开新仓前平掉反向仓位。
- 当 `UseFixedVolume = false` 时，仓位大小按照 `Portfolio.CurrentValue * RiskPercent / 100` 计算风险金额，再除以止损距离。如果未设置止损（`StopLossPips = 0`），风险距离为零，策略将拒绝开仓，这与 MQL5 中 `MoneyFixedRisk` 返回零手数的结果一致。

## 追踪止损

- 多单：当价格至少向有利方向移动 `TrailingStepPips` 点后，止损更新为 `Close - TrailingStopPips * pipValue`，且不会下移。
- 空单：对称地更新为 `Close + TrailingStopPips * pipValue`，确保止损始终向盈利方向收紧。
- 在调整追踪止损前，先检测是否触发初始止损或止盈，以保持与原策略相同的优先级。

## 默认参数

- 第一均线：周期 `5`、移位 `3`、方法 `Smoothed`。
- 第二均线：周期 `8`、移位 `5`、方法 `Smoothed`。
- 第三均线过滤器：开启，周期 `13`、移位 `8`、方法 `Smoothed`。
- 风险控制：止损 `50` 点、止盈 `50` 点、追踪 `10` 点，步进 `4` 点。
- 资金管理：默认 `UseFixedVolume = true`，`RiskPercent = 5` 供动态手数使用。
- 入场偏移：`0` 点（市价）。
- K 线类型：1 分钟，可根据需要替换成任意周期。

## 实现说明

- 均线的 `shift` 参数会将指标值延迟指定柱数，因此在 StockSharp 图表上与 MT5 的视觉移位一致。
- 策略只保留最小的状态（当前柱以及前两柱的数值），即可实现原 EA 的「柱 [0], [1], [2]」逻辑，不会创建额外的大型历史集合。
- 每当出现新的信号都会清空待触发的入场，模拟 EA 中的 `DeleteAllOrders()` 调用。
- 由于 StockSharp 的订单执行是异步的，策略记录的入场价使用目标触发价来计算追踪止损和止盈位置。在以蜡烛数据回测时，这样即可重现原 EA 的行为，无需依赖逐笔成交。
