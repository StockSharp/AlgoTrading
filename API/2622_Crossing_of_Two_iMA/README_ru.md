# Стратегия Crossing of Two iMA
[English](README.md) | [中文](README_cn.md)

Эта стратегия переносит популярного эксперта MetaTrader 5 **«Crossing of two iMA»** в высокоуровневый API StockSharp. Сделки открываются при пересечении двух настраиваемых скользящих средних, а дополнительная третья средняя может выступать фильтром направления. Реализация сохраняет гибкость оригинала: поддерживаются ручной объём или риск-менеджмент по проценту капитала, отложенный стиль входа с параметром `PriceLevelPips` и трейлинг-стоп с регулируемым шагом.

Сигналы рассчитываются только на закрытии завершённых свечей, что повторяет логику эксперта MQL5 «ждать новый бар». Поведение отложенных ордеров (`PriceLevelPips`) эмулируется внутри стратегии — фактические стоп/лимит заявки не отправляются. Для покупок стоп-вход срабатывает, когда максимум свечи достигает целевого уровня, а лимит-вход — когда минимум опускается до заданной цены. Для коротких сделок применяется зеркальная схема.

## Торговые правила

- **Индикаторы**
  - Первая скользящая средняя (период, сдвиг и метод сглаживания задаются параметрами).
  - Вторая скользящая средняя (аналогично настраивается).
  - Опциональная третья скользящая средняя-фильтр (`UseThirdMovingAverage = true`).
- **Условия входа**
  - **Основное пересечение (бары 0 и 1)**
    - **Лонг**: первая средняя пересекает вторую снизу вверх на текущем баре, а на предыдущем баре находилась ниже. Если фильтр активен, третья средняя должна находиться ниже первой.
    - **Шорт**: первая средняя пересекает вторую сверху вниз; при включённом фильтре третья средняя должна быть выше первой.
  - **Дополнительное пересечение (бары 0 и 2)**
    - Позволяет отловить резкие переходы, произошедшие между двумя предыдущими барами. Сигнал игнорируется, если в пределах последних трёх баров уже открывалась сделка (аналог `SearchPositions` в оригинале).
- **Направление**: торгуются лонги и шорты.
- **Стопы и цели**
  - Стоп-лосс и тейк-профит задаются в пунктах и преобразуются в ценовые оффсеты с учётом шага цены и 3/5-значного котирования, как в исходном советнике.
  - Трейлинг-стоп активируется, когда `TrailingStopPips > 0`. Стоп переносится на расстояние трейлинга после того, как цена продвинулась минимум на `TrailingStepPips` пунктов от предыдущего уровня.
- **Режим `PriceLevelPips`**
  - `0`: вход по рынку.
  - `< 0`: имитация стоп-ордеров (buy stop выше цены, sell stop ниже). Стоп и тейк смещаются на тот же оффсет.
  - `> 0`: имитация лимит-ордеров (buy limit ниже цены, sell limit выше). Защитные уровни смещаются симметрично.

## Управление капиталом

- `UseFixedVolume = true` повторяет ручной режим лота: стратегия использует параметр `Volume` и перед открытием новой сделки закрывает противоположную позицию.
- При `UseFixedVolume = false` риск рассчитывается как `Portfolio.CurrentValue * RiskPercent / 100`. Объём позиции равен `riskAmount / stopDistance`. Если стоп-лосс отключён (`StopLossPips = 0`), расстояние до стопа равно нулю, поэтому стратегия отказывается открывать позицию — это полностью соответствует поведению класса `MoneyFixedRisk` в MQL5.

## Логика трейлинг-стопа

- Для лонга стоп переносится на уровень `Close - TrailingStopPips * pipValue`, когда цена проходит в прибыльном направлении минимум `TrailingStepPips` пунктов. Стоп никогда не отступает назад.
- Для шорта стоп зеркально переносится на `Close + TrailingStopPips * pipValue` при достаточном движении в сторону прибыли.
- Проверка тейк-профита и исходного стопа выполняется до перерасчёта трейлинга, что совпадает с приоритетами оригинала.

## Значения по умолчанию

- Первая средняя: период `5`, сдвиг `3`, метод `Smoothed`.
- Вторая средняя: период `8`, сдвиг `5`, метод `Smoothed`.
- Фильтр: включён, период `13`, сдвиг `8`, метод `Smoothed`.
- Риск-параметры: стоп `50` пунктов, тейк `50` пунктов, трейлинг `10` пунктов и шаг `4` пункта.
- Управление капиталом: `UseFixedVolume = true`, `RiskPercent = 5` для альтернативного режима.
- Смещение входа: `0` пунктов (рыночный вход).
- Тип свечей: таймфрейм 1 минута (можно сменить на нужный таймфрейм графика).

## Особенности реализации

- Параметры `shift` задерживают значения скользящих ровно на заданное число баров, поэтому отображение на графиках StockSharp совпадает с MT5.
- Хранится лишь минимальный буфер значений (текущий бар и два предыдущих), достаточный для логики «бары [0], [1], [2]» из MQL5 — дополнительных коллекций не создаётся.
- Любой новый сигнал очищает ожидающий вход, имитируя вызов `DeleteAllOrders()`.
- Поскольку в StockSharp заявки исполняются асинхронно, для расчёта трейлинга и целей используется целевая цена входа. При тестировании на свечных данных это воспроизводит оригинальную логику без необходимости тиковой точности.
