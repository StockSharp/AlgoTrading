# Стратегия Money Rain

## Описание
- Конвертация советника MetaTrader 4 **MoneyRain.mq4** на высокоуровневый API StockSharp.
- Торговля ведётся по закрытию сформированных свечей с фильтрацией индикатором DeMarker.
- Сохранены фиксированные стоп-лосс и тейк-профит, а также оригинальный блок увеличения объёма после серии убыточных сделок.

## Логика торговли
1. Подписка на свечи типа `CandleType` (по умолчанию часовые) и расчёт DeMarker с периодом `DeMarkerPeriod`.
2. При отсутствии позиции и активных заявок:
   - Покупка, если DeMarker выше порога `Threshold`.
   - Продажа в противном случае.
   - Объём берётся либо базовый, либо рассчитанный блоком восстановления после убытков.
3. При открытой позиции стратегия контролирует каждую завершённую свечу:
   - Лонг закрывается, если минимум свечи достиг уровня стопа (`StopLossPoints` ниже входа) либо максимум дошёл до цели (`TakeProfitPoints` выше входа).
   - Шорт закрывается зеркально по тем же правилам.
4. После выхода модуль управления капиталом обновляет счётчики серий. При достижении `LossesLimit` открытия новых позиций блокируются и в лог пишется предупреждение.

## Управление капиталом
- `BaseVolume` нормализуется по биржевым ограничениям (`Security.VolumeStep`, `Security.MinVolume`, `Security.MaxVolume`). Если нормализованное значение меньше минимального лота, вход пропускается.
- После убытка сохраняется использованный объём (в долях от базового) и сбрасывается счётчик прибыльных сделок. Следующая прибыльная сделка применяет формулу MoneyRain `baseLot × lossesVolume × (StopLoss + spread) / (TakeProfit − spread)` для компенсации. Последующие выигрыши возвращают объём к базовому, а накопитель сбрасывается после двух и более подряд.
- При включённом `FastOptimization` восстановительный блок отключён, каждая заявка отправляется с нормализованным базовым объёмом.
- Спред для формулы оценивается по последним лучшим bid/ask из ленты Level1; при отсутствии котировок считается равным нулю.

## Параметры
| Параметр | Описание | Значение по умолчанию | Примечания |
|----------|----------|-----------------------|------------|
| `DeMarkerPeriod` | Период индикатора DeMarker. | `10` | Значение должно быть больше нуля. |
| `TakeProfitPoints` | Дистанция до тейк-профита в шагах цены. | `50` | Перемножается на `Security.PriceStep`. |
| `StopLossPoints` | Дистанция до стоп-лосса в шагах цены. | `50` | Должна оставаться положительной для корректной формулы восстановления. |
| `BaseVolume` | Базовый объём заявки. | `1` | Нормализуется перед отправкой. |
| `LossesLimit` | Максимум последовательных убытков. | `1 000 000` | По достижении торговля останавливается до сброса стратегии. |
| `FastOptimization` | Отключить восстановительный объём при оптимизации. | `true` | Ускоряет массовые прогоны. |
| `Threshold` | Порог DeMarker для разделения лонгов и шортов. | `0.5` | Совпадает с константой из оригинала. |
| `CandleType` | Тип свечей для сигналов. | `1h` | Можно заменить на другой таймфрейм или агрегацию. |

## Рекомендации
- Проверьте корректность `Security.PriceStep`, `Security.VolumeStep`, `Security.MinVolume`, `Security.MaxVolume`, чтобы преобразования цены и объёма не давали неверных значений.
- Стоп и тейк должны быть положительными: нули отключают выходы и расходятся с поведением исходного советника.
- Стратегия ждёт фактического исполнения и умеет накапливать частичные выходы, используя средневзвешенную цену закрытия.
- После срабатывания лимита убытков следующие сигналы игнорируются — перезапустите или сбросьте стратегию для возобновления работы.
