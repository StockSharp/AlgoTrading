# Стратегия Pending Orders By Time
[English](README.md) | [中文](README_cn.md)

Эта стратегия переносит советник MetaTrader «Pending orders by time» в StockSharp. Логика полностью завязана на расписание: в выбранный час открытия она выставляет симметричные стоп-заявки выше/ниже рынка, а в заданный час закрытия отменяет все незаполненные заявки и принудительно фиксирует позиции. Все параметры задаются в пунктах, как и в оригинале, а внутри конвертируются в цену с учётом точности котировок инструмента.

## Как работает алгоритм

1. **Триггер по времени.** Когда приходит свеча, закрывающаяся в час открытия, стратегия отправляет Buy Stop над лучшей ценой ask и Sell Stop под лучшей ценой bid. Смещение рассчитывается по параметру `Distance (pips)`.
2. **Защитные ордера.** Метод `StartProtection` автоматически добавляет стоп-лосс и тейк-профит с расстоянием, указанным в пунктах. Дополнительно метод `ManageRisk` проверяет закрывшиеся свечи и вручную закрывает позицию, если ценовой ход превысил стоп или цель.
3. **Завершение сессии.** В час закрытия стратегия отменяет все оставшиеся стоп-заявки и закрывает позицию по рынку, чтобы начать следующий день «с чистого листа».
4. **Учёт количества знаков.** Размер пункта вычисляется как шаг цены, умноженный на десять для инструментов с тремя или пятью знаками после запятой (JPY, пятизначные котировки). Благодаря этому исходные параметры в пунктах ведут себя так же, как в MetaTrader.

По умолчанию используется таймфрейм 30 минут — это укладывается в требование оригинала работать на периодах не длиннее H1. При необходимости можно выбрать другую свечную серию, главное, чтобы отметки часов совпадали с нужным расписанием.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `Opening Hour` | Час (0–23), когда выставляется пара стоп-заявок. | 9 |
| `Closing Hour` | Час (0–23), когда отменяются заявки и закрываются позиции. | 2 |
| `Distance (pips)` | Смещение в пунктах от текущей цены до уровней стоп-заявок. | 20 |
| `Stop Loss (pips)` | Расстояние стоп-лосса в пунктах. | 20 |
| `Take Profit (pips)` | Расстояние тейк-профита в пунктах. | 500 |
| `Order Volume` | Объём каждой стоп-заявки. | 0.1 |
| `Candle Type` | Таймфрейм, по которому отслеживаются часы. | 30-минутный таймфрейм |

Все параметры пригодны для оптимизации. Внутри стратегии значения в пунктах преобразуются через шаг цены, поэтому она корректно работает на разных FX-инструментах с отличающейся точностью котировки.

## Суточный цикл

1. **На каждом закрытии свечи** проверяется, достигнут ли стоп-лосс или тейк-профит. Если да — позиция закрывается рыночным ордером.
2. **В момент закрывающего часа** отменяются незаполненные заявки и закрывается позиция, чтобы не переносить сделки на следующий день.
3. **В момент открывающего часа** (при отсутствии позиции) дополнительно отменяются старые заявки и отправляется новая пара Sell Stop / Buy Stop симметрично относительно текущего спреда.
4. **В течение сессии** защитные ордера, запущенные через `StartProtection`, следят за превышением стопа или цели внутри свечи и срабатывают немедленно.

## Практические замечания

- Используйте инструменты, у которых шаг цены соответствует «пункту» — так сохранится логика исходного советника. Для экзотических тик-сайзов может потребоваться корректировка расстояний.
- Предполагается один торговый цикл в сутки. Если данные содержат несколько совпадений часов, скорректируйте параметры открытия/закрытия.
- Поскольку решения принимаются на закрытии свечи, выбирайте таймфрейм с нужной частотой контроля. Часовые свечи полностью повторяют поведение оригинала.
- Новые стоп-заявки выставляются только при нулевой позиции, чтобы не наращивать риск, если пробой уже в работе.

## Отличия от MQL-версии

- Защитные уровни реализованы через `StartProtection` и дополнительную проверку, а не через прямое присвоение стоп-лосса заявке.
- Цены bid/ask берутся из `Security.BestBid` и `Security.BestAsk`. При отсутствии котировок используется цена закрытия свечи.
- Для фиксации позиции в час закрытия применяются рыночные ордера — это упрощает переносимость между брокерами.
