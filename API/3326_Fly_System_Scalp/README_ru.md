# Стратегия Fly System Scalp

## Общее описание
Fly System Scalp — это адаптация советника *FlySystemEA* на платформу StockSharp. Стратегия постоянно отслеживает лучшие цены Bid/Ask и выставляет симметричные стоп-ордера Buy Stop и Sell Stop на фиксированном расстоянии от рынка. Цель — быстро реагировать на импульсные движения, сохраняя строгий контроль над спредом, комиссиями и торговым расписанием.

## Логика работы
1. **Подписка на Level-1**. Стратегия получает обновления лучшего предложения и спроса по инструменту.
2. **Проверки перед действиями**. На каждом тике выполняются проверки:
   * стратегия подключена и разрешено выставление заявок;
   * текущий момент входит в торговый интервал (если фильтр включён);
   * спред плюс значение `CommissionInPips` не превышает параметр `MaxSpread`.
3. **Размещение стоп-ордеров**. При выполнении условий и отсутствии открытых позиций выставляются два ордера:
   * Buy Stop на уровне `Ask + PendingDistance * pip` с защитным стоп-лоссом и опциональным тейк-профитом;
   * Sell Stop на `Bid - PendingDistance * pip` с зеркальными параметрами.
   Если актуальная цена отличается от требуемой более чем на `ModifyThreshold` пунктов, ордера перерегистрируются.
4. **Сопровождение**. При исполнении одного ордера противоположный немедленно отменяется. Если спред или время выходят за допустимые границы, все отложенные заявки удаляются и цикл ожидания начинается заново.
5. **Управление объёмом**. При включённом `AutoLotSize` объём рассчитывается как доля (`RiskFactor`%) от капитала, делённая на возможный убыток по стоп-лоссу. При отсутствии данных брокера используется фиксированный `ManualVolume`.
6. **Защитные механизмы**. Вызов `StartProtection()` подключает встроенную защиту StockSharp для контроля позиции.

## Параметры
| Название | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `PendingDistance` | Расстояние до рынка в пунктах для обоих стоп-ордеров. | 4 |
| `StopLossDistance` | Размер стоп-лосса в пунктах. | 0.4 |
| `TakeProfitDistance` | Размер тейк-профита в пунктах. | 10 |
| `UseTakeProfit` | Включение/отключение тейк-профита. | `false` |
| `MaxSpread` | Максимально допустимый спред (0 — без ограничения). | 1 |
| `CommissionInPips` | Комиссия в пунктах, добавляемая к спреду при проверке. | 0 |
| `AutoLotSize` | Автоматический расчёт объёма. | `false` |
| `RiskFactor` | Процент капитала для расчёта риска. | 10 |
| `ManualVolume` | Фиксированный объём без автолота. | 0.1 |
| `UseTimeFilter` | Использовать ли торговый интервал. | `false` |
| `TradeStartTime` | Начало торгового интервала (включительно). | 00:00:00 |
| `TradeStopTime` | Конец торгового интервала (исключая). | 00:00:00 |
| `ModifyThreshold` | Минимальное отклонение в пунктах для перерегистрации ордера. | 1 |

## Рекомендации по использованию
* Для автоматического расчёта объёма требуются корректные свойства инструмента: `Step`, `PriceStep`, `StepPrice`, `LotStep`, `MinVolume`, `MaxVolume`. При отсутствии данных стратегия использует `ManualVolume`.
* Размер пункта определяется по шагу цены и количеству знаков, что соответствует логике исходного советника (учёт трёх- и пятизнаковых котировок).
* Если `TradeStartTime` и `TradeStopTime` совпадают при включённом фильтре, торговля разрешена круглосуточно. При `TradeStartTime > TradeStopTime` диапазон считается переходящим через полночь.
* Проверка спреда суммирует фактический спред и `CommissionInPips`, что эквивалентно оригинальной реализации.
* Визуальные объекты не создаются — отображение можно организовать отдельными инструментами.

## Отличия от оригинала
* Удалены таймер и графические элементы, присутствовавшие в MQL-версии; управление построено на событиях StockSharp.
* Логика модификации ордеров упрощена: перерегистрация выполняется при превышении порога `ModifyThreshold`.
* Автоопределение комиссий заменено на ручной параметр, но контроль спреда по-прежнему учитывает комиссию.
* Вместо ручного контроля стоп-уровней используется стандартный метод `StartProtection()`.

## Советы по тестированию
Для корректного бэктеста необходимы исторические данные уровня 1 (bid/ask) либо реконструированный поток котировок из тиков. Только свечные данные не позволят корректно смоделировать исполнение стоп-ордеров.
