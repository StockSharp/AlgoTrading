# ColorMetroDuplexStrategy

## Общее описание

`ColorMetroDuplexStrategy` — это перенос советника MetaTrader 5 **Exp_ColorMETRO_Duplex** на платформу StockSharp. Оригинальный робот использует два независимых модуля ColorMETRO: первый управляет длинными позициями, второй — короткими. Каждый модуль анализирует свечи своего таймфрейма, получает из индикатора пару ступенчатых RSI-каналов и по их пересечению принимает решение об открытии или закрытии сделок.

В C# версии сохранена структура из двух модулей и реализован отдельный индикатор `ColorMetroIndicator`, полностью повторяющий алгоритм MT5. Все расчёты выполняются через высокоуровневый API: `SubscribeCandles`, `BindEx`, `BuyMarket` / `SellMarket` и т.д.

## Логика работы

1. При инициализации создаются два `SignalModule` — **Long** и **Short**.
2. В методе `OnStarted` для каждого модуля оформляется подписка на свечи и подключается `ColorMetroIndicator`.
3. С каждой закрывшейся свечой индикатор возвращает:
   - быстрый канал (fast band),
   - медленный канал (slow band),
   - внутреннее значение RSI.
4. Модуль сохраняет историю значений и анализирует две последние точки с учётом смещения `SignalBar`, как это делалось через `CopyBuffer` в MT5.
5. Правила торговли:
   - **Long**
     - *Открытие*: на предыдущей свече быстрый канал был выше медленного, на текущей (с учётом `SignalBar`) — опустился ниже либо сравнялся.
     - *Закрытие*: на предыдущей свече медленный канал находился выше быстрого.
   - **Short**
     - *Открытие*: быстрый канал был ниже медленного и перешёл выше либо сравнялся.
     - *Закрытие*: медленный канал был ниже быстрого.
6. При поступлении сигнала стратегия проверяет текущий нетто-позиционный объём. В случае смены направления сначала закрывается противоположная позиция, затем открывается новая.

## Параметры

Параметры сгруппированы по модулям; значения по умолчанию соответствуют исходному советнику.

### Торговые настройки

- **Long_Volume**, **Short_Volume** — объём сделки (лоты).
- **Long_OpenAllowed**, **Short_OpenAllowed** — разрешение на открытие позиций соответствующим модулем.
- **Long_CloseAllowed**, **Short_CloseAllowed** — разрешение на автоматическое закрытие.
- **Long_MarginMode**, **Short_MarginMode** — режим управления капиталом (оставлен для совместимости, не используется).
- **Long_StopLoss**, **Long_TakeProfit**, **Long_Deviation**, а также зеркальные параметры для Short — информационные поля, в портированной версии стоп-заявки автоматически не выставляются.
- **Long_Magic**, **Short_Magic** — оригинальные магические номера MT5.

### Настройки индикатора

- **Long_CandleType**, **Short_CandleType** — таймфреймы свечей для каждого модуля.
- **Long_PeriodRSI**, **Short_PeriodRSI** — период RSI внутри ColorMETRO.
- **Long_StepSizeFast**, **Short_StepSizeFast** — шаг быстрого канала (в пунктах RSI).
- **Long_StepSizeSlow**, **Short_StepSizeSlow** — шаг медленного канала.
- **Long_SignalBar**, **Short_SignalBar** — смещение, указывающее какую свечу использовать для сигналов.
- **Long_AppliedPrice**, **Short_AppliedPrice** — тип цены для расчёта RSI (по умолчанию close).

## Отличия от версии MT5

- **Нетто-позиция**. В MT5 модули управляли собственными позициями по магическим номерам. StockSharp оперирует совокупной позицией по инструменту, поэтому при смене направления происходит полное закрытие и затем открытие в противоположную сторону.
- **Управление риском**. Режимы MarginMode и значения стопов сохранены как параметры, но не влияют на размер заявки — его задаёт `Volume`.
- **Стоп-приказы**. В оригинале ордеры сопровождались stop-loss и take-profit. Здесь расстояния указаны только для справки; при необходимости их можно задать вручную в коде.
- **Контроль времени**. MT5 использовал глобальные переменные, чтобы не открывать повторные позиции в пределах одного уровня времени. В StockSharp обработка выполняется один раз на закрытии свечи, а фильтрацию дубликатов обеспечивает проверка текущей позиции.

## Дополнительные замечания

- `ColorMetroIndicator` реализует шаговые RSI-каналы и хранит предыдущее состояние тренда, что важно для получения идентичных сигналов с MT5.
- В коде присутствуют подробные комментарии на английском языке, поясняющие ключевые решения при портировании.
- Для добавления стопов, трейлинг-логики или альтернативного мани-менеджмента можно расширить методы `ProcessModule` и `SignalModule`.
