# Стратегия Backbone

Данная реализация переносит эксперта **Backbone** с платформы MetaTrader 5 на высокоуровневый API StockSharp. Алгоритм поочерёдно формирует длинные и короткие серии сделок, наращивает позицию по доле риска и защищает её фиксированными целями, дополняя сопровождением по трейлинг-стопу.

## Основная идея

1. **Определение стартового направления.** После запуска стратегия отслеживает максимумы и минимумы. Импульс, превышающий дистанцию `TrailingStopPips`, задаёт первое рабочее направление.
2. **Циклы по направлениям.** Пока серия активна, торгуется только одна сторона. После полного закрытия всех позиций счётчик сбрасывается и логика готовится к сделкам в противоположную сторону.
3. **Масштабирование по риску.** Каждое добавление позиций рассчитывает новый объём на основе капитала счёта, параметра `MaxRisk`, лимита `MaxTrades` и величины стоп-лосса — аналогично функции `Vol` в оригинальном советнике.
4. **Защита позиции.** Стоп-лосс и тейк-профит пересчитываются для усреднённой цены текущей серии. Трейлинг-стоп подтягивает защитный уровень, как только прибыль превышает заданный порог.

## Параметры

| Параметр | Значение по умолчанию | Назначение |
|----------|-----------------------|------------|
| `MaxRisk` | 0.5 | Доля капитала, доступная для одной направленной серии. |
| `MaxTrades` | 10 | Максимальное количество усреднений в рамках цикла. |
| `TakeProfitPips` | 170 | Расстояние до тейк-профита в пипсах. |
| `StopLossPips` | 40 | Расстояние до защитного стоп-ордера в пипсах. |
| `TrailingStopPips` | 300 | Порог для определения направления и для трейлинга. |
| `CandleType` | 5-минутные свечи | Тип свечей, по которым выполняются расчёты. |

> **Пояснение по пипсу.** Размер шага автоматически подстраивается по `PriceStep`. Для инструментов с 3 или 5 десятичными знаками применяется коэффициент ×10, как в MetaTrader.

## Логика торговли

1. Обрабатываются только закрытые свечи, при этом стратегия должна быть готова к торгам (`IsFormedAndOnlineAndAllowTrading`).
2. Пока направление не выбрано, обновляются экстремумы и проверяется пробой на величину `TrailingStopPips`.
3. Для длинной серии:
   - Открывается первая покупка, если прошлый цикл был коротким и позиция отсутствует.
   - Дополнительные покупки разрешены, если текущая серия уже длинная и количество сделок меньше `MaxTrades`.
   - Выход осуществляется по тейк-профиту, стоп-лоссу либо после подтяжки трейлинга.
4. Для короткой серии выполняются зеркальные условия.
5. После закрытия серии счётчики сбрасываются, и стратегия готовится к обратному движению.

## Расчёт объёма

Объём каждой новой сделки вычисляется по формуле:

```
qty = equity * fraction / (pipSize * stopLoss)
где fraction = 1 / (MaxTrades / MaxRisk - openTrades)
```

Полученный объём округляется по шагу лота и ограничивается минимальным/максимальным значением. Если расчёт меньше допустимого минимума, используется минимальный объём. При отсутствии данных по капиталу применяется стандартный объём стратегии.

## Управление выходом

- **Стоп-лосс и тейк-профит.** После каждого усреднения пересчитываются относительно средневзвешенной цены текущей серии.
- **Трейлинг-стоп.** Для длинных позиций стоп переносится на `Close - TrailingStopPips * pipSize`, когда плавающая прибыль превышает заданную дистанцию. Для коротких позиций используется зеркальная логика.

## Особенности

- StockSharp работает в модели неттинга, поэтому управление ведётся по совокупной позиции, а не по отдельным ордерам. Алгоритм повторяет оригинальную смену направлений, адаптированную под неттинговый учёт.
- Расчёты выполняются на закрытии свечи. Внутридневные движения меньше диапазона свечи не анализируются.
- Для корректной работы необходимо выбрать таймфрейм и инструмент с достаточным объёмом исторических данных, чтобы сформировать стартовые экстремумы.

