# Backbone 策略

本策略将 MetaTrader 5 平台上的 **Backbone** 智能交易系统迁移到 StockSharp 的高级 API 上。系统按周期交替做多、做空，通过风险分配扩展仓位，并使用固定止盈、止损以及移动止损保护仓位。

## 核心思路

1. **确定首个交易方向**：启动后记录最高价与最低价，当价格突破任一极值超过 `TrailingStopPips` 指定的距离时，确定首个交易方向。
2. **方向循环**：在一个方向的循环中，只执行该方向的交易。全部仓位平仓后，立即切换到相反方向的准备状态。
3. **基于风险的加仓**：每次加仓都会根据账户权益、`MaxRisk` 参数、`MaxTrades` 限制以及止损距离重新计算下单量，复现原 EA 中的 `Vol` 函数逻辑。
4. **仓位保护**：每次建仓都会以当前方向的加权平均价重新计算止盈与止损，并在浮动利润超过阈值时利用移动止损收紧保护水平。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MaxRisk` | 0.5 | 当前方向可使用的账户权益比例。 |
| `MaxTrades` | 10 | 每个方向最多允许的加仓次数。 |
| `TakeProfitPips` | 170 | 以平均建仓价为基准的止盈距离（点）。 |
| `StopLossPips` | 40 | 以平均建仓价为基准的止损距离（点）。 |
| `TrailingStopPips` | 300 | 用于确定方向与移动止损的距离（点）。 |
| `CandleType` | 5 分钟 K 线 | 用于信号计算的蜡烛类型。 |

> **点值说明**：策略会根据合约的 `PriceStep` 自动调整点值。报价有 3 或 5 位小数的品种会自动乘以 10，与 MetaTrader 的处理方式一致。

## 交易流程

1. 仅在蜡烛收盘后执行计算，并确保策略已完成初始化且允许交易。
2. 在尚未选定方向时持续更新极值，一旦价格突破极值超过 `TrailingStopPips`，即可确定初始方向。
3. 当方向为多头时：
   - 如果上一轮为空头且当前无仓位，则开立第一笔多单。
   - 若当前为多头循环且仓位数量少于 `MaxTrades`，可以继续加仓。
   - 当价格触及止盈、止损或移动止损抬升到当前止损上方时，平掉整组仓位。
4. 空头循环遵循对称的规则。
5. 循环结束后重置计数器，等待下一次反向机会。

## 仓位计算

```
qty = equity * fraction / (pipSize * stopLoss)
其中 fraction = 1 / (MaxTrades / MaxRisk - openTrades)
```

计算结果会按合约的最小下单步长取整，同时限制在允许的最小/最大下单量范围内。如果结果低于最小值，则使用最小下单量；当账户权益不可用时，回退到策略默认的下单量。

## 出场管理

- **止损 / 止盈**：每次加仓后都会根据当前方向的平均价格重新设置，使整组仓位共享相同的保护与目标水平。
- **移动止损**：当多头浮动盈利大于 `TrailingStopPips * pipSize` 时，将止损上移至 `Close - TrailingStopPips * pipSize`；空头逻辑与之相反。

## 注意事项

- StockSharp 使用净额持仓模型，因此策略针对方向循环管理的是整体仓位，而不是单个订单，但仍保留与原策略相同的轮换节奏和风险分配公式。
- 策略以收盘数据进行决策，蜡烛内部的细小波动不会触发信号。
- 请选择具有充足历史数据的品种与时间框架，以便在启动阶段形成可靠的初始极值。

