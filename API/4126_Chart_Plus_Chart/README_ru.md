# Стратегия Chart Plus Chart Monitor
[English](README.md) | [中文](README_cn.md)

## Обзор
Стратегия представляет собой перенос на StockSharp вспомогательного советника *ChartPlusChartV2* (файлы `Chart1.mq4` и `Chart2.mq4`). Оригинальные MQL-скрипты не ведут торговлю. Их задача — собрать ключевые показатели счёта (последняя цена закрытия, количество открытых ордеров, баланс счёта и прибыль выбранного ордера) и записать их в DLL `SharedVarsDLLv2.dll`, чтобы несколько графиков могли одновременно показывать одинаковые данные. Версия на C# придерживается той же идеи: каждое рыночное обновление формирует сводный снимок статистики, который можно вывести на пользовательские панели, дополнительные области графиков или внешние виджеты.

В отличие от реализации на MetaTrader, зависящей от Windows DLL, порт использует стандартные возможности базового класса `Strategy`. Снимки доступны через свойства только для чтения и при необходимости выводятся в журнал, что делает инструмент кроссплатформенным и избавляет от работы с разделяемой памятью.

## Ключевые особенности
- **Централизованный мониторинг.** Стратегия хранит актуальную цену закрытия, количество активных ордеров, стоимость портфеля и прибыль последней сделки, что позволяет легко подключить визуализацию или аналитику.
- **Событийная модель обновления.** Снимки пересчитываются при закрытии свечей, изменении состояния ордеров и исполнении сделок, полностью повторяя частоту обновлений исходных скриптов.
- **Настраиваемое подробное логирование.** Дополнительный флаг позволяет транслировать значения в журнал и имитировать передачу данных через DLL.
- **Безопасные значения по умолчанию.** Если брокер пока не передал текущую стоимость портфеля, используется стартовый баланс, чтобы избежать появления ложного нуля.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CandleType` | `TimeSpan.FromMinutes(1).TimeFrame()` | Таймфрейм, по которому формируются свечи. Каждая завершённая свеча даёт новое значение закрытия и инициирует пересчёт статистики — аналог `Close[0]` в MQL. |
| `LogOnEveryUpdate` | `false` | При включении каждый снимок записывается в журнал стратегии, что удобно для отладки или внешнего мониторинга. |

## Возвращаемые свойства
- `LastClosePrice` – последняя обработанная цена закрытия.
- `OpenOrdersCount` – количество активных ордеров (`ActiveOrders.Count`), аналог функции `OrdersTotal()`.
- `AccountValue` – текущая стоимость портфеля или стартовый баланс, если значение ещё недоступно.
- `LastTradeProfit` – прибыль последней сделки, вычисленная как приращение суммарного PnL.
- `LastSnapshotTime` – время формирования последнего снимка, полезно для контроля актуальности данных.

## Как работает стратегия
1. **Запуск.** В методе `OnStarted` стратегия подписывается на свечи выбранного таймфрейма, фиксирует текущее значение PnL и публикует стартовый снимок.
2. **Обновление свечей.** Каждая завершённая свеча обновляет цену закрытия и пересчитывает все показатели — точно так же, как MQL-скрипты вызывали `SetFloat`/`SetInt` на каждом тике.
3. **Изменения ордеров.** Переопределение `OnOrderChanged` синхронизирует счётчик ордеров даже в периоды без новых свечей.
4. **Исполнение сделок.** `OnNewMyTrade` пересчитывает прирост PnL, чтобы `LastTradeProfit` отражал последнюю сделку.
5. **Опциональное логирование.** При активном `LogOnEveryUpdate` каждое обновление выводит строку вида `Snapshot 2024-03-25T10:15:00Z: close=1.1234; orders=2; account=10025.50; last trade=15.20; total pnl=120.85.`

## Рекомендации по интеграции
- Привяжите свойства стратегии к интерфейсу WPF/WinForms или к пользовательским индикаторам на графике, чтобы получить оригинальный эффект «график рядом с графиком» без DLL.
- Запускайте помощник вместе с другими торговыми стратегиями на одном коннекторе и портфеле — он не отправляет заявки и не мешает боевым алгоритмам.
- Подбирайте `CandleType` под частоту обновления интерфейса: чем ниже таймфрейм, тем оперативнее обновления, но тем больше свечей нужно обрабатывать.
- Включайте логирование временно — для наладки, аудита или экспорта телеметрии во внешние системы.

## Особенности конвертации
- Индексы разделяемой памяти (`IND`, `IND+1`, `IND+2`) заменены на строго типизированные свойства, что устраняет ручное управление смещениями.
- Прибыль ордера вычисляется через разницу суммарного PnL — это позволяет получить аналог `OrderProfit()` без перебора сделок.
- Торговая логика не добавлялась: стратегия остаётся вспомогательным модулем мониторинга, как и исходный советник.

