# Chart Plus Chart 监控策略
[English](README.md) | [Русский](README_ru.md)

## 概述
该策略是将 MetaTrader 助手 *ChartPlusChartV2*（`Chart1.mq4` 与 `Chart2.mq4`）迁移到 StockSharp 的结果。原始 MQL 脚本并不会直接下单，而是收集账户的几个关键指标（最新收盘价、当前挂单数量、账户余额、所选订单的利润），然后通过 DLL `SharedVarsDLLv2.dll` 提供给多个图表共享显示。C# 版本沿用了这一理念：每次市场更新都会生成一份统计快照，可用于自定义面板、图表附加区域或外部监控工具。

与依赖 Windows DLL 的 MQL 方案不同，移植版直接利用 `Strategy` 基类提供的能力，通过只读属性公开数据，并在需要时写入日志，因而跨平台且部署更简单。

## 主要特点
- **集中式账户遥测。** 策略持续保存最新收盘价、有效订单数量、投资组合价值以及最近一笔成交的利润，方便界面或脚本使用。
- **事件驱动刷新。** 快照在每根完成的 K 线、任意订单状态变化以及成交回报时更新，重现原脚本“每个 tick 更新一次”的频率。
- **可选的详细日志。** 一个可配置的选项用于把快照写入日志，模拟通过 DLL 广播数据的行为。
- **安全的组合估值。** 当经纪商尚未提供实时组合价值时，策略会使用初始余额作为兜底，避免出现误导性的零值。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CandleType` | `TimeSpan.FromMinutes(1).TimeFrame()` | 用于生成蜡烛的时间框架。每根完结的蜡烛都会刷新快照，并提供与 MQL 中 `Close[0]` 等价的收盘价。 |
| `LogOnEveryUpdate` | `false` | 若开启，则每次刷新都会写入日志，方便调试或外部监控。 |

## 输出属性
- `LastClosePrice` – 最近一根完成蜡烛的收盘价。
- `OpenOrdersCount` – 当前活动订单数量（`ActiveOrders.Count`），等价于 `OrdersTotal()`。
- `AccountValue` – 投资组合的当前价值；若暂不可用，则返回初始余额。
- `LastTradeProfit` – 最近一次成交带来的已实现盈亏增量。
- `LastSnapshotTime` – 上次刷新快照的时间戳，便于检测数据是否过期。

## 工作流程
1. **启动。** 在 `OnStarted` 中订阅指定时间框架的蜡烛，记录当前 PnL 并立即发布初始快照。
2. **蜡烛更新。** 每根完成的蜡烛都会更新收盘价并重新计算全部统计值，对应 MQL 中每个 tick 写入共享内存的逻辑。
3. **订单变动。** 通过重写 `OnOrderChanged`，即使没有新蜡烛也能保持订单数量的准确性。
4. **成交回报。** `OnNewMyTrade` 重新计算总 PnL 的增量，从而获得最近一笔成交的利润。
5. **可选日志。** 当开启 `LogOnEveryUpdate` 时，每次刷新都会记录类似 `Snapshot 2024-03-25T10:15:00Z: close=1.1234; orders=2; account=10025.50; last trade=15.20; total pnl=120.85.` 的文本。

## 集成建议
- 可以把这些属性绑定到 WPF/WinForms 等界面控件，或绘制到图表的辅助区域，实现无需 DLL 的“图表叠图”效果。
- 与其他交易策略共存时，只需确保连接同一个组合即可；本策略不会下单，因此不会干扰真实交易流程。
- 根据界面需要调整 `CandleType`，较小的时间框架能提供更及时的刷新，但会带来更多行情数据。
- 仅在调试或导出监控数据时临时启用日志功能，以免生产环境日志过大。

## 转换细节
- MQL 中的共享内存索引（`IND`、`IND+1`、`IND+2`）全部替换为强类型属性，省去了手动管理偏移量的麻烦。
- 订单利润通过总 PnL 的差值计算，无需遍历历史成交即可得到 `OrderProfit()` 的效果。
- 本次迁移未加入任何新的交易逻辑，保持其作为监控工具的原始定位。

