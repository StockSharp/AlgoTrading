# Dual Lot Step Hedge 策略

## 概述

**Dual Lot Step Hedge** 策略是 MetaTrader 5 专家顾问 *“x1 lot from high to low”* 和 *“x1 lot from low to high”*（目录 `MQL/19543`）的 C# 版本。原始程序会立即同时开多单和空单，按照预设的步进方式调整手数，并在达到固定收益目标时一次性平掉所有仓位。本实现基于 StockSharp 的高级 API，完整复刻这一流程，并提供清晰的参数与状态控制。

策略提供两种运行模式：

- **HighToLow**：以最大手数乘数启动，首轮对冲仓位使用最大量，之后每次新建仓位时手数减少一个步长。
- **LowToHigh**：以最小手数步长启动，每次新建仓位时手数增加一个步长，直到达到乘数上限，此后保持该手数。

策略会始终维持多空双腿，分别计算止损和止盈，并通过监控账户权益在达到盈利目标时关闭整套仓位。

## 交易逻辑

1. 当没有持仓时，同时以当前手数开多单和空单（市价单）。
2. 若仅有其中一条腿持仓（例如另一条腿被止损），则立即以当前手数补齐缺失的一条腿。
3. 每次成功建仓后，根据所选模式更新手数。
4. 在每个成交（tick）到来时检查保护条件：
   - 多单价格跌破平均建仓价减去 `StopLossPips`（以点为单位）时止损，或上涨超过平均价加上 `TakeProfitPips` 时止盈。
   - 空单价格上破平均建仓价加上 `StopLossPips` 时止损，或下破平均价减去 `TakeProfitPips` 时止盈。
5. 当账户权益增量超过 `MinProfit` 时，平掉全部仓位并将手数恢复到模式对应的起始值。
6. 若意外检测到同方向存在多个持仓，策略会立即平仓并重置状态，以保持与原策略一致的“一腿最多一单”约束。

所有委托均通过 `BuyMarket` 与 `SellMarket` 方法下单。`OnOwnTradeReceived` 用于跟踪成交，维护每条腿的累计仓位，并在有未完成的开仓或平仓订单时阻止重复下单。

## 参数说明

| 参数 | 说明 |
|------|------|
| `LotMultiplier` | 最大手数乘数，按最小交易量的整数倍表示（默认 `10`）。 |
| `StopLossPips` | 单腿止损距离，单位为点（默认 `50`，设为 `0` 关闭止损）。 |
| `TakeProfitPips` | 单腿止盈距离，单位为点（默认 `150`，设为 `0` 关闭止盈）。 |
| `MinProfit` | 账户货币计价的总利润目标，达到后平掉全部仓位（默认 `27`）。 |
| `ScalingMode` | 手数调整模式：`HighToLow` 对应“x1 lot from high to low”，`LowToHigh` 对应“x1 lot from low to high”。 |

策略会自动读取 `Security.VolumeStep` 作为最小交易量，并根据价格步长自动换算点值（对 3/5 位小数的外汇品种自动乘以 10）。

## 手数循环

- **HighToLow**：首轮对冲使用最大手数（`VolumeStep * LotMultiplier`）。每次建仓后手数减一档。在达到利润目标并清仓后，将手数重置为 `0`，下一轮从最大手数重新开始。
- **LowToHigh**：从最小手数开始，每次建仓后增加一个步长，直到达到乘数上限。利润目标达成后手数重置为最小步长。

## 使用建议

- 策略订阅的是逐笔成交（`DataType.Ticks`），需要确保历史或实时数据源能提供 tick 数据。
- 止损和止盈在策略内部判断，不会额外向交易所发送保护性委托。
- 由于同时开多与开空，适用于支持对冲仓位、点差较小的券商。在净额制度账户上也能运行，但多空腿会互相抵消，直到其中一条腿因策略逻辑被关闭。
- 默认参数与原 MQL 程序一致。实际使用时请结合标的波动性谨慎调整，大手数对冲策略可能在触及盈利目标前经历较大回撤。

## 与 MQL 原版的对应关系

| MQL 变量 | C# 中的实现 |
|----------|-------------|
| `InpLots` | `LotMultiplier`，自动处理最小交易步长。 |
| `InpStopLoss` 与 `InpTakeProfit` | `StopLossPips` 与 `TakeProfitPips`，按价格步长转换为实际价差。 |
| `InpMinProfit` | `MinProfit` 与权益增量检查。 |
| `LotCheck` | `LotCheck` 辅助函数，保证手数满足最小步长并不超过最大限制。 |
| `CalculatePositions` | 通过 `OnOwnTradeReceived` 维护多腿仓位数量。 |
| `CloseAllPositions()` | `CloseAllPositions` 方法，负责协调平仓订单并在平仓后复位状态。 |

## 风险提示

策略刻意保持多空双腿，意味着持续承担点差与隔夜利息成本。实盘前请务必：

- 在 StockSharp 模拟器或模拟账户中充分测试。
- 确认经纪商允许对冲仓位，否则多空单会立即被净额抵消。
- 根据标的波动性合理设置止损、止盈和利润目标。
- 监控保证金占用，多空同时持有会导致名义敞口翻倍。

## 文件列表

- `CS/DualLotStepHedgeStrategy.cs` — 策略代码，包含详细英文注释。
- `README.md` — 英文文档。
- `README_ru.md` — 俄文文档。
