# Стратегия Dual Lot Step Hedge

## Обзор

**Dual Lot Step Hedge** — это порт MetaTrader 5 советников *«x1 lot from high to low»* и *«x1 lot from low to high»* (каталог `MQL/19543`) на язык C#. Оригинальные роботы мгновенно открывают хеджевую корзину из покупок и продаж, изменяют объём заявки после каждого нового входа и закрывают корзину при достижении целевой прибыли. Реализация на StockSharp повторяет эту логику с использованием высокоуровневого API и предоставляет понятные параметры и расширенное управление состоянием.

Поддерживаются два режима работы:

- **HighToLow** — старт с максимального множителя лота, первая корзина открывается на наибольший объём, после чего объём снижается на один шаг.
- **LowToHigh** — старт с минимального шага лота, объём увеличивается после каждого входа до достижения настроенного множителя, затем фиксируется на этом уровне.

Стратегия одновременно поддерживает обе ноги (лонг и шорт), рассчитывает стоп-лосс/тейк-профит для каждой ноги и отслеживает совокупную прибыль по портфелю, чтобы закрыть корзину при достижении цели.

## Логика торговли

1. При отсутствии позиций стратегия открывает **одновременно** рыночные покупки и продажи текущим объёмом.
2. Если активна только одна нога (например, противоположная закрылась по стопу), недостающая нога немедленно восстанавливается рыночным ордером с текущим объёмом.
3. После каждого успешного входа объём обновляется в зависимости от выбранного режима (`HighToLow` или `LowToHigh`).
4. Защитные уровни проверяются на каждом тиковом событии:
   - Лонг закрывается при достижении стоп-лосса (`StopLossPips` ниже средней цены входа) или тейк-профита (`TakeProfitPips` выше средней цены входа).
   - Шорт закрывается при достижении стоп-лосса (`StopLossPips` выше средней цены входа) или тейк-профита (`TakeProfitPips` ниже средней цены входа).
5. При превышении прироста капитала над `MinProfit` стратегия закрывает обе ноги и сбрасывает объём к стартовому значению режима.
6. Дополнительная проверка закрывает корзину и делает полный сброс, если неожиданно обнаружено более одной позиции в каждом направлении.

Заказы отправляются через методы `BuyMarket` и `SellMarket`. Заполнение отслеживается в `OnOwnTradeReceived`, хранится агрегированная экспозиция по каждой ноге и блокируется дублирование, пока выполняются заявки на вход или выход.

## Параметры

| Параметр | Описание |
|----------|----------|
| `LotMultiplier` | Максимальный множитель лота в шагах минимального объёма (по умолчанию `10`). |
| `StopLossPips` | Дистанция стоп-лосса в пипсах для каждой ноги (по умолчанию `50`). Значение `0` отключает стоп. |
| `TakeProfitPips` | Дистанция тейк-профита в пипсах для каждой ноги (по умолчанию `150`). Значение `0` отключает тейк. |
| `MinProfit` | Целевая прибыль корзины в валюте счёта. После превышения этого значения позиции закрываются (по умолчанию `27`). |
| `ScalingMode` | Поведение изменения объёма. `HighToLow` повторяет советник «x1 lot from high to low», `LowToHigh` — «x1 lot from low to high». |

Минимальный шаг объёма определяется автоматически из `Security.VolumeStep`, а стоимость пипса вычисляется по `PriceStep` с поправкой на 3/5-значные котировки.

## Циклическое изменение объёма

- **HighToLow** — первая корзина открывается максимальным объёмом (`VolumeStep * LotMultiplier`). После любого входа объём уменьшается на один шаг. После фиксации прибыли объём сбрасывается в `0`, чтобы следующий цикл снова начался с максимума.
- **LowToHigh** — старт с минимального шага. После каждого входа объём увеличивается на шаг до потолка множителя. После фиксации прибыли объём сбрасывается к минимальному шагу.

## Практические рекомендации

- Подписка ведётся на тиковые сделки (`DataType.Ticks`), т. к. оригинальные роботы работают по каждому тику. Настройте поставщик истории или коннектор соответствующим образом.
- Стоп-лосс и тейк-профит рассчитываются внутри алгоритма, дополнительные защитные заявки на биржу не выставляются.
- Поскольку обе ноги открываются по рынку, стратегия максимально эффективна у брокеров с поддержкой хеджирования и низким спредом. На неттинговых площадках ноги будут взаимно компенсироваться до тех пор, пока одна не закроется по внутренней логике.
- Значения по умолчанию соответствуют исходным MQL-настройкам. Изменяйте их аккуратно: крупные хеджевые объёмы могут вызвать значительные просадки до достижения целевой прибыли.

## Соответствие оригиналу MQL

| Переменная MT5 | Связь в C# |
|----------------|-----------|
| `InpLots` | Параметр `LotMultiplier` с автоматикой по шагу объёма. |
| `InpStopLoss` и `InpTakeProfit` | Параметры `StopLossPips` и `TakeProfitPips` с преобразованием пипсов. |
| `InpMinProfit` | Параметр `MinProfit` и проверка прироста капитала. |
| `LotCheck` | Метод `LotCheck`, ограничивающий шаг и максимум. |
| `CalculatePositions` | Учёт лонгов и шортов через `OnOwnTradeReceived`. |
| `CloseAllPositions()` | Метод `CloseAllPositions` с координацией заявок и сбросом состояния. |

## Управление рисками

Стратегия специально удерживает противоположные позиции, что приводит к постоянным издержкам на спред и своп. Перед запуском на реальном счёте:

- Протестируйте алгоритм в эмуляторе StockSharp или на демо-счёте.
- Убедитесь, что брокер поддерживает хеджирование. На неттинговых счетах позиции будут схлопываться.
- Настройте стопы, тейки и целевую прибыль согласно волатильности инструмента.
- Контролируйте нагрузку по марже: одновременные лонг и шорт удваивают номинальную позицию.

## Файлы

- `CS/DualLotStepHedgeStrategy.cs` — реализация стратегии с подробными комментариями.
- `README.md` — версия описания на английском языке.
- `README_cn.md` — версия описания на китайском языке.
