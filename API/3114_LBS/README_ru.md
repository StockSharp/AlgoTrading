# Стратегия LBS

**LBS** — портированная на StockSharp версия советника MetaTrader 5 «LBS (barabashkakvn's edition)». Алгоритм отслеживает закрытие свечей нужного таймфрейма и в выбранные часы выставляет отложенные стоп-заявки на пробой максимумов и минимумов. Перенос выполнен с использованием высокоуровневого API (подписки на свечи и стакан, методы `BuyStop`/`SellStop`), что упрощает сопровождение и сохраняет логику исходного робота.

## Логика торговли

1. Стратегия анализирует завершённые свечи типа `CandleType`.
2. Когда время закрытия свечи совпадает с одним из активных торговых часов (`Hour1`, `Hour2`, `Hour3`), вычисляются уровни пробоя:
   - Заявка Buy Stop выставляется на максимуме свечи либо на текущем ask плюс буфер «заморозки» — выбирается большее значение.
   - Заявка Sell Stop выставляется на минимуме свечи либо на текущем bid минус буфер «заморозки» — выбирается меньшее значение.
   - Буфер копирует поведение MetaTrader: берётся утроенный спред, но не менее десяти пунктов.
3. После срабатывания одной из заявок противоположная немедленно отменяется, как и в функции `DeleteAllPendingOrders` оригинала.
4. Стоп-лосс задаётся параметром `StopLossPips`. При наличии `TrailingStopPips` и `TrailingStepPips` стоп автоматически подтягивается, когда плавающая прибыль превышает сумму этих значений.
5. Сделки отправляются только при наличии рыночных котировок, отсутствии открытых позиций и активном состоянии стратегии.

## Управление риском

Переключатель `MoneyMode` воспроизводит режим «лот/риск» исходного эксперта:

- **FixedLot** — `VolumeOrRisk` трактуется как фиксированный торговый объём.
- **RiskPercent** — `VolumeOrRisk` интерпретируется как процент от стоимости портфеля. Сумма риска делится на расстояние от входа до стоп-лосса (в шагах цены), что даёт объём позиции. Если стоп-лосс отключён, заявка в этом режиме не будет отправлена.

Перед размещением объём нормализуется по минимальному лоту, шагу и лимиту инструмента, чтобы избежать отказов брокера.

## Параметры

| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `StopLossPips` | 50 | Расстояние до стоп-лосса в пунктах. Ноль отключает стоп и трейлинг. |
| `TrailingStopPips` | 5 | Дистанция трейлинг-стопа в пунктах. Ноль отключает подтягивание. |
| `TrailingStepPips` | 15 | Дополнительная прибыль (в пунктах), необходимая для переноса стопа. При включённом трейлинге должна быть > 0. |
| `MoneyMode` | `FixedLot` | Режим расчёта объёма: фиксированный лот либо процент от капитала. |
| `VolumeOrRisk` | 1.0 | Лот в режиме `FixedLot` либо процент риска в режиме `RiskPercent`. |
| `Hour1` | 10 | Первый торговый час. Значение `0` отключает запуск. |
| `Hour2` | 11 | Второй торговый час. Значение `0` отключает запуск. |
| `Hour3` | 12 | Третий торговый час. Значение `0` отключает запуск. |
| `CandleType` | 1 час | Таймфрейм свечей, по которым строятся уровни пробоя. Настройте под используемый график. |

## Особенности реализации

- Сравнение времени выполняется по моменту закрытия свечи — это соответствует моменту, когда в MetaTrader вызывается `TimeCurrent()` в начале следующего бара.
- Буфер заморозки и минимальный уровень стопа не опускаются ниже десяти пунктов, что предотвращает ошибки, связанные с ограничениями брокера.
- Трейлинг обновляется на каждом тиковом событии Level1, поэтому поведение близко к обработчику `OnTick` в оригинальном советнике.
- При расчёте риска используется `Portfolio.CurrentValue`, при его отсутствии — `Portfolio.BeginValue`.

## Рекомендации по использованию

1. Выберите инструмент и таймфрейм, соответствующие настройкам в MetaTrader.
2. Укажите часы, в которые необходимо выставлять отложенные ордера (значение `0` отключает конкретный час).
3. Для динамического объёма переключите `MoneyMode` в `RiskPercent` и задайте положительный `StopLossPips`.
4. При торговле фиксированным лотом оставьте режим `FixedLot` и задайте `VolumeOrRisk` равным нужному объёму.
5. Запустите стратегию — при наступлении следующего активного часа будут выставлены две стоп-заявки, а защитный стоп будет сопровождаться автоматически.
