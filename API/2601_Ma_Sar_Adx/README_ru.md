# Стратегия Ma SAR ADX

## Общее описание
Стратегия представляет собой перенос эксперта **MaSarADX.mq5** из MetaTrader 5 на высокоуровневый API StockSharp. Логика сочетает фильтр по простой скользящей средней, направление индекса направленного движения (ADX) и индикатор Parabolic SAR в роли динамического стопа и разворота. Проверка сигналов выполняется только после закрытия свечи, что полностью повторяет поведение оригинального советника, работавшего на первом тике нового бара.

## Используемые индикаторы и данные
- **Простая скользящая средняя (SMA)** — определяет глобальное направление тренда, период по умолчанию 100.
- **Average Directional Index (ADX)** — формирует значения +DI и −DI для оценки преобладания быков или медведей, период по умолчанию 14.
- **Parabolic SAR** — задаёт линию стопа и критерий закрытия сделок, стартовая и инкрементальная ускорения 0.02, максимальное ускорение 0.10.
- **Свечи** — стратегия по умолчанию подписывается на часовые свечи, но параметр можно изменить на любой таймфрейм.

Свечная подписка и индикаторы связаны через `BindEx`, благодаря чему на каждую обработку поступают синхронизированные значения SMA, ADX и SAR для одной и той же свечи без ручного буферизования.

## Торговые правила
### Условия для покупки
1. Цена закрытия свечи выше скользящей средней.
2. Значение +DI не меньше −DI (преимущество быков).
3. Цена закрытия выше значения Parabolic SAR.
4. Открытых длинных позиций нет (`Position <= 0`).

При выполнении условий отправляется рыночная заявка Buy на объём `Volume + |Position|`, что позволяет закрыть возможный короткий остаток и открыть новую длинную позицию.

### Условия для продажи
1. Цена закрытия свечи ниже скользящей средней.
2. Значение +DI не больше −DI (преимущество медведей).
3. Цена закрытия ниже Parabolic SAR.
4. Нет открытых коротких позиций (`Position >= 0`).

Когда условия соблюдены, отправляется рыночная заявка Sell на базовый объём плюс абсолютное значение текущей позиции.

### Правила выхода
- **Для лонга**: если цена опускается ниже Parabolic SAR, позиция немедленно закрывается по рынку.
- **Для шорта**: если цена поднимается выше Parabolic SAR, происходит немедленное закрытие.

Дополнительных стоп-лоссов и тейк-профитов не задаётся — выход определяется только пересечением SAR, как и в оригинальном советнике. Поскольку выход проверяется до открытия новых сделок, стратегия не разворачивается мгновенно в рамках одной свечи.

## Параметры
| Параметр | Назначение | Значение по умолчанию | Примечания |
| --- | --- | --- | --- |
| `MaPeriod` | Период SMA для фильтра тренда. | 100 | Может оптимизироваться, > 0. |
| `AdxPeriod` | Период расчёта ADX и его компонент +DI/−DI. | 14 | Может оптимизироваться, > 0. |
| `SarStep` | Шаг ускорения Parabolic SAR. | 0.02 | Аналог параметра `step` в MQL. |
| `SarMax` | Максимальное ускорение Parabolic SAR. | 0.10 | Соответствует параметру `maximum` в MQL. |
| `Volume` | Базовый объём для входа. | 1 | Замена расчёту лота по риску. Фактический объём: `Volume + |Position|`. |
| `CandleType` | Тип запрашиваемых свечей. | 1 час | Можно выбрать любой таймфрейм. |

## Особенности реализации
- Используется высокоуровневая связка `BindEx`, поэтому индикаторы получают данные без ручного доступа к буферам.
- Выход из позиции выполняется даже при временном запрете торговли (`AllowTrading = false`), чтобы не оставлять открытые позиции без контроля.
- В код добавлено построение графиков: на основном окне отображаются свечи, SMA и SAR, на дополнительном — ADX.
- Журналирование подробно описывает каждое действие стратегии и значения индикаторов, что облегчает анализ тестов и работы на бою.

## Рекомендации по применению
1. Привяжите стратегию к нужному инструменту и портфелю в Designer либо Backtester.
2. Настройте `CandleType` под требуемый таймфрейм (например, M15, H1, D1).
3. Подберите значения `MaPeriod`, `AdxPeriod`, `SarStep` и `SarMax` в соответствии с волатильностью актива.
4. Установите `Volume`, исходя из собственной системы риск-менеджмента. Если требуется динамический расчёт объёма, реализуйте его до вызова методов отправки заявок.
5. Запустите стратегию и дождитесь формирования всех индикаторов — до этого момента торговые сигналы не исполняются.

## Отличия от оригинального эксперта
- Динамический расчёт лота по свободной марже заменён фиксированным параметром `Volume`, что делает стратегию независимой от брокерской инфраструктуры.
- Порядок проверки сигналов (сначала закрытие, потом открытие) полностью сохранён.
- Все комментарии в исходном коде приведены на английском языке согласно регламенту проекта.
