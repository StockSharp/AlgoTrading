# Стратегия Exp X2MA Candle MM Recovery

## Общее описание
Данный алгоритм — порт эксперта **Exp_X2MACandle_MMRec** с платформы MetaTrader на C#. Логика построена на наблюдении за цветом свечи, полученной после двойного сглаживания исходных OHLC-данных индикатором X2MA. Цветовые переходы определяют моменты открытия и закрытия позиций, а блок риск-менеджмента уменьшает рабочий объём после серии убыточных сделок.

Стратегия обрабатывает только завершённые свечи. Для выбранного таймфрейма формируются две последовательные скользящие средние (методы и длины каждой ступени задаются параметрами). На основе сглаженных значений рассчитывается «цвет» свечи: зелёный (код `2`), красный (`0`) или нейтральный (`1`). Сигналы формируются по окончании свечи, расположенной на смещении `SignalBar + 1`, чтобы предотвратить повторные входы при текущем изменении цвета.

## Логика индикатора
1. Все четыре компоненты свечи (Open, High, Low, Close) проходят через две ступени сглаживания.
2. Методы сглаживания сопоставлены со встроенными индикаторами StockSharp:
   - `Simple` → `SimpleMovingAverage`;
   - `Exponential` → `ExponentialMovingAverage`;
   - `Smoothed` → `SmoothedMovingAverage` (RMA);
   - `Weighted` → `WeightedMovingAverage`;
   - `Jurik` → `JurikMovingAverage` (при наличии свойства Phase параметр учитывается).
3. Если модуль разницы между сглаженными Open и Close меньше `GapPoints * StepPrice`, тело свечи приравнивается к предыдущему закрытию.
4. Цвет определяется сравнением сглажённых Open и Close.
5. Бар для оценки сигналов задаётся параметром `SignalBar`, что соответствует использованию истории в MetaTrader.

## Управление объёмом
- Оригинальный эксперт анализировал историю сделок через сервис MetaTrader. В StockSharp прямой доступ к этой статистике отсутствует, поэтому используется внутренняя очередь из последних закрытых сделок.
- Размер очереди задаётся параметром `HistoryDepth`. Как только количество убытков в окне достигает `LossTrigger`, объём следующей сделки уменьшаетcя до `ReducedVolume`.
- Для определения результата сделки используется цена закрытия свечи, по сигналу которой позиция была ликвидирована. Автоматические стопы и тейк-профиты из MQL-версии не переносятся — при необходимости добавьте собственные правила (например, через `StartProtection`).

## Параметры
| Имя | Описание |
|-----|----------|
| `CandleType` | Таймфрейм свечей для расчётов. |
| `FirstMethod`, `FirstLength`, `FirstPhase` | Метод, длина и фаза первой ступени сглаживания. |
| `SecondMethod`, `SecondLength`, `SecondPhase` | Метод, длина и фаза второй ступени. |
| `GapPoints` | Порог выравнивания тела свечи в шагах цены инструмента. |
| `SignalBar` | Смещение по истории (0 — последняя завершённая свеча). |
| `AllowLongEntry` / `AllowShortEntry` | Разрешение на открытие длинных/коротких позиций. |
| `AllowLongExit` / `AllowShortExit` | Разрешение на закрытие длинных/коротких позиций. |
| `NormalVolume` | Базовый торговый объём. |
| `ReducedVolume` | Объём после серии убытков. |
| `HistoryDepth` | Глубина истории для учёта убытков (0 — отключить). |
| `LossTrigger` | Количество убытков в окне, при котором включается уменьшенный объём (0 — отключить). |

## Практические замечания
- Стратегия работает с единственным инструментом, возвращаемым `GetWorkingSecurities()`.
- Обработка происходит один раз на завершённой свече, поэтому повторные заявки исключены.
- Чтобы деактивировать снижение объёма, установите `ReducedVolume`, равный `NormalVolume`, либо обнулите `LossTrigger`.
- Из-за использования цен закрытия свечевая оценка убытков может отличаться от MetaTrader, особенно при проскальзываниях или частичном исполнении. При необходимости скорректируйте параметры.
- Для реализации стоп-лоссов и тейк-профитов воспользуйтесь механизмами риск-менеджмента StockSharp.
