# Стратегия Envelope Limit Ladder

**Envelope Limit Ladder Strategy** — порт эксперта MetaTrader `E_2_12_5min.mq4` (ID 7671) на платформу StockSharp. Стратегия воссоздаёт лестницу отложенных лимитных ордеров вокруг конверта EMA на пятиминутных свечах и сохраняет оригинальную схему из трёх тейк-профитов и трейлинг-стопа.

## Идея

1. **Фильтр-конверт.** Рассчитывается конверт скользящей средней (по умолчанию EMA 144 с отклонением 0,05%) на таймфрейме `EnvelopeCandleType`. Он задаёт среднюю линию и границы.
2. **Сигнальная свеча.** Анализ ведётся по подписке `CandleType` (по умолчанию 5 минут). Когда предыдущая свеча закрывается между средней линией и ближайшей границей, стратегия выставляет лимитные заявки по средней.
3. **Лестница ордеров.** Одновременно размещаются до трёх заявок Buy Limit и трёх Sell Limit:
   - Цена входа — выровненное значение средней линии.
   - Стоп-лосс — противоположная граница конверта.
   - Тейк-профит — граница ± пользовательские отступы (8, 13 и 21 пункт по умолчанию).
4. **Торговое окно.** Заявки появляются только при выполнении условия `TradingStartHour < Hour < TradingEndHour`. Когда час открытия достигает `TradingEndHour`, все невыполненные лимиты удаляются.
5. **Сопровождение позиций.** Каждая исполненная заявка получает собственные ордера стоп-лосс/тейк-профит. Дополнительно можно включить перенос стопа на скользящую среднюю (или оставить на противоположной границе) после прорыва за конверт.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CandleType` | 5 минут | Таймфрейм для поиска сигналов. |
| `EnvelopeCandleType` | 5 минут | Таймфрейм для расчёта конверта (аналог MT4 `EnvTimeFrame`). |
| `EnvelopePeriod` | 144 | Период скользящей средней. |
| `MaMethod` | EMA | Метод скользящей (`SMA`, `EMA`, `SMMA`, `LWMA`). |
| `EnvelopeDeviation` | 0.05 | Ширина конверта в процентах (0.05 = 0.05%). |
| `TradingStartHour` | 0 | Первый час, когда допускается постановка ордеров (жёсткое неравенство, как в MT4). |
| `TradingEndHour` | 17 | Час, после которого лимиты удаляются. |
| `FirstTakeProfitPoints` | 8 | Отступ для первого тейк-профита в пунктах. |
| `SecondTakeProfitPoints` | 13 | Отступ для второго тейк-профита. |
| `ThirdTakeProfitPoints` | 21 | Отступ для третьего тейк-профита. |
| `UseOppositeEnvelopeTrailing` | `true` | Использовать противоположную границу для трейлинга (`true`) или переносить стоп на среднюю (`false`). Соответствует флагу MT4 `MaElineTSL`. |
| `OrderVolume` | 0.1 | Объём каждой отложенной заявки (вместо функции `LotsOptimized`). |

## Особенности поведения

- Для каждой заполненной заявки создаётся отдельная пара стоп/тейк — закрытие одной ступени не влияет на остальные.
- Трейлинг включается только после выхода цены за границу конверта и срабатывает строго в сторону прибыли.
- При различии `EnvelopeCandleType` и `CandleType` стратегия использует последнюю рассчитанную величину конверта с дополнительной подписки, что повторяет обращение к старшему таймфрейму в MT4.
- Адаптивное управление объёмом из исходного советника заменено явным параметром `OrderVolume`, что делает поведение стратегии детерминированным.

## Рекомендации

- Подбирайте таймфрейм конверта в соответствии с настройками оригинального эксперта (5 минут, 1 час и т. д.).
- Установите `UseOppositeEnvelopeTrailing = false`, если хотите переносить стоп на среднюю линию после прорыва.
- Оптимизируйте ширину конверта и расстояния тейк-профитов совместно — ступени лестницы зависят от текущей волатильности инструмента.
