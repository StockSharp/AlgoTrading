# Divergence + EMA + RSI Close Buy Only

## Обзор

Стратегия переносит советник MetaTrader «Divergence + ema + rsi close buy only» на высокоуровневый API StockSharp. Основная торговля ведётся на **5-минутных свечах**, а фильтры опираются на данные **H1** и **D1**. Все сделки — только на покупку. Вход формируется при наличии бычьей дивергенции MACD, подтверждённой пересечением стохастика на часовом графике в зоне перепроданности и восходящей структурой EMA на дневном таймфрейме. Выход реализуется через достижение заданного уровня RSI либо за счёт защитных уровней `StartProtection`.

## Логика торговли

1. **Фильтр тренда по дневным EMA**
   - EMA(9) на D1 должна быть выше EMA(20), что подтверждает восходящий тренд.
   - Текущая закрытая 5-минутная свеча должна находиться ниже EMA(9) на D1 — стратегия ищет вход «из отката».

2. **Подтверждение стохастиком на H1**
   - Последнее завершённое значение %K должно лежать между `StochasticLowerBound` (по умолчанию 0) и `StochasticUpperBound` (по умолчанию 40).
   - На предыдущем часовом баре %K должен пересечь %D снизу вверх (текущее %K > %D при условии, что предыдущее %K ≤ %D).

3. **Триггер дивергенции MACD (M5)**
   - Гистограмма MACD (разность линии MACD и сигнальной линии) должна увеличиться как минимум на `MacdThreshold`, а закрытие 5-минутной свечи сформировать более низкий минимум относительно предыдущей свечи.

4. **Исполнение входа**
   - При выполнении всех фильтров и отсутствии открытой длинной позиции стратегия выставляет рыночную заявку на покупку. Если неожиданно присутствует короткая позиция, объём заявки увеличивается для её закрытия и открытия лонга.

5. **Правила выхода**
   - Длинная позиция закрывается, когда RSI на M5 поднимается выше `RsiExitLevel` (77 по умолчанию).
   - При положительных значениях `StopLossPips` и `TakeProfitPips` активируется `StartProtection`, который переводит значения из пунктов в ценовое расстояние и сопровождает позицию.

6. **Управление ордерами**
   - Перед отправкой нового рыночного ордера снимаются все активные заявки, чтобы избежать дублирования.
   - Рабочий объём задаётся параметром `TradeVolume` и может оптимизироваться.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Основной таймфрейм для расчётов MACD, RSI и сделок. | 5 минут |
| `HourTimeFrame` | Таймфрейм стохастика. | 1 час |
| `DayTimeFrame` | Таймфрейм EMA фильтра тренда. | 1 день |
| `MacdFastPeriod` / `MacdSlowPeriod` / `MacdSignalPeriod` | Настройка MACD на M5. | 6 / 13 / 5 |
| `MacdThreshold` | Минимальный прирост гистограммы для фиксации дивергенции. | 0.0003 |
| `DailyFastPeriod` / `DailySlowPeriod` | Периоды EMA на D1. | 9 / 20 |
| `StochasticKPeriod` / `StochasticDPeriod` / `StochasticSlowing` | Конфигурация стохастика на H1. | 30 / 5 / 9 |
| `StochasticUpperBound` / `StochasticLowerBound` | Допустимый диапазон %K. | 40 / 0 |
| `RsiPeriod` | Период RSI на M5. | 7 |
| `RsiExitLevel` | Значение RSI, при котором позиция закрывается. | 77 |
| `TradeVolume` | Базовый объём ордеров. | 0.01 |
| `StopLossPips` | Стоп-лосс в пунктах (0 отключает). | 100 |
| `TakeProfitPips` | Тейк-профит в пунктах (0 отключает). | 200 |

## Примечания

- Подписка осуществляется на три потока: основной таймфрейм, часовой и дневной. Каждый поток связан со своими индикаторами через `Bind`/`BindEx`.
- Обрабатываются только завершённые свечи, что соответствует использованию смещения (`shift`) в исходном MQL.
- Проверка дивергенции MACD повторяет поведение конструктора fxDreema: текущая свеча сравнивается с предыдущей по цене закрытия и значению гистограммы.
- Управление защитными ордерами делегировано `StartProtection`, поэтому стратегия корректно работает как в тестах, так и в онлайне без отдельного сопровождения стопов и тейков.
