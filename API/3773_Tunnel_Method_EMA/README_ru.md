# Стратегия Tunnel Method EMA
[English](README.md) | [中文](README_zh.md)

## Обзор
**Tunnel Method EMA** — портирование оригинального советника MetaTrader «Tunnel Method» на высокоуровневый API StockSharp. Стратегия работает на часовом таймфрейме и использует три экспоненциальные скользящие средние (EMA), рассчитанные по цене закрытия:

- **Быстрая EMA (12 периодов)** фиксирует краткосрочные изменения импульса.
- **Средняя EMA (144 периода)** формирует «туннель», относительно которого подтверждаются шорты.
- **Медленная EMA (169 периодов)** задаёт основной тренд и используется для фильтрации лонгов.

В каждый момент времени стратегия может иметь только одну позицию (лонг или шорт) и управляет риском при помощи стоп-лосса, тейк-профита и трейлинг-стопа.

## Логика сигналов
### Вход в лонг
1. Дождаться закрытия свечи (никаких внутрисвечных решений).
2. Зафиксировать пересечение: быстрая EMA (12) переходит снизу вверх через медленную EMA (169).
3. Если позиций нет, отправить рыночную покупку на заданный объём.

### Вход в шорт
1. Дождаться закрытия свечи.
2. Зафиксировать пересечение: быстрая EMA (12) переходит сверху вниз через среднюю EMA (144).
3. Если позиций нет, отправить рыночную продажу.

### Управление позицией
- **Стоп-лосс**: позиция закрывается при движении цены против трейдера на `StopLossPoints` (значение переводится в абсолютную цену через шаг цены инструмента).
- **Тейк-профит**: фиксация прибыли при достижении `TakeProfitPoints` от цены входа.
- **Трейлинг-стоп**: после накопления прибыли не менее `TrailingTriggerPoints` стоп подтягивается на расстоянии `TrailingStopPoints`. Для лонга используется максимальный хай с момента входа, для шорта — минимальный лоу. Возврат к трейлингу закрывает позицию.
- **Сброс состояния**: после выхода (по стопу, тейку или трейлингу) внутренние переменные очищаются, чтобы не влиять на следующую сделку.

## Параметры по умолчанию
| Параметр | Значение | Описание |
|----------|----------|----------|
| `CandleType` | `TimeSpan.FromHours(1).TimeFrame()` | Часовые свечи для расчёта EMA. |
| `FastLength` | 12 | Длина быстрой EMA, реагирующей на текущий импульс. |
| `MediumLength` | 144 | Длина средней EMA — центральной линии «туннеля» для шортов. |
| `SlowLength` | 169 | Длина медленной EMA — внешней границы «туннеля» для лонгов. |
| `StopLossPoints` | 25 | Расстояние защитного стопа в пунктах инструмента. |
| `TakeProfitPoints` | 230 | Расстояние тейк-профита в пунктах. |
| `TrailingStopPoints` | 35 | Расстояние трейлинг-стопа после его активации. |
| `TrailingTriggerPoints` | 20 | Минимальная накопленная прибыль для включения трейлинга. |

## Характеристики
- **Категория**: трендовая стратегия на пересечениях скользящих.
- **Инструменты**: любые площадки с часовыми свечами и корректным шагом цены.
- **Направление**: допускается работа как в лонг, так и в шорт (но не одновременно).
- **Таймфрейм**: по умолчанию 1 час, возможно изменить через параметр `CandleType`.
- **Риск-менеджмент**: жёсткий стоп-лосс, тейк-профит и трейлинг реализованы внутри стратегии.
- **Требования к данным**: используются только закрытия свечей, дополнительная рыночная информация не нужна.

## Дополнительно
- Для расчётов применяются встроенные EMA из StockSharp, что соответствует рекомендациям по использованию высокоуровневого API.
- Незавершённые свечи игнорируются, что исключает повторную генерацию сигналов и работу по неполным данным.
- Уровни трейлинга приводятся к корректному шагу цены через `ShrinkPrice`, чтобы выходы выставлялись на допустимых тиках.
- Параметры совпадают с оригинальными настройками MQL и поддерживают оптимизацию стандартными средствами StockSharp.
