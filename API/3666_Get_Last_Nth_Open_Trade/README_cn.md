# 获取倒数第 N 笔持仓策略

该工具策略复刻了原始的 MetaTrader 智能交易程序：扫描所有未平仓交易，并输出倒数第 *N* 笔。策略通过定时器工作，不会发送任何订单，而是周期性读取投资组合中的持仓，并将选定持仓的快照写入 StockSharp Designer 的日志。

## 工作流程

1. 启动后先检查是否已经指定投资组合，以及刷新间隔是否为正值。
2. 根据 `RefreshInterval` 参数创建定时器。每次触发都会重新构建当前所有持仓（净头寸不为零）。
3. 可以启用 `EnableSymbolFilter`（仅保留当前品种）或 `EnableMagicNumber`/`MagicNumber`（按策略编号过滤）来缩小范围。
4. 通过 `LastChangeTime` 对剩余持仓进行排序，最近变动的排在最前，然后读取 `TradeIndex` 指定（从 0 开始）的那一笔。
5. 生成包含编号、合约、数量、均价、止损、止盈、利润、备注、方向以及开平时间的快照。缺失字段会以空字符串呈现。
6. 只有当快照发生变化时才会写日志，避免重复输出干扰分析。

## 参数

| 参数 | 说明 |
|------|------|
| `EnableMagicNumber` | 启用后按照 `MagicNumber` 值过滤持仓，对应 `StrategyId`。非数字编号会被忽略。 |
| `EnableSymbolFilter` | 仅统计策略当前品种的持仓。 |
| `MagicNumber` | 当 `EnableMagicNumber` 为真时使用的策略编号。 |
| `TradeIndex` | 要展示的持仓索引，0 表示最新的一笔。 |
| `RefreshInterval` | 扫描间隔，默认 1 秒以模拟 MQL 中基于 Tick 的刷新节奏。 |

## 说明

- 策略只用于监控，不会下单，可作为看板或自动巡检组件。
- 如果没有匹配的持仓，会输出提示信息而不是空快照。
- 通过 `LastTradeSnapshot` 属性可以在代码中读取最近一次生成的文本。
- 止损、止盈、备注和时间字段依赖经纪商返回的数据；若不存在则保持为空。

## 与 MQL 版本的差异

- StockSharp 将订单聚合为 `Position`，因此本策略直接读取持仓而不是逐个交易票据。
- MQL 通过票据编号排序，这里则使用最近变动时间作为主排序键，再以编号作为次排序。
- MQL 中的 `Comment` 字段在 StockSharp 中是可选属性，通过反射尝试获取；若属性不存在则忽略。
- 原策略调用 `Comment()` 在屏幕上显示文本，本实现改为写入日志以适配 Designer 的工作流。
