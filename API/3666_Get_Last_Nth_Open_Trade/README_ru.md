# Стратегия «Get Last Nth Open Trade»

Эта вспомогательная стратегия повторяет оригинальный советник MetaTrader: она просматривает все открытые сделки и выводит *N*-ю с конца. Работа ведётся по таймеру, без выставления заявок. На каждом шаге стратегия считывает позиции из портфеля и записывает подробный снимок выбранной сделки в журнал StockSharp Designer.

## Как работает

1. При запуске проверяется, что портфель задан, а значение `RefreshInterval` положительное.
2. Создаётся таймер с периодом `RefreshInterval`. Каждое срабатывание формирует список всех позиций с ненулевым объёмом.
3. Дополнительные фильтры позволяют оставить только позиции по текущему инструменту (`EnableSymbolFilter`) и по идентификатору стратегии (`EnableMagicNumber` + `MagicNumber`).
4. Отфильтрованные позиции сортируются по `LastChangeTime` (от самых новых к старым). Стратегия выбирает элемент с индексом `TradeIndex` (нумерация с нуля) и строит текстовый отчёт.
5. Отчёт включает тикет, инструмент, объём, цену открытия, стоп-лосс, тейк-профит, прибыль, комментарий (если доступен), направление и отметки времени открытия/закрытия. Отсутствующие данные выводятся пустой строкой.
6. В журнал попадает только изменившийся текст, что помогает избежать лишнего шума.

## Параметры

| Параметр | Описание |
|----------|----------|
| `EnableMagicNumber` | При активации использует `MagicNumber` для фильтрации позиций по `StrategyId`. Нечисловые значения игнорируются. |
| `EnableSymbolFilter` | Ограничивает выборку позициями по текущему инструменту стратегии. |
| `MagicNumber` | Числовой идентификатор стратегии, используемый при включённом `EnableMagicNumber`. |
| `TradeIndex` | Индекс позиции в отсортированном списке. `0` — самая свежая сделка. |
| `RefreshInterval` | Интервал между сканированиями. Значение по умолчанию — 1 секунда, что имитирует обновление на каждом тике в MQL. |

## Примечания

- Стратегия предназначена для мониторинга и не торгует самостоятельно.
- При отсутствии подходящих позиций выводится информативное сообщение.
- Свойство `LastTradeSnapshot` предоставляет последний сформированный текст для других компонентов.
- Поля стоп-лосса, тейк-профита, комментария и времени зависят от данных брокера; при их отсутствии строки остаются пустыми.

## Отличия от версии на MQL

- В StockSharp сделки агрегируются в объекты `Position`, поэтому стратегия работает с позициями портфеля, а не с отдельными ордерами.
- Вместо сортировки по номеру тикета используется сортировка по времени последнего изменения, затем по идентификатору.
- Поле `Comment` считывается через отражение, поскольку в StockSharp оно может отсутствовать. Если свойства нет, комментарий пропускается.
- В MQL вывод выполнялся через `Comment()` на графике, здесь информация пишется в журнал, что удобнее для Designer.
