# Стратегия Classic & Virtual Trailing

## Обзор
**Classic & Virtual Trailing Strategy** — это порт эксперта MetaTrader `Classic & Virtual Trailing.mq4` (MQL ID 49326) на C#.
Как и оригинал, стратегия не открывает позиции самостоятельно, а подключается к уже существующим сделкам и сопровождает их
скользящим стопом в двух режимах:

- **Classic** – повторяет стандартный трейлинг MetaTrader: фактический уровень стопа сдвигается вслед за ценой. При касании
  уровень считается сработавшим и позиция закрывается рыночной заявкой, что аналогично серверному стоп-приказу.
- **Virtual** – воспроизводит виртуальный режим из исходного эксперта. Стоп хранится во внутреннем состоянии, заявки на бирже
  не модифицируются. Когда цена касается виртуального уровня, стратегия закрывает позицию вручную.

Обе ветви используют одинаковые условия активации: трейлинг включается лишь после того, как цена прошла `TrailingStartPips`
плюс `TrailingGapPips` пунктов в прибыльную сторону, и далее поддерживает расстояние в `TrailingGapPips`. Пересчёт пипсов
выполняется через `PriceStep` инструмента (для трёх- и пятизнаковых котировок применяется множитель 10), что совпадает с
логикой MetaTrader.

## Логика торговли
1. **Уровень Level1** – стратегия подписывается на лучшие котировки bid/ask и обновляет их при каждом тике.
2. **Конвертация пипсов** – входные параметры задаются в пипсах и переводятся в денежные величины вспомогательной функцией
   `GetPipSize()`, повторяющей расчёт MetaTrader.
3. **Активация трейлинга** – как только нереализованная прибыль превышает `TrailingStartPips + TrailingGapPips`, создаётся
   уровень `Bid − TrailingGap` для длинных и `Ask + TrailingGap` для коротких позиций.
4. **Учёт стоп-уровня (Classic)** – если брокер публикует минимальную дистанцию до стопов через поля Level1 (`StopLevel`,
   `StopDistance` и т.п.), стратегия автоматически увеличивает зазор, прежде чем передвинуть трейлинг.
5. **Поддержка уровня** – новый стоп фиксируется только при движении цены в благоприятную сторону и никогда не понижается.
   Для лонгов и шортов значения хранятся отдельно.
6. **Выход** – при касании уровня позиция закрывается рыночным ордером. Это справедливо для обоих режимов, так как в StockSharp
   срабатывание стопов реализовано на стороне клиента.
7. **Сброс состояния** – когда совокупная позиция обнуляется, сохранённые уровни очищаются, готовя стратегию к следующей сделке.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TrailingMode` | Выбор между режимами `Classic` и `Virtual`. | `Virtual` |
| `TrailingStartPips` | Требуемая прибыль в пипсах до включения трейлинга. | `30` |
| `TrailingGapPips` | Расстояние между ценой и трейлинг-уровнем в пипсах. | `30` |

Все параметры оформлены через `StrategyParam<T>`, что позволяет оптимизировать их в StockSharp Designer.

## Особенности реализации
- Стратегия работает с суммарной позицией (`Strategy.Position`), что соответствует подходу StockSharp и служит аналогом обхода
  всех ордеров в MetaTrader.
- Для корректной работы необходим поток Level1 с актуальными котировками bid/ask.
- В классическом режиме минимальный допустимый зазор стопа учитывается автоматически при наличии соответствующих данных.
- Графические объекты не рисуются: интерфейс визуализации в StockSharp отличается от MetaTrader, поэтому горизонтальные линии
  из оригинала не переносились.
- В соответствии с проектными требованиями стратегия не обращается к историческим значениям индикаторов.

## Файлы
- `CS/ClassicVirtualTrailingStrategy.cs` — реализация стратегии.
- `README.md`, `README_cn.md`, `README_ru.md` — документация на трёх языках.
