# Стратегия ATR Step Trader

## Обзор
ATR Step Trader — это порт советника MetaTrader5 `atrTrader.mq5`. Стратегия сочетает фильтрацию тренда по двум скользящим средним и работу с диапазонами, построенными на Average True Range (ATR). Реализация для StockSharp повторяет событийную модель исходного советника: обрабатываются только закрытые свечи, тренд должен подтверждаться серией из `MomentumPeriod` баров, а все расстояния выражаются в кратных величинах ATR, чтобы адаптироваться к волатильности инструмента.

## Индикаторы и данные
- **Простые скользящие средние (SMA).** Быстрая и медленная SMA (`FastPeriod` и `SlowPeriod`) формируют основной тренд-фильтр. Обе рассчитываются по свечам выбранного таймфрейма.
- **Average True Range.** Индикатор `AverageTrueRange` с периодом `AtrPeriod` переводит волатильность в ценовые расстояния. Входы, пирамидинг и стопы строятся именно на этих расстояниях.
- **Каналы максимумов/минимумов.** Индикаторы `Highest` и `Lowest` отслеживают экстремумы последних `MomentumPeriod` свечей и заменяют вызовы `iHighest`/`iLowest` из MQL.
- **Таймфрейм.** По умолчанию используется часовое окно (`TimeSpan.FromHours(1)`), что соответствует режиму `PERIOD_CURRENT` исходного эксперта. Параметр `CandleType` позволяет выбрать иной интервал.

## Логика входа
1. Дождаться закрытия свечи. Незавершённые бары игнорируются, как и в исходном `OnTick` с проверкой `iTime`.
2. Обновить счётчики серии. Быстрый сигнал увеличивает бычью серию, когда быстрая SMA выше медленной; медвежья серия растёт, когда быстрая SMA ниже медленной. При равенстве значения противоположный счётчик сбрасывается.
3. Когда бычья серия достигает `MomentumPeriod`, проверить, остаётся ли цена закрытия ниже последнего максимума минимум на `StepMultiplier * ATR`. Если да — открыть длинную позицию по рынку.
4. Когда медвежья серия достигает `MomentumPeriod`, проверить, остаётся ли цена закрытия выше последнего минимума минимум на `StepMultiplier * ATR`. Если да — открыть короткую позицию по рынку.
5. Первый вход инициализирует вспомогательные переменные: стратегия запоминает минимальную и максимальную цену входа для текущего направления и сразу выставляет волатильностный стоп (`StepMultiplier * StopMultiplier * ATR`). Эти значения используются при дальнейшем пирамидинге.

## Управление позицией
- **Пирамидинг.** Пока количество сделок меньше `PyramidLimit`, добавляется ещё один лот при отклонении цены на `± StepsMultiplier * ATR` от сохранённых экстремумов. Это копирует логику параметра `Steps` в исходнике и работает как в сторону прибыли, так и против тренда.
- **Стопы.** Начальный стоп устанавливается на расстоянии `StepMultiplier * StopMultiplier * ATR` от цены входа. Когда ступеней набрано максимум, стоп подтягивается к цене закрытия на расстояние `StepMultiplier * ATR`, что имитирует обновление стопов в MQL при трёх позициях.
- **Выход при неблагоприятном движении.** Если цена пробивает край пирамиды на `StepsMultiplier * ATR`, стратегия немедленно закрывает все позиции данного направления рыночным ордером.
- **Сброс состояния.** После полного выхода серия счётчиков и стоповые уровни обнуляются — для повторного входа нужно новое трендовое подтверждение.

## Параметры
| Группа | Параметр | Описание | Значение по умолчанию |
| --- | --- | --- | --- |
| Trend Filter | `FastPeriod` | Период быстрой SMA. | `70` |
| Trend Filter | `SlowPeriod` | Период медленной SMA. | `180` |
| Trend Filter | `MomentumPeriod` | Количество последовательных свечей для подтверждения тренда. | `50` |
| Volatility | `AtrPeriod` | Окно ATR для расчёта расстояний. | `100` |
| Entry Logic | `StepMultiplier` | Кратность ATR для первичного пробоя. | `4` |
| Entry Logic | `StepsMultiplier` | Кратность ATR между слоями пирамиды. | `2` |
| Risk Management | `StopMultiplier` | Дополнительный множитель для первоначального стопа. | `3` |
| Position Sizing | `PyramidLimit` | Максимальное число входов в одном направлении. | `3` |
| Trading | `TradeVolume` | Объём рыночного ордера. | `1` |
| General | `CandleType` | Используемый тип свечей (таймфрейм). | `TimeFrame(1h)` |

## Практические замечания
- Размер позиции контролируется через свойство `Volume` стратегии. Перед запуском установите `TradeVolume` в соответствии с лотом вашего инструмента.
- В примере используются рыночные заявки, аналогичные вызовам `CTrade.Buy/Sell` в MT5. При низкой ликвидности можно заменить их на лимитные или стоповые ордера.
- Переменные экстремумов повторяют логику `h_price` и `l_price` исходника и необходимы для решения, когда добавлять или закрывать ступени пирамиды.
- В оригинале стопы задавались на уровне каждой позиции. В портированной версии стоп контролируется на уровне всей стратегии, что приводит к одновременному закрытию всех слоёв и упрощает работу с заявками.
- Перед реальной торговлей протестируйте стратегию в симуляторе. Несмотря на адаптацию к волатильности через ATR, гэпы и проскальзывание могут увеличить фактический риск.
