# Стратегия Chart Plus Chart

## Обзор
**Chart Plus Chart** — это порт стратегии из MetaTrader 4, построенной на двух простейших советниках (`Chart1.mq4` и `Chart2.mq4`). В оригинале они не торговали, а лишь записывали в общую DLL текущую цену закрытия, количество ордеров, баланс счёта и прибыль первого ордера, чтобы другие графики могли использовать эти данные. Версия для StockSharp реализует тот же обмен, но без внешних DLL: стратегия подписывается на одну или две серии свечей и публикует те же показатели через типизированные события.

## Ключевые идеи MQL-версии
- Каждый советник передавал четыре величины: `Close[0]`, `OrdersTotal()`, `AccountBalance()`, `OrderProfit()`.
- Логика торговли отсутствовала — задача состояла исключительно в том, чтобы обновлять значения при инициализации и на каждом тике.
- Два экземпляра работали одновременно на разных графиках, используя разные индексы в DLL (10 и 70), чтобы не перезаписывать чужие данные.

## Особенности реализации в StockSharp
- Используются высокоуровневые подписки `SubscribeCandles`. Основной поток обязателен, второй поток можно отключать параметром `UseSecondaryStream`.
- При завершении свечи формируется структура `ChartSnapshot`, в которую попадает закрытие свечи, число активных ордеров, `Portfolio.CurrentValue` и `Portfolio.CurrentProfit`.
- Последние снимки сохраняются в полях `PrimarySnapshot` и `SecondarySnapshot` и транслируются через событие `SnapshotUpdated`, поэтому к ним легко подключить пользовательский интерфейс или другие стратегии.
- Переопределённые методы `OnOrderRegistered`, `OnOrderChanged`, `OnNewMyTrade`, `OnPositionChanged` обновляют снимки даже без новых свечей, повторяя поведение MQL-скриптов, которые обновляли данные на каждом тике.

## Как работает стратегия
1. При старте оформляются подписки на указанные типы свечей.
2. После закрытия первой свечи инициализируется соответствующий снимок, вызывается событие `SnapshotUpdated`.
3. Любые дальнейшие изменения (новые свечи, появление/изменение ордеров, изменение позиции) обновляют существующие `record struct` через выражение `with`, что гарантирует актуальность данных для подписчиков.
4. Если отключить `UseSecondaryStream`, вторичная подписка снимается, но основной поток продолжает работу.

## Структура снимка
```csharp
public record struct ChartSnapshot
{
        public decimal LastClose { get; init; }
        public int ActiveOrders { get; init; }
        public decimal AccountBalance { get; init; }
        public decimal TotalProfit { get; init; }
}
```
- **LastClose** — аналог `Close[0]`.
- **ActiveOrders** — текущее число активных ордеров (`ActiveOrders.Count`).
- **AccountBalance** — значение из `Portfolio.CurrentValue` (если недоступно, возвращается `0`).
- **TotalProfit** — агрегированная прибыль стратегии (`Portfolio.CurrentProfit`), что точнее отражает состояние портфеля, чем `OrderProfit()` только первого ордера.

## Параметры
| Параметр | Описание |
|----------|----------|
| `PrimaryCandleType` | Тип свечей/таймфрейм для основного потока. |
| `SecondaryCandleType` | Тип свечей для дополнительного потока, используется только при включённом `UseSecondaryStream`. |
| `UseSecondaryStream` | Включает/выключает вторую подписку и публикацию вторичного снимка. |

Параметры снабжены метаданными через `SetDisplay`, поэтому их легко менять в Designer, Shell и Runner.

## Пример интеграции
```csharp
var strategy = new ChartPlusChartStrategy
{
        PrimaryCandleType = TimeSpan.FromMinutes(15).TimeFrame(),
        SecondaryCandleType = TimeSpan.FromHours(1).TimeFrame(),
        UseSecondaryStream = true
};

strategy.SnapshotUpdated += (stream, snapshot) =>
{
        AddInfo($"[{stream}] close={snapshot.LastClose:0.#####} orders={snapshot.ActiveOrders} " +
                $"balance={snapshot.AccountBalance:0.##} profit={snapshot.TotalProfit:0.##}");
};
```
- Подпишитесь на событие до запуска стратегии, чтобы получить самый первый снимок.
- В любой момент можно запросить актуальные значения методами `PrimarySnapshot`, `SecondarySnapshot` или `GetSnapshot(stream)`.

## Отличия от оригинала
- Данные больше не записываются в DLL, а распространяются через C#-событие, что упрощает интеграцию с графическим интерфейсом или системами мониторинга.
- Вместо `OrderProfit()` используется `Portfolio.CurrentProfit`, который отражает совокупную прибыль/убыток. При наличии нескольких ордеров значение будет отличаться от MT4, но даёт полную картину.
- Обновления выполняются только после закрытия свечи (`CandleStates.Finished`), тогда как в MT4 данные считывались на каждом тике.
- Второй поток можно полностью отключить, если нужен только один набор данных.

## Рекомендации по использованию
- Подключайте стратегию к источнику данных, который обновляет `Portfolio.CurrentValue` и `Portfolio.CurrentProfit`, иначе часть полей останется нулевой.
- Используйте событие `SnapshotUpdated` для построения панелей мониторинга (WPF, WinForms, веб-интерфейсы) или для передачи данных в другие стратегии.
- Так как стратегия не посылает торговых приказов, её можно запускать параллельно с любыми торговыми алгоритмами — конфликтов по ордерам не возникнет.
