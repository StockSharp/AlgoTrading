# Стратегия SilverTrend V3 (C#)

## Общее описание

Стратегия SilverTrend V3 перенесена из MetaTrader 5 советника "SilverTrend v3" и реализована на высокоуровневом API StockSharp. Алгоритм определяет направление тренда с помощью канальной логики SilverTrend, подтверждает сигнал осциллятором J_TPO и сопровождает позиции стопами, трейлингом и фильтром для вечерних часов пятницы.

## Формирование сигналов

1. **Направление SilverTrend**
   - Используется окно из 350 баров и сглаживающий параметр 9 баров для вычисления динамических уровней поддержки (`smin`) и сопротивления (`smax`).
   - Закрытие ниже `smin` переводит стратегию в медвежий режим, закрытие выше `smax` — в бычий.
   - Расчёт выполняется по всей истории окна от старых баров к новым, чтобы сохранить рекурсивную природу исходного MQL-кода.

2. **Фильтр J_TPO**
   - Реализован оригинальный 14-периодный J_TPO, отражающий распределение цены внутри диапазона.
   - Открытие длинной позиции разрешается только при положительном значении осциллятора, короткой — при отрицательном, что отсекает слабые движения.

3. **Отслеживание смены режима**
   - Сделки открываются только при смене знака SilverTrend относительно предыдущего значения, что уменьшает количество ложных входов.

## Управление позициями

- **Рыночные входы** — используется значение `Volume`. При наличии встречной позиции она закрывается и разворачивается одним ордером.
- **Первичный стоп-лосс** — необязательный параметр в шагах цены, пересчитываемый через `PriceStep` инструмента относительно цены входа.
- **Тейк-профит** — также задаётся в шагах цены и проверяется по экстремумам свечи, имитируя модификации ордеров оригинального советника.
- **Трейлинг-стоп** — активируется после движения цены в прибыль на заданное расстояние; для лонга подтягивается вверх, для шорта — вниз.
- **Закрытие по противоположному сигналу** — если предыдущий режим указывает обратное направление, позиция закрывается на следующей закрытой свече.
- **Пятничный фильтр** — после указанного часа в пятницу новые сделки не открываются во избежание гэпов.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `TrailingStopPoints` | 50 | Дистанция трейлинг-стопа в шагах цены. Ноль отключает трейлинг. |
| `TakeProfitPoints` | 50 | Дистанция тейк-профита в шагах цены. Ноль отключает тейк. |
| `InitialStopLossPoints` | 0 | Первичный стоп-лосс в шагах цены. Ноль — без стопа. |
| `FridayCutoffHour` | 16 | Час биржевого времени, после которого в пятницу не открываются новые позиции. Ноль снимает ограничение. |
| `CandleType` | Свечи 1H | Тип свечей для расчётов, можно изменить под нужный таймфрейм. |
| `Volume` | 1 | Объём сделки (свойство `Volume` базового класса). |

Все расстояния пересчитываются через `PriceStep`, поэтому стратегия автоматически адаптируется к инструментам с разным минимальным шагом (включая 3/5-знаковые валютные пары).

## Требования к данным и окружению

- Для запуска логики необходимо минимум 360 завершённых свечей, чтобы сформировать буферы SilverTrend и J_TPO.
- Стратегия работает с одним инструментом, подписываясь на свечи через `SubscribeCandles`; метод `GetWorkingSecurities` возвращает именно эту пару инструмент/тип данных.
- В `OnStarted` вызывается `StartProtection()` для подключения стандартной защиты позиций StockSharp.

## Практические рекомендации

- Лучше всего стратегия работает на трендовых и ликвидных инструментах (основные форекс-пары, фьючерсы и т.п.); подбирайте таймфрейм под текущую волатильность.
- Из-за рекурсивного расчёта SilverTrend при нехватке истории после перезапуска придётся дождаться накопления достаточного числа свечей.
- Стоп-лосс, тейк-профит и трейлинг проверяются по экстремумам свечи. В реальной торговле при необходимости можно дополнительно выставлять биржевые стоп/лимит ордера.
- Внутренние переменные (`_previousSignal`, `_entryPrice`, параметры трейлинга) обновляются один раз на закрытии свечи, что повторяет поведение оригинальной версии "один бар — одно решение".

## Особенности переноса

- Полностью воспроизведены математические процедуры из `SilverTrend v3.mq5`, включая многомерный расчёт индикатора J_TPO.
- Соблюдены правила репозитория: параметры оформлены через `StrategyParam<T>`, все комментарии на английском языке, отступы сделаны табуляцией.
- По условию задачи создана только C#-версия; папка и реализация на Python не добавлялись.
