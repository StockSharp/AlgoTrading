# SilverTrend V3 策略（C#）

## 概述

SilverTrend V3 策略源自 MetaTrader 5 的 "SilverTrend v3" 专家顾问，本移植版本使用 StockSharp 高级 API 重写原始逻辑。策略通过 SilverTrend 通道判断趋势方向，并结合 J_TPO 市场轮廓振荡指标进行过滤，随后利用止损、止盈、移动止损以及周五过滤器对持仓进行完整的风险管理。

## 信号机制

1. **SilverTrend 趋势判断**
   - 使用 350 根 K 线窗口并配合 9 根平滑参数来计算动态支撑（`smin`）与阻力（`smax`）。
   - 收盘价跌破 `smin` 时视为看空环境；收盘价突破 `smax` 时视为看多环境。
   - 计算过程从最早的历史数据递推至最新一根，以保留原始 MQL 版本的递归特性。

2. **J_TPO 确认**
   - 实现原始代码中的 14 周期 J_TPO 指标，用于衡量价格在短期区间内的聚集情况。
   - 当指标为正时才允许做多，当指标为负时才允许做空，从而过滤掉噪音信号。

3. **趋势切换检测**
   - 仅在 SilverTrend 趋势方向发生变化时开仓，避免在无效波动中频繁交易。

## 交易管理

- **市价开仓**：使用策略属性 `Volume` 指定的手数。如果存在反向持仓，会在同一笔市价单中平仓并反手。
- **初始止损**：可选参数，以价格步长为单位，相对于进场价计算；自动根据标的的 `PriceStep` 转换为实际价格距离。
- **止盈目标**：同样以价格步长定义，使用当前 K 线的最高/最低价检测是否达到目标，从而模拟原策略的订单修改行为。
- **移动止损**：当价格向有利方向移动超过设定距离后启动。多单时止损上移，空单时止损下移，逻辑与原始 EA 保持一致。
- **反向信号离场**：当上一根信号显示相反方向时，会在下一根完成的 K 线上平掉现有持仓。
- **周五交易限制**：周五超过指定小时后不再开新仓，以避免周末跳空风险。

## 参数说明

| 参数 | 默认值 | 说明 |
| --- | --- | --- |
| `TrailingStopPoints` | 50 | 移动止损距离（价格步）。设为 0 则关闭移动止损。 |
| `TakeProfitPoints` | 50 | 止盈目标（价格步）。设为 0 则取消止盈。 |
| `InitialStopLossPoints` | 0 | 初始止损（价格步）。设为 0 则不使用初始止损。 |
| `FridayCutoffHour` | 16 | 周五超过该小时后不再开新仓。设为 0 可整日交易。 |
| `CandleType` | 1 小时 K 线 | 用于计算信号的数据类型，可根据需要调整。 |
| `Volume` | 1 手 | 每次交易的数量，使用 StockSharp 的 `Volume` 属性配置。 |

所有距离类参数都会在运行时乘以 `PriceStep`，因此能自动适配不同标的的最小跳动单位（包括 3/5 位报价的外汇品种）。

## 数据与环境要求

- 需要至少 360 根完整 K 线后才会生成信号，以保证 SilverTrend 与 J_TPO 缓冲区完成初始化。
- 策略仅针对单一标的，通过 `SubscribeCandles` 订阅所需的 K 线数据，`GetWorkingSecurities` 会返回相应的证券与周期。
- 在 `OnStarted` 中调用 `StartProtection()`，以启用 StockSharp 提供的基础持仓保护服务。

## 使用建议

- 建议应用于趋势性较强、流动性较好的品种（如主要外汇对或热门期货品种），并根据波动率调整时间框架。
- 由于 SilverTrend 计算具有递归特性，若在历史数据不足的情况下启动策略，需要等待足够的 K 线数据后才会开始交易。
- 当前实现基于 K 线最高/最低价模拟止损和止盈触发。如果在真实交易环境需要委托级别的风险控制，可结合实际止损/止盈订单一起使用。
- `_previousSignal`、`_entryPrice` 与移动止损状态只会在每根完成的 K 线上更新一次，与原 EA 的“一根 K 线一轮决策”行为保持一致。

## 移植细节

- 完整复刻 `SilverTrend v3.mq5` 中的数学算法，包括多维数组实现的 J_TPO 计算。
- 遵循仓库规范：所有参数通过 `StrategyParam<T>` 暴露、注释为英文、并使用制表符缩进。
- 根据任务要求，本次仅提供 C# 版本，未创建 Python 版本或对应目录。
