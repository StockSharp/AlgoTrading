# Advanced EA Panel Strategy

Стратегия переносит функционал MQL5-советника **Advanced EA Panel** в экосистему StockSharp. Изначально панель предоставляла интерактивный интерфейс с переключателями, расчётом пивотов и подсказками для ручной торговли. В C# версии все вычисления выполняются автоматически, а результаты публикуются через параметры и журнал стратегии.

## Основные возможности

- Анализирует девять таймфреймов (M1 … MN1) и для каждого ведёт учёт значений EMA(3/6/9), SMA(50/200), CCI(14) и RSI(21).
- Пересчитывает уровни пивотов по формулам Classic, Woodie или Camarilla на выбранном таймфрейме.
- Отслеживает волатильность через ATR и выводит сообщения при заметном изменении показателя.
- Поддерживает «виртуальную панель риска»: хранит цену входа, стоп, тейк и вычисляет расстояние до них в пунктах и отношение риск/прибыль.
- Может автоматически открывать/закрывать сделки при достижении заданного порога голосов по таймфреймам. Противоположные позиции сначала закрываются, затем выполняется разворот, как это делала кнопка панели.
- Использует `StartProtection`, чтобы защитные приказы восстанавливались после перезапуска, повторяя логику оригинального советника.

## Логика торговли

1. Каждая подписка на свечи формирует набор индикаторов. Если цена закрытия выше скользящих, CCI > +100, а RSI > 60, таймфрейм добавляет «бычий» голос. Обратные условия формируют «медвежий» голос, нейтральные значения не влияют на счётчик.
2. Сумма голосов сравнивается с параметром `DirectionalThreshold`. Значение ≥ порога запускает сигнал **Buy**, ≤ –порога — сигнал **Sell**.
3. При включённом `AutoTradingEnabled` стратегия:
   - Вызывает `ClosePosition()` для закрытия встречной позиции перед разворотом.
   - Отправляет рыночный ордер объёмом `Volume`, предварительно округлённым к `VolumeStep` инструмента.
   - Назначает стоп и тейк через `StartProtection`, пересчитанные из пунктов в абсолютную цену.
4. ATR на основном таймфрейме ведёт журнальные записи — при изменении значения выводится новая отметка о текущей волатильности.
5. Пивоты пересчитываются при закрытии каждой свечи выбранного таймфрейма, в журнал выводятся PP, R1–R4 и S1–S4 для дальнейшего анализа.

## Параметры

| Имя | Описание | Группа | Значение по умолчанию |
| --- | --- | --- | --- |
| `Volume` | Торговый объём в лотах, автоматически округляется к `VolumeStep`. | Trading | 1.0 |
| `StopLossPips` | Дистанция до стоп-лосса в шагах цены. `0` отключает стоп. | Risk | 50 |
| `TakeProfitPips` | Дистанция до тейк-профита в шагах цены. `0` отключает тейк. | Risk | 100 |
| `VolatilityPeriod` | Период ATR для оценки волатильности. | Volatility | 14 |
| `PrimaryCandleType` | Тип свечей, который используется для ATR и построения графика. | General | 15-минутные свечи |
| `PivotCandleType` | Таймфрейм, по которому пересчитываются пивоты. | General | 1-часовые свечи |
| `DirectionalThreshold` | Абсолютный порог голосов для открытия позиции. | Signals | 3 |
| `AutoTradingEnabled` | Включает автоматическое исполнение сигналов. | Signals | true |
| `PivotFormula` | Формула пивотов (`Classic`, `Woodie`, `Camarilla`). | General | Classic |

## Управление рисками

- `StartProtection` создаёт защитные приказы на основе параметров в пунктах, переводя их в абсолютные цены через `PriceStep`.
- При получении сделок обновляются `_entryPrice`, `_stopPrice`, `_takePrice`, а также вычисляется расстояние до уровней и отношение риск/прибыль, что повторяет индикаторы панели.
- Даже при выключенном авто-трейдинге риск-панель продолжает работать и отражает сделки, исполненные другими стратегиями или вручную.

## Отличия от MQL5-версии

- Визуальный интерфейс не переносился: вместо кнопок и объектов на графике используются параметры и журнальные сообщения. При необходимости их легко связать с любым UI внутри StockSharp.
- Функции `Buy`, `Sell`, `Reverse` и `Close` реализованы методами `RequestExecution`, `SendOrder` и `ClosePosition()` с той же последовательностью действий.
- Раздел с Points of Interest, редактированием текстовых полей и перетаскиванием линий опущен. Пивоты теперь рассчитываются программно, а трейдер может расширить класс для прорисовки линий.
- Волатильность и риск рассчитываются заново при каждом запуске, поэтому не требуют хранения объектов на графике.

## Рекомендации по использованию

1. Подключите стратегию к нужному инструменту и убедитесь, что коннектор поставляет все свечи из `PanelTimeFrames`. Пока хотя бы один таймфрейм не сформирует свечу, сигналы не будут генерироваться.
2. Настройте `DirectionalThreshold`, чтобы добиться нужной чувствительности. Большие значения требуют большего согласия между таймфреймами.
3. Установите `AutoTradingEnabled = false`, если хотите использовать стратегию как информационную панель и исполнять сделки вручную.
4. При желании можно удалить или расширить вызовы `CreateChartArea`/`DrawIndicator`, чтобы встроить стратегию в собственную визуализацию.

## Итоги конверсии

- **Логика кнопок** MQL5 перенесена в методы стратегии, сохраняя сценарии покупки, продажи, разворота и закрытия позиций.
- **Пивоты** рассчитываются по тем же наборам формул (Classic, Woodie, Camarilla), которые в панели выбирались предустановками.
- **Индикаторы** заменены на классы `ExponentialMovingAverage`, `SimpleMovingAverage`, `CommodityChannelIndex` и `RelativeStrengthIndex` с привязкой через `Bind`.
- **Риск-панель** стала частью журнала: все ключевые значения логируются и доступны внешним компонентам.

Таким образом, стратегия сохраняет идею Advanced EA Panel — комплексный контроль рынка и быстрые торговые действия — но реализует её в виде полностью автоматизированного модуля StockSharp.
