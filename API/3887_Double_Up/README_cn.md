# Double Up 策略

## 概述
Double Up 策略是 MetaTrader 专家顾问 `DoubleUp.mq4` 的等价移植版本。策略同时使用 CCI 振荡指标和 MACD 主线来识别极端动量。当两个指标都进入同一极端区域时，系统会预先设置下一笔逆向交易。CCI 回落到阈值附近时，算法要么平掉所有空头并开多，要么平掉所有多头并开空。

每次新开仓位的手数都会按照指数级增长模型计算（`基础手数 * 2^亏损计数`）。连续亏损会增加指数，而盈利平仓会把等待缓冲区中的值转移到亏损计数中，然后清空缓冲区。这与原始脚本中 `pos` 和 `wait` 变量的行为保持一致。

## 交易逻辑
- 订阅单一时间框架的K线，计算 CCI（默认周期8）和 MACD 主线（默认快线13、慢线33、信号线2）。
- 将 MACD 数值乘以一百万，使其数量级与 CCI 阈值一致。
- 当两个指标都高于 `+Threshold` 时，准备未来的做空信号；当两个指标都低于 `-Threshold` 时，准备未来的做多信号。
- 若多头信号处于等待状态并且 CCI 再次低于 `+Threshold`，立即开多。若空头信号处于等待状态并且 CCI 低于 `-Threshold`，立即开空。该顺序与原始实现完全一致。
- 在开新仓之前，策略会彻底平掉相反方向的持仓，并等待所有平仓成交。
- 平仓通过市场单完成，成交结果用于调整马丁格尔计数。

## 仓位管理
- 亏损平仓会将亏损计数加一；当计数达到 `PreWait` 时，其值会被加入等待缓冲区，然后计数清零。
- 盈利平仓会把缓冲区的（向下取整后的）值赋给亏损计数，并将缓冲区清零，因此下一次下单的手数等于 `基础手数 * 2^亏损计数`。
- 等待缓冲区在启动时由 `InitialWait` 参数初始化，之后完全由上述规则控制。

## 参数
| 名称 | 默认值 | 说明 |
|------|--------|------|
| `CciPeriod` | 8 | CCI 指标的周期。 |
| `Threshold` | 230 | 判断极端区域的绝对阈值。 |
| `MacdFastPeriod` | 13 | MACD 快速 EMA 周期。 |
| `MacdSlowPeriod` | 33 | MACD 慢速 EMA 周期。 |
| `MacdSignalPeriod` | 2 | MACD 信号 EMA 周期，与原始函数接口兼容。 |
| `BaseVolume` | 0.01 | 未应用马丁格尔之前的基础手数。 |
| `InitialWait` | 0 | 等待缓冲区的初始值（对应原脚本的 `wait`）。 |
| `PreWait` | 2 | 连续亏损的最小次数，达到后才会把计数加入缓冲区。 |
| `BackShift` | 0 | 指标数值的历史偏移量，本移植版本仅支持0。 |
| `CandleType` | 15 分钟K线 | 订阅的数据类型，可根据需求调整。 |

## 注意事项
- 目前仅支持 `BackShift = 0`，与原始 EA 的默认设置相同。
- 所有开仓和平仓均使用市价单，如需要请另行配置止损或止盈。
- 策略在亏损后会倍增仓位，请确保账户资金和风险控制可以承受马丁格尔序列。
