# Стратегия Double Up

## Общее описание
Double Up — это точный порт советника MetaTrader `DoubleUp.mq4`. В основе лежит совместный анализ осциллятора CCI и основной линии MACD. Как только оба индикатора достигают одинаковой экстремальной зоны, стратегия «заряжается» на сделку в противоположном направлении. После возвращения CCI к центральной зоне алгоритм либо закрывает все короткие позиции и открывает новую покупку, либо закрывает все длинные позиции и открывает продажу.

Объём новой позиции рассчитывается по экспоненциальной схеме (`базовый_объём * 2^счётчикУбыточных`). Последовательность убыточных закрытий увеличивает показатель степени, а прибыльное закрытие переносит накопленный буфер ожидания в счётчик и тем самым задаёт стартовый множитель для следующего входа. Такой же механизм использовался в исходном коде через переменные `pos` и `wait`.

## Логика торговли
- Подписка на поток свечей одного таймфрейма и вычисление CCI (по умолчанию период 8) и основной линии MACD (быстрая EMA 13, медленная 33, сигнальная 2).
- Значение MACD умножается на один миллион, чтобы сопоставить его масштаб с порогом CCI.
- Если обе величины превышают `+Threshold`, активируется сигнал для будущей продажи. Если обе величины ниже `-Threshold`, активируется сигнал для будущей покупки.
- Ожидаемая покупка исполняется, когда CCI возвращается ниже `+Threshold`. Ожидаемая продажа исполняется, когда CCI опускается ниже `-Threshold` при активном флаге продажи — порядок полностью повторяет оригинал.
- Перед открытием новой позиции стратегия принудительно закрывает противоположное направление и дожидается завершения всех сделок на выход.
- Выходы осуществляются рыночными заявками при смене сигнала. Фактический результат сделки используется для корректировки мартингейла.

## Управление объёмом
- Убыточное закрытие увеличивает счётчик убыточных сделок. Как только он достигает `PreWait`, значение добавляется в буфер ожидания, а сам счётчик сбрасывается.
- Прибыльное закрытие переносит (усечённое) значение буфера ожидания в счётчик убыточных сделок и очищает буфер. Следующая позиция будет открыта с объёмом `базовый_объём * 2^счётчик`.
- Буфер ожидания инициализируется параметром `InitialWait` и далее изменяется описанными правилами.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `CciPeriod` | 8 | Период индикатора Commodity Channel Index. |
| `Threshold` | 230 | Абсолютный порог для определения экстремумов. |
| `MacdFastPeriod` | 13 | Период быстрой EMA в расчёте MACD. |
| `MacdSlowPeriod` | 33 | Период медленной EMA в расчёте MACD. |
| `MacdSignalPeriod` | 2 | Период сигнальной EMA, нужен для совместимости с оригиналом. |
| `BaseVolume` | 0.01 | Базовый объём до применения степени мартингейла. |
| `InitialWait` | 0 | Стартовое значение буфера ожидания (`wait` в исходном скрипте). |
| `PreWait` | 2 | Минимальное число подряд убыточных выходов перед переносом счётчика в буфер. |
| `BackShift` | 0 | Сдвиг по истории для индикаторов. В порте поддерживается только ноль. |
| `CandleType` | 15-минутные свечи | Тип свечей для подписки; при необходимости измените под рабочий таймфрейм. |

## Примечания
- Поддерживается только значение `BackShift = 0`, что соответствует типичной настройке оригинального советника.
- Все входы и выходы выполняются рыночными ордерами; при необходимости подключите защитные стопы и тейк-профиты.
- Стратегия удваивает объём после убыточных сделок, поэтому заранее рассчитайте требования к марже и ограничения по риску.
