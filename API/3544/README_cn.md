# DeMarker Pending 策略

## 概述

**DeMarker Pending Strategy** 将 MetaTrader 专家顾问 *DeMarker Pending.mq5* 迁移到 StockSharp 的高级 API。策略在指定时间周期上计算 DeMarker 振荡指标。当指标跌破下方阈值时准备做多，当指标升破上方阈值时准备做空。策略不会立即使用市价单开仓，而是在当前买卖价附近、带有可调偏移量的位置挂出止损单或限价单。挂单成交后，头寸使用可配置的止损、止盈和可选的跟踪止损进行管理。

## 交易逻辑

1. **指标计算**：仅在已完成的 K 线上评估 DeMarker 指标。指标低于下轨时产生做多信号，高于上轨时产生做空信号。
2. **点差控制**：下单前检查当前点差（买价减卖价），必须小于允许的最大点差。该阈值以价格步长为单位，便于在不同品种之间保持一致。
3. **挂单布置**：
   - 在 *Stop* 模式下，顺势使用止损单：买单价格为 `ask + 偏移`，卖单价格为 `bid − 偏移`。
   - 在 *Limit* 模式下，逆势使用限价单：买单价格为 `bid − 偏移`，卖单价格为 `ask + 偏移`。
   - 偏移量以价格步长设置，并自动对齐至标的的最小价格步长。
   - 可选项允许在发送新挂单之前取消旧挂单，或始终只保留一张活动挂单。
   - 可以设置挂单有效期，超过时间后自动撤单。
4. **时间过滤**：可按交易时段过滤。超出允许时间范围时，策略会撤销所有挂单并忽略新信号。
5. **成交处理**：挂单成交后记录入场价，并计算止损与止盈目标（以价格步长表示）。同时可设置账户层面的盈利目标，一旦累计盈亏超过该值，策略即平掉所有仓位并撤销挂单。
6. **跟踪止损**：当头寸利润达到激活距离时，启动跟踪止损。可以通过“跟踪步长”参数要求价格额外运行一定距离后再移动止损，以贴合原始专家的行为。
7. **头寸退出**：策略通过 Level 1 行情监控止损、止盈与跟踪水平。一旦被触发，即使用市价单离场，同时移除相关挂单。

## 参数

| 参数 | 说明 |
|------|------|
| `TradeVolume` | 新挂单的交易量，必须为正数。 |
| `DeMarkerPeriod` | DeMarker 指标的平均周期。 |
| `DeMarkerUpperLevel` | 指标高于该阈值时准备做空。 |
| `DeMarkerLowerLevel` | 指标低于该阈值时准备做多。 |
| `StopLossPoints` | 止损距离（价格步长）。为 `0` 时不设置止损。 |
| `TakeProfitPoints` | 止盈距离（价格步长）。为 `0` 时不设置止盈。 |
| `TrailingActivationPoints` | 启动跟踪止损所需的利润距离（价格步长）。为 `0` 时立即允许跟踪。 |
| `TrailingStopPoints` | 跟踪止损距离（价格步长）。为 `0` 时关闭跟踪止损。 |
| `TrailingStepPoints` | 每次调整止损前所需的额外价格移动（价格步长）。为 `0` 时每次更新都会移动。 |
| `PendingIndentPoints` | 挂单相对参考价格（bid/ask）的偏移量，单位为价格步长。 |
| `PendingMaxSpreadPoints` | 最大允许点差（价格步长）。为 `0` 时不限制。 |
| `PendingOnlyOne` | 设为 `true` 时仅保留一张活动挂单。 |
| `PendingClosePrevious` | 设为 `true` 时在下新单前先撤销旧挂单。 |
| `PendingExpiration` | 挂单有效期。持续时间为零表示不过期。 |
| `EntryMode` | 选择挂单类型：`Stop` 或 `Limit`。 |
| `UseTimeFilter` | 是否启用交易时段过滤。 |
| `SessionStart` | 启用过滤时的会话开始时间（含）。 |
| `SessionEnd` | 启用过滤时的会话结束时间（不含），支持跨夜时段。 |
| `TargetProfit` | 账户盈利目标，达到后平仓并撤销挂单。为 `0` 时关闭。 |
| `CandleType` | 用于计算 DeMarker 的 K 线周期。 |

## 说明

- 策略订阅 Level 1 行情以获取最新买卖价，跟踪止损和风险控制均依赖这些数据，因此需要稳定的行情源。
- 所有以“点”表示的距离都会通过 `PriceStep` 转换为价格步长，以再现 MetaTrader 版本的配置方式。
- 代码完全基于 StockSharp 的高级 API（如 `BuyStop`、`SellLimit`、`SetDisplay` 等），便于维护和二次开发。
