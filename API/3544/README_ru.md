# Стратегия DeMarker Pending

## Обзор

**DeMarker Pending Strategy** — порт MetaTrader-советника *DeMarker Pending.mq5* на высокоуровневый API StockSharp. Алгоритм анализирует осциллятор DeMarker на выбранном таймфрейме. Когда осциллятор опускается ниже нижней границы, готовится длинный вход; когда поднимается выше верхней границы, подготавливается короткий вход. Вместо немедленного открытия позиций рыночными заявками стратегия выставляет отложенные заявки (Stop или Limit) на регулируемом расстоянии от текущих bid/ask. После исполнения отложенной заявки позиция сопровождается заданными стоп-лоссом, тейк-профитом и при необходимости трейлинг-стопом.

## Логика торговли

1. **Оценка индикатора.** Значения DeMarker рассчитываются только на закрытых свечах. Сигнал на покупку возникает ниже нижнего уровня, сигнал на продажу — выше верхнего уровня.
2. **Контроль спреда.** Перед установкой заявки текущий спред (ask − bid) сравнивается с максимальным допустимым значением. Порог задаётся в шагах цены, что упрощает настройку под разные инструменты.
3. **Размещение отложенных заявок.**
   - В режиме *Stop* используются стоп-заявки по направлению пробоя: `ask + отступ` для покупок и `bid − отступ` для продаж.
   - В режиме *Limit* используются лимитные заявки на откат: `bid − отступ` для покупок и `ask + отступ` для продаж.
   - Отступ задаётся в шагах цены и автоматически выравнивается под шаг инструмента.
   - Опции позволяют отменять предыдущую заявку перед установкой новой и/или поддерживать только одну активную заявку.
   - Можно задать срок жизни заявки — по истечении интервала она отменяется автоматически.
4. **Временной фильтр.** Торговлю можно ограничить дневной сессией. Вне заданного окна стратегия отменяет отложенные заявки и игнорирует новые сигналы.
5. **Обработка исполнений.** После исполнения фиксируется цена входа и вычисляются уровни стоп-лосса и тейк-профита (в шагах цены). Дополнительно можно задать целевую прибыль в деньгах — при достижении порога стратегия закрывает все позиции и отменяет заявки.
6. **Трейлинг-стоп.** Когда позиция проходит заданное расстояние в прибыль, стоп подтягивается вслед за ценой. Параметр «шаг трейлинга» задаёт дополнительное движение цены между очередными срабатываниями.
7. **Выход из позиции.** Уровни стопа, тейка и трейлинга отслеживаются по котировкам Level 1. При достижении любого уровня позиция закрывается рыночной заявкой, а сопутствующие отложенные заявки снимаются.

## Параметры

| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Объём новой отложенной заявки. Должен быть положительным. |
| `DeMarkerPeriod` | Период усреднения индикатора DeMarker. |
| `DeMarkerUpperLevel` | Уровень, выше которого формируется сигнал на продажу. |
| `DeMarkerLowerLevel` | Уровень, ниже которого формируется сигнал на покупку. |
| `StopLossPoints` | Расстояние стоп-лосса в шагах цены. `0` — стоп выключен. |
| `TakeProfitPoints` | Расстояние тейк-профита в шагах цены. `0` — тейк выключен. |
| `TrailingActivationPoints` | Прибыль в шагах цены, необходимая для активации трейлинг-стопа. `0` — без условия активации. |
| `TrailingStopPoints` | Расстояние трейлинг-стопа в шагах цены. `0` — трейлинг отключён. |
| `TrailingStepPoints` | Дополнительное смещение цены между срабатываниями трейлинга. `0` — подтягивание на каждом обновлении. |
| `PendingIndentPoints` | Отступ от опорной цены (bid/ask) при выставлении заявки, в шагах цены. |
| `PendingMaxSpreadPoints` | Максимально допустимый спред в шагах цены. `0` — без ограничения. |
| `PendingOnlyOne` | При значении `true` поддерживается не более одной активной отложенной заявки. |
| `PendingClosePrevious` | При значении `true` старая заявка отменяется перед установкой новой. |
| `PendingExpiration` | Время жизни отложенной заявки. Нулевая длительность отключает автоснятие. |
| `EntryMode` | Тип заявок: `Stop` или `Limit`. |
| `UseTimeFilter` | Включает фильтр торговой сессии. |
| `SessionStart` | Начало сессии (включительно) при активном фильтре. |
| `SessionEnd` | Конец сессии (исключительно). Поддерживаются ночные сессии через переход полуночи. |
| `TargetProfit` | Целевая прибыль в денежных единицах. `0` — цель отключена. |
| `CandleType` | Таймфрейм свечей для расчёта индикатора. |

## Примечания

- Для контроля стопов и трейлинг-логики стратегия подписывается на котировки Level 1, поэтому необходим поставщик данных с оперативными bid/ask.
- Все «пункты» преобразуются в шаги цены с использованием `PriceStep`, что соответствует логике оригинального эксперта MetaTrader.
- Реализация опирается на высокоуровневые методы StockSharp (`BuyStop`, `SellLimit`, `SetDisplay` и др.), что упрощает сопровождение и настройку.
