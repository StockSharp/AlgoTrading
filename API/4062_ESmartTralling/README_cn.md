# e-Smart Tralling 策略
[English](README.md) | [Русский](README_ru.md)

## 概述

**e-Smart Tralling** 策略完整复刻了同名的 MetaTrader 智能交易系统。它本身不会创建任何新仓位，而是专注于管理当前账户中目标证券的净头寸，通过多阶段的保本机制和最终的移动止损来逐步锁定利润。实现完全基于 StockSharp 的高级 API，并通过订阅蜡烛图来接收价格更新。

主要特性：

- 同时支持多头和空头仓位。
- 使用 `Security.PriceStep`（若缺失则使用 `Security.Step`）将 MetaTrader 的“点”转换为实际的价格增量。
- 提供三个可配置的盈利检查点，每个检查点都会把止损推进到更有利的位置。
- 达到第一个检查点后可按交易所的最小成交量步长向上取整，关闭约三分之一的仓位。
- 当价格进一步突破第三个检查点时，按照 `TrailingStop` 与 `TrailingStep` 参数启动移动止损。
- 将计算得到的止损价保存在内部，当蜡烛的高/低价触及该水平时通过市价单平仓，模拟 MetaTrader 中的 `OrderModify` 行为。

> **提示：** 原始 EA 会在一个账户中遍历全部订单。StockSharp 版本假定每个策略实例只负责一个证券的净头寸，如果需要同时管理多个品种，请启动多个实例。

## 管理流程

1. **初始化**：记录 StockSharp 返回的平均持仓价格，不主动发单。
2. **盈利检查点**：当蜡烛的最高价（多头）或最低价（空头）带来超过 `LevelProfit1/2/3` 的收益时，将止损价移动到距离开仓价 `LevelMovingX` 点的位置。
3. **部分止盈**：若启用 `UseCloseOneThird`，在第一个检查点触发时，以市价单平掉大约三分之一的仓位，成交量向上取整到 `Security.VolumeStep`（缺省为 0.1）。
4. **移动止损**：当未实现收益超过 `LevelMoving3 + TrailingStop + TrailingStep` 时，止损价开始以 `TrailingStop` 点的距离跟随行情，只有在再向前推进至少 `TrailingStep` 点后才会更新。
5. **离场**：一旦蜡烛的价格区间回撤到保存的止损价，立即以市价单平掉剩余仓位。

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `UseCloseOneThird` | 在第一个检查点关闭约三分之一仓位。 | `true` |
| `LevelProfit1` | 激活第一个检查点所需的盈利点数。 | `20` |
| `LevelProfit2` | 激活第二个检查点所需的盈利点数。 | `35` |
| `LevelProfit3` | 激活第三个检查点所需的盈利点数。 | `55` |
| `LevelMoving1` | 第一个检查点对应的止损偏移点数。 | `1` |
| `LevelMoving2` | 第二个检查点对应的止损偏移点数。 | `10` |
| `LevelMoving3` | 第三个检查点对应的止损偏移点数。 | `30` |
| `TrailingStop` | 第三个检查点之后移动止损与价格之间的距离。 | `30` |
| `TrailingStep` | 再次移动止损所需的额外正向位移。 | `5` |
| `CandleType` | 提供价格数据的蜡烛类型。 | 5 分钟蜡烛 |

所有“点”都会乘以品种的价格步长。若无法获得该信息，策略无法计算真实价格差，因此不会启动移动止损。

## 补充说明

- 策略通过 `SubscribeCandles` 订阅实时蜡烛。在历史回测时需启用蜡烛仿真或提供历史数据。
- 策略只在内部保存应有的止损价，不会自动挂出止损单。若需要实际的保护性委托，请在外部自行添加。
- 为保持简洁，MetaTrader 中的声音提示、图形注释等功能均未移植。
- 市价平仓会使用当前全部仓位，确保没有其他策略同时操作同一证券和投资组合。
- 部分止盈依赖交易品种的 `VolumeStep`。当交易所未提供该值时，会退回到 0.1 手的上取整方式，与原始 EA 一致。

## 与 MetaTrader 版本的差异

- 管理对象是单一的净头寸，而不是逐个订单。
- 止损移动通过监控蜡烛的价格区间并在触发时直接市价平仓来模拟。
- 移除了声音提醒和图表注释，建议使用 StockSharp 的日志系统。
- 未实现 `UseOneAccount`、`ShowComment`、`UseSound` 等输入变量，因为在 StockSharp 环境中已经不需要它们。

借助以上说明，可以在 StockSharp 平台中重现原策略的风格，并根据需要进一步扩展。
