# Стратегия e-Smart Tralling
[English](README.md) | [中文](README_cn.md)

## Обзор

**e-Smart Tralling** — это точная конверсия одноимённого советника MetaTrader, предназначенного исключительно для сопровождения уже открытых позиций. Стратегия не генерирует сигналов входа: она контролирует текущую нетто-позицию по выбранному инструменту и последовательно подтягивает стоп-лосс в соответствии с тремя прибылевыми уровнями и финальным трейлингом. Реализация построена на высокоуровневом API StockSharp и получает цены через подписку на свечи.

Основные возможности:

- Поддержка как длинных, так и коротких позиций.
- Перевод «поинтов» MetaTrader в реальные ценовые приращения через `Security.PriceStep` (с резервом на `Security.Step`).
- Три независимых уровня фиксации прибыли, каждый из которых переносит стоп выше/ниже цены входа.
- Опциональное закрытие ~1/3 объёма (округление вверх до шага объёма) при достижении первого уровня.
- Автоматический трейлинг после превышения третьего уровня на заданный запас.
- Закрытие позиции рыночным ордером при возврате цены к вычисленному уровню стоп-лосса.

> **Важно:** оригинальный советник обрабатывал все ордера на счёте. В StockSharp-версии предполагается, что экземпляр стратегии управляет только одной позицией. Для разных инструментов запускайте отдельные экземпляры.

## Логика сопровождения

1. **Инициализация** — стратегия сохраняет среднюю цену входа, предоставленную StockSharp, и ожидает движения цены.
2. **Прибылевые уровни** — как только максимум (для покупки) или минимум (для продажи) свечи обеспечивает прибыль выше `LevelProfit1/2/3`, стоп-цена переносится на `LevelMovingX` поинтов относительно цены входа.
3. **Частичное закрытие** — при активном `UseCloseOneThird` стратегия отправляет рыночную заявку на закрытие приблизительно одной трети позиции на первом уровне. Объём округляется вверх до `Security.VolumeStep` (при отсутствии данных — до 0.1 лота).
4. **Трейлинг** — после достижения прибыли `LevelMoving3 + TrailingStop + TrailingStep` стоп следует за ценой с отступом `TrailingStop`, причём обновление выполняется только после дополнительного продвижения не менее `TrailingStep` поинтов.
5. **Выход** — когда диапазон свечи возвращается к сохранённой стоп-цене, оставшаяся позиция закрывается рыночным ордером, что имитирует `OrderModify` из MetaTrader.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `UseCloseOneThird` | Закрывать около трети позиции на первом уровне. | `true` |
| `LevelProfit1` | Прибыль (в поинтах) для активации первого уровня. | `20` |
| `LevelProfit2` | Прибыль (в поинтах) для активации второго уровня. | `35` |
| `LevelProfit3` | Прибыль (в поинтах) для активации третьего уровня. | `55` |
| `LevelMoving1` | Смещение стоп-цены на первом уровне (поинты). | `1` |
| `LevelMoving2` | Смещение стоп-цены на втором уровне (поинты). | `10` |
| `LevelMoving3` | Смещение стоп-цены на третьем уровне (поинты). | `30` |
| `TrailingStop` | Расстояние (поинты) до трейлинга после третьего уровня. | `30` |
| `TrailingStep` | Дополнительное движение (поинты) перед следующим сдвигом трейлинга. | `5` |
| `CandleType` | Тип свечей для расчёта. | Таймфрейм 5 минут |

Все значения в поинтах умножаются на ценовой шаг инструмента. Если `PriceStep` и `Step` недоступны, трейлинг отключается, поскольку невозможно корректно пересчитать поинты в цену.

## Дополнительные замечания

- Для работы стратегия подписывается на свечи через `SubscribeCandles`. При тестировании на истории включите режим эмуляции свечей.
- Стоп-уровень хранится во внутренней переменной, фактический стоп-ордер не регистрируется. При необходимости можно добавить защитные заявки вручную.
- Функции MetaTrader (общесчётная обработка ордеров, комментарии, звуковые сигналы) намеренно исключены.
- Рыночные заявки на закрытие используют полный текущий объём. Убедитесь, что другие стратегии не управляют тем же инструментом и портфелем.
- Частичное закрытие ориентируется на `VolumeStep`. Если брокер не предоставляет шаг объёма, применяется округление к 0.1 лота, как в оригинальном советнике.

## Отличия от версии MetaTrader

- Управление ведётся по нетто-позиции, а не по отдельным ордерам.
- Перенос стоп-лосса моделируется рыночным закрытием при касании цены свечой.
- Исключены звуковые оповещения и вывод комментариев на график — используйте стандартные логи StockSharp.
- Внешние параметры `UseOneAccount`, `ShowComment`, `UseSound` отсутствуют, поскольку их функционал не требуется в рамках StockSharp.

Подробное описание выше поможет воссоздать исходную логику сопровождения и безопасно интегрировать её в инфраструктуру StockSharp.
