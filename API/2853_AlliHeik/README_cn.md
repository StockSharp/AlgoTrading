# Alli Heik 策略

Alli Heik 策略源自 MetaTrader 5 专家顾问 “AlliHeik”，核心是 **Heiken Ashi Smoothed Oscillator**（HASO）指标。该指标先用可选的移动平均对原始的开盘价、最高价、最低价、收盘价进行平滑，再基于平滑后的数据构建 Heiken Ashi 蜡烛，并对其开收盘均值再次平滑。连续两根平滑值的差即为振荡器曲线，之后再用另一条移动平均形成信号线。

策略只在完整收盘的 K 线结束时评估振荡器与信号线的交叉，可选地支持信号反向、自动平掉反向头寸、固定止损/止盈以及带步长的追踪止损，使行为与原 MT5 版本保持一致。

## 交易逻辑

1. **指标准备**
   - 使用 SMA、EMA、SMMA 或 LWMA 对 OHLC 数据进行预平滑。
   - 依据平滑数据构建 Heiken Ashi 蜡烛，并取其开盘与收盘的平均值得到中点。
   - 对中点再次平滑，计算当前与上一根平滑值之差，得到振荡器数值。
   - 对振荡器应用移动平均，生成信号线。
2. **入场条件**
   - *常规模式*：当振荡器从上向下穿越信号线时做多，当振荡器从下向上穿越信号线时做空（完全复刻 MQL 中的条件）。
   - *反向模式*：多空条件互换。
   - 仅在 K 线收盘后处理信号，可选地在开新仓前先平掉反向仓位。
3. **离场与风控**
   - 止损与止盈使用点数（pip）表示，会根据标的的最小变动价位和小数位数换算为价格距离。
   - 追踪止损在价格盈利超过 *TrailingStop + TrailingStep* 点后激活，并把止损移动到 `当前价 − TrailingStop`（做多）或 `当前价 + TrailingStop`（做空），只有当新止损相对旧值至少多出 `TrailingStep` 点时才会再次移动。
   - 一旦价格触及止损或止盈，策略会立即平仓。

## 参数说明

- **Volume** – 下单手数。
- **Stop Loss (pips)** – 固定止损距离，为 0 表示不启用。
- **Take Profit (pips)** – 固定止盈距离，为 0 表示不启用。
- **Trailing Stop (pips)** – 追踪止损距离，为 0 表示不启用追踪。
- **Trailing Step (pips)** – 每次移动追踪止损所需的最小新增盈利（启用追踪时必须大于 0）。
- **Reverse Signals** – 反向使用振荡器交叉信号。
- **Close Opposite** – 入场前先平掉反向仓位。
- **Pre Smooth Period / Method** – 预平滑 OHLC 的移动平均周期及类型。
- **Post Smooth Period / Method** – 平滑 Heiken Ashi 中点的移动平均参数。
- **Signal Period / Method** – 平滑振荡器得到信号线的移动平均参数。
- **Candle Type** – 计算所用的 K 线类型（默认 15 分钟）。

## 实现细节

- 通过 StockSharp 中的 SMA、EMA、SMMA、LWMA 等现成指标组合还原 HASO 的两级平滑和差分计算流程。
- Pip 距离转换成绝对价格时会考虑交易品种的 tick size 和小数位，兼容常见的 3/5 位报价精度。
- 每根收盘 K 线都会检查止损、止盈与追踪止损的触发条件，完全复现原始 EA 的步进式移动逻辑。
- 在指标未完全形成前不会生成交易信号，避免使用不完整的数据。

本目录未提供 Python 版本。
