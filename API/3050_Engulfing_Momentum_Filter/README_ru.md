# Стратегия Engulfing Momentum
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник **ENGULFING** из MetaTrader в среду StockSharp на высокоуровневом API. Вход происходит по свечной модели «поглощение» на рабочем таймфрейме с подтверждением импульса на более крупном периоде и трендового фильтра MACD на «месячных» свечах (30 дней). Блок управления рисками воспроизводит перевод стопа в безубыток и трейлинг, используя шаги инструмента.

## Алгоритм

1. **Свечной паттерн.** Последняя завершённая свеча должна поглощать тело предыдущей. Дополнительно проверяется, что свеча два бара назад пересекалась с предыдущей, что повторяет проверку фракталов в оригинальном коде.
2. **Фильтр тренда.** Быстрая и медленная взвешенные скользящие (аналог LWMA) задают направление. Для покупок быстрый MA должен быть выше медленного, для продаж — ниже.
3. **Фильтр импульса.** Индикатор Momentum на старшем таймфрейме (по умолчанию 1 час) должен отклоняться от уровня 100 минимум на заданное значение хотя бы в одном из трёх последних значений (`MomLevelB/MomLevelS` из MQL).
4. **Фильтр MACD.** На свечах `MacdCandleType` (30 дней) главная линия MACD должна быть выше сигнальной для лонгов и ниже для шортов, что соответствует проверке `MacdMAIN0` и `MacdSIGNAL0`.
5. **Управление позицией.** При появлении обратного сигнала стратегия переворачивает позицию. Стоп-лосс, тейк-профит, перевод в безубыток и трейлинг контролируют выходы.

## Управление рисками

- **Стоп-лосс и тейк-профит.** Настраиваются в шагах цены инструмента и повторяют параметры `Stop_Loss` и `Take_Profit` из советника. Ноль отключает уровень.
- **Трейлинг-стоп.** Опциональный, также задаётся в шагах. Стоп подтягивается вслед за экстремумом после входа.
- **Безубыток.** После прохождения `BreakEvenTriggerSteps` цена переводит стоп на цену входа плюс `BreakEvenOffsetSteps`, аналогично опции `USEMOVETOBREAKEVEN`.

Денежные цели (`Use_TP_In_Money`, `Take_Profit_In_percent`) не реализованы: в StockSharp удобнее оперировать шагами инструмента. Аналогичного эффекта можно добиться, подбирая значения стопа и тейка.

## Параметры

- `FastMaPeriod`, `SlowMaPeriod` — периоды взвешенных скользящих.
- `MomentumPeriod` — период Momentum на старшем таймфрейме.
- `MomentumBuyThreshold`, `MomentumSellThreshold` — минимальное отклонение от 100 для подтверждения импульса.
- `MacdFastLength`, `MacdSlowLength`, `MacdSignalLength` — параметры MACD для фильтра тренда.
- `StopLossSteps`, `TakeProfitSteps` — расстояния до стопа и тейка в шагах цены.
- `TrailingStopSteps` — дистанция трейлинг-стопа (0 выключает).
- `BreakEvenTriggerSteps`, `BreakEvenOffsetSteps` — параметры перевода в безубыток.
- `CandleType` — рабочий таймфрейм.
- `HigherCandleType` — таймфрейм для Momentum (по умолчанию 1 час).
- `MacdCandleType` — таймфрейм для MACD (по умолчанию 30 дней ≈ месяц).

## Как использовать

1. Назначьте стратегии инструмент и задайте подходящие `CandleType`, `HigherCandleType`, `MacdCandleType`.
2. Подберите периоды MA и пороги Momentum в зависимости от волатильности рынка.
3. Установите стопы, тейки, трейлинг и безубыток в шагах, соответствующих тик-сайзу инструмента.
4. Запустите стратегию. После формирования индикаторов она начнёт анализировать сигналы и управлять позицией.

## Особенности по сравнению с оригиналом

- Вместо ручного подсчёта LWMA используются готовые `WeightedMovingAverage` из StockSharp.
- Логика перевода в безубыток и трейлинга работает по закрытым свечам, что соответствует баровому режиму советника.
- Денежные и процентные цели опущены, но могут быть имитированы через настройку шаговых параметров.
- Одновременно удерживается только одна позиция, что отражает реальное использование советника, несмотря на наличие `Max_Trades`.

Рекомендуется адаптировать пороги импульса и размеры шагов под конкретный инструмент: чем выше волатильность, тем больше значения требуются, чтобы избежать ложных срабатываний.
