# Стратегия Virtual SL TP V1

**Virtual SL TP V1** — порт скрипта MetaTrader `Virtual_SL_TP_Pending_with_SL_Trailing.mq4` (MQL ID 49146) на платформу StockSharp. Оригинальная программа сопровождала уже открытую позицию: рассчитывала виртуальные уровни стоп-лосса и тейк-профита, а при необходимости устанавливала отложенный buy stop ордер после пробития заданного уровня. Версия на C# повторяет эту логику, используя только высокоуровневые методы StockSharp (`SubscribeLevel1`, `BuyStop`, `ClosePosition`).

## Ключевые идеи

1. **Учет спреда** – при запуске фиксируется стартовый спред. Если текущий спред превышает допуск `SpreadThreshold`, все виртуальные уровни сдвигаются вверх, сохраняя прежнюю дистанцию от рынка.
2. **Виртуальные выходы** – стратегия не размещает реальные защитные заявки. Она отслеживает лучшую цену Bid и вызывает `ClosePosition()` при достижении виртуального стоп-лосса или тейк-профита.
3. **Необязательный трейлинг-ордер** – когда параметр `EnableTrailing` включен и лучшая цена Ask доходит до триггера, на виртуальном уровне размещается buy stop заявка. Если сдвигается триггер (из-за изменения спреда), цена ордера пересчитывается автоматически.

## Параметры

| Название | Значение по умолчанию | Описание |
| -------- | --------------------- | -------- |
| `StopLossPoints` | `20` | Дистанция (в пунктах MetaTrader) между Ask и виртуальным стоп-лоссом. |
| `TakeProfitPoints` | `40` | Дистанция (в пунктах MetaTrader) между Ask и виртуальным тейк-профитом. |
| `SpreadThreshold` | `2.0` | Дополнительный спред, при превышении которого виртуальные уровни сдвигаются вверх. |
| `TrailingStopPoints` | `10` | Отступ (в пунктах MetaTrader) между Ask и ценой отложенного buy stop ордера. |
| `EnableTrailing` | `false` | Включает или отключает установку трейлинг-ордера. |

> **Пункты MetaTrader** рассчитываются автоматически из `Security.PriceStep`. При отсутствии шага цены используется значение `1`.

## Ход работы

1. `SubscribeLevel1()` подписывает стратегию на поток лучших котировок Bid/Ask.
2. Первый тик сохраняет стартовый спред и формирует виртуальные уровни: стоп-лосс, тейк-профит и триггер отложенного ордера.
3. Каждый следующий тик:
   - Пересчитывает спред и, при необходимости, сдвигает все виртуальные уровни.
   - Сравнивает лучшую цену Bid с виртуальными стоп-уровнями и вызывает `ClosePosition()` при срабатывании.
   - При активном трейлинге проверяет достижение триггера по Ask и отправляет `BuyStop`.
4. При остановке стратегии или отключении трейлинга отложенный ордер автоматически отменяется.

## Содержимое каталога

- `CS/VirtualSlTpV1Strategy.cs` – исходный код стратегии.
- `README.md` – описание на английском языке.
- `README_cn.md` – описание на китайском языке.
