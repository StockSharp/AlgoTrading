# Perceptron 自适应策略

## 概述

本策略将 MetaTrader 5 专家顾问 *Perceptron.mq5* 移植到 StockSharp。  
五个离散指标信号通过两层感知机组合，仓位平仓后根据盈亏对突触权重进行奖励或惩罚，从而复制原始 EA 的自学习机制，同时使用 StockSharp 的高级蜡烛 API。

## 指标层

| 代码 | 描述 | 信号规则 |
| --- | --- | --- |
| `IND1` | 快速/慢速 SMA 金叉死叉 | 在上一根柱子上发生金叉时返回 +1，死叉时返回 −1，否则返回 0。 |
| `IND2` | RSI | RSI 从超卖区间向上穿越 30 时返回 +1，从超买区间向下穿越 70 时返回 −1。 |
| `IND3` | CCI | 向上突破 −100 时返回 +1，向下跌破 +100 时返回 −1。 |
| `IND4` | 短期 SMA 斜率 | 短期 SMA 在最近两根柱子之间上升时返回 +1，下降时返回 −1。 |
| `IND5` | Awesome Oscillator 柱体颜色 | 当前柱体高于上一柱体（多头颜色）返回 +1，低于上一柱体（空头颜色）返回 −1。 |

所有信号均在收盘蜡烛上计算，内部维护的历史缓存模拟 MQL5 中的 `CopyBuffer` 行为。

## 感知机结构

- 五个隐藏神经元 (`NN1`…`NN5`) 分别组合四个指标，连线方式与原策略保持一致。
- 每个神经元拥有一组突触权重以及偏置权重 (`NNS1`…`NNS5`)。
- 最终输出 `brainReturn` 为所有神经元输出与偏置的加权和。  
  - `brainReturn > 0` 且上一笔不是多头时尝试开多。  
  - `brainReturn < 0` 且上一笔不是空头时尝试开空。
- 仅在没有持仓时发送市价单。

## 仓位管理

- 入场时记录价格、方向以及各指标/神经元的状态。
- 止损和止盈以绝对价格单位设置（例如 0.0004 对应外汇五位小数的 4 点）。  
  下一根蜡烛开盘后：
  - 多头首先比较最高价是否达到止盈，然后比较最低价是否触发止损；
  - 空头首先比较最低价是否达到止盈，然后比较最高价是否触发止损；
  - 若同一根蜡烛同时触及两个水平，则优先判定止盈，与原 EA 的偏好一致。
- 检测到离场后使用市价单平仓，并根据触发的止盈/止损价格计算实际盈亏。

## 权重自适应

平仓后使用记录的信号重新评估：

1. 计算 `directionSign`（多头为 −1，空头为 +1）以及 `outcomeSign`（实际盈亏的符号）。
2. 偏置权重限制在 `[SinMin, SinMax]`：若 `sign(neuronOutput) * directionSign > 0`，在盈利时增加、亏损时减少，否则反向调整。
3. 指标突触权重采用同样的逻辑，但不设上下界。
4. 清除已存储的信号，避免下一笔交易重复使用。

该流程将原脚本中大量的条件语句浓缩为简洁的强化学习步骤。

## 参数

| 参数 | 默认值 | 说明 |
| --- | --- | --- |
| `CandleType` | 1 分钟 | 策略使用的蜡烛类型。 |
| `FastMaLength` | 5 | 快速 SMA 周期。 |
| `SlowMaLength` | 9 | 慢速 SMA 周期。 |
| `RsiLength` | 14 | RSI 周期。 |
| `CciLength` | 14 | CCI 周期。 |
| `SlopeMaLength` | 5 | 斜率 SMA 周期。 |
| `AoShortLength` | 5 | Awesome Oscillator 短周期。 |
| `AoLongLength` | 34 | Awesome Oscillator 长周期。 |
| `StopLossOffset` | 0.001 | 止损距离，绝对价格单位（0 表示禁用）。 |
| `TakeProfitOffset` | 0.0004 | 止盈距离，绝对价格单位（0 表示禁用）。 |
| `SinMax` | 5 | 神经元偏置最大值。 |
| `SinMin` | 0 | 神经元偏置最小值。 |
| `SinPlusStep` | 0.03 | 正向强化步长。 |
| `SinMinusStep` | 0.03 | 负向强化步长。 |

所有参数均通过 `StrategyParam<T>` 暴露，可在 Designer 中优化。

## 实现说明

- 使用高级蜡烛订阅接口，一次绑定多个指标。
- 为了在更新权重时精确掌握平仓价格，策略内部自行处理止盈止损。
- 通过 `nullable` 字段存储历史数值，确保指标在完全形成之前不会触发信号。
- Awesome Oscillator 的颜色通过比较当前与上一柱体的数值近似获得。
- 图表区域绘制蜡烛、快慢均线及策略成交记录，便于观察学习过程。

## 限制与假设

- 只有在蜡烛收盘后才会检查止盈/止损，无法得知同一根蜡烛内的触发顺序，因此优先选择止盈结果。
- 指标权重没有上下界，长时间强化可能导致数值偏大。
- 原 EA 中 `LastTradeType` 不会重置；在本移植中每次平仓后都会清零，以允许连续同向交易。

