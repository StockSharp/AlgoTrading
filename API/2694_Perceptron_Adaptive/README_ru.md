# Адаптивная стратегия Perceptron

## Обзор

Стратегия представляет собой перенос эксперт-советника MetaTrader 5 *Perceptron.mq5* в среду StockSharp.  
Пять дискретных торговых сигналов объединяются двухслойным персептроном. После закрытия позиции сохранявшиеся состояния индикаторов используются для поощрения или наказания синаптических весов в зависимости от полученной прибыли, что воспроизводит обучающую петлю оригинального советника.

## Слой индикаторов

| Код | Описание | Логика сигнала |
| --- | --- | --- |
| `IND1` | Пересечение быстрых и медленных SMA | +1 при восходящем пересечении на предыдущей свече, −1 при нисходящем, иначе 0. |
| `IND2` | Индекс относительной силы (RSI) | +1 при выходе RSI из перепроданности (выше 30), −1 при выходе из перекупленности (ниже 70). |
| `IND3` | Индекс товарного канала (CCI) | +1 при пробое уровня −100 вверх, −1 при пробое +100 вниз. |
| `IND4` | Наклон короткой SMA | +1 если короткая SMA выросла между двумя предыдущими свечами, −1 если снизилась. |
| `IND5` | Осциллятор Awesome (цвет гистограммы) | +1 когда столбец растёт относительно предыдущего (зелёный цвет), −1 когда уменьшается (красный цвет). |

Сигналы рассчитываются только на закрытых свечах. Для имитации окна `CopyBuffer` ведутся собственные буферы исторических значений.

## Архитектура персептрона

- Пять скрытых нейронов (`NN1`…`NN5`) повторяют подключение индикаторов как в исходном коде.
- У каждого нейрона свой набор синаптических весов и смещение (`NNS1`…`NNS5`).
- Итоговая активация `brainReturn` — сумма произведений выходов нейронов на их смещения.  
  - `brainReturn > 0` → попытка открыть длинную позицию (если предыдущая сделка не была длинной).  
  - `brainReturn < 0` → попытка открыть короткую позицию (если предыдущая сделка не была короткой).
- Сделки совершаются рыночными приказами только при отсутствии открытой позиции.

## Управление позицией

- При входе сохраняются цена, направление и значения индикаторов/нейронов.
- Стоп-лосс и тейк-профит задаются в абсолютных ценовых единицах (например 0.0004 для 4 пунктов по пятому знаку).  
  После открытия следующей свечи:
  - Для лонгов сначала проверяется максимум на достижение тейк-профита, затем минимум на достижение стопа.
  - Для шортов сначала проверяется минимум, затем максимум.
  - Если в пределах одной свечи достигнуты оба уровня, приоритет отдаётся тейк-профиту — так же, как в EA.
- При фиксации выхода позиция закрывается рыночным ордером, а прибыль определяется по соответствующему уровню TP/SL.

## Адаптация весов

После закрытия позиции выполняются следующие шаги:

1. Рассчитываются `directionSign` (−1 для лонгов, +1 для шортов) и `outcomeSign` (знак реализованной прибыли).
2. Смещения нейронов ограничиваются диапазоном `[SinMin, SinMax]`:  
   если `sign(neuronOutput) * directionSign > 0`, смещение изменяется в сторону результата сделки, иначе — в противоположную.
3. Синаптические веса индикаторов корректируются аналогично, но без ограничений по диапазону.
4. Запомненные сигналы очищаются, чтобы не использовать их повторно.

Такое обобщение заменяет тысячи строк условных операторов в исходном советнике.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | Таймфрейм 1 минута | Тип свечей для подписки. |
| `FastMaLength` | 5 | Период быстрой SMA. |
| `SlowMaLength` | 9 | Период медленной SMA. |
| `RsiLength` | 14 | Период RSI. |
| `CciLength` | 14 | Период CCI. |
| `SlopeMaLength` | 5 | Период SMA для оценки наклона. |
| `AoShortLength` | 5 | Короткий период осциллятора Awesome. |
| `AoLongLength` | 34 | Длинный период осциллятора Awesome. |
| `StopLossOffset` | 0.001 | Дистанция стоп-лосса в абсолютных единицах (0 отключает уровень). |
| `TakeProfitOffset` | 0.0004 | Дистанция тейк-профита (0 отключает уровень). |
| `SinMax` | 5 | Верхняя граница смещений нейронов. |
| `SinMin` | 0 | Нижняя граница смещений. |
| `SinPlusStep` | 0.03 | Шаг положительного подкрепления. |
| `SinMinusStep` | 0.03 | Шаг отрицательного подкрепления. |

Все параметры оформлены через `StrategyParam<T>` и доступны для оптимизации в Designer.

## Особенности реализации

- Используется высокоуровневый API подписки на свечи с одновременной привязкой нескольких индикаторов.
- Управление сделками выполняется вручную, чтобы точно знать цену выхода при обновлении весов.
- Хранение предыдущих значений реализовано через `nullable`-поля, что исключает преждевременное срабатывание сигналов.
- Цвет гистограммы Awesome Oscillator приближённо определяется сравнением текущего и предыдущего столбцов.
- На графике отображаются свечи, скользящие средние и собственные сделки стратегии.

## Ограничения

- Стопы и цели проверяются лишь по завершённой свече, поэтому порядок событий внутри бара неизвестен; приоритет отдаётся тейк-профиту.
- Весовые коэффициенты индикаторов не ограничены и могут существенно увеличиваться при длительных сериях прибыльных/убыточных сделок.
- В оригинале переменная `LastTradeType` не сбрасывалась; в порте она обнуляется после каждого выхода, что позволяет повторять сделки в том же направлении.

