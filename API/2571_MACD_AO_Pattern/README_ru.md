# Стратегия MACD AO Pattern

## Общее описание
Стратегия представляет собой перенос экспертного советника FORTRADER `MACD.mq5` на платформу StockSharp. Реализован паттерн «AOP»: после сильного отклонения MACD от нулевой линии система ждёт возврата индикатора к нейтральной зоне, подтверждает «крючок» и входит в сделку в сторону разворота. Сразу выставляются фиксированные стоп-лосс и тейк-профит в пунктах.

## Логика стратегии
### Подготовка данных
- Работа ведётся по серии свечей из параметра `CandleType` (по умолчанию 5 минут).
- Используется стандартный MACD с настраиваемыми периодами быстрой, медленной и сигнальной EMA (значения 12/26/9).
- Хранятся значения главной линии MACD трёх последних завершённых свечей, что повторяет обращение `iMACD(...,1..3)` в MQL.

### Условия для продаж (медвежий крючок)
1. **Подготовка** – когда MACD последней закрывшейся свечи опускается ниже `BearishExtremeLevel` (−0.0015 по умолчанию), включается наблюдение за разворотом.
2. **Возврат к нейтрали** – подъём MACD выше `BearishNeutralLevel` (−0.0005) переводит схему в режим подтверждения крючка.
3. **Подтверждение** – три сохранённых значения должны образовать локальный максимум (`macd₁ < macd₂ > macd₃`) при условии, что последнее значение остаётся ниже нейтрального уровня, а предыдущее – выше него.
4. **Вход** – если нет длинной позиции (`Position <= 0`), отправляется рыночная продажа объёмом `OrderVolume`. Одновременно рассчитываются стоп-лосс и тейк-профит, используя параметры `StopLossPips` и `TakeProfitPips` и функцию пересчёта `GetPipSize`.
5. Появление положительного значения MACD сбрасывает медвежье состояние до следующего глубокого ухода вниз.

### Условия для покупок (бычий крючок)
1. **Подготовка** – превышение `BullishExtremeLevel` (+0.0015) активирует ожидание разворота вверх.
2. **Мгновенное обнуление** – падение MACD ниже нуля моментально отменяет сценарий, как и в оригинале.
3. **Возврат к нейтрали** – снижение ниже `BullishNeutralLevel` (+0.0005) позволяет перейти к проверке крючка.
4. **Подтверждение** – три значения MACD должны сформировать локальный минимум (`macd₁ > macd₂ < macd₃`) при соблюдении нейтральных порогов.
5. **Вход** – при отсутствии короткой позиции (`Position >= 0`) выполняется покупка по рынку с теми же фиксированными стопом и тейком.

### Управление рисками
- Цены `_stopPrice` и `_takePrice` рассчитываются сразу после входа и проверяются на каждой закрывшейся свече по её максимуму/минимуму, что имитирует серверное исполнение исходного робота.
- Перевод пунктов в цену строится на `Security.PriceStep`; для инструментов с 3 и 5 знаками шаг умножается на 10 — так же, как делал MQL при работе с fractional pip.
- После закрытия позиции защитные уровни обнуляются, стратегия ожидает новой последовательности сигналов.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Тип свечей, используемых в расчётах. | 5-минутные свечи |
| `OrderVolume` | Объём каждой рыночной заявки. | 0.1 |
| `TakeProfitPips` | Тейк-профит в пунктах (доступен для оптимизации). | 60 |
| `StopLossPips` | Стоп-лосс в пунктах (доступен для оптимизации). | 70 |
| `MacdFastPeriod` | Период быстрой EMA MACD. | 12 |
| `MacdSlowPeriod` | Период медленной EMA MACD. | 26 |
| `MacdSignalPeriod` | Период сигнальной EMA MACD. | 9 |
| `BearishExtremeLevel` | Отрицательный порог для активации продаж. | −0.0015 |
| `BearishNeutralLevel` | Отрицательный порог для подтверждения медвежьего крючка. | −0.0005 |
| `BullishExtremeLevel` | Положительный порог для активации покупок. | +0.0015 |
| `BullishNeutralLevel` | Положительный порог для подтверждения бычьего крючка. | +0.0005 |

## Дополнительные замечания
- Обработка выполняется только на завершённых свечах, что соответствует защите `PrevBars` в MQL.
- Используются исключительно фиксированные стоп и тейк без трейлинга и без повторного входа до полного завершения цикла сигналов.
- Исходный советник рассчитан на хеджинговые счета, но реализация на StockSharp контролирует, чтобы одновременно была только одна чистая позиция.
- Python-версия по заданию не создавалась.
