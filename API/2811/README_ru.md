# Стратегия Universal Trailing Manager

## Описание

**Universal Trailing Manager Strategy** — портированная на C# версия советника MetaTrader “Universal 1.64 (редакция barabashkakvn)”.
Стратегия автоматизирует сопровождение позиций: выполняет запланированные действия по времени, выставляет и сопровождает
отложенные заявки, тянет защитные уровни для рыночных сделок, фиксирует небольшую прибыль и отслеживает изменение капитала
портфеля в процентах.

Решение не использует индикаторы и работает исключительно на основе данных свечей, поэтому подходит в качестве универсального
модуля управления позициями в проектах на StockSharp.

## Основные возможности

- **Планировщик по времени** — открытие рыночных позиций и/или постановка отложенных заявок в заданный час и минуту терминала.
- **Грид из отложенных заявок** — поддержка по одной заявке каждого типа (Buy Limit, Sell Limit, Buy Stop, Sell Stop) с отдельными
  настройками смещения, стопов и трейлингом.
- **Защита рыночных позиций** — автоматическая постановка стоп-лоссов/тейк-профитов и их динамическое перемещение по правилу
  трейлинга с возможностью ожидания минимальной прибыли.
- **Быстрый выход** — закрытие позиции при достижении фиксированного числа пунктов прибыли относительно средней цены входа.
- **Глобальные уведомления** — контроль текущей стоимости портфеля и логирование события при росте или падении на заданный процент.
- **Ограничение по количеству позиций** — режим “ждать закрытия” и предел на количество одновременно открытых сделок в каждом
  направлении.

## Настройки

| Группа | Параметр | Назначение |
|--------|----------|------------|
| Общие | `TradeVolume` | Объём заявок (лоты) для рыночных и отложенных сделок. |
| Общие | `WaitClose` | Разрешать новые сделки только при числе позиций < `MaxMarketPositions`. |
| Рыночные | `MaxMarketPositions` | Максимальное количество одновременных сделок в одном направлении при включённом `WaitClose`. |
| Рыночные | `MarketTakeProfitPoints` | Тейк-профит в пунктах для рыночной позиции (0 — нет тейка). |
| Рыночные | `MarketStopLossPoints` | Стоп-лосс в пунктах для рыночной позиции (0 — нет стопа). |
| Рыночные | `MarketTrailingStopPoints` | Дистанция трейлинга (пункты). 0 отключает трейлинг. |
| Рыночные | `MarketTrailingStepPoints` | Минимальное улучшение (пункты) для сдвига трейлинга. |
| Рыночные | `WaitForProfit` | Начинать трейлинг только после достижения прибыли в `MarketTrailingStopPoints`. |
| Рыночные | `ScalpProfitPoints` | Закрыть позицию при прибыли в указанное число пунктов (0 — отключено). |
| Отложенные | `AllowBuyLimit`, `AllowSellLimit`, `AllowBuyStop`, `AllowSellStop` | Основные переключатели каждого типа отложенных заявок. |
| Отложенные | `LimitOrderOffsetPoints`, `StopOrderOffsetPoints` | Смещение цены от текущего закрытия, в пунктах. |
| Отложенные | `LimitOrderTakeProfitPoints`, `StopOrderTakeProfitPoints` | Тейк-профит (пункты) после срабатывания отложенной заявки. |
| Отложенные | `LimitOrderStopLossPoints`, `StopOrderStopLossPoints` | Стоп-лосс (пункты) после срабатывания отложенной заявки. |
| Отложенные | `LimitOrderTrailingStopPoints`, `StopOrderTrailingStopPoints` | Дистанция трейлинга для активной отложенной заявки (0 — выключено). |
| Отложенные | `LimitOrderTrailingStepPoints`, `StopOrderTrailingStepPoints` | Минимальный шаг пересчёта при трейлинге отложенной заявки. |
| Время | `UseTime` | Включить блок действий по расписанию. |
| Время | `TimeHour`, `TimeMinute` | Час и минутa серверного времени для срабатывания. |
| Время | `TimeBuy`, `TimeSell` | Открыть рыночную покупку/продажу в момент времени. |
| Время | `TimeBuyLimit`, `TimeSellLimit`, `TimeBuyStop`, `TimeSellStop` | Принудительно поставить соответствующую отложенную заявку в момент времени. |
| Глобальные | `UseGlobalLevels` | Включить отслеживание изменения капитала. |
| Глобальные | `GlobalTakeProfitPercent`, `GlobalStopLossPercent` | Проценты роста/падения портфеля для уведомления. |
| Данные | `CandleType` | Тип свечей, по которым выполняется логика (по умолчанию 1 минута). |

## Логика работы

1. **Получение свечи** — на закрытии каждой свечи обновляются ссылки на заявки, сбрасываются временные сигналы и запускается логика.
2. **Проверка расписания** — если время закрытия совпадает с заданными часом и минутой, стратегия выполняет соответствующие действия
   (рыночные или отложенные заявки).
3. **Управление отложенными заявками** — по одной активной заявке каждого типа; при выполнении условий трейлинга заявка снимается и
   размещается ближе к цене.
4. **Защита позиций** — создаются и переносятся стоп-лосс/тейк-профит для текущей позиции с учётом настроек трейлинга.
5. **Быстрый выход** — при достижении параметра `ScalpProfitPoints` позиция закрывается по рынку.
6. **Глобальные уровни** — каждый цикл проверяется стоимость портфеля и при первом достижении порога выводится сообщение в лог.

## Рекомендации

- Стратегия работает на закрытии свечей, поэтому для оперативного трейлинга используйте небольшие таймфреймы (1 минута и т.п.).
- Переход из лонга в шорт или наоборот выполняется через увеличение объёма заявки так, чтобы закрыть прежнюю позицию и открыть новую.
- Все расстояния задаются в пунктах, равных `Security.PriceStep`. Убедитесь, что шаг цены инструмента задан корректно.
- Функция глобального контроля лишь информирует в логах, не закрывая позиции автоматически — поведение идентично оригинальному советнику.
- При включённом `WaitClose` точность ограничения по количеству позиций зависит от стабильного использования одинакового объёма `TradeVolume`.

## Журнал

Стратегия пишет ключевые действия (`LogInfo`): постановка/перенос заявок, изменения стопов, срабатывание глобальных уровней.
Используйте журнал для диагностики и настройки параметров.

