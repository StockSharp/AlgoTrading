# Viva Las Vegas 策略

## 概述
Viva Las Vegas 是一个充满娱乐性的资金管理专家顾问，它会在每次机会随机选择做多或做空，然后交由五种经典的倍投系统之一来决定下一笔仓位的大小。StockSharp 版本完整保留了原始 MetaTrader 行为：
- 每次尝试都会通过伪随机掷硬币选择方向。
- 立即按照点数距离放置对称的止损和止盈保护。
- 一旦上一笔仓位平仓，就立刻更新资金管理序列并打开新的仓位。

因此策略始终保持单笔持仓，便于观察不同投注系统在 StockSharp 交易框架中的表现。

## 资金管理模块
`MoneyManagement` 参数从以下倍投模型中进行选择，所有模型都以 `BaseVolume` 作为基准手数：

1. **Martingale（马丁格尔）** – 每次亏损后将手数加倍，盈利后恢复到基准手数。
2. **Negative Pyramid（反金字塔）** – 亏损后手数加倍，盈利后手数减半，但不会低于基准手数。
3. **Labouchere（拉布歇尔）** – 维护一个数字序列（默认 `1-2-3`），下注时取首尾数字之和；盈利后移除首尾，亏损后将两者之和追加到序列末尾。
4. **Oscar’s Grind（奥斯卡推进）** – 盈利时按基准手数逐步提高仓位，直到累计盈利达到一个基准手数后重置；亏损只会减小运行中的盈利值。
5. **31 System（31 系统）** – 在序列 `1,1,1,2,2,4,4,8,8` 中循环，第一次盈利会把当前数值翻倍，第二次连续盈利后重置到序列开头。

所有模块都遵循原始 MQL 实现的细节，包括将收益为零的交易视为亏损。

## 交易流程
1. 启动时根据 `Seed` 参数初始化伪随机数生成器（`Seed = 0` 时使用时间作为种子），并通过 `StartProtection` 打开对称的止损和止盈。
2. 当没有持仓且没有挂单时，策略向当前资金管理模块请求下一笔手数，将结果按标的物的 `VolumeStep` 四舍五入，然后抛硬币决定是 `BuyMarket` 还是 `SellMarket`。
3. 仓位建立后，由保护模块根据设定的点数距离管理退出。
4. 仓位回到零时，比较新的 `PnL` 与上一笔交易时的基准值：
   - 利润 &gt; 0 → 发送 **win**（盈利）通知。
   - 利润 ≤ 0 → 发送 **loss**（亏损）通知。
5. 周期立即重新开始，因此策略要么持有单笔仓位，要么正等待新的随机入场。

由于任意时刻只有一笔仓位，策略在图表上的表现与原始 EA 的单票模式完全一致。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `StopTakePips` | `int` | `50` | 以点为单位的止损/止盈距离，通过 `StartProtection` 同步应用到保护单。 |
| `BaseVolume` | `decimal` | `1` | 资金管理算法使用的基准手数。 |
| `MoneyManagement` | `MoneyManagementMode` | `Martingale` | 控制下一笔下单手数的倍投模型。 |
| `Seed` | `int` | `0` | 伪随机数种子，设置为 0 时采用时间戳保证每次运行结果不同。 |

## 实现说明
- 手数会按 `VolumeStep` 对齐，并检查 `MinVolume` / `MaxVolume` 限制，避免因手数非法而被交易所拒单。
- 止损/止盈距离采用 MetaTrader 的传统换算方式：报价小数位为 3 或 5 时，一个点等于 10 个最小跳动。
- 盈亏通过策略的 `PnL` 属性计算，从而让保护单和平仓动作与原始 EA 一样影响资金管理序列。
- 代码中的英文注释标明了关键决策节点，便于学习或修改成其它实验策略。

## 使用建议
- 建议在模拟账户或行情回放环境中运行，此类倍投策略风险极高，仅适合实验用途。
- 启动前请将 `BaseVolume` 调整到符合标的物的合约最小单位。
- 搭配 StockSharp 图表可以直观观察不同资金管理模型如何扩张或收缩仓位规模。
