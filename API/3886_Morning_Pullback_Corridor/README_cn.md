# 晨间回撤通道策略

## 概述
**晨间回撤通道策略** 复现了 MetaTrader 4 专家顾问 “3_Otkat_Sys_v1_2” 的逻辑。策略只在清晨时段工作，分析相隔 29 根 K 线的价格走廊，寻找夜间大幅运动后的回撤机会，并为多空仓位分别设置非对称的止盈水平。

## 交易逻辑
1. **时间过滤** —— 仅在设定的交易小时内（默认平台时间 05:00）且该小时的前几分钟内评估信号；与原版 EA 一样会跳过周一和周五。
2. **价格走廊计算** —— 对每一根已完成的 K 线维护滚动窗口，比较以下价格差：
   - 29 根之前的开盘价与上一根 K 线的收盘价（`Open[29] - Close[1]`），
   - 上一根 K 线的收盘价与 29 根之前的开盘价（`Close[1] - Open[29]`），
   - 上一根收盘价到最近 29 根 K 线最低价的距离，
   - 最近 29 根 K 线最高价到上一根收盘价的距离。
3. **入场条件** —— 当隔夜波动超过 `CorridorOpenClosePoints` 阈值且最近回撤落在 `PullbackPoints ± CorridorPullbackPoints` 区间内时，在晨间时段以市价入场：
   - 多头信号需要夜间下跌后出现浅回撤，或上涨后继续向上突破通道；
   - 空头信号则是上述逻辑的镜像。
4. **仓位管理** —— 每笔交易同时设置：
   - 以 `StopLossPoints * PriceStep` 计算的止损；
   - 空单使用 `TakeProfitPoints * PriceStep` 止盈，多单在此基础上再加上 `LongTakeProfitExtraPoints`。
5. **日终平仓** —— 超过设定的日终阈值（默认 22:45 之后）仍未平仓的持仓会被强制平掉，避免隔夜持仓。

## 参数说明
| 参数 | 说明 |
|------|------|
| `TakeProfitPoints` | 基础止盈距离（点），适用于空单；多单额外加上 `LongTakeProfitExtraPoints`。 |
| `StopLossPoints` | 止损距离（点）。 |
| `PullbackPoints` | 期望的回撤深度，用于评估信号。 |
| `CorridorOpenClosePoints` | 29 根间隔的开盘/收盘差必须达到的最小值，用于确认隔夜动量。 |
| `CorridorPullbackPoints` | 回撤阈值的容差，用来构造入场通道。 |
| `LongTakeProfitExtraPoints` | 多单止盈在基础值上额外增加的点数。 |
| `TradeHour` | 允许开新仓的小时（0–23）。 |
| `TradeMinuteLimit` | 在交易小时内允许信号出现的最大分钟数。 |
| `CloseHour` | 开始检查强制平仓的小时。 |
| `CloseMinuteThreshold` | 在 `CloseHour` 中超过该分钟数即强制平仓。 |
| `CandleType` | 使用的 K 线时间框架（默认 1 分钟）。 |

## 实现细节
- 策略依赖 `Security.PriceStep` 将点数转换为绝对价格，若品种未提供有效步长则退化为 `1.0`。
- 每根已完成的 K 线都会检查止损/止盈，一旦价格在该 K 线范围内触发即用市价单平仓。
- 滚动窗口保存最近 60 根 K 线，既满足 29 根的计算需求，也模拟 MQL 中 `Lowest/Highest` 函数的行为。
- 若宿主平台创建了图表区域，策略会自动绘制行情 K 线与自身成交。

## 使用建议
- 启动策略前请设置 `Volume`（手数）；原始 EA 不会动态调整仓位规模。
- 确认数据源的时区与原始 EA 期望一致，以便获得相同的交易时间过滤效果。
- 在不同波动特性的市场上使用时，建议重新优化通道相关参数，因为默认点数针对原始品种调校。
