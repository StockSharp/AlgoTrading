# Утренняя стратегия отката в ценовом коридоре

## Обзор
**Утренняя стратегия отката в ценовом коридоре** воспроизводит работу эксперта MetaTrader 4 «3_Otkat_Sys_v1_2». Она анализирует импульс, возникший за ночь, и торгует только в первые минуты утренней сессии, оценивая коррекцию относительно коридора, построенного по свечам с интервалом в 29 баров. Для длинных и коротких позиций задаются разные уровни фиксации прибыли.

## Торговая логика
1. **Фильтр по времени** — сигналы рассматриваются лишь в заданный час (по умолчанию 05:00 по времени терминала) и только в первые минуты этого часа. Как и в оригинале, понедельник и пятница исключаются.
2. **Расчёт ценового коридора** — стратегия хранит скользящее окно последних свечей и сравнивает:
   - открытие 29 баров назад с закрытием предыдущей свечи (`Open[29] - Close[1]`),
   - закрытие предыдущей свечи с открытием 29 баров назад (`Close[1] - Open[29]`),
   - расстояние от предыдущего закрытия до минимального минимума за последние 29 баров,
   - расстояние от максимума за тот же период до предыдущего закрытия.
3. **Условия входа** — если ночной импульс превосходит порог `CorridorOpenClosePoints`, а текущий откат попадает в диапазон `PullbackPoints ± CorridorPullbackPoints`, открывается рыночная позиция:
   - Для покупок требуется либо ночное падение с неглубокой коррекцией, либо продолжение роста выше коридора.
   - Для продаж используется зеркальный набор условий.
4. **Управление позицией** — при открытии сделки устанавливаются:
   - стоп-лосс на расстоянии `StopLossPoints * PriceStep` от цены входа,
   - тейк-профит на уровне `TakeProfitPoints * PriceStep` для коротких и `(TakeProfitPoints + LongTakeProfitExtraPoints) * PriceStep` для длинных позиций.
5. **Закрытие в конце дня** — если к моменту, превышающему заданный порог (по умолчанию после 22:45), позиция остаётся открытой, она закрывается принудительно.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TakeProfitPoints` | Базовая дистанция тейк-профита в пунктах. Для покупок добавляется `LongTakeProfitExtraPoints`. |
| `StopLossPoints` | Дистанция защитного стопа в пунктах. |
| `PullbackPoints` | Целевая глубина отката, вокруг которой анализируются условия входа. |
| `CorridorOpenClosePoints` | Минимальная разница между ценами, разделёнными 29 барами, подтверждающая ночной импульс. |
| `CorridorPullbackPoints` | Допуск, добавляемый к целевому откату для формирования коридора. |
| `LongTakeProfitExtraPoints` | Дополнительные пункты тейк-профита для длинных позиций. |
| `TradeHour` | Час (0–23), в течение которого разрешено открывать новые позиции. |
| `TradeMinuteLimit` | Максимальная минута внутри торгового часа, допускающая появление сигнала. |
| `CloseHour` | Час, начиная с которого проверяется условие принудительного закрытия. |
| `CloseMinuteThreshold` | Минута внутри `CloseHour`, после которой позиция закрывается. |
| `CandleType` | Используемый таймфрейм свечей (по умолчанию 1 минута). |

## Особенности реализации
- Для перевода точечных значений в абсолютные цены используется `Security.PriceStep`. При отсутствии корректного шага цена по умолчанию принимается равной `1.0`.
- Стоп-лосс и тейк-профит контролируются на каждой завершённой свече: при пробое уровня сделка закрывается рыночным ордером.
- Список хранит последние 60 свечей, что покрывает требуемые 29 баров и имитирует функции `Lowest/Highest` из MQL.
- При наличии графической области настраиваемый компонент автоматически рисует свечи и сделки стратегии.

## Рекомендации по использованию
- Перед запуском задайте величину `Volume` — советник не меняет размер позиции динамически.
- Согласуйте часовой пояс данных с тем, который использовался в оригинальной системе, чтобы временные фильтры срабатывали корректно.
- Пороговые значения, выраженные в пунктах, необходимо оптимизировать для инструментов с другой волатильностью.
