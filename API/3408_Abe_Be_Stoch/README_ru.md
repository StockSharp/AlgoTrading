# Стратегия ABE BE Stochastic Engulfing
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник MetaTrader **Expert_ABE_BE_Stoch** на высокоуровневый API StockSharp. Она сочетает анализ японских свечей и осциллятора Стохастик, чтобы ловить развороты в зонах перепроданности и перекупленности. Основной сигнал формируется, когда бычье поглощение подтверждается глубоким значением `%D` ниже порога перепроданности, либо медвежье поглощение поддерживается `%D` выше порога перекупленности. Управление позицией осуществляется через пересечения уровней 20 и 80 Стохастика, что воспроизводит систему «голосов» оригинального эксперта.

Алгоритм может открывать как длинные, так и короткие позиции. Он анализирует только завершённые свечи, избегая шума внутри бара. Размер позиции задаётся свойством `Volume`, а опциональные стоп-лосс и тейк-профит преобразуют исходные настройки в пунктах в объекты `Unit` с типом `UnitTypes.Price`.

## Как работает стратегия

1. **Подписка на данные** – создаётся подписка на выбранный таймфрейм и инициализируется `StochasticOscillator` с параметрами `%K`, `%D` и замедлением.
2. **Распознавание паттерна** – на каждой закрытой свече проверяется, поглощает ли её тело тело предыдущей свечи. Вспомогательные методы воспроизводят определения бычьего и медвежьего поглощения из MetaTrader.
3. **Подтверждение импульса** – линия `%D` служит фильтром подтверждения: значения ниже порога перепроданности (по умолчанию 30) обязательны для бычьего сигнала, а значения выше порога перекупленности (по умолчанию 70) – для медвежьего.
4. **Управление позицией** – кэшируется предыдущее значение `%D`. Если новая точка пересекает вверх уровень 20 или 80, все короткие позиции закрываются. При пересечении вниз тех же уровней закрываются длинные позиции. Это повторяет добавочные «голоса» на закрытие из MQL-реализации.
5. **Контроль риска** – при ненулевых значениях стопа или тейка (в шагах цены) они переводятся в `Unit` и передаются в `StartProtection`. Если расстояния равны нулю, вызывается `StartProtection()` без параметров.

## Торговые правила

- **Вход в лонг**: предыдущая свеча медвежья, текущая бычья, её тело полностью покрывает тело предыдущей свечи, а `%D` ниже `EntryOversoldLevel` (30 по умолчанию). Любой шорт закрывается и открывается новая длинная позиция через `BuyMarket`.
- **Вход в шорт**: предыдущая свеча бычья, текущая медвежья, её тело поглощает предыдущее, а `%D` выше `EntryOverboughtLevel` (70 по умолчанию). Любая длинная позиция закрывается и открывается новый шорт через `SellMarket`.
- **Выход из лонга**: при открытом лонге пересечение `%D` вниз через `ExitUpperLevel` (80 по умолчанию) или `ExitLowerLevel` (20) приводит к продаже всей позиции.
- **Выход из шорта**: при открытом шорте пересечение `%D` вверх через `ExitLowerLevel` или `ExitUpperLevel` закрывает позицию покупкой.
- **Стопы/тейки**: параметры `StopLossPoints` и `TakeProfitPoints` задают расстояние в шагах цены. Значение 0 отключает соответствующую защиту.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | `TimeSpan.FromHours(1).TimeFrame()` | Источник свечей для анализа паттернов. |
| `StochasticPeriodK` | `int` | `47` | Период расчёта быстрой линии `%K`. |
| `StochasticPeriodD` | `int` | `9` | Период сглаживания линии `%D`. |
| `StochasticPeriodSlow` | `int` | `13` | Дополнительное сглаживание `%K` перед построением `%D`. |
| `EntryOversoldLevel` | `decimal` | `30` | Верхний предел `%D` для допуска бычьего поглощения. |
| `EntryOverboughtLevel` | `decimal` | `70` | Нижний предел `%D` для допуска медвежьего поглощения. |
| `ExitLowerLevel` | `decimal` | `20` | Уровень, пересечение вверх которого закрывает шорты, а вниз — лонги. |
| `ExitUpperLevel` | `decimal` | `80` | Уровень перекупленности, используемый аналогично `ExitLowerLevel`. |
| `TakeProfitPoints` | `decimal` | `0` | Дистанция до тейк-профита в шагах цены (0 отключает). |
| `StopLossPoints` | `decimal` | `0` | Дистанция до стоп-лосса в шагах цены (0 отключает). |

## Дополнительно

- По умолчанию используется часовой таймфрейм, но стратегия применима к любым OHLC-данным.
- Расчёты выполняются только на закрытых свечах для соответствия логике оригинального эксперта.
- Размер позиции задаётся пользователем через `Volume` или внешние механизмы управления капиталом.
