# Стратегия "Bullish & Bearish Engulfing"

## Общее описание
Данная стратегия переносит на StockSharp эксперта MetaTrader «Bullish and Bearish Engulfing». Алгоритм анализирует завершённые свечи выбранного таймфрейма, позволяет пропускать несколько последних баров и реагирует только тогда, когда сформировавшийся паттерн «бычьего/медвежьего поглощения» удовлетворяет дополнительному фильтру по дистанции. Решение предназначено для трейдеров, которые торгуют свечные модели и хотят автоматизировать их обработку, не теряя контроля над направлением сделок, объёмом и управлением текущих позиций.

## Условия распознавания паттерна
После учёта параметра смещения стратегия проверяет две последовательные завершённые свечи:

- **Бычье поглощение**
  - Текущая оцениваемая свеча закрывается выше открытия (бычье тело).
  - Предыдущая свеча закрывается ниже открытия (медвежье тело).
  - Максимум текущей свечи выше предыдущего максимума, а минимум ниже предыдущего минимума как минимум на величину фильтра.
  - Закрытие бычьей свечи выше открытия предыдущей, а её открытие ниже предыдущего закрытия — также с учётом фильтра.
- **Медвежье поглощение**
  - Текущая свеча закрывается ниже открытия (медвежье тело).
  - Предыдущая свеча закрывается выше открытия (бычье тело).
  - Новая свеча делает более высокий максимум, но закрывается значительно ниже предыдущего открытия и открывается выше предыдущего закрытия — все сравнения проводятся с поправкой на фильтр.
  - Минимум текущей свечи ниже предыдущего минимума не менее чем на заданную дистанцию.

Эти критерии полностью повторяют оригинальный код для MetaTrader, где требовалось, чтобы свеча-поглотитель полностью перекрывала тело предыдущей и одновременно пробивала оба экстремума. Параметр дистанции задаётся в пунктах (pips) и автоматически переводится в цену с учётом `PriceStep` и количества знаков у инструмента (для 5- и 3-значных валютных котировок используется множитель 10).

## Логика работы
1. Через высокоуровневый API выполняется подписка на выбранный тип свечей; обрабатываются только свечи с состоянием `Finished`.
2. Ведётся небольшой буфер с OHLC-значениями, достаточный для текущего смещения.
3. Как только в буфере есть минимум две подходящие свечи, проверяются условия бычьего и медвежьего поглощения.
4. При бычьем сигнале создаётся рыночная заявка на сторону, указанную в параметре **BullishSide**; при медвежьем сигнале используется значение **BearishSide**.
5. Если включён флаг **CloseOppositePositions**, наличие противоположной позиции приводит к увеличению объёма заявки на абсолютный размер позиции — таким образом противоположная позиция закрывается и сразу открывается новая в нужном направлении. Когда флаг выключен, сигналы игнорируются до тех пор, пока противоположная позиция не будет закрыта вручную.
6. Объём сделки задаётся параметром **Volume** (по умолчанию 1). Стратегия не добавляет стоп-лосс или тейк-профит автоматически — управление рисками должно быть настроено отдельно либо через защитные модули StockSharp (например, `StartProtection`).

## Параметры
| Параметр | Описание | Значение по умолчанию | Примечания |
|----------|----------|-----------------------|------------|
| `CandleType` | Тип свечей (`DataType`), используемый для поиска сигналов. | Свечи 1 часа | Можно выбрать любой поддерживаемый таймфрейм. |
| `Shift` | Количество завершённых свечей, которые следует пропустить перед оценкой паттерна. | 1 | Значение 1 анализирует последнюю закрытую свечу; большие значения смещают анализ в прошлое. |
| `DistanceInPips` | Минимальная дистанция в пунктах между свечами поглощения. | 0 | Переводится в цену через шаг цены инструмента; помогает отсечь свечи с маленьким телом. |
| `CloseOppositePositions` | Нужно ли закрывать противоположные позиции перед входом. | `true` | При `false` сигнал пропускается, если открыта позиция противоположного направления. |
| `BullishSide` | Направление заявки при бычьем поглощении. | `Buy` | Можно переключить на `Sell` для контртрендовой торговли. |
| `BearishSide` | Направление заявки при медвежьем поглощении. | `Sell` | Можно переключить на `Buy`, чтобы торговать против тренда. |
| `Volume` | Базовый объём заявки. | 1 | При закрытии обратной позиции к объёму добавляется `abs(Position)`. |

## Управление позицией и рисками
- Сделки исполняются рыночными ордерами без встроенных защитных уровней. Рекомендуется подключать защитные модули или внешние ограничения риска.
- В оригинальной MQL-версии объём рассчитывался через модуль Money Management. В портированной стратегии используется фиксированное значение `Volume`, что делает поведение предсказуемым в StockSharp; при необходимости добавьте собственный блок управления капиталом.
- При активном параметре `CloseOppositePositions` разворот выполняется одной сделкой: объём равен базовому значению плюс абсолютная текущая позиция, что обеспечивает немедленный переход из старого направления в новое.

## Структура файлов
- `CS/BullishBearishEngulfingStrategy.cs` — C# реализация, использующая высокоуровневый API стратегий StockSharp.

> **Важно:** Python-версия и соответствующая папка не создавались в рамках данной задачи — предоставлена только C# реализация.
