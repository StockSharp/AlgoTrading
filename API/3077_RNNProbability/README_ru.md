# Стратегия RNN Probability

## Обзор
Стратегия RNN Probability — это конвертация эксперта MetaTrader *RNN (barabashkakvn's edition)*. Оригинальный робот считывает три значения RSI, разделённых длиной индикатора, и прогоняет их через решётку вероятностей, имитирующую рекуррентную нейросеть. Порт на StockSharp воспроизводит ту же логику через подписку на свечи высокого уровня, автоматически переводя понятия MetaTrader (лоты, пункты, стопы) в объекты StockSharp.

После появления значения RSI для последней завершённой свечи стратегия обращается к значениям RSI на одну и две длины индикатора назад. Нормированные показания объединяются с восемью весами (`Weight0` … `Weight7`), заданными в исходном советнике, чтобы получить вероятность снижения цены. Вероятность преобразуется в диапазон `[-1; 1]`, и знак результата определяет открытие длинной или короткой позиции. Одновременно держится только одна позиция, что соответствует оригинальной реализации.

## Логика торговли
1. Подписаться на выбранный тип свечей и вручную обновлять индикатор `RelativeStrengthIndex`, используя параметр `AppliedPrice` (по умолчанию — цена открытия).
2. Сохранять завершённые значения RSI в скользящем буфере, достаточном для доступа к показаниям на одну и две длины индикатора назад.
3. Нормировать три значения RSI в диапазон `[0; 1]` и вычислить решётку вероятностей:
   - Первая ветка (`Weight0`, `Weight1`, `Weight2`, `Weight3`) активна, если текущее значение RSI ниже середины диапазона (ниже 50).
   - Вторая ветка (`Weight4`, `Weight5`, `Weight6`, `Weight7`) активна, если текущее значение RSI выше середины.
4. Преобразовать полученную вероятность в торговый сигнал между `-1` и `+1`.
5. Если позиция отсутствует и сигнал отрицательный, купить `TradeVolume` лотов. Если сигнал неотрицательный, продать `TradeVolume` лотов.
6. При необходимости активировать симметричные стоп-лосс и тейк-профит в пунктах. Стратегия автоматически пересчитывает расстояние в абсолютное смещение цены и учитывает поправку MetaTrader для 3- и 5-значных форекс-котировок.
7. Записывать в журнал RSI-входы, вероятность и итоговый сигнал, сохраняя информативность исходного советника.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | Таймфрейм 1 час | Основная серия свечей для расчётов и сигналов. |
| `TradeVolume` | `decimal` | `1` | Объём заявки в лотах. |
| `RsiPeriod` | `int` | `9` | Период RSI. Определяет интервал между историческими выборками. |
| `AppliedPrice` | `AppliedPriceType` | `Open` | Компонент цены, подаваемый в RSI (Open, Close, High, Low, Median, Typical, Weighted). |
| `StopLossTakeProfitPips` | `decimal` | `100` | Расстояние до стоп-лосса и тейк-профита в пунктах. Ноль отключает защитные ордера. |
| `Weight0` … `Weight7` | `decimal` | `6, 96, 90, 35, 64, 83, 66, 50` | Весовые коэффициенты решётки вероятностей. Каждое значение — процент от 0 до 100. |

## Отличия от оригинального эксперта MetaTrader
- Удалены email-уведомления — детальный лог StockSharp обеспечивает ту же информативность без SMTP.
- Объём позиции фиксирован `TradeVolume`. Частичное закрытие и наращивание позиции не реализованы, как и в исходнике.
- Данные индикатора поступают через высокоуровневую подписку на свечи, что исключает прямые вызовы `CopyBuffer` и ручную работу с массивами.
- Конвертация пунктов использует `PriceStep` инструмента и автоматически учитывает дополнительные знаки, вместо жёстко заданных размеров тика.

## Рекомендации по использованию
- Перед запуском согласуйте `TradeVolume` с минимальным шагом лота инструмента; значение также копируется в `Strategy.Volume`.
- Настраивайте восемь весов в процессе оптимизации, чтобы адаптировать решётку вероятностей под другие рынки.
- Уменьшайте `StopLossTakeProfitPips` или ставьте ноль при работе с широкими спредами или ручными выходами.
- Добавьте стратегию на график, чтобы наблюдать свечи, RSI и сделки и быстрее проверять корректность сигналов.

## Индикаторы
- Один `RelativeStrengthIndex`, рассчитанный по выбранной цене.
