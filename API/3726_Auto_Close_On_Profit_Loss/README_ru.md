# Стратегия автоматического закрытия по прибыли/убытку
[English](README.md) | [中文](README_cn.md)

Эта утилитарная стратегия непрерывно отслеживает плавающую прибыль и убыток текущего портфеля и автоматически закрывает все открытые позиции при достижении заданного уровня прибыли или ограничителя по убытку. Стратегия представляет собой порт оригинального советника MetaTrader «AutoCloseOnProfitLoss» для платформы StockSharp.

Стратегия не открывает сделки самостоятельно. Она выступает в роли надстройки управления риском и прибылью: контролирует уже существующие позиции и отправляет рыночные заявки на их закрытие, когда выполняются заданные денежные условия.

## Подробности

- **Условия входа**: отсутствуют. Стратегия не открывает позиции.
- **Длинные/короткие позиции**: обе. Закрываются любые активные позиции в портфеле.
- **Условия выхода**:
  - Все позиции закрываются, когда плавающая прибыль больше или равна `TargetProfit`, и при этом параметр `EnableProfitClose` включен.
  - Все позиции закрываются, когда плавающий убыток меньше или равен `MaxLoss` (отрицательное значение) при включенном параметре `EnableLossClose`.
  - Плавающая прибыль/убыток рассчитывается в валюте портфеля: сначала используется агрегированное значение портфеля, при его отсутствии суммируется PnL каждой отдельной позиции.
- **Стопы**: денежный стоп по параметру `MaxLoss`.
- **Значения по умолчанию**:
  - `TargetProfit` = 100 денежных единиц портфеля.
  - `MaxLoss` = -50 денежных единиц портфеля.
  - `EnableProfitClose` = true.
  - `EnableLossClose` = true.
  - `ShowAlerts` = true (детализированные сообщения записываются в лог стратегии при закрытии позиций).
  - `CandleType` = минутный таймфрейм (используется только в качестве источника периодических проверок).
- **Теги / фильтры**:
  - Категория: Утилиты / управление рисками.
  - Направление: Оба.
  - Индикаторы: нет.
  - Стопы: денежные.
  - Сложность: низкая.
  - Таймфрейм: настраиваемые свечи (по умолчанию 1 минута).
  - Сезонность: нет.
  - Нейросети: нет.
  - Дивергенция: нет.
  - Уровень риска: зависит от выбранных порогов.

## Особенности реализации

- Подписка на свечи используется только как источник периодических вызовов, имитируя регулярные проверки в оригинальном советнике MetaTrader.
- При выполнении условий закрытия стратегия многократно отправляет рыночные заявки на закрытие всех обнаруженных бумаг до полного отсутствия открытых позиций.
- Выполняется проверка корректности параметров: `TargetProfit` должен быть положительным при активном закрытии по прибыли, а `MaxLoss` — отрицательным при включенном закрытии по убытку. Это предотвращает запуск стратегии с некорректными настройками.
