# Стратегия Straddle Trail v2.40

**Straddle Trail v2.40** — это перенос на StockSharp советника MetaTrader 4 "Straddle&Trail" версии 2.40. Алгоритм выставляет симметричный стреддл из стоп-заявок перед важным событием, сопровождает активированную позицию переводом в безубыток и трейлинг-стопом, а также контролирует вручную открытые сделки.

## Основной цикл работы

1. **Подготовка**
   - Стратегия подписывается на стакан заявок, чтобы получать актуальные цены Bid/Ask, и на минутные свечи (тип задаётся параметром) для расчёта расписания.
   - На основании точности инструмента определяется размер пункта, поэтому все расстояния, заданные в пунктах, корректно преобразуются в цены.
2. **Выставление стреддла**
   - За `PreEventEntryMinutes` минут до события (или сразу при включении параметра `PlaceStraddleImmediately`) выставляются Buy Stop и Sell Stop на расстоянии `DistanceFromPrice` пунктов от текущей цены.
   - Пока до события ещё есть время, при активном `AdjustPendingOrders` заявки каждую минуту переставляются ближе к рынку. За `StopAdjustMinutes` минут до события перестановки прекращаются.
3. **Управление ордерами**
   - После срабатывания одной стороны при включённом `RemoveOppositeOrder` противоположный отложенный ордер удаляется, чтобы исключить двойное направление.
   - Параметры `ShutdownNow` и `ShutdownOption` позволяют в любой момент закрыть позиции и/или снять отложенные заявки.
4. **Защита позиции**
   - Первоначальные уровни стоп-лосса и тейк-профита рассчитываются из параметров в пунктах.
   - Достижение триггера безубытка переносит стоп на `BreakevenLockPips` пунктов в прибыль.
   - Трейлинг-стоп может стартовать сразу либо только после безубытка (контролируется `TrailAfterBreakeven`).
   - Если `ManageManualTrades` включён, стратегия применяет эту же логику к вручную открытым позициям.

## Параметры

| Параметр | Описание |
|----------|----------|
| `ShutdownNow` | Запускает процедуру экстренного закрытия на следующей свече. |
| `ShutdownOption` | Что закрывать: всё, только активированные сделки, только лонги, только шорты, все отложенные, только buy stop или только sell stop. |
| `DistanceFromPrice` | Расстояние в пунктах между ценой и стоп-заявками стреддла. |
| `StopLossPips` | Начальный стоп-лосс в пунктах. |
| `TakeProfitPips` | Начальный тейк-профит в пунктах. Ноль отключает цель. |
| `TrailPips` | Дистанция трейлинг-стопа в пунктах. Ноль отключает трейлинг. |
| `TrailAfterBreakeven` | Включает трейлинг только после перевода в безубыток. |
| `BreakevenLockPips` | Прибыль, фиксируемая после срабатывания безубытка. |
| `BreakevenTriggerPips` | Порог прибыли в пунктах для перевода стопа в безубыток. |
| `EventHour` / `EventMinute` | Время новости по времени брокера. Для отключения расписания установите оба параметра в 0. |
| `PreEventEntryMinutes` | За сколько минут до события ставится стреддл. |
| `StopAdjustMinutes` | За сколько минут до события переставлять заявки больше не нужно (минимум 1 минута). |
| `RemoveOppositeOrder` | Удаляет противоположный отложенный ордер после срабатывания стреддла. |
| `AdjustPendingOrders` | Переставляет стоп-заявки каждую минуту до наступления запретного окна. |
| `PlaceStraddleImmediately` | Выставляет стреддл сразу после старта стратегии, игнорируя расписание. |
| `ManageManualTrades` | Применяет перевод в безубыток и трейлинг к вручную открытым позициям. |
| `CandleType` | Тип свечей, используемый для расчёта логики (по умолчанию минутки). |

## Рекомендации по использованию

- Убедитесь, что параметры инструмента корректно задают размер пункта, иначе значения в пунктах не совпадут с ценами.
- Закрытие позиций выполняется рыночными ордерами при достижении условий стопа или цели, что повторяет подход оригинального советника.
- Если расписание активно и `PlaceStraddleImmediately` выключен, стреддл выставляется один раз в день. Для повторной работы в тот же день перезапустите стратегию.
- Функция аварийного выключения позволяет мгновенно снять риск и убрать отложенные заявки.

## Детали конверсии

- Все комментарии переведены на английский язык и дополнены пояснениями к логике.
- Используются высокоуровневые методы StockSharp (`BuyStop`, `SellStop`, `ClosePosition`), что соответствует принятым практикам проекта.
- Алгоритм работает на подписках свечей и стакана, не обращаясь к индикаторам напрямую, как требуют правила из `AGENTS.md`.
