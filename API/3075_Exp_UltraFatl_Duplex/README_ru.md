# Стратегия Exp UltraFATL Duplex

## Обзор
**Exp UltraFATL Duplex** – это порт MetaTrader 5 эксперта `Exp_UltraFatl_Duplex`, реализованный на C# для StockSharp. Стратегия использует две независимые ветки индикатора UltraFATL: одна анализирует потенциальные покупки, другая – продажи. Каждая ветка строит лестницу сглаженных значений FATL, подсчитывает количество растущих и падающих ступеней и на основе баланса формирует торговые сигналы.

## Логика торговли
1. Подписка на свечи заданного таймфрейма для каждой ветки (long/short).
2. Применение 39-точечного фильтра FATL к выбранной цене (close, typical, DeMark и т.д.).
3. Прогон результата через лестницу скользящих средних, где длина каждой ступени увеличивается на заданный шаг.
4. Сравнение соседних значений внутри лестницы для подсчёта «бычьих» и «медвежьих» голосов, повторное сглаживание обоих счётчиков.
5. Оценка счётчиков на смещённой (по умолчанию предыдущей) закрытой свече:
   - **Длинная ветка** открывает покупку, если на предыдущей свече быки лидировали, а на текущей счётчики пересеклись вниз (быки ≤ медведей). Закрытие происходит, когда на предыдущей свече лидируют медведи.
   - **Короткая ветка** открывает продажу в зеркальной ситуации – предыдущая свеча за медведями, текущая даёт пересечение вверх (быки ≥ медведей). Закрытие происходит, когда на предыдущей свече лидируют быки.
6. Опциональные стоп-лоссы и тейк-профиты рассчитываются по экстремумам свечей с учётом шага цены инструмента.

Стратегия поддерживает только чистую позицию: перед открытием лонга закрывается возможный шорт и наоборот. Все сделки исполняются рыночными ордерами.

## Параметры
### Блок длинных позиций
- **Long Volume** – объём ордера при открытии лонга.
- **Allow Long Entries / Exits** – разрешение на входы и выходы из длинных позиций.
- **Long Candle Type** – таймфрейм расчёта индикатора.
- **Long Applied Price** – тип цены, подаваемый в фильтр FATL.
- **Long Trend Method / Start Length / Phase / Step / Steps** – настройки лестницы сглаживания.
- **Long Counter Method / Counter Length / Counter Phase** – параметры сглаживания счётчиков голосов.
- **Long Signal Bar** – смещение по завершённым свечам (значения меньше 1 трактуются как 1).
- **Long Stop (pts)** и **Long Target (pts)** – стоп и тейк в шагах цены.

### Блок коротких позиций
Аналогичный набор параметров: **Short Volume**, флаги входа/выхода, **Short Candle Type**, **Short Applied Price**, параметры лестницы и счётчиков, **Short Signal Bar**, а также стоп-лосс и тейк-профит в пунктах.

## Особенности реализации
- Сглаживающие методы сопоставлены индикаторам StockSharp. Для вариантов Jurik используется `JurikMovingAverage`; режимы `Parabolic` и `T3` аппроксимированы экспоненциальным или Jurik-сглаживанием.
- Стопы и тейки проверяются по данным свечей и не выставляют реальные защитные ордера на бирже.
- Входы и выходы рассчитываются только после закрытия свечи. Поэтому смещение сигнала меньше одной свечи невозможно – значение 0 эквивалентно смещению 1.
- Для визуализации оба счётчика выводятся на отдельные области графика.

## Использование
Добавьте стратегию в решение StockSharp, настройте параметры обеих веток под ваш торговый план и запустите её в Designer, Shell или Runner. Убедитесь, что инструмент предоставляет требуемые свечные данные, а параметры `LongVolume` и `ShortVolume` соответствуют нужному объёму сделки.
