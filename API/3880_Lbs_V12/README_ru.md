# Стратегия Lbs V12

## Обзор
Стратегия Lbs V12 — это конвертация советника MetaTrader **LBS_V12.mq4**. Она выставляет пару стоп-заявок на пробой диапазона предыдущей 15-минутной свечи в момент наступления заданного часа. Цены заявок смещаются на текущее значение индикатора Average True Range (ATR), чтобы учитывать внутридневную волатильность. Сделки сопровождаются виртуальными стоп-уровнями и трейлинг-стопом, которые пересчитываются после закрытия каждой свечи.

## Логика работы
1. Стратегия обрабатывает только завершенные свечи выбранного таймфрейма (по умолчанию 15 минут).
2. Когда появляется новая свеча с минутой `00` в часе, указанном в параметре `TriggerHour`, предыдущая свеча используется как эталонный диапазон.
3. При отсутствии открытых позиций и активных заявок на текущую дату отправляются две стоп-заявки:
   - **Buy Stop** выше максимума эталонной свечи с добавлением спрэда, одного шага цены и значения ATR.
   - **Sell Stop** ниже минимума эталонной свечи с вычитанием тех же буферов.
4. Для каждой стороны сохраняются виртуальные уровни защиты:
   - Стоп-лосс ставится за противоположную границу эталонной свечи.
   - Тейк-профит рассчитывается в пунктах MetaTrader от цены входа.
   - Трейлинг-стоп активируется, когда прибыль превышает заданное расстояние.
5. При открытии позиции противоположная стоп-заявка отменяется. Дальнейший выход производится рыночными ордерами, если экстремумы свечей достигают рассчитанных уровней защиты.
6. Логика выполняется один раз в сутки: при переходе на новую дату все заявки и внутреннее состояние сбрасываются.

## Параметры
| Имя | Описание | Значение по умолчанию |
|-----|----------|-----------------------|
| `Volume` | Торговый объем в лотах. | `1` |
| `TriggerHour` | Час (по времени терминала), когда отправляются стоп-заявки. | `9` |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах MetaTrader. | `100` |
| `TrailingStopPoints` | Расстояние трейлинг-стопа в пунктах MetaTrader. | `20` |
| `AtrPeriod` | Период индикатора ATR для расчета смещения заявок. | `3` |
| `CandleType` | Тип свечей для анализа (по умолчанию 15-минутные). | `15 минут` |

## Управление рисками
- Закрытие позиций выполняется рыночными ордерами при достижении виртуального стоп-лосса или тейк-профита.
- Трейлинг-стоп подтягивает уровень защиты вслед за ценой при достаточном движении в прибыльную сторону.
- Ежедневный сброс не позволяет накапливать устаревшие заявки или множественные позиции.

## Примечания
- Для корректной компенсации спрэда рекомендуется получать котировки Bid/Ask. При их отсутствии используется один шаг цены.
- В конвертации сохранены исходные значения параметров MetaTrader, а расчет тейк-профита для коротких позиций скорректирован так, чтобы целевой уровень всегда находился в прибыльной области.
