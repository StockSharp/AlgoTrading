# Стратегия Rabbit3

## Описание
- Конвертация оригинального советника MetaTrader 5 `Rabbit3 (barabashkakvn's edition)`.
- Реализация выполнена через высокоуровневый API StockSharp с подпиской на свечи и привязкой индикаторов.
- Логика основана на двойном подтверждении сигналов: текущее и предыдущее значения Williams %R должны находиться в экстремальной зоне, а CCI — подтверждать направление.
- Добавлено динамическое управление объёмом: прибыль сделки, превышающая заданный порог в деньгах, увеличивает объём следующей заявки.

## Логика торговли
### Условия входа
1. **Покупка**
   - Текущая и предыдущая закрытые свечи показывают Williams %R ниже уровня `WilliamsOversold` (по умолчанию `-80`).
   - Значение CCI ниже `CciBuyLevel` (по умолчанию `-80`).
   - Текущая чистая позиция неотрицательная, а добавление нового объёма не превышает `MaxPositions × BaseVolume` (учитывается повышенный объём, если он активирован).
2. **Продажа**
   - Текущая и предыдущая закрытые свечи показывают Williams %R выше `WilliamsOverbought` (по умолчанию `-20`).
   - Значение CCI выше `CciSellLevel` (по умолчанию `80`).
   - Чистая позиция неположительная и новое наращивание не выходит за пределы допустимого лимита.

### Выход и управление рисками
- Стоп-лосс и тейк-профит выставляются автоматически через `StartProtection`.
- Дистанция рассчитывается в «скорректированных пунктах»: если инструмент имеет 3 или 5 знаков после запятой, шаг цены умножается на 10 (эмуляция пипсов MetaTrader) перед применением `StopLossPips` и `TakeProfitPips`.
- Дополнительные условия выхода не требуются — защитные приказы закрывают позицию.

### Управление объёмом
- `BaseVolume` задаёт исходный размер сделки (по умолчанию `0.01`).
- После закрытия каждой позиции рассчитывается изменение реализованной прибыли относительно предыдущего значения `PnL`.
- Если прирост строго больше `ProfitThreshold` (по умолчанию `4` денежных единицы), следующая сделка откроется объёмом `BaseVolume × VolumeMultiplier` (по умолчанию `1.6`). В противном случае объём возвращается к базовому.
- Текущее значение также записывается в свойство `Volume`, что позволяет видеть его в интерфейсе.

### Индикаторы и визуализация
- Подписаны Williams %R, CCI, а также две EMA (`FastEmaPeriod` и `SlowEmaPeriod`) для контекстного отображения тренда.
- Автоматически создаётся область графика с отображением свечей, индикаторов и совершённых сделок.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | таймфрейм 1 час | Тип данных для подписки на свечи. |
| `CciPeriod` | `15` | Период индикатора CCI. |
| `CciBuyLevel` | `-80` | Порог CCI для подтверждения покупок. |
| `CciSellLevel` | `80` | Порог CCI для подтверждения продаж. |
| `WilliamsPeriod` | `62` | Длина расчёта Williams %R. |
| `WilliamsOversold` | `-80` | Нижний порог для подтверждения покупок. |
| `WilliamsOverbought` | `-20` | Верхний порог для подтверждения продаж. |
| `FastEmaPeriod` | `17` | Период быстрой EMA для визуального контроля тренда. |
| `SlowEmaPeriod` | `30` | Период медленной EMA для визуального контроля тренда. |
| `MaxPositions` | `2` | Максимальное количество ступеней усреднения в одном направлении. |
| `ProfitThreshold` | `4` | Прибыль (в деньгах), необходимая для увеличения следующего объёма. |
| `BaseVolume` | `0.01` | Базовый объём сделки. |
| `VolumeMultiplier` | `1.6` | Множитель объёма при выполнении условия прибыли. |
| `StopLossPips` | `45` | Стоп-лосс в скорректированных пунктах. |
| `TakeProfitPips` | `110` | Тейк-профит в скорректированных пунктах. |

## Примечания
- Стратегия работает с чистой позицией. В отличие от хеджирующей MQL-версии одновременно длинные и короткие позиции не удерживаются: противоположный сигнал игнорируется, пока текущая позиция не будет закрыта защитными ордерами.
- `MaxPositions` ограничивает совокупный объём (базовый или увеличенный). При изменении `BaseVolume` или `VolumeMultiplier` корректируйте лимит, чтобы сохранить желаемый риск.
- Допускается погрешность, равная половине шага объёма инструмента, чтобы избежать проблем с округлением при проверке лимита усреднения.
- Python-реализация пока не создавалась и может быть добавлена позднее при необходимости.
