# Pendulum 策略

## 概述
**Pendulum 策略** 是 MetaTrader 智能交易系统 *Pendulum 1_01* 的 StockSharp 版本。原始 EA 会在现价上下保持两个挂单，并在每次成交后成倍增加同向挂单的手数。本 C# 版本使用 StockSharp 的高级 API 复现了这种“钟摆式”运行方式。

核心思想：

- 在最近完成的蜡烛收盘价附近维持对称的买入止损和卖出止损挂单。
- 每次挂单成交后，同方向的下一张挂单按设定倍率放大手数，形成类似马丁格尔的仓位进阶。
- 当达到短期点数目标或账户权益触发全局止盈 / 止损阈值时平仓。

## 工作流程
1. 策略启动时会订阅用户指定的主时间框蜡烛（默认 15 分钟），并在需要时额外订阅日线。最新日线波动区间用于计算挂单距离。
2. 每根完成的交易蜡烛都会执行以下步骤：
   - 更新全局权益限制。
   - 检查当前持仓是否触及本地点数止盈。
   - 根据日线区间或手动输入的点距计算挂单价格，并创建/更新买入止损与卖出止损。
3. 挂单成交后，对应方向的层级递增，下一张挂单采用放大后的手数；达到 `MaxLevels` 后在该方向暂停新挂单，直至仓位归零。
4. 全局止盈 / 止损在每根蜡烛结束后检查，一旦权益超过设定百分比即清空持仓。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| ---- | ---- | ------ | ---- |
| `BaseVolume` | `decimal` | `0.1` | 第一张挂单的手数。 |
| `VolumeMultiplier` | `decimal` | `2` | 同向每次成交后的手数倍数。 |
| `MaxLevels` | `int` | `8` | 单个方向允许的最大成交次数。 |
| `ManualStepPips` | `int` | `50` | 在没有日线数据时使用的点距。 |
| `UseDynamicRange` | `bool` | `true` | 是否使用最新日线区间动态计算挂单距离。 |
| `RangeFraction` | `decimal` | `0.2` | 取日线波动区间的哪一部分作为基础距离。 |
| `TakeProfitPips` | `int` | `10` | 本地点数止盈，设为 `0` 表示关闭。 |
| `SlippagePips` | `int` | `3` | 额外增加的安全点差，用于模拟 MetaTrader 中的滑点设置。 |
| `UseGlobalTargets` | `bool` | `true` | 是否开启基于权益的全局止盈 / 止损。 |
| `GlobalTakePercent` | `decimal` | `1` | 达到该百分比的权益增长时平掉所有仓位。 |
| `GlobalStopPercent` | `decimal` | `2` | 达到该百分比的权益回撤时强制止损。 |
| `CandleType` | `DataType` | `15m` 蜡烛 | 主要交易逻辑使用的时间框。 |

## 说明
- 下单手数会自动符合交易品种的最小/最大手数以及步长限制。
- 挂单价格会按品种的最小报价步长对齐，并设置容差避免频繁撤单重下。
- 全局止盈 / 止损依赖 `Portfolio.CurrentValue`（若不可用则回退到 `BeginValue`），因此所选组合需提供该数据。
- 启动时调用 `StartProtection()` 以启用 StockSharp 自带的风控保护。

## 转换差异
- 原始 EA 中的标签显示和账户余额表格被移除。
- 全局止盈改为按账户权益百分比计算，以便在不同券商之间保持一致性。
- MetaTrader 的 `OrderModify` 等函数以撤单 + 重新下单方式实现。
