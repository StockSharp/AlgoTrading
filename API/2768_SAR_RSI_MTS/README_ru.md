# Стратегия SAR RSI MTS

## Общее описание

**SAR RSI MTS** — это перенос оригинального эксперта MetaTrader 5 «SAR RSI MTS» на высокоуровневый API StockSharp. Стратегия следует сигналам индикатора Parabolic SAR и подтверждает их показаниями индекса относительной силы (RSI). Расчёты выполняются только на закрытых свечах (по умолчанию H1), а суммарная нетто-позиция ограничивается параметром `MaxPosition`.

## Используемые данные и индикаторы

- **Parabolic SAR** с параметрами `Acceleration = SarStep`, `AccelerationStep = SarStep`, `AccelerationMax = SarMax`.
- **RSI** с настраиваемым периодом и нейтральным уровнем (по умолчанию 50).
- Тип свечей задаётся параметром `CandleType`, стандартное значение — часовые свечи.

Внутри стратегии рассчитывается стоимость «пункта» на основе шага цены и количества знаков. Если инструмент котируется с 3 или 5 знаками после запятой, шаг умножается на 10, что воспроизводит логику исходного MQL-скрипта.

## Правила входа

Проверка условий выполняется при закрытии каждой свечи, когда индикаторы готовы:

- **Покупка**
  1. Значение SAR на предыдущей свече находится ниже текущей цены закрытия, а сам SAR растёт.
  2. RSI выше нейтрального уровня и увеличивается относительно предыдущего значения.
  3. Если есть короткая позиция, стратегия сначала выкупает её и затем открывает новый лонг на объём `Volume`, не превышая `MaxPosition`.

- **Продажа**
  1. SAR на предыдущей свече расположен выше текущей цены закрытия и снижается.
  2. RSI опускается ниже нейтрального уровня и падает относительно предыдущего значения.
  3. При наличии длинной позиции она закрывается перед открытием нового шорта. Добавление шортов возможно, пока |позиция| ≤ `MaxPosition`.

Сравнения выполняются с учётом точности инструмента и повторяют функцию `CompareDoubles` из исходного кода.

## Управление позицией и рисками

Перед поиском новых сигналов стратегия обрабатывает защитные правила:

- **Фиксированный стоп-лосс** в пунктах, пересчитанных в цену относительно средней входной цены текущей позиции.
- **Фиксированный тейк-профит**, аналогичный стоп-лоссу.
- **Трейлинг-стоп**, который активируется после достижения прибыли `TrailingStop + TrailingStep` и сдвигается дискретно, повторяя процедуру `Trailing()` из MQL.
- При отсутствии позиции состояние трейлинга сбрасывается.

Любой защитный сигнал закрывает всю нетто-позицию и прекращает обработку сигналов на текущей свече, что имитирует поведение биржевых стоп-заявок исходного эксперта.

## Параметры

| Параметр | Описание |
|----------|----------|
| `StopLossPips` | Дистанция стоп-лосса в пунктах. Значение `0` отключает стоп. |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. Значение `0` отключает тейк. |
| `TrailingStopPips` | Размер трейлинг-стопа. Значение `0` — без трейлинга. |
| `TrailingStepPips` | Минимальное улучшение цены для смещения трейлинг-стопа. |
| `SarStep` | Шаг ускорения Parabolic SAR, одновременно начальное ускорение. |
| `SarMax` | Максимальное ускорение Parabolic SAR. |
| `RsiPeriod` | Период RSI. |
| `RsiNeutralLevel` | Нейтральный уровень RSI (по умолчанию 50). |
| `CandleType` | Тип свечей для расчётов. |
| `MaxPosition` | Максимальное абсолютное значение нетто-позиции. |

## Дополнительные замечания

- Значения по умолчанию соответствуют входным параметрам оригинального советника: стоп 10 пунктов, тейк 40 пунктов, трейлинг 15/5 пунктов, SAR `0.05/0.5`, RSI 14.
- Торговый объём задаётся свойством `Strategy.Volume`; при реверсе объём автоматически рассчитывается с учётом `MaxPosition`.
- Логика построена исключительно на высокоуровневых механизмах StockSharp (подписка на свечи, `Bind`, рыночные заявки), что полностью соответствует требованиям проекта.
