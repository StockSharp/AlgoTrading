# SAR RSI MTS 策略

## 概览

**SAR RSI MTS 策略**是 MetaTrader 5 专家顾问“SAR RSI MTS”的 StockSharp 高级 API 版本。系统依靠抛物线 SAR 指标来识别趋势方向，并使用相对强弱指数（RSI）确认信号。策略只在已经收盘的 K 线（默认 1 小时）上运行，并对净持仓规模设置了可配置的上限。

## 指标与数据

- **抛物线 SAR**：`Acceleration = SarStep`、`AccelerationStep = SarStep`、`AccelerationMax = SarMax`。
- **RSI**：可配置周期与中性水平（默认 50）。
- **K 线类型**：由 `CandleType` 参数决定，默认订阅 1 小时数据。

策略会根据交易品种的价格步长和小数位数计算“点值”。当标的价格保留 3 或 5 位小数时，会自动把步长乘以 10，从而复制原始 MQL 程序中对“点”的处理方式。

## 入场逻辑

在每根完成的 K 线收盘时，当两个指标都给出有效结果后评估新的交易机会：

- **做多条件**
  1. 前一根 K 线的 SAR 位于当前收盘价之下，并且当前的 SAR 值高于上一根。
  2. RSI 高于中性阈值，并且相较上一根有所上升。
  3. 如果当前为净空头头寸，策略会先买入足够的数量将仓位翻转，再按照 `Volume` 参数设定的数量建立新的多单，并保证不超过 `MaxPosition` 上限。

- **做空条件**
  1. 前一根 K 线的 SAR 位于当前收盘价之上，并且当前的 SAR 值低于上一根。
  2. RSI 低于中性阈值，并且相较上一根有所下降。
  3. 若已有净多头，则先平掉现有多头，再按计划建立新的空单。空头仓位的绝对值同样受到 `MaxPosition` 限制。

所有比较都会按照品种的小数精度进行，以对应 MQL 版本中 `CompareDoubles` 函数的效果。

## 出场与风控

每根 K 线在检测新信号之前都会先执行风控逻辑：

- **固定止损**：以点数配置，换算成价格距离后作用于当前平均持仓价。
- **固定止盈**：同样以点数配置，逻辑与止损对称。
- **追踪止损**：仅在浮动盈利超过 `TrailingStop + TrailingStep` 时激活，并按离散步长移动，重现原 MQL 程序中的 `Trailing()` 行为。
- 当持仓归零时会自动清空追踪状态。

所有退出操作都会一次性平掉全部净头寸。当某个保护条件触发时，策略会跳过同一根 K 线的入场判断，模拟原始系统中经纪商侧止损单的效果。

## 参数说明

| 参数 | 说明 |
|------|------|
| `StopLossPips` | 以点数表示的止损距离，设为 `0` 表示关闭。 |
| `TakeProfitPips` | 以点数表示的止盈距离，设为 `0` 表示关闭。 |
| `TrailingStopPips` | 追踪止损的基础距离，设为 `0` 表示关闭。 |
| `TrailingStepPips` | 每次调整追踪止损所需的最小价格改进幅度。 |
| `SarStep` | 抛物线 SAR 的加速度步长，同时作为初始加速度。 |
| `SarMax` | 抛物线 SAR 的最大加速度。 |
| `RsiPeriod` | RSI 指标的计算周期。 |
| `RsiNeutralLevel` | 用于区分多空的 RSI 中性水平（默认 50）。 |
| `CandleType` | 用于计算的 K 线类型，默认 1 小时。 |
| `MaxPosition` | 策略允许的净持仓绝对值上限。 |

## 其他说明

- 默认配置与原始 EA 保持一致：10 点止损、40 点止盈、15/5 点追踪止损、SAR 参数 `0.05/0.5`、RSI 周期 14。
- 下单数量由基础的 `Strategy.Volume` 属性控制。策略在加仓或反向时会自动遵守 `MaxPosition` 限制。
- 全部指标绑定与交易执行均使用 StockSharp 高级 API，未直接访问原始数据缓冲，从而完全符合项目规范。
