# Exp XWAMI MMRec (ID 2956)

## Описание

Стратегия переносит эксперт MetaTrader **Exp_XWAMI_MMRec**. Она использует индикатор XWAMI, который оценивает импульс как разницу между текущей ценой и ценой `Period` баров назад. Разность последовательно сглаживается четырьмя фильтрами; выход третьего и четвёртого фильтров соответствует буферам `Up` и `Down` оригинального индикатора. Пересечения этих буферов инициируют реверс позиции.

Каждый этап сглаживания может работать в одном из нескольких режимов: простая/экспоненциальная/сглаженная/линейно-взвешенная средняя, Jurik JJMA/JurX, Tillson T3, VIDYA (аппроксимация через EMA) и адаптивная средняя Кауфмана. Стратегия ведёт единую нетто-позицию и поддерживает торговлю в обе стороны. Модуль управления капиталом анализирует результаты последних `BuyTotalTrigger` / `SellTotalTrigger` сделок; если количество убыточных сделок достигает `BuyLossTrigger` / `SellLossTrigger`, объём следующей позиции снижается до `ReducedVolume`.

Стоп-лосс и тейк-профит задаются в пунктах (`StopLossPoints`, `TakeProfitPoints`) и пересчитываются в цену через `Security.PriceStep`. При достижении стопа или цели позиция закрывается немедленно, а результат сохраняется в истории для блока управления капиталом.

## Параметры

| Свойство StockSharp | Значение по умолчанию | Параметр MT5 | Назначение |
| --- | --- | --- | --- |
| `CandleType` | Таймфрейм H1 | `InpInd_Timeframe` | Таймфрейм свечей для расчёта индикатора. |
| `Period` | 1 | `iPeriod` | Отступ по барам при расчёте импульса. |
| `Method1` / `Length1` / `Phase1` | `T3`, `4`, `15` | `XMethod1`, `XLength1`, `XPhase1` | Настройки первого фильтра (фаза используется для Jurik/JurX/T3). |
| `Method2` / `Length2` / `Phase2` | `Jjma`, `13`, `15` | `XMethod2`, `XLength2`, `XPhase2` | Второй этап сглаживания. |
| `Method3` / `Length3` / `Phase3` | `Jjma`, `13`, `15` | `XMethod3`, `XLength3`, `XPhase3` | Третий этап (буфер `Up`). |
| `Method4` / `Length4` / `Phase4` | `Jjma`, `4`, `15` | `XMethod4`, `XLength4`, `XPhase4` | Четвёртый этап (буфер `Down`). |
| `AppliedPrice` | `Close` | `IPC` | Источник цен; реализованы все варианты из MetaTrader, включая TrendFollow и Demark. |
| `SignalBar` | 1 | `SignalBar` | Индекс бара, по которому оценивается сигнал (`0` — последний завершённый бар). |
| `AllowBuyOpen` / `AllowSellOpen` | `true` | `BuyPosOpen`, `SellPosOpen` | Разрешение на открытие длинных/коротких позиций. |
| `AllowBuyClose` / `AllowSellClose` | `true` | `BuyPosClose`, `SellPosClose` | Разрешение на принудительное закрытие при обратном сигнале. |
| `NormalVolume` | `0.1` | `MM` | Базовый объём позиции. |
| `ReducedVolume` | `0.01` | `SmallMM_` | Объём после серии убыточных сделок. |
| `BuyTotalTrigger` / `BuyLossTrigger` | `5` / `3` | `BuyTotalMMTriger`, `BuyLossMMTriger` | Длина окна и лимит убыточных сделок для покупок. |
| `SellTotalTrigger` / `SellLossTrigger` | `5` / `3` | `SellTotalMMTriger`, `SellLossMMTriger` | Аналогичные настройки для продаж. |
| `StopLossPoints` | `1000` | `StopLoss_` | Расстояние стоп-лосса в пунктах. |
| `TakeProfitPoints` | `2000` | `TakeProfit_` | Расстояние тейк-профита в пунктах. |

## Алгоритм работы

1. Подписаться на свечи выбранного таймфрейма и обрабатывать только завершённые бары.
2. Рассчитать ценовую разницу и последовательно пропустить её через четыре фильтра.
3. Сохранять пары значений (`Up`, `Down`). При пересечении на предыдущем баре (`SignalBar + 1`) стратегия разворачивается: если `Up > Down`, закрывается шорт и при условии `Up <= Down` на баре `SignalBar` открывается лонг; противоположный сценарий формирует шорт.
4. Определять объём следующей сделки на основе результатов последних сделок. При превышении допустимого числа убытков используется `ReducedVolume`, иначе — `NormalVolume`.
5. Контролировать стоп-лосс и тейк-профит по ценам, рассчитанным из пунктов. При достижении уровня позиция закрывается и результат учитывается в истории.

## Отличия от MT5 версии

- StockSharp работает с совокупной позицией, поэтому понятия `BuyMagic`/`SellMagic`, глобальные переменные и выбор режима маржи (`MarginMode`) удалены.
- Tillson T3 реализован в коде; Jurik JJMA и JurX сопоставлены с `JurikMovingAverage`. VIDYA и ParMA аппроксимированы экспоненциальным средним из-за отсутствия прямых аналогов.
- Сделки исполняются рыночными ордерами `BuyMarket`/`SellMarket`, а стопы/цели контролируются логикой стратегии, без выставления стоп-заявок на биржу.
- Параметр допустимого отклонения (`Deviation_`) не используется, так как StockSharp не требует явного задания проскальзывания.

## Рекомендации по использованию

1. Выберите инструмент, установите `CandleType` в соответствии с оригинальным экспертом.
2. Настройте методы сглаживания и их параметры под желаемую конфигурацию XWAMI.
3. Подберите объёмы `NormalVolume` и `ReducedVolume`, а также пороги срабатывания на основе риск-профиля.
4. Запустите стратегию — она автоматически будет переворачиваться при каждом пересечении буферов.

При необходимости можно изменить сопоставление фильтров в методе `ExpXwamiMmRecStrategy.CreateFilter`, чтобы подключить альтернативные индикаторы StockSharp.
