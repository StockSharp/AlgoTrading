# Gazonkos Expert 策略

## 概览
本策略移植自 MetaTrader 4 上的 "gazonkos expert" 智能交易系统，原版运行在 EUR/USD 的 1 小时周期。算法在确认出现强劲的单根 K 线动量后，等待价格出现固定幅度的回调再顺势进场，并为仓位设置固定点差的止损与止盈。

## 原始 MQL4 逻辑
- 持续计算两个历史收盘价之间的差值（`Close[t2] - Close[t1]`）。默认参数为 `t1 = 3`、`t2 = 2`，对应于两小时前与三小时前那两根已完成 K 线的收盘价。
- 当 `Close[t2] - Close[t1]` 大于 `delta` 时判定为多头动量；若 `Close[t1] - Close[t2]` 大于同一阈值则判定为空头动量。
- 触发动量后，EA 会在同一小时内记录价格的极值（多头记录最高价，空头记录最低价）。若随后出现 `Otkat` 点的回调，则按动量方向发送市价单。
- 如果已经存在相同 magic number 的仓位，或该小时内已经开过仓，系统会禁止再次进场。
- 每笔交易同时设置固定距离的止盈（`TakeProfit`）和止损（`StopLoss`），单位均为点。

## C# 版本的状态机
移植版本完全保留了原有的状态流转：
1. **WaitingForSlot**：检查当前小时是否已经下单，以及是否超过允许的最大持仓数。
2. **WaitingForImpulse**：根据 `Close[t2]` 与 `Close[t1]` 判断多空动量。
3. **MonitoringRetracement**：在动量触发后持续更新极值，并等待价格在同一小时内回调 `RetracementPips`（原始参数 `Otkat`）。
4. **AwaitingExecution**：在满足回调条件时按动量方向下市价单，并立即按照合约 `PriceStep` 计算止盈止损距离。

策略只处理已完成的蜡烛数据，与原版 EA 相同，忽略尚未收盘的小时数据。

## 参数说明
| 参数 | 说明 |
|------|------|
| `TakeProfitPips` | 入场价到止盈价之间的距离。 |
| `RetracementPips` | 动量后所需的回调幅度。 |
| `StopLossPips` | 入场价到止损价之间的距离。 |
| `T1Shift` | 动量检测中较旧的参考 K 线索引（默认 3）。 |
| `T2Shift` | 动量检测中较新的参考 K 线索引（默认 2）。 |
| `DeltaPips` | 判定动量所需的最小价差。 |
| `LotSize` | 每笔订单使用的固定手数。 |
| `MaxActiveTrades` | 允许的最大并发仓位数；若大于 1，需要账户支持净头寸叠加。 |
| `CandleType` | 用于分析的蜡烛时间框架（默认 1 小时）。 |

所有以点数表示的距离都会乘以 `Security.PriceStep` 转换成真实价格差。当合约没有提供价格步长时，默认使用 0.0001，与原始 EUR/USD 设置保持一致。

## 实现细节
- 使用 StockSharp 的高级 API (`SubscribeCandles().Bind`) 订阅蜡烛并驱动逻辑。
- 为模拟 MQL4 中的 `Close[i]` 访问方式，收盘价存储在轻量级的滚动缓冲区内。
- 开仓后会记录当前蜡烛的小时数，在同一小时内禁止再次进场，对应原策略的 `LastTradeTime` 保护机制。
- `MaxActiveTrades` 依据当前净仓位进行判断；在净额账户中等同于只允许一笔持仓，与原策略默认行为一致。
- 代码中的注释使用英文详细说明状态机逻辑，便于维护与复查。
