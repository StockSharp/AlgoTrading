# Стратегия Gazonkos Expert

## Общее описание
Эта стратегия представляет собой порт советника MetaTrader 4 «gazonkos expert», рассчитанного на часовой график EUR/USD. Алгоритм ищет сильные импульсы на часовом таймфрейме и после отката входит в направлении движения. Стоп-лосс и тейк-профит задаются фиксированными расстояниями в пунктах.

## Логика оригинального MQL4-советника
- Непрерывно вычисляется разница между двумя прошлыми ценами закрытия (`Close[t2] - Close[t1]`). По умолчанию `t1 = 3`, `t2 = 2`, что соответствует барам, завершившимся два и три часа назад.
- Если `Close[t2] - Close[t1]` превышает порог `delta`, фиксируется бычий импульс; если `Close[t1] - Close[t2]` превышает тот же порог, фиксируется медвежий импульс.
- После импульса эксперт отслеживает максимум (для покупок) или минимум (для продаж), достигнутый до смены часа. Если цена откатывает от этого экстремума на `Otkat` пунктов в пределах того же часа, открывается рыночная сделка в сторону импульса.
- Новые сделки блокируются, если уже есть позиция с тем же magic-номером или если сделка уже открывалась в текущем часу.
- Каждая заявка сопровождается фиксированными уровнями тейк-профита (`TakeProfit`) и стоп-лосса (`StopLoss`), измеряемыми в пунктах.

## Состояния в реализации на C#
Порт воспроизводит исходный конечный автомат:
1. **WaitingForSlot** – проверяет, что в текущем часу не было сделок и лимит по количеству одновременно открытых позиций не превышен.
2. **WaitingForImpulse** – ищет бычьи или медвежьи импульсы по значениям `Close[t2]` и `Close[t1]`.
3. **MonitoringRetracement** – фиксирует экстремумы после импульса и ожидает откат на `RetracementPips` (ранее `Otkat`) в течение того же часа.
4. **AwaitingExecution** – отправляет рыночный ордер в сторону импульса и сразу же устанавливает защитные уровни на основе `PriceStep` инструмента.

Анализ ведётся только по закрытым свечам выбранного таймфрейма, что повторяет принцип работы оригинального советника.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TakeProfitPips` | Расстояние от точки входа до тейк-профита. |
| `RetracementPips` | Величина отката, необходимая перед входом. |
| `StopLossPips` | Расстояние от точки входа до стоп-лосса. |
| `T1Shift` | Индекс более старой свечи для оценки импульса (по умолчанию 3). |
| `T2Shift` | Индекс более новой свечи для оценки импульса (по умолчанию 2). |
| `DeltaPips` | Минимальная разница между сравниваемыми закрытиями. |
| `LotSize` | Фиксированный объём каждой сделки. |
| `MaxActiveTrades` | Максимальное число одновременно открытых сделок; значения больше единицы требуют учёта неттинга у брокера. |
| `CandleType` | Тип свечей, используемых для анализа (по умолчанию 1 час). |

Все расстояния в пунктах переводятся в ценовые смещения через `Security.PriceStep`. Если шаг цены не задан, используется значение 0.0001, соответствующее базовой настройке EUR/USD.

## Особенности реализации
- Используется высокоуровневый API StockSharp для подписки на свечи (`SubscribeCandles().Bind`).
- Закрытия свечей сохраняются в компактном буфере, что эмулирует обращения `Close[i]` из MQL4.
- После открытия сделки фиксируется час свечи, и до следующего часа новые входы блокируются – аналог оригинального поля `LastTradeTime`.
- Параметр `MaxActiveTrades` сопоставляется с текущей чистой позицией. На неттинговых счетах это фактически ограничивает стратегию одной сделкой, что соответствует поведению советника по умолчанию.
- Комментарии в коде подробно описывают логику состояний на английском языке для удобства сопровождения.
