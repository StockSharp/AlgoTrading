# 图表参数诊断策略

## 概述
本策略源自 MetaTrader 4 脚本 `ACB3.MQ4`（位于 `MQL/8584` 目录），原脚本会弹出一系列提示，说明当前图表的可见范围、历史柱线数量以及价格区间。移植到 StockSharp 之后，策略保留了相同的目的：订阅蜡烛数据并在日志中输出关于“图表几何结构”的详细诊断信息，而不会发送任何订单。

与交易机器人不同，该策略是一个监控工具。它可以在回测或实时监控之前，帮助确认图表是否加载了足够的历史数据、可见区域的宽度是否正确，以及价格刻度是否具有足够的分辨率。由于诊断输出基于实时蜡烛生成，窗口宽度或价格极值发生变化时，报告会即时更新。

## 数据流程与处理步骤
1. 策略启动时首先读取证券元数据，提取价格小数位数和最小报价跳动（quote point），并立即写入日志，方便检查合约参数是否正确。
2. 使用 `VisibleBars` 参数初始化 `Highest` 与 `Lowest` 指标，这两个指标在同一蜡烛流上运行，追踪“可见窗口”中最高价和最低价。
3. 订阅所选 `CandleType` 的蜡烛数据。仅当蜡烛状态为完成时才进入诊断流程。
4. 对每根完成的蜡烛，策略会：
   - 统计自启动以来处理过的蜡烛总数。
   - 根据 `VisibleBars` 计算可见窗口的首尾索引，并估算为了填满窗口所需的偏移量。
   - 通过 `Highest` 与 `Lowest` 获取价格区间，并转换为报价跳动数量，以模拟 MetaTrader 中的垂直分辨率。
   - 输出多行日志，格式与原 MQL 脚本的 Alert 序列一致，所有文本使用英文，数值根据检测到的精度进行格式化。

## 参数说明
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | 1 分钟时间框 | 执行诊断的蜡烛序列，支持任意时间框或蜡烛类型。 |
| `VisibleBars` | `int` | 100 | 模拟图表可见宽度的蜡烛数量，对应原脚本中的 `WindowBarsPerChart()`。 |

两个参数都支持优化，在回测时可以快速检视不同窗口宽度下的诊断结果。策略不执行交易，因此优化仅改变日志的上下文，不影响持仓。

## 日志输出
日志内容完全复刻 MetaTrader 的提示结构：

```
Horizontal resolution: 100
Vertical resolution (points): 120
Summary:
Total bars processed: 523
Visible bars: 100
Last visible bar index: 522
First visible bar index: 423
Shift bars: 0
Horizontal:
Price range: 1.23450
Minimum price: 1.09500
Maximum price: 1.23450
Vertical:
Chart parameters updated.
```

随着新蜡烛到来，数值会持续更新。若证券未提供价格步长，策略会退回到 `10^-digits` 的计算方式，与原脚本一致。

## 使用建议
- 将策略附加到待分析的证券，并选择与图表一致的蜡烛类型。
- 根据屏幕或回测面板能显示的柱线数量调整 `VisibleBars`。
- 在 StockSharp 界面或日志文件中查看输出。策略会自动绘制蜡烛方便比对，但不会绘制额外图形。
- 策略不会提交订单，因此无需启用风控或保护模块。

## 与 MQL 版本的差异
- 原脚本依赖 `WindowBarsPerChart()`、`WindowPriceMin()` 等界面函数。移植版本通过指标与计数器自行计算，避免依赖具体的图表控件。
- 诊断结果通过日志输出而非弹窗，方便自动化监控并可保留完整历史记录。
- 计算在每根完成蜡烛时执行，因此在加载新历史或接收实时行情时会自动更新，而原脚本需要手动重新运行。

## 备注
- 策略为纯诊断用途，不会更改仓位，也不会产生交易。
- 输出的日志可进一步被外部工具解析，构建监控面板或告警系统。
- 当 `VisibleBars` 大于已处理的蜡烛数量时，策略会在 `Shift bars` 中指出缺失的数量，与原脚本的行为一致。
