# Стратегия диагностики параметров графика

## Общее описание
Стратегия представляет собой адаптацию скрипта MetaTrader 4 `ACB3.MQ4` из папки `MQL/8584`. В оригинале скрипт выводил цепочку Alert-сообщений с информацией о текущем состоянии окна графика: количестве подгруженных баров, индексах первого и последнего видимого бара и вертикальном диапазоне цен. В версии для StockSharp логика полностью сохранена: стратегия подписывается на свечи и формирует подробный отчёт о «геометрии графика» в журнале, не отправляя заявок.

Таким образом, стратегия служит инструментом контроля. Она помогает убедиться, что в тестовой или рабочей сессии загружен нужный объём истории, видимый интервал соответствует ожиданиям, а ценовая шкала имеет требуемое разрешение. Диагностика выполняется на каждой завершённой свече, поэтому отчёт мгновенно отражает изменения ширины окна, появление новой истории и новые экстремумы цены.

## Последовательность работы
1. При старте считываются метаданные инструмента: количество знаков после запятой и минимальный шаг цены. Значения сразу фиксируются в журнале, чтобы оператор мог проверить корректность настроек инструмента.
2. Создаются индикаторы `Highest` и `Lowest` с длиной `VisibleBars`. Они отслеживают наивысшее и наинизшее значение внутри виртуального окна, имитирующего `WindowBarsPerChart()` из MQL.
3. Оформляется подписка на свечи типа `CandleType`. В обработку попадают только полностью сформированные свечи (`CandleStates.Finished`).
4. Для каждой завершённой свечи стратегия:
   - Увеличивает счётчик общего числа обработанных баров.
   - Вычисляет индексы первого и последнего бара в текущем видимом окне и определяет, сколько баров не хватает до полного заполнения (`Shift bars`).
   - Получает из индикаторов диапазон цен и переводит его в количество шагов цены, имитируя метрику вертикального разрешения из MetaTrader.
   - Записывает серию строк в журнал. Формат сообщений совпадает с оригинальным скриптом, значения форматируются в соответствии с количеством знаков инструмента.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | Тайм-фрейм 1 минута | Поток свечей, на основе которого выполняется диагностика. Можно выбрать любой поддерживаемый тип свечей. |
| `VisibleBars` | `int` | 100 | Количество свечей, имитирующее ширину окна графика. Аналог функции `WindowBarsPerChart()` из MQL. |

Оба параметра допускают оптимизацию. Это позволяет исследовать разные размеры окна при бэктестинге. Поскольку стратегия не торгует, оптимизация влияет только на содержимое отчёта.

## Пример журнала
```
Horizontal resolution: 100
Vertical resolution (points): 120
Summary:
Total bars processed: 523
Visible bars: 100
Last visible bar index: 522
First visible bar index: 423
Shift bars: 0
Horizontal:
Price range: 1.23450
Minimum price: 1.09500
Maximum price: 1.23450
Vertical:
Chart parameters updated.
```
Значения пересчитываются на каждой новой свече. Если инструмент не предоставляет `PriceStep`, стратегия возвращается к расчёту шага как `10^-digits`, что полностью повторяет логику MQL-версии.

## Рекомендации по использованию
- Запустите стратегию на нужном инструменте и выберите тот же тип свечей, который используется в вашем графике.
- Настройте `VisibleBars` так, чтобы число баров соответствовало ширине видимой области или интересующему интервалу анализа.
- Просматривайте отчёт в журнале терминала или в лог-файле. Для удобства свечи автоматически выводятся на график, однако дополнительных визуальных объектов стратегия не рисует.
- Поскольку заявок нет, защитные механизмы и управление рисками не активируются.

## Отличия от оригинального MQL-скрипта
- Вместо функций пользовательского интерфейса (`WindowBarsPerChart()`, `WindowPriceMin()` и т. п.) используются индикаторы и внутренние счётчики. Это делает стратегию независимой от конкретной реализации графика.
- Alert-сообщения заменены на записи в журнале, что удобнее для автоматического мониторинга и позволяет сохранять полную историю диагностики.
- Обновление выполняется автоматически при появлении новой свечи. В MetaTrader-версии для обновления значений скрипт приходилось запускать повторно.

## Дополнительные замечания
- Стратегия не совершает сделок и не изменяет состояние портфеля.
- Лог можно анализировать внешними инструментами, строить дашборды или подключать уведомления.
- Если значение `VisibleBars` превышает количество обработанных баров, в отчёте отображается фактическое число доступных баров и величина недостающего сдвига (`Shift bars`), как и в оригинальном скрипте.
