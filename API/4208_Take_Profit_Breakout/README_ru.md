# Стратегия прорыва с фиксацией прибыли
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет советник MetaTrader «take-profit» и отслеживает четыре подряд идущие свечи со строго возрастающими или убывающими максимумами и ценами открытия. Если свечи формируют возрастающую последовательность, открывается покупка по рынку, при зеркальном условии — продажа. Управление сделками реализовано через глобальную цель по прибыли, трейлинг-стоп с возможностью частичной фиксации позиции и настраиваемый стоп-лосс в шагах цены.

По умолчанию анализируются минутные свечи, но тип свечей и смещения можно менять под конкретный инструмент. Объём позиций задаётся фиксированным числом лотов либо вычисляется от стоимости портфеля и процента риска. При каждом продвижении трейлинг-стопа стратегия может закрывать половину оставшейся позиции, фиксируя прибыль и оставляя «хвост» для дальнейшего движения.

Когда рыночная стоимость портфеля превышает стартовый капитал на величину `ProfitTarget`, стратегия немедленно закрывает позицию и отменяет активные заявки, полностью повторяя логику оригинального советника. Проверка корректности процентов риска гарантирует, что рассчитанный объём соответствует шагу объёма инструмента.

## Подробности

- **Входы**:
  - **Покупка**: четыре отслеживаемые свечи показывают строго возрастающие максимумы и цены открытия.
  - **Продажа**: четыре свечи демонстрируют строго убывающие максимумы и цены открытия.
- **Управление позицией**:
  - Необязательный стоп-лосс устанавливается на величину `StopLossPoints` от цены входа.
  - Трейлинг-стоп подтягивается, когда цена проходит расстояние `TrailingStopPoints` от точки входа.
  - При каждом обновлении трейлинг-стопа, если включена опция `PartialClose`, закрывается половина текущего объёма с учётом шага объёма.
- **Цель по счёту**: при выполнении условия `equity ≥ initial equity + ProfitTarget` все позиции закрываются, заявки отменяются.
- **Риск-менеджмент**:
  - Фиксированный объём использует параметр `Lots` (или `Volume`, если задан базовым классом).
  - Процентный режим рассчитывает объём как `equity * RiskPercent / max(stopDistance, price)` и нормализует его по шагу объёма.
- **Значения по умолчанию**:
  - `Shift1` = 0, `Shift2` = 1, `Shift3` = 2, `Shift4` = 3.
  - `TrailingStopPoints` = 1, `StopLossPoints` = 0, `ProfitTarget` = 1 (валюта счёта).
  - `Lots` = 1, `RiskPercent` = 1, `MaxOrders` = 1.
  - `CandleType` = минутный таймфрейм.
- **Лучше всего работает** на трендовых фьючерсах, основных валютных парах и ликвидных криптоактивах с устойчивыми импульсами.
- **Плюсы**: быстрый отклик на импульс, цель по счёту, частичное закрытие и понятный контроль риска.
- **Минусы**: чувствительность к боковику, требовательность к корректным шагам цены и объёма, расчёт ведётся в неттинговом режиме (одна агрегированная позиция).

## Параметры

| Имя | Описание |
| --- | --- |
| `Shift1` – `Shift4` | Индексы свечей, которые сравниваются при поиске прорыва. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа в шагах цены. |
| `StopLossPoints` | Начальный стоп-лосс в шагах цены; 0 — без стоп-лосса. |
| `ProfitTarget` | Цель по прибыли в валюте счёта, после достижения которой позиции закрываются. |
| `Lots` | Фиксированный объём при отключённом риск-менеджменте. |
| `RiskManagement` | Переключатель процентного режима расчёта объёма. |
| `RiskPercent` | Процент от капитала, используемый для расчёта объёма при активном риск-менеджменте. |
| `PartialClose` | Включает частичное закрытие при продвижении трейлинг-стопа. |
| `MaxOrders` | Максимальное количество базовых единиц (ограничение нетто-позиции). |
| `CandleType` | Тип свечей для анализа. |

## Рекомендации

1. Подбирайте смещения `Shift` в зависимости от волатильности инструмента: большие значения анализируют более длинные импульсы.
2. Согласовывайте `TrailingStopPoints` с шагом цены, чтобы избежать хаотичных срабатываний.
3. При использовании процентного режима обязательно задавайте `StopLossPoints`, чтобы риск на сделку был контролируемым.
4. После достижения цели по прибыли стратегия прекращает торговлю до ручного перезапуска — это особенность оригинального советника.
