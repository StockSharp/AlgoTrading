# Стратегия Bull vs Medved

## Обзор
Bull vs Medved — это перенос советника MetaTrader 4 *Bull_vs_Medved.mq4* на платформу StockSharp. Стратегия пытается
подключиться к откату после сильного импульса: в течение шести заранее определённых пятиминутных окон она выставляет
отложенные лимитные заявки. Перенос сохранил ограничения «не более одной сделки в окно», удаление протухших заявок и
использование длины свечного тела для расчёта динамических стоп-лоссов и тейк-профитов.

## Логика торговли
1. Подписаться на поток свечей типа `CandleType` и обрабатывать только завершённые свечи.
2. Хранить две предыдущие свечи, чтобы текущая (`shift1`), предыдущая (`shift2`) и свеча до неё (`shift3`) соответствовали
   обращениям `Close[1..3]` в исходном коде MetaTrader.
3. Во время каждого окна (`EntryWindowMinutes` минут, начиная с `StartTime0..5`) проверять следующие паттерны:
   - **Bull**: закрытие `shift3` выше открытия `shift2`, тело `shift2` не меньше 10 пунктов брокера, тело `shift1` не меньше
     `CandleSizePoints`. Если условие `IsBadBull` ложно (нет трёх длинных бычьих свечей подряд) — выставить лимитную покупку.
   - **Cool Bull**: `shift2` — откат минимум на 20 пунктов, закрывшийся ниже открытия `shift1`; сама `shift1` закрылась выше
     открытия `shift2` и имеет тело не меньше 40% порога — выставить лимитную покупку.
   - **Bear**: `shift1` — медвежья свеча с телом не меньше `CandleSizePoints` — выставить лимитную продажу.
4. Лимит на покупку ставится по цене `ask - BuyIndentPoints * PriceStep`, лимит на продажу — по `bid + SellIndentPoints * PriceStep`.
   Если позиция или заявка уже существует, сигналы в текущем окне игнорируются.
5. Стопы и цели скрыты внутри стратегии. После исполнения заявки тело `shift1` умножается на `StopLossMultiplier` и
   `TakeProfitMultiplier`, нормализуется по `PriceStep`, и полученные уровни сохраняются как защитные.
6. После закрытия каждой свечи стратегия проверяет, не пробиты ли сохранённые уровни максимумом/минимумом. При срабатывании
   позиция закрывается рыночным ордером, а защита сбрасывается.
7. Отложенные заявки, которым больше 230 минут, снимаются — как и в оригинале. Флаг `_orderPlacedInWindow` сбрасывается, когда
   время выходит за пределы торгового окна.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `OrderVolume` | `decimal` | `0.1` | Объём каждой лимитной заявки. |
| `CandleSizePoints` | `decimal` | `75` | Минимальная длина тела сигнальной свечи (в пунктах брокера). |
| `StopLossMultiplier` | `decimal` | `0.8` | Множитель тела свечи для расчёта стоп-лосса. |
| `TakeProfitMultiplier` | `decimal` | `0.8` | Множитель тела свечи для расчёта тейк-профита. |
| `BuyIndentPoints` | `decimal` | `16` | Количество пунктов, вычитаемых из ask при выставлении buy limit. |
| `SellIndentPoints` | `decimal` | `20` | Количество пунктов, добавляемых к bid при выставлении sell limit. |
| `EntryWindowMinutes` | `int` | `5` | Длительность каждого торгового окна. |
| `CandleType` | `DataType` | пятиминутные свечи | Свечной поток, с которым работает стратегия. |
| `StartTime0..5` | `TimeSpan` | `00:05`, `04:05`, `08:05`, `12:05`, `16:05`, `20:05` | Начало каждого окна. |

## Отличия от оригинального советника
- В MetaTrader стоп и цель прикреплялись к самой отложенной заявке. В StockSharp они моделируются скрытыми уровнями и закрытием
  чистой позиции по рынку при достижении цены.
- Пороговые величины рассчитываются через `Security.PriceStep`, поэтому стратегия корректно работает и на 4-, и на 5-значных
  котировках без дополнительных коэффициентов.
- Стопы проверяются только на закрытых свечах, тогда как на сервере MetaTrader они могли сработать внутри бара.
- Звуковые уведомления и комментарии заявок не переносились — для диагностики достаточно логов StockSharp.

## Рекомендации по применению
- Стратегия ориентирована на валютные пары с дробными пунктами. Убедитесь, что `PriceStep` совпадает с ожидаемым размером
  пункта, иначе фильтры по телу свечи исказятся.
- Поскольку стоп и цель скрытые, имеет смысл использовать стратегию в отдельной сессии или дополнить брокерскими защитами на
  случай обрыва связи.
- При необходимости скорректируйте `StartTime` под торговую сессию брокера. Чтобы отключить окно, задайте время вне рабочего
  диапазона.
- Добавьте стратегию на график: так проще убедиться, что в каждом окне появляется не более одной лимитной заявки.
