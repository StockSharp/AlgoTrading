# Стратегия Multi Stochastic

## Общее описание
Multi Stochastic — это высокоуровневая реализация StockSharp советника MetaTrader 5 «Multi Stochastic (barabashkakvn's edition)». Стратегия одновременно отслеживает до четырёх валютных инструментов и опирается на сигналы осциллятора Стохастик (параметры 5, 3, 3). Для каждого инструмента может быть открыта только одна позиция: покупка при выходе из перепроданности и продажа при выходе из перекупленности. Закрытие позиций осуществляется по фиксированным стоп-лоссам и тейк-профитам в пунктах.

## Логика входов и выходов
- Для каждого подключённого инструмента создаётся собственный индикатор StochasticOscillator с длиной 5 и сглаживаниями %K/%D по 3 периода.
- Сигнал на покупку возникает, когда текущая %K опускается ниже `OversoldLevel` (по умолчанию 20), на предыдущей свече %K находилась ниже %D, а на текущей свече %K пересекает %D снизу вверх.
- Сигнал на продажу возникает, когда текущая %K поднимается выше `OverboughtLevel` (по умолчанию 80), на предыдущей свече %K находилась выше %D, а на текущей свече %K пересекает %D сверху вниз.
- Новые сделки не открываются, пока по инструменту уже есть активная позиция.

## Управление рисками
- Значения стоп-лосса и тейк-профита задаются в пунктах. Внутри стратегии пункты преобразуются в абсолютную цену на основе `Security.PriceStep` с поправкой на трёх- и пятизначные котировки (пункт = шаг цены × 10).
- Длинные позиции закрываются, если минимум свечи достигает стоп-уровня или максимум свечи достигает тейк-профита.
- Короткие позиции закрываются, если максимум свечи достигает стоп-уровня или минимум свечи достигает тейк-профита.
- Если биржевые метаданные не позволяют рассчитать размер пункта, защитные уровни отключаются во избежание некорректных закрытий.

## Параметры
- `CandleType` — используемый таймфрейм свечей (по умолчанию 1 час).
- `StochasticLength` — длина осциллятора Стохастик (по умолчанию 5).
- `StochasticKPeriod` — сглаживание %K (по умолчанию 3).
- `StochasticDPeriod` — сглаживание %D (по умолчанию 3).
- `OversoldLevel` — порог перепроданности (по умолчанию 20).
- `OverboughtLevel` — порог перекупленности (по умолчанию 80).
- `StopLossPips` — расстояние до стоп-лосса в пунктах (по умолчанию 50).
- `TakeProfitPips` — расстояние до тейк-профита в пунктах (по умолчанию 10).
- `UseSymbol1` … `UseSymbol4` — включение обработки соответствующего инструмента (по умолчанию true).
- `Symbol1` … `Symbol4` — инструменты для торговли. Если `Symbol1` не задан, используется основной инструмент стратегии.

## Особенности реализации
- Для каждого инструмента выполняется отдельная подписка `SubscribeCandles` с `BindEx`, позволяющая получать значения `StochasticOscillatorValue` вместе со свечами.
- Предыдущие значения %K и %D сохраняются по каждому инструменту, чтобы повторить оригинальную логику пересечений из MT5.
- Защитные уровни пересчитываются при каждом входе и сбрасываются после закрытия позиции либо при отсутствии открытых сделок.
- Ордера выставляются методами `BuyMarket` и `SellMarket` с использованием общего параметра `Volume`, что соответствует ограничению на одну позицию из исходного советника.

## Отличия от версии MT5
- Вместо ручного обновления котировок применяются высокоуровневые подписки StockSharp.
- Расчёт размера пункта выполняется через свойства `Security.PriceStep` и `Security.Decimals`. Если данные недоступны, стопы и тейки отключаются.
- Логирование и визуализация подготовлены к расширению, но не обязательны для базовой работы.

## Рекомендации по использованию
1. Назначьте нужные инструменты параметрам `Symbol1`…`Symbol4` и выберите подходящий таймфрейм свечей.
2. Убедитесь, что выбранные стопы и тейки соответствуют тик-сайзу инструмента и не приводят к мгновенным закрытиям.
3. Отключайте неиспользуемые слоты инструментов, чтобы снизить нагрузку при мониторинге меньшего количества инструментов.
