# Стратегия Auto SLTP Manager

## Описание
**Auto SLTP Manager Strategy** — адаптация советника MetaTrader 5 «AutoSLTP» для платформы StockSharp. Стратегия постоянно
поддерживает уровни стоп-лосса и тейк-профита по текущему инструменту, используя внешний конфигурационный файл. Она не открывает
сделки самостоятельно, а занимается сопровождением уже открытых позиций. После появления позиции стратегия отслеживает последнюю
цену сделки и подтягивает защитные уровни в соответствии с правилами, заданными в файле настроек. При достижении цены одного из
уровней позиция закрывается рыночным ордером.

## Особенности
- **Внешняя конфигурация.** Правила подтягивания читаются из текстового файла и могут изменяться без перекомпиляции кода.
- **Раздельные параметры для лонгов и шортов.** Для каждой стороны допускаются собственные расстояния стоп-лосса и тейк-профита.
- **Автоматическая работа с пунктами.** Значения в пунктах конвертируются в абсолютные цены с учётом `PriceStep` и поправки для
  трёх- и пятизнаковых котировок, как в оригинальной версии.
- **Контроль частоты обновления.** Пересчёт уровней выполняется не чаще, чем заданный `UpdateInterval`, чтобы избежать лишних
  модификаций заявок.
- **Проверки корректности.** Стратегия игнорирует пустые строки и комментарии, валидирует числовые поля и останавливается с
  понятным сообщением, если для выбранного инструмента не найдено ни одной записи.

## Конфигурационный файл
Путь к файлу задаётся параметром `ConfigurationPath`. Каждая строка должна иметь формат `symbol*position_type*sl*tp`, где:

| Поле             | Описание                                                                                                      |
|------------------|---------------------------------------------------------------------------------------------------------------|
| `symbol`         | Идентификатор инструмента. Допускается `Security.Id` (например, `EURUSD@FXCM`) или короткий код `Security.Code`. |
| `position_type`  | Тип позиции: `POSITION_TYPE_BUY` для длинных правил или `POSITION_TYPE_SELL` для коротких.                    |
| `sl`             | Расстояние стоп-лосса в пунктах. Должно быть положительным целым числом.                                      |
| `tp`             | Расстояние тейк-профита в пунктах. Должно быть положительным целым числом.                                    |

Пример (`AutoSLTP/AutoSLTP.txt`):

```
EURUSD*POSITION_TYPE_BUY*50*96
EURUSD*POSITION_TYPE_SELL*40*46
```

Пустые строки и комментарии, начинающиеся с `#`, игнорируются. Стратегия загружает только записи, совпадающие с инструментом,
переданным стратегии; остальные строки остаются в файле для других инструментов.

## Параметры
| Имя                | Тип       | Значение по умолчанию        | Описание                                                                                       |
|--------------------|-----------|------------------------------|-------------------------------------------------------------------------------------------------|
| `ConfigurationPath`| `string`  | `AutoSLTP/AutoSLTP.txt`      | Относительный или абсолютный путь к конфигурационному файлу.                                   |
| `UpdateInterval`   | `TimeSpan`| `00:00:10` (10 секунд)       | Минимальная пауза между пересчётами защитных уровней.                                          |

Путь приводится к абсолютному виду через `Path.GetFullPath`, поэтому относительные значения рассчитываются относительно рабочего
каталога приложения.

## Логика сопровождения
1. При поступлении новой сделки стратегия проверяет, прошёл ли заданный интервал времени с момента предыдущего обновления.
2. Если открыта длинная позиция:
   - при снижении цены до сохранённого стоп-уровня выполняется `SellMarket` на весь объём и внутренние данные сбрасываются;
   - при росте цены до уровня тейк-профита также выполняется рыночное закрытие `SellMarket`.
3. Если ни одно условие выхода не выполнено, стратегия подтягивает стоп до `price - sl_distance` и тейк до `price + tp_distance`,
   когда новая цена даёт более выгодные уровни.
4. Для короткой позиции логика зеркально симметрична и использует `BuyMarket`.
5. Когда позиция закрыта, накопленные уровни очищаются, чтобы следующее сопровождение началось с новой цены входа.

Пункты преобразуются в абсолютные значения через `PriceStep`. Для инструментов с тремя или пятью знаками после запятой расстояние
умножается на 10, что полностью повторяет корректировку в MetaTrader.

## Отличия от оригинального советника
- Вместо модификации заявок брокера стратегия закрывает позиции рыночными ордерами. Это позволяет работать даже с коннекторами,
  не поддерживающими защитные заявки.
- Ошибки в файле настроек приводят к остановке стратегии с ясным сообщением, а не к тихому выводу в лог, как в MQL.
- Используются события от `SubscribeTrades()` вместо регулярного опроса списка позиций каждые 10 секунд.
- Стратегия управляет только тем инструментом, к которому привязана, что соответствует архитектуре StockSharp.

## Рекомендации по использованию
1. Подготовьте файл с правилами в требуемом формате и разместите его по пути `ConfigurationPath`.
2. Запустите стратегию совместно с коннектором и торговой логикой, открывающей позиции.
3. После появления позиции стратегия начнёт сопровождение согласно дистанциям из файла.
4. Настройте `UpdateInterval` под требуемую скорость реакции: слишком маленькое значение может приводить к лишним заявкам, слишком
   большое — к задержкам.
5. Следите за логом. При отсутствии конфигурации для инструмента стратегия завершит работу и укажет проблемную строку.

## Ограничения
- Стратегия не генерирует входы в рынок — только сопровождает уже существующие позиции.
- Для одновременной работы с несколькими инструментами требуется запуск нескольких экземпляров или создание обёртки, запускающей
  несколько стратегий.
- Скорость реакции зависит от частоты входящих сделок; на редких тикерах фактическая задержка может превышать `UpdateInterval`.

