# Auto SLTP Manager 策略

## 概述
**Auto SLTP Manager Strategy** 将 MetaTrader 5 的 AutoSLTP 管理器移植到 StockSharp。策略专注于风险控制，不产生进场信号，
而是根据外部配置文件为当前品种的持仓持续调整止损和止盈距离。当持仓存在时，它读取最新成交价格，按照配置中指定的
距离逐步抬升（或下调）止损和止盈。一旦价格触及任一保护水平，策略会通过市价单立即平仓。

## 策略特点
- **外部配置文件**：通过文本文件为不同品种与方向指定独立的止损、止盈距离，可随时修改而无需重新编译。
- **方向区分**：支持为多头与空头分别设置不同的点数距离，满足复杂风控需求。
- **点值换算**：根据 `Security.PriceStep` 自动将点数转换为价格差，并对 3/5 位小数报价应用与原 MQL 版本一致的倍率修正。
- **时间节流**：通过 `UpdateInterval` 控制更新频率，避免过于频繁地重新计算保护水平。
- **健壮性检查**：对格式、数值、符号匹配进行严格校验，缺失配置时会在启动阶段抛出清晰的异常信息。

## 配置文件格式
`ConfigurationPath` 参数指定配置文件路径。每行使用 `symbol*position_type*sl*tp` 结构：

| 字段             | 说明                                                                                         |
|------------------|----------------------------------------------------------------------------------------------|
| `symbol`         | 品种标识，可与 `Security.Id`（如 `EURUSD@FXCM`）或 `Security.Code`（如 `EURUSD`）匹配。           |
| `position_type`  | 方向标识：`POSITION_TYPE_BUY` 表示多头规则，`POSITION_TYPE_SELL` 表示空头规则。                |
| `sl`             | 止损点数，必须为正整数。                                                                     |
| `tp`             | 止盈点数，必须为正整数。                                                                     |

示例（`AutoSLTP/AutoSLTP.txt`）：

```
EURUSD*POSITION_TYPE_BUY*50*96
EURUSD*POSITION_TYPE_SELL*40*46
```

以 `#` 开头的注释和空行会被忽略。策略只会加载与当前策略绑定证券匹配的记录，其余行可供其他策略复用。

## 参数说明
| 参数名              | 类型       | 默认值                     | 描述                                                                             |
|---------------------|------------|----------------------------|----------------------------------------------------------------------------------|
| `ConfigurationPath` | `string`   | `AutoSLTP/AutoSLTP.txt`    | 指向配置文件的相对或绝对路径。                                                   |
| `UpdateInterval`    | `TimeSpan` | `00:00:10`（10 秒）        | 连续两次重新计算之间的最小时间间隔。                                             |

配置路径会通过 `Path.GetFullPath` 解析，因此相对路径基于程序的工作目录。

## 运行流程
1. 订阅成交数据后，策略按 `UpdateInterval` 限制更新频率。
2. 当存在多头仓位时：
   - 如果最新价格跌破保存的止损水平，则使用 `SellMarket` 全量平仓并重置内部状态；
   - 如果最新价格上涨至止盈水平，同样使用 `SellMarket` 平仓；
   - 否则，根据当前价格计算新的止损（`price - sl_distance`）和止盈（`price + tp_distance`），并在更有利时更新。
3. 当存在空头仓位时，逻辑对称，使用 `BuyMarket` 完成平仓，并根据价格下移止损、止盈。
4. 无仓位时清空保存的保护价，下一次持仓将从新的价格起点开始跟踪。

点数转换采用 `PriceStep` 并在报价为 3 或 5 位小数时乘以 10，完全复制原始 MQL 实现的处理方式。

## 与 MQL 版本的差异
- StockSharp 版本使用市价平仓而非修改券商端的止损/止盈委托，以适应不支持保护单的交易通道。
- 配置解析错误会在启动时抛出异常并终止策略，避免悄然失败。
- 通过 `SubscribeTrades()` 获取成交数据，无需每 10 秒轮询持仓信息。
- 策略实例只管理绑定的单一证券，符合 StockSharp 策略模型。

## 使用建议
1. 按格式准备配置文件，并确保路径与 `ConfigurationPath` 一致。
2. 启动连接器及其他负责开仓的策略，同时启动 Auto SLTP Manager。
3. 当出现新仓位时，策略会自动开始移动保护价；如需要更快或更慢的响应，可调整 `UpdateInterval`。
4. 建议将配置文件纳入版本控制，以便记录风险参数的变化历史。
5. 如果运行日志提示未找到配置，请及时修正文件后重新启动策略。

## 限制说明
- 策略不负责产生交易信号，仅执行风控管理。
- 如需同时管理多个品种，请启动多个策略实例或编写调度器分别挂载不同证券。
- 保护价调整依赖成交数据，如果行情更新稀疏，实际响应时间可能大于 `UpdateInterval`。

