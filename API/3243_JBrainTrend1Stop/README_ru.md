# Стратегия JBrainTrend1Stop

**JBrainTrend1Stop** — порт советника MetaTrader 5 `Exp_JBrainTrend1Stop` на платформу StockSharp. Стратегия сочетает две оценки Average True Range, осциллятор Stochastic и три Jurik Moving Average для обнаружения разворотов BrainTrading. Когда сглаженная Jurik цена делает достаточно сильный импульс и Stochastic выходит из нейтральной зоны, стратегия переключает направление, обновляет линию BrainTrend и (при необходимости) переворачивает позицию после заданной задержки.

## Логика работы

1. Подписываемся на свечи типа `CandleType` и подаём их на:
   - Основной `AverageTrueRange` длиной `AtrPeriod`.
   - Дополнительный `AverageTrueRange` длиной `AtrPeriod + StopDPeriod`.
   - `StochasticOscillator` с периодом `StochasticPeriod` и сглаживанием %K в один бар (как в MT5).
   - Три `JurikMovingAverage` (для High, Low и Close) с параметрами `JmaLength` и `JmaPhase`.
2. Для каждой закрывшейся свечи вычисляем:
   - `range = ATR / 2.3` — аналог константы `d` из оригинала.
   - `range1 = ATR_extended * 1.5` — аналог константы `s`.
   - `val3 = |JMA_close - JMA_close[сдвиг 2]|`, воспроизводя разность буферов MT5.
3. Если `val3 > range` и Stochastic вышел из нейтральной зоны:
   - При `%K < 47` фиксируем медвежий режим (`_trendState = -1`), инициализируем стоп `JMA_high + range1 / 4` и формируем **sell**-сигнал.
   - При `%K > 53` переходим в бычий режим (`_trendState = 1`), инициализируем стоп `JMA_low - range1 / 4` и формируем **buy**-сигнал.
4. Пока режим не меняется, линия BrainTrend подтягивается к цене на величину `range1` (`JMA_high + range1` для продаж, `JMA_low - range1` для покупок).
5. Сигнал выполняется после `SignalBar` закрытых свечей. При исполнении:
   - Buy-сигнал закрывает шорты (если `SellClose = true`) и, при разрешении `BuyOpen`, открывает новый лонг.
   - Sell-сигнал закрывает лонги (если `BuyClose = true`) и, при `SellOpen = true`, открывает шорт.

На графике автоматически рисуются Jurik-сглаженное закрытие, осциллятор Stochastic и сделки.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Тип свечей, используемый стратегией. | H4 (4-часовые свечи) |
| `AtrPeriod` | Длина основного ATR, запускающего BrainTrend. | 7 |
| `StochasticPeriod` | Период %K/%D Stochastic (с однобарным сглаживанием %K). | 9 |
| `StopDPeriod` | Дополнительные бары в периоде второго ATR (`AtrPeriod + StopDPeriod`). | 3 |
| `JmaLength` | Длина Jurik Moving Average для high/low/close. | 7 |
| `JmaPhase` | Фаза Jurik (ограничивается диапазоном [-100; 100]). | 100 |
| `SignalBar` | Сколько закрытых свечей ждать перед отправкой сигнала. | 1 |
| `BuyOpen` / `SellOpen` | Разрешить открытие лонга/шорта. | `true` |
| `BuyClose` / `SellClose` | Разрешить закрытие существующих позиций при обратном сигнале. | `true` |

Объём сделки задаётся через свойство `Volume` стратегии или настройки брокера.

## Отличия от версии MT5

- Блок управления капиталом (`MM`, `MMMode`, `Deviation_`, динамический лот) заменён стандартным выставлением объёма через `Volume` и рыночные ордера StockSharp. Учёт проскальзывания не реализован.
- Абсолютные уровни `StopLoss_` и `TakeProfit_` не перенесены. При необходимости настройте защиту на стороне терминала или риск-менеджера.
- Линии BrainTrend используются только для вычисления сигналов; отложенные ордера по ним не выставляются.
- Jurik Moving Average берётся из библиотеки StockSharp. Параметр фазы устанавливается через reflection, как и в других BrainTrading-стратегиях репозитория.

## Использование

1. Привяжите стратегию к инструменту и задайте `CandleType` (для соответствия оригиналу — 4-часовые свечи).
2. Настройте параметры индикаторов (`AtrPeriod`, `StochasticPeriod`, `StopDPeriod`, `JmaLength`, `JmaPhase`) под требуемую чувствительность BrainTrend.
3. Регулируйте `SignalBar`, если нужна задержка между появлением сигнала и входом в позицию.
4. Установите `Volume` и флаги открытия/закрытия (`BuyOpen`, `SellOpen`, `BuyClose`, `SellClose`) под вашу торговую модель.
5. При необходимости добавьте внешние ограничения по риску (стоп-лоссы, лимиты портфеля и т. п.) средствами хоста.

После запуска стратегия отслеживает развороты BrainTrend, закрывает противоположные позиции и, при необходимости, разворачивает позицию после заданной задержки.
