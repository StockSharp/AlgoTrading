# Стратегия Neural Network ATR

## Обзор

Стратегия переносит логику советника "Neurotest" в экосистему StockSharp, сочетая
легковесный нейронный слой и управление рисками на базе ATR. Каждая завершённая свеча
M15 (параметр настраивается) преобразуется в пять нормализованных признаков: импульс
закрытия, внутридневной диапазон, размер тела, рост объёма и относительную волатильность
(отношение ATR к цене). Одно скрытое звено с сигмоидальным выходом генерирует
вероятностный сигнал, который масштабируется адаптивной скоростью обучения и сравнивается
с порогами покупок и продаж.

## Правила торговли

1. Подписаться на свечи выбранного таймфрейма и вычислить ATR того же периода.
2. Построить пять нормализованных признаков по предыдущей и текущей завершённой свече,
   затем вычислить отклик нейронной сети.
3. Если скорректированный прогноз выше порога покупок и позиция не длинная — открыть
   длинную позицию (или закрыть короткую и перевернуться).
4. Если прогноз ниже порога продаж и позиция не короткая — открыть короткую позицию.
5. После входа прикрепить стоп-лосс и тейк-профит, рассчитывая расстояние по ATR.
   При отсутствии значений ATR использовать резервное расстояние в пунктах.
6. Если текущий спред превышает заданный лимит, свеча игнорируется.

## Управление рисками

- Объём позиции рассчитывается так, чтобы убыток по стоп-лоссу равнялся `Max Risk %`
  от капитала счёта.
- Защитные заявки используют настраиваемое соотношение риск/прибыль.
- Торговля автоматически приостанавливается при превышении дневной или общей просадки.
- Пенальти снижает скорость обучения на 10% (до минимального уровня), если дневная
  цель по прибыли не достигнута. На следующем торговом дне штраф сбрасывается.

## Параметры

| Параметр | Описание |
|----------|----------|
| **Max Risk %** | Максимальный риск на сделку в процентах от капитала. |
| **Daily Loss %** | Допустимая дневная просадка. |
| **Total Loss %** | Максимальная совокупная просадка. |
| **Daily Profit %** | Цель по дневной прибыли для отмены штрафа. |
| **Learning Rate** | Масштабирование выходного сигнала нейросети. |
| **Hidden Layer** | Количество нейронов скрытого слоя. |
| **Buy Threshold / Sell Threshold** | Пороги открытия длинных и коротких позиций. |
| **Candle Type** | Тип и таймфрейм свечей для расчётов. |
| **ATR Period** | Период индикатора ATR. |
| **Max Spread** | Максимально допустимый спред в шагах цены. |
| **Risk Reward** | Множитель тейк-профита относительно стопа. |
| **Fallback Stop** | Стоп-лосс в пунктах при отсутствии ATR. |

## Примечания

- Требуется подписка Level1, чтобы контролировать bid/ask спред перед каждым решением.
- Веса нейросети инициализируются детерминированно (seed 42), а динамика скорости
  обучения имитирует адаптивное поведение исходного советника.
- Для корректного расчёта объёма убедитесь, что портфель предоставляет `CurrentValue`,
  `StepPrice` и ограничения по объёму.
