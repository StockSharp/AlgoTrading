# Стратегия NRTR Revers

## Обзор

NRTR Revers – это перенос советника MetaTrader 5 `NRTR_Revers.mq5` на платформу StockSharp. Стратегия использует подход Nick Rypock Trailing Reverse (NRTR) и меняет торговый уклон между покупкой и продажей в зависимости от того, как цена взаимодействует с диапазонами, построенными по ATR. Все расчёты выполняются на закрытии завершённых свечей выбранного таймфрейма.

## Логика торговли

1. **ATR-проекция** – рассчитывается средний истинный диапазон (ATR) с настраиваемым периодом и умножается на коэффициент `VolatilityMultiplier`, чтобы получить ширину защитной полосы.
2. **Динамические уровни** – для текущего направления:
   - Определяется минимум (или максимум) в окне, полностью повторяющем оригинальный MQL-алгоритм.
   - Ищется дополнительный экстремум глубже по истории; его расстояние до основной полосы сравнивается с параметром `ReversePips`, чтобы подтвердить сильное движение.
3. **Переворот тренда** – если предыдущая свеча закрылась за пределами ATR-полосы или расстояние до вторичного экстремума превышает заданный порог, уклон стратегии меняется (BUY → SELL или SELL → BUY). При наличии обратной позиции она закрывается, после чего открывается новая сделка в нужную сторону.
4. **Ожидание плоской позиции** – после принудительного закрытия позиции стратегиия ждёт, пока позиция станет нулевой, и только затем размещает заявку в новом направлении. Такое поведение полностью воспроизводит логику исходного советника.
5. **Управление рисками** – стоп-лосс, тейк-профит и трейлинг задаются в пунктах и переводятся в цену с учётом скорректированного шага (корректно для инструментов с 3 и 5 знаками). Трейлинг переносится только при приросте больше, чем `TrailingStopPips + TrailingStepPips`, то есть точь-в-точь как в версии для MT5.

## Параметры

- `CandleType` – таймфрейм, по которому подписываются свечи.
- `AtrPeriod` – период сглаживания ATR.
- `VolatilityMultiplier` – множитель ATR, определяющий отступ от экстремума.
- `ReversePips` – дополнительное расстояние в пунктах, которое должен преодолеть вторичный экстремум для смены тренда.
- `StopLossPips` – расстояние от входа до стоп-лосса (0 отключает уровень).
- `TakeProfitPips` – расстояние от входа до тейк-профита (0 отключает уровень).
- `TrailingStopPips` – глубина включения трейлинг-стопа (0 отключает трейлинг).
- `TrailingStepPips` – минимальный дополнительный профит для переноса трейлинг-стопа; при включённом трейлинге должен быть больше нуля.
- `TradeVolume` – объём заявки в единицах инструмента (лоты, контракты и т. п.).

## Примечания

- Стратегия работает только с завершёнными свечами и игнорирует незакрытые бары.
- Получаемое через `Bind` значение ATR соответствует `atr_array[1]` из оригинального MQL-скрипта, так как обработка происходит после закрытия свечи.
- Расчёт шага цены автоматически учитывает трёх- и пятизначные котировки, поэтому параметры в пунктах полностью совместимы с исходным советником.
- По требованию заказчика Python-версия и соответствующая папка не создавались; доступна только реализация на C#.
