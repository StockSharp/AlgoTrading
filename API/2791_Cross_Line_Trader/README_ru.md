# Стратегия Cross Line Trader

## Обзор
Стратегия повторяет логику советника MetaTrader «Cross Line Trader»: она реагирует на пересечения цены с набором заранее описанных линий. В версии для StockSharp линии не рисуются вручную на графике, а задаются одной строкой параметра. При запуске строка разбирается, после чего стратегия отслеживает только завершённые свечи. Как только новая свеча открывается по другую сторону активной линии, отправляется рыночный ордер в соответствующем направлении, а сама линия выключается, чтобы не сработать повторно.

## Торговая логика
1. Подписка идёт на тип свечей из параметра **Candle Type**; обрабатываются только свечи в состоянии `Finished`, что исключает внутридневной шум.
2. Линии создаются из параметра **Line Definitions**, каждая хранит собственное состояние: активность, счётчик обработанных баров и геометрию.
3. Для линий типа **Trend** и **Horizontal** стратегия сравнивает открытия двух соседних свечей относительно траектории линии:
   - Лонг активируется, если предыдущее открытие было ниже линии, а текущее — выше.
   - Шорт активируется, если предыдущее открытие было выше линии, а текущее — ниже.
4. **Vertical**-линии работают как таймеры: по истечении заданного числа баров позиция открывается немедленно по текущему открытию свечи.
5. Направление сделки определяется параметром **Direction Mode**:
   - `FromLabel` сопоставляет подпись линии со значениями **Buy Label** и **Sell Label**.
   - `ForceBuy` и `ForceSell` принудительно используют только одну сторону независимо от подписи.
6. После удачного срабатывания подаётся рыночный ордер объёмом из **Trade Volume**, событие записывается в лог, а линия деактивируется.
7. Параметры **Stop Loss Offset** и **Take Profit Offset** задают защитные расстояния: на каждой новой свече стратегия проверяет минимум/максимум относительно последней цены входа и при необходимости закрывает позицию.

## Формат описания линий
Параметр **Line Definitions** состоит из записей, разделённых точкой с запятой. Каждая запись имеет вид:

```
Name|Type|Label|BasePrice|SlopePerBar|Length|Ray
```

- **Name** — произвольное имя для логов, не должно содержать точек с запятой.
- **Type** — `Horizontal`, `Trend` или `Vertical` (без учёта регистра).
- **Label** — текст для сопоставления в режиме `FromLabel`.
- **BasePrice** — базовая цена линии для первой обрабатываемой свечи (десятичное число в invariant culture).
- **SlopePerBar** — изменение цены на один бар для трендовой линии; для горизонтальной укажите `0`.
- **Length** — интерпретация зависит от типа:
  - Для трендовых и горизонтальных линий без луча задаёт, насколько далеко вправо расположен конечный бар; после достижения значения линия отключается.
  - Для лучей (`Ray = true`) параметр игнорируется — линия активна бесконечно.
  - Для вертикальных линий определяет, через сколько баров сработает триггер (минимум `1`).
- **Ray** — `true` оставляет линию активной бесконечно вправо, `false` ограничивает область действия значением **Length**.

Пример строки:

```
TrendLine|Trend|Buy|1.1000|0.0005|8|false;HorizontalSell|Horizontal|Sell|1.1050|0|0|true;VerticalImpulse|Vertical|Buy|0|0|1|false
```

Здесь задана восходящая линия для покупок, горизонтальный уровень для продаж (без срока действия) и вертикальный триггер на следующую свечу.

## Параметры
- **Candle Type** — тип свечей, используемый в расчётах; по умолчанию таймфрейм 1 минута.
- **Trade Volume** — объём рыночных заявок при открытии позиции (должен быть больше нуля).
- **Direction Mode** — способ выбора направления (`FromLabel`, `ForceBuy`, `ForceSell`).
- **Buy Label / Sell Label** — подписи, определяющие сделки при режиме `FromLabel`.
- **Line Definitions** — строка с описанием всех линий (см. формат выше).
- **Stop Loss Offset** — защитное расстояние в ценовых единицах; значение `0` отключает контроль.
- **Take Profit Offset** — расстояние до цели по прибыли; `0` отключает контроль.

## Управление рисками
Отдельные стоп- и тейк-приказы не выставляются. Вместо этого стратегия на каждой закрывшейся свече проверяет:
- Для лонга: минимум <= `EntryPrice - StopLossOffset` или максимум >= `EntryPrice + TakeProfitOffset` — позиция закрывается продажей по рынку.
- Для шорта: максимум >= `EntryPrice + StopLossOffset` или минимум <= `EntryPrice - TakeProfitOffset` — позиция закрывается покупкой по рынку.

Если оба смещения равны нулю, позиция закрывается только встречным сигналом или вручную.

## Особенности реализации
- Все комментарии в исходнике написаны на английском языке согласно требованиям проекта.
- Некорректные записи в строке линий пропускаются без ошибок, поэтому рекомендуется тщательно проверять формат.
- Перезапуск стратегии сбрасывает внутренние счётчики, и ожидание по линиям начинается заново с первой новой свечи.
- Алгоритм ориентируется исключительно на цены открытия, как и оригинальный эксперт, поэтому внутрисвечные касания не учитываются.

## Порядок использования
1. Выберите торговый инструмент и подходящий тип свечей.
2. Заполните **Line Definitions**, описав все нужные уровни и трендовые линии.
3. Настройте **Direction Mode** и, при необходимости, подписи для покупок и продаж.
4. Укажите защитные расстояния, если требуется автоматический выход.
5. Запустите стратегию и следите за журналом: каждая сработавшая линия будет отмечена направлением и ценой срабатывания.
