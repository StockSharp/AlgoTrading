# Стратегия TradingLab Best MACD

Стратегия переносит эксперта MetaTrader "TradingLab_Best_MACD_Strategy" на высокоуровневый API StockSharp. Она сочетает фильтр по скользящей средней, сигналы MACD и проверку реакций цены на локальные уровни поддержки/сопротивления.

## Основная логика

- **Источник свечей** — подписка на завершённые свечи через параметр `CandleType`. Только закрытые свечи участвуют в расчётах.
- **Фильтр тренда** — простая скользящая средняя с периодом 200 определяет направление торговли. Для длинных позиций цена должна находиться выше средней, для коротких — ниже.
- **Коробка поддержки/сопротивления** — окно максимумов/минимумов длиной 20 баров имитирует индикатор "Box". Если предыдущая свеча пробивает максимум, активируется счётчик сопротивления, если минимум — счётчик поддержки. Сигналы действуют ограниченное число свечей (`SignalValidity`).
- **Пересечения MACD** — стандартный MACD (12, 26, 9) должен пересечь сигнальную линию на предыдущей свече и располагаться по нужную сторону от нулевой линии. Пересечение также сохраняет силу `SignalValidity` свечей.
- **Момент входа** — сделка открывается, когда оба условия (MACD и соответствующее касание уровня) ещё активны и хотя бы одно из них сработало на текущей свече.
- **Выход из позиции** — при входе рассчитываются уровни стоп-лосса и тейк-профита относительно средней. Дистанция тейк-профита равна `RiskRewardMultiplier` умноженной на скорректированное расстояние до стопа. Каждая новая закрытая свеча проверяет пробой заданных уровней и при необходимости вызывает `ClosePosition()`.

## Параметры

| Параметр | Описание |
|----------|----------|
| `OrderVolume` | Фиксированный объём рыночных заявок. |
| `SignalValidity` | Количество свечей, в течение которых активны сигналы MACD и коробки. |
| `MaLength` | Период простой скользящей средней. |
| `BoxPeriod` | Длина окна для определения локальных максимумов и минимумов. |
| `MacdFastLength`, `MacdSlowLength`, `MacdSignalLength` | Периоды MACD. |
| `StopDistancePoints` | Дистанция стоп-лосса в пунктах MetaTrader (умножается на шаг цены инструмента). |
| `RiskRewardMultiplier` | Множитель для расчёта дистанции тейк-профита. |
| `CandleType` | Тип свечей, используемый для подписки (по умолчанию — часовые). |

## Дополнительные замечания

- Проверка уровней опирается на максимум/минимум 20 последних свечей. Каждый пробой перезапускает соответствующий счётчик.
- Расчёт защитных уровней выполняется при каждой новой позиции и контролируется по максимуму и минимуму завершённых свечей, что обеспечивает детерминированное поведение без тиковых данных.
- Если инструмент не предоставляет `PriceStep`, используется запасное значение 0.0001 для пересчёта пунктов в цену.
