# TradingLab 最佳 MACD 策略

该策略使用 StockSharp 高阶 API 复刻 MetaTrader 专家顾问 "TradingLab_Best_MACD_Strategy"。策略把移动平均趋势过滤、MACD 金叉死叉以及动态支撑/阻力检测组合在一起，以顺势参与价格动能并利用最近的价格反应。

## 核心逻辑

- **K 线来源**：通过可配置的 `CandleType` 订阅完成的 K 线，仅在蜡烛收盘后作出决策。
- **趋势过滤**：200 周期简单移动平均线定义趋势方向。做多需要收盘价在均线之上，做空需要收盘价在均线之下。
- **支撑阻力盒**：20 周期的最高/最低窗口模拟自定义的 "Box" 指标。当上一根 K 线突破该区间的高点或低点时，分别触发做空或做多信号，并在 `SignalValidity` 根 K 线内保持有效。
- **MACD 交叉**：标准 MACD（默认 12、26、9）必须在上一根 K 线上穿或下穿信号线，并位于零轴的指定一侧。每次交叉都会在倒计时结束前保持有效，逻辑与原 EA 相同。
- **入场时机**：当 MACD 和相应的支撑/阻力触发仍然有效，并且至少一个条件在当前 K 线重新触发时，才允许开仓。
- **出场机制**：开仓后根据均线与价格之间的距离计算动态止损与止盈。止盈距离等于 `RiskRewardMultiplier` 乘以用于止损的调整距离。随后每根完成的 K 线都会检查高低点，一旦触及目标即调用 `ClosePosition()` 平仓。

## 参数

| 参数 | 说明 |
|------|------|
| `OrderVolume` | 每次市价单的固定下单量。 |
| `SignalValidity` | MACD 交叉与支撑/阻力触发保持有效的蜡烛数量。 |
| `MaLength` | 趋势过滤用的简单移动平均周期。 |
| `BoxPeriod` | 构造最高/最低盒子的回溯长度。 |
| `MacdFastLength`、`MacdSlowLength`、`MacdSignalLength` | MACD 的快线、慢线与信号线周期。 |
| `StopDistancePoints` | 止损距离，使用 MetaTrader 点数表示（乘以标的的价格步长）。 |
| `RiskRewardMultiplier` | 用于生成止盈目标的风险收益倍数。 |
| `CandleType` | 订阅的蜡烛数据类型，默认使用 1 小时周期。 |

## 说明

- 支撑与阻力的检测遵循原策略思路：观察上一根 K 线是否突破 20 周期盒子的高点或低点，一旦突破即重置倒计时。
- 每次进场都会重新计算止损与止盈，并在后续 K 线中根据高低点监控，实现可预测的出场行为。
- 保护管理依赖品种的 `PriceStep`。若品种未提供有效步长，将回退到 0.0001。 
