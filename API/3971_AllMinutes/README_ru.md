# Стратегия AllMinutes

## Обзор
**AllMinutes Strategy** — перенос скрипта MetaTrader 4 `AllMinutes.mq4`. В оригинале скрипт постоянно обновлял `.hst`-файлы нескольких офлайн-графиков, чтобы каждый минутный бар присутствовал в истории. Версия на StockSharp повторяет эту логику средствами высокоуровневого API: подписывается на указанные инструменты, выравнивает свечи по целевому таймфрейму, заполняет пропуски синтетическими барами и сохраняет результат в совместимые с MetaTrader HST-файлы.

Стратегия предназначена для сервисов подготовки данных, где коннектор StockSharp поставляет тиковые или минутные котировки в тестер MetaTrader. Торговых приказов она не выставляет и позициями не управляет.

## Основные особенности
- Произвольное количество пар «инструмент + минутный период» задаётся одной строкой `ChartList`.
- Создаёт файлы **ALL<symbol><timeframe>.hst** и записывает заголовок формата MT4 build 509 (версия 401).
- Выявляет разрывы между завершёнными свечами и добавляет плоские бары с последней ценой закрытия, при необходимости игнорируя выходные.
- Периодически сбрасывает буферы записи таймером стратегии, чтобы внешние программы сразу видели свежие данные.
- Поддерживает частичные обновления: если текущая свеча ещё формируется (`CandleStates.Active`), переписывается последняя запись вместо добавления дубликата.

## Параметры
| Параметр | Описание |
|----------|----------|
| `ChartList` | Список через запятую, например `EURUSD@FXCM 1` (инструмент и период в минутах). Суффикс площадки можно опустить, если `SecurityProvider` умеет находить инструмент. |
| `SkipWeekends` | При заполнении пропусков пропускает бары с отметками субботы, воскресенья и пятничного перехода через 23:00. Поведение идентично MQL-версии. |
| `RefreshInterval` | Интервал таймера (мс), который вызывает принудительный `Flush()` потоков. Меньшее значение ускоряет появление данных, но увеличивает нагрузку на диск. |
| `OutputDirectory` | Каталог, куда сохраняются HST-файлы. По умолчанию создаётся папка `./AllMinutes` рядом с исполняемым процессом. |

## Как работает стратегия
1. **Инициализация**: каждая запись из `ChartList` преобразуется в объект `Security` и подписку на свечи нужного периода. Открывается/создаётся соответствующий HST-файл и пишется заголовок.
2. **Подписка на данные**: запрос свечей выполняется в режиме «история + онлайн». Завершённые бары дописываются в конец, активные — перезаписывают последнюю запись.
3. **Заполнение разрывов**: перед добавлением нового бара вычисляется промежуток с предыдущим. Если он больше размера таймфрейма, добавляются плоские синтетические свечи с объёмом `1` и ценой закрытия предыдущего бара.
4. **Фильтр выходных**: при включённом `SkipWeekends` синтетические бары с отметками выходных и позднего вечера пятницы пропускаются.
5. **Сброс буферов**: таймер стратегии вызывает `Flush()` для каждого открытого потока, чтобы изменения сразу попадали на диск.

## Рекомендации по использованию
- Перед запуском привяжите рабочий `SecurityProvider` (например, из коннектора), чтобы стратегия могла найти инструменты по коду.
- Стратегия не задействует `Portfolio` и может работать параллельно с торговыми алгоритмами, использующими тот же источник данных.
- Сформированные файлы можно скопировать в каталог `MetaTrader 4\history\<broker>` для загрузки офлайн-графиков или тестера.
- Имя файла соответствует исходному правилу: `ALL{symbolCode}{timeframe}.hst`, недопустимые символы заменяются на `_`.

## Отличия от версии на MQL
- Вместо таймера и вызовов `iClose`/`iTime` используется событийная подписка на свечи высокого уровня StockSharp.
- Запись осуществляется через .NET `FileStream` и `BinaryWriter`, но структура данных полностью совместима с MT4.
- Последняя запись перезаписывается при получении активной свечи, тогда как в MQL-скрипте это выполнялось внутри `OnTimer`.
- При некорректной конфигурации генерируется `InvalidOperationException`, что облегчает диагностику в продуктивной среде.

## Ограничения
- Фильтр выходных ориентируется на UTC. Если провайдер данных использует иной торговый календарь, логику необходимо адаптировать.
- Поддерживаются только минутные периоды, поскольку исходный скрипт работал именно с ними. Для других таймфреймов потребуется расширить разбор `ChartList`.
- Генерируются только HST-файлы формата MT4 build 509; формат MetaTrader 5 (HST2) не поддерживается.

