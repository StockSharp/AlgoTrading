# AllMinutes 策略

## 概述
**AllMinutes 策略** 移植自 MetaTrader 4 脚本 `AllMinutes.mq4`。原始脚本会持续重写多个离线图的 `.hst` 历史文件，以保证每分钟都有数据。本版本使用 StockSharp 高级 API 完成同样的工作：根据配置订阅多个品种，按照目标时间框对齐蜡烛图，在缺失区间生成补足的虚拟蜡烛，并将结果写入与 MetaTrader 兼容的 HST 文件。

该策略用于数据维护流程，例如通过 StockSharp 连接器将实时数据送入 MetaTrader 测试环境。它不会提交订单或管理持仓。

## 主要特性
- 通过单个逗号分隔的参数配置任意数量的“品种 + 分钟周期”组合。
- 生成 **ALL<symbol><timeframe>.hst** 文件，并写入 MT4 build 509（版本 401）格式的文件头。
- 在检测到已完成蜡烛之间存在缺口时，会以最后一个收盘价生成平坦的补充蜡烛，可选择跳过周末时段。
- 通过策略计时器周期性刷新文件缓冲区，保证 MetaTrader 读取时数据保持最新。
- 支持部分更新：当当前蜡烛仍处于 `CandleStates.Active` 状态时，策略会覆盖最近一条记录而不是追加重复行。

## 参数
| 参数 | 说明 |
|------|------|
| `ChartList` | 逗号分隔的列表，例如 `EURUSD@FXCM 1`（品种 + 分钟周期）。如果 `SecurityProvider` 能解析品种，则交易所后缀可以省略。 |
| `SkipWeekends` | 启用后，在补齐缺口时会跳过周六、周日以及周五 23:00 的换盘分钟，完全复现原脚本逻辑。 |
| `RefreshInterval` | 计时器的间隔（毫秒），用于刷新文件流。数值越小，文件更新越快，但磁盘 I/O 频率越高。 |
| `OutputDirectory` | HST 文件的输出目录，默认是当前进程目录下的 `./AllMinutes`。 |

## 工作流程
1. **初始化**：`ChartList` 中的每个条目都会解析为一个 StockSharp `Security` 与目标分钟周期的蜡烛订阅；随后打开或创建对应的 HST 文件并写入标准文件头。
2. **订阅数据**：以历史 + 实时模式请求蜡烛。已完成的蜡烛会追加新记录，处于活动状态的蜡烛会覆盖最后一条记录，保持当前分钟最新。
3. **缺口填补**：在写入每个真实蜡烛前都会比较与前一条记录的时间差。如果大于指定周期，则生成平坦的虚拟蜡烛，重复最后一个收盘价，并使用 tick 量 `1`，与 MQL 实现完全一致。
4. **周末过滤**：当 `SkipWeekends` 为真时，所有位于周末或周五晚间换盘窗口内的虚拟蜡烛都会被跳过。
5. **刷新文件**：策略计时器定期调用 `Flush()`，确保外部程序无需关闭文件即可读取到最新数据。

## 使用建议
- 在启动策略前，请提供可用的 `SecurityProvider`（例如连接到某个交易所的 `Connector`），以便解析品种符号。
- 策略不会操作 `Portfolio`，因此可与其他交易策略同时运行，只要它们共享同一个行情源即可。
- 生成的 HST 文件可复制到 `MetaTrader 4\history\<broker>` 目录，用于离线图或测试器。
- 文件命名遵循原始约定：`ALL{symbolCode}{timeframe}.hst`，文件名中不合法的字符会被替换为 `_`。

## 与 MQL 版本的差异
- 本策略通过事件驱动的高级 API 订阅蜡烛，而原脚本使用定时器轮询历史数据。
- 使用 .NET 的 `FileStream`/`BinaryWriter` 进行磁盘写入，但严格遵循 MT4 的文件头与记录格式。
- 当接收到活动蜡烛更新时会覆盖最后一条记录，原脚本在 `OnTimer` 中完成同样的操作。
- 如果配置无效（例如找不到品种），会抛出 `InvalidOperationException`，使部署时更容易诊断问题。

## 限制
- 跳过周末的判断基于 UTC 时间。如果数据源采用其他交易日历，需要相应调整过滤逻辑。
- 仅支持分钟周期，与原脚本保持一致。如需其他周期，可扩展 `ChartList` 的解析规则。
- 始终生成 MT4 build 509（版本 401）格式的历史文件，暂不支持 MetaTrader 5 的 HST2 格式。

