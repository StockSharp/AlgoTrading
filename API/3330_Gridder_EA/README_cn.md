# Gridder EA 策略（从 MQL4 移植）

## 概述
原版 GridderEA 是 MetaTrader 4 上的多品种网格策略。StockSharp 版本保留了核心思想——可变步长、递增手数、篮子止盈止损以及紧急对冲——并专注于当前策略绑定的单一标的。策略会订阅指定周期的K线，只在K线收盘后处理数据，当价格相对最后参考价偏离到设定的点差时开出新的加仓单。

## 交易逻辑
1. **网格扩展**：基础步长（以点为单位）决定了每次加仓前的最小价格位移。之后的订单可以按照几何或指数方式扩大步长，以适应更高的波动。
2. **手数扩展**：第一笔订单使用初始手数。后续订单会按照所选模式（固定、几何或指数）乘以手数倍率。
3. **篮子目标**：通过价格偏移和合约步长计算每笔未平仓单的浮动盈亏，以账户货币表示。当总浮盈达到“每手止盈”目标时，策略会一次性平掉全部头寸；“每手止损”同理，可在亏损达到阈值时快速清空仓位。
4. **紧急模式**：当同方向的订单数量达到触发值时，可以自动开启对冲单，对冲量为当前总量的一定比例，用于模拟 MQL 版本中的 Emergency Mode，限制回撤。
5. **仓位保护**：在启动时调用 `StartProtection()`，确保策略能检测到账户中的意外持仓并与交易所状态同步。

该实现不需要遍历长历史序列，仅处理收盘后的K线，与原始 EA 在“仅已完成K线”模式下的行为一致。

## 参数说明
| 参数 | 说明 |
|------|------|
| **Initial Volume** | 第一笔网格订单的手数。 |
| **Volume Multiplier** | 几何或指数模式下用于放大手数的系数。 |
| **Grid Step (pips)** | 连续加仓之间的基础间隔（点）。 |
| **Step Multiplier** | 几何或指数步长模式下的放大系数。 |
| **Target Profit / Lot** | 按每手计算的浮盈目标，达到后平掉所有订单。 |
| **Target Loss / Lot** | 按每手计算的浮亏阈值，达到后强制止损。 |
| **Max Orders Per Side** | 单边允许的最大加仓次数，`0` 表示不限制。 |
| **Allow Long / Allow Short** | 分别控制多头和空头网格是否启用。 |
| **Step Mode** | 步长模式：固定、几何或指数。 |
| **Lot Mode** | 手数模式：固定、几何或指数。 |
| **Use Emergency Mode** | 是否启用紧急对冲逻辑。 |
| **Emergency Trigger** | 触发紧急模式所需的订单数量。 |
| **Hedge Volume Factor** | 触发紧急模式时，对冲单占总量的比例。 |
| **Candle Type** | 网格逻辑所使用的K线类型。 |

## 与原版的差异
- 该移植版本一次只管理一个证券，如需多品种交易，可同时运行多个策略实例。
- MetaTrader 中的面板和图形界面未移植，可使用 StockSharp 的图表区域显示K线和成交。
- 原策略的预设资金管理与分批平仓被简化为统一的篮子止盈/止损规则。

## 使用建议
1. 在界面或代码参数中设置K线周期、基础手数与网格步长。
2. 在连接好交易所或仿真环境后启动策略，K线订阅会自动完成。
3. 根据品种波动调整紧急触发和对冲比例，比例越大越能快速降低净敞口，但同时也会牺牲收益。
4. 建议结合 StockSharp 的组合风险控制（投资组合保护、最大仓位限制等）一同使用。

## 紧急对冲示例
假设已连续开出五笔买单，并将触发值设为 5、对冲比例设为 0.5。当第五笔买单成交时，策略会自动发送一笔等于总多头仓位一半的市价卖单，从而模拟原 EA 中的锁仓保护，等待行情回归。

## 优化提示
- 同步优化 **Grid Step (pips)** 与 **Volume Multiplier**，步长越小需要越谨慎的倍率，以免仓位膨胀过快。
- 使用 **Target Profit / Lot** 将 MetaTrader 中以美元表示的目标迁移到 StockSharp 环境，无需依赖历史成交。
- 根据标的波动度调整 **Emergency Trigger** 与 **Hedge Volume Factor**，高波动品种通常需要更早介入对冲。

## 风险控制建议
- 在实盘前务必在模拟器中进行充分测试。
- 注意券商的最小手数单位，确保 `RoundVolume` 后的结果可被接受。
- 建议额外设置组合级别的止损机制，以防长期趋势导致网格无法回撤。
