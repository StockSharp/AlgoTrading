# Стратегия PROphet

## Обзор
Эта стратегия представляет собой порт советника MetaTrader 4 «PROphet» на платформу StockSharp. Оригинальный алгоритм оценивает
взвешенный диапазон последних четырёх свечей, открывает позиции только в часы активной торговли Европы и США и постоянно подтяги
вает стоп-лосс, когда цена движется в нужную сторону. Реализация на StockSharp сохраняет те же правила и адаптирована к неттинго
вой модели портфеля.

## Логика торговли
- Подписка на выбранный таймфрейм (`CandleType`, по умолчанию M5) и обработка только закрытых свечей.
- Хранение трёх последних завершённых свечей, чтобы воспроизвести индексацию `High[i]` и `Low[i]`, используемую в MQL.
- На каждой свече вычисляются триггеры `Qu(X1, X2, X3, X4)` для покупок и `Qu(Y1, Y2, Y3, Y4)` для продаж. Каждое слагаемое — э
то модуль диапазона (например, `|High[1] - Low[2]|`), умноженный на соответствующий вес минус сто, полностью как в оригинальном к
оде.
- Новые входы разрешены только тогда, когда текущий час лежит в диапазоне `TradeStartHour`–`TradeEndHour` включительно (по умолч
анию 10:00–18:00).
- Используется одна рыночная заявка, объём которой сначала закрывает противоположную позицию, а затем открывает новую. Такой подх
од повторяет фильтрацию по Magic Number из версии для MetaTrader.

## Риск-менеджмент и трейлинг
- Точки MetaTrader переводятся в абсолютное значение цены через `PriceStep`. Параметры по умолчанию (`BuyStopLossPoints = 68`, `
SellStopLossPoints = 72`) совпадают с внешними переменными МТ4.
- Когда бид (для лонгов) или аск (для шортов) уходит дальше текущего стопа на `spread + 2 * stopDistance`, стоп переносится на `c
urrentPrice ± stopDistance`. При наличии Level-1 используется фактический спред, иначе — один минимальный шаг цены.
- После наступления `ExitHour` стратегия принудительно закрывает все позиции. Значение 18 в точности повторяет логику закрытия по
сле 18:00 серверного времени.
- Выходы выполняются рыночными ордерами, потому что высокоуровневый API StockSharp не создаёт защитные стоп-заявки автоматически
. Это обеспечивает одинаковое поведение у разных брокеров.

## Параметры
| Параметр | Описание |
|----------|----------|
| `AllowBuy` | Разрешить сделки на покупку. |
| `AllowSell` | Разрешить сделки на продажу. |
| `X1`, `X2`, `X3`, `X4` | Веса диапазонов в формуле `Qu` для покупок. |
| `BuyStopLossPoints` | Стоп-лосс для лонгов в пунктах MetaTrader. |
| `Y1`, `Y2`, `Y3`, `Y4` | Веса диапазонов в формуле `Qu` для продаж. |
| `SellStopLossPoints` | Стоп-лосс для шортов в пунктах MetaTrader. |
| `TradeVolume` | Базовый объём сделки (в лотах); при необходимости стратегия добавляет объём для закрытия противоположных позиций. |
| `TradeStartHour` | Час начала торгового окна. |
| `TradeEndHour` | Час окончания торгового окна. |
| `ExitHour` | Час, после которого позиции закрываются принудительно. |
| `CandleType` | Таймфрейм свечей для расчётов. |

## Примечания
- Портфель StockSharp работает по неттинговой схеме. Поэтому при появлении нового сигнала стратегия сначала закрывает обратную п
озицию, а затем открывает новую в требуемом направлении, что приблизительно соответствует одной позиции на каждое направление в о
ригинальном советнике.
- В MQL версия брала спред через `MarketInfo`. Здесь сначала используется спред из Level-1, а при его отсутствии — один шаг цены.
- Поскольку трейлинг пересчитывается только на закрытии свечи, возможны отклонения относительно тикового обновления стопа в MetaT
rader.
