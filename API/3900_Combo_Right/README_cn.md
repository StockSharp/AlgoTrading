# Combo Right 策略

该策略是 MetaTrader 智能交易系统 **Combo_Right.mq4** 的 StockSharp 复刻版。它把基于开盘价计算的商品通道指数（CCI）动量筛选与三组感知机结合起来，根据不同的 `PassMode` 分支决定是否覆盖 CCI 信号，并分别应用对应的止盈止损距离。

## 交易流程

1. 订阅所选蜡烛类型，并以开盘价驱动 CCI 指标。最近完成的蜡烛提供收盘价，同时也把历史开盘价写入环形缓冲区，供感知机读取。
2. 为每根完成蜡烛保存开盘价，使得感知机可以直接取得 `period`、`2*period`、`3*period`、`4*period` 根之前的开盘价，无需调用指标的随机访问接口。
3. 当收到一根完成的蜡烛时：
   - 读取最新 CCI 值，作为默认信号（`> 0` 开多，`< 0` 开空），同时使用 `TakeProfit1` / `StopLoss1` 作为保护距离。
   - 根据 `PassMode` 计算一到三个感知机。每个感知机都使用原始 MQL 参数 (`X** - 100`) 转换出的权重，以及最近收盘价与历史开盘价的差值。
   - 若某个感知机满足条件，则覆盖默认信号，并在下单前改用对应的止盈止损距离。
4. 取消未成交挂单，先平掉反向仓位，再按 `TradeVolume` 开出新的市场单。下单后调用 `SetTakeProfit` / `SetStopLoss`，把感知机所需的价格偏移量换算成实际价格距离，确保保护单和当前仓位保持一致。

### Pass 模式

- **Pass 1**：只参考 CCI 值，信号与指标数值同号。
- **Pass 2**：若第一组感知机（`Perceptron1Period`、`X12…X42`）输出为负，则立即按第二组风险参数开空；否则回退到 CCI 结果。
- **Pass 3**：若第二组感知机输出为正，则按第三组风险参数开多；否则回退到 CCI 结果。
- **Pass 4**：先检查第三组感知机。若其输出为正，还需第二组感知机同时为正才允许开多；若第三组为负且第一组为负，则开空。若两条分支都未触发，则使用 CCI 信号。

只有在积累了足够多的历史蜡烛后（覆盖最大 `period * 4`）策略才开始评估信号，避免像原始 MQL 脚本那样访问越界。

## 风险控制

每次进场都会根据品种的 `PriceStep` 计算价格偏移。若品种未提供步长，则直接使用参数所表示的点数。`SetTakeProfit` 与 `SetStopLoss` 接收计算好的偏移量以及下单后的净持仓量，使保护单可以在持仓变化时同步调整。

## 参数

| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `TakeProfit1`, `StopLoss1` | `decimal` | 50 / 50 | CCI 默认分支使用的止盈、止损距离（点）。 |
| `CciPeriod` | `int` | 10 | 基于开盘价计算 CCI 的周期。 |
| `X12`, `X22`, `X32`, `X42` | `int` | 100 | 第一组（看空）感知机的原始权重，代码内部会减去 100。 |
| `TakeProfit2`, `StopLoss2` | `decimal` | 50 / 50 | 看空感知机触发时使用的止盈、止损距离。 |
| `Perceptron1Period` | `int` | 20 | 看空感知机的取样步长（单位：蜡烛根数）。 |
| `X13`, `X23`, `X33`, `X43` | `int` | 100 | 第二组（看多）感知机的原始权重。 |
| `TakeProfit3`, `StopLoss3` | `decimal` | 50 / 50 | 看多感知机触发时使用的止盈、止损距离。 |
| `Perceptron2Period` | `int` | 20 | 看多感知机的取样步长。 |
| `X14`, `X24`, `X34`, `X44` | `int` | 100 | 第三组（确认用）感知机的原始权重，仅在 `PassMode = 4` 时使用。 |
| `Perceptron3Period` | `int` | 20 | 确认感知机的取样步长。 |
| `PassMode` | `int` | 1 | Supervisor 模式（1–4），完整复刻原始 EA 的分支逻辑。 |
| `TradeVolume` | `decimal` | 0.01 | 每次新开仓的下单量，会在下单前先平掉反向仓位。 |
| `CandleType` | `DataType` | M1 | 驱动 CCI 与感知机的蜡烛类型。 |

## 备注

- 策略遵循项目规范，不使用指标的随机访问接口，而是自行维护最小化的开盘价缓冲区。
- 当品种缺乏价格步长信息时，点数距离会被直接当作价格偏移处理，与 MQL 中 `Point` 的表现一致。
- 所有代码注释和文档均为英文，便于与代码库的其余部分保持一致。
