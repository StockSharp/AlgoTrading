# Стратегия Cycle Market Order

Стратегия конвертирована из эксперта MetaTrader 4 «CycleMarketOrder_V181». Алгоритм поддерживает фиксированное количество ценовых слотов и открывает рыночные сделки, когда текущая котировка попадает в диапазон конкретного слота. Каждый слот имеет собственный объём, порог безубыточности и trailing stop, благодаря чему сетка постепенно наращивает позицию и одновременно защищает уже полученную прибыль.

## Логика торговли

1. Размер пункта вычисляется из минимального шага цены и количества знаков после запятой инструмента (для котировок с 5/3 знаками автоматически используется коэффициент 10). Далее параметры `MaxPrice`, `SpanPips` и `MaxCount` задают диапазоны, которыми управляет каждый слот.
2. Стратегия подписывается на поток Level-1, чтобы воспроизвести тиковое поведение оригинального эксперта, и при каждом обновлении сохраняет актуальные значения лучшего бид/аск.
3. При включённом `UseWeekendMode` торговля полностью приостанавливается в выходные: с часа `WeekendHour` в субботу, в течение всего воскресенья и до `WeekstartHour` в понедельник.
4. Для длинного цикла (`EntryDirection = 1`) слоты просматриваются в порядке возрастания. Если текущая цена Ask находится между `startPrice` и `endPrice` слота, отправляется рыночная покупка объёмом `OrderVolume`. При `EntryDirection = -1` используется зеркальная логика с ценой Bid.
5. Состояние каждого слота хранит информацию о незавершённых заявках, объёме позиции и средней цене входа. В журналах используется идентификатор `MagicNumberBase + index`, чтобы соответствовать MT4 magic number.
6. Управление trailing stop выполняется на каждом событии Level-1 до попытки открыть новые сделки. Как только прибыль по длинному слоту превышает `BreakEvenPips + TrailingStopPips`, стоп переносится на `Bid - TrailingStopPips`. Для коротких слотов применяется `Ask + TrailingStopPips` и зеркальное условие безубыточности. Пересечение цены с сохранённым уровнем закрывает слот рыночной сделкой.
7. Поскольку используются только рыночные ордера, отдельные отложенные заявки отсутствуют. Частичное исполнение корректно уменьшает объём слота, поэтому trailing продолжает работу, а после полного закрытия слот готов к следующему входу.

## Параметры

| Параметр | Описание |
|----------|----------|
| `EntryDirection` | Направление торговли: `1` — покупки, `-1` — продажи, `0` — только сопровождение текущих позиций. |
| `MaxPrice` | Верхняя опорная цена для расчёта диапазонов. |
| `MaxCount` | Количество активных слотов в сетке. |
| `SpanPips` | Расстояние между соседними слотами в пунктах. |
| `OrderVolume` | Объём заявки при срабатывании слота. |
| `BreakEvenPips` | Прибыль в пунктах, необходимая для активации trailing stop. |
| `TrailingStopPips` | Размер смещения trailing stop после достижения безубыточности. |
| `UseWeekendMode` | Включение фильтра выходных. |
| `WeekendHour` | Час (по времени терминала) начала блокировки торговли в субботу. |
| `WeekstartHour` | Час возобновления торговли в понедельник. |
| `MagicNumberBase` | Базовый идентификатор для логирования, совместимый с magic number оригинального эксперта. |

## Особенности реализации

* Для каждого слота хранятся отложенные объёмы на вход и выход, что предотвращает повторную регистрацию объёма при частичном исполнении.
* При добавлении новой сделки trailing stop сбрасывается и пересчитывается от актуальной средней цены входа.
* Фильтр выходного дня просто пропускает обработку trailing и открытие новых позиций; открытые сделки остаются нетронутыми до окончания окна.
* Использование Level-1 необходимо, поскольку стратегия анализирует чистые цены Bid/Ask, а не значения свечей, что максимально приближает поведение к версии MT4.
