# Стратегия TrailingStopFrCn

## Общее описание

`TrailingStopFrCnStrategy` — адаптация советника MetaTrader **TrailingStopFrCn.mq4** для платформы StockSharp. Изначальный советник сопровождает уже открытые позиции, обновляя уровень стоп-лосса с помощью фиксированного трейлинга, фракталов Билла Уильямса или экстремумов последних свечей. Перенос сохраняет эту гибкость, использует высокоуровневый API StockSharp, подписывается на свечи и поток Level 1, отслеживает текущую нетто-позицию и автоматически обновляет защитный стоп.

Стратегия не открывает сделки самостоятельно. Она анализирует `Strategy.Security`, отменяет устаревшие стоп-заявки при смене направления позиции и размещает одну агрегированную стоп-заявку, повторяющую логику оригинального советника.

## Логика трейлинга

1. **Фиксированное расстояние** — если `TrailingStopPips` больше нуля, стратегия работает так же, как параметр `TrailingStop` в MQL. Для лонгов стоп размещается по формуле `bestBid - distance`, для шортов — `bestAsk + distance`, где `distance = TrailingStopPips × размер пункта`.
2. **Фрактальный трейлинг** — при `TrailingStopPips = 0` и `TrailingMode = Fractals` стратегия определяет фракталы Билла Уильямса на окне из пяти свечей. После закрытия каждой свечи данные попадают в буфер, и свеча двух периодов давности рассматривается как потенциальный фрактал. Последний фрактал, удалённый от текущей цены минимум на `MinStopDistancePips`, становится кандидатом для стоп-лосса.
3. **Экстремумы свечей** — при `TrailingStopPips = 0` и `TrailingMode = Candles` стратегия анализирует до 99 последних закрытых свечей и выбирает первый минимум (для лонгов) или максимум (для шортов), который находится не ближе чем на `MinStopDistancePips` к текущей цене.

После расчёта кандидата выполняются те же защитные правила, что и в MQL-версии:

- **OnlyProfit** — перемещать стоп только когда новый уровень фиксирует прибыль (стоп выше цены входа для лонгов и ниже для шортов).
- **OnlyWithoutLoss** — прекращать дальнейший трейлинг, когда действующий стоп уже обеспечивает безубыточность.
- Стоп передвигается только в выгодную сторону: вверх для длинной позиции и вниз для короткой.

StockSharp оперирует нетто-позицией, поэтому заявка на стоп выставляется на объём `Math.Abs(Position)` и охватывает всю позицию целиком.

## Параметры

| Параметр | Описание |
|----------|----------|
| `OnlyProfit` | Перемещать стоп только при фиксации прибыли относительно средней цены входа. Полный аналог одноимённого флага в MQL. |
| `OnlyWithoutLoss` | Останавливать трейлинг, когда стоп уже находится на уровне безубыточности или лучше. |
| `TrailingStopPips` | Фиксированное расстояние трейлинга в пунктах. Установите 0, чтобы использовать фракталы или экстремумы свечей. |
| `MinStopDistancePips` | Минимальное расстояние между текущей ценой и стоп-лоссом (в пунктах). Позволяет имитировать ограничение брокера `MODE_STOPLEVEL`. |
| `TrailingMode` | Источник уровней при `TrailingStopPips = 0`: `Fractals` (фракталы) или `Candles` (экстремумы свечей). |
| `CandleType` | Тип свечей, используемый для расчёта фракталов/экстремумов. По умолчанию — часовой таймфрейм. |

## Особенности работы

- Для получения лучшего бид/аск стратегия подписывается на Level 1. Фиксированный трейлинг реагирует на каждый тик, а фрактальный и свечной режимы обновляют кандидата после закрытия свечи.
- При смене направления позиции текущая стоп-заявка сначала отменяется и только затем выставляется новая.
- Если подходящий кандидат отсутствует (например, недостаточно истории), действующий стоп остаётся без изменений.
- Если брокер не ограничивает минимальное расстояние, `MinStopDistancePips` можно оставить равным нулю.

## Отличия от MetaTrader-версии

- StockSharp хранит единую нетто-позицию, поэтому индивидуальные тики MetaTrader не отслеживаются — выставляется одна общая стоп-заявка.
- Параметр `Magic` не нужен: стратегия автоматически работает только со своим инструментом.
- Вместо цикла с задержкой в одну секунду используется событийная модель — закрытие свечей и поток Level 1.
- Графические объекты MetaTrader не переносятся. При необходимости можно воспользоваться инструментами визуализации StockSharp.

## Рекомендации по использованию

1. Запускайте стратегию вместе с любым модулем, который открывает позиции по тому же инструменту. Как только появляется нетто-позиция, TrailingStopFrCn автоматически прикрепит стоп.
2. Подбирайте `CandleType` под нужный горизонт анализа: большие таймфреймы дают более плавные уровни, меньшие — более быстрые реакции.
3. Настраивайте `MinStopDistancePips` в соответствии с требованиями брокера, иначе возможны отказы при регистрации заявок.
4. В тестах убедитесь, что в источнике данных доступны свечи и поток Level 1, иначе логика трейлинга может не активироваться.
