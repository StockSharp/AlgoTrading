# Open Close

## Обзор
Open Close — порт советника MetaTrader 5 `Open Close.mq5` (тикет 23090). Стратегия анализирует соотношение цен открытия и закрытия двух последних завершённых свечей. Одновременно удерживается только одна позиция: когда более свежая свеча разворачивается относительно предыдущей, стратегия открывает сделку, а когда обе свечи указывают в одну сторону — закрывает. Реализация на C# также сохраняет адаптивный расчёт объёма, уменьшающий экспозицию после серии убыточных сделок.

## Логика стратегии
### Свечной фильтр
* Работа ведётся только по полностью сформированным свечам, поступающим из источника `CandleType`.
* Поддерживается скользящее окно из двух последних завершённых свечей («текущая» и «предыдущая»).
* Сравниваются цены открытия и закрытия этих свечей:
  * **Бычий разворот** — `previous.Open > older.Open` **и** `previous.Close < older.Close`.
  * **Медвежий разворот** — `previous.Open < older.Open` **и** `previous.Close > older.Close`.

### Правила входа
* При отсутствии позиции и появлении бычьего разворота выставляется рыночная заявка на покупку.
* При отсутствии позиции и обнаружении медвежьего разворота подаётся рыночная заявка на продажу.
* Одновременно допускается только одна сделка. Противоположные сигналы игнорируются, пока позиция не будет закрыта.

### Правила выхода
* Для длинной позиции выход выполняется, если обе свечи смещаются вниз (`previous.Open < older.Open` и `previous.Close < older.Close`).
* Для короткой позиции условие симметрично (`previous.Open > older.Open` и `previous.Close > older.Close`).
* В оригинальном советнике отсутствуют стоп-лосс и тейк-профит, поэтому закрытие целиком зависит от конфигурации последних свечей.

### Расчёт объёма и серия убытков
* Основной размер заявки определяется параметром `MaximumRiskPercent` — долей капитала, выделяемой на сделку. Базовая формула: `Portfolio.CurrentValue × MaximumRiskPercent ÷ referencePrice`, где в качестве цены используется последнее закрытие.
* Если оценка портфеля или цена недоступны, используется резервный объём `FallbackVolume`.
* После каждой полностью закрытой сделки фиксируется реализованный результат, а число подряд идущих убыточных сделок считается за последние `HistoryDays` дней.
  * Если подряд получилось более одного убытка, следующий объём уменьшается на `volume × losses ÷ DecreaseFactor`, что повторяет логику MT5.
* Итоговый объём приводится к шагу объёма инструмента и ограничивается минимальными/максимальными значениями.

### Дополнительные замечания по реализации
* Обработка выполняется только для свечей с состоянием `CandleStates.Finished`, что гарантирует использование полных данных.
* Проверки входа и выхода происходят на закрытии свежей свечи. В MetaTrader заявка отправлялась на открытии следующего бара; разница невелика на старших таймфреймах, но важна для очень коротких интервалов.
* Портфельные метрики StockSharp приближенно заменяют `AccountFreeMargin` из MetaTrader. При отличающихся контрактных размерах подберите значения `MaximumRiskPercent` или `FallbackVolume` вручную.

## Параметры
| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `MaximumRiskPercent` | `decimal` | `0.02` | Доля капитала, вкладываемая в новую позицию (0.02 = 2%). |
| `DecreaseFactor` | `decimal` | `3` | Делитель, уменьшающий объём после серии убытков. Чем больше значение, тем мягче снижение. |
| `HistoryDays` | `int` | `60` | Количество календарных дней для учёта серии убыточных сделок. |
| `FallbackVolume` | `decimal` | `0.1` | Резервный объём, используемый при невозможности расчёта по риску. |
| `CandleType` | `DataType` | `TimeFrame(15m)` | Источник свечей, по которым формируются сигналы. |

## Отличия от версии MetaTrader
* Проверка маржи опирается на `Portfolio.CurrentValue`; в оригинале использовался `AccountFreeMargin`. Совпадение поведения возможно только при схожей оценке капитала на обеих платформах.
* История сделок формируется на основе исполнений самой стратегии, а не по глобальной истории терминала. Оставьте стратегию работать достаточно долго, чтобы накопить статистику серий.
* Порт сохраняет модель одной позиции и отсутствие защитных ордеров, как и в оригинале. При необходимости добавьте стопы во внешних модулях управления риском.
