# Стратегия N Candles v6

## Обзор
**N Candles v6** отслеживает последние завершённые свечи и ищет серии одинаковых по направлению баров. Когда рынок формирует `N` бычьих свечей подряд, стратегия открывает длинную позицию, а серия из `N` медвежьих свечей приводит к открытию короткой позиции. Логика повторяет эксперта MetaTrader *N Candles v6.mq5*, адаптированного под высокоуровневый API StockSharp.

Алгоритм подходит для любого инструмента с классическими временными свечами. Гибко настраиваемый торговый интервал запрещает новые сделки вне выбранной сессии, однако защита позиции (стопы и трейлинг) продолжает работать даже при закрытом окне торговли.

## Торговая логика
1. Подписка на указанный тип свечей и обработка только завершённых баров.
2. Подсчёт подряд идущих бычьих (`Close > Open`) и медвежьих (`Close < Open`) свечей. Доджи обнуляют счётчики.
3. При появлении `CandlesCount` бычьих свечей:
   - Проверка, что прогнозируемая позиция не превысит `MaxPositionVolume`.
   - Отправка рыночной заявки Buy. Если была короткая позиция, объём увеличивается для мгновенного разворота в лонг.
4. При появлении `CandlesCount` медвежьих свечей:
   - Убедиться, что новая короткая позиция не нарушит ограничение `MaxPositionVolume`.
   - Отправить рыночную заявку Sell, увеличив объём при необходимости закрыть лонг.
5. Если новая свеча ломает серию («чёрная овца»):
   - Применить выбранный `ClosingMode`, чтобы единовременно закрыть все позиции, только встречные или только попутные.
6. На каждом баре выполняется защитная логика:
   - Стоп-лосс и тейк-профит вычисляются из расстояния в пунктах и шага цены инструмента.
   - Трейлинг активируется после движения на `TrailingStopPips + TrailingStepPips` и подтягивается только в прибыльную сторону.
   - Пробой стопа, тейка или трейлинга моментально закрывает всю позицию.

## Управление рисками
- **Stop Loss (пункты)** – переводит расстояние в пунктах в абсолютное смещение цены, учитывая шаг цены (для 5- и 3-значных котировок применяется масштабирование ×10).
- **Take Profit (пункты)** – фиксирует прибыль после прохода заданного расстояния; `0` отключает цель.
- **Trailing Stop / Step (пункты)** – включает динамическую защиту после достижения заданной прибыли. Шаг должен быть > 0 при активном трейлинге.
- **Max Position Volume** – ограничивает модуль совокупной позиции; сигналы, которые его превышают, игнорируются.
- **Closing Mode** – реакция на «чёрную овцу»:
  - `All` – закрыть всю позицию.
  - `Opposite` – закрыть позиции против направления серии (например, шорты после бычьей последовательности).
  - `Unidirectional` – закрыть позиции по направлению серии.
- **Торговое окно** – новые сделки открываются только если час открытия свечи попадает в диапазон `StartHour`–`EndHour` (включительно). Стоп-логика активна всегда.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `CandlesCount` | 3 | Количество одинаковых свечей для сигнала. |
| `OrderVolume` | 0.01 | Базовый объём рыночной заявки; при развороте закрывает противоположную позицию. |
| `TakeProfitPips` | 50 | Расстояние до тейк-профита в пунктах (`0` отключает). |
| `StopLossPips` | 50 | Расстояние до стоп-лосса в пунктах (`0` отключает). |
| `TrailingStopPips` | 10 | Расстояние трейлинг-стопа в пунктах (`0` отключает). |
| `TrailingStepPips` | 4 | Минимальное улучшение цены для подтягивания трейлинга; > 0 при включённом трейлинге. |
| `MaxPositionVolume` | 2 | Максимальный модуль нетто-позиции. |
| `UseTradingHours` | true | Включает фильтр торгового окна. |
| `StartHour` | 11 | Начало торговой сессии (0–23). |
| `EndHour` | 18 | Конец торговой сессии (0–23). |
| `ClosingMode` | All | Поведение при появлении «чёрной овцы». |
| `CandleType` | Часовые свечи | Тип данных для генерации сигналов. |

## Дополнительно
- Пересчёт пунктов основан на `PriceStep` инструмента; для 5- и 3-значных котировок шаг умножается на десять.
- `StartProtection()` запускается при старте стратегии и включает штатную защиту StockSharp (контроль переподключений и т.п.).
- Стратегия работает с неттинговым учётом (`Strategy.Position`). Для имитации хеджинга увеличьте `MaxPositionVolume`.
