# Exp Iin MA Signal MMRec Стратегия
[English](README.md) | [中文](README_cn.md)

Порт StockSharp эксперта MetaTrader «Exp_Iin_MA_Signal_MMRec». Стратегия отслеживает сигналы пересечения пары настраиваемых скользящих средних (оригинального индикатора Iin_MA_Signal) и применяет адаптивное управление объёмом с понижением после серии убытков.

## Обзор

- **Генерация сигналов**: быстрые и медленные скользящие средние рассчитываются по выбранному типу свечей и используемой цене. Сигнал на покупку появляется, когда быстрая средняя пересекает медленную снизу вверх, а сигнал на продажу — при обратном пересечении. Параметр `SignalBar` откладывает исполнение на указанное количество полностью закрытых баров, что повторяет сдвиг буфера индикатора в версии MQL.
- **Управление позицией**: флаги `BuyPosOpen` и `SellPosOpen` включают или отключают входы в лонг и шорт. Когда возникает противоположный сигнал и активен соответствующий `BuyPosClose` или `SellPosClose`, стратегия либо закрывает текущую позицию, либо сразу переворачивается в новое направление.
- **Контроль риска**: значения `StopLossPoints` и `TakeProfitPoints` переводятся в ценовые расстояния через `Security.PriceStep` и проверяются по экстремумам свечи до обработки новых сигналов.
- **Мани-менеджмент**: история последних сделок ведётся раздельно для лонгов и шортов. Если в пределах окна `BuyTotalTrigger`/`SellTotalTrigger` количество убыточных сделок достигает порога, стратегия переключается с `NormalVolume` на `ReducedVolume`. Параметр `MoneyMode` определяет трактовку объёма (фиксированные лоты, процент от капитала или риск, рассчитанный по стопу).

## Параметры

- `FastPeriod`, `SlowPeriod` – периоды быстрых и медленных скользящих средних.
- `FastType`, `SlowType` – типы скользящих (`Simple`, `Exponential`, `Smoothed`, `Weighted`, `VolumeWeighted`).
- `FastPrice`, `SlowPrice` – используемая цена (`Close`, `Open`, `High`, `Low`, `Median`, `Typical`, `Weighted`).
- `SignalBar` – количество закрытых баров между появлением сигнала и отправкой заявки.
- `BuyPosOpen`, `SellPosOpen` – разрешение открытия длинных и коротких позиций.
- `BuyPosClose`, `SellPosClose` – закрытие или переворот текущей позиции при противоположном сигнале.
- `BuyTotalTrigger`, `SellTotalTrigger` – глубина истории, в которой подсчитываются последние сделки.
- `BuyLossTrigger`, `SellLossTrigger` – минимальное число убытков в окне, активирующее пониженный объём.
- `NormalVolume`, `ReducedVolume` – основной и резервный объём (или риск-фактор, зависящий от `MoneyMode`).
- `StopLossPoints`, `TakeProfitPoints` – величина стоп-лосса и тейк-профита в пунктах инструмента.
- `MoneyMode` – интерпретация объёма (`Lot`, `Balance`, `FreeMargin`, `BalanceRisk`, `FreeMarginRisk`). Режимы на основе капитала используют `Portfolio.CurrentValue`, а риск-режимы делят сумму риска на дистанцию стопа.
- `CandleType` – тип свечей, которые используются для расчётов индикатора.

## Логика сигналов

1. Каждая закрытая свеча передаёт выбранную цену в обе скользящие средние.
2. Разница между текущими и предыдущими значениями средних определяет факт пересечения.
3. Сигналы ставятся в очередь и исполняются, когда её размер превышает `SignalBar`.
4. При исполнении сигнала на покупку:
   - Если открыта короткая позиция и `SellPosClose` включён, стратегия фиксирует PnL по этому шорту. Далее при активном `BuyPosOpen` происходит переворот в лонг, иначе позиция просто закрывается.
   - Если позиция отсутствует и `BuyPosOpen` включён, открывается новый лонг с рассчитанным объёмом.
5. Сигналы на продажу работают зеркально.

## Особенности мани-менеджмента

- История сделок хранится в виде очереди FIFO, ограниченной значениями `BuyTotalTrigger` / `SellTotalTrigger`.
- Убыточная сделка (отрицательный PnL) увеличивает счётчик убытков. Достижение порога `BuyLossTrigger` или `SellLossTrigger` приводит к использованию `ReducedVolume` для следующей позиции.
- `MoneyMode = Lot` трактует объёмы как количество лотов.
- `MoneyMode = Balance` и `FreeMargin` умножают заданное значение на `Portfolio.CurrentValue` и делят на текущую цену закрытия.
- `MoneyMode = BalanceRisk` и `FreeMarginRisk` умножают значение на `Portfolio.CurrentValue` и делят на дистанцию стоп-лосса. При нулевом стопе используется расчёт как в процентном режиме.
- Если данные портфеля недоступны, объём обнуляется, чтобы избежать случайных заявок.

## Управление риском

- Уровни стоп-лосса и тейк-профита пересчитываются на каждой свече по цене входа и шагу цены. Если уровень достигнут внутри диапазона свечи, позиция закрывается до обработки новых сигналов.
- Любое закрытие фиксирует результат сделки, чтобы очереди мани-менеджмента отражали фактическую историю.

## Примечания

- Настройте `StopLossPoints` и `TakeProfitPoints` в соответствии с шагом цены инструмента: стратегия умножает их на `Security.PriceStep`.
- Для режимов, использующих капитал, объект `Portfolio` должен предоставлять `CurrentValue`.
- Стратегия работает в неттинговом режиме: одновременные длинные и короткие позиции не поддерживаются.
