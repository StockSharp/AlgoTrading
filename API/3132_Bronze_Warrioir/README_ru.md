# Стратегия Bronze Warrioir

## Общее описание
- Конверсия советника MetaTrader 5 *Bronze Warrioir.mq5* в стратегию на высокоуровневом API StockSharp.
- Работает с одной бумагой по завершённым свечам, совмещая сигналы CCI, Williams %R и авторского осциллятора DayImpuls.
- Цель — отлавливать импульсы, когда тренд DayImpuls, перекупленность/перепроданность Williams %R и экстремумы CCI совпадают, при этом сохраняются механизмы контроля прибыли/убытка из оригинала.

## Набор индикаторов
- **CCI** — период задаётся параметром `IndicatorPeriod`. Для шортов требуется значение выше `CciLevel`, для лонгов — ниже `-CciLevel`.
- **Williams %R** — рассчитывается на том же периоде. Значение выше `WilliamsLevelUp` трактуется как перекупленность, ниже `WilliamsLevelDown` — перепроданность.
- **DayImpuls** — полная копия кастомного индикатора из пакета. Тело свечи переводится в пункты (разница close-open делится на стоимость шага цены) и сглаживается двумя экспоненциальными средними одинаковой длины. Рост означает усиление бычьего импульса, падение — медвежьего.

## Логика входов
1. **Контроль Equity** — сначала вычисляется плавающий PnL текущей позиции. Если он превысил `ProfitTarget` или упал ниже `LossTarget`, стратегия немедленно закрывает все позиции.
2. **Фильтр данных** — используются только свечи со статусом `Finished`. Дополнительно хранится предыдущее значение DayImpuls, чтобы воспроизвести проверку `custom[1]`.
3. **Вход в шорт** возможен при отсутствии короткой позиции, когда DayImpuls выше `DayImpulsLevel` и растёт, Williams %R выше `WilliamsLevelUp`, а CCI превышает `CciLevel`. В StockSharp объём приказа равен `TradeVolume` плюс текущий лонг, что обеспечивает разворот одной сделкой.
4. **Вход в лонг** зеркальный: DayImpuls ниже порога и снижается, Williams %R ниже `WilliamsLevelDown`, CCI меньше `-CciLevel`. Объём равен `TradeVolume` плюс открытый шорт.
5. **Повторные входы** — если плавающий PnL вышел за пределы `[-PredTarget/2, PredTarget]`, оригинал проверял параметр `LotCoefficient` перед открытием встречной позиции. В портированной версии проверка сохранена, но исполнение реализовано как рыночный разворот (сначала закрытие текущего плеча, затем открытие противоположного) из-за неттинговой модели StockSharp.

## Управление рисками
- `StopLossPips` и `TakeProfitPips` преобразуются в ценовые расстояния на основе `PriceStep`. Для инструментов с 3 или 5 знаками после запятой добавляется множитель 10, что соответствует понятию "пункт" в MT5.
- Параметры передаются в `StartProtection`, которая автоматически сопровождает позицию стоп-лоссом и тейк-профитом.
- В `OnOwnTradeReceived` ведётся учёт объёмов и средних цен по лонгам/шортам, что позволяет точно пересчитать плавающую прибыль аналогично сумме `Commission + Swap + Profit` в MT5.

## Параметры
| Параметр | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `TradeVolume` | Базовый объём (лоты) для каждой сделки. | `1` |
| `StopLossPips` | Дистанция стоп-лосса в пунктах. | `50` |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | `50` |
| `IndicatorPeriod` | Общий период индикаторов. | `14` |
| `CciLevel` | Порог CCI для открытия позиций. | `150` |
| `WilliamsLevelUp` | Порог Williams %R для шорта. | `-15` |
| `WilliamsLevelDown` | Порог Williams %R для лонга. | `-85` |
| `DayImpulsLevel` | Уровень DayImpuls, разделяющий бычий/медвежий режим. | `50` |
| `ProfitTarget` | Целевой плавающий профит (валюта счёта). | `100` |
| `LossTarget` | Предельный плавающий убыток (валюта счёта). | `-100` |
| `PredTarget` | Коридор прибыли/убытка для повторного входа. | `40` |
| `LotCoefficient` | Коэффициент проверки возможности усреднения. | `2` |
| `CandleType` | Используемый таймфрейм свечей. | `15m` |

## Особенности реализации
- Индикатор DayImpuls реализован как вложенный класс и полностью повторяет двойное EMA-сглаживание оригинала.
- Из-за неттинга одновременно держать лонг и шорт невозможно, поэтому для имитации хеджевых входов используется рыночный разворот с суммарным объёмом.
- Работа со свечами происходит только после проверки `IsFormedAndOnlineAndAllowTrading()`, что обеспечивает корректную интеграцию с жизненным циклом стратегии.
- Учёт средних цен и объёмов обновляется при каждом собственном трейде, что делает расчёт плавающего PnL устойчивым к частичным закрытиям и разворотам.
