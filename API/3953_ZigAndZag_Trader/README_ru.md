# Стратегия ZigAndZag Trader

## Обзор
**ZigAndZag Trader** — порт MetaTrader-советника *ZigAndZag_trader.mq4* на StockSharp. Стратегия комбинирует два ZigZag-подобных детектора свингов:

1. **Долгосрочный ZigZag** (`TrendDepth`) фиксирует глобальные экстремумы и определяет направление тренда.
2. **Краткосрочный ZigZag** (`ExitDepth`) отслеживает последний свинг внутри тренда и запоминает «взвешенную» цену `(5×Close + 2×Open + High + Low) / 9`.

Сделки открываются, когда цена уходит от последнего свинга в сторону текущего тренда, и закрываются при возврате этой взвешенной цены через тот же уровень против тренда. Так полностью воспроизводится исходный алгоритм, который считывал 4–6 буферы пользовательского индикатора `ZigAndZag` в MQL4.

## Логика торговли
- **Определение тренда** — новый минимум долгосрочного ZigZag переводит стратегию в режим uptrend, новый максимум — в downtrend.
- **Фиксация свингов** — каждый новый свинг короткого ZigZag сбрасывает состояние и обновляет опорную взвешенную цену.
- **Входы**
  - Тренд вверх + последний свинг — минимум: покупка при превышении взвешенной ценой опорного уровня минимум на один пункт.
  - Тренд вниз + последний свинг — максимум: продажа при падении взвешенной цены ниже опорного уровня минимум на один пункт.
- **Выход** — если взвешенная цена пробивает опорный уровень против текущего тренда, все позиции закрываются.
- **Ограничение объёма** — суммарная позиция не может превышать `MaxOrders × Volume`; лишние сигналы игнорируются.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CandleType` | `1 Minute` | Тип свечей для расчёта обоих ZigZag. |
| `Lots` | `0.1` | Запрашиваемый размер позиции в лотах (приводится к шагу объёма инструмента). |
| `TrendDepth` | `3` | Глубина (в свечах) долгосрочного ZigZag для определения тренда. |
| `ExitDepth` | `3` | Глубина краткосрочного ZigZag, генерирующего входы и выходы. |
| `MaxOrders` | `1` | Максимальное количество одновременно открытых ордеров/единиц позиции. |
| `StopLossPips` | `0` | Размер стоп-лосса в пунктах (`0` — без стопа). |
| `TakeProfitPips` | `0` | Размер тейк-профита в пунктах (`0` — без цели). |

## Управление рисками
`StartProtection` активируется автоматически. Если заданы ненулевые `StopLossPips` или `TakeProfitPips`, то к каждой рыночной сделке привязываются защитные ордера на соответствующей дистанции (с учётом шага цены инструмента).

## Визуализация
На графике отображаются свечи и собственные сделки. Отдельные индикаторы не рисуются — логика использует внутренние ZigZag-трекеры.

## Дополнительно
- Формула взвешенной цены полностью совпадает с оригинальным индикатором и не требует прямого доступа к его буферам.
- Порог срабатывания равен одному пункту, что имитирует проверку на превышение спрэда в исходном коде.
- Все комментарии и сообщения в коде переведены на английский язык согласно требованиям репозитория.
