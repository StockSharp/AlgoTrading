# ZigAndZag Trader 策略

## 概述
**ZigAndZag Trader** 是 MetaTrader 专家 *ZigAndZag_trader.mq4* 在 StockSharp 平台上的移植版本。策略同时运行两个 ZigZag 风格的摆动检测器：

1. **长期 ZigZag**（参数 `TrendDepth`）标记主要高低点，用来识别趋势方向。
2. **短期 ZigZag**（参数 `ExitDepth`）跟踪当前趋势内部最近的摆动，并记录加权价格 `(5×收盘 + 2×开盘 + 最高 + 最低) / 9`。

当价格按照趋势方向突破最近摆动点时开仓；当加权价格逆趋势穿越该摆动点时立即平仓。此流程完全复刻了原始专家读取自定义指标 `ZigAndZag` 第 4–6 号缓冲区的行为。

## 交易逻辑
- **趋势识别**：长期 ZigZag 出现新的摆动低点 → 趋势设为向上；出现新的摆动高点 → 趋势设为向下。
- **摆动管理**：短期 ZigZag 确认新摆动时重置内部状态并更新参考加权价格。
- **入场条件**
  - 上升趋势 + 最近摆动为低点：当加权价格向上突破该低点至少 1 个点时买入。
  - 下降趋势 + 最近摆动为高点：当加权价格向下突破该高点至少 1 个点时卖出。
- **离场条件**：若加权价格逆趋势穿越参考摆动点，立即关闭全部仓位。
- **仓位限制**：净头寸绝对值上限为 `MaxOrders × Volume`，超出后新的信号会被忽略。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CandleType` | `1 Minute` | 用于两种 ZigZag 计算的 K 线类型。 |
| `Lots` | `0.1` | 目标下单手数，最终会对齐到交易品种的最小成交单位。 |
| `TrendDepth` | `3` | 长期 ZigZag 的回看长度（以 K 线数计）。 |
| `ExitDepth` | `3` | 短期 ZigZag 的回看长度，决定入场与平仓信号。 |
| `MaxOrders` | `1` | 允许同时持有的最大仓位数量。 |
| `StopLossPips` | `0` | 止损距离（点），`0` 表示不开启。 |
| `TakeProfitPips` | `0` | 止盈距离（点），`0` 表示不开启。 |

## 风险控制
策略会自动调用 `StartProtection`。当 `StopLossPips` 或 `TakeProfitPips` 设置为正值时，每笔市价单都会附带固定距离的保护性止损/止盈，并按照品种的最小价格步长换算为价格差。

## 可视化
策略在默认图表区域绘制 K 线以及自身的成交记录。由于 ZigZag 逻辑完全在内部实现，因此不额外绘制指标曲线。

## 补充说明
- 加权价格计算与原始 MQL 指标保持一致，无需直接访问指标缓冲区。
- 突破阈值设定为 1 个点，对应原程序中“超过点差才触发”的过滤条件。
- 代码中的注释与消息均保持英文，符合仓库规范。
