# Стратегия Bago EA Classic

Порт на StockSharp повторяет советник MetaTrader из файла `MQL/7656/Bago_ea.mq4`. Вся логика трендовой торговли сохранена: входы появляются только при синхронных пробоях EMA и RSI в сторону тренда, а туннель Vegas (EMA 144/169) фильтрует ложные сигналы и служит основой для поэтапного трейлинг-стопа.

## Подробная логика

1. **Набор индикаторов**
   - Быстрая и медленная EMA (`FastPeriod`/`SlowPeriod`) с настраиваемым методом `MaMethod` и ценой `MaAppliedPrice`.
   - Пара EMA с периодами 144 и 169 формирует туннель Vegas и использует те же настройки, что и рабочие средние.
   - RSI (`RsiPeriod`, `RsiAppliedPrice`) отслеживает пересечения уровня 50.
   - Все индикаторы получают данные из свечного подписки `CandleType` через высокоуровневый метод `Bind`.
2. **Машина состояний пересечений**
   - Пересечения EMA и RSI фиксируются флагами «вверх/вниз» и счётчиками баров. Состояние активно `CrossEffectiveBars` закрытых свечей либо до появления противоположного пересечения, как в MQL-версии.
   - Дополнительные флаги туннеля фиксируют, когда цена переходит на другую сторону Vegas, что определяет режим сопровождения позиции.
3. **Торговые сессии**
   - Сделки разрешены только в выбранные периоды: Лондон (07–16), Нью-Йорк (12–21), Токио (00–08 плюс свеча 23:00). Переключатели соответствуют `extern bool` из оригинального кода.
4. **Фильтры входов**
   - **Покупка**: нужны активные флаги EMA-up и RSI-up и либо закрытие выше туннеля минимум на `TunnelBandWidthPips`, но не дальше `TunnelSafeZonePips`, либо откат под туннель на `TunnelBandWidthPips` с последующим отбоем.
   - **Продажа**: зеркальная проверка для пересечений вниз и симметричных уровней туннеля.
   - При наличии противоположной позиции она закрывается рыночной заявкой перед открытием новой — полный аналог `OrderClose` из MetaTrader.
5. **Ведение позиции**
   - Базовый стоп выставляется на `StopLossPips` от цены входа. При парковке около туннеля стоп переносится с учётом `StopLossToFiboPips`, что повторяет «фибо»-буфер советника.
   - Этапы трейлинга соответствуют уровням тейк-профита EA: стоп смещается к туннелю ±(`TrailingStepX` + `StopLossToFiboPips`) и постепенно переходит к жёсткому трейлингу `TrailingStopPips`.
   - Частичные фиксации (`PartialClose1Volume`, `PartialClose2Volume`) выполняются при достижении `TrailingStep1Pips` и `TrailingStep2Pips`. Остаток объёма сопровождается до третьего уровня `TrailingStep3Pips`.
   - Любое противоположное пересечение EMA/RSI немедленно закрывает всю позицию.
6. **Работа с ордерами**
   - Защитные приказы создаются через `SellStop`/`BuyStop`. При каждом переносе стопа предыдущий ордер отменяется и ставится новый — аналог циклических `OrderModify`.
   - Пересчёт пунктов использует `PriceStep` инструмента и автоматически учитывает 3- и 5-значные котировки (умножение шага на десять), как в MetaTrader.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|------------------------|----------|
| `TradeVolume` | decimal | 3 | Совокупный объём новой позиции. |
| `StopLossPips` | decimal | 30 | Дистанция первоначального стоп-лосса в пунктах. |
| `StopLossToFiboPips` | decimal | 20 | Дополнительный буфер при переносе стопа возле туннеля. |
| `TrailingStopPips` | decimal | 30 | Шаг жёсткого трейлинга, когда цена вышла далеко от туннеля. |
| `TrailingStep1Pips` | decimal | 55 | Первый уровень прибыли (TP1). |
| `TrailingStep2Pips` | decimal | 89 | Второй уровень прибыли (TP2). |
| `TrailingStep3Pips` | decimal | 144 | Третий уровень прибыли (TP3) перед переходом к чистому трейлингу. |
| `PartialClose1Volume` | decimal | 1 | Объём частичного закрытия на первом уровне. |
| `PartialClose2Volume` | decimal | 1 | Объём частичного закрытия на втором уровне. |
| `CrossEffectiveBars` | int | 2 | Количество свечей, в течение которых флаги пересечений остаются актуальными. |
| `TunnelBandWidthPips` | decimal | 5 | Нейтральная зона вокруг туннеля, где новые сделки не открываются. |
| `TunnelSafeZonePips` | decimal | 120 | Максимальное удаление цены от туннеля для входа по пробою. |
| `EnableLondonSession` | bool | true | Разрешить торговлю с 07:00 до 16:00. |
| `EnableNewYorkSession` | bool | true | Разрешить торговлю с 12:00 до 21:00. |
| `EnableTokyoSession` | bool | false | Разрешить торговлю с 00:00 до 08:00 и на свече 23:00. |
| `FastPeriod` | int | 5 | Период быстрой EMA. |
| `SlowPeriod` | int | 12 | Период медленной EMA. |
| `MaShift` | int | 0 | Горизонтальный сдвиг средних. |
| `MaMethod` | `MovingAverageType` | Exponential | Метод расчёта средних. |
| `MaAppliedPrice` | `AppliedPriceType` | Close | Цена, подаваемая в EMA. |
| `RsiPeriod` | int | 21 | Период сглаживания RSI. |
| `RsiAppliedPrice` | `AppliedPriceType` | Close | Цена, подаваемая в RSI. |
| `CandleType` | `DataType` | H1 | Свечной источник данных. |

## Особенности реализации

- Используется только высокоуровневый API: подписка на свечи, `Bind` и торговые методы `BuyMarket`/`SellMarket`/`BuyStop`/`SellStop`.
- Списки с историческими значениями имитируют индексацию баров (`Close[1]`, `Close[2]`) из MQL и ограничиваются `HistoryLimit`.
- Метод `StartProtection()` запускает встроенный механизм защиты позиций сразу после старта стратегии.
- Все комментарии в коде даны на английском языке для единообразия репозитория.
