# Moving Average Crossover Spread 策略

该策略是将 MQL4 智能交易系统 **“EA - Moving Average”** 移植到 StockSharp 平台的版本。
它在选定的K线数据上跟踪两条指数移动平均线（EMA），在每根新K线开始时检查是否出现交叉信号，并据此开仓。

## 核心思想

- 订阅 `CandleType` 指定的K线序列，并对每根完成的K线计算快、慢两条EMA。
- 仿照原始 MQL 程序中的 `iMA(..., shift=1/2)` 调用，只使用最近两根已经收盘的K线数据判断交叉。
- 当上一根K线中快线已经上穿慢线，而再上一根K线仍旧位于慢线下方时，视为“金叉”，在新K线开盘立即做多。
- 当上一根K线中快线已经下穿慢线，而再上一根K线仍旧位于慢线上方时，视为“死叉”，在新K线开盘立即做空。
- 始终保持最多只有一个持仓；只要有持仓或挂单存在，就不会响应新的信号。

## 订单与风控

- 下单前会读取最新的买一卖一，如果能够计算出点差，则换算成“点”（PriceStep 的整数倍）并与 `MaxSpreadPoints` 对比，超过阈值则放弃该信号，对应 MQL 中 `MarketInfo(..., MODE_SPREAD)` 的过滤逻辑。
- 市价单发送后立即设置对称的保护单：
  - 止损价基于上一根K线的慢EMA值，再加上/减去 `StopLossPoints` 对应的点数。
  - 止盈价与入场价的距离等于止损距离，实现与原始代码 `Ask + (Ask - StopLoss)` / `Bid - (StopLoss - Bid)` 相同的镜像结构。
- 所有以“点”为单位的距离都会通过交易品种的 `PriceStep` 转换为绝对价格，以保持与 MetaTrader 中点值设定一致。

## 移植说明

- 原策略允许选择不同类型的均线，但默认使用 EMA (`MAMode = 1`)。移植版本保持这一默认设置，若需要其他平滑算法，可在此基础上扩展。
- 交易手数由 `TradeVolume` 参数控制，并在 `OnStarted` 中同步到 `Strategy.Volume`。
- 策略不维护额外的历史队列，只保存两组 EMA 数值用于检测交叉，符合仓库的高层 API 要求。

## 参数

- `CandleType` – 订阅的K线类型与周期。
- `FastPeriod` – 快速EMA的周期长度，默认21。
- `SlowPeriod` – 慢速EMA的周期长度，默认84。
- `StopLossPoints` – 以点为单位的止损距离，相对于上一根K线的慢EMA。
- `MaxSpreadPoints` – 允许的最大点差，超出则不进场。
- `TradeVolume` – 市价单的下单手数。

## 使用建议

1. 启动前确认已选择正确的交易标的与K线周期，使EMA值与原 MQL 策略保持一致。
2. 如需启用点差过滤，请确保行情中有 Level1 买卖报价；若缺失则默认认为点差符合要求。
3. 交易品种必须提供有效的 `PriceStep`。若该值不可用，策略无法换算点值，将跳过保护单的设置。
