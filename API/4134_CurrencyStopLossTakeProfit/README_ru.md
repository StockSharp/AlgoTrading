# Стратегия фиксированных стопов в валюте счёта

## Обзор

Данная стратегия — порт MetaTrader 4 эксперта **`sltp-currency.mq4`** на платформу StockSharp. Оригинальный эксперт не открывает сделки, а лишь отслеживает уже существующие позиции по текущему инструменту и закрывает их, когда достигается заданная прибыль или убыток в валюте депозита. Пороговые значения задаются непосредственно в денежных единицах, без пересчёта в пункты. Версия на C# выполняет ту же роль денежного риск-менеджера для позиций, открытых вручную или другими алгоритмами.

## Основные особенности

1. **Учёт собственных сделок.** Каждое исполнение заявки попадает во внутренний список «лотов». В нём хранится направление, объём и цена открытия, что позволяет независимо сопровождать несколько входов.
2. **Расчёт результата в валюте счёта.** Стратегия подписывается на данные Level1 и использует последние цены bid/ask. Разница между ценой входа и текущей ценой переводится в деньги через `PriceStep` и `StepPrice` инструмента.
3. **Самостоятельное закрытие позиций.** Для длинных позиций проверяется достижение цели по прибыли или предельного убытка, после чего выставляется рыночная заявка на продажу остатка. Для коротких позиций выполняется зеркальная логика с рыночной покупкой.
4. **Одна заявка — один лот.** Каждый запрос на выход связывается с созданной заявкой и отслеживается до полного исполнения. Частичные сделки уменьшают остаток лота; отказ или отмена заявки снимает блокировку и позволяет повторить попытку.
5. **Отсутствие сигналов на вход.** Стратегия не генерирует торговых идей, а служит надстройкой для управления риском. Её можно комбинировать с другими роботами либо использовать совместно с ручными сделками в Designer.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `TakeProfitCurrency` | Величина прибыли (в валюте счёта) на одну позицию, при достижении которой выполняется полное закрытие. `0` отключает цель по прибыли. | `5` |
| `StopLossCurrency` | Допустимый размер плавающего убытка (в валюте счёта) для одной позиции. Превышение порога приводит к принудительному выходу. `0` отключает стоп-лосс. | `8` |

Оба параметра представлены как `StrategyParam<decimal>`, отображаются в группе **Risk** и доступны для оптимизации.

## Последовательность работы

- **Запуск.** В `OnStarted` выполняется подписка `SubscribeLevel1()`, а метод `OnReseted` очищает все накопленные данные.
- **Учёт сделок.** Обработчик `OnNewMyTrade` после каждого исполнения обновляет список открытых лотов: новые входы добавляют записи, выходы уменьшают объём или полностью удаляют запись.
- **Проверка условий.** При каждом обновлении Level1 пересчитывается нереализованный результат для длинных (по bid) и коротких (по ask) позиций. Сравнение происходит в денежных единицах, без использования индикаторов.
- **Выставление выходов.** При выполнении условий вызываются `BuyMarket()` или `SellMarket()` с точным объёмом оставшегося лота. Для обработки сбоев и частичного исполнения используется словарь `_closingOrders`, а также переопределённые методы `OnOrderRegisterFailed` и `OnOrderChanged`.

## Практические рекомендации

- Необходимо обеспечить поток bid/ask (или хотя бы last price), иначе невозможно рассчитать текущую прибыль/убыток.
- Стратегия реагирует только на собственные заявки. Чтобы защитить внешние позиции, следует отправлять их через данный экземпляр стратегии.
- Пороговые значения применяются к каждой позиции отдельно. Разноуровневые входы закрываются независимо друг от друга.
- Значение `0` у любого из параметров отключает соответствующий тип защиты (например, можно оставить только стоп-лосс).

## Файлы

- `CS/CurrencyStopLossTakeProfitStrategy.cs` — исходный код стратегии.
- `README.md` — описание на английском языке.
- `README_cn.md` — описание на китайском языке.
- `README_ru.md` — данный документ.

## Отличия от версии MT4

- В MT4 эксперт просматривает все ордера терминала, а StockSharp-реализация учитывает только собственные сделки — это важно для точного тестирования и воспроизводимости.
- Для оценки результата предпочтительно используются цены bid/ask, что ближе к реальной переоценке позиций в MT4. При отсутствии двусторонних котировок используется последняя цена сделки.
- В C# версии явно отслеживается состояние рыночных заявок, что позволяет корректно реагировать на частичные исполнения и отказ биржи. В оригинальном `OrderClose` эти нюансы скрыты внутри платформы MT4.
