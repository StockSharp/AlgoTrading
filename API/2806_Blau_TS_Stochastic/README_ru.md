# Стратегия Blau TS Stochastic
[English](README.md) | [中文](README_cn.md)

Эта стратегия представляет собой порт на StockSharp экспертного советника MetaTrader «Exp_BlauTSStochastic». Система торгует с использованием тройного сглаженного стохастического осциллятора Уильяма Блау, который поставлялся вместе с исходным пакетом MQL. Индикатор вычисляет максимум и минимум цены за настраиваемое количество баров, трижды сглаживает числитель и знаменатель стохастика выбранным типом скользящей средней, преобразует результат в диапазон [-100; 100] и дополнительно строит сглаженную сигнальную линию. Все расчёты выполняются только на закрытых свечах, которые поступают через высокоуровневую подписку на свечи.

Индикатор может строиться по любому из поддерживаемых источников цен (close, open, high, low, median, typical, weighted, simple, quarter, две трендовые модификации или DeMark) и использовать одно из четырёх сглаживаний (SMA, EMA, SMMA/RMA, WMA). Параметр `SignalBar` воспроизводит сдвиг, применявшийся в оригинальном советнике: стратегия анализирует данные давностью `SignalBar` баров, поэтому при значении 1 реагирует на бар, который закрылся на предыдущем шаге.

## Правила входа и выхода

Доступно три торговых режима. В каждом режиме флаги `EnableLongEntry`, `EnableShortEntry`, `EnableLongExit` и `EnableShortExit` определяют, разрешены ли соответствующие действия.

### Режим Breakdown

*Вход в лонг*: значение гистограммы на баре `SignalBar+1` выше нуля, а более свежее значение на баре `SignalBar` меньше либо равно нулю. Это соответствует условию «гистограмма пробивает ноль» из оригинальной версии и открывает (или переворачивает в) длинную позицию, одновременно закрывая шорты.

*Вход в шорт*: значение гистограммы на баре `SignalBar+1` ниже нуля, а более свежее значение на баре `SignalBar` выше либо равно нулю. Стратегия открывает (или переворачивает в) короткую позицию и при необходимости закрывает лонги.

Те же условия отвечают и за выходы: если гистограмма на предыдущем баре была выше нуля, шорты закрываются, а если ниже нуля — закрываются лонги.

### Режим Twist

*Вход в лонг*: гистограмма формирует локальное дно. Значение на баре `SignalBar+1` меньше значения на баре `SignalBar+2`, но последнее значение (`SignalBar`) разворачивается вверх и превышает промежуточный бар. Это воспроизводит «смену направления», реализованную в советнике.

*Вход в шорт*: гистограмма формирует локальную вершину. Значение на баре `SignalBar+1` больше значения на баре `SignalBar+2`, а последнее значение падает ниже промежуточного. При появлении разворота, направленного против позиции, стратегия закрывает позиции противоположного типа.

### Режим CloudTwist

Режим отслеживает изменение цвета облака индикатора, которое задаётся гистограммой и сигнальной линией.

*Вход в лонг*: гистограмма была выше сигнальной линии на предыдущем баре, но последнее значение пересекло сигнальную линию сверху вниз (или коснулось её). Такое изменение цвета трактуется как бычий сигнал, и шорты при необходимости закрываются.

*Вход в шорт*: гистограмма была ниже сигнальной линии, но последнее значение пересекло её снизу вверх (или коснулось). Стратегия открывает шорт и опционально закрывает длинные позиции.

## Управление рисками

* `StopLossPoints` и `TakeProfitPoints` задаются в шагах цены инструмента. Если хотя бы одно значение больше нуля, стратегия включает встроенный блок защиты StockSharp с рыночными ордерами — стопы автоматически сопровождают позицию.
* Объём заявок берётся из свойства `Volume` стратегии. При разворотном сигнале выставляется объём `Volume + |Position|`, чтобы сначала закрыть текущую позицию и только затем открыть новую.

## Параметры

* `CandleType` — таймфрейм (тип данных) для расчёта осциллятора (по умолчанию четырёхчасовые свечи).
* `Mode` — алгоритм формирования сигналов: `Breakdown`, `Twist` или `CloudTwist`.
* `AppliedPrice` — источник цен для расчёта стохастика (close, open, high, low, median, typical, weighted, simple, quarter, trend-following 0/1 или DeMark).
* `Smoothing` — тип сглаживания для всех этапов (`Simple`, `Exponential`, `Smoothed`, `Weighted`).
* `BaseLength` — число баров для расчёта диапазона максимум/минимум.
* `SmoothLength1`, `SmoothLength2`, `SmoothLength3` — длины последовательных сглаживаний числителя и знаменателя.
* `SignalLength` — длина сглаживания сигнальной линии гистограммы.
* `SignalBar` — сдвиг по барам, определяющий, какие значения используются при принятии решений.
* `StopLossPoints`, `TakeProfitPoints` — размеры защитного стопа и цели в шагах цены (0 отключает соответствующий ордер).
* `EnableLongEntry`, `EnableShortEntry`, `EnableLongExit`, `EnableShortExit` — переключатели, разрешающие четыре базовых действия.

Задайте желаемый `Volume`, прикрепите стратегию к инструменту и запустите её. Все расчёты выполняются по закрытым свечам, поэтому перед началом торговли стратегия ждёт формирования индикаторов.
