# Стратегия Simple Martingale Template

## Общее описание
Данная стратегия переносит логику MT4-советника «Simple Martingale Template» в инфраструктуру StockSharp. Анализируются завершённые свечи выбранного таймфрейма. Для генерации сигналов используются две простые скользящие средние (SMA) и фильтр пробоя: закрытие предыдущей свечи должно выйти за максимум или минимум свечи двумя барами ранее. Объём позиции управляется по схеме мартингейла — после убыточного цикла объём умножается, после прибыльного цикла возвращается к базовому значению.

## Логика торговли
1. Подписка на свечи таймфрейма `CandleType`. В расчётах участвуют только закрытые свечи.
2. Расчёт быстрых и медленных SMA по цене закрытия.
3. **Покупка** открывается, если:
   - закрытие последней свечи выше быстрой SMA,
   - быстрая SMA выше медленной,
   - на предыдущей свече быстрая SMA была ниже медленной,
   - закрытие последней свечи выше максимума свечи двумя барами ранее.
4. **Продажа** открывается при зеркально противоположных условиях и закрытии ниже минимума свечи двумя барами ранее.
5. При появлении сигнала и отсутствии позиции/активных заявок стратегия отправляет рыночный ордер с текущим объёмом мартингейла.
6. Стоп-лосс и тейк-профит реализованы программно: после входа хранятся целевые цены, и при касании этих уровней по максимуму/минимуму новой свечи позиция закрывается рыночным ордером.
7. После закрытия позиции анализируется изменение баланса портфеля:
   - рост баланса приводит к возврату объёма к `BaseVolume`;
   - падение баланса умножает предыдущий объём на `Multiplier` с учётом шага объёма инструмента.

## Параметры
| Название | Описание |
| --- | --- |
| `StopLossPoints` | Расстояние до защитного стопа в пунктах. |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах. |
| `BaseVolume` | Базовый лот первого шага мартингейла. |
| `Multiplier` | Множитель объёма после убыточной сделки. |
| `FastPeriod` | Период быстрой SMA. |
| `SlowPeriod` | Период медленной SMA. |
| `CandleType` | Таймфрейм анализируемых свечей. |

## Управление капиталом
- Изменение объёма происходит только при фиксации результата и отсутствии позиций; мелкие колебания (±0.01 денежной единицы) игнорируются.
- Перед постановкой ордеров объём округляется к допустимому шагу, учитываются минимальные и максимальные ограничения инструмента.
- Стоп и тейк контролируются по экстремумам свечей, что повторяет механику оригинального советника, использовавшего рыночные выходы.

## Рекомендации по использованию
- Подбирайте таймфрейм и инструмент так, чтобы SMA успели сформироваться (требуются как минимум два закрытых бара до запуска логики).
- Значения `StopLossPoints` и `TakeProfitPoints` задаются в пунктах, поэтому их необходимо адаптировать к размеру шага цены выбранного инструмента.
- Контролируйте агрессивность мартингейла: при больших множителях капитал требования быстро возрастают.
- Стратегия вызывает `StartProtection()`, поэтому стандартные защитные механизмы StockSharp продолжают работать совместно.
