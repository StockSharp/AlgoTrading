# 小资金马丁策略
[English](README.md) | [Русский](README_ru.md)

## 概述
该策略在 StockSharp 中复刻了“Martin for small deposits”马丁网格专家。策略每次仅在一根完成的K线上执行逻辑，使用最近15根K线的收盘价：当最新收盘价低于14根之前的收盘价时开多网格，反之则开空网格。所有交易都通过高级策略 API 以市价提交。

## 入场逻辑
- 使用滑动窗口保存最近15根完成K线的收盘价。
- 当没有持仓或挂单时，将最新收盘价与14根之前的收盘价进行比较。
- 最新收盘价更低时启动多头网格；更高时启动空头网格。
- 首单手数等于 **Initial Volume**。同方向的后续加仓按照马丁系数放大，然后再按品种的最小交易步长归一化。

## 仓位管理
- 持仓期间，策略会等待 **Bars To Skip** 根完成K线后才考虑下一次加仓。
- 只有当价格朝着持仓不利方向移动至少 **Step (pips)**（根据检测到的点值转换为价格单位）时才会追加订单。
- 每次成交都会更新内部统计数据：总持仓量、平均入场价、多头的最低入场价或空头的最高入场价，以及最近一次成交价。
- 总持仓量不会超过 **Max Volume** 或交易所限制；如果归一化后的手数小于最小交易量，则跳过该笔订单。

## 离场条件
- 当未实现净利润（当前收盘价与平均入场价之差乘以持仓量）超过 **Min Profit** 时，立即平掉所有头寸。
- 若 **Take Profit (pips)** 大于零，且价格自最近一次成交朝有利方向运行了该点数，则整个网格立即平仓。
- 策略会跟踪平仓请求，在退出订单完全成交前不会发送新的指令。恢复空仓后，所有内部计数器都会重置，下一次信号将重新开始新的网格。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| Initial Volume | 0.01 | 首笔订单的基础手数。 |
| Take Profit (pips) | 65 | 最近一次成交向有利方向移动的点数，达到后整体平仓；设为0表示禁用。 |
| Step (pips) | 15 | 价格向不利方向移动的点数，达到后才会加仓。 |
| Bars To Skip | 45 | 连续完成的K线数量，在此期间禁止再次加仓。 |
| Increase Factor | 1.7 | 同方向每次加仓前使用的马丁倍数。 |
| Max Volume | 6 | 网格允许的最大总手数（归一化前）。 |
| Min Profit | 10 | 净利润超过该值时平掉整个网格。 |
| Candle Type | 1小时 | 订阅K线与计算信号所使用的周期。 |

## 实现说明
- 点值根据 `Security.PriceStep` 与小数位数推导；当报价精度为3或5位小数时，会将最小报价步长乘以10以匹配 MQL 中的“pip”概念。
- 未实现利润通过价格差与持仓量估算，不包含原始专家中的掉期或手续费调整。
- 在平仓订单未完全成交之前，策略不会发送新的加仓指令，从而保持原始 MQL 顺序执行的行为。
- 当 **Step (pips)** 为零时不会进行加仓；当 **Take Profit (pips)** 为零时，仅有 **Min Profit** 条件会触发整体平仓。
