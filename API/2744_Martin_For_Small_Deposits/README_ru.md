# Мартин для небольших депозитов
[English](README.md) | [中文](README_cn.md)

## Обзор
Стратегия переносит советник «Martin for small deposits» в StockSharp. Она обрабатывает только завершившиеся свечи, подписывается на 15 последних закрытий и открывает сетку, когда текущее закрытие ниже (для покупок) или выше (для продаж), чем закрытие 14 свечей назад. Все заявки выставляются по рынку через высокоуровневый API стратегий.

## Логика входа
- Поддерживается скользящее окно из 15 закрытий последних свечей.
- При отсутствии открытых позиций или ожидающих заявок текущее закрытие сравнивается со значением 14 свечей назад.
- Более низкое закрытие запускает сетку покупок, более высокое — сетку продаж.
- Объём первой сделки равен **Initial Volume**. Каждая следующая сделка по той же стороне умножается на **Increase Factor** и затем приводится к допустимому шагу объёма инструмента.

## Управление позицией
- Пока позиция открыта, стратегия ждёт минимум **Bars To Skip** завершённых свечей перед добавлением новой сделки.
- Дополнительные заявки отправляются только если цена прошла против позиции не менее **Step (pips)**, пересчитанного в цену через размер пункта.
- После каждой сделки обновляются агрегированный объём, средняя цена входа, минимальная/максимальная цена входа и цена последней сделки.
- Совокупный объём не превышает **Max Volume** и биржевые ограничения. Если приведённый объём меньше минимально допустимого, сделка пропускается.

## Условия выхода
- Когда нереализованная прибыль (разница между текущей ценой закрытия и средней ценой входа, умноженная на объём) превышает **Min Profit**, стратегия закрывает всю сетку.
- Если **Take Profit (pips)** больше нуля и цена прошла это расстояние от последней сделки в нужном направлении, позиция полностью закрывается.
- Пока выполняются заявки на закрытие, новые сделки не отправляются. После возврата к нулевой позиции внутренние счётчики сбрасываются, и следующая сетка начинается "с нуля".

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| Initial Volume | 0.01 | Базовый объём первой сделки. |
| Take Profit (pips) | 65 | Расстояние в пунктах от последней сделки для полного закрытия. 0 — выключить. |
| Step (pips) | 15 | Движение против позиции в пунктах, необходимое для добавления новой сделки. |
| Bars To Skip | 45 | Минимальное количество завершённых свечей между усреднениями. |
| Increase Factor | 1.7 | Множитель объёма для каждой новой сделки в сетке. |
| Max Volume | 6 | Максимально допустимый совокупный объём (до нормализации по шагу). |
| Min Profit | 10 | Порог прибыли для закрытия всей сетки. |
| Candle Type | 1 час | Таймфрейм подписки на свечи и расчёта сигналов. |

## Особенности реализации
- Размер пункта определяется через `Security.PriceStep` и количество знаков после запятой. Для инструментов с 3 или 5 знаками шаг цены умножается на 10, как в MQL.
- Нереализованная прибыль рассчитывается по разнице цен и объёму, без учёта свопов и комиссий, присутствовавших в оригинале.
- Пока есть активные заявки на закрытие, новая усредняющая сделка не отправляется, что сохраняет последовательность действий оригинального эксперта.
- При **Step (pips)** = 0 усреднение не выполняется; при **Take Profit (pips)** = 0 закрытие сетки происходит только по условию **Min Profit**.
