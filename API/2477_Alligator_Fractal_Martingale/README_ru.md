# Стратегия Alligator Fractal Martingale

Стратегия переносит советник MetaTrader «Alligator(barabashkakvn's edition)» на высокоуровневый API StockSharp. Она объединяет индикатор Аллигатор Билла Вильямса, фильтр по фракталам, лестницу усреднения по методу мартингейла и адаптивный трейлинг-стоп. Первая сделка открывается по рынку, а при движении цены против позиции активируются заранее рассчитанные уровни докупки.

## Логика торговли

- **Раскрытие пасти Аллигатора**. Сглаженные средние челюсти (синяя), зубов (красная) и губ (зелёная) рассчитываются по медианной цене. Длинный уклон активируется, когда губы находятся выше челюсти минимум на `EntrySpread`, короткий — при обратном соотношении. При сжатии спреда ниже `ExitSpread` соответствующий уклон отключается.
- **Фильтр по фракталам (опционально)**. Каждая завершённая свеча проверяется на наличие фракталов Билла Вильямса. Лонг допускается лишь при наличии верхнего фрактала за последние `FractalLookback` баров, который расположен как минимум на `FractalBuffer` выше цены закрытия. Для шорта требуется нижний фрактал ниже рынка. Выключите `UseFractalFilter`, чтобы входить только по сигналам Аллигатора.
- **Мартингейл-усреднение**. После первоначального входа стратегия строит до `MartingaleSteps` уровней усреднения через шаг `MartingaleStepDistance`. Объём каждого уровня умножается на `MartingaleMultiplier`, но не превышает `MaxVolume`. При касании ценой уровня позиция немедленно наращивается.
- **Управление выходом**. Каждая позиция получает синтетический стоп-лосс и тейк-профит из параметров `StopLossDistance` и `TakeProfitDistance`. Если `EnableTrailing` включён, стоп подтягивается вслед за ценой при движении больше `TrailingStep` в прибыльную сторону.
- **Выход по Аллигатору (опционально)**. При `UseAlligatorExit = true` позиция закрывается сразу, как только пасть Аллигатора закрывается (уклон сменяется на неактивный).

## Управление риском и ордерами

- Параметр `Volume` задаёт объём первой сделки. Мартингейл-уровни используют округлённый объём и множитель, ограниченный `MaxVolume` и шагом объёма инструмента.
- Стопы и цели рассчитываются на каждой завершённой свече внутри стратегии, без биржевых отложенных заявок. При пересечении диапазоном свечи виртуального стопа или цели позиция закрывается немедленно.
- Перед открытием позиции противоположного направления текущая позиция закрывается, чтобы избежать хеджирования внутри StockSharp.

## Параметры

| Параметр | Описание |
| --- | --- |
| `Volume` | Базовый объём первой сделки. |
| `JawLength`, `TeethLength`, `LipsLength` | Длины сглаженных средних челюсти, зубов и губ Аллигатора. |
| `JawShift`, `TeethShift`, `LipsShift` | Сдвиг (в барах) для чтения буферов индикатора. |
| `EntrySpread`, `ExitSpread` | Пороги раскрытия и закрытия пасти Аллигатора. |
| `UseAlligatorEntry`, `UseAlligatorExit` | Включение/отключение входов и выходов по Аллигатору. |
| `UseFractalFilter` | Использовать ли подтверждение фракталом. |
| `FractalLookback`, `FractalBuffer` | Горизонт актуальности фракталов и минимальная дистанция до цены. |
| `EnableMartingale`, `MartingaleSteps`, `MartingaleMultiplier`, `MartingaleStepDistance`, `MaxVolume` | Настройки мартингейл-лестницы. |
| `StopLossDistance`, `TakeProfitDistance`, `EnableTrailing`, `TrailingStep` | Параметры синтетических стопов, тейков и трейлинг-стопа. |
| `AllowMultipleEntries` | Разрешить повторные входы по рынку при открытой позиции. |
| `ManualMode` | Ручной режим — стратегия только сопровождает позиции. |
| `CandleType` | Тип используемых свечей. |

## Рекомендации по использованию

1. Убедитесь, что инструмент поддерживает выбранные шаги цены и объёма. Стратегия при возможности выравнивает значения по `Security.MinPriceStep` и `Security.VolumeStep`.
2. Мартингейл реализован внутри алгоритма. Если требуется реальная выставка лимитных заявок, отключите функцию и управляйте докупками самостоятельно.
3. Запускайте стратегию на счёте, где допустимо многократное добавление к позиции. Хотя StockSharp агрегирует чистую позицию, оригинальный алгоритм рассчитан на «наращивание» в одном направлении.
4. Значения по умолчанию ориентированы на четырёхзначные валютные пары (`0.008` ≈ 80 пунктов). Настройте дистанции под конкретный рынок перед применением. 
