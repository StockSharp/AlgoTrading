# 3103 — ADX EA (C#)

## Обзор
Оригинальный советник MetaTrader «ADX EA» сочетает пробои по индикатору ADX, пересечения линий +DI/−DI, подтверждение по моментуму старшего таймфрейма и месячный фильтр MACD. Порт на C# воспроизводит эту многоступенчатую схему на высокоуровневом API StockSharp. Стратегия подписывается на три потока свечей:

1. **Основной таймфрейм** (по умолчанию 5 минут) — рассчитывает ADX, линейно-взвешенные средние, проверяет структуру свечей и фильтр объёмов.
2. **Таймфрейм моментума** (по умолчанию 15 минут) — даёт отклонения вокруг базы 100, которые пропускают или блокируют вход.
3. **Таймфрейм MACD** (по умолчанию 30 дней) — имитирует месячный MACD, управляющий выходами.

## Логика торговли
- **Пробойный модуль**. При включении длинные сделки требуют:
  - ADX или +DI выше `EntryLevel` и разницу между +DI и −DI больше `MinDirectionalDifference`.
  - Быстрая LWMA выше медленной, бычья структура свечей (`Low[2] < High[1]`) и растущий моментум (`Momentum[1] > Momentum[2]`).
  - Хотя бы одно из трёх последних значений моментума на старшем таймфрейме должно отклоняться от 100 больше, чем на `MomentumBuyThreshold`.
  - Рост объёма на основном таймфрейме (`Volume[1] > Volume[2]` или `Volume[1] > Volume[3]`).
  - Месячный MACD в бычьем состоянии (`MacdMain[1] > MacdSignal[1]`).
  - ADX выше `ExitLevel`, что подтверждает силу тренда.

  Короткие пробои используют зеркальную логику: доминирование −DI, условие `Low[1] < High[2]`, моментум ниже 100 на `MomentumSellThreshold` и медвежий MACD.

- **Модуль пересечений**. При активации отслеживает пересечение +DI над −DI (для покупок) или −DI над +DI (для продаж). Дополнительные фильтры совпадают с МТ4-версией:
  - `RequireAdxSlope` требует, чтобы ADX рос относительно предыдущего значения.
  - `ConfirmCrossOnBreakout` добавляет требования пробоя при пересечении.
  - `MinAdxMainLine` задаёт минимальное значение ADX на момент пересечения.
  - Совпадение LWMA, наклон моментума, рост объёма и полярность MACD остаются обязательными.

- **Пирамидинг**. Каждый новый ордер увеличивает объём согласно `LotExponent`. `TradeVolume` выступает базовым лотом, а добавочные ступени умножаются на `LotExponent^n`, где `n` — число уже открытых ступеней. `MaxTrades` ограничивает суммарный нетто-объём.

## Управление рисками
- **Защитные заявки**. `TakeProfitSteps` и `StopLossSteps` передаются в `StartProtection` и задаются в шагах цены инструмента.
- **Трейлинг**. `TrailingStopSteps` поддерживает ручной трейлинг за локальным экстремумом цены закрытия.
- **Безубыток**. При `UseBreakEven = true` стоп переносится после прохода `BreakEvenTrigger` шагов и может быть смещён на `BreakEvenOffset` шагов выше точки входа.
- **Выход по MACD**. При `EnableMacdExit = true` месячный MACD закрывает длинные позиции, когда главная линия опускается ниже сигнальной (и наоборот для коротких), что повторяет процедуры `Close_BUY`/`Close_SELL`.
- **Equity-стоп**. `UseEquityStop` отслеживает плавающую доходность и закрывает позиции при просадке, равной `TotalEquityRisk` процентам.

Функции, завязанные на денежные цели счёта («Take Profit in Money», «Trailing Profit in Money» и т.д.), не переносились, поскольку в StockSharp принято управлять риском через ценовые дистанции и сервис защитных заявок. Все остальные решения советника реализованы через соответствующие индикаторы.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TradeVolume` | 0.01 | Базовый лот первой сделки. |
| `CandleType` | 5 минут | Основной поток свечей для расчёта ADX и LWMA. |
| `MomentumCandleType` | 15 минут | Старший таймфрейм для фильтра моментума. |
| `MacdCandleType` | 30 дней | Таймфрейм MACD для выходов. |
| `FastMaPeriod` | 6 | Период быстрой LWMA. |
| `SlowMaPeriod` | 85 | Период медленной LWMA. |
| `AdxPeriod` | 14 | Период индикатора ADX. |
| `MomentumPeriod` | 14 | Период моментума на старшем таймфрейме. |
| `MacdFastPeriod` | 12 | Быстрый EMA в MACD-фильтре выхода. |
| `MacdSlowPeriod` | 26 | Медленный EMA в MACD-фильтре выхода. |
| `MacdSignalPeriod` | 9 | Сигнальная SMA MACD. |
| `EnableBreakoutStrategy` | true | Включает пробойный блок. |
| `EnableCrossStrategy` | true | Включает блок пересечений DI. |
| `UseTrendFilter` | true | Требует доминирования +DI для лонгов и −DI для шортов в пробойном блоке. |
| `RequireAdxSlope` | true | Требует роста ADX при оценке пересечений. |
| `ConfirmCrossOnBreakout` | true | Добавляет условия пробоя к модулю пересечений. |
| `EnableMacdExit` | true | Включает выходы по MACD. |
| `EntryLevel` | 10 | Минимальное значение ADX/+DI/−DI для пробоя. |
| `ExitLevel` | 10 | Минимальное значение ADX, допускающее новые входы. |
| `MinDirectionalDifference` | 10 | Минимальный разрыв между +DI и −DI. |
| `MinAdxMainLine` | 10 | Минимальное значение ADX при пересечении DI. |
| `MomentumBuyThreshold` | 0.3 | Отклонение моментума от 100 для подтверждения лонга. |
| `MomentumSellThreshold` | 0.3 | Отклонение моментума от 100 для подтверждения шорта. |
| `MaxTrades` | 10 | Максимальное число ступеней пирамидинга. |
| `LotExponent` | 1.44 | Множитель объёма на каждую дополнительную ступень. |
| `TakeProfitSteps` | 50 | Дистанция тейк-профита в шагах цены. |
| `StopLossSteps` | 20 | Дистанция стоп-лосса в шагах цены. |
| `TrailingStopSteps` | 40 | Шаги ручного трейлинг-стопа. |
| `UseBreakEven` | true | Активирует перенос стопа в безубыток. |
| `BreakEvenTrigger` | 30 | Шаги в прибыль, необходимые для переноса стопа. |
| `BreakEvenOffset` | 30 | Дополнительное смещение стопа относительно цены входа. |
| `UseEquityStop` | true | Включает эквити-стоп. |
| `TotalEquityRisk` | 1 | Допустимая просадка счёта в процентах. |

## Рекомендации
- Подбирайте `MomentumCandleType` и `MacdCandleType` в соответствии с основным таймфреймом, чтобы воспроизвести оригинальную привязку (например, 5 минут → 15 минут → месяц).
- Совместно настройте `EntryLevel`, `MinDirectionalDifference` и `MinAdxMainLine`: понижение всех трёх значительно ослабляет фильтры.
- Значение `LotExponent` > 1.0 повторяет мартингейл-подход исходника; поставьте 1.0 для постоянного объёма.

