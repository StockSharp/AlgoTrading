# Стратегия Three EMA

## Общее описание
Стратегия повторяет эксперта MetaTrader "ThreeEMA", который использует три экспоненциальные скользящие средние (EMA) разных периодов. Сигналы формируются при строгом упорядочении средних на закрытии свечи: когда быстрая EMA находится выше средней, а средняя выше медленной, стратегия открывает или удерживает длинную позицию. Если порядок обращается (быстрая ниже средней, а средняя ниже медленной), открывается короткая позиция. Защитные стоп‑лосс и тейк‑профит берутся из оригинального MQL и задаются в пунктах относительно шага цены инструмента.

## Поведение оригинального MQL
В MQL-версии создавались три индикатора EMA с периодами `FastPeriod`, `MediumPeriod`, `SlowPeriod`. На каждой закрытой свече выполнялись проверки:

- **Открытие лонга / закрытие шорта** при условии `FastEMA > MediumEMA > SlowEMA`.
- **Открытие шорта / закрытие лонга** при условии `FastEMA < MediumEMA < SlowEMA`.
- Стоп‑лосс и тейк‑профит задавались фиксированными расстояниями в пунктах от цены открытия.

Заявки отправлялись по рынку, объём рассчитывался модулем фиксированных лотов, трейлинг отключался.

## Особенности реализации в StockSharp
- Используется высокоуровневый API подписки на свечи. Три индикатора `ExponentialMovingAverage` привязаны к одной подписке, поэтому на каждую завершённую свечу поступают готовые значения EMA.
- Проверки выполняются только на полностью сформированных свечах, что исключает внутрибрасковый шум.
- При появлении направленного стека индикаторов стратегия отменяет активные заявки, закрывает противоположную позицию (если она есть) и открывает новую рыночную сделку в требуемом направлении.
- Метод `StartProtection` переводит заданные в пунктах стоп‑лосс и тейк‑профит в абсолютное изменение цены с учётом `PriceStep`, полностью повторяя защитную логику оригинального советника.
- При наличии графика отображаются свечи и все три EMA, что помогает визуально контролировать сигналы.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `CandleType` | Таймфрейм 1 минута | Таймфрейм подписки, на которой рассчитываются EMA. |
| `FastPeriod` | 5 | Период быстрой EMA. Должен быть меньше `MediumPeriod`. |
| `MediumPeriod` | 12 | Период средней EMA. Должен находиться между быстрым и медленным значениями. |
| `SlowPeriod` | 24 | Период медленной EMA. Должен быть максимальным. |
| `StopLossPoints` | 400 | Расстояние защитного стоп‑лосса в пунктах (конвертируется в цену через `PriceStep`). Ноль отключает защиту. |
| `TakeProfitPoints` | 900 | Расстояние тейк‑профита в пунктах (конвертируется в цену через `PriceStep`). Ноль отключает защиту. |

## Рекомендации по использованию
1. Перед запуском задайте требуемый объём через свойство `Volume`, так как оригинальный эксперт работал с фиксированными лотами.
2. Следите, чтобы периоды EMA шли в строгом порядке возрастания — при нарушении порядка `OnStarted` выбросит исключение, аналогично проверкам из MQL.
3. Логика всегда переворачивает позицию при смене порядка EMA, поэтому стратегия практически всегда находится в рынке, пока стек индикаторов меняет направление.
