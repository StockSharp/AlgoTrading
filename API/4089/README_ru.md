# Стратегия TST Pullback Reversal
[English](README.md) | [中文](README_cn.md)

## Обзор
**TST Pullback Reversal** — порт оригинального эксперта MetaTrader 4 `TST.mq4`, переписанный на высокоуровневом API StockSharp. Стратегия отслеживает свечи, где после формирования экстремума цена резко отошла от открытия, и пытается взять возврат к среднему. Работает в обе стороны и использует фиксированные стоп-лосс и тейк-профит в шагах цены.

## Логика сигналов
- **Покупка**
  1. Свеча закрылась ниже цены открытия (`Open > Close`).
  2. Разница между максимумом свечи и ценой закрытия превышает `GapPoints * PriceStep`.
  3. На текущей свече еще не было сделок.
  При выполнении условий закрывается короткая позиция (если была) и выставляется рыночная покупка на объем `OrderVolume` плюс объем, необходимый для переворота из шорта в лонг.

- **Продажа**
  1. Свеча закрылась выше цены открытия (`Close > Open`).
  2. Разница между ценой закрытия и минимумом свечи превышает `GapPoints * PriceStep`.
  3. На текущей свече еще не было сделок.
  При выполнении условий закрывается длинная позиция (если была) и отправляется рыночная продажа на объем `OrderVolume` плюс объем для переворота из лонга в шорт.

## Управление позицией
- После входа сразу рассчитываются уровни стоп-лосса и тейк-профита на основе параметров `StopLossPoints` и `TakeProfitPoints`.
- На каждой завершенной свече проверяются экстремумы: если минимум пробил стоп или максимум достиг тейка, позиция закрывается. Приоритет у стоп-лосса.
- После выхода уровни очищаются, но сохраняется время свечи, чтобы не допустить повторного входа в ту же свечу (аналог функции `NevBar()` в исходнике MT4).

## Параметры
- `StopLossPoints` (по умолчанию `500`): расстояние до защитного стопа в шагах цены.
- `TakeProfitPoints` (по умолчанию `100`): расстояние до тейк-профита в шагах цены.
- `GapPoints` (по умолчанию `500`): минимальный откат от экстремума до закрытия для формирования сигнала.
- `OrderVolume` (по умолчанию `0.1`): объем новой рыночной заявки.
- `CandleType` (по умолчанию `1 час`): таймфрейм свечей, которые подписывает стратегия через `SubscribeCandles`.

Все расстояния умножаются на `PriceStep` инструмента; если шаг цены не задан, используется значение `1`.

## Особенности реализации
- Используется только высокоуровневый API StockSharp, без собственных коллекций данных.
- Обработка идет по завершенным свечам, что обеспечивает совместимость с Designer и моделирует внутрисвечные решения советника.
- Флаг `_lastSignalBarTime` повторяет механику `NevBar()` и ограничивает стратегию одним входом на свечу.
- При смене направления стратегия автоматически закрывает противоположную позицию и открывает новую в одном рыночном приказе.
- Стоп и тейк реализованы внутри кода стратегии и срабатывают при достижении уровней по значениям High/Low свечи.

## Практические советы
- Подбирайте `GapPoints` в зависимости от волатильности инструмента: большие значения уменьшают количество сигналов, но фильтруют мелкие откаты.
- Если нужны более точные срабатывания стопов и тейков, используйте более короткий таймфрейм `CandleType`.
- Рассмотрите добавление фильтров тренда, торговых сессий или объема перед запуском на реальном счете, чтобы снизить количество ложных входов.
