# Стратегия Cidomo
[English](README.md) | [中文](README_cn.md)

Перенос советника MetaTrader 5 «Cidomo» на StockSharp. Стратегия работает на новом баре выбранного таймфрейма, измеряет недавний ценовой диапазон и выставляет пару отложенных стоп-заявок выше и ниже диапазона. Управление рисками включает стоп-лосс, тейк-профит, ступенчатый трейлинг-стоп и два варианта мани-менеджмента (фиксированный объём или процент от капитала).

## Логика работы

1. После закрытия очередного бара `CandleType` стратегия собирает максимум и минимум последних `BarsCount` свечей, формируя рабочий ценовой коридор.
2. Выставляется buy stop по цене `максимум + IndentPips` и sell stop по цене `минимум - IndentPips` (отступ задаётся в пунктах и переводится в абсолютное значение).
3. При срабатывании одной заявки противоположная немедленно отменяется, чтобы исключить двойной вход.
4. Для открытой позиции отслеживаются:
   - Исходный стоп-лосс (`StopLossPips`) и тейк-профит (`TakeProfitPips`).
   - Ступенчатый трейлинг-стоп (`TrailingStopPips` / `TrailingStepPips`): стоп переносится только после прохождения цены на величину `TrailingStop + TrailingStep`, что повторяет поведение оригинального советника.
   - Закрытие позиции выполняется рыночными ордерами при достижении стоп-уровней, что эквивалентно вызовам `PositionModify` в MetaTrader.
5. Если `UseTimeFilter = true`, новые заявки ставятся только в интервале ±30 секунд от времени `StartHour:StartMinute` (серверное время), полностью копируя узкое торговое окно из исходного кода.

## Мани-менеджмент

- **FixedVolume** — всегда используется фиксированный объём `TradeVolume`.
- **RiskPercent** — объём рассчитывается так, чтобы при срабатывании стоп-лосса убыток составил `RiskPercent` от текущей стоимости портфеля. Результат округляется по `VolumeStep` инструмента и ограничивается диапазоном `MinVolume` / `MaxVolume`.

## Защита позиции

- Стоп-лосс и тейк-профит хранятся локально и исполняются рыночным выходом при пересечении уровня на следующей свече.
- Трейлинг-стоп передвигается только в сторону сокращения риска и соблюдает минимальный шаг, исключая частые мелкие корректировки.
- Если стоп-лосс отключён (`StopLossPips = 0`), риск-ориентированный расчёт автоматически возвращается к фиксированному объёму `TradeVolume`.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | `H4` | Таймфрейм, на котором строится диапазон пробоя. |
| `BarsCount` | `int` | `15` | Количество завершённых свечей, используемых для поиска максимума и минимума. |
| `IndentPips` | `decimal` | `3` | Отступ в пунктах от границ диапазона перед выставлением стоп-заявок. |
| `StopLossPips` | `decimal` | `50` | Размер стоп-лосса в пунктах; `0` отключает защиту. |
| `TakeProfitPips` | `decimal` | `50` | Размер тейк-профита в пунктах; `0` отключает цель. |
| `TrailingStopPips` | `decimal` | `35` | Расстояние трейлинг-стопа в пунктах; `0` отключает трейлинг. |
| `TrailingStepPips` | `decimal` | `5` | Минимальное дополнительное движение цены, необходимое для подтягивания трейлинг-стопа. |
| `MoneyManagement` | `CidomoMoneyManagementMode` | `RiskPercent` | Режим расчёта объёма (фиксированный или процент риска). |
| `RiskPercent` | `decimal` | `1` | Процент капитала, допускаемый к риску при срабатывании стоп-лосса в режиме `RiskPercent`. |
| `TradeVolume` | `decimal` | `0.1` | Фиксированный объём заявки; используется и при невозможности вычислить риск-базовый объём. |
| `UseTimeFilter` | `bool` | `false` | Включает временной фильтр ±30 секунд. |
| `StartHour` | `int` | `9` | Час (0-23) центра торгового окна. |
| `StartMinute` | `int` | `58` | Минута (0-59) центра торгового окна. |
## Особенности

- Все параметры в пунктах автоматически подстраиваются под 3- и 5-значные котировки (шаг цены умножается на 10), как и в версии для MetaTrader.
- Поскольку в портированной версии уровни контролируются на стороне клиента, важно поддерживать соединение, чтобы стратегия успела отправить рыночные ордера при срабатывании защитных цен.
