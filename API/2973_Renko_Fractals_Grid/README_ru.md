# Стратегия Renko Fractals Grid

## Обзор
Renko Fractals Grid — порт оригинального советника MetaTrader 4 "RENKO FRACTALS GRID". Стратегия торгует пробои последних фракталов Билла Вильямса с подтверждением по волатильности в стиле Ренко, направлением по взвешенным скользящим средним и силой импульса через индикатор Rate of Change. Перенос на StockSharp сохраняет сеточную модель управления позициями исходного робота: мартингейл-подбор объёмов, перевод в безубыток, трейлинг-стопы, защита эквити и опциональный трейлинг плавающей прибыли в денежных единицах.

## Логика входов
- **Пробой фрактала.** Лонг открывается, когда последний бычий фрактал пробит закрытием свечи, а минимум одна из трёх предыдущих свечей закрывалась ниже этого уровня. Для шорта условия зеркальные.
- **Фильтр Ренко.** Анализируется диапазон High/Low последних _CandlesToRetrace_ свечей. Сигнал допустим только если текущая цена закрытия находится минимум на один «кирпич» (фиксированное число пунктов или текущее значение ATR) дальше экстремумов.
- **Фильтр тренда.** Быстрая и медленная взвешенные средние должны быть направлены в одну сторону (быстрая выше медленной для покупок и ниже для продаж).
- **Импульс.** Абсолютное отклонение трёх последних значений Rate of Change от 100 должно превышать заданные пороги. Это повторяет фильтр `iMomentum` из версии MQL4.
- **MACD.** Входы разрешены только при правильном расположении основной линии MACD относительно сигнальной. То же правило используется для досрочного выхода.

## Управление риском
- **Мартингейл-сетка.** Каждый дополнительный вход умножает базовый объём на _LotExponent_, а общее количество одновременно открытых сделок ограничено параметром _MaxTrades_.
- **Стоп и тейк.** Фиксированные отступы в пунктах рассчитываются от средней цены позиции.
- **Безубыток.** После прохождения цены на _BreakEvenTriggerPips_ стоп переносится на цену входа плюс _BreakEvenOffsetPips_.
- **Трейлинг.** Свечной трейлинг-стоп отслеживает максимальное отклонение цены от точки входа.
- **Денежный трейлинг.** При активированной опции после достижения _MoneyTakeProfit_ совокупная прибыль фиксируется, если просадка от максимума превышает _MoneyStopLoss_.
- **Стоп по эквити.** Стратегия запоминает максимум совокупной стоимости портфеля и открытых позиций. При просадке более _EquityRiskPercent_ процентов все позиции закрываются.

## Параметры
| Параметр | Описание |
| --- | --- |
| `CandleType` | Тип свечей, на которых строятся индикаторы. |
| `FastMaLength` / `SlowMaLength` | Периоды взвешенных скользящих средних. |
| `MomentumLength` | Длина окна для индикатора Rate of Change. |
| `MomentumBuyThreshold` / `MomentumSellThreshold` | Минимальное отклонение от 100 для подтверждения сделок. |
| `UseAtrFilter` | Использовать ATR вместо фиксированного размера кирпича Ренко. |
| `BoxSizePips` | Размер кирпича в пунктах при отключённом ATR-фильтре. |
| `CandlesToRetrace` | Количество свечей для поиска экстремумов. |
| `BaseVolume` | Базовый объём первой сделки. |
| `LotExponent` | Множитель объёма для каждой следующей сделки в сетке. |
| `MaxTrades` | Максимальное число одновременно открытых сделок в одном направлении. |
| `StopLossPips` / `TakeProfitPips` | Отступы стоп-лосса и тейк-профита в пунктах. |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах (0 — отключено). |
| `UseBreakEven` | Включить перевод в безубыток. |
| `BreakEvenTriggerPips` / `BreakEvenOffsetPips` | Порог активации безубытка и добавочный запас в пунктах. |
| `UseMoneyTarget` | Включить денежный трейлинг прибыли. |
| `MoneyTakeProfit` / `MoneyStopLoss` | Порог по плавающей прибыли и максимально допустимый откат. |
| `UseEquityStop` | Включить глобальный стоп по эквити. |
| `EquityRiskPercent` | Допустимая просадка от пика эквити (в процентах). |

## Особенности реализации
- В MQL4 советник считал MACD на месячном таймфрейме. В StockSharp используется тот же набор параметров на рабочем таймфрейме, поскольку дополнительных подписок по умолчанию нет.
- Все величины в пунктах пересчитываются через шаг цены инструмента, что корректно работает для пятизнаковых котировок.
- Реализован подсчёт реализованной прибыли через события сделок, что достаточно для оценки просадки эквити без данных брокера.
- Стратегия использует высокоуровневые подписки на свечи и индикаторы, а комментарии в коде переведены на английский язык, как требуется в проекте.
