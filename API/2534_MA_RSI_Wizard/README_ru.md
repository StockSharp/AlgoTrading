# Стратегия MA + RSI Wizard

## Обзор

Это перенос эксперта "MQL5 Wizard MA RSI" из каталога `MQL/17489` на платформу StockSharp. В оригинале Expert Advisor использует фильтр скользящей средней и фильтр RSI, а сделки выполняются когда взвешенная сумма сигналов пересекает заданные пороги. В версии на C# сохранена логика советника, при этом задействованы высокоуровневые возможности StockSharp и встроенные средства риск-менеджмента.

Стратегия способна работать на любом инструменте с OHLCV-свечами. Она рассчитывает одну скользящую среднюю с настраиваемым сдвигом и индикатор RSI с выбором ценового источника. Оба индикатора формируют составной балл: при превышении порога открытия создаётся позиция, при достижении противоположным баллом порога закрытия позиция ликвидируется. Параметры дистанций, стопов и тейков повторяют настройки оригинального эксперта.

## Индикаторы и оценка

* **Скользящая средняя** — регулируемые период, метод (Simple, Exponential, Smoothed, LinearWeighted), источник цены и сдвиг вперёд. Если закрытие выше смещённой средней, вклад MA равен 100, иначе 0.
* **RSI** — регулируемые период и источник цены. Для длинного сигнала вклад линейно растёт от 0 при RSI = 50 до 100 при RSI = 100; для короткого сигнала поведение симметричное.
* **Составной балл** — вычисляется как взвешенное среднее `score = (maScore * MaWeight + rsiScore * RsiWeight) / (MaWeight + RsiWeight)`, что удерживает результат в диапазоне 0…100 аналогично реализации в MetaTrader.
* **Фильтр дистанции** — параметр `PriceLevelPoints` задаёт минимальное расстояние между ценой закрытия и смещённой средней (в пересчёте на цену через шаг цены инструмента). Более близкие сигналы отбрасываются.

## Правила торговли

1. Индикаторы пересчитываются только на закрытых свечах.
2. Если противоположный балл ≥ `ThresholdClose`, текущая позиция закрывается рыночным ордером.
3. **Вход в лонг** — возможен при отсутствии длинной позиции, когда балл длинного направления ≥ `ThresholdOpen`, выдержан кулдаун `ExpirationBars`, а расстояние до средней превышает порог. Объём ордера `Volume + |Position|`, что позволяет мгновенно переворачиваться из шорта.
4. **Вход в шорт** — зеркально к правилам для лонга.
5. `StartProtection` активирует стоп-лосс и тейк-профит в абсолютных ценовых пунктах.

## Риск-менеджмент

После запуска вызывается `StartProtection`. Расстояния `StopLevelPoints` и `TakeLevelPoints` задаются в пунктах и умножаются на `Security.PriceStep`. Нулевое значение выключает соответствующий барьер. `ExpirationBars` работает как кулдаун между входами в одном направлении и отражает параметр срока действия отложенных ордеров из исходного эксперта.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `CandleType` | Тип свечей для анализа. | 15-минутные свечи |
| `ThresholdOpen` | Минимальный балл для открытия позиции. | 55 |
| `ThresholdClose` | Минимальный обратный балл для закрытия. | 100 |
| `PriceLevelPoints` | Минимальная дистанция до смещённой MA (пункты). | 0 |
| `StopLevelPoints` | Стоп-лосс (пункты). | 50 |
| `TakeLevelPoints` | Тейк-профит (пункты). | 50 |
| `ExpirationBars` | Кулдаун перед повторным входом в том же направлении (свечи). | 4 |
| `MaPeriod` | Период скользящей средней. | 20 |
| `MaShift` | Сдвиг средней вперёд (свечи). | 3 |
| `MaMethod` | Метод MA (Simple, Exponential, Smoothed, LinearWeighted). | Simple |
| `MaAppliedPrice` | Источник цены для MA. | Close |
| `MaWeight` | Вес вклада MA в общий балл. | 0.8 |
| `RsiPeriod` | Период RSI. | 3 |
| `RsiAppliedPrice` | Источник цены для RSI. | Close |
| `RsiWeight` | Вес вклада RSI. | 0.5 |

## Примечания

* Стратегия обрабатывает только закрытые свечи и игнорирует незавершённые бары.
* При нулевых весах индикаторов торговля прекращается, так как балл не достигает порогов.
* `ExpirationBars = 0` разрешает повторные входы без ожидания.
* Поскольку в StockSharp по умолчанию используются рыночные заявки, параметр истечения отложенных ордеров реализован в виде кулдауна, а не отмены заявок.
