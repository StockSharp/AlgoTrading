# Стратегия MO Bidir

## Обзор
**MO Bidir** — порт на StockSharp советника MetaTrader 4 `mo_bidir_v0_1`. Оригинальный робот работал на пятиминутном графике и на каждой новой свече открывал хедж из рыночной покупки и продажи с фиксированными уровнями стоп-лосса и тейк-профита. Перенесённая версия повторяет эту логику, но использует только завершённые свечи и высокоуровневые методы регистрации заявок.

## Логика торговли
1. Стратегия подписывается на выбранный тип свечей (по умолчанию 5 минут) и обрабатывает только закрытые бары.
2. При закрытии свечи проверяется список активных хедж-ног. Если хотя бы одна нога ещё открыта, новых сделок не открывается до срабатывания защитных уровней.
3. Когда активных ног нет, отправляются **рыночная покупка** и **рыночная продажа** одинакового объёма. Каждая исполненная заявка превращается в отдельную хедж-ногу.
4. После полного исполнения рассчитываются цены стоп-лосса и тейк-профита: расстояние в пунктах умножается на шаг цены инструмента (если он неизвестен — используется минимальный шаг).
5. На каждой последующей закрытой свече стратегия сравнивает экстремумы с защитными уровнями:
   - Для длинной ноги пробой минимумом уровня стоп-лосса закрывает позицию рыночной продажей. Если стоп не задет, пробой максимума уровня тейк-профита фиксирует прибыль.
   - Для короткой ноги пробой максимумом стоп-уровня закрывает позицию рыночной покупкой. Если стоп не задействован, пробой минимума тейк-профита завершает сделку с прибылью.
   - Если в пределах одной свечи оказались и стоп, и цель, приоритет отдаётся стоп-лоссу — так поступал исходный советник при первом касании цены.
6. Когда все ноги закрыты защитными ордерами, на следующей свече стратегия сразу подготавливает новый хедж.

Такая последовательность максимально соответствует MT4-реализации и опирается исключительно на `BuyMarket`/`SellMarket` и требования руководства по конвертации.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Объём заявок для обеих ног хеджа. Значение должно быть больше нуля. |
| `StopLossPoints` | Расстояние до стоп-лосса в пунктах инструмента. Значение `0` отключает стоп. |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах. Значение `0` отключает целевое закрытие. |
| `CandleType` | Тип свечей, по которым фиксируется момент открытия хеджа. По умолчанию пятиминутные. |

Расстояния в пунктах переводятся в абсолютную цену через умножение на `PriceStep`. Если шаг цены не задан, используется `MinPriceStep`; при отсутствии обеих величин защитные уровни не активируются.

## Управление риском
- Оба направления используют одинаковый объём и симметричные уровни защиты.
- Значения стопа (80 пунктов) и цели (750 пунктов) соответствуют исходным настройкам, что эквивалентно 8 и 75 пунктам на пятизначной форекс-котировке.
- Закрытие ног производится рыночными приказами — это мгновенно освобождает маржу и позволяет оставшейся ноге работать до своего сигнала выхода.

## Особенности реализации
- Стратегия принимает решения только по закрытым свечам. При отсутствии тиковых данных в тесте предполагается, что при одновременном появлении стопа и тейка сначала сработал стоп.
- Список хедж-ног позволяет отслеживать каждую сторону отдельно, даже если суммарная позиция портфеля равна нулю, — тем самым имитируется режим «хеджинг» MetaTrader.
- Перенос не добавляет новых фильтров, индикаторов или трейлинг-стопов: логика остаётся настолько же лаконичной, как и в оригинальном советнике.

## Рекомендации по использованию
- Подберите значение `TradeVolume` под требования брокера и убедитесь, что торговая площадка допускает одновременные длинные и короткие позиции по одному инструменту.
- Если параметры задаются в «пипсах», предварительно переведите их в пункты, соответствующие шагу цены инструмента.
- При необходимости дополнительных средств защиты комбинируйте стратегию с модулем `StartProtection` или внешними системами управления рисками StockSharp.
