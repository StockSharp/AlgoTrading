# TugbaGold 策略

## 概述

TugbaGold 源自 MetaTrader 5 的网格马丁策略。本转换版本利用 StockSharp 的高级 API 重现其加仓与出场逻辑：当上一根 K 线显示趋势动能时加仓，并以固定点距构建买卖网格；当浮动利润达到阈值后根据不同模式对最极端的持仓执行平仓或部分减仓。

## 工作流程

1. 策略订阅 `CandleType` 参数指定的蜡烛序列，始终使用**上一根**已完成蜡烛生成信号，与 MT5 原版保持一致。
2. 若上一根蜡烛收阳，则允许开多；若收阴，则允许开空。
3. 只有当当前价格与网格中最佳价格的距离超过 `PointOrderStepPips` 时才会加仓。
4. 第一单使用 `StartVolume`。之后的每一单会将最有利持仓的手数加倍，同时受 `MaxVolume` 与交易所手数限制约束。
5. 当同一方向至少存在两单后，策略会在目标价中加入 `MinimalProfitPips` 的利润缓冲，按模式计算出场价格：
   - **Average**：按极值仓位的加权平均价计算，再加上利润缓冲。
   - **Partial**：把最差仓位按 `StartVolume` 计入，最佳仓位按其实际手数计入。
6. 到达目标价时执行对应的平仓逻辑：
   - **Average 模式**：同时完全平掉最优与最差的两笔仓位。
   - **Partial 模式**：完全平掉最差仓位，并将最佳仓位减仓 `StartVolume`。
7. 如果某方向只有一笔仓位，则按照 `TakeProfitPips` 的距离平仓。

## 参数说明

| 参数 | 含义 |
|------|------|
| `TakeProfitPips` | 单笔仓位的止盈距离，设为 `0` 表示关闭。 |
| `StartVolume` | 新网格第一单的初始手数。 |
| `MaxVolume` | 单笔最大手数，`0` 表示不限制加倍。 |
| `CloseMode` | 出场模式：`Average`（双向极值全部平仓）或 `Partial`（部分减仓+全平）。 |
| `PointOrderStepPips` | 相邻加仓单之间的最小点距。 |
| `MinimalProfitPips` | 触发出场时额外要求的利润缓冲。 |
| `CandleType` | 生成信号所用的蜡烛类型。 |

## 仓位管理

- 点值优先读取 `Security.PriceStep`，若不可用则回退到 `0.0001`。
- 下单与减仓手数会自动按照交易品种的最小手数、最大手数以及步长进行归一化。
- 策略内部维护持仓列表，在需要平仓时使用 `BuyMarket`/`SellMarket` 提交市价单。
- 启动时会自动调用 `StartProtection()`，保持与平台风险控制流程一致。

## 注意事项

- 代码假设市价单可以即时成交，与 MT5 实盘环境类似。
- 需要实时的买卖价（Level1 数据）才能准确触发网格出场逻辑。
- 原策略中的止损未在此版本中实现，所有退出完全由逻辑驱动。
- 马丁加仓风险较高，运行前请做好资金与风险控制。

## 转换要点

- 网格平均价、手数调整等公式完全复刻自原始 MQL5 程序。
- 通过跟踪每个方向的最高价与最低价来判定“最佳/最差”仓位，并执行相应的平仓顺序。
- 所有决策均在蜡烛订阅回调中完成，未使用任何低级别的历史查询接口，符合高层 API 的最佳实践。
