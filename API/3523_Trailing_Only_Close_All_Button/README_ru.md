# Стратегия Trailing Only Close All Button

Стратегия воспроизводит советник MetaTrader *Trailing Only with Close All Button*. Она не открывает сделки самостоятельно, а только сопровождает позиции, открытые другой логикой или вручную. При старте выставляются уровни стоп-лосса, тейк-профита и трейлинг-стопа, вычисленные по метатрейдеровским пунктам. Дополнительно реализована кнопка **Close All**, которая закрывает позиции и/или снимает ордера по заданным фильтрам.

## Основные особенности

- Подписка на **Level1** обеспечивает поток лучших цен Bid/Ask для расчёта защитных уровней.
- После появления позиции сразу рассчитываются цены стоп-лосса и тейк-профита на основе параметров `StopLossPips` и `TakeProfitPips`.
- Трейлинг-стоп активируется, когда прибыль превышает сумму `TrailingStopPips + TrailingStepPips`. Каждое дополнительное улучшение цены минимум на `TrailingStepPips` подтягивает стоп ближе к рынку.
- При достижении рассчитанного стопа или тейка стратегия закрывает позицию рыночной сделкой, что соответствует работе серверных стопов в MetaTrader.
- Кнопка `CloseAll` может закрывать только позиции, только отложенные ордера либо и то и другое. При этом доступны фильтры по инструменту и по текущей прибыли/убытку, как в оригинальном скрипте.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `StopLossPips` | Расстояние от цены входа до стоп-лосса в метатрейдеровских пунктах (для 5-ти знаков 0.00010). | 500 |
| `TakeProfitPips` | Расстояние до тейк-профита в метатрейдеровских пунктах. | 1000 |
| `TrailingStopPips` | Минимальная прибыль (в пунктах), после которой включается трейлинг-стоп. | 200 |
| `TrailingStepPips` | Дополнительный шаг (в пунктах), необходимый для каждого следующего подтягивания стопа. При включённом трейлинге должен быть больше нуля. | 50 |
| `ManualCloseMode` | Что закрывает кнопка: только позиции, только ордера или всё сразу. | Positions |
| `ManualCloseSymbol` | Ограничивает действие кнопки текущим инструментом или распространяет на все инструменты стратегии. | Chart |
| `ManualCloseProfitFilter` | Фильтр по плавающему PnL: закрывать всё, только прибыльные или только убыточные позиции. | ProfitOnly |
| `CloseAll` | Виртуальная кнопка. Установите `true` в интерфейсе, чтобы запустить ручное закрытие; стратегия сама вернёт значение в `false`. | `false` |

## Особенности реализации

- Перевод пунктов в цену выполняется через `PriceStep`. Для инструментов с 3 или 5 знаками используется множитель `10`, как в MetaTrader.
- Используется только высокоуровневый API: подписка `SubscribeLevel1()` и рыночные заявки `BuyMarket` / `SellMarket` для выхода.
- Все состояния трейлинга и ручного закрытия сбрасываются при обнулении позиции, чтобы предыдущие уровни не влияли на новые сделки.
- Процедура ручного закрытия перебирает `Portfolio.Positions` и список ордеров стратегии, применяя выбранные фильтры перед отправкой заявок на закрытие или отмену.
