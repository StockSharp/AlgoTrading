# Стратегия Lego EA
[English](README.md) | [中文](README_cn.md)

**Lego EA Strategy** — порт оригинального эксперта Lego EA под StockSharp. Стратегия объединяет несколько фильтров (CCI, две скользящие средние, стохастик, Accelerator Oscillator, DeMarker и Awesome Oscillator), причем каждый фильтр можно включать отдельно для входов и выходов. Это позволяет либо полностью воспроизвести оригинальную конфигурацию, либо собирать «конструктор» из собственных блоков.

## Параметры
- `Volume` — базовый объём позиции при прибыльной предыдущей сделке.
- `LotMultiplier` — множитель для объёма после убыточной сделки.
- `StopLossPips` — расстояние стоп-лосса в пунктах (автоматически переводится в цену).
- `TakeProfitPips` — расстояние тейк-профита в пунктах.
- `UseCciForEntry` / `UseCciForExit` — использование фильтра CCI для открытия/закрытия.
- `UseMaForEntry` / `UseMaForExit` — проверка пересечения быстрой и медленной скользящих.
- `UseStochasticForEntry` / `UseStochasticForExit` — контроль стохастика относительно уровней.
- `UseAcceleratorForEntry` / `UseAcceleratorForExit` — анализ последовательности значений Accelerator Oscillator.
- `UseDemarkerForEntry` / `UseDemarkerForExit` — проверка индикатора DeMarker на выход за заданные уровни.
- `UseAwesomeForEntry` / `UseAwesomeForExit` — подтверждение импульса через Awesome Oscillator.
- `CciPeriod` — период расчёта CCI.
- `MaFastPeriod`, `MaSlowPeriod` — периоды скользящих средних.
- `MaShift` — горизонтальный сдвиг скользящих (количество завершённых баров назад).
- `MaMethod` — тип сглаживания.
- `MaPrice` — цена, подаваемая на обе скользящие.
- `StochasticKPeriod`, `StochasticDPeriod`, `StochasticSlow` — параметры стохастика.
- `StochasticLevelUp`, `StochasticLevelDown` — пороговые уровни стохастика.
- `DemarkerPeriod`, `DemarkerLevelUp`, `DemarkerLevelDown` — настройки DeMarker.
- `CandleType` — таймфрейм свечей, по которым строятся индикаторы.

## Логика работы
1. После формирования каждой свечи стратегия собирает значения всех выбранных индикаторов.
2. Для согласованности с MetaTrader используется значение предыдущего закрытого бара (аналог `iGetArray(...,1)`).
3. Вход в лонг возможен только при одновременном подтверждении всех включённых фильтров на покупку; для шорта требуются сигналы на продажу.
4. Если позиции нет и условия выполнены — отправляется рыночная заявка. Объём равен базовому `Volume` либо последнему объёму, умноженному на `LotMultiplier`, если предыдущая сделка была убыточной.
5. При наличии позиции фильтры выхода проверяются аналогичным образом. Закрытие выполняется, когда все активные фильтры дают встречный сигнал.
6. `StartProtection` автоматически устанавливает стоп и тейк в абсолютных ценах с учётом шага цены инструмента.

## Управление риском
- При прибыли объём сбрасывается к базовому `Volume`.
- При убытке следующий объём увеличивается в `LotMultiplier` раз, воспроизводя ступенчатый маневр исходного эксперта.
- Минимальный/максимальный объём и шаг объёма берутся из свойств инструмента и контролируются перед отправкой заявки.

## Отличия от версии MetaTrader
- Источники цен индикаторов сопоставлены со стандартными типами StockSharp. CCI использует типичную цену, скользящие — выбранный `MaPrice`.
- Расчёт ведётся строго по закрытым свечам, что исключает неполные значения.
- Проверки freeze-level заменены на встроенный механизм `StartProtection`.
- Учёт результата сделки происходит при полном закрытии позиции, что соответствует обработке события `DEAL_ENTRY_OUT` в MT5.

## Рекомендации
- Начните с базовой конфигурации (включены только скользящие), затем постепенно подключайте дополнительные фильтры.
- Следите за нагрузкой на депозит при больших значениях `LotMultiplier` — серия убытков быстро увеличивает объём.
- Используйте тестер стратегий StockSharp для оценки сочетаний фильтров на нужном инструменте.

Python-реализация пока отсутствует.
