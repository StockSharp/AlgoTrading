# Стратегия AutoMagiCal

## Обзор
AutoMagiCal — это точная конверсия одноимённого скрипта MetaTrader. Первоначальный инструмент генерировал детерминированный «magic number», которым другие советники могли помечать свои ордера. Скрипт не выполнял торговых операций: он анализировал строку символа и выводил итоговый идентификатор на график MetaTrader. Версия для StockSharp повторяет эту логику внутри жизненного цикла стратегии, чтобы автоматизированные процессы могли использовать тот же идентификатор без изменений.

В отличие от стандартных торговых алгоритмов, AutoMagiCal полностью сосредоточен на подготовке данных. При запуске стратегия проверяет привязанный `Security`, извлекает несколько символов из его кода, преобразует их в ASCII-коды и объединяет цифры в большое целое число. Результат сохраняется в свойстве `MagicNumber` и записывается в журнал стратегии, что позволяет другим модулям или операторам ссылаться на него при необходимости.

## Алгоритм расчёта magic number
1. Получить идентификатор инструмента. Стратегия сначала использует `Security.Id`, а при его отсутствии — `Security.Code`. Если инструмент не назначен, в журнал выводится сообщение об ошибке.
2. Извлечь четыре символа с теми же смещениями, что и в MetaTrader: позиции с 1 по 4 (нулевой символ пропускается). Каждый символ переводится в десятичный ASCII-код и добавляется к промежуточной строке.
3. Преобразовать конкатенированную строку в десятичное число. Ошибки парсинга регистрируются через `AddErrorLog`, что повторяет защитные проверки исходного MQL-кода.
4. Ограничить чрезмерно большие значения теми же порогами, что и оригинал. Числа больше `999 999 999` делятся на 10, а после первой корректировки значения свыше `9 999 999 999` дополнительно делятся на 100. Это предотвращает переполнение целочисленного типа при слишком длинной последовательности.
5. Округлить скорректированное значение до ближайшего целого и сохранить его в `MagicNumber`. В журнал пишется сообщение `"Magic No. = X"`, которое заменяет подпись в углу графика из MetaTrader.

## Особенности реализации
- Класс наследует `Strategy` и переопределяет `OnStarted`, чтобы выполнить расчёт сразу после запуска. Метод `OnReseted` очищает сохранённый magic number и гарантирует повторный расчёт при новом старте.
- Комментарии в исходном коде написаны на английском языке в соответствии с правилами репозитория.
- Логика полностью отделена от торговли. Стратегия не регистрирует заявки и не подписывается на поток данных — она служит вспомогательным компонентом, предоставляющим стабильный идентификатор.
- Вместо графической подписи используются сообщения журнала. StockSharp позволяет просматривать их в интерфейсе, файлах и системах телеметрии, поэтому информация остаётся доступной без дополнительных визуальных элементов.
- Свойство `MagicNumber` имеет тип `int?`. Пока расчёт не выполнен, оно остаётся `null`, что помогает быстро выявить проблемы конфигурации.

## Инструкция по использованию
1. Перед вызовом `Start()` привяжите стратегию к портфелю и нужному инструменту. Без идентификатора инструмента расчёт невозможен.
2. Запустите стратегию. Метод `OnStarted` моментально сработает и выполнит логику AutoMagiCal.
3. Проверьте журнал: там появится запись `Magic No. = <значение>`. То же значение доступно программно через свойство `MagicNumber`.
4. При необходимости остановите стратегию после получения числа. Поскольку никаких торговых действий не выполняется, её можно оставить запущенной — это не повлияет на счёт.
5. Если в журнале отображаются ошибки вроде «Security is not assigned» или «Symbol is too short», проверьте строку инструмента. Для корректной работы требуется минимум пять символов.

## Отличия от версии MetaTrader
- В MetaTrader скрипт рисовал текстовую метку на графике. В StockSharp её заменили записи журнала, что лучше подходит для автоматизированных сценариев.
- Конверсия объединяет расчёт и обработку ошибок в одном классе стратегии, соответствуя структуре каталога StockSharp. В MQL аналогичная логика могла быть распределена по нескольким файлам.
- В C# явно используется `Math.Round` с параметром `MidpointRounding.AwayFromZero`, чтобы повторить поведение `NormalizeDouble`. Это устраняет неоднозначность для пользователей StockSharp.
- MQL полагался на неявное преобразование double в int. В StockSharp результат хранится в `int?`, благодаря чему факт успешного расчёта становится очевидным.

## Устранение неполадок
- **Не выбран инструмент** — привяжите `Security` перед запуском, иначе стратегия не сможет извлечь символ.
- **Слишком короткий символ** — исходный скрипт ожидал минимум пять символов. Если ваш брокер использует более короткие коды, дополняйте их вручную или адаптируйте алгоритм.
- **Неожиданный результат** — ASCII-код зависит от точных символов в строке. Различные обозначения одного инструмента (например, `EURUSD` и `EURUSDm`) приведут к разным magic number.

## Параметры
Стратегия не имеет параметров. Вся логика фиксирована, что гарантирует совпадение результатов с оригинальным скриптом MetaTrader.
