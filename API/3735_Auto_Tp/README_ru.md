# Стратегия Auto TP

**Auto TP** — это вспомогательная стратегия управления рисками, конвертированная из советника MetaTrader 4 «Auto_Tp». Она не открывает сделки самостоятельно, а следит за уже существующей позицией и автоматически привязывает защитные заявки:

- Размещает фиксированный тейк-профит на заданном расстоянии в MetaTrader-пунктах.
- При необходимости выставляет стартовый стоп-лосс.
- Может подтягивать стоп-лосс вслед за ценой при движении позиции в прибыль.
- Контролирует уровень капитала и закрывает все позиции, если эквити опускается ниже заданного процента от баланса.

## Логика работы

1. Как только позиция стратегии переходит из нуля в лонг или шорт, происходит немедленная постановка тейк-профита и (если включено) стоп-лосса, рассчитанных от средней цены входа и текущего объёма.
2. Пока позиция открыта, поступающие тики Level1 используются для корректировки стоп-лосса. Трейлинг активен только при включённом стоп-лоссе.
3. На каждом тике рассчитывается отношение текущего эквити к исходному балансу. При падении эквити ниже порога стратегия закрывает все позиции и больше не срабатывает, пока эквити не поднимется выше заданного уровня.

Размер MetaTrader-пункта определяется на основе шага цены инструмента. Для инструментов с 3/5 знаками после запятой (а также 2/3 знаков для JPY-пар) пункт равен десяти шагам цены, что повторяет поведение оригинального советника.

## Параметры

| Параметр | Описание |
| --- | --- |
| `TakeProfitPips` | Расстояние до тейк-профита в MetaTrader-пунктах. Значение должно быть положительным. |
| `UseStopLoss` | Включает постановку стоп-лосса. |
| `StopLossPips` | Расстояние до стоп-лосса в MetaTrader-пунктах. Используется только при активном `UseStopLoss`. |
| `UseTrailingStop` | Включает трейлинг стопа. Требует активного стоп-лосса. |
| `TrailingStopPips` | Дистанция трейлинга в MetaTrader-пунктах. |
| `UseEquityProtection` | Включает контроль эквити. |
| `MinEquityPercent` | Минимально допустимое эквити в процентах от баланса. При превышении порога вниз все позиции закрываются. |

## Практические рекомендации

- Запускайте стратегию совместно с модулем, который открывает сделки, либо используйте для сопровождения вручную набранных позиций через StockSharp. Стратегия защищает только те позиции, которые проходят через её экземпляр.
- Для лонгов трейлинг ориентируется на лучшую цену покупки (bid), для шортов — на лучшую цену продажи (ask). Заявки всегда сдвигаются минимум на один шаг цены от рынка, чтобы избежать немедленного исполнения.
- Для расчёта порога по эквити сначала используется `Portfolio.BeginValue`, при отсутствии значения стратегия опирается на текущее `Portfolio.CurrentValue`.
- При частичном закрытии или наращивании позиции параметры защитных заявок пересчитываются с учётом нового среднего входа и объёма. Уже достигнутое значение трейлинг-стопа сохраняется, если оно более выгодно.

## Отличия от оригинального советника

- В StockSharp защитные приказы выставляются и обновляются отдельно, а не через модификацию уже открытой сделки, как в MetaTrader. При изменении параметров старые заявки отменяются и регистрируются заново.
- Контроль эквити выполняется по данным портфеля брокера. В MetaTrader использовались функции AccountBalance/AccountEquity терминала.
- Параметр `Slippage`, присутствовавший в исходном советнике для ручного закрытия сделок, не нужен: управление проскальзыванием осуществляется брокером.

## Графическая часть

Стратегия не добавляет собственных элементов на графики. При необходимости визуализации её можно запускать вместе с любым модулем, который строит графические объекты или отображает сделки.

