# Auto TP 策略

**Auto TP 策略** 是从 MetaTrader 4 的 "Auto_Tp" 智能交易系统转换而来的风险管理助手。它本身不会生成入场信号，而是监控当前仓位，并自动附加保护性挂单：

- 在可配置的 MetaTrader 点（pip）距离处放置固定止盈。
- 可选地设置初始止损。
- 当行情朝有利方向运行时，可启动移动止损。
- 监控账户权益，当权益低于账户余额的一定百分比时平掉所有头寸。

## 工作原理

1. 仓位从空仓变为多头或空头时，策略立即按照最新仓位数量挂出止盈与（若启用）止损单。
2. 只要仓位未平仓，策略就会在每次 Level1 行情到来时尝试更新移动止损。只有在启用止损和移动止损时才会执行。
3. 每个行情跳动都会比较当前权益与设定阈值，一旦权益低于阈值，策略会立刻平掉全部仓位，并在权益重新高于阈值之前避免重复触发。

策略通过品种的价格步长来推算 MetaTrader 的 pip 大小。对于 3 或 5 位小数（以及日元品种的 2 或 3 位小数）报价，pip 被定义为价格步长的 10 倍，与原始 EA 的逻辑一致。

## 参数

| 名称 | 说明 |
| --- | --- |
| `TakeProfitPips` | 止盈距离（MetaTrader pip）。必须为正数。 |
| `UseStopLoss` | 是否启用止损挂单。 |
| `StopLossPips` | 止损距离（MetaTrader pip），仅在启用止损时生效。 |
| `UseTrailingStop` | 是否启用移动止损，需要先启用止损。 |
| `TrailingStopPips` | 移动止损距离（MetaTrader pip）。 |
| `UseEquityProtection` | 是否启用权益保护。 |
| `MinEquityPercent` | 当权益低于账户余额该百分比时平仓。 |

## 使用提示

- 请将该策略与其他入场策略或手动下单结合使用；它只会保护通过 StockSharp 策略持有的仓位。
- 多头移动止损使用最优买价，空头使用最优卖价，并会保证止损价格至少与市场价相差一个价格步长，以避免立即成交。
- 权益保护优先使用 `Portfolio.BeginValue` 作为账户余额参考值；如果无法获取，则退回使用当前权益。
- 当仓位数量发生变化（部分平仓或加仓）时，策略会基于新的平均持仓价与数量重新同步已有的保护性挂单。

## 与原版 EA 的差异

- 在 StockSharp 中需要显式挂出止损/止盈委托，而不是像 MetaTrader 那样直接修改仓位属性。当参数变化时，对应挂单会被撤销并重新下达。
- 权益保护依赖于经纪商提供的投资组合数值，原始 EA 使用终端中的 AccountBalance 与 AccountEquity。
- 强制平仓时的滑点控制由经纪商处理，因此不再保留 EA 中的 `Slippage` 输入参数。

## 图表

该工具不会额外绘制图表元素。如需可视化，可与其它入场策略或自定义图表组件一同使用。

