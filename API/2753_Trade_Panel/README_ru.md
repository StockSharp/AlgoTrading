# Стратегия Trade Panel

## Общее описание
Стратегия переносит торговую панель MetaTrader "TradePanel" на высокоуровневый API StockSharp. В оригинале это был графический интерфейс для ручного открытия рыночных сделок, закрытия позиций различными способами и управления базовыми стоп-уровнями. В версии для StockSharp панель заменена параметрами стратегии, но логика исполнения и контроля рисков повторяет замысел MQL-советника.

## Логика работы
1. **Получение данных**. Стратегия подписывается на поток Level1 по выбранному инструменту и хранит последнюю цену сделки, лучшие bid/ask. Эти значения используются при оценке стопов, тейков и текущей прибыли/убытка.
2. **Ручные команды**. Параметры `BuyRequest`, `SellRequest`, `CloseRequest` эмулируют кнопки панели. При установке значения `true` отправляется соответствующий рыночный ордер, после чего флаг автоматически сбрасывается. Выполнение команд возможно только при активном подключении и заполненных свойствах `Security` и `Portfolio`.
3. **Режимы закрытия** (`CloseMode`) полностью повторяют панель:
   - `CloseAll` — полное закрытие позиции.
   - `CloseLast` — закрытие объёма до величины `OrderVolume`, имитируя последнюю сделку.
   - `CloseProfit` — закрытие полной позиции только при положительном результате относительно средней цены входа (`PositionPrice`).
   - `CloseLoss` — закрытие полной позиции при отрицательном результате.
   - `ClosePartial` — закрытие объёма `PartialCloseVolume`, позволяя частично фиксировать позицию.
4. **Защитные уровни**. Опциональные стоп и тейк задаются в пунктах и переводятся через `Security.PriceStep`. При пробое уровня стратегия отправляет рыночный ордер на полное закрытие позиции. Внутренний флаг предотвращает повторные заявки до изменения позиции.

## Параметры
| Параметр | Описание |
|----------|----------|
| `OrderVolume` | Базовый объём новых рыночных сделок и режимa `CloseLast`. |
| `StopLossPoints` | Расстояние стоп-лосса в пунктах (0 — отключено). |
| `TakeProfitPoints` | Расстояние тейк-профита в пунктах (0 — отключено). |
| `PartialCloseVolume` | Объём частичного закрытия при режиме `ClosePartial`. |
| `CloseMode` | Режим обработки команд закрытия (`CloseAll`, `CloseLast`, `CloseProfit`, `CloseLoss`, `ClosePartial`). |
| `BuyRequest` | Установка `true` отправляет рыночную покупку (флаг сбрасывается). |
| `SellRequest` | Установка `true` отправляет рыночную продажу (флаг сбрасывается). |
| `CloseRequest` | Установка `true` активирует выбранный режим закрытия (флаг сбрасывается). |

## Отличия от MQL-версии
- Нет графического интерфейса, функций рисования, звуков и спидометра — управление идёт через параметры.
- Работа ведётся с чистой нетто-позицией StockSharp, поэтому множество ордеров MetaTrader агрегируются в единую позицию.
- Стопы и тейки исполняются рыночными заявками при достижении уровня, а не модификацией ордеров как в MetaTrader.
- Таймеры и обработчики мыши, использовавшиеся только для UI, исключены, так как они не нужны в автоматическом режиме.

## Рекомендации по использованию
- Убедитесь, что доступны данные Level1; без них защитные проверки не смогут определить текущее значение цены.
- Параметры команд проверяются при поступлении новых котировок. В спокойном рынке выполнение может ожидать следующего тика.
- Значения `StopLossPoints` и `TakeProfitPoints` зависят от корректной настройки `Security.PriceStep` под инструмент MetaTrader.
- Перед отправкой сделок стратегия проверяет наличие подключения и заданных свойств, что повторяет защитные проверки оригинальной панели.
