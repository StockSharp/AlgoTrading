# Стратегия NRTR ATR Stop

## Обзор
Стратегия NRTR ATR Stop переносит логику советника MetaTrader `Exp_NRTR_ATR_STOP` на высокоуровневый API StockSharp. Она отслеживает динамические уровни NRTR (Non-Repainting Trailing Reverse), построенные на основе среднего истинного диапазона (ATR). Когда цена пробивает противоположный уровень, направление тренда мгновенно меняется: старые позиции закрываются, а в новом направлении открывается рыночная сделка.

## Логика индикатора
* Для подписанной серии свечей вычисляется **ATR** с длиной `AtrPeriod`. Значение ATR умножается на коэффициент `Coefficient`, определяя расстояние от цены до текущего стоп-уровня.
* Поддерживаются два «ползущих» уровня:
  * `upper stop` сопровождает бычий тренд и располагается под ценой, защищая длинные позиции.
  * `lower stop` сопровождает медвежий тренд и располагается над ценой, защищая короткие позиции.
* При закрытии свечи за противоположным уровнем направление тренда немедленно переворачивается. Новый уровень инициализируется экстремумом предыдущей свечи, смещённым на расстояние ATR.
* Оригинальный советник использует смещение `SignalBar`, считывая значения индикатора на несколько свечей назад. Стратегия повторяет это поведение с помощью очереди: каждая завершённая свеча сохраняет свой сигнал, а исполнение происходит только после того, как накопится `SignalBar` закрытых свечей.

## Торговые правила
1. **Сигнал на покупку** — направление меняется с нейтрального/медвежьего на бычье. Стратегия при необходимости закрывает все короткие позиции и одним рыночным ордером открывает новую длинную позицию с объёмом `Volume` плюс величина закрываемого шорта.
2. **Сигнал на продажу** — направление меняется с нейтрального/бычьего на медвежье. Аналогично закрываются длинные позиции и открывается новая короткая позиция.
3. Флаги `EnableLongEntry`, `EnableShortEntry`, `EnableLongExit`, `EnableShortExit` задают, какие действия выполнять при появлении сигнала.
4. Сигналы обрабатываются только по завершённым свечам и когда стратегия находится онлайн и имеет разрешение на торговлю.

## Параметры
| Имя | Описание |
| --- | --- |
| `AtrPeriod` | Количество свечей для расчёта ATR. |
| `Coefficient` | Множитель, которым умножается ATR при построении стоп-уровней. |
| `SignalBar` | Количество полностью закрытых свечей, которое нужно подождать перед исполнением сигнала. Ноль — исполнение сразу. |
| `CandleType` | Тип/таймфрейм используемых свечей. |
| `EnableLongEntry` | Разрешение на открытие длинных позиций по сигналу на покупку. |
| `EnableShortEntry` | Разрешение на открытие коротких позиций по сигналу на продажу. |
| `EnableLongExit` | Разрешение на закрытие длинных позиций при сигнале на продажу. |
| `EnableShortExit` | Разрешение на закрытие коротких позиций при сигнале на покупку. |

## Дополнительные замечания
* Стратегия опирается только на закрытые свечи и не анализирует внутрисвечные тики.
* Сделки отправляются через `BuyMarket` и `SellMarket`, что позволяет в одном ордере закрыть позицию и открыть новую в противоположном направлении.
* Перед запуском убедитесь, что свойство `Volume` установлено в положительное значение.
