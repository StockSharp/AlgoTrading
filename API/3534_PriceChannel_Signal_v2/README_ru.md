# Стратегия PriceChannel Signal v2

## Общее описание
PriceChannel Signal v2 — трендовая стратегия на основе модифицированного канала Дончиана. Оригинальный советник MQL5 отслеживает смену тренда по каналу, дополнительные сигналы на повторный вход при повторном пробое диапазона и защитные уровни выхода, построенные из того же диапазона. Порт на StockSharp полностью сохраняет логику: работает с одной позицией, анализирует только завершённые свечи и при необходимости ограничивает торговлю временным окном.

## Логика работы
1. Верхняя и нижняя границы канала Дончиана рассчитываются на интервале `ChannelPeriod`.
2. Полученный диапазон смещается двумя коэффициентами:
   * **Risk Factor** — сдвигает входные полосы к центру диапазона.
   * **Exit Level** — формирует внутренние защитные полосы для выходов.
3. Поддерживается состояние тренда:
   * Закрытие выше верхней входной полосы переводит тренд в бычий режим.
   * Закрытие ниже нижней входной полосы переводит тренд в медвежий режим.
   * Если пробоя нет, сохраняется предыдущее состояние.
4. Сигналы:
   * **Покупка** — переход тренда из медвежьего в бычий.
   * **Продажа** — переход тренда из бычьего в медвежий.
   * **Повторный вход вверх** — при включённой опции цена закрывается выше верхней полосы, когда тренд уже бычий.
   * **Повторный вход вниз** — при включённой опции цена закрывается ниже нижней полосы, когда тренд уже медвежий.
   * **Выход из лонга** — при включённой опции закрытие опускается ниже защитной полосы после нахождения выше неё на предыдущей свече.
   * **Выход из шорта** — при включённой опции закрытие поднимается выше защитной полосы после нахождения ниже неё на предыдущей свече.
5. На одну свечу допускается не более одной заявки в каждом направлении. Новая позиция не открывается, если предыдущая ещё активна.
6. При включённом временном фильтре все сигналы игнорируются вне заданного торгового интервала.

## Параметры
| Параметр | Описание |
|----------|----------|
| `ChannelPeriod` | Длина истории для канала Дончиана и защитных полос. |
| `RiskFactor` | Сдвиг входных полос (0–10). Меньшие значения расширяют диапазон, большие — сужают. |
| `ExitLevel` | Сдвиг защитных полос. Должен быть больше `RiskFactor`, чтобы располагаться внутри диапазона входа. |
| `UseReEntry` | Включает повторные входы при пробое активной полосы. |
| `UseExitSignals` | Включает выходы по внутренним защитным полосам. |
| `CandleType` | Тип свечей, на которых строятся расчёты. |
| `UseTimeControl` | Переключатель ограничения по времени. |
| `StartHour` / `StartMinute` | Начало торгового окна (включительно) при включённом фильтре. |
| `EndHour` / `EndMinute` | Конец торгового окна (исключительно) при включённом фильтре. |

## Правила входа и выхода
* **Вход в лонг:** тренд стал бычьим или выполнено условие повторного входа, позиция отсутствует, свеча внутри торгового окна.
* **Вход в шорт:** тренд стал медвежьим или выполнено условие повторного входа вниз, позиция отсутствует, свеча внутри торгового окна.
* **Выход из лонга:** включены защитные сигналы и закрытие опустилось ниже защитной полосы после нахождения выше неё на предыдущей свече.
* **Выход из шорта:** включены защитные сигналы и закрытие поднялось выше защитной полосы после нахождения ниже неё на предыдущей свече.

## Дополнительные замечания
* Стратегия использует рыночные заявки и не наращивает объём позиции.
* Обработка выполняется только по завершённым свечам, что исключает перерисовку внутри бара.
* Объём по умолчанию — 1 контракт, если не задан пользователем.
* Временной фильтр повторяет поведение оригинала: конечное время задаётся как исключительное, допускается переход через полночь.
