# Buy Sell Close 策略

## 概要
- 基于 MetaTrader `@Buy_Sell_Close` 面板改写的手动交易工具。
- 通过参数触发市价买入/卖出以及关闭多头、空头或全部仓位。
- 支持以“万分比风险”重新计算下单手数，并按需批量更新止损/止盈委托。
- 通过日志输出账户快照，复刻原始脚本中的图表信息面板。

## 工作原理
原版专家顾问在图表上绘制按钮来完成买入、卖出、平仓和修改保护单。StockSharp 版本改为使用策略参数面板。每个布尔参数都是一次性开关：设置为 `true` 即执行对应操作，随后自动恢复为 `false`。

### 主要操作
- **Open Buy / Open Sell**：发送市价单。交易量来自固定手数，或启用自动资金管理后按公式 `balance * risk / 10000` 计算。
- **Close Buys / Close Sells**：分别平掉多头或空头持仓。策略同时跟踪多空腿，可处理对冲仓位。
- **Close Everything**：同时平掉多头和空头。
- **Apply Stops**：撤销旧有保护单，并基于当前参数为多头和空头重新下达止损、止盈订单。
- **Refresh Snapshot**：输出包含余额、权益、持仓量及浮动盈亏的日志，相当于 MQL 面板的文本提示。

### 自动资金管理
当 `Automatic Money Management` 打开时，策略使用与 MQL 相同的“万分比风险”公式（例如 `0.2` 代表 0.02%）。若标的缺少 `StepPrice` 等合约信息，则回退为固定手数。

### 止损与止盈
止损/止盈参数以 MetaTrader 点数表示，通过乘以 `PriceStep` 转换为真实价格距离。执行前会先取消旧订单，防止重复挂单；仅当对应方向存在持仓时才会生成保护单。

### 日志
- 快照日志包含余额、权益、多空持仓量与浮盈，方便监控。
- 当缺少组合、标的或计算结果为零时，会输出警告提醒无法执行请求。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `Automatic Money Management` | 是否启用风险驱动的手数计算。 | `true` |
| `Risk (1/10000)` | 与 MQL 相同的万分比风险系数。 | `0.2` |
| `Fixed Volume` | 关闭自动管理时使用的固定手数。 | `0.01` |
| `Stop-Loss Points` | 以点数表示的止损距离，用于批量更新保护单。 | `250` |
| `Take-Profit Points` | 以点数表示的止盈距离，用于批量更新保护单。 | `500` |
| `Open Buy` / `Open Sell` | 触发一次市价买入或卖出。 | `false` |
| `Close Buys` / `Close Sells` / `Close Everything` | 触发平掉多头、空头或全部仓位。 | `false` |
| `Apply Stops` | 触发重新布置止损/止盈订单。 | `false` |
| `Refresh Snapshot` | 输出一条账户状态日志。 | `false` |

## 与 MQL 版本的差异
- 操作入口改为 StockSharp 参数面板，不再绘制图表按钮。
- 止损/止盈通过高层 API 下单，而不是修改已有 MetaTrader 票据。
- 账户信息写入日志，而非在图表上显示文本。
- 风险计算沿用原公式，同时考虑 StockSharp 提供的最小/步长手数约束。

