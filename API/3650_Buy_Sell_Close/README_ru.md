# Стратегия Buy Sell Close

## Кратко
- Ручной помощник, конвертированный из панели MetaTrader `@Buy_Sell_Close`.
- Через параметры можно отправлять рыночные заявки на покупку/продажу и закрывать длинные, короткие или все позиции.
- Поддерживает автоматическое управление объёмом на основе риска в десятитысячных долях депозита и позволяет по требованию обновлять стоп-лосс/тейк-профит.
- Пишет подробные снимки счёта в журнал, повторяя информационную панель оригинального скрипта.

## Как работает
В MQL версия рисовала кнопки на графике. В StockSharp действия выполняются через панель параметров. Каждый логический параметр — это одноразовый переключатель: установите `true`, стратегия выполнит действие и сразу вернёт значение к `false`.

### Основные действия
- **Open Buy / Open Sell** — отправка рыночных приказов. Объём берётся из фиксированного параметра или рассчитывается формулой `balance * risk / 10000`, полностью повторяющей MQL.
- **Close Buys / Close Sells** — закрытие всех длинных или коротких позиций. Стратегия отдельно ведёт учёт двух направлений, поэтому поддерживает хеджевые комбинации.
- **Close Everything** — одновременное закрытие длинного и короткого плеча.
- **Apply Stops** — отменяет старые защитные заявки и ставит новые стоп-лосс и тейк-профит для каждого направления, используя заданные расстояния в пунктах.
- **Refresh Snapshot** — пишет в журнал баланс, капитал, объёмы и плавающий результат, имитируя таблички на графике из MetaTrader.

### Управление риском
При включенном `Automatic Money Management` размер позиции вычисляется по той же формуле, что и в MQL (`Risk (1/10000)` = доля в десятитысячных). Если у инструмента нет данных `StepPrice`, стратегия возвращается к фиксированному объёму.

### Стоп-лосс и тейк-профит
Параметры задаются в пунктах MetaTrader и переводятся в цену через `PriceStep`. Перед постановкой новых заявок старые отменяются, а защитные ордера создаются только при наличии позиции соответствующего направления.

### Логирование
- Снимки содержат баланс, equity, объёмы по направлениям и плавающий PnL — аналог панели `Date/Balance/Profit` из MQL.
- При невозможности выполнить действие (нет портфеля, инструмента или объём равен нулю) выводится предупреждение.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `Automatic Money Management` | Включение расчёта объёма по риску. | `true` |
| `Risk (1/10000)` | Риск в десятитысячных долях депозита, идентичен MQL. | `0.2` |
| `Fixed Volume` | Фиксированный объём, когда авторасчёт отключён. | `0.01` |
| `Stop-Loss Points` | Расстояние до стоп-лосса в пунктах. | `250` |
| `Take-Profit Points` | Расстояние до тейк-профита в пунктах. | `500` |
| `Open Buy`, `Open Sell` | Одноразовые флаги для отправки рыночных приказов. | `false` |
| `Close Buys`, `Close Sells`, `Close Everything` | Одноразовые флаги для закрытия позиций. | `false` |
| `Apply Stops` | Одноразовый флаг для обновления защитных ордеров. | `false` |
| `Refresh Snapshot` | Запрос на вывод отчёта по счёту. | `false` |

## Отличия от версии MQL
- Действия выполняются через параметры стратегии, без рисования кнопок на графике.
- Защитные ордера выставляются высокоуровневыми методами StockSharp, а не модификацией существующих тикетов.
- Информация об аккаунте передаётся через журнал вместо текстовых меток на графике.
- Расчёт риска сохранён в исходном виде и учитывает ограничения по минимальному/шаговому объёму из метаданных StockSharp.

