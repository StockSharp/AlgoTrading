# 移动平均持仓系统策略

## 概述

移动平均持仓系统是 MetaTrader 4 指标专家 "MovingAveragePositionSystem.mq4" 的移植版本。策略监控一条长周期移动平均线，只在蜡烛完全收盘后根据价格与均线的交叉动作进行交易。它支持手动设定手数，并可选择启用类似马丁格尔的仓位管理逻辑，根据以 MetaTrader 点数表示的盈亏累计结果调整交易量。

## 交易逻辑

1. **信号判定**
   - 计算可配置的移动平均线（简单、指数、平滑或线性加权）。
   - 当最新收盘蜡烛的收盘价穿越移动平均线并与上一根蜡烛的方向相反时，策略开仓。
   - 每个方向只允许一笔仓位：已有多头时不会再次买入，已有空头时不会再次卖出。
2. **持仓管理**
   - 如果新收盘的蜡烛在均线下方且当前持有多头，则立即市价平仓。
   - 如果蜡烛在均线上方且当前持有空头，则立即平掉空头。
   - 可以通过参数启用按点数计算的固定止盈；止损逻辑由均线反向穿越负责。
3. **资金管理**
   - 启用马丁格尔模块后，策略会统计当前交易周期内的已实现盈亏和浮动亏损（仅记录亏损），单位为 MetaTrader 点。
   - 当累计亏损超过设定阈值时，下一次交易手数加倍（永远不超过最大手数），并平掉所有持仓。
   - 当累计盈利超过设定目标时，手数重置为初始值，并平掉持仓以锁定利润。

## 参数说明

| 参数 | 说明 |
|------|------|
| **MaType** | 移动平均类型：Simple、Exponential、Smoothed 或 LinearWeighted，对应原策略的 `TypeMA`。 |
| **MaPeriod** | 移动平均计算周期（默认 240）。 |
| **MaShift** | 移动平均的前移位数，对应 `SdvigMA`。 |
| **CandleType** | 计算所使用的蜡烛类型，默认使用 1 小时蜡烛。 |
| **InitialVolume** | 启动时的手数，对应 `Lots`。 |
| **StartVolume** | 盈利后重置的基础手数（`StarLots`）。 |
| **MaxVolume** | 允许的最大手数（`MaxLots`），超过时会自动减半。 |
| **LossThresholdPips** | 亏损阈值（点），达到后触发加倍 (`LossPips`)。 |
| **ProfitThresholdPips** | 盈利阈值（点），达到后恢复基础手数 (`ProfitPips`)。 |
| **TakeProfitPips** | 固定止盈距离（点），对应 `TakeProfit`。 |
| **UseMoneyManagement** | 是否启用马丁格尔式资金管理 (`MM`)。 |

## 使用建议

- 使用与原始 MetaTrader 设置相同的交易品种和周期。240 周期与 1 小时时间框架组合能复现默认行为。
- 点值阈值依赖于证券的 `PriceStep` 与 `StepPrice` 配置，如无该信息需要手动调整参数。
- 原代码每次下单前都会检查保证金，移植版本采用简化处理：当当前手数超过 `MaxVolume` 时自动减半。若需更多风险控制，可结合 StockSharp 内建的风险管理组件。
- 策略仅在蜡烛收盘时做出决策，与 MQL 中基于 `Close[1]` 与 `Close[2]` 的逻辑保持一致。

## 文件列表

- `CS/MovingAveragePositionSystemStrategy.cs` – 使用 StockSharp 高级策略 API 的 C# 实现。
- `README.md` – 英文文档。
- `README_ru.md` – 俄文文档。
- `README_cn.md` – 中文文档（本文件）。

