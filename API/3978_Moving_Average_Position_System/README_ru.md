# Стратегия Moving Average Position System

## Общее описание

Moving Average Position System — это порт MetaTrader 4 советника «MovingAveragePositionSystem.mq4». Стратегия отслеживает длинную скользящую среднюю и реагирует на пересечения цены закрытия по завершённым свечам. Поддерживается ручной выбор лота и необязательная мартигейл-последовательность увеличения объёма, ориентированная на суммарный результат в пунктах MetaTrader.

## Логика работы

1. **Определение сигнала**
   - Вычисляется настраиваемая скользящая средняя (простая, экспоненциальная, сглаженная или линейно-взвешенная).
   - Когда закрытие последней завершённой свечи пересекает среднюю в противоположном направлении относительно предыдущей свечи, открывается новая позиция.
   - Одновременно разрешена только одна позиция в каждом направлении: если уже есть покупка, стратегия не будет докупать, пока не закроет текущую сделку (аналогично для продаж).
2. **Сопровождение позиции**
   - Если свеча закрылась ниже средней при открытой длинной позиции, стратегия немедленно закрывает покупку по рынку.
   - Если свеча закрылась выше средней при открытой короткой позиции, короткая позиция закрывается.
   - При необходимости можно задать фиксированный тейк-профит в пунктах MetaTrader — стопы в остальном контролируются пересечением со средней.
3. **Управление капиталом**
   - При активированном мартигейл-блоке стратегия суммирует реализованный и плавающий результат текущего цикла в пунктах MetaTrader.
   - При убытке, превосходящем заданный порог, объём следующей сделки удваивается (но не превышает максимально допустимый лот), а открытые позиции закрываются.
   - При достижении целевой прибыли объём сбрасывается к стартовому лоту, а открытые позиции фиксируются.

## Параметры

| Параметр | Описание |
|----------|----------|
| **MaType** | Тип скользящей средней: Simple, Exponential, Smoothed или LinearWeighted (аналог `TypeMA`). |
| **MaPeriod** | Период скользящей средней (по умолчанию 240). |
| **MaShift** | Горизонтальный сдвиг средней (соответствует `SdvigMA`). |
| **CandleType** | Тип свечей для расчётов. По умолчанию — часовые свечи. |
| **InitialVolume** | Начальный объём перед коррекцией мартигейла (`Lots`). |
| **StartVolume** | Базовый лот, к которому возвращается мартигейл после прибыльного цикла (`StarLots`). |
| **MaxVolume** | Максимально допустимый лот (`MaxLots`). При превышении объём автоматически делится пополам. |
| **LossThresholdPips** | Порог убытка в пунктах, вызывающий удвоение объёма (`LossPips`). |
| **ProfitThresholdPips** | Порог прибыли в пунктах, при котором объём сбрасывается к стартовому значению (`ProfitPips`). |
| **TakeProfitPips** | Фиксированный тейк-профит в пунктах (`TakeProfit`). |
| **UseMoneyManagement** | Флаг активации блока управления объёмом (`MM`). |

## Рекомендации по использованию

- Используйте те же инструмент и таймфрейм, что и в MetaTrader. Период 240 предполагает работу с часовыми свечами.
- Пороговые значения выражаются в пунктах. Убедитесь, что у инструмента заданы корректные `PriceStep` и `StepPrice`; иначе подберите значения вручную.
- Проверка маржи в оригинале заменена упрощённой нормализацией: если текущий лот превышает `MaxVolume`, он делится пополам. При необходимости добавьте дополнительные фильтры риска средствами StockSharp.
- Сигналы генерируются только на закрытии свечей, полностью повторяя проверку `Close[1]` и `Close[2]` из исходного кода.

## Файлы

- `CS/MovingAveragePositionSystemStrategy.cs` — реализация стратегии на C#.
- `README.md` — документация на английском языке.
- `README_ru.md` — документация на русском языке (этот файл).
- `README_cn.md` — документация на китайском языке.

