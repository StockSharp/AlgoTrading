# MA MACD Position Averaging

Стратегия является точной конверсией советника MetaTrader **«MA MACD Position averaging»**. Она объединяет фильтр по взвешенной скользящей средней с проверкой отношения линий MACD и включает модуль усреднения с наращиванием позиции при неблагоприятном движении цены на заданное число пунктов. Все рисковые параметры задаются в пунктах и автоматически переводятся в ценовые отступы с учётом параметров инструмента из StockSharp.

## Логика работы

1. **Подготовка индикаторов**
   - Настраиваемая скользящая средняя (`MaPeriod`, `MaMethod`, `MaAppliedPrice`) рассчитывается на закрытых свечах. Параметры `SignalBar` и `MaShift` имитируют возможность MetaTrader обращаться к данным предыдущих баров и выводить индикатор со сдвигом по горизонтали.
   - Индикатор MACD (`MacdFastPeriod`, `MacdSlowPeriod`, `MacdSignalPeriod`, `MacdAppliedPrice`) рассчитывается по тем же свечам. Основная и сигнальная линии складываются в небольшой буфер, что позволяет получать исторические значения без прямых вызовов индикатора.
2. **Условия входа**
   - **Покупка**: обе линии MACD ниже нуля, отношение `MACDmain / MACDsignal` не меньше `MacdRatio`, закрытие свечи выше выбранной скользящей средней, а расстояние между ценой и средней не меньше `IndentPips` пунктов.
   - **Продажа**: обе линии MACD выше нуля, отношение превышает `MacdRatio`, закрытие ниже скользящей средней, а разрыв не меньше `IndentPips` пунктов.
   - Новые входы разрешены только при отсутствии открытой позиции. Если цикл усреднения уже запущен, сигнальная часть пропускается и работают только правила усреднения.
3. **Модуль усреднения**
   - При наличии длинной позиции и снижении цены минимум на `StepLossingPips` пунктов относительно лучшей (самой дешёвой) покупки отправляется дополнительный ордер BUY объёмом, равным объёму последней ноги, умноженному на `LotCoefficient` (с округлением по шагу объёма инструмента).
   - При наличии короткой позиции и росте цены минимум на `StepLossingPips` пунктов относительно лучшей (самой высокой) продажи добавляется новая нога SELL с тем же коэффициентом `LotCoefficient`.
   - Если одновременно обнаружены длинные и короткие ноги (в норме этого не происходит), стратегия немедленно закрывает все позиции для восстановления консистентности.
4. **Защитные выходы**
   - Для каждой ноги сохраняются индивидуальные уровни стоп-лосса и тейк-профита (`StopLossPips`, `TakeProfitPips`). На каждой завершённой свече проверяется, пересёк ли ценовой диапазон свечи один из уровней; в случае пересечения нога закрывается рыночным ордером.
   - Трейлинг-стоп (`TrailingStopPips`, `TrailingStepPips`) включается по желанию. После движения цены в прибыль на `TrailingStopPips + TrailingStepPips` пунктов стоп переносится на расстояние `TrailingStopPips` пунктов от текущего закрытия и двигается дальше только при дополнительном прогрессе не менее `TrailingStepPips` пунктов.
5. **Служебная логика**
   - Все объёмы приводятся к шагу объёма и ограничиваются допустимым диапазоном. Обработка выполняется только для полностью сформированных свечей (`CandleStates.Finished`), что исключает двойные срабатывания.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `CandleType` | `DataType` | `TimeSpan.FromHours(1).TimeFrame()` | Таймфрейм для расчёта индикаторов. |
| `OrderVolume` | `decimal` | `0.1` | Базовый объём первой сделки. |
| `StopLossPips` | `int` | `50` | Дистанция стоп-лосса в пунктах (0 отключает стоп). |
| `TakeProfitPips` | `int` | `50` | Дистанция тейк-профита в пунктах (0 отключает цель). |
| `TrailingStopPips` | `int` | `5` | Отступ трейлинг-стопа в пунктах. Должен быть > 0 для активации. |
| `TrailingStepPips` | `int` | `5` | Дополнительное движение в пунктах перед очередным переносом трейлинг-стопа. |
| `StepLossingPips` | `int` | `30` | Просадка в пунктах, при которой открывается новая нога усреднения. |
| `LotCoefficient` | `decimal` | `2.0` | Коэффициент умножения объёма для каждой новой ноги. |
| `SignalBar` | `int` | `0` | Количество полностью завершённых баров, смещающих выборку индикаторов. |
| `MaPeriod` | `int` | `15` | Длина скользящей средней в барах. |
| `MaShift` | `int` | `0` | Горизонтальный сдвиг (в барах) значений скользящей средней. |
| `MaMethod` | `MovingAverageMethod` | `Weighted` | Тип сглаживания (simple, exponential, smoothed, weighted). |
| `MaAppliedPrice` | `AppliedPriceType` | `Weighted` | Источник цены для скользящей средней. |
| `IndentPips` | `int` | `4` | Минимальный разрыв между ценой и средней для входа. |
| `MacdFastPeriod` | `int` | `12` | Период быстрой EMA в MACD. |
| `MacdSlowPeriod` | `int` | `26` | Период медленной EMA в MACD. |
| `MacdSignalPeriod` | `int` | `9` | Период сигнальной линии MACD. |
| `MacdAppliedPrice` | `AppliedPriceType` | `Weighted` | Тип цены, подаваемый на MACD. |
| `MacdRatio` | `decimal` | `0.9` | Минимальное отношение основной и сигнальной линий MACD для торговли. |

### Преобразование пунктов

Все параметры в пунктах (`StopLossPips`, `TakeProfitPips`, `TrailingStopPips`, `TrailingStepPips`, `StepLossingPips`, `IndentPips`) умножаются на `PriceStep` инструмента. Если у инструмента 3 или 5 знаков после запятой, значение дополнительно умножается на 10 для соответствия определению пункта в MetaTrader. При отсутствии данных о шаге цены используется значение `0.0001`.

## Особенности реализации

- Стратегия хранит собственный список ног позиции, поскольку в StockSharp применяется режим неттинга. Каждая нога содержит цену входа, стоп и тейк, что позволяет воспроизвести логику усреднения исходного советника.
- Защитные ордера реализуются программно: при достижении уровня стопа или тейка на свечке нога закрывается рыночным ордером на этой же свече.
- Усреднение автоматически отключается, если `StepLossingPips = 0`. В остальных случаях объём новой ноги равен объёму предыдущей, умноженному на `LotCoefficient`, и округляется вниз до шага объёма.
- Перенос трейлинг-стопа использует цену закрытия свечи в качестве текущей цены. Стоп никогда не отодвигается назад и активируется только после прохождения `TrailingStopPips + TrailingStepPips` пунктов.
- Буферы индикаторов учитывают сдвиги `SignalBar` и `MaShift`, поэтому логика принимает те же значения, что и в MetaTrader при чтении буферов `iMA` и `iMACD`.
