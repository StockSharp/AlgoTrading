# Стратегия MA Reverse

## Описание
MA Reverse — это порт на StockSharp простого советника MetaTrader 4 «MA_Reverse». Исходный робот отслеживает, как долго цена
Bid находится выше или ниже простой скользящей средней (SMA) с периодом 14. После достаточно долгой серии баров в одну сторону
он открывает позицию в расчёте на возврат цены к среднему значению. В версии для StockSharp та же идея реализована через
подсчёт количества завершённых свечей, закрывающихся выше или ниже SMA, и немедленное исполнение рыночного ордера, когда
срабатывает заданный порог.

## Торговая логика
- Стратегия подписывается на свечи выбранного таймфрейма и рассчитывает простую скользящую среднюю с периодом `SmaPeriod`.
- Поддерживается целочисленный счётчик (его целевое значение задаётся параметром `StreakThreshold`), который увеличивается,
пока цена закрытия остаётся выше средней, и уменьшается, пока цена закрытия ниже. При касании средней счётчик сбрасывается.
- Когда счётчик достигает `StreakThreshold`, а цена закрытия минимум на `MinimumDeviation` выше SMA, отправляется рыночный ордер
на продажу. Предполагается, что затянувшееся движение вверх относительно средней скоро развернётся.
- При достижении `-StreakThreshold` и отклонении закрытия на `MinimumDeviation` ниже SMA логика зеркально открывает длинную
позицию.
- После совершения сделки счётчик не обнуляется автоматически — он продолжает отслеживать следующую серию, как и в исходном
советнике.

## Управление ордерами
- Рыночные входы используют объём `TradeVolume`. Если на момент сигнала существует противоположная позиция, стратегия сначала
закрывает её и в том же ордере открывает новую позицию, что повторяет поведение MetaTrader при переводе из лонга в шорт или
наоборот.
- Глобальный тейк-профит настраивается через вспомогательный метод `StartProtection`. Расстояние вычисляется как `TakeProfitPoints`
умноженное на шаг цены инструмента и повторяет выражение «30 * Point» из MQL-кода. При достижении цели позиция закрывается
рыночным ордером.
- В оригинальном советнике не предусмотрен стоп-лосс, поэтому в порте он также отсутствует. Управление рисками полностью
лежит на тейк-профите и настройках риск-менеджмента пользователя.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Лот для каждого рыночного входа. Это же значение используется при развороте позиции для закрытия старых сделок и открытия новых. |
| `SmaPeriod` | Количество свечей в расчёте простой скользящей средней. По умолчанию соответствует 14, как в советнике. |
| `StreakThreshold` | Сколько последовательных закрытий должно оказаться по одну сторону от SMA, прежде чем разрешается открытие позиции. |
| `MinimumDeviation` | Минимальное абсолютное расстояние между ценой закрытия и SMA, подтверждающее экстремум. |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены. Умножается на `PriceStep`, чтобы получить абсолютное значение. |
| `CandleType` | Тип свечей (таймфрейм), используемый для расчёта SMA и оценки серий. |

## Примечания
- Счётчик работает на завершённых свечах, полученных через `SubscribeCandles`, что делает реализацию устойчивой и совместимой с
прогоном по историческим данным. Поведение совпадает с тиковым вариантом MetaTrader при достаточно мелком таймфрейме.
- StockSharp агрегирует позиции, поэтому несколько последовательных сделок рассматриваются как одна позиция с единым плавающим
тейк-профитом. Это аналогично постановке одинакового тейк-профита на каждую заявку в MetaTrader.
- Индикатор не добавляется в `Strategy.Indicators`, поскольку привязка через `Bind` сама управляет жизненным циклом индикатора.
- Перед запуском стратегии уточняйте шаг цены и торговый объём для конкретных инструментов у брокера, чтобы `TakeProfitPoints`
давал ожидаемое абсолютное смещение.
