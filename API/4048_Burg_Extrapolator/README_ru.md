# Стратегия Burg Extrapolator

## Обзор
Стратегия Burg Extrapolator — это порт на StockSharp оригинального эксперта MetaTrader 4 «Burg Extrapolator». Исходный советник строит модель авторегрессии (AR) с помощью алгоритма Бёрга по скользящему окну цен открытия (или их преобразований MOM/ROC) и формирует прогноз траектории цены. Решения о входе/выходе принимаются по экстремальным точкам прогноза: если ожидаемый ход в одном направлении достаточно велик, алгоритм наращивает позицию, а при противоположном сигнале закрывает существующие сделки. Конвертация сохраняет модельные блоки, адаптируя управление позицией и капиталом под высокоуровневый API StockSharp.

## Логика торговли
1. **Подготовка данных**
   - Формируется история из `PastBars + 1` цен открытия для заданного `CandleType`.
   - По выбору трейдера данные преобразуются в логарифмический моментум (по умолчанию) или процентное изменение. Для работы с «сырыми» ценами они центрируются на скользящем среднем, как в коде MT4.
2. **Линейное прогнозирование Бёрга**
   - Рассчитываются коэффициенты отражения до порядка `PastBars * ModelOrder` алгоритмом Бёрга.
   - Модель рекурсивно разворачивается вперёд и строит последовательность будущих значений (на практике — до `PastBars` баров). При необходимости прогноз переводится обратно в ценовое пространство.
3. **Поиск сигналов**
   - Стратегия просматривает прогноз и запоминает первую максимум/минимум до появления противоположного экстремума. Разница между найденными значениями сравнивается с порогами `MaxLoss` и `MinProfit` (в абсолютную цену переводятся умножением на `PriceStep`).
   - Достаточно сильный подъём даёт `OpenSignal = 1`, падение — `OpenSignal = -1`. Если первым формируется противоположный экстремум, выставляется `CloseSignal` для закрытия текущей позиции без открытия новой.
4. **Управление ордерами**
   - Сначала выполняются защитные блоки (стоп-лосс, тейк-профит, трейлинг). Трейлинг отслеживает лучшую цену с момента входа и закрывает позицию при откате на `TrailingStop` пунктов, что соответствует поведению MT4 с переносом стопа.
   - При появлении сигнала на закрытие противоположной позиции отправляется рыночный ордер на полный объём текущего нетто-позиционирования.
   - Сигналы входа последовательно наращивают позицию до предела `MaxTrades`. Объём следующей заявки масштабируется по формуле `1 + existingTrades * MaxRisk`, что заменяет метатрейдеровскую привязку к марже и удобно для StockSharp.

## Данные и индикаторы
- Свечи выбранного типа `CandleType` (по умолчанию 30-минутные).
- Встроенная модель авторегрессии Бёрга (без внешних индикаторов).
- Необязательные преобразования: логарифмический моментум и процентное изменение.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | 30-минутные свечи | Основной таймфрейм стратегии. |
| `MaxRisk` | 0.5 | Множитель риска для масштабирования дополнительных заявок. |
| `MaxTrades` | 5 | Максимальное число сделок в одном направлении. |
| `MinProfit` | 160 | Минимальный прогнозируемый профит (в пунктах) для открытия новых ордеров. |
| `MaxLoss` | 130 | Предельный прогнозируемый убыток (в пунктах), при достижении которого позиция закрывается. |
| `TakeProfit` | 0 | Фиксированный тейк-профит в пунктах (0 — отключено). |
| `StopLoss` | 180 | Фиксированный стоп-лосс в пунктах (0 — отключено). |
| `TrailingStop` | 10 | Размер трейлинг-стопа в пунктах, работает только при `StopLoss > 0`. |
| `PastBars` | 200 | Длина истории для модели Бёрга. |
| `ModelOrder` | 0.37 | Доля `PastBars`, задающая порядок модели Бёрга. |
| `UseMomentum` | true | Использовать логарифмический моментум. |
| `UseRateOfChange` | false | Использовать процентное изменение (игнорируется, если активирован моментум). |

Все параметры оформлены как `StrategyParam<T>`, доступны для оптимизации и изменения в Designer.

## Особенности реализации
- Алгоритм Бёрга реализован напрямую на C# и повторяет логику MT4. Расчёты выполняются в `double`, а перед проверкой сигналов прогнозы переводятся в `decimal`.
- В MT4 объём рассчитывался из свободной маржи. В версии для StockSharp объём контролируется за счёт свойства `Volume` и параметра `MaxRisk`: базовый лот задаётся `Volume`, дальнейшие доливки масштабируются линейно.
- Защитные действия (стопы, трейлинг) реализованы через рыночные ордера, что соответствует высокоуровневому API и предотвращает зависание виртуальных заявок в тестах.
- При изменении `PastBars` или `ModelOrder` массивы и состояние модели пересоздаются, поэтому изменение параметров на лету немедленно влияет на расчёт прогнозов.
- Для визуального контроля стратегия автоматически рисует свечи и сделки; при необходимости легко добавить вывод прогноза на отдельную серию.
