# 2DLimits

## 概述
2DLimits 是 MetaTrader 4 智能交易系统 `2DLimits_EA_v2` 的直接移植版本。策略对最近两个已经完成的日线蜡烛进行评估，仅当它们呈现阶梯式结构（高点和低点同时抬升或下降）时才参与交易。一旦形态成立，就会在前一日的极值处挂入止损单，并使用日内中点作为止损、前一日区间作为止盈。

实现过程中结合了 StockSharp 的高级蜡烛订阅与一级行情。日线蜡烛提供突破位置，最新的买卖报价保证仅在价格低于中点时激活做多挂单、在价格高于中点时激活做空挂单。

## 策略逻辑
### 日线结构过滤
* 策略维护一个包含最近两根已完成日线的滑动窗口（可通过烛图类型参数调整）。
* **做多结构**：最新一日的最高点和最低点都高于再前一日。
* **做空结构**：最新一日的最高点和最低点都低于再前一日。
* 最新日线的中点按 `(高点 + 低点) / 2` 计算，同时记录日线区间用于设置止盈。

### 入场规则
* 同一时间只保留一组挂单；每当新的日线收盘都会取消并重新计算挂单。
* 做多挂单的条件：
  * 满足做多结构过滤条件。
  * 最新买价低于前一日的中点（对应原策略的 `Ask < middleY` 判断）。
  * 在前一日的最高价放置买入止损单。
* 做空挂单的条件：
  * 满足做空结构过滤条件。
  * 最新卖价高于前一日的中点（对应原策略的 `Bid > middleY` 判断）。
  * 在前一日的最低价放置卖出止损单。
* 如果多空结构均不成立，则当日不保留任何挂单。

### 出场规则
* 当某个方向的止损单被触发后，会立即取消另一方向的挂单，避免同时持有多空仓位。
* 做多突破成交后会注册两张保护单：
  * 在参考日的中点放置卖出止损单作为止损。
  * 在 `前一日高点 + 前一日区间` 放置卖出限价单作为止盈。
* 做空突破成交后采取对称保护：
  * 在参考日中点放置买入止损单作为止损。
  * 在 `前一日低点 - 前一日区间` 放置买入限价单作为止盈。
* 当持仓数量变化时会重新部署保护单，平仓后立即清除所有保护单。

### 挂单生命周期与安全控制
* 只有在下一根日线收盘后才会刷新挂单，确保每日最多一个交易计划。
* 持仓期间不再生成新的挂单，避免信号重叠。
* 通过 `SubscribeLevel1()` 保留最新买卖报价；若暂时无法获得，则回退使用最新成交价以避免盲目下单。
* 价格会按照品种的最小价位变动进行四舍五入，确保与交易所报价步长对齐。

## 参数
| 名称 | 说明 |
| --- | --- |
| `Volume` | 挂单使用的成交量，必须大于 0。 |
| `CandleType` | 用于计算参考区间的蜡烛类型（默认日线）。 |

## 其他说明
* 策略完全依赖高阶 API 管理订单，不使用自定义数据集合或指标缓存。
* 本包仅包含 C# 实现，本次转换不提供 Python 版本。
* 测试文件保持不变，未做任何修改。
