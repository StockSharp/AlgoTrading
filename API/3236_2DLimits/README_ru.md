# 2DLimits

## Обзор
2DLimits — это прямой порт советника MetaTrader 4 `2DLimits_EA_v2`. Стратегия анализирует две последние завершённые дневные свечи и входит в рынок только тогда, когда они образуют «ступеньку» (одновременное повышение или понижение максимумов и минимумов). При выполнении условий выставляются стоп-заявки на пробой экстремумов предыдущего дня, после исполнения позиция защищается стоп-лоссом по середине диапазона и тейк-профитом размером в диапазон прошлых суток.

Реализация использует высокоуровневые подписки на свечи StockSharp и поток котировок первого уровня. Дневные свечи задают уровни пробоя, а последние значения bid/ask гарантируют, что длинные заявки активируются только при цене ниже середины диапазона, а короткие — выше неё.

## Логика стратегии
### Фильтр дневной структуры
* Поддерживается скользящее окно из двух последних завершённых дневных свечей (тип свечи настраивается параметром).
* **Бычий сценарий** требует, чтобы у свежей свечи и максимум, и минимум были выше, чем у предыдущей.
* **Медвежий сценарий** требует одновременного снижения максимума и минимума относительно позавчерашней свечи.
* Средняя точка рассчитывается как `(high + low) / 2`, диапазон сохраняется для расчёта тейк-профита.

### Правила входа
* В каждый момент активна только одна группа заявок; при закрытии новой дневной свечи все заявки отменяются и пересчитываются.
* Условия для длинного входа:
  * Выполнен бычий фильтр структуры.
  * Актуальная цена ask ниже дневной середины (аналог условия `Ask < middleY`).
  * Выставляется стоп-заявка на покупку по максимуму предыдущего дня.
* Условия для короткого входа:
  * Выполнен медвежий фильтр структуры.
  * Текущий bid выше середины предыдущего дня (аналог условия `Bid > middleY`).
  * Выставляется стоп-заявка на продажу по минимуму предыдущего дня.
* Если фильтры не подтверждают ни один сценарий, заявки на следующий день не формируются.

### Правила выхода
* При срабатывании одной из стоп-заявок противоположная заявка немедленно отменяется — стратегия не удерживает разнонаправленных позиций.
* После исполнения длинного пробоя регистрируются две защитные заявки:
  * Стоп-заявка на продажу по дневной середине выполняет роль стоп-лосса.
  * Лимитная заявка на продажу по `максимум + диапазон` повторяет тейк-профит оригинального советника.
* Для короткого пробоя выполняются симметричные действия:
  * Стоп-заявка на покупку по середине диапазона фиксирует стоп-лосс.
  * Лимитная заявка на покупку по `минимум - диапазон` задаёт цель по прибыли.
* При изменении величины позиции защитные заявки переоткрываются, а после закрытия позиции удаляются.

### Жизненный цикл заявок и защитные проверки
* Обновление заявок происходит только после закрытия следующей дневной свечи, что ограничивает число сделок одним сценарием в сутки.
* Пока позиция открыта, новые сигналы не генерируются, исключая пересечение сценариев.
* Через `SubscribeLevel1()` сохраняется последняя пара bid/ask; при её отсутствии используется цена последней сделки как резервный вариант.
* Все цены округляются к шагу цены инструмента, чтобы соответствовать биржевым требованиям.

## Параметры
| Название | Описание |
| --- | --- |
| `Volume` | Объём заявок для входа по стопам (значение должно быть > 0). |
| `CandleType` | Тип свечей, из которых берётся опорный диапазон (по умолчанию дневные). |

## Дополнительные сведения
* Стратегия полностью управляет заявками через высокоуровневый API и не использует собственных коллекций данных или буферов индикаторов.
* В рамках конвертации создана только C#-версия; Python-реализация не добавлялась.
* Тестовые файлы не изменялись согласно запросу.
