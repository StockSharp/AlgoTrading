# Стратегия MA Envelopes

Конвертация советника MetaTrader 5 «MA Envelopes». Стратегия ищет откаты цены к скользящей средней, обрамлённой каналом Envelopes. Когда закрывшаяся свеча попадает между средней и границей канала в рамках торгового окна, на уровне средней выставляются лимитные заявки с защитными ордерами, рассчитанными от линий Envelopes.

## Логика работы

1. Рассчитывается скользящая средняя в соответствии с выбранным методом, источником цены и периодом, затем по отклонению строятся симметричные границы канала.
2. Если завершённая свеча закрылась выше средней, но ниже верхней границы, и текущая цена Ask остаётся выше средней, формируется каскад из лимитных заявок на покупку по цене средней.
   * Стоп-лосс размещается на нижней границе, а тейк-профит — на верхней границе с дополнительным сдвигом в пунктах.
   * Поддерживается до трёх независимых заявок с собственными значениями смещения (`First`, `Second`, `Third` SL/TP).
3. При обратных условиях (закрытие ниже средней, но выше нижней границы, Bid ниже средней) логика зеркально применима к лимитным продажам.
4. `StartHour` и `EndHour` задают торговый интервал. По окончании окна все неисполненные заявки отменяются.
5. Объём позиции рассчитывается исходя из `MaximumRisk`; `DecreaseFactor` уменьшает размер позиции после серии убыточных сделок. Итоговый объём подгоняется под шаг и ограничения инструмента.
6. После исполнения входной заявки немедленно выставляются защитные ордера стоп-лосс и тейк-профит. При срабатывании одного из них противоположный ордер отменяется; если позиция закрыта частично, для остатка выставляются новые защитные ордера.

## Параметры

| Параметр | Описание |
|----------|----------|
| `MaximumRisk` | Доля капитала, рискуемая в одной сделке. |
| `DecreaseFactor` | Коэффициент уменьшения объёма после серии убытков. |
| `First/Second/ThirdStopTakeProfitPips` | Дополнительные пункты к границам канала для трёх заявок. |
| `StartHour`, `EndHour` | Начало и конец торгового окна (по времени терминала, 0–23). |
| `MaPeriod`, `MaShift`, `MaMethodType`, `AppliedPrice` | Настройки скользящей средней. |
| `EnvelopeDeviation` | Ширина канала Envelopes в процентах. |
| `CandleType` | Таймфрейм обрабатываемых свечей. |

## Примечания

* При частичном закрытии позиции стратегия повторно создаёт защитные ордера для оставшегося объёма.
* В конце торгового окна удаляются только входные лимитные заявки; существующие позиции продолжают сопровождаться защитными ордерами.
* Для определения актуальных цен используется стакан котировок; при отсутствии данных применяется цена закрытия свечи.
