# Стратегия SVOS EURJPY D1

## Обзор
Стратегия представляет собой перевод советника **SVOS_EURJPY_D1** с MetaTrader 4 на C#. Работа ведётся по дневным свечам EURJPY.
Алгоритм сочетает классификацию рыночного режима, индикаторные фильтры и свечные модели. Индикатор Vertical Horizontal Filter
(VHF) разделяет трендовые и флетовые участки. В тренде используются сигналы гистограммы MACD (OSMA), во флете — осциллятор
Stochastic. Свечные модели (поглощения, «утренняя/вечерняя звезда») применяются для жёсткого закрытия позиции при неблагоприятной
реакции цены.

## Логика торговли
- **Определение режима** — значение VHF за предыдущий день сравнивается с параметром `VhfThreshold`. Превышение порога включает
  трендовую логику, иначе используется блок торговли во флете.
- **Подтверждение тренда** — сравниваются EMA с периодами 5 и 20 с медленной EMA (130 периодов, эквивалент полугодовой сглаживающей
  средне скользящей оригинального советника). При восходящем тренде объём покупок умножается на `RiskBoost`, при нисходящем — объём
  продаж.
- **Индикаторные фильтры**:
  - В тренде: длинный вход при положительном и растущем значении OSMA (`OSMA[1] > 0` и `OSMA[1] > OSMA[2]`), короткий — при
    отрицательном и убывающем значении.
  - Во флете: длинный вход при пересечении основной линии Stochastic выше сигнальной, короткий — при обратном пересечении.
  - **Контроль волатильности**: стандартное отклонение за прошлый бар должно превышать `StdDevMinimum` перед открытием новых сделок.
- **Фильтр по свечам** — последняя завершённая свеча не должна быть доджи (`DojiDivisor`) и должна подтверждать направление
  (бычья для лонга, медвежья для шорта). Противоположные поглощения или фигуры утренней/вечерней звезды немедленно закрывают
  позицию соответствующего направления.
- **Ограничение позиций** — общее количество открытых ордеров ограничивается `MaxTrendOrders` в тренде и `MaxRangeOrders` во флете.
- **Управление рисками** — каждому ордеру назначаются фиксированные стоп-лосс и тейк-профит (`StopLossPips`, `TakeProfitPips`).
  Трейлинг-стоп (`TrailingStopPips`) активируется при достижении заданной прибыли и пересчитывается по экстремумам свечи, что
  повторяет логику MetaTrader.

## Используемые индикаторы
- **Экспоненциальные средние (5, 20, 130)** — подтверждение направления и масштабирование объёма.
- **Vertical Horizontal Filter** — кастомный индикатор, оценивающий отношение направленного движения к сумме приращений закрытия,
  позволяющий отделить тренд от боковика.
- **MACD (OSMA)** — разница между линиями MACD и сигнальной формирует трендовые сигналы.
- **Stochastic Oscillator** — линии %K/%D дают точки входа в диапазоне.
- **Standard Deviation** — фильтр минимальной волатильности перед открытием позиций.

## Управление позициями
- Сделки исполняются через `BuyMarket`/`SellMarket`. Каждая запись хранится в списках, что позволяет имитировать индивидуальные
  стопы и тейки в неттинговой модели StockSharp.
- При достижении стоп-уровня или тейка внутри диапазона свечи соответствующая часть позиции закрывается рыночным ордером.
- Трейлинг-стоп следует за максимумом (для лонга) или минимумом (для шорта), сохраняя заданную дистанцию.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `LotSize` | Базовый объём ордера в лотах. | `0.1` |
| `RiskBoost` | Множитель объёма при подтверждённом тренде. | `3` |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | `350` |
| `StopLossPips` | Дистанция стоп-лосса в пунктах. | `90` |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах (всегда активен). | `150` |
| `StochKPeriod` | Период %K осциллятора Stochastic. | `8` |
| `StochDPeriod` | Период %D осциллятора Stochastic. | `3` |
| `StochSlowing` | Сглаживание линии %K. | `3` |
| `StdDevPeriod` | Окно расчёта стандартного отклонения. | `20` |
| `StdDevMinimum` | Минимальное стандартное отклонение для открытия сделок. | `0.3` |
| `VhfPeriod` | Период Vertical Horizontal Filter. | `20` |
| `VhfThreshold` | Порог разделения тренда и флета. | `0.4` |
| `MaxTrendOrders` | Максимум одновременных ордеров в тренде. | `4` |
| `MaxRangeOrders` | Максимум одновременных ордеров во флете. | `2` |
| `MacdFastLength` | Быстрая EMA в MACD. | `10` |
| `MacdSlowLength` | Медленная EMA в MACD. | `25` |
| `MacdSignalLength` | Сигнальная EMA MACD. | `5` |
| `DojiDivisor` | Делитель для определения свечи-доджи. | `8.5` |
| `CandleType` | Таймфрейм свечей (по умолчанию день). | `1 день` |
| `PipSizeOverride` | При необходимости вручную задаёт размер пункта (`0` — автоопределение по `PriceStep`). | `0` |

## Особенности реализации
- В оригинале использовалась EMA по месячному таймфрейму (6 месяцев). В порте применена EMA(130) по дневным закрытиям — это даёт
  сопоставимое сглаживание без отдельной подписки на месячные свечи.
- Из-за неттинга в StockSharp стопы, тейки и трейлинг реализованы внутри стратегии: каждая сделка хранится и обслуживается
  отдельно, что повторяет механику MetaTrader.
- Трейлинг обновляется по максимуму/минимуму свечи, поэтому результаты могут отличаться от тикового трейлинга оригинала при
  резких внутридневных разворотах.
- Размер пункта рассчитывается по `Security.PriceStep`. Если у брокера нестандартный шаг, используйте `PipSizeOverride`.

## Рекомендации по запуску
1. Подключите стратегию к данным EURJPY с дневным таймфреймом либо измените `CandleType` при использовании другого интервала.
2. Проверьте корректность определения пункта и при необходимости задайте `PipSizeOverride` вручную.
3. Настройте параметры управления капиталом (`LotSize`, `RiskBoost`) под требования счёта.
4. Протестируйте стратегию в StockSharp Designer или Runner перед запуском на реальном счёте.
