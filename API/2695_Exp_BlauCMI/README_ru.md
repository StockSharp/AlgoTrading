# Exp BlauCMI

## Обзор
Стратегия воспроизводит советник MetaTrader 5 **Exp_BlauCMI** на высокоуровневом API StockSharp. Индикатор Blau Candle Momentum Index (CMI) представляет собой отношение тройного сглаженного момента к его абсолютному значению. Расчёт выполняется по выбранным свечам. Покупки открываются, когда осциллятор разворачивается вверх после нисходящего движения, продажи — при развороте вниз. Все заявки отправляются только после закрытия свечей, что полностью повторяет логику оригинального эксперта.

## Логика индикатора
1. Через параметры `Momentum Price` и `Reference Price` задаются два ценовых ряда. Сырой момент вычисляется как разница между текущим значением первой цены и отложенным значением второй цены. Глубина смещения задаётся параметром `Momentum Depth`.
2. Момент и его абсолютное значение проходят через три последовательных сглаживания (`First/Second/Third Smoothing`). Для всех этапов используется один и тот же тип среднего: простое, экспоненциальное, сглаженное (RMA) или линейно-взвешенное.
3. Blau CMI равен `100 * smoothedMomentum / smoothedAbsMomentum`. Индикатор начинает выдавать сигналы, когда третье сглаживание накопит достаточно баров.
4. Параметр `Signal Shift` определяет, сколько закрытых свечей назад анализируется разворот (значение 1 соответствует оригинальному советнику и использует последнюю закрытую свечу).

## Торговые правила
- **Вход в лонг** — допускается при включённом флаге `Allow Long Entry`, если выполняется последовательность `Value[Signal Shift - 1] < Value[Signal Shift - 2]` и `Value[Signal Shift] > Value[Signal Shift - 1]`, то есть осциллятор развернулся вверх. При наличии короткой позиции она сначала закрывается, если разрешён `Allow Short Exit`.
- **Вход в шорт** — допускается при включённом `Allow Short Entry`, когда индикатор разворачивается вниз (`Value[Signal Shift - 1] > Value[Signal Shift - 2]` и `Value[Signal Shift] < Value[Signal Shift - 1]`). При наличии длинной позиции она закрывается, если включён `Allow Long Exit`.
- **Выход из лонга** — при появлении условия для короткого входа позиция закрывается, если разрешён `Allow Long Exit`.
- **Выход из шорта** — при появлении условия для длинного входа позиция закрывается, если разрешён `Allow Short Exit`.
- Все сделки выполняются рыночными ордерами объёмом `Order Volume`. К каждой позиции автоматически привязываются стоп-лосс и тейк-профит через `StartProtection` и действуют до закрытия позиции.

## Параметры
- `Candle Type` — тип свечей (таймфрейм и т.п.), используемый для расчёта и сигналов. По умолчанию 4-часовые свечи.
- `Smoothing Method` — общий метод усреднения для всех трёх этапов (Simple, Exponential, Smoothed, Linear Weighted).
- `Momentum Depth` — число баров между сравниваемыми ценами в исходном моменте.
- `First/Second/Third Smoothing` — длины трёх этапов сглаживания момента и его абсолютного значения.
- `Signal Shift` — количество закрытых свечей, на которых оценивается разворот (минимум 1).
- `Momentum Price` — применяемая цена для «передней» части момента.
- `Reference Price` — цена для отложенной части момента.
- `Allow Long Entry`, `Allow Short Entry` — разрешение на открытие позиций в соответствующем направлении.
- `Allow Long Exit`, `Allow Short Exit` — разрешение на закрытие позиций по противоположным сигналам.
- `Stop-Loss Points`, `Take-Profit Points` — расстояние до защитных ордеров в шагах цены (`Security.PriceStep`). Значение 0 отключает соответствующий ордер.
- `Order Volume` — объём рыночных заявок. Значение также присваивается свойству `Strategy.Volume`.

## Дополнительные замечания
- Поддерживаются четыре типа сглаживания, которые реализованы стандартными индикаторами StockSharp: SMA, EMA, RMA (Smoothed) и WMA.
- Константа цены Demark повторяет реализацию MT5: сначала усредняются экстремумы и закрытие свечи, затем вычисляются расстояния до high/low.
- Расчёты выполняются только по завершённым свечам, поэтому стратегия реагирует один раз на бар и соответствует логике `IsNewBar` в оригинале.
- Параметры `Stop-Loss Points` и `Take-Profit Points` трактуются как количество шагов цены, что полностью совместимо с точечными значениями MQL5.
