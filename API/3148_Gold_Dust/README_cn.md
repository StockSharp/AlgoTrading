# Gold Dust 策略

## 概述

Gold Dust 策略在 StockSharp 框架中重现了 MetaTrader 5 顾问程序 “Gold Dust”。策略通过线性加权移动平均线（LWMA）构建一到两个感知器，输入价格使用加权价（高+低+2×收盘）。每个感知器比较价格与均线在四个按周期等距的时间点之间的差值。当感知器结果为正时开空，为负时开多，与原版 EA 完全一致。本移植版依赖 StockSharp 的高层烛线订阅接口，不需要手动管理指标缓存。

## 信号生成

1. 订阅参数 `CandleType` 指定的烛线并计算周期为 `MaPeriod` 的 `WeightedMovingAverage`。
2. 每根收盘烛线记录其开盘价、收盘价及对应的 LWMA 值，始终保留三个完整周期的历史，模拟原版 `CopyRates` 与 `CopyBuffer` 的行为。
3. 计算与均线的偏差：
   - `a1`：当前收盘价减去当前 LWMA；
   - `a2`：一个周期前的开盘价减去当时的 LWMA；
   - `a3`：两个周期前的开盘价减去当时的 LWMA；
   - `a4`：三个周期前的开盘价减去当时的 LWMA。
4. 对应感知器按照 `result = Σ(wi × ai)` 计算输出，每个权重等于原始参数（例如 `X11`）减去 100，这与 MQL 版本中的 `w = x - 100` 完全一致。
5. 根据 `PassMode` 决定如何解释感知器结果：
   - `1` – 只使用第一组权重；
   - `2` – 只使用第二组权重；
   - `3` – 只有当两组同时给出相同的非零符号时才生成信号。
6. 结果为负时建立或维持多头，结果为正时建立或维持空头，结果为零时视作无共识并尝试在有浮盈时平仓。

## 仓位管理

- **入场**：策略使用固定的 `TradeVolume`。开多之前若存在空头，将先以相同数量买入对冲；开空时也采取同样处理，从而保证同一时间只有一个方向的仓位。
- **止损**：`StopLossPips` 会根据 `Security.PriceStep` 换算成绝对价格距离。若标的报价保留 3 或 5 位小数，会额外乘以 10，以还原原始 EA 的 “adjusted point” 逻辑。止损在每根完成的烛线上检查，一旦烛线最低价（多头）或最高价（空头）触碰到止损价位，就用市价单离场。
- **移动止损**：当 `TrailingStopPips` 大于零时启用。价格向有利方向移动超过 `TrailingStopPips + TrailingStepPips` 后，止损将被推进到 `收盘价 ± TrailingStopPips`。即便初始止损为零也会创建移动止损，与 EA 中的 `PositionModify` 相同。移动止损在烛线收盘时更新。
- **盈利退出**：当两个感知器均给出零信号时，策略只会在浮动收益为正的情况下主动平仓，对应原版 `CloseProfitPositions` 中 “盈利+掉期+佣金 > 0” 的判定。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `TradeVolume` | `1` | 新建仓位的基本手数，反向信号会先平掉已有仓位再开新单。 |
| `StopLossPips` | `150` | 初始止损距离（调整后的点）。设为 0 可关闭初始止损。 |
| `TrailingStopPips` | `25` | 移动止损距离（调整后的点）。设为 0 可关闭移动止损。 |
| `TrailingStepPips` | `5` | 移动止损推进前需要的额外获利距离。 |
| `MaPeriod` | `20` | 加权移动平均线周期。 |
| `CandleType` | `H1` | 计算所用的烛线类型，可根据数据源支持的周期修改。 |
| `PassMode` | `1` | 决定使用哪组感知器：1 – 第一组；2 – 第二组；3 – 两组都同意时才行动。 |
| `X11`, `X21`, `X31`, `X41` | `100` | 感知器 #1 的原始权重值，实际使用前会自动减去 100。 |
| `X12`, `X22`, `X32`, `X42` | `100` | 感知器 #2 的原始权重值，处理方式与第一组相同。 |

## 移植说明

- 原 EA 在每个 Tick 上调整止损；StockSharp 版本在烛线收盘时执行同样的逻辑，以保持在高层 API 内实现。
- `CMoneyFixedMargin` 资金管理被固定手数 `TradeVolume` 所取代，如需风险模型可在外部包装。
- 感知器计算使用有限长度的列表缓存烛线和指标值，无需调用 `CopyBuffer`。
- 点值换算遵循 MetaTrader 的 “adjusted point” 规则，对三位或五位报价自动乘以 10。

## 使用建议

1. 在终端中选择交易品种并设置与原 MT5 图表一致的 `CandleType`。 
2. 将感知器权重 `X**` 与 `PassMode` 调整为在 MetaTrader 中优化得到的组合，也可以在 StockSharp 内继续优化。
3. 根据经纪商最小手数及步长设定 `TradeVolume`。策略在反手时会自动加上已有反向仓位的绝对值。
4. 关注日志输出，移动止损调整和止损触发都会写入日志，方便对照原始 EA 的行为。

