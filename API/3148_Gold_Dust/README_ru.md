# Стратегия Gold Dust

## Общее описание

Стратегия Gold Dust переносит советник MetaTrader 5 «Gold Dust» в инфраструктуру StockSharp. Алгоритм использует одну или две нейросетевые «ячейки» (персептроны), построенные на линейной взвешенной средней (LWMA), рассчитанной по взвешенной цене свечи. Каждый персептрон измеряет отклонение цены от средней в четырёх точках, разделённых длиной скользящей. Положительный результат вызывает открытие короткой позиции, отрицательный — длинной. Перенос сохраняет логику оригинала и использует высокоуровневые подписки на свечи.

## Формирование сигналов

1. Подписаться на свечи типа `CandleType` и вычислять `WeightedMovingAverage` с периодом `MaPeriod`.
2. На каждой завершённой свече сохранять открытие, закрытие и значение LWMA; история ограничена тремя полными периодами, что повторяет работу `CopyRates`/`CopyBuffer` в MQL.
3. Рассчитать отклонения цены от средней:
   - `a1` — текущее закрытие минус текущая LWMA;
   - `a2` — открытие свечи «минус один период» минус LWMA на той же свече;
   - `a3` — открытие «минус два периода» минус LWMA;
   - `a4` — открытие «минус три периода» минус LWMA.
4. Вычислить персептрон `result = Σ(wi × ai)`, где каждый вес равен исходному параметру (`X11` и т.д.) минус 100 — аналог выражения `w = x - 100` в советнике.
5. Интерпретировать результат согласно `PassMode`:
   - `1` — использовать только первую группу весов;
   - `2` — использовать только вторую группу весов;
   - `3` — торговать лишь при одинаковых ненулевых знаках обоих персептронов.
6. Отрицательный знак открывает/удерживает длинную позицию, положительный — короткую, нулевой — даёт команду зафиксировать прибыльные позиции.

## Управление позицией

- **Входы**. Торговый объём фиксируется параметром `TradeVolume`. Перед сменой направления стратегия закрывает встречную позицию, тем самым в рынке остаётся только одна сделка, как и в оригинале (`m_need_open_buy` / `m_need_open_sell`).
- **Стоп-лосс**. Параметр `StopLossPips` переводится в абсолютную цену через `Security.PriceStep`. Для инструментов с трёх- и пятизначными котировками применяется множитель 10, чтобы повторить «adjusted point». На каждой закрытой свече проверяется, пробила ли низ (для лонга) или верх (для шорта) уровень стопа; при срабатывании позиция закрывается рыночным приказом.
- **Трейлинг**. Если `TrailingStopPips > 0`, включается свечной трейлинг. После движения на `TrailingStopPips + TrailingStepPips` стоп переносится к `Close ± TrailingStopPips`. Трейлинг создаёт стоп даже при отсутствии исходного стоп-лосса, как и `PositionModify` в MQL.
- **Фиксация прибыли**. При нулевом сигнале стратегия закрывает позицию только при положительной плавающей прибыли, что соответствует условию `Commission + Swap + Profit > 0` в функции `CloseProfitPositions`.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TradeVolume` | `1` | Базовый объём новой позиции; при смене направления добавляется величина противоположной позиции. |
| `StopLossPips` | `150` | Начальный стоп-лосс в «пунктах» (учитывает множитель для 3/5 знаков). Ноль отключает стоп. |
| `TrailingStopPips` | `25` | Дистанция трейлинг-стопа в тех же пунктах. Ноль отключает трейлинг. |
| `TrailingStepPips` | `5` | Минимальное дополнительное движение до переноса трейлинга. |
| `MaPeriod` | `20` | Период LWMA, участвующей в расчёте персептронов. |
| `CandleType` | `H1` | Таймфрейм свечей; можно выбирать другой, если он поддерживается источником данных. |
| `PassMode` | `1` | Режим работы: 1 — первый персептрон; 2 — второй; 3 — требуется согласие обоих. |
| `X11`, `X21`, `X31`, `X41` | `100` | Исходные веса персептрона №1 (до вычитания 100). |
| `X12`, `X22`, `X32`, `X42` | `100` | Исходные веса персептрона №2. |

## Особенности переноса

- В оригинале стопы обновлялись на каждом тике; в портированной версии это происходит при закрытии свечи, что позволяет обойтись высокоуровневым API.
- Блок `CMoneyFixedMargin` заменён фиксированным параметром `TradeVolume`; при необходимости можно добавить собственный риск-менеджер.
- Для повторения `CopyBuffer` используется ограниченный буфер значений цены и LWMA, без обращения к индикатору через `GetValue`.
- Преобразование пунктов строго повторяет MetaTrader: при трёх- и пятизначных котировках шаг умножается на 10.

## Практические рекомендации

1. Выберите инструмент и установите `CandleType`, соответствующий таймфрейму, на котором использовался советник в MT5.
2. Перенесите оптимальные значения весов `X**` и параметр `PassMode` из MetaTrader или проведите оптимизацию средствами StockSharp.
3. Подберите `TradeVolume` так, чтобы он удовлетворял ограничениям брокера (минимальный лот, шаг объёма); стратегия автоматически добавит объём противоположной позиции при развороте.
4. Следите за журналом: перенос трейлинга и срабатывание стопов сопровождаются информационными сообщениями, что упрощает проверку соответствия оригиналу.

