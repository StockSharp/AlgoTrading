# Стратегия Absorption

Стратегия повторяет работу советника Absorption для MetaTrader. Алгоритм ищет свечи-поглощения, которые перекрывают диапазон предыдущей свечи и одновременно формируют локальный экстремум в пределах короткой истории. Как только найден подходящий бар, выставляется пара встречных стоп-заявок и далее позиция сопровождается фиксированной целью, переводом в безубыток и трейлинг-стопом.

## Логика торговли

1. **Поиск паттерна**
   - Анализируются две последние завершённые свечи.
   - Свеча считается *поглощением*, если её максимум выше максимума предыдущей свечи, а минимум ниже предыдущего минимума.
   - Дополнительно проверяется, что максимум или минимум этой свечи является экстремумом среди последних `MaxSearch` баров.
   - Приоритет отдаётся более старой свече (две свечи назад). Если условия выполняют обе свечи, используется старшая; иначе допускается сигнал по последней свече.
2. **Выставление ордеров**
   - Бай-стоп размещается на уровне максимума свечи плюс заданный `Indent`.
   - Селл-стоп размещается на уровне минимума свечи минус тот же `Indent`.
   - Оба ордера используют общий объём стратегии.
   - Для каждой отложенной заявки сохраняются уровни стопа и, при необходимости, тейк-профита. Если ордера не активированы, они отменяются через `OrderExpirationHours` часов.
3. **Сопровождение позиции**
   - При исполнении одной заявки противоположная отменяется.
   - Начальный стоп ставится за противоположной границей свечи-поглощения с учётом отступа.
   - Фиксированный тейк-профит закрывает сделку после достижения заданного расстояния в шагах цены.
   - Модуль безубытка переносит стоп на `Entry + Breakeven` (лонг) или `Entry - Breakeven` (шорт) после набора прибыли в `BreakevenProfit` шагов.
   - Трейлинг-стоп удерживает стоп-лосс на расстоянии `TrailingStop` от лучшей цены и срабатывает только после движения минимум на `TrailingStep` шагов в прибыльную сторону.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип используемых свечей (по умолчанию часовые). |
| `MaxSearch` | Количество недавних свечей для подтверждения экстремумов. |
| `TakeProfitBuy` | Дистанция тейк-профита для лонга в шагах цены. `0` отключает цель. |
| `TakeProfitSell` | Дистанция тейк-профита для шорта в шагах цены. `0` отключает цель. |
| `TrailingStop` | Размер трейлинг-стопа в шагах. `0` отключает сопровождение. |
| `TrailingStep` | Минимальное продвижение для обновления трейлинг-стопа. Должно быть положительным при включённом трейлинге. |
| `Indent` | Отступ в шагах цены от экстремумов свечи для постановки стоп-заявок. |
| `OrderExpirationHours` | Срок действия отложенных ордеров. По истечении этого времени они отменяются. |
| `Breakeven` | Отступ стоп-лосса после перевода в безубыток. `0` отключает модуль. |
| `BreakevenProfit` | Прибыль в шагах цены, необходимая для активации перевода в безубыток. |

Все расстояния задаются в шагах цены инструмента. Базовый объём стратегии установлен на `0.1`.

## Управление рисками

Выходы из позиции выполняются рыночными ордерами. Правила стоп-лосса, тейк-профита, безубытка и трейлинг-стопа отслеживают максимумы и минимумы свечей, чтобы фиксировать внутридневные касания уровней. После отправки ордера на выход новые заявки не формируются до тех пор, пока позиция не станет нулевой.
