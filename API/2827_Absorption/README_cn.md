# Absorption 策略

该策略重现 MetaTrader 平台上的 Absorption 专家顾问。算法寻找吞没前一根 K 线并在近期区间内创出极值的 "吸收" K 线。一旦发现符合条件的 K 线，策略会在其上下放置两条止损挂单，并通过固定目标、保本移动和移动止损来管理仓位。

## 交易逻辑

1. **识别形态**
   - 检查最近两根已完成的 K 线。
   - 当当前 K 线的最高点高于上一根 K 线的最高点且最低点低于上一根 K 线的最低点时，将其视为 *吸收 K 线*。
   - 进一步确认该 K 线的最高点或最低点是过去 `MaxSearch` 根 K 线中的极值。
   - 优先使用较老的 K 线（倒数第二根）。如果两根 K 线都满足条件，则使用较老的那根，否则允许使用最近的一根触发信号。
2. **挂单布置**
   - 在吸收 K 线的最高点上方 `Indent` 个价格步长处放置买入止损单。
   - 在吸收 K 线的最低点下方 `Indent` 个价格步长处放置卖出止损单。
   - 两个挂单都使用统一的策略手数。
   - 每个挂单保存自己的止损位置以及可选的止盈目标。如果在 `OrderExpirationHours` 小时内未触发，挂单会被自动取消。
3. **仓位管理**
   - 当一侧挂单成交时，另一侧挂单被取消。
   - 初始止损位于吸收 K 线的另一侧边界并加上/减去设定的 `Indent`。
   - 可选的固定止盈在价格达到指定的步长距离后平仓。
   - 保本模块在价格向有利方向移动 `BreakevenProfit` 个步长后，将止损移动到 `Entry + Breakeven`（多头）或 `Entry - Breakeven`（空头）。
   - 移动止损保持止损与最佳价格之间 `TrailingStop` 个步长的距离，仅在价格至少向盈利方向移动 `TrailingStep` 个步长时才更新。

## 参数

| 参数 | 说明 |
|------|------|
| `CandleType` | 使用的 K 线类型（默认 1 小时）。 |
| `MaxSearch` | 用于确认极值的最近 K 线数量。 |
| `TakeProfitBuy` | 多头止盈距离（价格步长）。`0` 表示关闭止盈。 |
| `TakeProfitSell` | 空头止盈距离（价格步长）。`0` 表示关闭止盈。 |
| `TrailingStop` | 移动止损距离（价格步长）。`0` 表示关闭移动止损。 |
| `TrailingStep` | 更新移动止损所需的最小盈利位移，启用移动止损时必须为正。 |
| `Indent` | 在吸收 K 线上下放置挂单的价格步长偏移。 |
| `OrderExpirationHours` | 挂单有效期（小时）。超过该时间未成交的挂单会被取消。 |
| `Breakeven` | 触发保本后止损相对入场价的偏移量。`0` 表示关闭保本。 |
| `BreakevenProfit` | 启动保本所需的盈利距离（价格步长）。 |

所有距离类参数均以品种的价格步长为单位。默认下单手数设为 `0.1`。

## 风险控制

策略使用市价单离场。止损、止盈、保本与移动止损逻辑会监控每根 K 线的最高价和最低价，以捕捉盘中触及预设水平的情况。一旦发送离场委托，在仓位归零之前不会再重复提交新的离场单。
