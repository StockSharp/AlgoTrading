# Стратегия Divergence Trader

## Общее описание
Данная стратегия представляет собой портирование эксперта MetaTrader "Divergence Trader" на платформу StockSharp. Алгоритм
сравнивает две простые скользящие средние, рассчитанные по настраиваемым ценовым источникам, и анализирует величину их
расхождения. Когда дистанция между быстрой и медленной средними попадает в заданный нейтральный коридор, стратегия ожидает
возобновления импульса и открывает позицию в направлении текущего преобладающего движения. Обработка ведётся только по
завершённым свечам выбранного таймфрейма с использованием высокоуровневого API и привязок индикаторов.

## Параметры
- **Lot Size** – объём сделки при открытии позиции. Значение автоматически приводится к шагу объёма инструмента.
- **Fast SMA Period / Price** – период и тип цены для быстрой простой скользящей средней.
- **Slow SMA Period / Price** – период и тип цены для медленной простой скользящей средней.
- **Buy Threshold** – минимальное положительное расхождение, необходимое для открытия длинной позиции.
- **Stay-Out Threshold** – максимальное допустимое расхождение; значения вне диапазона блокируют новые сделки.
- **Take Profit (pips)** – целевой профит в пунктах. Ноль отключает функцию.
- **Stop Loss (pips)** – допустимый убыток в пунктах. Ноль отключает функцию.
- **Trailing Stop (pips)** – расстояние трейлинг-стопа, активируемого после выхода позиции в прибыль.
- **Break-Even Trigger / Buffer (pips)** – прирост в пунктах для перевода сделки в безубыток и дополнительный буфер,
  позволяющий сместить уровень безубытка от цены входа.
- **Basket Profit / Basket Loss** – пороги по доходности счёта, при достижении которых закрываются все позиции. Контроль по
  убытку по умолчанию отключён.
- **Start Hour / Stop Hour** – торговое окно в локальном времени. При равных значениях стратегия работает круглосуточно.
- **Candle Type** – таймфрейм, используемый для сигналов и управления позицией.

## Логика торговли
1. Подписаться на свечи выбранного таймфрейма и вычислять значения двух простых скользящих средних.
2. Работать только с закрытыми свечами, чтобы избежать внутрисвечного шума и сохранить поведение оригинального советника.
3. Отслеживать расхождение (разницу между быстрой и медленной средней) на предыдущей закрытой свече:
   - Если расхождение положительное и лежит между **Buy Threshold** и **Stay-Out Threshold**, отправить рыночную заявку на покупку.
   - Если расхождение отрицательное и его модуль остаётся в пределах коридора, отправить рыночную заявку на продажу.
4. Сделки игнорируются вне торговых часов или при наличии открытой позиции.

## Управление позицией
- **Контроль безубытка** – при достижении заданного профита сохраняется уровень безубытка (при необходимости смещённый буфером).
  Свеча, коснувшаяся уровня, закрывает позицию.
- **Трейлинг-стоп** – когда прибыль превышает расстояние трейлинга, стоп сопровождает цену, оставаясь на заданном числе пунктов
  позади неё.
- **Take profit / stop loss** – фиксированные уровни, рассчитываемые от цены входа в пунктах.
- **Защита портфеля** – текущая стоимость портфеля сравнивается с заданными порогами прибыли и убытка. При срабатывании любого
  из порогов позиция закрывается, а активные заявки отменяются, что повторяет логику функции `CloseEverything` в MQL.

## Рекомендации по использованию
- Коридор расхождения симметричен: увеличение **Stay-Out Threshold** позволяет дольше удерживать сделки, уменьшение – повышает
  частоту сигналов.
- Типы цен соответствуют значениям `CandlePrice` в StockSharp, поэтому доступны цена открытия, закрытия, медианная, типичная и
  другие варианты, аналогичные MetaTrader.
- На диаграмме выводятся свечи, обе скользящие средние и исполненные сделки для наглядного контроля.
- Функции управления капиталом зависят от данных портфеля. В тестовой среде без статистики по счёту корзинные ограничения будут
  автоматически игнорироваться.
