# Стратегия PSAR Multi Timeframe

## Общее описание
Стратегия повторяет логику советника MetaTrader **EA_PSar_002B**. Она рассчитывает значения Parabolic SAR на трёх таймфреймах (M15, M30 и H1), а управление позицией ведёт по минутным свечам. Одновременно может быть открыта только одна совокупная позиция; новые сделки допускаются лишь после закрытия предыдущей. Изначально алгоритм создавался под EURUSD и минутный график, что сохранено и в порте.

## Логика торговли
1. **Фильтр сходимости SAR.** Текущие значения индикатора на M15, M30 и H1 должны находиться в диапазоне 19 минимальных ценовых шагов друг от друга. Это условие «сжимает» три кривые перед пробоем.
2. **Вход в покупку** возможен при выполнении одного из сценариев:
   - SAR на M15, M30 и H1 лежат ниже текущих минимумов, при этом предыдущий H1-SAR был выше максимума предыдущей H1-свечи, а новый H1-SAR опускается ниже текущего минимума.
   - SAR на M15 и H1 ниже текущих минимумов, предыдущий SAR на M30 был выше предыдущего максимума, а новый M30-SAR опускается ниже текущего минимума.
   - SAR на M30 и H1 ниже текущих минимумов, предыдущий SAR на M15 был выше предыдущего максимума, а новый M15-SAR опускается ниже текущего минимума.
3. **Вход в продажу** строится зеркально: сравнения с минимумами заменяются на максимумы и наоборот.
4. **Фиксация прибыли и убытков.** Тейк-профит и стоп-лосс задаются в поинтах (минимальных шагах цены). По умолчанию это 999 и 399 поинтов, что соответствует значениям из MQL после нормализации 4/5-значных котировок.
5. **Динамический выход.** После открытия позиции контролируется SAR на M30.
   - Лонг закрывается, если предыдущий SAR находился ниже минимума предыдущей минутной свечи, а текущий SAR перепрыгнул выше максимума текущей M1-свечи.
   - Шорт закрывается, если предыдущий SAR был выше предыдущего максимума, а текущий SAR провалился ниже текущего минимума.
   - Если текущий SAR на M30 выходит за цену входа, стоп подтягивается к уровню SAR.

## Управление капиталом
Параметр `UseMoneyManagement` полностью повторяет переключатель из исходного советника. При отключении торгуется фиксированный объём (`FixedVolume`). При включении вычисляется синтетический размер лота: доля свободного капитала (`PercentMoneyManagement`) делится на 100 000, затем результат приводится к `Security.VolumeStep` и ограничивается диапазоном `VolumeMin`/`VolumeMax` инструмента.

## Параметры
- `BaseCandleType` — таймфрейм, по которому обрабатываются сделки (по умолчанию M1).
- `FastSarCandleType`, `MediumSarCandleType`, `SlowSarCandleType` — таймфреймы индикаторов SAR (по умолчанию 15, 30 и 60 минут).
- `EnableParabolicFilter` — аналог флага `sar2`. Выключение полностью останавливает торговлю.
- `TakeProfitPoints`, `StopLossPoints` — отступы в поинтах. Размер пункта вычисляется автоматически через `Security.PriceStep` и `Security.Decimals`, поэтому корректно обрабатываются 3- и 5-значные форекс-котировки.
- `UseMoneyManagement`, `PercentMoneyManagement`, `FixedVolume` — блок настроек объёма.

## Особенности переноса
- Используется только высокоуровневый API StockSharp. Все временные ряды подключаются через `SubscribeCandles().Bind(...)`, а значения индикаторов приходят в обработчики напрямую, без собственных буферов.
- Защитные приказы реализованы рыночными закрытиями, как и в MQL-версии, где применялся `OrderClose`.
- Коэффициент «цифровки» брокера из MetaTrader заменён автоматическим расчётом пункта (`PriceStep` × 10 для 3/5-значных инструментов).
- В оригинале при запуске на другом символе/таймфрейме выводилось сообщение в `Comment()`. В S# ограничение описано в документации и не блокирует запуск программно.

## Рекомендации по использованию
1. Подключайте стратегию к EURUSD с минутными свечами как основному потоку. Таймфреймы индикаторов при необходимости можно менять.
2. Убедитесь, что инструмент содержит `PriceStep` и `Decimals`. Без них стратегия использует размер шага 1, что приведёт к неверным стопам.
3. Не отключайте `EnableParabolicFilter`, если требуется активная торговля — это главный переключатель алгоритма.
