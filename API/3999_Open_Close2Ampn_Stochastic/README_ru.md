# Стратегия Open Close2 Ampn Stochastic

## Общее описание
- Порт советника MetaTrader 4 *open_close2ampnstochastic_strategy*, реализованный на высокоуровневом API StockSharp.
- Использует стохастический осциллятор с периодом 9 и сглаживанием %K/%D = 3 в сочетании с фильтром по двум последним свечам: перед открытием позиции новая свеча должна подтвердить направление предыдущей.
- По умолчанию работает с часовыми свечами; параметр `CandleType` позволяет переключиться на любой другой доступный таймфрейм.

## Логика сигналов
1. **Открытие позиции** – стратегия удерживает только одну позицию. Пока позиция равна нулю, анализируется последняя завершённая свеча:
   - **Покупка**: основная линия стохастика выше сигнальной, а открытие и закрытие текущей свечи ниже соответствующих значений предыдущей свечи.
   - **Продажа**: основная линия стохастика ниже сигнальной, а открытие и закрытие текущей свечи выше значений предыдущей свечи.
2. **Закрытие позиции** – зеркальные условия относительно открытий:
   - **Закрытие длинной**: основная линия опускается ниже сигнальной, новая свеча имеет более высокие цену открытия и закрытия.
   - **Закрытие короткой**: основная линия поднимается выше сигнальной, новая свеча показывает более низкие цены открытия и закрытия.
3. **Аварийная защита** – повторяет условие `AccountProfit` из оригинала. Если модуль плавающего убытка (сумма реализованного PnL и оценки по текущей свече) превышает `MaximumRisk × AccountMargin`, стратегия немедленно закрывает позицию. В StockSharp отсутствует прямой эквивалент `AccountMargin`, поэтому используется `Portfolio.BlockedValue`, а при его отсутствии – `Portfolio.CurrentValue`.

## Управление капиталом
- **BaseVolume** соответствует параметру `Lots` в MQL и применяется, когда информация о портфеле недоступна.
- При наличии оценки капитала объём рассчитывается как `Portfolio.CurrentValue × MaximumRisk / 1000`, что воспроизводит логику `AccountFreeMargin` из MT4.
- После каждой убыточной сделки следующий объём сокращается на долю `losses / DecreaseFactor`. После прибыльной сделки счётчик серии обнуляется. Итоговый объём не опускается ниже `MinimumVolume` (по умолчанию 0.1 лота).
- Перед выставлением заявок объём приводится к шагу инструмента (`VolumeStep`) и ограничивается `MinVolume`/`MaxVolume`.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `BaseVolume` | decimal | `0.1` | Резервный объём, если расчёт по риску недоступен. |
| `MaximumRisk` | decimal | `0.3` | Доля капитала, используемая для расчёта объёма и аварийного выхода. `0` отключает риск-модуль. |
| `DecreaseFactor` | decimal | `100` | Делитель, уменьшающий объём после серии убыточных сделок. |
| `MinimumVolume` | decimal | `0.1` | Минимально допустимый объём заявки. |
| `StochasticLength` | int | `9` | Период стохастического осциллятора. |
| `StochasticKLength` | int | `3` | Сглаживание линии %K. |
| `StochasticDLength` | int | `3` | Сглаживание сигнальной линии %D. |
| `CandleType` | `DataType` | `TimeFrame(1h)` | Тип свечей, используемых для расчёта сигналов. |

## Особенности реализации
- Для аварийного выхода плавающий результат оценивается по средней цене позиции (`Strategy.PositionPrice`) и цене закрытия последней свечи. Это приближает поведение `AccountProfit`, но точность зависит от коннектора.
- Если коннектор не предоставляет `BlockedValue` и `CurrentValue`, модуль аварийного закрытия не активируется; при этом торговля ведётся по объёму `BaseVolume`.
- При старте вызывается `StartProtection()`, чтобы задействовать встроенные защитные механизмы StockSharp (стоп-заявки, контроль соединения и т. п.), аналогичные страховке в оригинальном скрипте.

## Отличия от оригинала
- Округление лотов выполняется по данным инструмента в StockSharp. Убедитесь, что заданы `VolumeStep`, `MinVolume` и `MaxVolume`, иначе объёмы могут отличаться от MT4.
- В MT4 проверка условий происходила на каждом тике при помощи `Volume[0]`. Перенос обрабатывает только завершённые свечи, что избавляет от повторных сигналов и соответствует рекомендуемой модели StockSharp.
- Значения капитала и маржи являются оценочными. При необходимости точного совпадения с расчётами брокера скорректируйте `MaximumRisk` или модифицируйте защитный блок.
