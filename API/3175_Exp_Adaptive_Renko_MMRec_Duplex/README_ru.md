# Стратегия Exp Adaptive Renko MMRec Duplex

Стратегия переносит советник MetaTrader 5 **Exp_AdaptiveRenko_MMRec_Duplex.mq5** на высокоуровневый API StockSharp. Две независимые ветки Adaptive Renko — одна для покупок, другая для продаж — отслеживают, как кирпичные каналы меняют статус между поддержкой и сопротивлением. Когда «длинный» канал формирует свежую поддержку, а «короткий» канал теряет сопротивление (или наоборот), стратегия открывает соответствующую рыночную позицию. C# версия полностью воспроизводит модуль перерасчёта лота (MM Recounter), уменьшающий объём после серии убыточных сделок и возвращающий его к нормальному значению после восстановления.

## Основные этапы работы

1. **Подписки на данные**. Каждая сторона подписывается на свой тип свечей (таймфрейм) и привязывает к нему индикатор волатильности (ATR или стандартное отклонение) через `SubscribeCandles().BindEx(...)`. Индикатор управляет высотой адаптивных кирпичей.
2. **Обработка Adaptive Renko**. Вспомогательный класс `AdaptiveRenkoProcessor` воссоздаёт логику индикатора из MQL и возвращает снимок с текущим трендом, поддержкой и сопротивлением. Сигналы учитываются только на закрытых свечах.
3. **Логика входа**. Когда длинный поток фиксирует бычий разворот (поддержка на сигнальной свече), открывается длинная позиция. Для короткой позиции требуется медвежий сигнал из короткого потока.
4. **Логика выхода**. Обратные события Renko закрывают активную позицию. Дополнительно контролируются уровни стоп-лосса и тейк-профита в шагах цены.
5. **MMRec управление капиталом**. Для каждой стороны ведётся очередь последних результатов сделок. Если число убыточных исходов в заданном окне достигает порога `LossTrigger`, следующая сделка исполняется с уменьшенным значением манименеджмента (`LongSmallMoneyManagement` / `ShortSmallMoneyManagement`). В остальных случаях используется базовое значение (`LongMoneyManagement` / `ShortMoneyManagement`). Перечисление `MarginModeOption` повторяет режимы расчёта из оригинального советника (лоты, доля баланса, доля убытка и т.д.).
6. **Учёт сделок**. При каждом выходе вызывается `RegisterTradeResult`, который пополняет MMRec очереди. Обрезка очередей полностью соответствует функциям `BuyTradeMMRecounterS` и `SellTradeMMRecounterS` без обращения к истории терминала.

## Группы параметров

| Группа | Ключевые параметры | Описание |
| --- | --- | --- |
| Лонг | `LongCandleType`, `LongVolatilityMode`, `LongVolatilityPeriod`, `LongSensitivity`, `LongPriceMode`, `LongMinimumBrickPoints`, `LongSignalBarOffset` | Управляют Adaptive Renko потоком, генерирующим длинные сигналы. |
| Шорт | `ShortCandleType`, `ShortVolatilityMode`, `ShortVolatilityPeriod`, `ShortSensitivity`, `ShortPriceMode`, `ShortMinimumBrickPoints`, `ShortSignalBarOffset` | Аналогичные настройки для короткой ветки. |
| MMRec | `LongTotalTrigger`, `LongLossTrigger`, `LongSmallMoneyManagement`, `LongMoneyManagement`, `LongMarginMode`, `ShortTotalTrigger`, `ShortLossTrigger`, `ShortSmallMoneyManagement`, `ShortMoneyManagement`, `ShortMarginMode` | Настройки модуля восстановления объёма. *TotalTrigger* задаёт длину окна, *LossTrigger* — количество убытков для переключения на уменьшенный объём. |
| Риск | `LongStopLossPoints`, `LongTakeProfitPoints`, `ShortStopLossPoints`, `ShortTakeProfitPoints`, `LongDeviationSteps`, `ShortDeviationSteps` | Параметры защитных уровней и информативного слиппеджа в шагах цены. |

## Поведенческие особенности

- Стратегия рассчитана на неттинговый режим: перед открытием новой длинной позиции закрывается существующий шорт и наоборот.
- Объём рассчитывается функцией `CalculateVolume`, поддерживающей все режимы оригинального манименеджмента, включая схемы с учётом стоп-лосса.
- Вся обработка индикаторов выполняется только на завершённых свечах, как и в исходном советнике.
- В журнал пишется выбранный множитель манименеджмента и ожидаемый слиппедж в шагах цены для удобства анализа.

## Состав репозитория

- `CS/ExpAdaptiveRenkoMmrecDuplexStrategy.cs` — реализация стратегии с адаптивным Renko и блоком MMRec.
- `README.md` — документация на английском языке.
- `README_ru.md` — эта страница.
- `README_cn.md` — документация на китайском языке.
