# Стратегия BandOsMaCustom

## Общее описание

Стратегия портирована из MetaTrader 5 эксперт-советника
`MQL/45596/mql5/Experts/MQL5Book/p7/BandOsMACustom.mq5`. Оригинальный робот
использует гистограмму MACD (OsMA), строит поверх неё полосы Боллинджера и
дополнительную скользящую среднюю. Входы выполняются при пробое полос
Боллинджера самой гистограммой, а выходы — при пересечении гистограммой
скользящей средней. Все расстояния измеряются в пунктах инструмента, стоп и
трейлинг-стоп совпадают по величине, а шаг подтягивания равен `StopLoss / 50`.

Версия на StockSharp сохраняет ту же логику и реализована полностью на
высокоуровневом API, чтобы облегчить сопровождение и визуализацию.

## Особенности конверсии

* Гистограмма MACD реализована через `MovingAverageConvergenceDivergenceHistogram`
  и питается ценой, выбранной параметром `AppliedPrice` (аналог MetaTrader
  `PRICE_*`).
* Полосы Боллинджера и выходная скользящая средняя получают на вход значения
  OsMA, поэтому хранится компактная история, имитирующая параметры смещения
  `BandsShift` и `MaShift` без прямого обращения к прошлым барам индикатора.
* Торговая логика повторяет исходную: пробой нижней полосы создаёт бычий сигнал,
  пробой верхней — медвежий, пересечение с выходной средней сбрасывает сигнал и
  позволяет закрыть позицию.
* Метод `StartProtection` задаёт стоп-лосс и трейлинг-стоп с шагом `StopLossPoints / 50`,
  полностью повторяя класс `TrailingStop` из MQL.

## Используемые индикаторы

| Индикатор | Назначение |
| --- | --- |
| `MovingAverageConvergenceDivergenceHistogram` | Полный аналог `iOsMA` из MetaTrader. |
| `BollingerBands` | Полосы Боллинджера для гистограммы OsMA. |
| Скользящая средняя (SMA/EMA/SMMA/LWMA) | Фильтр для закрытия позиций. |

## Параметры

| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | Часовые свечи | Базовый таймфрейм для всех расчётов. |
| `FastOsmaPeriod` | 12 | Быстрая EMA в расчёте OsMA. |
| `SlowOsmaPeriod` | 26 | Медленная EMA в расчёте OsMA. |
| `SignalPeriod` | 9 | Период сигнальной SMA OsMA. |
| `AppliedPrice` | Typical | Тип цены (MetaTrader `PRICE_*`), подаваемой в OsMA. |
| `BandsPeriod` | 26 | Период полос Боллинджера по гистограмме. |
| `BandsShift` | 0 | Смещение полос Боллинджера в барах. |
| `BandsDeviation` | 2.0 | Множитель стандартного отклонения. |
| `MaPeriod` | 10 | Период выходной скользящей средней. |
| `MaShift` | 0 | Смещение скользящей средней в барах. |
| `MaMethod` | Simple | Тип скользящей (SMA/EMA/SMMA/LWMA). |
| `StopLossPoints` | 1000 | Стоп-лосс в шагах цены. |
| `OrderVolume` | 0.01 | Объём позиции, эквивалент вводу `Lots` в MetaTrader. |

## Правила торговли

1. Подписаться на выбранный поток свечей и передавать в OsMA цену согласно
   `AppliedPrice`.
2. Каждое новое значение OsMA направлять в полосы Боллинджера и выходную
   скользящую среднюю.
3. Формировать сигналы с учётом смещённых буферов:
   * OsMA пересекает нижнюю полосу сверху вниз — фиксируется бычий сигнал.
   * OsMA пересекает верхнюю полосу снизу вверх — фиксируется медвежий сигнал.
   * OsMA пересекает выходную среднюю — сигнал сбрасывается.
4. Управление позициями:
   * При отсутствии соответствующего сигнала закрывать текущую позицию.
   * При отсутствии позиции открывать сделку по активному сигналу.
5. Включить защиту через `StartProtection`, передав рассчитанный стоп-лосс и
   трейлинг-стоп с шагом `StopLossPoints / 50`.

## Дополнительно

* Все комментарии в коде написаны на английском языке согласно политике
  репозитория.
* Исторические буферы позволяют воспроизвести поведение MetaTrader по параметрам
  смещения индикаторов, не обращаясь к значениям по индексам.
* Стратегия использует только высокоуровневые вызовы StockSharp: расчёты выполняет
  подписка `SubscribeCandles`, а рыночные заявки оформляются методами
  `BuyMarket` и `SellMarket`.
