# Стратегия Back Kick

**Back Kick** — это хеджирующая стратегия пробоя, перенесённая из советника MetaTrader 5 `Back kick.mq5`. На закрытии каждой свечи система одновременно открывает длинную и короткую рыночные позиции одинакового объёма. Для каждой ноги задаются симметричные уровни стоп-лосса и тейк-профита в пунктах. В портированной версии StockSharp обе позиции ведутся раздельно с помощью внутренних структур состояния, что позволяет имитировать режим хеджирования MT5 при неттинговом учёте.

## Логика работы

1. Подписка на свечи выбранного таймфрейма. После закрытия свечи и при отсутствии активных ног формируется запрос на открытие новой пары сделок.
2. Немедленно отправляются рыночные заявки на покупку и продажу с одинаковым объёмом. Для каждой ноги рассчитываются уровни защитных ордеров по заданным значениям в пунктах.
3. Состояние сделок контролируется по лучшим ценам bid/ask из Level 1. При достижении защитного уровня соответствующая нога закрывается рыночной заявкой, а противоположная продолжает работать до своего выхода.
4. Когда обе позиции закрыты, стратегия ожидает закрытия следующей свечи, после чего восстанавливает хедж.

Такое поведение повторяет оригинальный советник, который стремится поймать резкие «пинки» цены за счёт постоянного присутствия в обеих сторонах рынка.

## Параметры

| Имя | Описание | Значение по умолчанию | Примечания |
| --- | -------- | --------------------- | ---------- |
| `OrderVolume` | Объём каждой ноги хеджа. | `0.1` | Нормализуется по `VolumeStep` инструмента и проверяется на `MinVolume`/`MaxVolume`. |
| `StopLossPips` | Стоп-лосс в пунктах. | `50` | Значение `0` отключает защитный стоп. |
| `TakeProfitPips` | Тейк-профит в пунктах. | `140` | Значение `0` отключает фиксированный тейк-профит. |
| `CandleType` | Таймфрейм, по закрытию которого создаётся новая пара. | `15m` | Можно выбрать любой поддерживаемый `TimeFrame`. |
| `LogDiagnostics` | Подробный лог заявок и выходов. | `false` | Используйте для отладки последовательности сделок. |

## Особенности реализации

- **Пересчёт пункта.** Оригинальный код учитывает трёх- и пятизнаковые котировки. В портированной версии шаг цены умножается на `10`, если у инструмента 3 или 5 знаков после запятой.
- **Ручное ведение позиций.** Поскольку StockSharp работает с неттинговой позицией, стратегия хранит состояние каждой ноги (`PositionState`) и самостоятельно отправляет рыночные заявки на закрытие. Это позволяет воспроизвести поведение MT5 с раздельными сделками.
- **Управление риском.** Стоп-лосс и тейк-профит необязательны. При нулевой настройке соответствующая нога остаётся открытой до срабатывания другой защиты или внешнего вмешательства.
- **Защитный сервис.** Вызов `StartProtection()` сохраняется для контроля внештатных ситуаций, даже несмотря на кастомную логику выхода.

## Использование

1. Подключите стратегию к инструменту с потоковыми данными Level 1 и нужными свечами.
2. Настройте объём и защитные расстояния в пунктах под свой риск-профиль.
3. Запустите стратегию. Она дождётся закрытия очередной свечи и отправит пару рыночных заявок.
4. Анализируйте логи или график, чтобы отслеживать независимое закрытие каждой ноги.

## Отличия от версии MT5

- Управление объёмом по проценту риска не перенесено. Используйте параметр `OrderVolume`.
- Из-за неттинга в StockSharp хедж моделируется внутренним учётом. Это обеспечивает максимально близкое поведение к исходному советнику при работе с брокерами, использующими неттинг.
- Проверки `FreezeLevel` и `StopsLevel`, зависящие от брокера, опущены. Вместо этого выполняется нормализация объёма с понятными исключениями при нарушении ограничений биржи.

## Состав папки

- `CS/BackKickStrategy.cs` — реализация стратегии на C#.
- `README.md` — документация на английском языке.
- `README_ru.md` — документация на русском языке (этот файл).
- `README_cn.md` — документация на китайском языке.
