# Стратегия MACD Not So Sample

## Обзор
Стратегия MACD Not So Sample — это порт MetaTrader-советника *MACD_Not_So_Sample*. Исходный робот работал на графике EURUSD
с таймфреймом H4, используя пересечения MACD и сигнальной линии, подтверждённые EMA-трендом, и сопровождал позицию крупным
тейк-профитом и трейлинг-стопом. Версия для StockSharp сохраняет эту идею: отрицательный MACD, который пересекает сигнал снизу
вверх при растущей EMA, открывает длинную позицию; положительный MACD, который пересекает сигнал сверху вниз при падающей EMA,
открывает короткую позицию.

Перенос реализует все элементы управления позицией: установка тейк-профита, пересчёт трейлинг-стопа после достаточного движения
цены и выход по обратному пересечению MACD, когда модуль значения превышает заданные уровни. Все вычисления выполняются на
закрытых свечах H4, что полностью повторяет поведение MetaTrader.

## Торговая логика
1. Подписаться на таймфрейм `CandleType` (по умолчанию четырёхчасовые свечи) и обрабатывать только свечи в состоянии `Finished`.
2. Рассчитать индикатор `MovingAverageConvergenceDivergenceSignal` с параметрами `FastPeriod`, `SlowPeriod`, `SignalPeriod`, чтобы
   получить значения MACD и сигнальной линии.
3. Построить EMA-тренд с периодом `TrendPeriod` для фильтрации направлений сделок.
4. Перевести точечные параметры (`MacdOpenLevelPips`, `MacdCloseLevelPips`, `TakeProfitPips`, `TrailingStopPips`) в ценовые
   расстояния с учётом минимального шага цены инструмента.
5. При отсутствии позиции:
   - Открыть **лонг**, если MACD ниже нуля и пересёк сигнал снизу вверх, предыдущее значение было ниже сигнала, EMA растёт, а
     модуль MACD превышает `MacdOpenLevelPips`.
   - Открыть **шорт**, если MACD выше нуля и пересёк сигнал сверху вниз, предыдущее значение было выше сигнала, EMA снижается, а
     модуль MACD превышает `MacdOpenLevelPips`.
6. При длинной позиции:
   - Закрыть сделку, когда MACD становится положительным, пересекает сигнал сверху вниз и его величина больше `MacdCloseLevelPips`.
   - Выйти досрочно при достижении тейк-профита или при срабатывании трейлинг-стопа.
7. При короткой позиции:
   - Закрыть сделку, когда MACD становится отрицательным, пересекает сигнал снизу вверх и его модуль больше `MacdCloseLevelPips`.
   - Выйти досрочно при достижении тейк-профита или при срабатывании трейлинг-стопа.
8. Трейлинг-стоп активируется только после того, как цена пройдёт порог `TrailingStopPips`, затем уровень сопровождает новые
   экстремумы свечей, фиксируя прибыль.

## Параметры
| Название | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `FastPeriod` | `int` | `47` | Период быстрой EMA в расчёте MACD. |
| `SlowPeriod` | `int` | `166` | Период медленной EMA в расчёте MACD. |
| `SignalPeriod` | `int` | `11` | Период EMA сигнальной линии MACD. |
| `TrendPeriod` | `int` | `8` | Период EMA, используемой как трендовый фильтр. |
| `MacdOpenLevelPips` | `decimal` | `1` | Минимальный модуль MACD (в пунктах) для открытия позиции. |
| `MacdCloseLevelPips` | `decimal` | `3` | Минимальный модуль MACD (в пунктах) для закрытия позиции. |
| `TakeProfitPips` | `decimal` | `550` | Расстояние тейк-профита в пунктах. |
| `TrailingStopPips` | `decimal` | `19` | Шаг трейлинг-стопа в пунктах. Значение `0` отключает трейлинг. |
| `TradeVolume` | `decimal` | `1` | Объём, используемый при рыночных заявках. |
| `CandleType` | `DataType` | H4 | Свечной ряд, который обрабатывает стратегия. |
| `RequiredSecurityCode` | `string` | `EURUSD` | Ожидаемый тикер инструмента, проверка повторяет поведение MetaTrader. |

## Отличия от оригинального MetaTrader-советника
- В MetaTrader каждая сделка — отдельный ордер с `MagicNumber`. В StockSharp используется чистая позиция, поэтому стратегия закрывает
  текущую позицию и открывает новую без управления множеством ордеров.
- В MQL-версии объём зависел от свободной маржи (`AccountFreeMargin`). В порте используется параметр `TradeVolume`; управление
  рисками следует настраивать во внешних компонентах.
- Трейлинг-стоп реализован через анализ экстремумов свечи, а не модификацию ордеров, но момент срабатывания совпадает с
  оригинальной логикой.
- Индикаторы рассчитываются через высокоуровневые классы StockSharp и подписку на свечи, без прямых вызовов `iMACD` и `iMA`.

## Рекомендации по использованию
- Перед запуском убедитесь, что код инструмента совпадает с `RequiredSecurityCode`. При несоответствии стратегия немедленно
  остановится, чтобы избежать торгов по неверному активу.
- Параметр `TradeVolume` копируется в `Strategy.Volume` в методе `OnStarted`, поэтому вспомогательные методы (`BuyMarket`,
  `SellMarket`) используют заданный объём.
- Трейлинг-стоп начинает действовать только после прохождения ценой указанного расстояния; до этого момента закрытие происходит по
  MACD или тейк-профиту.
- При добавлении стратегии на график выводятся свечи, оба индикатора и сделки, что упрощает визуальную проверку сигналов.

## Индикаторы
- `MovingAverageConvergenceDivergenceSignal` (линия MACD и сигнальная линия).
- `ExponentialMovingAverage` (трендовый фильтр).
