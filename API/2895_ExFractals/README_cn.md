# ExFractals 策略

## 概述

ExFractals 是一种突破型策略，将威廉姆斯分形水平与 ExVol 平均实体动量过滤器结合起来。当价格收盘突破最近两个分形价格的平均值，并且 ExVol 指示动量方向与突破一致时，策略会进场交易。

## 交易逻辑

1. **分形识别**
   - 仅在蜡烛收盘后处理数据。
   - 在五根蜡烛的滑动窗口中，如果中间蜡烛是相对其它四根蜡烛的极值，则确认一个分形。
   - 分别保存最新的两个上分形和两个下分形以及它们的时间戳，避免重复使用相同的信号。
   - 将同方向的两个分形价格取平均作为触发水平。
2. **ExVol 过滤器**
   - ExVol 等于选定周期内蜡烛实体（收盘价减开盘价）在价格步长单位下的简单平均值。
   - ExVol 为负值表示近期多数蜡烛收阳，ExVol 为正值表示近期多数蜡烛收阴。
3. **入场条件**
   - **做多**：最新收盘价高于上分形平均水平且 ExVol 为负。若持有空头仓位，则先平仓再开多。
   - **做空**：最新收盘价低于下分形平均水平且 ExVol 为正。若持有多头仓位，则先平仓再开空。
4. **风控与离场**
   - 止损与止盈在入场后按设定的点数（pips）距离放置，输入 `0` 可禁用。
   - 当浮动利润超过 `TrailingStop + TrailingStep` 点时启动追踪止损，并保持固定的追踪距离，同时确保每次移动至少跨越追踪步长。
   - 一旦触发止损或止盈，仓位立即全部平仓。

## 参数

| 参数 | 说明 | 默认值 |
| ---- | ---- | ------ |
| `Candle Type` | 策略订阅的蜡烛类型/时间框架。 | 1 小时蜡烛 |
| `ExVol Period` | 计算 ExVol 平均值所需的收盘蜡烛数量。 | 15 |
| `Stop Loss` | 止损距离（点数），`0` 表示关闭。 | 40 |
| `Take Profit` | 止盈距离（点数），`0` 表示关闭。 | 100 |
| `Trailing Stop` | 追踪止损距离（点数），`0` 表示关闭追踪。 | 30 |
| `Trailing Step` | 每次调整追踪止损所需的额外点数，启用追踪时必须大于零。 | 5 |
| `Volume` | 基类 `Strategy` 的默认下单数量。 | 1 |

## 其他说明

- 追踪止损完全遵循原始 MQL 实现，仅在达到足够盈利时才移动。
- 如果合约未提供 `PriceStep`，策略会退化为使用 0.0001 作为步长进行计算。
- 所有信号通过 `BuyMarket` 与 `SellMarket` 市价指令执行，并会在开仓前自动平掉相反方向的持仓。
- 为生成第一个可用的分形平均水平，请确保历史数据中至少包含五根已收盘蜡烛。
