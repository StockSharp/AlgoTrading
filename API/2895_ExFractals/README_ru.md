# Стратегия ExFractals

## Общее описание

ExFractals — это пробойная стратегия, объединяющая уровни фракталов Уильямса и фильтр импульса ExVol. Алгоритм отслеживает два последних подтверждённых фрактала сверху и снизу, усредняет их и открывает позицию, когда цена закрытия преодолевает средний уровень, а ExVol подтверждает направление движения.

## Логика торговли

1. **Поиск фракталов**
   - Свечи анализируются только после закрытия.
   - Фрактал формируется, если средняя свеча в окне из пяти свечей является строгим экстремумом относительно четырёх соседних.
   - Для каждого направления хранятся два последних фрактала вместе с отметками времени, чтобы избежать повторного использования одинаковых точек.
   - Торговый уровень вычисляется как среднее значение между двумя последними фракталами соответствующего типа.
2. **Фильтр ExVol**
   - Значение ExVol — это простая средняя тела свечи (close − open), выраженная в шагах цены, за выбранный период.
   - Отрицательное значение говорит о доминировании бычьих свечей, положительное — о преобладании медвежьих свечей.
3. **Условия входа**
   - **Покупка:** закрытие выше усреднённого уровня верхних фракталов и отрицательный ExVol. При наличии короткой позиции она закрывается и открывается длинная.
   - **Продажа:** закрытие ниже усреднённого уровня нижних фракталов и положительный ExVol. При наличии длинной позиции она закрывается и открывается короткая.
4. **Управление рисками**
   - Стоп-лосс и тейк-профит задаются в пунктах относительно цены входа и могут быть отключены установкой значения `0`.
   - Трейлинг-стоп активируется только после того, как плавающая прибыль превысит сумму `TrailingStop + TrailingStep`. Стоп тянется вслед за ценой, сохраняя фиксированную дистанцию и учитывая минимальный шаг.
   - При срабатывании стопа или цели позиция закрывается полностью.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| -------- | -------- | --------------------- |
| `Candle Type` | Тип/таймфрейм свечей для расчётов. | Свечи 1 час |
| `ExVol Period` | Количество свечей для расчёта среднего тела (ExVol). | 15 |
| `Stop Loss` | Расстояние стоп-лосса в пунктах от цены входа, `0` — отключить. | 40 |
| `Take Profit` | Расстояние тейк-профита в пунктах от цены входа, `0` — отключить. | 100 |
| `Trailing Stop` | Дистанция трейлинг-стопа в пунктах, `0` — отключить. | 30 |
| `Trailing Step` | Дополнительное движение в пунктах перед подтягиванием стопа; должно быть больше нуля при включённом трейлинге. | 5 |
| `Volume` | Базовый объём заявок из класса `Strategy`. | 1 |

## Дополнительные замечания

- Реализация трейлинг-стопа повторяет логику оригинального MQL: стоп обновляется только при достаточной прибыли.
- Если у инструмента отсутствует `PriceStep`, используется запасное значение 0.0001.
- Заявки выполняются рыночными ордерами `BuyMarket` и `SellMarket`, что автоматически переворачивает позицию при появлении противоположного сигнала.
- Для корректного запуска стратегии необходимо иметь в истории минимум пять закрытых свечей для построения первых фракталов.
