# Стратегия Parabolic SAR Bug 3

## Обзор
**Parabolic SAR Bug 3 Strategy** — это высокоуровневая реализация на StockSharp эксперта MetaTrader 4 `pSAR_bug_3.mq4` из каталога `MQL/9786`. Робот реагирует на первый же разворот точек Parabolic SAR на противоположную сторону от цены. Когда SAR оказывается ниже цены закрытия свечи, стратегия закрывает открытые шорты и открывает длинную позицию. Если SAR поднимается над закрытием, позиция немедленно разворачивается в шорт. Каждая сделка защищена фиксированными стоп-лоссом и тейк-профитом, выраженными в «пунктах» Parabolic SAR и умноженными на тот же коэффициент, что и в оригинальной MQL-версии.

## Логика торговли
1. **Данные и индикатор**. Стратегия подписывается на настраиваемый тип свечей (по умолчанию 15-минутные) и привязывает индикатор Parabolic SAR с задаваемыми параметрами шага и максимального ускорения.
2. **Отслеживание состояния**. После первой завершённой свечи код сохраняет информацию о том, находится ли SAR выше или ниже цены закрытия. На последующих свечах новое положение сравнивается с предыдущим, чтобы обнаружить разворот индикатора.
3. **Вход в лонг**. Если Parabolic SAR переходит из зоны выше закрытия в зону ниже, стратегия отправляет рыночную заявку, которая одновременно закрывает текущие короткие позиции и открывает заданный объём лонга. Защитные уровни рассчитываются сразу же.
4. **Вход в шорт**. Когда Parabolic SAR перемещается из-под цены закрытия наверх, выполняется зеркальный сценарий — закрытие длинных позиций и открытие шорта.
5. **Выходы**. На каждой завершённой свече максимум и минимум сравниваются с сохранёнными защитными уровнями. Пробой стоп-лосса или тейк-профита вызывает рыночную заявку на закрытие позиции, что повторяет подход MetaTrader с брокерскими защитными ордерами.

## Управление рисками
- Дистанции стоп-лосса и тейк-профита вычисляются как произведение `StopLossPoints` или `TakeProfitPoints` на `StopMultiplier` и минимальный шаг цены инструмента (при его отсутствии используется значение `0.0001`).
- Торговля выполняется только после проверки `IsFormedAndOnlineAndAllowTrading()`, что гарантирует готовность подписок и разрешение на сделки.
- При смене направления позиции старые защитные уровни очищаются, чтобы исключить ложные срабатывания.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `TradeVolume` | `0.1` | Объём заявки в лотах. Значение также присваивается базовому свойству `Strategy.Volume`. |
| `StopLossPoints` | `90` | Дистанция стоп-лосса в пунктах Parabolic SAR, далее умножается на `StopMultiplier` и шаг цены. |
| `TakeProfitPoints` | `20` | Дистанция тейк-профита в пунктах Parabolic SAR, далее умножается на `StopMultiplier` и шаг цены. |
| `StopMultiplier` | `10` | Коэффициент, воспроизводящий входной параметр `StopMult` из MetaTrader и обеспечивающий совместимость с брокерами, использующими дробные пункты. |
| `SarStep` | `0.02` | Начальный коэффициент ускорения Parabolic SAR. |
| `SarMaximum` | `0.2` | Максимальный коэффициент ускорения Parabolic SAR. |
| `CandleType` | `15-минутные свечи` | Тип свечей, используемый для расчётов индикатора и сигналов. |

## Особенности конверсии
- В MetaTrader позиция закрывалась перед открытием встречной сделки отдельным ордером. В StockSharp тот же результат достигается одной рыночной заявкой, объём которой покрывает противоположную позицию и добавляет требуемый объём новой сделки.
- Брокерские стоп-ордера эмулируются проверкой экстремумов свечей и отправкой рыночных заявок при их пробое.
- Параметр `StopMultiplier` принимает любые положительные значения, но по умолчанию равен `10`, как указано в комментариях исходного кода.
- Python-версия в рамках данной задачи не создавалась.
