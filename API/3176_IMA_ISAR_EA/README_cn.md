# iMA iSAR EA 策略

## 概述
该策略使用 StockSharp 高级 API 复刻 MetaTrader 5 中的 "iMA iSAR EA" 智能交易系统。它结合三条加权移动平均线与两条抛物线 SAR 轨迹，在动量突破时建立仓位。当最快的加权均线位于另外两条均线之上，并且两条 SAR 都位于收盘价下方时开多；条件反向时开空。策略以点（pips）为单位管理止损、止盈以及可选的跟踪止损。

实现基于单一的蜡烛序列，`CandleType` 参数可自定义周期。所有指标都在这一周期上计算。原始 MQ5 程序为各指标使用不同周期，在 StockSharp 中通过为每条均线提供独立的位移（Shift）参数来近似，实现延迟若干已完成 K 线再读取信号的效果。

## 交易规则
- **指标**
  - 三条加权移动平均线（快线、常规线、慢线），均基于配置的蜡烛序列计算，可选的位移参数重现 MQ5 缓冲区的延迟行为。
  - 两条抛物线 SAR 指标（快速 SAR、常规 SAR），使用相同的蜡烛序列，但拥有独立的加速系数和最大步长。
- **入场条件**
  - **做多**：快线高于常规线与慢线，且两条 SAR 都在收盘价下方。
  - **做空**：快线低于常规线与慢线，且两条 SAR 都在收盘价上方。
  - 当出现反向信号时，策略会立即平掉相反仓位，并在同一笔市价单中完成反向建仓。
- **风险控制**
  - 固定止损与止盈以点值表达（即价格步长的倍数），在每根完成的蜡烛上评估。
  - 可选的跟踪止损：启用后，止损会以配置的距离跟随收盘价，只有在价格朝有利方向移动达到设定的跟踪步长后才会抬升/下调。
  - 下单前会根据品种的 `VolumeStep`、`MinVolume` 与 `MaxVolume` 自动调整成交量。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `Volume` | `decimal` | `0.1` | 基础下单手数；若需要反向开仓，会自动包含平掉原有仓位所需的数量。 |
| `StopLossPips` | `decimal` | `50` | 以点为单位的止损距离，设为 `0` 表示禁用。 |
| `TakeProfitPips` | `decimal` | `50` | 以点为单位的止盈距离，设为 `0` 表示禁用。 |
| `UseTrailing` | `bool` | `true` | 是否启用跟踪止损管理。 |
| `TrailingStopPips` | `decimal` | `25` | 跟踪止损与价格之间的距离（点）。 |
| `TrailingStepPips` | `decimal` | `5` | 价格每次至少需要向有利方向移动的点数，达到后才会更新跟踪止损。 |
| `CandleType` | `DataType` | `15 分钟 K 线` | 所有指标使用的蜡烛序列。 |
| `FastMaPeriod` | `int` | `10` | 快速加权均线周期。 |
| `FastMaShift` | `int` | `0` | 快速均线向后偏移的已完成 K 线数量。 |
| `NormalMaPeriod` | `int` | `30` | 常规加权均线周期。 |
| `NormalMaShift` | `int` | `3` | 常规均线向后偏移的已完成 K 线数量。 |
| `SlowMaPeriod` | `int` | `60` | 慢速加权均线周期。 |
| `SlowMaShift` | `int` | `6` | 慢速均线向后偏移的已完成 K 线数量。 |
| `FastSarStep` | `decimal` | `0.02` | 快速 SAR 的加速系数。 |
| `FastSarMax` | `decimal` | `0.2` | 快速 SAR 的最大加速值。 |
| `NormalSarStep` | `decimal` | `0.02` | 常规 SAR 的加速系数。 |
| `NormalSarMax` | `decimal` | `0.2` | 常规 SAR 的最大加速值。 |

## 说明
- 跟踪止损在蜡烛收盘时检查，如需分笔级别的精度，可结合基于报价的保护组件使用。
- 若能获取证券的 `PriceStep`，则点值等于该价格步长；否则默认假设外汇常用的 `0.0001` Tick。
- 为贴近原 MQ5 逻辑，所有信号均在已完成的蜡烛上触发，策略不会预先挂单，而是直接提交市价委托。
