# CloseAllControlStrategy

## Обзор

**CloseAllControlStrategy** — это портированная в StockSharp версия утилиты MetaTrader "CloseAll" из файла `MQL/38245/CloseAll.mq4`. Стратегия выполняет однократную массовую операцию сразу после запуска и позволяет закрыть открытые позиции или удалить отложенные заявки, подходящие под заданные фильтры. Решение рассчитано на мульти-символьные портфели, где трейдеру важно быстро обнулить экспозицию или убрать конкретные заявки по комментариям, магическим числам или идентификаторам инструментов.

В отличие от сигнальных стратегий, эта утилита не подписывается на рынок и не ждёт тиков. Она анализирует текущее состояние портфеля, выполняет выбранное действие и сразу завершает работу. Благодаря этому её удобно использовать как аварийную кнопку или инструмент завершения торговой сессии в Designer и AlgoTrading.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|------------------------|----------|
| `OrderComment` | `string` | `"Bonnitta EA"` | Подстрока (регистр не важен), которая должна содержаться в комментарии заявки/позиции. Пустая строка отключает фильтр по комментариям. |
| `Mode` | `CloseAllMode` | `CloseAll` | Выбирает сценарий массового закрытия. Подробности — в таблице режимов ниже. |
| `CurrencyId` | `string` | пусто | Идентификатор инструмента для валютно-зависимых режимов. При пустом значении используется `Security` стратегии. |
| `MagicOrTicket` | `long` | `1` | Идентификатор, сравниваемый с тикетами и strategy id. Фильтр работает только для положительных значений. |

### Таблица режимов

| Режим | Позиции | Отложенные заявки | Дополнительные фильтры |
|-------|---------|-------------------|------------------------|
| `CloseAll` | Закрыть все подходящие длинные и короткие позиции. | — | Только комментарий. |
| `CloseBuy` | Закрыть только длинные позиции. | — | Только комментарий. |
| `CloseSell` | Закрыть только короткие позиции. | — | Только комментарий. |
| `CloseCurrency` | Закрыть позиции по инструменту `CurrencyId` (или по текущему инструменту при пустом значении). | — | Комментарий + инструмент. |
| `CloseMagic` | Закрыть позиции, у которых идентификатор совпадает с `MagicOrTicket`. | — | Комментарий + magic. |
| `CloseTicket` | Закрыть единственную позицию с тикетом `MagicOrTicket`. | — | Комментарий + тикет. |
| `ClosePendingByMagic` | — | Удалить отложенные заявки с идентификатором `MagicOrTicket`. | Комментарий + magic. |
| `ClosePendingByMagicCurrency` | — | Удалить отложенные заявки, удовлетворяющие одновременно magic и инструменту. | Комментарий + magic + инструмент. |
| `CloseAllAndPendingByMagic` | Закрыть позиции и удалить заявки, совпадающие по magic. | Удалить | Комментарий + magic. |
| `ClosePending` | — | Удалить все отложенные заявки, прошедшие фильтр по комментарию. | Только комментарий. |
| `CloseAllAndPending` | Закрыть все позиции. | Удалить все отложенные заявки. | Только комментарий. |

### Сопоставление идентификаторов

* `MagicOrTicket` сравнивается с `Order.TransactionId`, `Order.Id`, `Order.UserOrderId`, а также (если представимо в виде числа) со `StrategyId` заявок и позиций.
* Сначала выполняется числовое сравнение (инвариантно к культуре). Если парсинг не удался, значение сравнивается как строка с десятичным представлением `MagicOrTicket`.
* Значения ≤ 0 отключают фильтры по magic/тикету.

### Работа с комментариями

* Перед сравнением строка фильтра и комментарий очищаются от пробелов по краям.
* Сравнение выполняется без учёта регистра и ищет подстроку (аналог `StringFind` в MQL).
* Комментарии позиций извлекаются через reflection. Если комментарий получить не удалось, позиция отфильтровывается, что повторяет поведение MetaTrader при несовпадении комментария.

## Последовательность выполнения

1. Проверить, что портфель задан, и единожды запустить защиту позиций.
2. Определить активный режим и собрать позиции/заявки, удовлетворяющие всем фильтрам.
3. Отправить рыночные или отменяющие приказы.
4. Немедленно остановить стратегию после выполнения массового действия.

Стратегия не формирует повторные защитные приказы и не подписывается на данные. Все операции выполняются через высокоуровневые методы `BuyMarket`, `SellMarket` и `CancelOrder`.

## Рекомендации по использованию

* Перед запуском укажите нужный портфель и при необходимости инструмент стратегии.
* Настройте `OrderComment` под комментарий вашего советника или ручной сделки.
* Используйте `CurrencyId`, чтобы ограничить закрытие конкретным инструментом (например `EURUSD@FORTS`).
* Задайте `MagicOrTicket` равным используемому идентификатору. Если фильтр не нужен, установите значение `0`.
* Стратегия завершает работу сама, поэтому её удобно держать в схеме Designer и запускать по требованию без риска повторного закрытия.

## Отличия от оригинального скрипта MQL

* Графические кнопки («Close Orders» и «Exit») заменены немедленным выполнением при запуске.
* Обнаружение отложенных заявок использует перечисление `OrderTypes`, охватывая все не-рыночные типы, поддерживаемые StockSharp.
* Комментарии и идентификаторы стратегий для позиций и заявок считываются через reflection для максимальной совместимости с адаптерами брокеров.
* Логирование осуществляется стандартными средствами базового класса `Strategy` (без явного `Print`). При необходимости можно добавить собственные сообщения.
