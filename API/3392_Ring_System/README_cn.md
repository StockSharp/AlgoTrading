# 环形系统策略

## 策略理念

**环形系统策略** 将 "MT5 Ring System EA" 的三角套利思想迁移到 StockSharp 平台。策略同时监控能够构成封闭兑换环的三条货币对（例如 `EURUSD`、`USDJPY`、`EURJPY`）。当前两条腿的乘积与直接交叉盘出现偏差时，策略会建立对冲篮子进行套利，并在价差回归时同步平仓。

实现过程中完全依赖高级烛图订阅 API。每条腿均独立监控，所有交易均使用同步市价单执行，以保持环形组合的净敞口接近零。

## 参数

| 参数 | 说明 |
|------|------|
| `Currencies` | 用于构建环形组合的货币列表，仅使用前三个条目。 |
| `Entry Threshold` | 开仓所需的最小相对偏差，即合成价格（`leg1 * leg2`）与直接交叉盘之间的差值。 |
| `Exit Threshold` | 已有环形仓位触发平仓的偏差阈值，通常小于入场阈值。 |
| `Order Volume` | 建仓或平仓时每条腿发送的交易量。 |
| `Candle Type` | 用于评估价差的烛图聚合类型。可根据行情源提供的任意时间框架选择。 |
| `Symbol Prefix` | 追加到生成品种代码前的可选前缀，例如部分券商使用 `m.` 或 `FX_`。 |
| `Symbol Suffix` | 追加到生成品种代码后的可选后缀，例如 `EURUSD.i`。 |
| `Flatten On Stop` | 停止策略时是否自动平掉所有腿的仓位。 |

## 交易流程

1. 解析货币字符串，保留前三个代码，并生成三条货币对。
2. 为每条腿订阅烛图，在烛图收盘后记录最新收盘价。
3. 计算理论交叉价（`price1 * price2`）并与直接交叉价（`price3`）比较。
4. 当相对偏差超过入场阈值时开仓：
   - 做多环：买入直接交叉盘（第三腿），同时卖出另外两条腿。
   - 做空环：卖出直接交叉盘，同时买入另外两条腿。
5. 当偏差绝对值回落到平仓阈值以内时，平掉所有仓位。
6. 如启用，在 `OnStopped` 阶段再次平仓以确保安全。

## 使用提示

- 策略假设三条货币对都能从证券提供者中获取，必要时使用前缀和后缀参数匹配券商命名规则。
- 为贴近原始 EA，所有交易均采用市价单执行。
- 策略避免同时叠加多个篮子，仅在三条腿都为空仓时才会再次开仓。
- 每个策略实例只处理一个环，如需更多组合可启动多个实例。

## 与原始 EA 的差异

- 本移植版本仅聚焦于单个三角套利环，而 MT5 版本最多可同时管理 56 个环。
- 原策略中的自动手数、步进加仓等资金管理功能被简化为单一的 `Order Volume` 参数。
- MQL 版本提供的图形信息面板和持久化日志未包含在本实现中。
- 未实现原策略的交易时段限制和滑点检测，如有需要可借助 StockSharp 的风控组件。

## 回测建议

回测时请选择共享基础货币集合的三条外汇产品，并确保烛图数据时间对齐。根据所选货币对的波动性调整入场与平仓阈值。
