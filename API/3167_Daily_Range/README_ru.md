# Стратегия Daily Range

## Обзор
Стратегия является портом на StockSharp советника MetaTrader 5 `MQL/23334/Daily range.mq5`. Оригинальная версия отслеживает максимум и минимум последних дней, добавляет к ним смещение, пропорциональное дневному диапазону, и торгует пробои. Переписанная C#-реализация полностью использует высокоуровневый API StockSharp.

## Логика работы
### Расчёт диапазона
* Для каждого торгового дня сохраняются экстремумы (максимум, минимум) и последняя цена закрытия.
* Поддерживается скользящее окно из `SlidingWindowDays` дней, включая текущий.
* Параметр `RangeMode` определяет способ вычисления диапазона:
  * **HighestLowest** — расстояние между максимальным максимумом и минимальным минимумом в окне.
  * **CloseToClose** — среднее абсолютное изменение между последовательными дневными закрытиями в окне.
* После наступления заданного `StartTime` для нового дня стратегия пересчитывает уровни пробоя:
  * `Upper = Highest + Range × OffsetCoefficient`
  * `Lower = Lowest − Range × OffsetCoefficient`
* До наступления `StartTime` используются уровни, рассчитанные на предыдущий день, что повторяет поведение MQL-версии.

### Правила входа
* Длинная позиция открывается, когда цена закрытия свечи превышает либо равна верхнему уровню, а число длинных входов за день меньше `MaxPositionsPerDay`.
* Короткая позиция открывается, когда цена закрытия опускается ниже либо равна нижнему уровню и лимит коротких входов не исчерпан.
* При развороте из уже открытой позиции сначала перекрывается текущий объём, после чего добавляется новый `Volume`, чтобы воспроизвести неттинговую схему исходного робота.
* Сигналы рассматриваются только по закрытым свечам выбранного `CandleType` и лишь при выполнении `IsFormedAndOnlineAndAllowTrading()`.

### Правила выхода
* Расстояние до стоп-лосса и тейк-профита определяется как `Range × StopLossCoefficient` и `Range × TakeProfitCoefficient` соответственно.
* Для длинных позиций закрытие выполняется при касании стоп-уровня минимумом свечи либо достижении тейк-профита максимумом.
* Для коротких позиций закрытие происходит при пересечении стоп-уровня максимумом свечи либо тейк-профита минимумом.
* Нулевое значение коэффициента отключает соответствующую защиту.

### Контроль рисков
* Ведутся отдельные счётчики длинных и коротких входов, которые обнуляются при наступлении нового торгового дня.
* Объём сделок задаётся свойством `Volume` базового класса `Strategy`.
* Отложенные заявки не используются — выходы исполняются рыночными приказами при следующей проверке условий.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `RangeMode` | Метод расчёта дневного диапазона (`HighestLowest` или `CloseToClose`). | `HighestLowest` |
| `SlidingWindowDays` | Количество календарных дней в скользящем окне диапазона. | `3` |
| `StopLossCoefficient` | Множитель диапазона для определения расстояния стоп-лосса. | `0.03` |
| `TakeProfitCoefficient` | Множитель диапазона для расчёта тейк-профита. | `0.05` |
| `OffsetCoefficient` | Дополнительное смещение для уровней пробоя. | `0.01` |
| `MaxPositionsPerDay` | Максимальное число входов в одном направлении за день. | `3` |
| `StartTime` | Время суток, когда пересчитывается диапазон на текущую сессию. | `10:05` |
| `CandleType` | Тип свечей, используемых для расчётов и сигналов. | Таймфрейм 15 минут |

## Особенности реализации
* Стратегия использует высокоуровневую инфраструктуру StockSharp (`SubscribeCandles`, `WhenNew`, рыночные заявки) без прямого доступа к стаканам.
* Все расчёты диапазона выполняются внутри стратегии без обращения к `GetValue`, что соответствует проектным требованиям.
* Защитные приказы моделируются за счёт контроля экстремумов свечей, а не регистрацией стоп/лимит ордеров, что упрощает переносимость между адаптерами.
* По запросу не реализована Python-версия — предоставлена только C#-реализация.
* Для корректного старта необходимо наличие исторических свечей, достаточных для первого пересчёта диапазона.
