# Стратегия MA Grid

## Общее описание

Стратегия представляет собой портирование советника MetaTrader 5 **MAGrid.mq5** на платформу StockSharp. Алгоритм поддерживает симметричную сетку длинных и коротких позиций вокруг экспоненциальной скользящей средней (EMA). Когда цена преодолевает заранее заданный шаг сетки вверх или вниз, стратегия закрывает позицию с противоположной стороны и открывает новую по направлению пробоя, сохраняя корзину сбалансированной относительно EMA.

## Источник

- **Папка в репозитории MQL:** `MQL/38303`
- **Файл-оригинал:** `MAGrid.mq5`
- **Торговая платформа:** MetaTrader 5 (режим хеджирования)

## Логика торговли

1. **Опорная EMA**
   - Период EMA задаётся параметром (`MaPeriod`, по умолчанию 48).
   - Индикатор рассчитывается на выбранном типе свечей.
   - Уровни сетки формируются как кратные величине `Distance` относительно значения EMA.

2. **Инициализация сетки**
   - Количество шагов сетки принудительно делается чётным, чтобы обеспечить зеркальность.
   - Текущий индекс сетки определяется сравнение закрытия свечи с EMA и её уровнями.
   - Стратегия сразу открывает симметричный набор рыночных покупок и продаж: половина под EMA, половина над ней.

3. **Поддержание сетки**
   - Если цена закрывается выше следующего верхнего уровня:
     - Индекс сетки увеличивается на единицу.
     - Закрывается одна длинная позиция (если есть открытые покупки).
     - Открывается новая короткая позиция на очередном верхнем уровне.
   - Если цена закрывается ниже следующего нижнего уровня:
     - Индекс сетки уменьшается на единицу.
     - Закрывается одна короткая позиция (если есть открытые продажи).
     - Открывается новая длинная позиция на очередном нижнем уровне.
   - Когда на одной из сторон сетки не остаётся позиций, соответствующие срабатывания временно блокируются до появления новых ордеров.

4. **Обработка ордеров**
   - Для отслеживания назначения ордера (открытие или закрытие) используется внутренняя таблица.
   - Отдельно ведутся показатели длинного и короткого объёма, что позволяет воспроизвести хеджирующую логику оригинального советника в рамках неттинговой модели StockSharp.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `MaPeriod` | 48 | Период EMA, определяющей центр сетки. |
| `GridAmount` | 6 | Количество шагов сетки (автоматически приводится к чётному числу). |
| `Distance` | 0.005 | Относительное расстояние между соседними уровнями (0.005 = 0.5%). |
| `OrderVolume` | 0.1 | Объём каждой рыночной заявки. |
| `CandleType` | Дневные свечи | Тип свечей, используемый для расчёта EMA и сигналов. |

## Управление рисками

- В коде отсутствуют стоп-лосс и тейк-профит; риск регулируется числом уровней сетки и объёмом заявки.
- Из-за одновременного наличия длинных и коротких позиций баланс портфеля меняется плавно, однако нагрузка на маржу растёт по мере расширения сетки.
- Рекомендуется подключать внешние ограничения по просадке и использованию капитала.

## Особенности конверсии

- Логика хеджирования реализована через раздельный учёт длинного и короткого объёма.
- Формула вычисления объёма из MQL, привязанная к балансу счёта, заменена параметром `OrderVolume`.
- Подписка на данные реализована через высокоуровневый API `SubscribeCandles().Bind(...)` в соответствии с требованиями проекта.
