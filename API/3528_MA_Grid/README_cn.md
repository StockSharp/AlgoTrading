# MA 网格策略

## 概览

本策略是 MetaTrader 5 专家顾问 **MAGrid.mq5** 的 C# 移植版本。它围绕指数移动平均线（EMA）维护一组对冲的买入和卖出头寸。当价格向上或向下突破预设的网格距离时，策略会在突破方向上开仓，同时从对侧网格中平掉一笔持仓，从而始终让仓位簇围绕 EMA 中心展开。

## 原始来源

- **MQL 仓库目录：** `MQL/38303`
- **原始文件：** `MAGrid.mq5`
- **平台：** MetaTrader 5（对冲模式）

## 交易逻辑

1. **EMA 锚点**
   - EMA 周期可配置，默认值为 48。
   - EMA 在所选的蜡烛序列上计算。
   - 网格水平按照 `Distance` 参数的倍数布置在 EMA 上下。

2. **网格初始化**
   - 网格步数会被强制转换为偶数，以保证上下对称。
   - 通过比较最新收盘价和 EMA 网格水平来确定当前所在网格编号。
   - 策略会对称开立多单和空单，使一半仓位位于 EMA 下方，另一半位于 EMA 上方。

3. **网格维护**
   - 当价格收于上方网格之上时：
     - 网格编号加一。
     - 若仍有多头敞口，则平掉一笔多单。
     - 在新的上方网格开立一笔空单。
   - 当价格收于下方网格之下时：
     - 网格编号减一。
     - 若仍有空头敞口，则平掉一笔空单。
     - 在新的下方网格开立一笔多单。
   - 若任一侧的敞口耗尽，对应的触发条件会被暂时禁用，直到重新开仓。

4. **订单处理**
   - 策略使用内部映射记录订单意图，以区分开仓与平仓成交。
   - 分别维护多头与空头敞口，借此在 StockSharp 的净头寸模型下模拟 MQL 的对冲行为。

## 参数

| 名称 | 默认值 | 描述 |
| --- | --- | --- |
| `MaPeriod` | 48 | 计算 EMA 锚点的周期。 |
| `GridAmount` | 6 | 网格步数，自动向上取偶数。 |
| `Distance` | 0.005 | 相邻网格之间的相对距离（例如 0.005 表示 0.5%）。 |
| `OrderVolume` | 0.1 | 每笔市价单的下单量。 |
| `CandleType` | 日线 | 用于计算 EMA 并评估信号的蜡烛类型。 |

## 风险管理

- 策略未实现止损或止盈，风险控制主要依赖网格数量与下单量。
- 由于同时持有多空仓位，净值波动较平稳，但保证金占用会随着网格规模增加。
- 建议结合账户层面的风险限额（最大回撤、资金占用等）使用。

## 转换说明

- C# 实现通过分别跟踪多头与空头敞口来复刻原策略的对冲网格逻辑。
- 原始代码中依赖账户余额计算下单量的部分，被替换为可配置的 `OrderVolume` 参数。
- 数据订阅遵循项目规范，使用 `SubscribeCandles().Bind(...)` 的高阶 API 完成。
