# Стратегия RM Stochastic Band

## Общее описание

**RM Stochastic Band Strategy** — порт на StockSharp высокоуровневого эксперта MetaTrader *EA RM Stochastic Band* (автор Ronny Maheza). Стратегия отслеживает три стохастических осциллятора на разных таймфреймах (базовом, среднем и старшем) и открывает сделки только тогда, когда все три подтверждают перепроданность или перекупленность. После входа уровни защиты и фиксации прибыли рассчитываются через индикатор Average True Range на старшем таймфрейме, что полностью повторяет механику оригинального советника. Дополнительно реализованы фильтры по спреду и минимальной величине портфеля, играющей роль прокси свободной маржи.

## Ключевая логика

1. **Много таймфреймов для подтверждения сигнала**  
   - Базовый таймфрейм (по умолчанию M1) формирует сигнал.  
   - Таймфреймы подтверждения (M5 и M15) должны совпадать по направлению.  
   - Сделка открывается только если значения %K на всех трёх таймфреймах одновременно ниже уровня перепроданности (для покупки) или выше уровня перекупленности (для продажи).

2. **Выходы на основе ATR**  
   - ATR считается на старшем таймфрейме (по умолчанию M15).  
   - Стоп-лосс = `цена входа ± ATR * StopLossMultiplier`.  
   - Тейк-профит = `цена входа ± ATR * TakeProfitMultiplier`.  
   - Проверка условий выхода выполняется по закрытым свечам базового таймфрейма.

3. **Исполнительные фильтры и безопасность**  
   - При превышении текущим спредом стандартного порога используется более широкая «цент-версия» лимита, как и в исходном коде.  
   - Если стоимость портфеля ниже `MinMargin`, торговля блокируется.  
   - Одновременно допускается только одна позиция; при наличии активных заявок новые сделки не открываются.

## Используемые подписки и индикаторы

| Индикатор | Таймфрейм | Назначение |
|-----------|-----------|------------|
| Stochastic Oscillator | Базовый (M1) | Формирует основной сигнал (используется %K). |
| Stochastic Oscillator | Средний (M5) | Подтверждение направления. |
| Stochastic Oscillator | Старший (M15) | Дополнительное подтверждение тренда. |
| Average True Range | Старший (M15) | Расчёт стоп-лосса и тейк-профита. |

Дополнительно производится подписка на Level-1 для контроля лучшего бид/аск и спреда.

## Правила входа

- **Покупка**: все три значения %K ниже `OversoldLevel`. Стратегия отправляет рыночную заявку объёмом `OrderVolume` и фиксирует ATR-основанные уровни выхода.
- **Продажа**: все три значения %K выше `OverboughtLevel`. Выполняется рыночная продажа тем же объёмом.

## Правила выхода

- **Стоп-лосс**: длинная позиция закрывается при касании `вход - ATR * StopLossMultiplier`; короткая — при достижении `вход + ATR * StopLossMultiplier`.
- **Тейк-профит**: длинная позиция закрывается при `вход + ATR * TakeProfitMultiplier`; короткая — при `вход - ATR * TakeProfitMultiplier`.
- После закрытия позиция очищаются внутренние переменные стопов/целей, чтобы следующее срабатывание пересчитало свежие уровни.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `OrderVolume` | Объём рыночных заявок. | 0.1 |
| `StochasticLength` | Длина расчёта %K. | 5 |
| `StochasticSmoothing` | Сглаживание %K. | 3 |
| `StochasticSignalLength` | Длина %D. | 3 |
| `AtrPeriod` | Период ATR на старшем таймфрейме. | 14 |
| `StopLossMultiplier` | Множитель ATR для стоп-лосса. | 1.5 |
| `TakeProfitMultiplier` | Множитель ATR для тейк-профита. | 3.0 |
| `MinMargin` | Минимальная стоимость портфеля для торговли. | 100 |
| `MaxSpreadStandard` | Максимальный спред для стандартного счёта. | 3 |
| `MaxSpreadCent` | Порог спреда, когда стандартный лимит уже превышен. | 10 |
| `OversoldLevel` | Уровень перепроданности по %K. | 20 |
| `OverboughtLevel` | Уровень перекупленности по %K. | 80 |
| `BaseCandleType` | Основной таймфрейм (по умолчанию 1 минута). | 1 минута |
| `MidCandleType` | Таймфрейм подтверждения (по умолчанию 5 минут). | 5 минут |
| `HighCandleType` | Таймфрейм подтверждения + ATR (по умолчанию 15 минут). | 15 минут |

Все параметры поддерживают диапазоны оптимизации, соответствующие входам исходного советника.

## Особенности реализации

- Индикаторы подключаются через `SubscribeCandles(...).BindEx(...)`, что полностью соответствует требованиям AGENTS.md к использованию высокоуровневого API.  
- Спред оценивается по Level-1. Если котировки (bid/ask) отсутствуют, торговля блокируется, что защищает от работы на неполных данных.  
- Управление позициями выполняется рыночными заявками, как и в оригинале, с фиксацией предварительно рассчитанных уровней стопа и цели.  
- В исходном MQL-коде отсутствовала логика безубытка и трейлинг-стопов, поэтому они намеренно не реализованы.

## Рекомендации по эксплуатации

1. Подключайте стратегию к инструменту, по которому доступен Level-1 поток, иначе фильтр по спреду не позволит торговать.  
2. Настройте уровни стохастика и множители ATR под волатильность конкретного рынка.  
3. При оптимизации при необходимости экспериментируйте с другими таймфреймами, если рыночный цикл отличается от схемы M1/M5/M15.
