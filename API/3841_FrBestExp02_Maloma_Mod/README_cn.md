# FrBestExp02 Maloma Mod 策略

该策略是 MetaTrader 4 智能交易程序 `Frbestexp02_1_maloma_mod.mq4` 的 C# 版本。它结合了 OsMA 动量、分形反转、勾选成交量确认以及滚动日枢轴过滤器，用于在 15 分钟周期上捕捉过度延伸后的反向机会。

## 交易逻辑

- **会话枢轴**：在可配置窗口内（默认 96 根 M15 蜡烛，约等于一个交易日）计算最高价、最低价和最早的收盘价得到枢轴点。策略只在价格位于枢轴上方时做空，位于枢轴下方时做多。
- **分形形态**：等待距当前三根 K 线的确认分形。下分形（摆动低点）触发做空条件，上分形（摆动高点）触发做多条件。
- **OsMA 直方图**：MACD 直方图（默认快线 12、慢线 26、信号线 9）必须继续向负区间下降才允许做空，而做多时需要继续向正区间上升；上一根柱也必须在相同的零轴一侧。
- **成交量过滤**：上一根完结蜡烛的成交量必须高于设定阈值，并且大于两根前的成交量，以复现原始 EA 对成交量突增的要求。
- **下单节奏**：两次入场之间必须满足最小时间间隔（默认 20 秒）。
- **风险控制**：止损、止盈以及可选的移动止损均以点数设置，并在运行时转换为实际价格，通过 `SetStopLoss`/`SetTakeProfit` 自动更新保护单。

## 参数

| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `Volume` | 每次下单的手数。 | 1 |
| `StopLossPoints` | 止损距离（点）。 | 1000 |
| `TakeProfitPoints` | 止盈距离（点）。 | 1000 |
| `TrailingStopPoints` | 可选的移动止损距离（0 表示禁用）。 | 0 |
| `VolumeThreshold` | 触发信号所需的上一根成交量最小值。 | 50 |
| `OsmaFastPeriod` / `OsmaSlowPeriod` / `OsmaSignalPeriod` | 计算 OsMA 直方图的 MACD 参数。 | 12 / 26 / 9 |
| `PivotWindow` | 枢轴计算使用的完结蜡烛数量。 | 96 |
| `MinTradeIntervalSeconds` | 两次新开仓之间的最小秒数。 | 20 |
| `CandleType` | 主时间框架（默认 15 分钟蜡烛）。 | M15 |

## 与原版 EA 的差异

- 原版代码支持按 `kh` 倍数对冲加仓并包含复杂的利润回收逻辑。移植版本只维护单一方向仓位，在开新仓前会先平掉或反向。
- 移动止损使用 StockSharp 的 `SetStopLoss` 辅助方法简化实现，不再逐笔修改订单。
- 省略了利润累计与马丁加仓模块，退出完全依赖止损、止盈或移动止损。
- 指标计算全部基于完结蜡烛事件，没有盘中修改订单的行为。

## 使用建议

1. 若希望成交量过滤器与 MT4 版本一致，请确保标的能够提供勾选成交量数据。
2. 推荐保持 15 分钟周期，以匹配原始分形与枢轴设置。
3. 不同品种可适当调整 `VolumeThreshold` 与 OsMA 参数，使其适应波动性与成交量差异。
4. 只有在需要更紧凑的退出方式时才开启移动止损，否则保持 0 依赖固定止损/止盈。

该实现遵循 StockSharp 高阶 API 的最佳实践：通过 `SubscribeCandles` 订阅蜡烛、绑定 MACD 指标，并使用 `BuyMarket`/`SellMarket` 下单同时自动配置保护单。
