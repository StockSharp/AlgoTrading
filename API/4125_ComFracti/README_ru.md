# Стратегия ComFracti

## Обзор

ComFracti — портированная с MT4 стратегия "ComFracti". Алгоритм совмещает подтверждение фракталами на двух таймфреймах с фильтрами RSI и стохастика, а также предлагает дополнительные фильтры: наклон EMA, параболический SAR, канал и перцептрон. Реализация на C# использует высокоуровневый API StockSharp, анализирует только завершённые свечи и в каждый момент времени удерживает одну позицию.

## Логика торговли

- **Основной сигнал**
  - Лонг подтверждается, если фрактальный сигнал вверх присутствует и на рабочем, и на старшем таймфрейме.
  - Шорт подтверждается, если оба таймфрейма формируют нисходящий фрактал.
  - При включённом фильтре RSI трёхпериодный RSI на старшем таймфрейме должен быть ниже `50 - RsiLevelBuy` для лонга или выше `50 + RsiLevelSell` для шорта.
  - При включённом фильтре стохастика %K (период 5, сглаживание 3/3) должен быть ниже `50 - StochasticLevelBuy` для лонга или выше `50 + StochasticLevelSell` для шорта.
- **Дополнительные фильтры**
  - **Наклон EMA**: EMA на фильтровом таймфрейме должна расти для лонга и снижаться для шорта.
  - **Parabolic SAR**: значение SAR должно располагаться ниже цены открытия (лонг) или выше (шорт).
  - **Канальный фильтр**: сравнивает предыдущую свечу с адаптивным каналом; минимум прошлой свечи должен быть выше нижней границы (лонг), максимум — ниже верхней (шорт).
  - **Перцептрон**: взвешенная сумма разностей максимумов и минимумов последних баров должна быть положительной (лонг) или отрицательной (шорт).
- **Управление позицией**
  - Одновременно удерживается только одна позиция; при появлении сигнала противоположного направления стратегия сначала закрывает текущую позицию.
  - Стоп-лосс и тейк-профит задаются в пунктах инструмента.
  - Опциональный трейлинг-стоп двигается вслед за ценой после достижения заданного буфера (`ProfitTrailing = true`).
  - При включённом `CloseOnOppositeSignal` позиция закрывается при появлении противоположного основного сигнала.

## Управление рисками

- Базовый объём задаётся параметром `BaseVolume` (по умолчанию 0.1 лота). При активном `AccountMicro` объём делится на 10.
- Если `UseMoneyManagement` включён, стратегия рассчитывает объём исходя из процента риска `RiskPercent`, текущего расстояния стоп-лосса и стоимости шага цены. Полученный объём ограничивается параметром `MinimumVolume`.

## Параметры

| Параметр | Описание |
| --- | --- |
| `TakeProfitPoints`, `StopLossPoints` | Расстояние до тейк-профита и стоп-лосса в пунктах. |
| `UseTrailingStop`, `TrailingStopPoints`, `ProfitTrailing` | Настройки трейлинг-стопа (дистанция и требование предварительной прибыли). |
| `BaseVolume`, `UseMoneyManagement`, `RiskPercent`, `AccountMicro`, `MinimumVolume` | Управление объёмом позиции. |
| `UseFractals`, `FractalShift*` | Включение фрактального фильтра и смещения анализируемых баров. |
| `UseRsi`, `RsiLevelBuy`, `RsiLevelSell`, `RsiType` | Настройки фильтра RSI и таймфрейм расчёта. |
| `UseStochastic`, `StochasticPeriod*`, `StochasticLevel*` | Настройки стохастика и порогов. |
| `UseMaFilter`, `MaPeriod` | Фильтр EMA на выбранном таймфрейме. |
| `UsePsarFilter`, `PsarStep` | Фильтр Parabolic SAR. |
| `UseChannelFilter`, `ChannelLookback`, `ChannelK` | Параметры канального фильтра. |
| `UsePerceptronFilter`, `PerceptronV1`–`PerceptronV4` | Весовые коэффициенты перцептронного фильтра (0–100, смещены относительно 50). |
| `CandleType`, `HigherFractalType`, `FilterType` | Используемые таймфреймы данных. |

## Примечания

- Стратегия работает со свечами закрытия, поэтому поведение может немного отличаться от оригинального тикового советника MT4.
- Реализованный трекер фракталов воспроизводит пятибарный алгоритм MT4 и поддерживает настройку смещений (`sh1/sh2`).
- Деньговое управление опирается на стоимость портфеля, доступную в StockSharp; при отсутствии оценки стратегия возвращается к фиксированному объёму.
