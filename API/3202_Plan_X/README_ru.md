# Стратегия Plan X

## Общее описание

Plan X — это пробойная стратегия, перенесённая из оригинального советника MetaTrader 5. Алгоритм сравнивает закрытие каждой завершённой свечи с закрытием свечи, смещённой на заданное количество баров назад. Если новое закрытие превышает опорное значение на величину канала, открывается позиция по направлению пробоя. При включённом реверсе сделки выполняются в противоположном направлении.

Реализация построена на высокоуровневом API StockSharp и поддерживает настройку стоп-лосса, тейк-профита, трейлинг-стопа и торговых сессий.

## Последовательность работы

1. **Обработка свечей** — подписка на выбранный тип свечей и анализ только завершённых баров. Хранится небольшой буфер закрытий для сравнения с опорной свечой.
2. **Определение пробоя** — если закрытие превышает опорное значение плюс высоту канала, формируется сигнал на покупку; если закрытие ниже опорной цены минус канал, формируется сигнал на продажу. При активном реверсе условия меняются местами.
3. **Исполнение ордеров** — для входа используются рыночные приказы. При развороте объём автоматически увеличивается на величину текущей позиции, что позволяет закрыть старую и открыть новую позицию одним ордером.
4. **Управление рисками** — сразу после входа выставляются уровни стоп-лосса и тейк-профита. Трейлинг-стоп срабатывает, когда цена проходит расстояние, превышающее сумму трейлинга и шага.
5. **Фильтр по времени** — торговля ограничивается диапазоном часов. Если час начала больше часа окончания, считается, что окно торговли пересекает полночь.

## Параметры

| Параметр | Описание |
|----------|----------|
| `Stop Loss (pips)` | Расстояние до защитного стопа в пунктах, пересчитываемое в цену с учётом шага цены. |
| `Take Profit (pips)` | Дистанция до тейк-профита в пунктах. |
| `Trailing Stop (pips)` | Размер трейлинг-стопа. Ноль — отключение трейлинга. |
| `Trailing Step (pips)` | Дополнительное ценовое движение, необходимое для переноса трейлинг-стопа. Обязательно > 0 при включённом трейлинге. |
| `Channel Height (pips)` | Высота канала пробоя в пунктах. |
| `Candle Shift` | Количество баров между текущей и опорной свечой. |
| `Use Time Control` | Включение фильтра торговых часов. |
| `Start Hour` | Час (0–23), с которого разрешена торговля. |
| `End Hour` | Час (0–23), до которого разрешена торговля. |
| `Reverse Signals` | Инвертирует направления сделок. |
| `Order Volume` | Объём рыночных приказов (лоты/контракты). |
| `Candle Type` | Тип свечей, используемых для расчётов. |

## Логика сигналов

- **Покупка** — закрытие ≥ опорное закрытие + высота канала, реверс выключен.
- **Продажа** — закрытие ≤ опорное закрытие − высота канала, реверс выключен.
- При включённом реверсе условия покупки и продажи меняются местами.

## Логика трейлинг-стопа

- Активация происходит после того, как прибыль превысила сумму `Trailing Stop + Trailing Step` (в ценовых единицах).
- Для длинной позиции новый стоп устанавливается на уровне `максимум − Trailing Stop`, если значение выше текущего стопа.
- Для короткой позиции новый стоп равен `минимум + Trailing Stop`, если значение ниже текущего стопа.

## Дополнительные замечания

- Расчёт пункта повторяет MQL-реализацию: для инструментов с 3 или 5 знаками после запятой шаг цены умножается на 10.
- Вне торгового окна новые сделки не открываются, но активные позиции продолжают сопровождаться.
- Метод `StartProtection()` вызывается при запуске для активации механизмов защиты портфеля.
