# Стратегия XD Range Switch

## Общее описание
Стратегия XD Range Switch переносит в StockSharp советник MetaTrader 5 **Exp_XD-RangeSwitch** и использует высокоуровневый API платформы. В основе лежит пользовательский индикатор XD-RangeSwitch, который строит попеременно верхнюю и нижнюю границы канала и рисует стрелки в момент смены доминирующей стороны. В зависимости от параметра `TradeDirection` стратегия может торговать против появившейся стрелки (контртрендовый подход) или в сторону пробоя канала. Размер сделки определяется через базовое свойство `Strategy.Volume`, а исходные алгоритмы мани-менеджмента заменены штатными средствами управления позицией в StockSharp.

## Восстановление индикатора XD-RangeSwitch
* Индикатор отслеживает последние `Peaks` завершённых свечей и вычисляет экстремумы (максимумы и минимумы) в этом окне.
* Нижняя граница канала появляется, если цена закрытия текущей свечи выше наибольшего максимума предыдущих `Peaks` баров. Значение границы соответствует минимальному минимуму в указанном окне вместе с текущей свечой.
* Верхняя граница канала появляется, если цена закрытия ниже наименьшего минимума предыдущих `Peaks` баров. Значение границы равно максимальному максимуму в том же окне.
* Если пробоя не произошло, значения канала просто переносятся вперёд.
* Как только граница снова становится ненулевой после паузы, стратегия фиксирует стрелку на уровне этой границы — аналог MT5-буферов 2 и 3 в оригинальном советнике.
* Обрабатываются только полностью сформированные свечи, что обеспечивает одинаковые значения в реальном времени и при тестах.

## Логика торговли
1. Стратегия подписывается на свечи с таймфрейма `CandleType` и формирует буферы индикатора в точности как в MT5.
2. Для каждого нового бара анализируется значение индикатора, которое находится на `SignalBar` свечей позади (совпадает с аргументом `CopyBuffer` в исходном коде).
3. Интерпретация сигналов зависит от параметра `TradeDirection`:
   * **AgainstSignal** воспроизводит поведение по умолчанию — восходящая стрелка открывает лонг и требует закрыть шорт, нисходящая стрелка открывает шорт и закрывает лонг.
   * **WithSignal** меняет трактовку: восходящая стрелка воспринимается как выход из лонга и вход в шорт, то есть торговля ведётся в сторону пробоя канала.
4. Даже без стрелок границы канала используются как сигналы к закрытию позиции, полностью повторяя флаги `SELL_Close` и `BUY_Close`.
5. Закрытия позиций выполняются до открытия новых сделок, чтобы при смене направления сначала обнулить противоположную позицию.
6. Сделки исполняются рыночными заявками (`BuyMarket`/`SellMarket`). При наличии противоположной позиции объём автоматически расширяется, чтобы сначала закрыть текущую экспозицию и только затем открыть позицию в новом направлении.

## Управление рисками
* Встроено опциональное сопровождение стоп-лосса и тейк-профита через пары параметров `UseStopLoss`/`StopLossPoints` и `UseTakeProfit`/`TakeProfitPoints`.
* Расстояния задаются в абсолютных ценовых единицах, что соответствует "пунктам" из MT5.
* Проверка уровней выполняется на каждой закрытой свече по значениям High/Low, чтобы имитировать внутридневное срабатывание.
* Если одновременно активны и стоп, и тейк, приоритет отдаётся стоп-лоссу: позиция закрывается при достижении любого из уровней.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | Свечи H4 | Таймфрейм, на котором вычисляется индикатор XD-RangeSwitch. |
| `Peaks` | 4 | Количество экстремумов в окне (длина анализа) индикатора. |
| `SignalBar` | 1 | Сдвиг по завершённым свечам при чтении буферов индикатора. |
| `TradeDirection` | AgainstSignal | Выбор между контртрендовой и трендовой интерпретацией стрелок. |
| `AllowBuyEntry` / `AllowSellEntry` | true | Разрешение открывать новые позиции соответствующего типа. |
| `AllowBuyExit` / `AllowSellExit` | true | Разрешение закрывать текущие позиции по сигналу индикатора. |
| `UseStopLoss` / `StopLossPoints` | true / 1000 | Включение стоп-лосса и расстояние до него в ценовых пунктах. |
| `UseTakeProfit` / `TakeProfitPoints` | true / 2000 | Включение тейк-профита и расстояние до него в ценовых пунктах. |

## Примечания
* Внутренние буферы по максимумам и минимумам ведутся прямо в стратегии, без дополнительных коллекций, что сохраняет логику MT5 и соответствует требованиям по конверсии.
* Сигналы учитывают только завершённые свечи. При `SignalBar > 0` сделка совершается на следующем баре после того, который сформировал стрелку — так же, как в исходном советнике.
* Объём хранимой истории ограничен максимумом из `Peaks` и `SignalBar`, плюс небольшой запас, поэтому потребление памяти остаётся стабильным на длинных прогонах.
* Стандартные настройки совпадают с MT5: H4, `Peaks = 4`, `SignalBar = 1`, контртрендовый режим и коридор риска 1000/2000 пунктов.
