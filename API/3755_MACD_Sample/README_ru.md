# Стратегия MACD Sample

Стратегия повторяет логику советника MetaTrader 4 «MACD Sample», но реализована на высокоуровневом API StockSharp. Она торгует в обе стороны по одному инструменту, открывает сделки по пересечениям линий MACD в нужной зоне относительно нулевого уровня и подтверждает направление 26-периодной экспоненциальной скользящей средней. Фиксированный тейк-профит и трейлинг-стоп перенесены в модуль защиты `StartProtection`.

## Торговая логика

1. Дождаться не менее 100 завершённых свечей, чтобы индикаторы MACD и EMA набрали историю.
2. Рассчитать стандартный MACD (12, 26, 9) вместе с его сигнальной линией и экспоненциальную среднюю периода `TrendMaPeriod` (по умолчанию 26) для фильтра тренда.
3. **Вход в покупку** — разрешён только при отсутствии позиции. Текущий MACD должен быть ниже нуля, но пересекать сигнальную линию снизу вверх; предыдущее значение MACD находилось ниже сигнальной; абсолютное значение MACD превышает порог `MacdOpenLevel` (в ценовых пунктах), а трендовая EMA растёт.
4. **Вход в продажу** — зеркальное условие: MACD выше нуля, пересекает сигнальную линию сверху вниз, предыдущее значение было выше сигнальной, текущая величина больше `MacdOpenLevel`, EMA снижается.
5. **Выход из покупки** — при обратном пересечении MACD под сигнальную линию в положительной зоне и при значении выше `MacdCloseLevel`. Дополнительно позиция может закрыться по тейк-профиту или трейлинг-стопу.
6. **Выход из продажи** — при пересечении MACD над сигнальной в отрицательной зоне и абсолютном значении выше `MacdCloseLevel`, либо по защитным приказам.

Стратегия одновременно удерживает не более одной позиции. Все заявки — рыночные, объём определяется свойством `Volume`. Защитные уровни автоматически масштабируются под шаг цены инструмента, аналогично константе `Point` в MetaTrader.

## Параметры

| Название | Описание | Значение по умолчанию | Примечания |
| --- | --- | --- | --- |
| `FastEmaPeriod` | Быстрая EMA в MACD. | 12 | Диапазон оптимизации 6…18.
| `SlowEmaPeriod` | Медленная EMA в MACD. | 26 | Диапазон 20…32.
| `SignalPeriod` | Период сигнальной EMA. | 9 | Диапазон 5…13.
| `TrendMaPeriod` | EMA для фильтра направления. | 26 | Диапазон 20…40.
| `MacdOpenLevel` | Порог для входа в MACD (в пунктах). | 3 | Полный аналог `MACDOpenLevel`.
| `MacdCloseLevel` | Порог для выхода в MACD (в пунктах). | 2 | Полный аналог `MACDCloseLevel`.
| `TakeProfitPoints` | Тейк-профит в ценовых пунктах. | 50 | 0 — отключить тейк-профит.
| `TrailingStopPoints` | Трейлинг-стоп в пунктах. | 30 | 0 — отключить трейлинг-стоп.
| `CandleType` | Тип свечей для расчётов. | Таймфрейм 5 минут | Можно выбрать любую свечную серию StockSharp.

## Особенности реализации

- Индикаторы привязаны к подписке на свечи через `BindEx`/`Bind`, поэтому StockSharp сам передаёт готовые значения без ручного буферизования.
- Торговые сигналы проверяются только после `IsFormedAndOnlineAndAllowTrading()`, что исключает сделки во время подкачки истории или при отсутствии соединения.
- Все пороги, выраженные в пунктах, автоматически умножаются на шаг цены инструмента, воспроизводя механику MetaTrader.
- Метод `StartProtection` превращает тейк-профит и трейлинг-стоп в серверные защитные приказы. Любой блок можно отключить, задав параметр равным нулю.
- Журнальные сообщения (`LogInfo`) подробно описывают каждое решение, упрощая сопоставление с оригинальным советником при тестах миграции.

## Рекомендации по применению

- Базовый советник предназначался для форекс-инструментов на внутридневных таймфреймах, поэтому стоит начинать с аналогичных активов.
- При работе с инструментами с экзотическим шагом цены убедитесь, что поле `Security.PriceStep` заполнено; иначе будет использовано значение 1.0.
- Для комплексного риск-менеджмента можно дополнить стратегию внешними модулями StockSharp, например лимитами по портфелю.

## Теги

- Трендовая торговля
- Импульс
- Пересечение MACD
- Интрадей (по умолчанию 5 минут)
- Тейк-профит и трейлинг-стоп
