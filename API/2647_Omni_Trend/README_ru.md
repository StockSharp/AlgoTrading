# Стратегия Omni Trend

## Описание

Omni Trend — это перенос советника MetaTrader "Exp_Omni_Trend" на платформу StockSharp. Алгоритм сочетает скользящую среднюю и волатильностный канал на основе ATR. Как только цена пробивает границу предыдущего канала, стратегия меняет направление торговли, закрывает противоположные позиции и открывает сделку по новому тренду. Реализация сохраняет все ключевые настройки оригинала, включая задержку исполнения (`SignalBar`) и возможность отключать отдельные входы или выходы.

Стратегия подписывается на выбранные свечи и обрабатывает только завершённые бары. Скользящая средняя (`MaType`, `MaLength`, `AppliedPrice`) определяет базовый уровень, а ATR (`AtrLength`) задаёт ширину адаптивных полос через множители `VolatilityFactor` и `MoneyRisk`. Полосы выступают в роли трейлинг-стопов: пересечение верхней полосы переводит систему в бычий режим, нижней — в медвежий. В новом режиме немедленно закрываются противоположные позиции (если разрешено) и, после выдержки `SignalBar`, открывается сделка по направлению тренда.

Дополнительные уровни `StopLossPoints` и `TakeProfitPoints` измеряются в шагах цены инструмента и действуют как жёсткие ограничения убытков/прибыли. Размер позиции задаётся свойством `Volume` (по умолчанию `1`).

## Логика торговли

1. Рассчитать выбранную скользящую среднюю от указанного ценового поля.
2. Рассчитать ATR и построить верхнюю/нижнюю защитные полосы с использованием `VolatilityFactor` и `MoneyRisk`.
3. Если `HighPrice` пробивает предыдущую верхнюю полосу:
   - направление меняется на «вверх»;
   - при активном флаге `EnableSellClose` закрываются все короткие позиции;
   - при активном `EnableBuyOpen` выставляется отложенный сигнал на покупку через `SignalBar` баров.
4. Если `LowPrice` пробивает предыдущую нижнюю полосу:
   - направление меняется на «вниз»;
   - при активном `EnableBuyClose` закрываются длинные позиции;
   - при активном `EnableSellOpen` формируется сигнал на продажу через заданную задержку.
5. Пока тренд сохраняется, противоположные выходы продолжают генерироваться, что обеспечивает постоянное сопровождение позиции, как и в оригинальном советнике.
6. Проверка риск-менеджмента выполняется на каждом закрытом баре: если цена достигает стопа или цели (в шагах цены), позиция закрывается немедленно и сбрасывается цена входа.

Сигналы попадают в очередь FIFO. При `SignalBar = 0` они исполняются на закрытии текущего бара. При значениях больше нуля исполнение переносится на открытие бара, который завершает задержку, имитируя работу MQL5-версии.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Тип/таймфрейм свечей. | 4 часа |
| `MaLength` | Период скользящей средней. | 13 |
| `MaType` | Метод расчёта скользящей (Simple, Exponential, Smoothed, LinearWeighted). | Exponential |
| `AppliedPrice` | Используемая цена: Close, Open, High, Low, Median, Typical, Weighted. | Close |
| `AtrLength` | Период ATR. | 11 |
| `VolatilityFactor` | Множитель ATR при построении канала. | 1.3 |
| `MoneyRisk` | Коэффициент смещения канала от скользящей средней. | 0.15 |
| `SignalBar` | Количество закрытых баров до исполнения сигнала. | 1 |
| `EnableBuyOpen` | Разрешить открытие длинных позиций. | true |
| `EnableSellOpen` | Разрешить открытие коротких позиций. | true |
| `EnableBuyClose` | Разрешить закрытие длинных позиций при медвежьем тренде. | true |
| `EnableSellClose` | Разрешить закрытие коротких позиций при бычьем тренде. | true |
| `StopLossPoints` | Стоп-лосс в шагах цены (0 — отключён). | 1000 |
| `TakeProfitPoints` | Тейк-профит в шагах цены (0 — отключён). | 2000 |
| `Volume` | Размер позиции (свойство стратегии). | 1 |

## Рекомендации

- Значение `SignalBar = 1` повторяет поведение советника: вход выполняется на открытии следующей свечи после появления сигнала. Ноль означает исполнение на закрытии текущего бара.
- Убедитесь, что инструмент имеет корректный `PriceStep`, если используете уровни стопа/цели.
- Встроенный график отображает свечи, выбранную скользящую среднюю и сделки стратегии для визуальной проверки.
- Отключайте отдельные флаги `Enable*`, чтобы ограничить работу только покупками или только продажами либо оставлять закрытие позиций вручную.
- Стратегия отправляет рыночные заявки (`BuyMarket`, `SellMarket`), аналогично тому, как советник выполняет немедленные ордера.

## Состав

- `CS/OmniTrendStrategy.cs` — реализация стратегии.
- `README.md`, `README_ru.md`, `README_cn.md` — документация на трёх языках.

Python-версия сознательно не создавалась согласно заданию.
