# Стратегия HTH Basket

В этой папке размещена реализация на StockSharp высокоуровневого API оригинального советника MetaTrader **HTH.mq4** (Hedge That Hedge). Исходный код открывает корзину из четырёх основных валютных пар сразу после смены торгового дня и управляет позицией через правила на основе пунктов (pips). Перенос повторяет эту логику при помощи подписок на свечи, параметров `StrategyParam` и отдельного состояния по каждому инструменту.

## Торговая идея

1. Трейдер задаёт четыре валютные пары. Первая пара привязывается к свойству стратегии `Security`, оставшиеся три — через параметры `Symbol2`, `Symbol3` и `Symbol4`.
2. Для каждого инструмента подписываются две серии свечей: дневные свечи дают последние два закрытия, минутные свечи (по умолчанию 1 минута) обеспечивают актуальную цену и позволяют определить, наступило ли окно после полуночи.
3. В промежутке с 00:05 по 00:12 (включительно) стратегия проверяет, открыт ли уже дневной набор сделок. Если нет, то рассчитывает знак предыдущей дневной девиации для основной пары (пара 1).
4. Положительная девиация (закрытие day-1 выше закрытия day-2) приводит к открытию трёх длинных ног (пары 1, 2 и 4) и одной короткой (пара 3). Отрицательная девиация зеркально меняет направления. Все сделки используют объём `TradeVolume`, как и в MQL.
5. В течение дня суммарная прибыль корзины в пунктах пересчитывается при каждом закрытии минутной свечи. Когда включён параметр `ShowProfitInfo`, значение выводится в лог и используется для управления рисками.
6. В 23:00 по времени площадки все позиции закрываются, что повторяет поведение оригинального советника.

## Управление корзиной

- **Экстренное удвоение** — если `AllowEmergencyTrading` включён, в начале каждой сессии активируется флаг. Когда просадка корзины опускается ниже `-EmergencyLossPips` и существует прибыльная нога, она удваивается (добавляется позиция того же объёма и направления). Процедура срабатывает только один раз в день, аналогично функции `doubleorders()` в MQL.
- **Цель по прибыли** — при активированном `UseProfitTarget` и достижении `ProfitTargetPips` все сделки закрываются.
- **Ограничение убытка** — при активированном `UseLossLimit` и падении суммы пунктов ниже `-LossLimitPips` корзина ликвидируется.
- Все перечисленные действия выполняются только тогда, когда `ShowProfitInfo` истинно, что полностью соответствует проверке `show_profit` в исходном коде.

Каждую минуту по основной паре в лог пишется сообщение "Deviation snapshot" со следующей информацией:

- текущие и предыдущие дневные девиации по каждому из четырёх инструментов;
- девиации по шести комбинациям пар (суммы/разности), как в выводе `Comment()` у MQL-версии;
- последняя суммарная прибыль корзины в пунктах.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TradeEnabled` | true | Разрешает открывать корзину в дневном окне. |
| `ShowProfitInfo` | true | Записывает прибыль в пунктах и активирует правила управления риском. |
| `UseProfitTarget` | false | Закрывает корзину при достижении `ProfitTargetPips`. |
| `UseLossLimit` | false | Закрывает корзину при просадке ниже `-LossLimitPips`. |
| `AllowEmergencyTrading` | true | Включает механизм экстренного удвоения. |
| `EmergencyLossPips` | 60 | Просадка (в пунктах), запускающая удвоение. |
| `ProfitTargetPips` | 80 | Порог прибыли (в пунктах), после которого позиции закрываются. |
| `LossLimitPips` | 40 | Порог убытка (в пунктах), после которого корзина закрывается. |
| `TradeVolume` | 0.01 | Объём каждой ноги. |
| `Symbol2` | — | Вторая валютная пара (в оригинале USDCHF). |
| `Symbol3` | — | Третья валютная пара (в оригинале GBPUSD). |
| `Symbol4` | — | Четвёртая валютная пара (в оригинале AUDUSD). |
| `IntradayCandleType` | 1 минута | Период свечей для окна времени и обновления цен. |

## Особенности реализации

- Для каждого инструмента используются две подписки на свечи: минутные — для отслеживания времени и расчёта прибыли, дневные — для девиаций. Все подписки создаются через `Bind`, чтобы соответствовать правилам конверсии.
- Класс `InstrumentState` хранит последнюю цену, два последних дневных закрытия, среднюю цену входа и текущий объём позиции по инструменту. Это позволяет пересчитывать пункты без обращения к дополнительным коллекциям.
- Перевод прибыли в пункты осуществляется через `PriceStep` инструмента (при отсутствии берётся `MinPriceStep`), что повторяет деление на `MODE_POINT` в MQL.
- Стратегия реагирует только на **завершённые** свечи, поэтому внутрисвечные тики игнорируются.
- Экстренный флаг сбрасывается при открытии новой корзины. После выполнения удвоения флаг выключается до следующей сессии, что полностью соответствует поведению переменной `enable_emergency_trading` в советнике.
