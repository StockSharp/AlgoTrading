# Стратегия Risk Fixed Margin
[English](README.md) | [中文](README_cn.md)

Стратегия является портом скрипта MetaTrader 5 `risk (barabashkakvn's edition).mq5`. Оригинальный эксперт не открывает сделки – он рассчитывает, каким объёмом можно войти в позицию при фиксированном проценте риска от свободной маржи. Реализация на StockSharp сохраняет эту идею: стратегия подписывается на котировки Level 1, оценивает доступный капитал и выводит подробные рекомендации по объёму для покупок и продаж.

## Общее описание

- **Назначение:** контроль загрузки свободной маржи и преобразование её в рекомендуемые объёмы для длинных и коротких позиций.
- **Тип данных:** только поток Level 1 (лучшие bid/ask) по выбранному инструменту.
- **Торговля:** стратегия не отправляет заявки и служит исключительно информационным модулем.
- **Вывод:** периодические сообщения в лог с рассчитанными объёмами и текущими показателями счёта.

## Параметр

| Название | Описание | Значение по умолчанию |
| -------- | -------- | --------------------- |
| `Risk %` | Процент от свободной маржи, который допускается задействовать в новой позиции. | `5` |

## Логика работы

1. При старте стратегия подписывается на Level 1, чтобы получать обновления по лучшим ценам. Дополнительные свечи или индикаторы не требуются.
2. Каждое поступившее сообщение обновляет сохранённые bid/ask. Как только известна хотя бы одна сторона книги заявок, строится отчёт.
3. Отчёт приближённо вычисляет показатели счёта:
   - **Equity** использует `Portfolio.CurrentValue` – текущую стоимость портфеля.
   - **Balance** оценивается как `equity - PnL`, что удаляет нереализованную прибыль стратегии и приближает значение к балансу MetaTrader.
   - **Free margin** рассчитывается как разница между equity и номиналом открытой позиции (`abs(Position) * mid price`). Средняя цена берётся как полусумма bid/ask (или известная сторона, если вторая отсутствует).
4. Свободная маржа умножается на параметр `Risk %`, формируя денежный лимит риска.
5. Для покупки и продажи вычисляется «сырой» объём `risk / price`, после чего он нормализуется вниз к ближайшему шагу объёма (`Security.VolumeStep`). Это повторяет проверку `CTrade.CheckVolume` из MQL.
6. В лог отправляется пять строк: первая отображает процент риска, две следующие описывают длинное направление, две последние – короткое. Новая запись появляется только при изменении значений, чтобы не захламлять журнал.

## Пример вывода

```
5% risk of free margin
Check open BUY: 0.42, Balance: 10000.00, Equity: 10050.00, FreeMargin: 9950.00
trade BUY, volume: 0.40
Check open SELL: 0.41, Balance: 10000.00, Equity: 10050.00, FreeMargin: 9950.00
trade SELL, volume: 0.40
```

Такой блок показывает как максимальный теоретический объём (`Check open ...`), так и объём, скорректированный под шаг (`trade ...`).

## Отличия от версии MetaTrader

- В StockSharp доступны иные поля портфеля, поэтому баланс и свободная маржа рассчитываются на основе `Portfolio.CurrentValue`, реализованного PnL и номинала текущей позиции.
- Класс `CMoneyFixedMargin` заменён явными вычислениями. Риск по‑прежнему задаётся как процент от свободных средств, но формулы легко адаптировать под свои правила.
- В StockSharp нет точного аналога `CTrade.CheckVolume`, поэтому нормализация ограничивается округлением вниз к шагу объёма. При необходимости можно добавить ограничения брокера (максимальный лот, уровни маржи и т.д.).
- Вместо функции `Comment` используется `LogInfo`, поэтому результаты видны в журнале стратегий в Designer/Runner.

## Рекомендации по использованию

1. Привяжите стратегию к реальному портфелю и инструменту с корректными параметрами шага цены и шага объёма.
2. Настройте `Risk %` в соответствии с рисковым профилем. Помните, что при высоких значениях и сильном плече теоретический объём может стать очень большим.
3. Для дополнительных ограничений (жёсткий лимит на объём, контроль маржи и т.п.) расширьте методы `CalculateVolumes` или `NormalizeVolume`.
4. Стратегия не совершает сделок автоматически – объединяйте её с торговыми алгоритмами или применяйте рекомендации вручную.
