# Стратегия Stat Euclidean Metric

## Обзор
Стратегия повторяет логику советника MetaTrader `Stat_Euclidean_Metric.mq4`. Она отслеживает развороты линии MACD на выбранном инструменте и таймфрейме. В базовом режиме стратегия сразу открывает позицию по сигналу, а в основном режиме сравнивает текущие рыночные условия с историческими векторами признаков из бинарных файлов и принимает решение на основе алгоритма k ближайших соседей.

## Торговая логика
1. Подписка на свечи заданного типа и расчёт MACD по типичной цене ((High + Low + Close) / 3).
2. Фиксация медвежьего разворота, когда для трёх последних завершённых свечей выполняется `MACD[2] <= MACD[1]` и `MACD[1] > MACD[0]`.
3. Фиксация бычьего разворота, когда `MACD[2] >= MACD[1]` и `MACD[1] < MACD[0]`.
4. Реакция на сигнал зависит от режима:
   - **TrainingMode = true** — открытие рыночной позиции по направлению разворота (при необходимости сначала закрывается текущая позиция).
   - **TrainingMode = false** — расчёт пяти отношений простых скользящих средних типичной цены, оценка вероятности успеха по k-NN и открытие сделок только при выполнении порогов.
5. Подключение встроенной защиты `StartProtection`, которая автоматически добавляет стоп-лосс и тейк-профит в шагах цены.

## Признаки для классификатора
Вектор признаков формируется на только что закрытой свече и включает:
- SMA(89) / SMA(144)
- SMA(144) / SMA(233)
- SMA(21) / SMA(89)
- SMA(55) / SMA(89)
- SMA(2) / SMA(55)

Каждая запись в файлах содержит шесть значений типа `double`: пять отношений и метку (`0` — неудачная сделка, `1` — успешная). При вычислении стратегии выбирается `NeighborCount` ближайших записей, после чего среднее по меткам трактуется как вероятность успеха.

## Файлы данных
- `BuyDatasetPath` — путь к бинарному файлу с векторами после покупок.
- `SellDatasetPath` — путь к бинарному файлу с векторами после продаж.

Относительные пути приводятся к `Environment.CurrentDirectory`. Отсутствие файлов фиксируется в журнале и трактуется как пустой набор. Текущая реализация только читает файлы и не добавляет новые записи автоматически; при работе в учебном режиме экспорт векторов необходимо выполнять вручную.

## Параметры
- **TrainingMode** — выбор между чистой логикой MACD и режимом с классификатором.
- **BuyThreshold / SellThreshold** — минимальная вероятность для открытия позиции по сигналу.
- **AllowInverseEntries** — разрешение на контртрендовые сделки при очень низкой вероятности.
- **InverseBuyThreshold / InverseSellThreshold** — максимальная вероятность, при которой открывается противоположная сделка.
- **FastLength / SlowLength / SignalLength** — периоды EMA в MACD.
- **TakeProfitPoints / StopLossPoints** — расстояние до тейк-профита и стоп-лосса в шагах цены.
- **ClosePositionsOnSignal** — закрывать ли текущую позицию перед новой заявкой.
- **BuyDatasetPath / SellDatasetPath** — пути к бинарным файлам с обучающими данными.
- **NeighborCount** — количество соседей в голосовании k-NN.
- **CandleType** — тип свечей для всех расчётов.

## Рекомендации по использованию
- Перед запуском режима с классификатором укажите корректные пути к файлам данных (абсолютные или относительные).
- Для пополнения базы данных запустите стратегию в учебном режиме на исторических данных и сохраните признаки вручную.
- Оптимизируйте пороги и количество соседей, чтобы адаптировать модель к различным инструментам.
- Контролируйте параметр `Volume`: при смене направления стратегия выставляет заявку объёмом `Volume + |Position|`, чтобы мгновенно перевернуться.

## Отличия от версии MQL4
- Данные классификатора только читаются. В оригинальном советнике новые записи добавлялись при завершении работы, здесь файлы нужно обновлять самостоятельно.
- Защита позиции реализована через `StartProtection`, а не через параметры `OrderSend`.
- В классификационном режиме при включённом `ClosePositionsOnSignal` стратегия полностью закрывает позицию перед новым сигналом. В MQL4-скрипте закрывались только прибыльные ордера.
