# MACD and SAR
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет исходный советник MetaTrader «MACD and SAR». На каждом завершённом баре она оценивает соотношение между основной и сигнальной линиями MACD, а также положение уровня Parabolic SAR. Для каждого сравнения предусмотрен переключатель, позволяющий инвертировать условие и применять шаблон как в трендовой, так и в контртрендовой логике. Допускается набор нескольких позиций при условии, что их общее количество не превышает заданный лимит.

При появлении сигнала на покупку существующий короткий объём закрывается и добавляется новый лот в длинную сторону (если не достигнут предел по количеству позиций). Аналогично при сигнале на продажу сначала закрываются лонги, после чего открывается короткий лот. Отдельные стоп-лоссы и тейк-профиты не используются — выход происходит только при появлении противоположного сигнала.

## Логика работы

1. Ожидать формирования очередной свечи выбранного таймфрейма.
2. Считать значения MACD (основная, сигнальная линии и гистограмма) и текущий уровень Parabolic SAR по ценам закрытия.
3. Проверить три сравнения, каждое из которых можно перевернуть соответствующим логическим параметром:
   - Основная линия MACD относительно сигнальной.
   - Сигнальная линия MACD относительно нулевого уровня.
   - Уровень Parabolic SAR относительно цены закрытия.
4. Если все три условия для лонга выполняются и лимит по количеству позиций не исчерпан, открыть покупку указанным объёмом (с учётом объёма, необходимого для закрытия шортов).
5. Если все три условия для шорта выполняются и остаётся доступный лимит, открыть продажу указанным объёмом (включая объём для закрытия лонгов).

## Параметры

- `TradeVolume` — объём одной сделки (по умолчанию `0.1`).
- `MaxPositions` — максимальное количество одновременно набранных позиций в одном направлении (по умолчанию `10`).
- `MacdFastPeriod` — период быстрой EMA в MACD (по умолчанию `12`).
- `MacdSlowPeriod` — период медленной EMA в MACD (по умолчанию `26`).
- `MacdSignalPeriod` — период сглаживания сигнальной линии MACD (по умолчанию `9`).
- `SarStep` — шаг ускорения Parabolic SAR (по умолчанию `0.02`).
- `SarMaximum` — максимальное ускорение Parabolic SAR (по умолчанию `0.2`).
- `BuyMacdGreaterSignal` — при `true` требуется MACD main > signal для покупок, иначе ожидается обратное (по умолчанию `true`).
- `BuySignalPositive` — при `true` требуется MACD signal > 0 для покупок, иначе ожидается значение < 0 (по умолчанию `false`).
- `BuySarAbovePrice` — при `true` требуется SAR выше цены для покупок, иначе цена должна быть выше SAR (по умолчанию `false`).
- `SellMacdGreaterSignal` — при `true` требуется MACD main > signal для продаж, иначе main < signal (по умолчанию `false`).
- `SellSignalPositive` — при `true` требуется MACD signal > 0 для продаж, иначе сигнал < 0 (по умолчанию `true`).
- `SellSarAbovePrice` — при `true` требуется SAR выше цены для продаж, иначе цена должна быть выше SAR (по умолчанию `true`).
- `CandleType` — тип/таймфрейм свечей, используемых для расчётов (по умолчанию 15-минутные свечи).

## Дополнительные замечания

- Стратегия полностью полагается на пересечения индикаторов и не использует защитные стопы или цели по прибыли.
- Контроль лимита позиций выполняется через сравнение абсолютного объёма позиции с `MaxPositions * TradeVolume` с небольшим допуском на округление.
- Все заявки отправляются по рынку, поэтому убедитесь, что торговый объём соответствует инструменту и брокерским ограничениям.
- При необходимости ограничения просадки или трейлинг-стопы можно добавить через стандартные механизмы защиты портфеля StockSharp; в базовой версии они отсутствуют.

