# 检查未平仓订单策略

## 概述
检查未平仓订单策略是 MetaTrader 4 专家顾问 *Check_Open_Orders.mq4* 的 StockSharp 版本。原始脚本主要用于示范：
它在启动后立即发送几笔市价单，并通过图表注释提示当前是否存在符合选项的未平仓交易（全部、多头或空头）。
移植后的 StockSharp 策略保留了这一教学用途，同时利用框架的高级 API 完成订单提交、持仓监控与状态记录。

启动时策略会根据标的的最小、最大及步长限制调整下单手数，随后订阅一级行情，并按照
`WaitTimeMilliseconds` 设置的间隔异步发送两笔买单与一笔卖单。每次成交后都会输出一条
与原始 `Comment()` 文本相呼应的日志，说明当前监控模式以及是否仍有符合条件的持仓。若行情中包含买卖价，
还会为每笔示范交易自动设置止损与止盈。

## 交易逻辑
1. 读取参数并根据品种的手数限制调整 `TradeVolume`。
2. 订阅一级行情，以便获取最新买卖价用于构建保护性委托。
3. 启动异步流程：按照配置的毫秒延迟依次发送两笔买单和一笔卖单。
4. 每次下单后，利用最近成交价或最新买卖价计算参考价格，并调用 `SetStopLoss`、`SetTakeProfit`
   以点数为单位设置保护性止损与止盈。
5. 在收到新的成交或持仓变化时重新生成状态文本，指出当前模式 (`Mode`) 以及是否存在满足条件的未平仓单。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `TradeVolume` | `decimal` | `0.01` | 示范订单的手数，会自动贴合品种允许的范围与步长。 |
| `StopLossPoints` | `decimal` | `100` | 每笔示范订单使用的止损点数。 |
| `TakeProfitPoints` | `decimal` | `400` | 每笔示范订单使用的止盈点数。 |
| `SlippagePoints` | `decimal` | `7` | 以点数表示的滑点缓冲，会转换成价格赋值给 `Strategy.Slippage`。 |
| `WaitTimeMilliseconds` | `int` | `2000` | 连续下单之间的等待毫秒数。 |
| `Mode` | `CheckOpenOrdersMode` | `CheckAllTypes` | 控制状态提示是检查全部仓位、仅多头或仅空头。 |

`CheckOpenOrdersMode` 枚举包含以下选项：
- `CheckAllTypes`：只要净仓位不为零即返回“是”。
- `CheckOnlyBuy`：仅在净仓位为正（多头）时返回“是”。
- `CheckOnlySell`：仅在净仓位为负（空头）时返回“是”。

## 与 MetaTrader 版本的差异
- StockSharp 天生按策略划分订单与持仓，因此无需依赖 MetaTrader 的 `MagicNumber`；策略只检查自身的净仓位。
- 使用最新的一级行情价格调用 `SetStopLoss`/`SetTakeProfit`。如果暂时缺少买卖价，策略会跳过保护单并给出警告，
  而不是直接引用 `Bid`/`Ask` 全局变量。
- 下单间隔通过 `Task.Delay` 实现，避免像 `Sleep()` 那样阻塞主线程。
- 状态信息通过 `AddInfoLog` 输出至日志和 Designer 界面，而不是图表注释。

## 使用说明
- 建议连接能够提供一级行情的数据源，否则示范订单仍会成交，但无法自动设置止损止盈。
- 策略基于净仓位判断是否存在持仓，若账户允许多空同时存在，则会按照多空合并后的净头寸进行报告。
- 默认参数与原始脚本一致，可在经纪商要求更长间隔时上调 `WaitTimeMilliseconds`。
- 本策略主要用于学习范例，若要在生产策略中复用，请移除示范性的下单流程，并根据需求扩展逻辑。
