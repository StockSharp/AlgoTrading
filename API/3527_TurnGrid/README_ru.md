# Стратегия TurnGrid

## Общее описание

**TurnGrid** — это перенос оригинального эксперта `TurnGrid.mq5` с платформы MQL5. Стратегия строит симметричную ценовую сетку вокруг текущего уровня и при каждом переходе цены через новую границу по очереди открывает длинные и короткие позиции. Таким образом поддерживается сбалансированный портфель до тех пор, пока доходность счёта не достигнет заданного ориентира.

При портировании использован высокоуровневый API StockSharp: обновление сетки выполняется по завершённым свечам, рыночные заявки отвечают за открытие и закрытие позиций, а риск-параметры вынесены в свойства стратегии. Комментарии даны на английском языке в соответствии с требованиями репозитория.

## Логика торговли

1. После запуска стратегия получает цену закрытия последней свечи и формирует сетку из `4 * GridShares` уровней. Центральный уровень фиксируется на текущей цене, верхние уровни масштабируются множителем `1 + GridDistance`, нижние — `1 - GridDistance`.
2. В центре сетки исполняется стартовая рыночная покупка. Объём рассчитывается исходя из доли капитала `Balance / GridShares` и ступенчатой формулы из MQL-версии.
3. Каждая завершённая свеча обновляет индекс активного уровня. Если индекс изменился:
   - Закрываются позиции, прикреплённые к уровню на два шага от текущего: длинные — через продажу, короткие — через покупку.
   - На активном уровне открываются недостающие направления. Если уровень пуст, стратегия выбирает направление с меньшим количеством открытых позиций, чтобы сохранить симметрию.
4. Оценка комиссий ведётся через параметр `FeeRate`: каждая сделка добавляет приблизительную стоимость комиссии в накопительный счётчик.
5. Когда собственный капитал счёта (за вычетом накопленных комиссий) превышает стартовый баланс на `EquityTakeProfit`, стратегия закрывает текущую чистую позицию и перестраивает сетку вокруг последней цены.

## Параметры

| Название | Описание | Значение по умолчанию |
| --- | --- | --- |
| `GridDistance` | Относительное расстояние между соседними уровнями сетки. | `0.01` |
| `GridShares` | Максимальное количество одновременно активных ячеек сетки. | `50` |
| `EquityTakeProfit` | Рост капитала, необходимый для сброса сетки. | `0.02` |
| `FeeRate` | Оценочный коэффициент комиссии за сделку. | `0.0008` |
| `CandleType` | Тип свечей, используемый для расчётов. | Таймфрейм 1 минута |

## Особенности реализации

- Подписка на данные выполняется через `SubscribeCandles(CandleType)`, обрабатываются только свечи в состоянии `Finished`, что делает поведение совместимым с событийной моделью StockSharp.
- Состояние сетки хранится в массиве структур `GridLevel`, содержащих цену уровня, флаги наличия позиций и объёмы для отложенного закрытия.
- Формула объёма заявок повторяет оригинальный алгоритм распределения капитала и дополнительно нормализуется по `VolumeStep`, `VolumeMin` и `VolumeMax` инструмента.
- При достижении целевой доходности стратегия сначала закрывает чистую позицию (`TryCloseNetPosition`), затем инициализирует сетку заново, обеспечивая чистый переход между торговыми циклами.

## Файлы

- `CS/TurnGridStrategy.cs` – реализация стратегии на C# с использованием высокоуровневого API StockSharp.
- `README.md` – документация на английском языке.
- `README_cn.md` – документация на китайском языке.
- `README_ru.md` – документация на русском языке (этот файл).
