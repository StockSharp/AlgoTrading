# TurnGrid 策略

## 概述

**TurnGrid 策略** 复刻自原始的 MQL5 专家顾问 `TurnGrid.mq5`。策略会在当前价格附近搭建对称的价格网格，当价格穿越网格线时交替开仓多头与空头，从而在整个震荡区间内保持动态平衡的持仓组合，直到账户权益达到设定的目标值。

本次移植使用 StockSharp 的高级 API：通过蜡烛线订阅驱动网格更新，市价单用于开平仓，风险管理以参数形式暴露。所有注释均采用英文，命名风格遵循 StockSharp 规范。

## 交易逻辑

1. 策略启动时获取最新蜡烛的收盘价，基于该价格构建包含 `4 * GridShares` 个层级的网格。中心层级使用当前价格，上方层级按 `1 + GridDistance` 递增，下方层级按 `1 - GridDistance` 递减。
2. 在网格中心立即买入一笔市价单。成交量来源于可用资金 (`Balance / GridShares`)，再叠加 MQL 原版中的逐步加仓公式。
3. 每根完成的蜡烛都会根据收盘价更新当前所在的网格索引。一旦索引发生变化：
   - 关闭距离当前索引两个层级的挂钩仓位：位于价格下方的买单通过卖出平仓，位于价格上方的卖单通过买入平仓。
   - 为当前层级补充缺失方向的仓位。如果多空都为空，则优先补充仓位数量较少的方向，以保持多空平衡。
4. 通过 `FeeRate` 参数对手续费进行估算，每次成交都会把估算的手续费累加到运行中的费用统计。
5. 当账户权益减去累计费用后超过初始余额的 `EquityTakeProfit` 比例时，策略会平掉当前净头寸，并以最新价格为中心重建网格。

## 参数

| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `GridDistance` | 相邻网格层级之间的相对价格距离。 | `0.01` |
| `GridShares` | 网格允许的最大持仓数量。 | `50` |
| `EquityTakeProfit` | 触发网格重置所需的权益增幅。 | `0.02` |
| `FeeRate` | 每笔交易的手续费估算系数。 | `0.0008` |
| `CandleType` | 用于驱动策略的蜡烛线类型。 | 1 分钟周期 |

## 实现细节

- 通过 `SubscribeCandles(CandleType)` 订阅蜡烛线，仅处理状态为 `Finished` 的蜡烛，从而在保持逻辑一致性的同时兼容 StockSharp 事件模型。
- 网格状态保存在轻量级的 `GridLevel` 结构体数组中，包含价格锚点、持仓标志以及延迟平仓所需的成交量信息。
- 下单手数沿用原始 EA 的资金分配公式，并结合交易标的的 `VolumeStep`、`VolumeMin`、`VolumeMax` 做归一化处理。
- 当权益条件满足时，策略先通过 `TryCloseNetPosition` 平掉净头寸，再重建网格，确保不同交易周期之间的衔接干净整洁。

## 文件

- `CS/TurnGridStrategy.cs` – 使用 StockSharp 高级 API 实现的策略代码。
- `README.md` – 英文说明。
- `README_cn.md` – 简体中文说明（本文）。
- `README_ru.md` – 俄文说明。
