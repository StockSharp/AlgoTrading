# Стратегия Parabolic SAR First Dot

## Обзор
**Parabolic SAR First Dot Strategy** — это конвертация MetaTrader-советника `pSAR_bug_4` из папки `MQL/9954` на высокоуровневый API StockSharp. Система реагирует на самый первый разворот Parabolic SAR на противоположную сторону цены. Когда точки SAR перемещаются под цену закрытия, открывается длинная позиция; если точки оказываются над закрытием, открывается короткая сделка. Каждая позиция защищена фиксированными стоп-лоссом и тейк-профитом, выраженными в «пунктах» Parabolic SAR по аналогии с оригиналом.

## Логика торговли
1. **Подготовка данных и индикатора**. Стратегия подписывается на настраиваемый тип свечей (по умолчанию 15-минутные) и привязывает индикатор Parabolic SAR с заданными коэффициентами ускорения.
2. **Отслеживание состояния**. На первой завершённой свече фиксируется, находится ли SAR выше или ниже закрытия. На последующих свечах новое положение сравнивается с предыдущим.
3. **Правила входа**.
   - **Покупка**: SAR переходит сверху цены закрытия вниз. Любая открытая короткая позиция закрывается, затем отправляется рыночная заявка на покупку с заданным объёмом.
   - **Продажа**: SAR переходит снизу вверх. Любая длинная позиция закрывается, после чего открывается короткая позиция.
4. **Защитные уровни**. После входа рассчитываются уровни стоп-лосса и тейк-профита на основе цены закрытия свечи. Расстояние берётся как `StopLossPoints` или `TakeProfitPoints`, умноженные на шаг цены инструмента (`PriceStep`). Если параметр `UseStopMultiplier` активен (поведение MetaTrader по умолчанию), расстояние дополнительно умножается на 10 для учёта дробных пунктов.
5. **Правила выхода**. На каждой завершённой свече стратегия проверяет максимум и минимум. При пробое стоп-лосса или тейк-профита позиция закрывается рыночной заявкой. При появлении противоположного сигнала SAR выполняется разворот — объём ордера выбирается так, чтобы закрыть текущую позицию и открыть новую в противоположную сторону.

## Управление рисками
- Для каждой новой позиции пересчитываются уровни защитных приказов.
- Если инструмент не предоставляет шаг цены, используется консервативное значение `0.0001`, чтобы избежать нулевых расстояний.
- Перед любым действием вызывается `IsFormedAndOnlineAndAllowTrading()`, что гарантирует готовность подписок и разрешение на торговлю.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `TradeVolume` | `0.1` | Объём заявки для новых позиций, синхронизируется со свойством `Strategy.Volume`. |
| `StopLossPoints` | `90` | Дистанция стоп-лосса в пунктах Parabolic SAR, переводится в цену через `PriceStep` (и умножается на 10 при активном `UseStopMultiplier`). |
| `TakeProfitPoints` | `20` | Дистанция тейк-профита в пунктах Parabolic SAR. |
| `UseStopMultiplier` | `true` | При включении умножает расстояние до стопа и тейка на 10, воспроизводя переключатель `StopMult` оригинального советника. |
| `SarAccelerationStep` | `0.02` | Начальный коэффициент ускорения для Parabolic SAR. |
| `SarAccelerationMax` | `0.2` | Максимальный коэффициент ускорения индикатора Parabolic SAR. |
| `CandleType` | `15-минутный таймфрейм` | Тип свечей, используемый для расчётов и сигналов. |

## Особенности конвертации
- В MetaTrader стоп-лосс и тейк-профит выставлялись брокеру. В StockSharp они воспроизводятся за счёт мониторинга максимумов и минимумов свечей и отправки рыночных заявок при достижении порога.
- Перемножение расстояний на 10 при активном `StopMult` сохранено параметром `UseStopMultiplier`, что важно для брокеров с дробными пунктами.
- Используется только высокоуровневый API (`SubscribeCandles`, `Bind`, `BuyMarket`, `SellMarket`), как того требуют правила проекта. Python-версия специально не создавалась согласно задаче.
