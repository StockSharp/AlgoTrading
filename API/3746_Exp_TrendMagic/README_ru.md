# Стратегия Exp TrendMagic

## Общее описание
Exp TrendMagic — это точная конверсия эксперта MetaTrader 5 «Exp_TrendMagic». Стратегия отслеживает смену цвета индикатора TrendMagic, который объединяет CCI (Commodity Channel Index) и ATR (Average True Range). При изменении цвета закрываются позиции противоположного направления и, при разрешении, открывается сделка по новому тренду.

Перенос сохраняет все параметры управления капиталом, сдвиг сигнальной свечи (`Signal Bar`) и набор флагов, регулирующих открытия и закрытия длинных/коротких позиций.

## Логика работы
1. **Индикаторы**
   - `CCI` с настраиваемым периодом и типом цены.
   - `ATR` с настраиваемым периодом.
   - Расчёт TrendMagic:
     - При CCI ≥ 0: `TrendMagic = Low - ATR` с ограничением, чтобы линия поддержки не снижалась.
     - При CCI < 0: `TrendMagic = High + ATR` с ограничением, чтобы линия сопротивления не росла.
   - Цвет линии: **0** — бычий режим (поддержка ниже цены), **1** — медвежий режим (сопротивление выше цены).

2. **Определение сигналов**
   - Цвета индикатора складываются в буфер, воспроизводящий работу MT5, а чтение значений сдвигается на `Signal Bar`.
   - Если цвет на предыдущей свече (`Signal Bar + 1`) равен **0**, а на текущей (`Signal Bar`) равен **1**, стратегия закрывает короткие позиции и, при разрешении, открывает длинную.
   - Если предыдущий цвет **1**, а текущий **0**, закрываются длинные позиции и, при необходимости, открывается короткая.
   - Флаги `Allow Buy/Sell Entry` и `Allow Buy/Sell Exit` полностью повторяют семантику оригинального эксперта.

3. **Управление капиталом**
   - `Money Management` задаёт долю капитала, используемую на сделку. Отрицательное значение трактуется как фиксированный объём.
   - `Margin Mode` определяет способ перевода значения в объём заявки:
     - `FreeMargin` / `Balance` — доля свободных средств или баланса делится на цену.
     - `LossFreeMargin` / `LossBalance` — доля капитала, допускаемая к риску, делится на величину стоп-лосса.
     - `Lot` — фиксированный объём.
   - Результирующий объём приводится к шагу, минимуму и максимуму инструмента.

4. **Риск-менеджмент**
   - После открытия позиции запоминается цена входа и применяется стоп-лосс/тейк-профит в пунктах (кратных `PriceStep`).
   - При достижении уровней позиция закрывается немедленно, а сохранённая цена сбрасывается.
   - Встроенная задержка запрещает повторное открытие сделки того же направления до следующей свечи, повторяя MQL-функцию `TradeTimeLevel`.

## Параметры
| Параметр | Описание |
|----------|----------|
| `Money Management` | Доля капитала или фиксированный объём при отрицательном значении. |
| `Margin Mode` | Метод пересчёта доли капитала в объём. |
| `Stop Loss` | Дистанция стоп-лосса в пунктах. |
| `Take Profit` | Дистанция тейк-профита в пунктах. |
| `Deviation` | Параметр для совместимости с MT5 (в StockSharp не используется напрямую). |
| `Allow Buy/Sell Entry` | Разрешение на открытие длинных/коротких позиций. |
| `Allow Buy/Sell Exit` | Разрешение на закрытие коротких/длинных позиций. |
| `Candle Type` | Тип свечей, используемых для расчётов. |
| `CCI Period` / `CCI Price` | Период и тип цены для CCI. |
| `ATR Period` | Период ATR. |
| `Signal Bar` | Номер завершённой свечи, по которой считывается сигнал. |

## Дополнительные замечания
- Стратегия работает только с закрытыми свечами (`CandleStates.Finished`), как и оригинальная версия на MT5.
- При перезапуске все индикаторы и внутренние переменные сбрасываются, что обеспечивает повторяемость оптимизации.
- Параметр `Deviation` оставлен для соответствия интерфейсу MT5, хотя в StockSharp он не влияет на размещение заявок.
