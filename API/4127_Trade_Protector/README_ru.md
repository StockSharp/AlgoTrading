# Стратегия Trade Protector

## Обзор
Стратегия представляет собой точный перенос советника MetaTrader 4 "trade_protector-1_0" на StockSharp. Скрипт не генерирует сигналы: он непрерывно отслеживает уже открытые позиции и подстраивает защитные приказы в зависимости от движения цены. Порт сохраняет это поведение, работая поверх потока level1, поэтому его можно подключать к любому вручную торгуемому инструменту или к другой стратегии, которая выставляет сделки. Все дистанции задаются в пунктах, как и в оригинальном MQL-коде.

## Логика работы
- На каждом обновлении level1 фиксируются свежие bid/ask и проверяется наличие позиции. Если позиции нет, стратегия просто ждёт.
- Для длинных позиций рассчитываются до трёх кандидатов на стоп-лосс: текущий стоп, пропорциональный стоп, завязанный на плавающую прибыль, и классический трейлинг. Пропорциональный стоп вычисляется как `entry + ratio * (bid - entry) - spread`, когда прибыль превысила `ProportionalThresholdPips`. Трейлинг удерживает стоп на расстоянии `TrailingStopPips` от bid, пока цена находится рядом со входом (`bid < entry + 4 * spread`).
- Из всех кандидатов выбирается максимальный. Перед выставлением ордер немного сдвигается ниже текущего bid на один тик, чтобы избежать мгновенного исполнения.
- Короткие позиции используют зеркальную схему. Пропорциональный стоп рассчитывается как `entry - ratio * (entry - ask) + spread`, а трейлинг размещается на `ask + TrailingStopPips + spread`, когда рынок близок к точке входа. Стоп всегда удерживается выше ask.
- Блок escape повторяет режим "эвакуации" из MetaTrader. Если длинная позиция ушла в просадку глубже `EscapeLevelPips` (плюс пять тиков), выставляется тейк-профит `entry + EscapeTakeProfitPips`. Для короткой позиции тейк ставится на `entry - EscapeTakeProfitPips` после симметричной просадки. Отрицательные значения тейка разрешены — это позволяет закрываться по приемлемому убытку.
- При каждом пересчёте уровней стопы и тейки пере-регистрируются. Если цена или объём изменились, активные приказы отменяются, чтобы на бирже всегда оставался только один защитный ордер каждого типа.

## Параметры
| Параметр | Описание |
| --- | --- |
| `TrailingStopPips` | Базовое расстояние трейлинг-стопа в пунктах. |
| `ProportionalThresholdPips` | Минимальная плавающая прибыль (в пунктах), необходимая для расчёта пропорционального стопа. |
| `ProportionalRatio` | Доля текущей прибыли, используемая при расчёте пропорционального стоп-лосса. |
| `UseEscape` | Включает логику escape и соответствующий тейк-профит. |
| `EscapeLevelPips` | Просадка в пунктах, после которой активируется escape. Значение 0 повторяет поведение оригинала (срабатывание после пяти тиков убытка). |
| `EscapeTakeProfitPips` | Расстояние от входа до escape-тейк-профита. Может быть отрицательным для фиксации уменьшенного убытка. |
| `EnableDetailedLogging` | При включении стратегия пишет информационные сообщения при каждом перемещении защитных приказов. |

## Особенности переноса
- Преобразование пунктов выполнено через скорректированное значение `Point`, включая обработку трёх- и пятизнаковых котировок. То же значение применяется в блоке escape, чтобы пороги полностью совпадали с MQL.
- Стратегия работает исключительно с level1-данными, повторяя бесконечный цикл `start()` без использования свечей и индикаторов.
- Защитные приказы выставляются через высокоуровневые методы StockSharp (`BuyStop`, `SellStop`, `BuyLimit`, `SellLimit`), что отражает идею оригинала о модификации существующих заявок и остаётся в рамках idiomatic StockSharp.
- Файловый лог из MQL заменён на опциональные вызовы `LogInfo`, управляемые параметром `EnableDetailedLogging`. Это упрощает код и одновременно даёт подробную диагностику при тестировании.
- После срабатывания escape тейк-профит не удаляется, полностью повторяя поведение MetaTrader, где цель остаётся до закрытия позиции.
