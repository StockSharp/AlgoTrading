# Стратегия Gap DM

## Общее описание
Gap DM — это контртрендовая стратегия торговли гэпов. Она сравнивает цену закрытия предыдущей свечи с ценой открытия текущей и, если фиксирует значимый разрыв, немедленно открывает позицию в противоположную сторону, рассчитывая на закрытие гэпа. Реализация основана на оригинальном советнике MetaTrader 5 «Gap DM» от cmillion и адаптирована под высокоуровневый API StockSharp. Все сигналы строятся на завершённых свечах выбранного таймфрейма, что гарантирует воспроизводимость в тестах и на реальных данных.

## Логика сигналов
1. Подписаться на серию свечей, заданную параметром `CandleType`.
2. Обрабатывать только завершённые свечи (`CandleStates.Finished`).
3. Сохранить закрытие предыдущей свечи и сравнить его с ценой открытия текущей.
4. Перевести разницу в пункты (pips) через `PriceStep`. Для инструментов с трёх- и пятизнаковыми котировками автоматически используется коэффициент 10, как в MT5.
5. Если текущее открытие **ниже** предыдущего закрытия минимум на `Minimum Gap (pips)`, фиксируется отрицательный гэп и открывается **длинная** позиция.
6. Если текущее открытие **выше** предыдущего закрытия минимум на `Minimum Gap (pips)`, фиксируется положительный гэп и открывается **короткая** позиция.
7. Если стратегия не готова торговать (нет подключения, идёт прогрев), новые сделки не открываются.

## Объём и ограничения
- `Order Volume` задаёт объём заявки в лотах. При реверсе стратегия автоматически добавляет объём, чтобы сначала закрыть встречную позицию и лишь затем открыть новую — это соответствует неттинговой модели StockSharp.
- `Max Positions` ограничивает суммарную позицию в одну сторону. При достижении лимита новые сигналы игнорируются.
- При смене направления (лонг ↔ шорт) дополнительный объём учитывает текущее нетто-плечо, чтобы итоговая позиция не превышала допустимый максимум.

## Управление рисками
- `Stop Loss (pips)` задаёт защитный стоп относительно цены входа. Каждый закрытый бар проверяет, прошла ли цена через уровень стопа, и при необходимости закрывает позицию рыночной заявкой.
- `Take Profit (pips)` симметрично стопу фиксирует прибыль на заранее заданном расстоянии. Значение `0` отключает цель.
- Трейлинг-стоп в данной реализации отсутствует, что соответствует логике исходного советника.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `Order Volume` | Объём каждой сделки в лотах. | `1` |
| `Stop Loss (pips)` | Размер защитного стопа в пунктах. `0` — без стопа. | `0` |
| `Take Profit (pips)` | Размер целевого профита в пунктах. `0` — без цели. | `0` |
| `Minimum Gap (pips)` | Минимальная величина гэпа для генерации сигнала. | `1` |
| `Max Positions` | Максимально допустимая суммарная позиция в одну сторону (в лотах). | `15` |
| `Candle Type` | Тип свечей, по которым измеряется гэп. | `1 час` |

## Последовательность работы
1. При запуске сбросить внутреннее состояние: размеры гэпов, стопов, прошлое закрытие.
2. Подписаться на свечи, подготовить отображение свечей и собственных сделок на графике (если доступна область).
3. Для каждой завершённой свечи:
   - Обновить активные уровни стопа и тейк-профита в соответствии с текущей позицией.
   - Проверить условия появления гэпа и при необходимости отправить рыночную заявку.
   - Повторно проверить защитные уровни, чтобы срабатывания внутри текущей свечи исполнялись без задержки.
4. Сохранить цену закрытия для анализа следующей свечи.

## Отличия от версии MT5
- В StockSharp используется неттинговый учёт, поэтому стратегия масштабирует суммарную позицию, а не создаёт отдельные заявки для каждого входа. Алгоритм поведения при этом остаётся максимально близким к оригиналу.
- Все комментарии в коде написаны на английском языке согласно требованиям репозитория.
- Режим управления риском через процент депозита (`risk`) не реализован. Вместо него используется фиксированный объём `Order Volume`.

## Требования
- Инструмент должен предоставлять валидный `PriceStep`.
- Стратегия подходит для любых свечей (временных, объёмных, диапазонных), если понятие гэпа имеет смысл для выбранного рынка.
- Необходима среда StockSharp с поддержкой рыночных заявок и отслеживания собственных сделок.

