# Gap DM 策略

## 概述
Gap DM 是一种逆向跳空交易策略，通过比较上一根 K 线的收盘价与下一根 K 线的开盘价来捕捉开盘缺口。当市场出现明显跳空时，策略会立即向缺口反向建仓，期待价格回补。该实现基于 cmillion 的 MetaTrader 5 "Gap DM" EA，在 StockSharp 的高级 API 上重写，所有交易信号均来自所选周期的已完成 K 线，确保回测与实时执行的一致性。

## 信号逻辑
1. 订阅由 `CandleType` 指定的 K 线序列。
2. 仅在蜡烛完成（`CandleStates.Finished`）后评估信号。
3. 记录上一根蜡烛的收盘价，并与当前蜡烛的开盘价比较。
4. 依据品种 `PriceStep` 计算跳空点数，对于 3 或 5 位报价会自动乘以 10，以复现 MT5 中点与 pip 的换算。
5. 若当前开盘价 **低于** 前一收盘价且差值不少于 `Minimum Gap (pips)`，判定为向下跳空，策略 **买入做多**。
6. 若当前开盘价 **高于** 前一收盘价且差值不少于 `Minimum Gap (pips)`，判定为向上跳空，策略 **卖出做空**。
7. 如果策略尚未准备好交易（例如离线、未加载完历史数据），则跳过信号。

## 仓位与限制
- `Order Volume` 决定每次下单的手数，同时用于在反向开仓时先行平掉已有净仓位，以适配 StockSharp 的净额持仓模式。
- `Max Positions` 控制同一方向可累积的最大净手数，当达到上限时将忽略新的同向信号。
- 当从空头翻多头或从多头翻空头时，策略会自动增加下单量，先平掉反向敞口再建立新的仓位。

## 风险控制
- `Stop Loss (pips)` 以入场价为基准设置保护性止损。每根完成的 K 线都会检查价格区间，若穿越止损则立即使用市价单平仓。
- `Take Profit (pips)` 与止损对称，达到目标价即市价平仓。将参数设为 `0` 可关闭止盈。
- 策略未实现跟踪止损，保持与原始 EA 相同的退出逻辑。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `Order Volume` | 每次入场的交易手数。 | `1` |
| `Stop Loss (pips)` | 止损距离（pip）。设为 `0` 表示禁用。 | `0` |
| `Take Profit (pips)` | 止盈距离（pip）。设为 `0` 表示禁用。 | `0` |
| `Minimum Gap (pips)` | 触发交易所需的最小跳空幅度。 | `1` |
| `Max Positions` | 同一方向允许的最大累积手数。 | `15` |
| `Candle Type` | 用于检测跳空的 K 线周期。 | `1 小时` |

## 执行流程
1. 在每次启动时重置内部缓存（跳空阈值、止损/止盈价格、前值收盘）。
2. 订阅 K 线并在图表可用时绘制蜡烛和成交记录。
3. 对每根完成的 K 线执行以下步骤：
   - 根据当前仓位更新或重置止损和止盈价格。
   - 判断是否存在满足条件的跳空并发送市价单。
   - 再次检查保护性价位，确保同一根 K 线内触发的止损/止盈不会被延迟。
4. 保存当前收盘价，供下一根 K 线参考。

## 与原版 MT5 EA 的差异
- StockSharp 采用净额持仓，因此通过调整净仓位来模拟 MT5 中的多次开单行为，而不是创建多个独立订单，但策略整体思路保持一致。
- 源代码内所有注释均为英文，以符合项目规范。
- 原 EA 的百分比风险管理（`risk` 模式）未移植，改为固定手数控制。请直接在 `Order Volume` 中输入希望交易的手数。

## 使用要求
- 需要交易品种提供有效的 `PriceStep`。
- 可用于任意基于时间、成交量或区间的 K 线，只要跳空概念适用。
- 需要可正常发送市价单并跟踪自身成交的 StockSharp 运行环境。

