# 双均线趋势共振策略

## 概述
**双均线趋势共振策略** 复刻了原始的 MetaTrader 智能交易系统：通过一条慢速指数移动平均线（EMA）和一条快速线性加权移动平均线（LWMA）来确认趋势。策略会等待两条均线在同一方向上连续倾斜，并使用上一根 K 线的收盘价作为附加确认信号，只有在动量与趋势完全一致时才入场，旨在捕捉最有力量的趋势波段。

在 StockSharp 中的实现仅处理已完成的蜡烛线，保存最近三根 K 线的均线斜率，并通过 `StartProtection` 自动管理止损和止盈。策略与具体品种无关，只要证券提供蜡烛数据并定义了价格最小变动单位（point），就可以运行。

## 指标
- **慢速 EMA（默认 57）**：代表主趋势方向，要求连续两根 K 线的 EMA 值递增或递减。
- **快速 LWMA（默认 3）**：作为动量确认指标，只有当其斜率与慢速 EMA 一致时才允许入场。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `SlowMaLength` | 57 | 慢速 EMA 趋势过滤器的周期。 |
| `FastMaLength` | 3 | 快速 LWMA 动量过滤器的周期。 |
| `StopLossPoints` | 100 | 止损距离，按品种的 point 表示，最终乘以 `Security.PriceStep` 转换为价格。 |
| `TakeProfitPoints` | 100 | 止盈距离，按 point 表示，最终乘以 `Security.PriceStep` 转换为价格。 |
| `CandleType` | 15 分钟 | 用于计算的蜡烛类型。 |

全部参数都暴露为 `StrategyParam<T>`，因此可以在运行时修改，也可以通过 StockSharp 的优化工具进行批量优化。

## 交易规则
### 做多条件
1. 慢速 EMA 上升：当前值 > 前一根 > 前两根。
2. 快速 LWMA 上升：当前值 > 前一根 > 前两根。
3. 上一根 K 线的收盘价高于上一根慢速 EMA 值。
4. 当前慢速 EMA 高于当前快速 LWMA。
5. 当前仓位为空仓或净空。
6. 满足全部条件时，发送市价买入订单，数量为 `Volume + |Position|`，以便在需要时翻多。

### 做空条件
1. 慢速 EMA 下降：当前值 < 前一根 < 前两根。
2. 快速 LWMA 下降：当前值 < 前一根 < 前两根。
3. 上一根 K 线的收盘价低于上一根慢速 EMA 值。
4. 当前慢速 EMA 低于当前快速 LWMA。
5. 当前仓位为空仓或净多。
6. 满足全部条件时，发送市价卖出订单，数量为 `Volume + |Position|`，实现快速翻空。

### 防护机制
- `StartProtection` 会将 `StopLossPoints` 与 `TakeProfitPoints` 乘以 `Security.PriceStep`，从而得到绝对价格距离，然后以市价方式执行止损或止盈，确保在无挂单支持时也能退出。
- 当出现反向信号时，策略会立即反向开仓，即使已有的止损/止盈单仍在等待。

## 实现细节
- 仅处理 `CandleStates.Finished` 的蜡烛，等同于 MQL 版本中的“新柱”检测。
- 使用私有字段保存最近两根均线值和上一根收盘价，避免直接访问指标历史。
- 通过 `IsFormedAndOnlineAndAllowTrading()` 确保数据完备且允许交易后才下单。
- `LogInfo` 输出多空入场的详细信息，便于调试与实时监控。
- 如果图表可用，会同时绘制蜡烛与两条均线，方便视觉确认。

## 使用建议
- 根据标的物的合约规模设置 `Volume`。策略使用 `Volume + |Position|` 的市价单来完成反手。
- 如果证券未设置 `PriceStep`，代码会回退到 1。此时请根据真实最小跳动调整参数。
- 优化时可重点关注均线周期与止损/止盈距离，以适配不同市场的波动特征。
- 可以在此基础上增加波动率、交易时段等过滤器，代码结构已经为扩展做好准备。

## 建议的优化范围
- `SlowMaLength`：20 – 120（步长 5–10）。
- `FastMaLength`：2 – 10（步长 1）。
- `StopLossPoints` / `TakeProfitPoints`：50 – 200（根据波动率调整）。

上述范围兼顾了原策略的默认设置，同时为其他品种提供足够的弹性。
