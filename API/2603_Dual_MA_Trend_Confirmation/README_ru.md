# Стратегия двойного подтверждения тренда скользящими средними

## Общее описание
**Стратегия двойного подтверждения тренда** повторяет оригинального советника MetaTrader, который сочетает медленную экспоненциальную скользящую среднюю (EMA) и быструю линейно-взвешенную среднюю (LWMA). Сделки открываются только тогда, когда обе скользящие средние последовательно наклонены в одну сторону, а закрытие предыдущей свечи подтверждает направление движения. Такой подход позволяет входить в наиболее сильные импульсные участки тренда.

Реализация на StockSharp обрабатывает исключительно закрытые свечи, хранит наклон обеих средних за последние три бара и автоматически управляет защитными приказами через `StartProtection`. Стратегия не зависит от конкретного инструмента — требуется лишь наличие свечей и определённого шага цены.

## Индикаторы
- **Медленная EMA (по умолчанию 57)** — фильтрует глобальный тренд и должна расти/падать две свечи подряд.
- **Быстрая LWMA (по умолчанию 3)** — подтверждает импульс. Её направление должно совпадать с направлением медленной EMA.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `SlowMaLength` | 57 | Период медленной EMA. |
| `FastMaLength` | 3 | Период быстрой LWMA. |
| `StopLossPoints` | 100 | Размер стоп-лосса в пунктах инструмента (переводится в цену через `Security.PriceStep`). |
| `TakeProfitPoints` | 100 | Размер тейк-профита в пунктах инструмента (переводится в цену через `Security.PriceStep`). |
| `CandleType` | 15 минут | Тип свечей, используемый в расчётах. |

Все параметры описаны через `StrategyParam<T>`, поэтому их можно менять на лету или использовать в оптимизации.

## Правила входа и выхода
### Покупка
1. EMA растёт: текущее значение > предыдущее > значение два бара назад.
2. LWMA растёт: текущее значение > предыдущее > значение два бара назад.
3. Закрытие предыдущей свечи выше значения EMA на предыдущем баре.
4. Текущая EMA выше текущей LWMA.
5. Текущая позиция отсутствует или короткая.
6. При выполнении всех условий отправляется рыночная заявка на покупку объёмом `Volume + |Position|` для переворота в длинную позицию.

### Продажа
1. EMA падает: текущее значение < предыдущее < значение два бара назад.
2. LWMA падает: текущее значение < предыдущее < значение два бара назад.
3. Закрытие предыдущей свечи ниже значения EMA на предыдущем баре.
4. Текущая EMA ниже текущей LWMA.
5. Текущая позиция отсутствует или длинная.
6. При выполнении условий отправляется рыночная заявка на продажу объёмом `Volume + |Position|` для переворота в короткую позицию.

### Защитные механизмы
- `StartProtection` преобразует значения стоп-лосса и тейк-профита из пунктов в абсолютную цену, умножая их на `Security.PriceStep`, и выставляет защитные приказы рыночным способом.
- При появлении обратного сигнала стратегия сразу разворачивает позицию, независимо от состояния защитных заявок.

## Реализация
- В расчётах участвуют только свечи со статусом `CandleStates.Finished`, что эквивалентно проверке нового бара в MQL.
- Внутренние поля хранят последние два значения индикаторов и предыдущее закрытие, поэтому не требуется обращаться к истории индикаторов.
- Метод `IsFormedAndOnlineAndAllowTrading()` гарантирует, что торговля ведётся только при наличии всех данных и разрешённом состоянии стратегии.
- Записи `LogInfo` подробно фиксируют события входа, что упрощает отладку и мониторинг.
- При наличии графической панели рисуются свечи и обе скользящие средние для визуальной проверки.

## Рекомендации по использованию
- Настройте `Volume` в соответствии с лотностью инструмента — стратегия всегда отправляет ордера объёмом `Volume + |Position|`.
- Если у инструмента не задан `PriceStep`, код использует значение `1`. В этом случае параметры стопов и профитов стоит подстроить вручную.
- Наиболее полезные направления оптимизации: периоды скользящих средних и расстояния защитных приказов.
- При необходимости можно добавить дополнительные фильтры (волатильность, торговые сессии и т. п.) — архитектура стратегии легко расширяется.

## Рекомендуемые диапазоны оптимизации
- `SlowMaLength`: 20 – 120 (шаг 5–10).
- `FastMaLength`: 2 – 10 (шаг 1).
- `StopLossPoints` / `TakeProfitPoints`: 50 – 200 (в зависимости от волатильности).

Такие диапазоны соответствуют исходной логике советника и подходят для адаптации под другие инструменты.
