# Стратегия Grid Rebalance
[English](README.md) | [中文](README_cn.md)

Стратегия Grid Rebalance — это высокоуровневая версия советника Mission Automate «Grid» на платформе StockSharp. Стратегия чередует длинные и короткие циклы сетки и всегда поддерживает лестницу лимитных ордеров в направлении текущего цикла. Когда суммарная позиция достигает общего тейк-профита, цикл завершается, все отложенные заявки снимаются, и следующий цикл стартует в противоположную сторону.

## Логика работы
1. **Старт цикла.** При отсутствии позиций и отложенных ордеров стратегия открывает рыночную позицию в направлении `FirstTradeSide` объёмом `StartVolume` лотов.
2. **Построение сетки.** После каждого исполнения ордера в активном направлении выставляется новый лимитный ордер на расстоянии `GridStepPoints` (переводится в цену через `PriceStep` инструмента). Объём нового ордера равен объёму последнего исполненного умноженному на `LotMultiplier`.
3. **Общий тейк-профит.** После каждого пополнения позиции пересчитывается средняя взвешенная цена входа. Тейк-профит для всей корзины устанавливается на среднюю цену плюс/минус `TargetPoints` (также переводится через `PriceStep`). Для моделирования срабатывания серверного тейк-профита анализируются максимумы и минимумы свечей.
4. **Завершение цикла.** Когда цена достигает уровня тейк-профита, стратегия закрывает всю позицию рыночным ордером, снимает оставшиеся лимитные заявки, запоминает направление завершившегося цикла и инвертирует его для следующего запуска.

## Параметры
- `FirstTradeSide` — направление первого цикла (`Buy` или `Sell`). После каждого завершённого цикла направление автоматически меняется на противоположное.
- `StartVolume` — объём начального рыночного ордера в каждом цикле.
- `LotMultiplier` — множитель, который применяется к объёму последнего исполненного ордера при подготовке следующего уровня сетки. Значения больше единицы формируют мартингейл-последовательность.
- `GridStepPoints` — расстояние между уровнями сетки в пунктах. Стратегия умножает его на `Security.PriceStep`, чтобы получить абсолютную ценовую разницу.
- `TargetPoints` — расстояние тейк-профита от средней цены входа, также измеряется в пунктах.
- `CandleType` — тип свечей, по которым отслеживаются экстремумы для фиксации прибыли.

## Управление рисками и особенности
- Явный стоп-лосс отсутствует: при движении рынка против позиции сетка продолжает наращивать объём.
- В каждый момент активен только один отложенный ордер; после его исполнения следующий уровень выставляется немедленно.
- Новый цикл не запускается, пока открыта позиция, существуют активные заявки или инструмент не предоставил корректный `PriceStep`.
- Все расчёты выполняются внутри стратегии без обращения к глобальным коллекциям и буферам индикаторов, что соответствует требованиям проекта.
- При завершении цикла все отложенные ордера снимаются, что исключает появление «забытых» заявок от предыдущих циклов.

## Примечания
- Все параметры в пунктах конвертируются в цены с помощью `Security.PriceStep`. Пока шаг цены не задан, стратегия ждёт поступления информации от площадки.
- Реализация использует только высокоуровневый API (`SubscribeCandles`, `Bind`, `BuyMarket`, `SellMarket`, `BuyLimit`, `SellLimit`).
- Python-версия намеренно не создавалась в рамках этой задачи.
