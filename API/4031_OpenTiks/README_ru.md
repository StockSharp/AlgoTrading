# Стратегия OpenTiks

## Обзор
Стратегия OpenTiks переносит классического советника MetaTrader `OpenTiks.mq4` в инфраструктуру StockSharp. Исходный робот
анализировал ступенчатую последовательность свечей с монотонно растущими (или падающими) максимумами и ценами открытия, чтобы
распознать ранние пробои. После появления сигнала он открывал рыночную позицию, при необходимости выставлял защитный стоп и
далее сопровождал сделку, регулярно фиксируя прибыль путём последовательного сокращения объёма. Реализация на StockSharp
повторяет эти принципы, используя высокоуровневый API, подписки на свечи и встроенные помощники по заявкам, что позволяет
запускать логику в Designer, Runner или собственных приложениях S#.

## Распознавание паттерна
Сделка формируется, когда **четыре подряд идущие свечи** удовлетворяют одному из условий:

- **Бычий пробой** – для текущей свечи и трёх предыдущих: каждое значение `High` строго выше предыдущего `High`, а каждое
  значение `Open` строго выше предыдущего `Open`.
- **Медвежий пробой** – для того же окна из четырёх свечей: каждое `High` строго ниже предыдущего `High`, а каждое `Open`
  строго ниже предыдущего `Open`.

Сигналы рассчитываются по закрытым свечам выбранного `CandleType`. Когда условие выполняется, стратегия отправляет рыночную
заявку с объёмом, нормализованным по `VolumeStep` инструмента и ограниченным значениями `MinVolume` / `MaxVolume`.
Параметр `MaxOrders` задаёт максимальное количество одновременно открытых входов: ноль отключает проверку, любое положительное
значение блокирует новые заявки, если модуль нетто-позиции, делённый на нормализованный торговый объём, достигает указанного
предела.

## Управление рисками и выходом
- **Стоп-лосс** – если `StopLossPoints` больше нуля, стратегия отслеживает обратные движения на последней свече. Длинная
  позиция закрывается, когда минимум свечи опускается ниже `entryPrice - StopLossPoints × PriceStep`. Короткая позиция
  ликвидируется, когда максимум достигает `entryPrice + StopLossPoints × PriceStep`.
- **Трейлинг-стоп** – как только цена проходит не менее `TrailingStopPoints × PriceStep` в прибыльную сторону, активируется
  трейлинг на той же дистанции от закрытия (для лонга – снизу, для шорта – сверху). Каждый раз при улучшении уровня трейлинг
  может дополнительно сократить позицию.
- **Постепенное фиксирование прибыли** – при включённом `UsePartialClose` стратегия сокращает текущий объём вдвое каждый раз,
  когда трейлинг-стоп продвигается вперёд. Заявки округляются по `VolumeStep`. Если получившаяся половина меньше `MinVolume`,
  закрывается вся позиция, как и в исходном советнике MetaTrader.

Все расчёты выполняются на закрытых свечах, поэтому выходы происходят на следующем баре, а не на каждом тике. Такой подход
сохраняет совместимость с высокоуровневым API StockSharp и при этом остаётся верным изначальной идее работы по новым барам.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `OrderVolume` | `decimal` | `0.1` | Базовый лот для входа. Стратегия нормализует его по шагу объёма и ограничивает допустимыми границами инструмента. |
| `StopLossPoints` | `decimal` | `0` | Дистанция защитного стопа в ценовых пунктах (price step). Ноль отключает стоп. |
| `TrailingStopPoints` | `decimal` | `30` | Расстояние трейлинг-стопа, поддерживаемое после выхода позиции в прибыль, в ценовых пунктах. |
| `MaxOrders` | `int` | `1` | Максимальное количество одновременно открытых входов. Ноль убирает ограничение. |
| `UsePartialClose` | `bool` | `true` | Включает алгоритм поэтапного выхода, который сокращает объём при каждом продвижении трейлинг-стопа. |
| `CandleType` | `DataType` | таймфрейм 1 минута | Тип свечей, по которым формируются сигналы и контролируются стопы. |

## Особенности реализации
- В StockSharp позиция по инструменту **неттинговая**, поэтому все сделки аккумулируются в одном лонге или шорте. Параметр
  `MaxOrders` ограничивает именно суммарную нетто-позицию, а не количество отдельных заявок, как в MetaTrader.
- Трейлинг реализован на основе свечей: проверка стопов выполняется при закрытии бара. Для более частой реакции можно выбрать
  меньший таймфрейм или дополнительно подписаться на поток сделок.
- Частичное закрытие учитывает биржевые ограничения (`VolumeStep`, `MinVolume`, `MaxVolume`), что помогает избегать отказов по
  заявкам.
- Англоязычные комментарии в коде подчёркивают ключевые узлы логики и помогают адаптировать шаблон под собственные эксперименты
  с пробоями или мани-менеджментом.

## Советы по использованию
1. Выберите таймфрейм, соответствующий настройкам исходного советника (например, M1 или M5).
2. Проверьте шаг цены и лота инструмента: значение `OrderVolume` по умолчанию (`0.1`) подходит для Forex, но при необходимости
   его можно скорректировать для фьючерсов, акций или криптовалют.
3. Экспериментируйте с `TrailingStopPoints` и `UsePartialClose`, чтобы найти баланс между быстрой фиксацией прибыли и желанием
   удерживать долгие тренды.
4. Используйте графики StockSharp для визуального контроля лестницы свечей и динамики частичных выходов.
