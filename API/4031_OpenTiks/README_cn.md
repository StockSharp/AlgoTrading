# OpenTiks 策略

## 概述
OpenTiks 策略将 MetaTrader 顾问 `OpenTiks.mq4` 迁移到 StockSharp 平台。原始机器人通过寻找高点和开盘价都严格
单调的阶梯形 K 线序列来捕捉早期突破。出现信号后，它会立即以市价建仓，可选地设置止损，并在行情向有利方向运行时
不断上移止损并分批减仓。StockSharp 版本保留了这些思路，利用高层 API、蜡烛图订阅以及内置下单工具，使策略可以在
Designer、Runner 或任何自建 S# 应用中运行。

## 模式识别
当出现以下两种模式之一时将发出交易信号（共需 **四根连续 K 线**）：

- **多头突破**：当前 K 线及前三根 K 线的 `High` 值严格递增，同时 `Open` 值也严格递增。
- **空头突破**：同一窗口内的四根 K 线 `High` 值严格递减，并且 `Open` 值严格递减。

策略使用所选 `CandleType` 的已完成蜡烛进行判断。一旦条件成立，便按设定的手数发送市价单，并根据交易品种的
`VolumeStep`、`MinVolume`、`MaxVolume` 自动调整实际下单量。`MaxOrders` 用于限制同一时间最多允许的持仓次数，
设为 0 表示不限制，正整数则在净头寸绝对值除以标准下单量达到阈值时阻止新的加仓。

## 风险控制与出场
- **止损**：当 `StopLossPoints` 大于 0 时，策略会监控最新收盘 K 线。多头在最低价跌破
  `entryPrice - StopLossPoints × PriceStep` 时平仓；空头在最高价触及 `entryPrice + StopLossPoints × PriceStep`
  时离场。
- **移动止损**：当价格向有利方向运行至少 `TrailingStopPoints × PriceStep` 后，策略会启动追踪止损，并保持
  相同的距离（多头在价格下方、空头在价格上方）。每次止损水平被提升时，都可以进一步锁定利润。
- **逐步减仓**：启用 `UsePartialClose` 后，只要移动止损再次上移，策略就会把当前仓位减半。下单量会按照
  `VolumeStep` 取整，如果得到的半仓小于 `MinVolume`，则改为一次性平仓，与原版 EA 的处理保持一致。

所有止损与追踪逻辑均基于收盘数据执行，因此实际离场发生在下一根 K 线收盘时，而不是每笔成交都响应。这种实现方式
既符合 StockSharp 的高层 API 设计，又贴近原始策略“以新 K 线为驱动”的思路。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `OrderVolume` | `decimal` | `0.1` | 每次建仓的基础手数，会根据品种的成交量步长及限制自动调整。 |
| `StopLossPoints` | `decimal` | `0` | 止损距离（以价格点/最小价位计）。为 0 时不开启止损。 |
| `TrailingStopPoints` | `decimal` | `30` | 当仓位盈利后所维持的追踪止损距离，同样以价格点表示。 |
| `MaxOrders` | `int` | `1` | 同时存在的最大建仓次数。0 表示不限次数。 |
| `UsePartialClose` | `bool` | `true` | 启用逐步减仓，在追踪止损更新时自动对冲仓位。 |
| `CandleType` | `DataType` | 1 分钟时间框架 | 用于信号判断和止损监控的主要蜡烛类型。 |

## 实现细节
- StockSharp 使用 **净头寸模型**，同一品种的所有交易会合并为一个多头或空头仓位。因此 `MaxOrders` 实际上限制的是
  合并后的净头寸，而不是 MetaTrader 中的单独订单数量。
- 移动止损依赖蜡烛收盘进行计算，如需更细粒度的保护，可以选择更短的 `CandleType`，或扩展策略订阅实时成交数据。
- 逐步减仓会参考交易品种的 `VolumeStep`、`MinVolume`、`MaxVolume`，以尽量避免因数量不合规而被交易所拒单。
- 代码中的英文注释标注了关键决策点，方便在二次开发或研究不同突破/资金管理方法时参考。

## 使用建议
1. 选择与原始 EA 相符的蜡烛时间框架（例如 M1 或 M5），以复现同样的交易节奏。
2. 根据交易品种检查价格步长和最小手数，默认的 `0.1` 更适合外汇合约，如需交易期货、股票或加密货币可自行调整。
3. 调整 `TrailingStopPoints` 和 `UsePartialClose`，寻找在快速锁盈与让利润奔跑之间的最佳平衡。
4. 搭配 StockSharp 图表观察阶梯形走势与分批止盈过程，便于理解和优化策略行为。
