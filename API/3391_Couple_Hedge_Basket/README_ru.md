# Стратегия Couple Hedge Basket

## Обзор

Couple Hedge — это мультивалютная корзинная стратегия, основанная на идеи
оригинального *MT5 CoupleHedgeEA v3.0*. Стратегия формирует группы из двух
инструментов (стороны «плюс» и «минус») и одновременно торгует их, чтобы
извлекать пользу из относительных движений, при этом хеджируя совокупную
экспозицию портфеля. Она отслеживает прибыль корзины в валюте счёта, добавляет
новые хеджирующие позиции при уходе корзины в убыток и закрывает все сделки при
достижении заданных уровней прибыли или убытка.

## Ключевые особенности

- **Корзинная торговля.** Каждая группа открывает длинную и короткую позицию,
  формируя хедж. Дополнительные входы открываются с использованием геометрической
  или экспоненциальной прогрессий.
- **Управление прибылью.** Прибыль корзины рассчитывается по данным PnL
  отдельных позиций, предоставляемым StockSharp. Задержки закрытия (в секундах)
  повторяют поведение MQL-версии, где использовалось количество тиков.
- **Контроль сессии.** Торговля приостанавливается после открытия рынка в
  понедельник и перед закрытием в пятницу на заданный период ожидания.
- **Фильтр спреда.** Усреднение пропускается, если средний спред по выбранным
  инструментам превышает допустимый порог.
- **Автоматический объём.** При включённом авто-лоте первый хедж рассчитывается
  как процент от текущей стоимости портфеля, а последующие сделки масштабируются
  выбранной прогрессией.

## Настройки

| Параметр | Описание |
|----------|----------|
| `OperationMode` | Режим работы стратегии. `CloseImmediatelyAllOrders` немедленно закрывает все позиции, `CloseInProfitAndStop` прекращает торговлю после закрытия корзины в плюс. |
| `SideSelection` | Определяет, торговать ли обе стороны корзины или только одну. |
| `StepMode` | Правила открытия дополнительных корзин. `OpenWithAutoStep` использует EMA диапазона свечей для расчёта триггера. |
| `StepOpenNext` | Убыток корзины (в валюте счёта), необходимый для открытия следующей корзины. |
| `StepProgression`, `StepProgressionFactor` | Управление увеличением расстояния между усреднениями. |
| `MinutesBetweenOrders` | Минимальный интервал между усреднениями в рамках одной группы. |
| `CloseProfitMode`, `TargetCloseProfit` | Логика фиксации прибыли. `SideBySide` отслеживает каждую сторону отдельно. |
| `CloseLossMode`, `TargetCloseLoss` | Поведение при принудительном закрытии по убытку. |
| `DelayCloseProfit` / `DelayCloseLoss` | Задержка (в секундах) перед закрытием после срабатывания порога. |
| `AutoLot`, `RiskFactor`, `ManualLotSize` | Параметры расчёта объёма. Автоматический режим делит долю капитала на последнюю среднюю цену. |
| `LotProgression`, `ProgressionFactor` | Прогрессии изменения объёма для последующих корзин. |
| `UseFairLotSize` | Балансировка объёмов с учётом `TickValue` инструментов. |
| `MaximumLotSize` | Максимально допустимый объём на сторону. Ноль отключает ограничение. |
| `MaximumGroups` | Ограничение на количество одновременно торгующих групп. |
| `MaximumOrders` | Ограничение на общее число открытых позиций. |
| `MaxSpread` | Максимально допустимый средний спред (в абсолютных ценовых единицах). |
| `ControlSession`, `WaitAfterOpen`, `StopBeforeClose` | Параметры сессионного фильтра, повторяющие график работы оригинального эксперта. |

Параметры групп (`GroupNEnabled`, `GroupNPlus`, `GroupNMinus`,
`GroupNCandleType`) позволяют настроить до трёх стандартных групп, при желании
можно выбрать другие инструменты в интерфейсе.

## Логика работы

1. Подписка на свечи и уровень 1 по всем включённым инструментам.
2. Обновление средней амплитуды свечей и средней цены для расчёта авто-шага и
   авто-лота.
3. Расчёт прибыли корзины по открытым позициям и постановка отложенного закрытия
   при достижении порогов прибыли/убытка.
4. Проверка ограничений (`MaximumGroups`, `MaximumOrders`,
   `MinutesBetweenOrders`).
5. При достижении уровня убытка открывается очередная хеджирующая корзина.
   Объём корректируется согласно прогрессии и, при необходимости, с учётом
   `TickValue`.
6. Вся группа закрывается после подтверждения сигнала (с учётом заданной
   задержки) на прибыль или убыток.

## Рекомендации

- Убедитесь, что выбранный портфель поддерживает торговлю всеми инструментами и
  предоставляет поток Level1 для контроля спреда.
- В журнал выводится номер каждой открытой корзины — это помогает сравнить
  поведение с MT5-экспертом.
- Значение `MaxSpread` задаётся в ценовых единицах. Для пятизначных котировок FX
  величина `0.0004` соответствует примерно четырём пунктам.
- При включённом `UseFairLotSize` убедитесь, что у инструментов корректно задан
  `TickValue`, иначе балансировка будет некорректной.
- Сессионный фильтр использует локальное время компьютера. При необходимости
  скорректируйте значения под расписание конкретной биржи.

## Отличия от MQL-версии

- Триггер усреднения задаётся в валюте счёта, а не в пунктах на лот, что
  соответствует модели учёта в StockSharp.
- Задержки в тиках перенесены в секунды (рекомендуется диапазон 1–5 секунд для
  имитации оригинала).
- Параметры, связанные с оформлением графика (`SetChartInterface`,
  `SaveInformation`), носят информационный характер.

## Начало работы

1. Скопируйте стратегию в решение StockSharp и выполните сборку.
2. Подключите стратегию к коннектору, выберите портфель и убедитесь в наличии
   потоков данных Level1.
3. Настройте инструменты в группах и параметры риска.
4. Запустите стратегию и отслеживайте в логе открытия/закрытия корзин, корректируя
   прогрессии под желаемый риск-профиль.

