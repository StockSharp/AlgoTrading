# Daydream Channel Breakout
[English](README.md) | [中文](README_cn.md)

Daydream Channel Breakout — это точная конверсия советника Daydream с платформы MetaTrader в инфраструктуру StockSharp. Стратегия работает против экстремальных движений: когда цена пробивает нижнюю границу канала Дончиана, алгоритм покупает в расчёте на возврат, а при выходе выше верхней границы открывает короткую позицию. Закрытие сделок осуществляется «виртуальным» тейк-профитом, выраженным в пунктах, поэтому на бирже не остаётся отложенных заявок.

## Логика стратегии

- Канал Дончиана строится по `ChannelPeriod` завершённым свечам, текущая свеча исключается (как и в оригинальном MQL-скрипте).
- **Покупка** выполняется, если цена закрытия опустилась ниже предыдущей нижней границы канала. Если была короткая позиция, её объём автоматически добавляется к заявке, и позиция переворачивается.
- **Продажа** выполняется, если цена закрытия превысила предыдущую верхнюю границу канала. Аналогично закрывается длинная позиция и открывается шорт.
- В рамках одной свечи допускается только один вход. После подачи заявки алгоритм ждёт открытия следующей свечи для новых сигналов.
- Каждая открытая позиция контролируется на предмет достижения виртуального тейк-профита. Как только прибыль в пунктах превышает `TakeProfitPips` (пересчитанное в цену с учётом размера пипса), позиция закрывается рыночным ордером.

## Параметры

| Имя | Описание | Значение по умолчанию | Примечание |
| --- | --- | --- | --- |
| `OrderVolume` | Объём заявки при каждом новом входе. К нему автоматически прибавляется объём противоположной позиции для разворота. | `0.1` | Соответствует значению в MT5. |
| `TakeProfitPips` | Дистанция виртуального тейк-профита в пунктах. | `50` | Размер пункта вычисляется из `Security.PriceStep`; для инструментов с 3/5 знаками умножается на 10. |
| `ChannelPeriod` | Число завершённых свечей в расчёте канала Дончиана. | `25` | Полностью повторяет оригинальный параметр. |
| `CandleType` | Тип свечей, используемый в расчётах. | `TimeSpan.FromHours(1).TimeFrame()` | Можно заменить на любой тип свечей StockSharp. |

## Последовательность работы

1. **Подписка на данные** — стратегия создаёт подписку на указанный тип свечей и связывает индикатор DonchianChannels через `BindEx`.
2. **Проверка тейк-профита** — первым шагом на каждой завершённой свече измеряется расстояние между ценой закрытия и средней ценой входа. При достижении порога позиция закрывается, и сигналы на этой свече больше не рассматриваются.
3. **Обновление канала** — значения верхней и нижней границы предыдущей свечи сохраняются отдельно, чтобы повторить логику `shift=1` из MQL.
4. **Принятие решения по входу**:
   - Цена < предыдущей нижней границы → покупка `OrderVolume + Math.Max(0, -Position)`.
   - Цена > предыдущей верхней границы → продажа `OrderVolume + Math.Max(0, Position)`.
5. **Визуализация и логирование** — для каждого входа и тейк-профита в журнал записываются подробные сообщения. При наличии области графика автоматически отображаются свечи, канал Дончиана и сделки.

## Управление рисками

- Реализован только виртуальный тейк-профит. Стоп-лосс и трейлинг отсутствуют, поэтому риск необходимо ограничивать внешними механизмами (портфельные лимиты, защита счёта и т.д.).
- Из-за добавления абсолютного объёма позиции стратегия может наращивать позицию в одном направлении, если сигналы появляются на последовательных свечах.
- Вспомогательная функция определения размера пункта умножает шаг цены на десять для 3- и 5-значных инструментов, повторяя преобразование `Point()` → `pip` в MT5. Для нестандартных тик-сайзов параметр можно скорректировать вручную.

## Практические рекомендации

- Стратегия ориентирована на возврат к среднему и лучше всего работает на боковых рынках.
- При тестировании учитывайте реалистичные спреды и комиссии, поскольку входы происходят рыночными ордерами сразу после пробоя канала.
- В реальной торговле имеет смысл дополнительно вводить фильтры по сессиям или волатильности, а также комбинировать стратегию с защитой портфеля.
- Реализация использует только высокоуровневый API StockSharp, поэтому без доработок запускается в Designer, Shell и Runner.
