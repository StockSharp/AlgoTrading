# Стратегия FXT ticks Collector

Стратегия представляет собой перенос советника MetaTrader 4 `FXTticksCollector.mq4` в инфраструктуру StockSharp. Исходный MQL-скрипт создаёт и пополняет файл тестера FXT, добавляя в него каждую новую котировку. Конверсия сохраняет эту идею: стратегия записывает компактный бинарный поток, по структуре совместимый с FXT, но управляется подписками StockSharp на свечи и сделки.

## Логика работы

1. **Инициализация**
   - На основе идентификатора инструмента и выбранного таймфрейма формируется имя файла вида `<Инструмент>_<Таймфрейм>_0.fxt`. Недопустимые символы заменяются на подчёркивания.
   - Если файл существует и его заголовок совпадает с текущими параметрами, новые данные дописываются в конец. Иначе файл создаётся заново.
   - При создании нового файла первые `InitialBarCount` завершённых свечей записываются как исторические бары, что повторяет «первые 100 баров» из MQL-версии.

2. **Сбор данных в реальном времени**
   - Подписка на свечи хранит последнюю актуальную свечу. Любые завершённые свечи, которые приходят до начала реального потока (например, после перезапуска), записываются с флагом `0` (первичное заполнение) или `1` (догрузка пропущенных баров).
   - Подписка на сделки фиксирует каждый тик. Для каждого тика в файл попадает снимок: время открытия бара, значения OHLC (из текущей свечи или из цены сделки), суммарный объём, точное время тика и флаг `4`, как в оригинальном советнике.
   - Счётчик баров увеличивается автоматически при переходе на новое время бара, поэтому в заголовке всегда хранятся актуальные числа баров и тиков.

3. **Завершение работы**
   - При остановке стратегия перезаписывает заголовок, обновляя числа баров, тиков и время открытия последнего бара, после чего сбрасывает буферы и логирует итоговую статистику.

## Параметры

| Параметр | Назначение | Значение по умолчанию |
|----------|------------|------------------------|
| `CandleType` | Таймфрейм, определяющий границы баров и часть имени файла. | Свечи 1 минута |
| `InitialBarCount` | Количество исторических свечей, записываемых при создании нового файла. | 100 |
| `FileDirectory` | Каталог для хранения бинарного файла FXT. | `.` |
| `AppendToExisting` | При `true` стратегия дописывает данные в существующий файл, если заголовок совпадает по инструменту, таймфрейму и количеству баров разогрева. | `true` |

## Формат бинарного файла

- **Заголовок** (младший порядок байт):
  1. `int` — сигнатура `0x46585443` (`"CXTF"`).
  2. `int` — версия формата (`1`).
  3. `string` — идентификатор инструмента (формат `BinaryWriter`).
  4. `long` — длительность таймфрейма в секундах.
  5. `int` — число свечей, записанных при первичном создании.
  6. `int` — количество обработанных баров.
  7. `long` — количество сохранённых тиковых снимков.
  8. `long` — время открытия последнего бара в секундах Unix.
  9. `bool` — признак, что файл создавался в режиме дозаписи.

- **Записи**:
  - Бары разогрева или догрузки: время открытия, значения OHLC (double), объём (double), время закрытия, флаг `0` или `1`.
  - Тиковые снимки: выровненное время открытия бара, OHLC, накопленный объём, фактическое время тика и флаг `4`.

## Особенности конверсии

- В оригинале использовался модуль `FXTHeader.mqh`. В портированной версии заголовок описан явно, чтобы сторонние утилиты могли читать файл без зависимостей от MT4.
- Вместо массивов `Time[0]` стратегия запоминает последнюю свечу из подписки и выравнивает время тиков по выбранному таймфрейму. Это гарантирует корректное определение начала нового бара, даже если свеча обновляется после прихода тика.
- Имя файла делается кросс-платформенным за счёт замены недопустимых символов.
- Стратегия не отправляет заявок и предназначена исключительно для сбора данных, поэтому её можно запускать параллельно с торговыми алгоритмами.

## Рекомендации по использованию

1. Назначьте инструмент и портфель, запустите стратегию и дождитесь появления рыночных данных.
2. Чтобы начальный участок файла содержал историю, убедитесь, что поставщик данных передаёт завершённые свечи в момент запуска.
3. Повторный запуск с теми же параметрами продолжит дописывать файл. Смена таймфрейма, инструмента или объёма разогрева приведёт к созданию нового файла, что соответствует логике оригинального советника при несоответствии заголовка.
