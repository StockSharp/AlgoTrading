# FXT ticks Collector 策略

该策略是 MetaTrader 4 专家顾问 `FXTticksCollector.mq4` 的 StockSharp 版本。原始脚本会持续向 MT4 的 FXT 测试文件追加最新的行情数据。移植后的 C# 策略同样收集行情，只是改为使用 StockSharp 的蜡烛与成交订阅，并将结果写入结构清晰的二进制文件。

## 工作流程

1. **初始化**
   - 将当前交易品种的标识和所选时间框组合成文件名 `<Symbol>_<Timeframe>_0.fxt`，并自动替换所有非法字符。
   - 如果文件存在且头部信息与当前设置匹配，则继续写入；否则重新创建文件。
   - 新建文件时会写入 `InitialBarCount` 根已结束的历史蜡烛，复现原始脚本“先写 100 根历史柱”的行为。

2. **实时记录**
   - 蜡烛订阅保存最近一根蜡烛。当在启动阶段收到历史回放时，会以标志 `0`（预热）或 `1`（补数）写入这些蜡烛。
   - 成交订阅捕获每一笔实时成交。每个 tick 都会写入一条记录：对齐后的开盘时间、当前蜡烛的 OHLC（若无蜡烛则退回到成交价）、累计成交量、tick 的实际时间以及与原脚本相同的标志值 `4`。
   - 每当出现新的时间片，策略会更新内部的条数统计，从而保证文件头部的 bar / tick 数量始终准确。

3. **停止**
   - 在停止时重新写入文件头部，更新总条数、tick 数及最后一个 bar 的开盘时间，并刷新缓冲区后记录日志。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 定义 bar 对齐方式及文件命名的时间框。 | 1 分钟蜡烛 |
| `InitialBarCount` | 新建文件时写入的历史蜡烛数量。 | 100 |
| `FileDirectory` | 保存 FXT 风格二进制文件的目录。 | `.` |
| `AppendToExisting` | 头部匹配时是否在原文件上追加数据。 | `true` |

## 二进制结构

- **头部**（小端序）：
  1. `int` 魔数 `0x46585443`（`"CXTF"`）。
  2. `int` 版本号（`1`）。
  3. `string` 品种标识（`BinaryWriter` 格式）。
  4. `long` 时间框秒数。
  5. `int` 创建文件时写入的预热蜡烛数量。
  6. `int` 已处理 bar 的数量。
  7. `long` 已写入 tick 记录的数量。
  8. `long` 最近一个 bar 的开盘时间（Unix 秒）。
  9. `bool` 创建文件时是否启用追加模式。

- **记录内容**：
  - 预热/补数 bar：开盘时间、OHLC（double）、成交量（double）、收盘时间、标志 `0` 或 `1`。
  - tick 快照：对齐后的开盘时间、OHLC、累计成交量、tick 时间以及标志 `4`。

## 移植说明

- 原始 EA 依赖 `FXTHeader.mqh`。移植版在 C# 中直接实现了等价的头部结构，并明确记录字段，方便外部工具解析。
- MT4 通过 `Time[0]` 数组获取当前 bar。StockSharp 没有该数组，因此策略会缓存最后一根蜡烛，并使用时间框对齐 tick 时间，确保 bar 边界与 MT4 行为一致。
- 文件名会对所有非法字符进行替换，使得输出在 Windows、Linux 等系统上都有效。
- 策略不发送任何订单，专注于数据收集，可与其他交易策略同时运行。

## 使用建议

1. 选择交易品种和投资组合后启动策略，保持数据源在线即可持续写入。
2. 若希望文件开头包含历史数据，请确保数据源在启动时能够推送完成的蜡烛。
3. 使用相同参数重启时会继续写入旧文件；更改时间框、品种或预热数量会触发重新创建文件，与原始脚本在头部不匹配时的行为一致。
