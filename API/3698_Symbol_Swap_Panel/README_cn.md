# 符号切换面板策略

## 概述
**符号切换面板策略** 是 MQL 面板 *“Symbol Swap Panel”* 在 StockSharp 平台上的移植版。原始专家顾问提供了一个图表面板，让交易者可以输入符号、切换当前图表，并实时查看 OHLC、成交量以及点差等关键指标。该策略在 StockSharp 中复刻了这一体验：启动后即可在日志中持续输出与面板标签一致的信息，并允许通过参数即时跳转到新的标的。

## 核心行为
- 为当前标的订阅蜡烛数据和 Level1 报价。
- 每根闭合蜡烛都会输出包含开高低收、总成交量以及最新点差的详细日志。
- 缓存买价/卖价以计算与 MQL 面板一致的实时点差。
- 响应手动的切换请求，在不中断策略的情况下重建订阅并监控新的符号。
- 记录最近一次已应用的符号，避免重复切换造成的无效重启。

## 参数
| 名称 | 类型 | 说明 |
| --- | --- | --- |
| `TargetSecurityId` | `string` | 触发切换时要监控的证券 ID。留空会记录警告并忽略请求。 |
| `CandleType` | `DataType` | 蜡烛聚合类型，默认使用 1 小时蜡烛，对应原面板的刷新周期。 |
| `SwapRequested` | `bool` | 手动切换开关，设为 `true` 后会立即尝试切换到 `TargetSecurityId`，完成后自动复位为 `false`。 |

## 数据订阅
- 根据 `CandleType` 为当前标的创建蜡烛订阅。
- 打开 Level1 订阅以接收买卖报价并计算点差。
- 每当标的发生变化时，旧的订阅都会被安全地停止并重新建立。

## 工作流程
1. 启动时优先使用 `Strategy.Security` 作为初始标的，如未设置则尝试根据 `TargetSecurityId` 解析。
2. 为该标的打开蜡烛与 Level1 数据流。
3. 每根闭合蜡烛都会在日志中输出与原面板一致的文本信息。
4. Level1 更新会刷新缓存的买价和卖价，为点差提供最新数值。
5. 当 `SwapRequested` 设为 `true` 且 `TargetSecurityId` 有效时，立即切换标的并重建所有订阅。

## 使用说明
- 策略仅用于行情监控，不会发送任何交易指令。
- 只有在买价与卖价均有效的情况下才会输出点差值。
- 如果提供了无效或未知的符号，会记录警告并忽略请求，同时保持现有订阅不变。
- 原 MQL 面板每秒刷新一次，如需更频繁的日志输出，可将蜡烛周期调整为更短的时间帧。

## 保留的 MQL 特性
- 通过文本输入实现的手动符号切换。
- 实时展示所选符号的 OHLC、成交量与点差。
- 对空输入或无法添加到 Market Watch 的符号给出提示（在此转换中表现为警告日志）。

## 与原实现的差异
- StockSharp 策略通过日志输出信息，而不是在图表面板上显示文本，更契合该平台的典型工作流。
- 图表切换通过重新指定策略的 `Security` 并重建订阅来实现，而不是直接控制终端窗口。
- 定时刷新机制被蜡烛闭合事件取代，以充分利用 StockSharp 的高层 API。

## 依赖条件
- 需要一个连接到目标市场的 StockSharp 连接器。
- 需要 Level1 报价数据源以便计算点差。
