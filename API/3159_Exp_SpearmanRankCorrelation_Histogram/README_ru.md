# Стратегия Exp Spearman Rank Correlation Histogram

Стратегия StockSharp повторяет советник MetaTrader **Exp_SpearmanRankCorrelation_Histogram**. Она подписывается на выбранный таймфрейм, рассчитывает гистограмму ранговой корреляции Спирмена по каждому закрытому бару и реагирует на смену цветовых состояний. В зависимости от торгового режима алгоритм может закрывать противоположные позиции, переворачиваться или ждать экстремальных значений перед действием.

## Индикаторный конвейер

1. Индикатор `RankCorrelationIndex` (ранговая корреляция Спирмена, масштабированная до ±100) получает цены закрытия свечей. Окно расчёта ограничено параметром `MaxRange` и по умолчанию равно 14 барам.
2. Результат нормализуется в диапазон `[-1; 1]`. При включённом `InvertCorrelation` знак инвертируется, что соответствует флагу `direction` в MQL.
3. Нормализованное значение сравнивается с уровнями `HighLevel` и `LowLevel`, после чего определяется цвет:
   * `4` – сильная бычья зона (`value > HighLevel`).
   * `3` – умеренная бычья зона (`0 < value ≤ HighLevel`).
   * `2` – нейтраль (`value == 0`).
   * `1` – умеренная медвежья зона (`LowLevel ≤ value < 0`).
   * `0` – сильная медвежья зона (`value < LowLevel`).
4. Цвета сохраняются в буфере «серии»: индекс `0` соответствует последней закрытой свече, `1` – предыдущей и т. д.

## Логика торговли

* Сигналы анализируются только на завершённых свечах (`CandleStates.Finished`).
* Параметр `SignalBar` задаёт смещение по истории (по умолчанию один бар назад). Стратегия также использует предшествующий бар, как и исходный эксперт.
* Флаги `AllowBuyEntries`, `AllowSellEntries`, `AllowBuyExits`, `AllowSellExits` включают или запрещают открытия и закрытия длинных/коротких позиций.
* Торговые режимы повторяют логику MetaTrader:
  * **Mode 1** – закрывает противоположную позицию, когда старший цвет бычий или медвежий (`> 2` или `< 2`). При разрешении открывает новый трейд, если свежий цвет вышел из бычьей (`< 3`) или медвежьей (`> 1`) зоны.
  * **Mode 2** – реагирует только на экстремальные значения. Цвет `4` закрывает шорт и может открыть лонг, если новый бар опустился ниже `4`. Цвет `0` закрывает лонг и может открыть шорт, если новый бар поднялся выше `0`.
  * **Mode 3** – жёсткий вариант Mode 2: шорты закрываются немедленно при `4`, лонги – при `0`; условия для новых сделок совпадают с Mode 2.
* Перед размещением рыночных заявок вызывается `CancelActiveOrders()` для очистки незавершённых поручений.
* Переворот позиции выполняется объёмом `Volume` плюс текущая абсолютная позиция, чтобы полностью сменить направление.
* Опциональные параметры `StopLossPoints` и `TakeProfitPoints` (в ценовых единицах) включают защиту через `StartProtection`; при значении `0` защитные ордера не выставляются.

## Параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Таймфрейм для расчёта индикатора и принятия решений. |
| `RangeLength` | Номинальное окно Spearman (ограничивается `MaxRange`). |
| `MaxRange` | Верхний предел окна; при `0` автоматически используется `10`. |
| `HighLevel`, `LowLevel` | Границы бычьей и медвежьей зон гистограммы. |
| `SignalBar` | Количество закрытых баров, которые пропускаются перед анализом. |
| `InvertCorrelation` | Инвертирует знак гистограммы для режима `direction=false` из MQL. |
| `AllowBuyEntries`, `AllowSellEntries` | Разрешают открытие длинных/коротких позиций. |
| `AllowBuyExits`, `AllowSellExits` | Разрешают автоматическое закрытие длинных/коротких позиций. |
| `TradeMode` | Выбор режима Mode 1, Mode 2 или Mode 3 исходного эксперта. |
| `StopLossPoints`, `TakeProfitPoints` | Опциональные защитные расстояния в абсолютных ценовых единицах. |
| `Volume` (стандартный) | Базовый объём сделок при открытии или развороте. |

## Отличия от советника MetaTrader

* Параметры манименеджмента (`MM`, `MMMode`) и проскальзывания (`Deviation_`) не реализованы. Управление объёмом осуществляется через стандартное свойство `Volume` и настройки брокера.
* Вызовы из `TradeAlgorithms.mqh` заменены прямыми `BuyMarket`/`SellMarket` после отмены активных заявок.
* Параметр `CalculatedBars`, оптимизировавший расчёты в MQL, в StockSharp не требуется и исключён.
* Флаг `direction` представлен параметром `InvertCorrelation`, который просто меняет знак гистограммы.
* Значения `StopLoss_` и `TakeProfit_` трактуются как абсолютные ценовые отступы при запуске `StartProtection`; автоматического пересчёта пунктов нет.
* Сигналы исполняются по закрытию свечи, без переноса на открытие следующего бара.

Такие изменения соблюдают рекомендации по использованию высокоуровневого API StockSharp и сохраняют исходную идею стратегии.
