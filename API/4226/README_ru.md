# Стратегия Viva Las Vegas

## Обзор
Viva Las Vegas — это экспериментальный советник по управлению капиталом, который на каждой новой попытке случайным образом открывает длинную или короткую позицию и передает размер следующей сделки одному из пяти классических прогрессирующих алгоритмов. Порт на StockSharp полностью повторяет логику MetaTrader:
- Направление выбирается через псевдослучайный «подброс монеты».
- Сразу же выставляются симметричные стоп-лосс и тейк-профит в пунктах.
- После закрытия позиции последовательность money-management обновляется и моментально открывается новая сделка.

В результате стратегия всегда находится либо в позиции, либо мгновенно готова открыть следующую — это удобный пример того, как ведут себя агрессивные системы мартингейла в инфраструктуре StockSharp.

## Модули управления капиталом
Параметр `MoneyManagement` задает один из следующих вариантов, где `BaseVolume` служит базовым лотом:

1. **Martingale** — удваивает объем после каждого убытка и возвращается к базовому объему после прибыли.
2. **Negative Pyramid** — удваивает объем после убытка и делит его пополам после прибыли (но не опускается ниже базового значения).
3. **Labouchere** — поддерживает числовую последовательность (по умолчанию `1-2-3`), ставит сумму первого и последнего элементов, удаляет их после выигрыша и добавляет их сумму после проигрыша.
4. **Oscar’s Grind** — увеличивает ставку на базовый лот после каждой прибыли, пока суммарный результат не достигнет одного базового лота, затем обнуляет прогрессию; убытки уменьшают накопленный результат.
5. **31 System** — циклически проходит по серии `1,1,1,2,2,4,4,8,8`: первая прибыль удваивает текущий элемент, вторая подряд прибыль сбрасывает серию в начало.

Все схемы реализованы в точности как в MQL-версии, включая трактовку нулевой прибыли как поражения.

## Последовательность работы
1. При старте инициализируется генератор случайных чисел (если `Seed = 0`, используется текущее время) и активируется встроенный модуль защиты `StartProtection` с заданным расстоянием до стопа и тейка.
2. Когда нет позиции и нет активного ордера, стратегия запрашивает у выбранного модуля следующий объем, нормализует его по `VolumeStep` инструмента и случайно выбирает `BuyMarket` или `SellMarket`.
3. Как только позиция открыта, защитный модуль сопровождает её до срабатывания стопа или тейка.
4. После возврата позиции к нулю фиксируется изменение `PnL`:
   - Прибыль &gt; 0 — модуль получает сигнал **win**.
   - Прибыль ≤ 0 — модуль получает сигнал **loss**.
5. Цикл сразу повторяется, поэтому стратегия постоянно находится в рынке, управляя только одной сделкой за раз.

Благодаря этому поведение полностью совпадает с «одиночным тикетом» оригинального эксперта и легко отслеживается на графике.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `StopTakePips` | `int` | `50` | Расстояние в пунктах до стоп-лосса и тейк-профита, передается в `StartProtection`. |
| `BaseVolume` | `decimal` | `1` | Базовый лот, от которого отталкиваются все прогрессии управления капиталом. |
| `MoneyManagement` | `MoneyManagementMode` | `Martingale` | Алгоритм, определяющий объем следующей сделки. |
| `Seed` | `int` | `0` | Зерно генератора случайных чисел; ноль означает использование текущего времени. |

## Особенности реализации
- Объемы приводятся к допустимому шагу `VolumeStep` и проверяются на соответствие `MinVolume` / `MaxVolume`, что предотвращает отклоненные заявки.
- Пункты пересчитываются в шаги цены по классическому правилу MetaTrader: если количество знаков `Digits` равно 3 или 5, один пункт содержит десять тиков.
- Фиксированный результат сделки вычисляется через свойство `PnL`, поэтому любые закрытия (в том числе защитными ордерами) корректно влияют на прогрессию.
- В коде добавлены английские комментарии, поясняющие ключевые решения и облегчающие адаптацию стратегии для учебных целей.

## Рекомендации по применению
- Используйте демо-счет или режим тестирования: мартингейл несет повышенный риск и предназначен в первую очередь для экспериментов.
- Перед запуском убедитесь, что `BaseVolume` соответствует минимальному размеру лота выбранного инструмента.
- Добавьте стратегию на график StockSharp, чтобы видеть, как разные схемы управления капиталом наращивают или снижают объем.
