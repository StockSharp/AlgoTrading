# Стратегия Ticks In MySQL Recorder

## Описание
- Порт эксперта MetaTrader 4 `TicksInMySQL.mq4` из каталога `MQL/7850`.
- Подключается к базе MySQL и вставляет строку при каждом поступлении данных уровня 1 (тика).
- Сохраняет используемую маржу, свободную маржу, текущую стоимость портфеля, цены Bid/Ask и идентификатор инструмента, не отправляя торговых заявок.
- Добавлены вспомогательные опции: автоматическое создание таблицы и аварийная остановка при ошибке вставки.

Реализация полностью пассивная: она не торгует, а только копирует поток телеметрии из оригинального советника для последующего анализа или отчётности вне StockSharp.

## Требования к MySQL
- Стратегия использует провайдер [MySql.Data](https://www.nuget.org/packages/MySql.Data/). Подключите пакет в проект (Designer, Backtester, Shell или собственный раннер) перед сборкой.
- Указанный пользователь должен иметь права на вставку строк. Включайте `EnsureTableExists` только если разрешено выполнять `CREATE TABLE`.
- Приложение, запускающее стратегию, должно иметь сетевой доступ к серверу MySQL; проверьте правила брандмауэра и VPN.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Server` | `localhost` | Имя хоста или IP-адрес сервера MySQL. |
| `Port` | `3306` | TCP-порт соединения. |
| `Database` | `mt4` | База данных с целевой таблицей. |
| `User` | `user` | Логин для подключения. |
| `Password` | `pwd` | Пароль пользователя (хранится в настройках стратегии). |
| `TableName` | `ticks` | Имя таблицы, куда записываются строки. |
| `EnsureTableExists` | `false` | Создавать таблицу при запуске, если она отсутствует (требует права DDL). |
| `PricePrecision` | `4` | Количество знаков после запятой для Bid/Ask (аналог `NormalizeDouble` в MQL). |
| `StopOnInsertError` | `false` | При включении стратегия останавливается после первой ошибки вставки. |

## Структура таблицы
При активном `EnsureTableExists` выполняется следующий SQL-запрос (имя таблицы подставляется динамически):

```sql
CREATE TABLE IF NOT EXISTS `ticks` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `margin` DECIMAL(19,6) NOT NULL,
    `freemargin` DECIMAL(19,6) NOT NULL,
    `date` DATETIME NOT NULL,
    `ask` DECIMAL(19,6) NOT NULL,
    `bid` DECIMAL(19,6) NOT NULL,
    `symbol` VARCHAR(64) NOT NULL,
    `equity` DECIMAL(19,6) NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB;
```

При необходимости скорректируйте типы колонок под требования инфраструктуры. Вставка выполняется в этом же порядке полей.

## Сохраняемые поля
Каждый корректный тик записывается со следующими значениями:

- `margin`: текущая заблокированная маржа (`Portfolio.BlockedValue`).
- `freemargin`: `Portfolio.CurrentValue - Portfolio.BlockedValue`, аналог `AccountFreeMargin()` в MQL.
- `date`: временная метка в UTC (серверное время, если доступно, иначе `CurrentTime`).
- `ask`: лучшая цена Ask, округлённая до `PricePrecision` знаков.
- `bid`: лучшая цена Bid, округлённая до `PricePrecision` знаков.
- `symbol`: идентификатор инструмента (`Security.Id`).
- `equity`: стоимость портфеля (`Portfolio.CurrentValue` с запасным вариантом `Portfolio.BeginValue`).

До получения обеих цен Bid и Ask записи не выполняются, чтобы избежать неполных строк.

## Порядок работы
1. Подключите пакет MySql.Data в проект с стратегией.
2. Настройте параметры подключения и назначьте портфель/инструмент перед запуском.
3. При необходимости включите `EnsureTableExists` или создайте таблицу вручную по приведённой схеме.
4. Запустите стратегию: она подписывается на `SubscribeLevel1()` и вставляет строку для каждого тика.
5. Следите за журналом. При `StopOnInsertError = true` стратегия автоматически остановится после первой ошибки записи, что удобно для систем «fail fast».

## Эксплуатационные замечания
- Вставка выполняется внутри блокировки, поэтому взаимодействие с БД остаётся последовательным, как и в исходном советнике.
- Пароли хранятся средствами StockSharp; при необходимости используйте внешние хранилища или шифрование настроек.
- Торговая логика отсутствует — стратегию можно запускать параллельно с рабочими алгоритмами на том же портфеле.
- Для крупных массивов данных рекомендуется добавить индексы (например, по колонке `date`).
