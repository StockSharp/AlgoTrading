# Стратегия Fractals Martingale

В данной папке находится порт советника MetaTrader «Fractals Martingale», реализованный на высокоуровневом API StockSharp.
Алгоритм объединяет фракталы Билла Вильямса, трендовый фильтр на основе индикатора Ишимоку и подтверждение по месячному MACD.
Размер позиции регулируется по принципу мартингейла: после убыточных сделок объем следующей заявки умножается на коэффициент, а
защитная пауза предотвращает бесконтрольный рост экспозиции.

## Логика торговли

1. **Поиск фракталов на рабочем таймфрейме**. Стратегия хранит историю завершенных свечей и ищет локальные экстремумы, окруженные
   минимум `FractalDepth` барами. Если следующая свеча открывается выше верхнего фрактала, формируется бычий сигнал; если ниже
   нижнего фрактала – медвежий. Найденные уровни остаются актуальными в течение `FractalLookback` обработанных свечей.
2. **Фильтр Ишимоку**. Сигнал учитывается только тогда, когда на старшем таймфрейме (`IchimokuCandleType`) линия Tenkan расположена
   выше Kijun для покупок и ниже Kijun для продаж.
3. **Подтверждение MACD**. Как и в исходном советнике, применяется месячный MACD (серия `MacdCandleType`, по умолчанию 30-дневные
   свечи). Длинные позиции открываются, только если линия MACD находится выше сигнальной, а короткие – если ниже.
4. **Фильтр торговой сессии**. Заявки размещаются лишь в диапазоне часов от `StartHour` (включительно) до `EndHour` (не включая).
   Поддерживается режим с переходом через полночь.
5. **Мартингейл**. Базовый объем задается параметром `TradeVolume`. После убыточной серии следующий объем умножается на
   `Multiplier` и приводится к шагу объема инструмента. При прибыли цепочка сбрасывается. При превышении `MaxConsecutiveLosses`
   торговля приостанавливается на `PauseMinutes` минут и затем возобновляется с базовым объемом.
6. **Переворот позиции**. Перед открытием нового ордера стратегия закрывает встречный объем, чтобы в портфеле не оставалось
   разнонаправленных позиций.

## Управление рисками

- `StopLossPips` и `TakeProfitPips` переводятся в абсолютное изменение цены с учетом шага пункта и передаются в `StartProtection`.
  Это повторяет настройки исходного советника, где стопы задавались в пунктах.
- Денежный трейлинг-стоп оригинала заменен на встроенный защитный механизм StockSharp, поскольку работа с валютой счета зависит
  от брокера.

## Параметры

| Параметр | Описание |
| --- | --- |
| `TradeVolume` | Базовый объем первой заявки в серии. |
| `Multiplier` | Во сколько раз увеличить объем после убыточной сделки. |
| `StopLossPips`, `TakeProfitPips` | Расстояние до стоп-лосса и тейк-профита в пунктах. |
| `FractalDepth` | Количество баров по обе стороны при определении фрактала. |
| `FractalLookback` | Сколько обработанных свечей хранить фрактал в качестве актуального уровня. |
| `StartHour`, `EndHour` | Торговые часы (по времени площадки). Равные значения отключают фильтр. |
| `MaxConsecutiveLosses` | Допустимое число подряд идущих убыточных сделок перед паузой. |
| `PauseMinutes` | Длительность защитной паузы в минутах. |
| `TenkanPeriod`, `KijunPeriod`, `SenkouPeriod` | Периоды линий Ишимоку на старшем таймфрейме. |
| `MacdFastPeriod`, `MacdSlowPeriod`, `MacdSignalPeriod` | Периоды EMA для фильтра MACD. |
| `CandleType` | Основная серия свечей для сигналов и сделок. |
| `IchimokuCandleType` | Таймфрейм для расчета Ишимоку. |
| `MacdCandleType` | Таймфрейм для MACD (по умолчанию приблизительный месяц). |

## Рекомендации по использованию

1. **Расчет пункта**. Значение пункта берется из `Security.PriceStep`; для пятизначных форекс-котировок производится умножение на 10,
   чтобы соответствовать логике MetaTrader.
2. **Множественные подписки**. Стратегии требуются до трех разных серий свечей. Убедитесь, что поставщик данных поддерживает
   необходимые таймфреймы.
3. **Контроль мартингейла**. Умножение объема резко увеличивает риски. Используйте параметры `Multiplier`, `MaxConsecutiveLosses`
   и `PauseMinutes`, чтобы адаптировать стратегию к капиталу.
4. **Отличия от версии MT4**. В переводе отсутствуют почтовые и push-уведомления, денежные трейлинг-стопы и явные проверки маржи –
   эти функции реализованы средствами StockSharp. Логика входа/выхода и наращивания позиции сохранена.

## Содержимое

- `CS/FractalsMartingaleStrategy.cs` – реализация стратегии на C#.
- `README.md` – документация на английском языке.
- `README_cn.md` – описание на китайском языке.
- `README_ru.md` – описание на русском языке (данный файл).
