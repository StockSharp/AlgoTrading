# Peak Volume Counter 策略
[English](README.md) | [Русский](README_ru.md)

**Peak Volume Counter** 是来自 `MQL/9514/AIS7PVC.MQ4` 的 MetaTrader 4 工具在 StockSharp 上的移植版本。策略不会下单，只用于监控。它持续跟踪逐笔成交数据，在检测到成交量瞬间爆发时记录告警。整体逻辑与原始的 “Peak Volume Counter” 指标一致，并把颜色区间转换为文字严重程度标签。

## 工作原理

1. 启动时策略会重置所有计数器、最后一次记录的成交价以及时间窗口。
2. 订阅标的的逐笔行情 (`DataType.Ticks`)。每条成交消息都会累加到总量。如果交易所没有提供成交量，策略会按 1 手处理，以匹配 MetaTrader 对跳动成交量的统计方式。
3. 第一笔成交定义累计窗口的起点，后续成交不断扩展该窗口，直至达到阈值。
4. 当累计成交量达到或超过 `VolumeThreshold`（默认 `7`）时，策略通过日志输出事件编号、成交量、窗口持续时间、最新成交价、服务器和本地时间以及对应的严重程度标签。
5. 记录完成后计数器立即归零并开始新的窗口，因此在跨越分钟边界时也不会错过连续的爆量片段。

这种实现重现了原脚本比较相邻一分钟 K 线的跳动成交量并识别强势爆量的做法。由于直接处理逐笔数据，不需要等待 K 线收盘即可给出提示。

## 参数

| 名称 | 说明 | 默认值 | 可优化 |
| --- | --- | --- | --- |
| `VolumeThreshold` | 触发告警所需的最小累计成交量，告警后累计值会被重置。 | `7` | 是（5 → 20，步长 1） |

## 告警说明

告警通过策略日志（`LogInfo`）输出，例如：

```
Peak volume #3: volume 11 (yellow), window 4.5s, price 1.2345, server 2024-05-01T12:34:56.7890000Z, local 2024-05-01T15:34:56.7900000+03:00.
```

严重程度标签对应原始颜色区间：

| 标签 | 原始颜色区间 | 含义 |
| --- | --- | --- |
| `red` | 7 – 8 个跳动 | 达到最小爆量门槛，提示关注。 |
| `orange` | 9 – 10 个跳动 | 成交加速，力度中等。 |
| `yellow` | 11 – 12 个跳动 | 活跃度提升，买卖双方参与度增强。 |
| `lawn green` | 13 – 14 个跳动 | 较高的活跃度，常见于突破前。 |
| `aqua` | 15 – 16 个跳动 | 非常强劲的成交流。 |
| `blue` | 17 – 18 个跳动 | 罕见的爆量，通常伴随重大事件。 |
| `violet` | 19 及以上跳动 | 极端成交爆发，提示流动性剧烈失衡。 |

窗口持续时间表示从第一笔到最后一笔构成爆量的交易间隔。若市场数据存在乱序时间戳，结果会被截断为零，避免出现负值。

## 使用建议

- 必须连接能提供真实逐笔成交的数据源，否则无法生成告警。
- 由于策略不会下单，可在真实账户连接上作为辅助监控工具运行。
- 根据标的的流动性调整 `VolumeThreshold`：流动性差的品种可以降低阈值，期货和主流外汇对则可以调高。
- 移植版持续累计成交量，与 K 线收盘无关，因此不会出现等到下一根 K 线才提示的情况。
- 可订阅策略日志，将严重程度标签与自有的交易决策或可视化面板结合使用。

