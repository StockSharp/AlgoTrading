# Simple EA MA plus MACD
[English](README.md) | [中文](README_cn.md)

## Обзор
Стратегия переносит советник MetaTrader 5 **Simple EA MA plus MACD** на высокоуровневый API StockSharp. Алгоритм ищет пробой "сигнальной свечи", для которой выполняются два условия: смещённая скользящая средняя располагается ниже/выше максимумов свечей, а гистограмма MACD пересекает нулевую линию. Когда следующая свеча закрывается за пределами экстремума сигнальной свечи, происходит вход в направлении пробоя.

Последовательность полностью повторяет логику оригинального советника:

1. **Поиск сигнала.** На каждой закрытой свече анализируется предыдущий бар. Настраиваемая скользящая средняя (по умолчанию LWMA) на выбранной цене должна быть ниже максимумов двух последних свечей для покупок (выше – для продаж). Одновременно основная линия MACD должна пересечь нуль между двумя предыдущими барами.
2. **Подтверждение сигнала.** После фиксации сигнальной свечи стратегия ждёт закрытия следующего бара. Закрытие выше сохранённого максимума активирует покупку; закрытие ниже минимума – продажу. Если цена вернулась внутрь диапазона сигнальной свечи, сигнал аннулируется.
3. **Сопровождение позиции.** Для новых сделок применяются уровни стоп-лосса, тейк-профита и трейлинг-стопа в пунктах. Значения конвертируются в абсолютные цены через `PriceStep`. Для инструментов с 3 или 5 знаками применяется форекс-коррекция (шаг × 10), что совпадает с расчётами MetaTrader.

## Управление рисками
- **Стоп-лосс / тейк-профит.** Настраиваемые расстояния в пунктах проверяются на каждом закрытии свечи. При достижении уровня позиция закрывается рыночным ордером.
- **Трейлинг-стоп.** Как только прибыль превышает `TrailingStopPips + TrailingStepPips`, трейлинг переносится за достигнутый экстремум. Возврат цены к уровню трейлинга приводит к закрытию сделки. Шаг трейлинга равный нулю обновляет защиту при каждом новом экстремуме.
- **Переворот.** При появлении пробоя в противоположную сторону открывается единый рыночный ордер, который одновременно закрывает текущую позицию и открывает новую в противоположном направлении.

## Особенности реализации
- Скользящая средняя поддерживает все режимы сглаживания и типы цен MetaTrader (Simple, Exponential, Smoothed, LinearWeighted и Close/Open/High/Low/Median/Typical/Weighted).
- Параметр `MaShift` воспроизводит горизонтальный сдвиг индикатора, считывая значения скользящей средней с предыдущих баров перед проверкой условий.
- MACD реализован через встроенный `MovingAverageConvergenceDivergence`. Для стратегии используется только гистограмма (разница быстрых и медленных EMA); период сигнальной линии сохраняется для совместимости с исходными настройками.
- Подписка на свечи и расчёт индикаторов выполнены исключительно средствами высокоуровневого API StockSharp без ручной обработки тиков и буферов.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Volume` | `1` | Объём ордера при каждом входе по пробою. |
| `TakeProfitPips` | `50` | Расстояние до тейк-профита в пунктах (пересчёт в абсолютную цену через `PriceStep`). `0` отключает цель. |
| `StopLossPips` | `50` | Расстояние до стоп-лосса в пунктах. `0` отключает защиту. |
| `TrailingStopPips` | `5` | Базовая величина трейлинг-стопа в пунктах. |
| `TrailingStepPips` | `5` | Минимальный дополнительный прогресс (в пунктах) перед очередным переносом трейлинг-стопа. |
| `MaPeriod` | `100` | Период скользящей средней, контролирующей сигнальный бар. |
| `MaShift` | `0` | Горизонтальный сдвиг скользящей средней, аналог `ma_shift` из MetaTrader. |
| `MaMethod` | `LinearWeighted` | Метод расчёта скользящей средней (Simple, Exponential, Smoothed, LinearWeighted). |
| `MaAppliedPrice` | `Weighted` | Тип цены для расчёта скользящей средней (Close, Open, High, Low, Median, Typical, Weighted). |
| `MacdFastPeriod` | `12` | Период быстрой EMA в MACD. |
| `MacdSlowPeriod` | `26` | Период медленной EMA в MACD. |
| `MacdSignalPeriod` | `9` | Период сигнальной линии MACD, сохраняемый для совместимости. |
| `MacdAppliedPrice` | `Weighted` | Тип цены, подаваемой на вход MACD. |
| `CandleType` | Таймфрейм 1 час | Основной поток свечей для сигналов и сопровождения. |

## Рекомендации
- Перед запуском проверьте корректность `PriceStep` и других параметров инструмента в коннекторе: от них зависит пересчёт пунктов в абсолютные цены.
- Для волатильных рынков можно увеличить `TrailingStepPips`, чтобы уменьшить число ранних закрытий, либо уменьшить шаг для более агрессивного сопровождения.
- Сделки открываются только на закрытых свечах, поэтому пробой должен удержаться до конца бара. Переход на меньший таймфрейм увеличивает частоту сигналов, но повышает уровень шума.
