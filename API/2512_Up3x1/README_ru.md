# Стратегия Up3x1 (конвертация из MT5)

## Общее описание
- Конвертация советника MetaTrader 5 `up3x1.mq5` на высокоуровневый API StockSharp.
- Торговля строится на тройном пересечении экспоненциальных скользящих средних с управлением стоп-лоссом, тейк-профитом и трейлинг-стопом.
- Обработка ведётся только по завершённым свечам, что повторяет проверку `iTickVolume(0) > 1` и гарантирует одно решение на бар.
- По умолчанию используется часовое таймфрейм, но его можно изменить через параметр `CandleType`.

## Торговая логика
1. **Индикаторы**
   - Быстрая EMA (`FastPeriod`, по умолчанию 24).
   - Средняя EMA (`MediumPeriod`, по умолчанию 60).
   - Медленная EMA (`SlowPeriod`, по умолчанию 120).
2. **Вход в лонг**
   - На предыдущем баре: быстрая EMA < средняя EMA < медленная EMA.
   - На текущем баре: средняя EMA опускается ниже быстрой EMA, при этом быстрая всё ещё ниже медленной.
3. **Вход в шорт**
   - На предыдущем баре: быстрая EMA > средняя EMA > медленная EMA.
   - На текущем баре: средняя EMA поднимается выше быстрой EMA, обе при этом выше медленной.
4. **Правила выхода (для обеих сторон)**
   - Тейк-профит срабатывает при движении цены на `TakeProfitOffset` от точки входа (используются high для лонга и low для шорта).
   - Стоп-лосс срабатывает при откате на `StopLossOffset` (low для лонга, high для шорта).
   - Трейлинг-стоп активируется, когда прибыль превышает `TrailingStopOffset`, и далее сопровождает цену на фиксированном расстоянии (оценка по экстремумам свечи).
   - Дополнительное условие выхода: быстрая EMA снова опускается ниже средней при сохранении обеих выше медленной (аналог проверки `ma_one_1 > ma_two_1 > ma_three_1` в MQL).

## Управление позицией и рисками
- `RiskFraction` (по умолчанию 0.02) умножается на текущую стоимость портфеля и повторяет исходную формулу `FreeMargin * 0.02 / 1000`.
- `BaseVolume` (по умолчанию 0.1) используется как резервный объём, если данные портфеля недоступны или расчётная величина не положительна.
- После более чем одной убыточной сделки объём сокращается на `volume * losses / 3`; счётчик `losses` не обнуляется после прибыльных сделок, как и в оригинальном коде.
- Объёмы округляются вниз до `Security.VolumeStep`, ограничиваются диапазоном `Security.MinVolume`/`Security.MaxVolume`; если минимальный лот недостижим, сделка пропускается.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|------------------------|----------|
| `FastPeriod` | 24 | Период быстрой EMA.
| `MediumPeriod` | 60 | Период средней EMA.
| `SlowPeriod` | 120 | Период медленной EMA и трендовый фильтр.
| `TakeProfitOffset` | 0.015 | Абсолютное расстояние тейк-профита (настраивается под шаг цены инструмента).
| `StopLossOffset` | 0.01 | Абсолютное расстояние стоп-лосса.
| `TrailingStopOffset` | 0.004 | Дистанция трейлинг-стопа; установите 0 для отключения.
| `BaseVolume` | 0.1 | Резервный объём для открытия позиции.
| `RiskFraction` | 0.02 | Доля стоимости портфеля, участвующая в расчёте объёма.
| `CandleType` | 1 час | Тип свечей, используемый для расчётов и сигналов.

## Особенности конвертации
- Трейлинг-стоп и защитные выходы используют максимумы/минимумы свечей, так как стратегия работает со завершёнными барами (tick-by-tick данные не требуются).
- Стоп-лосс и тейк-профит исполняются через рыночное закрытие позиции, без регистрации отдельных защитных заявок, что упрощает работу в высокоуровневом API.
- Динамический объём рассчитывается по `Portfolio.CurrentValue`; при отсутствии значения стратегия использует `BaseVolume`, подобно функции `LotCheck` в MQL.
- Счётчик `losses` накапливается и не обнуляется после прибыли, чтобы сохранить поведение оригинального эксперта.
- Все комментарии в коде выполнены на английском языке согласно требованиям проекта.

## Рекомендации по использованию
1. Подключите стратегию к инструменту и портфелю, затем задайте `CandleType`, соответствующий рабочему таймфрейму.
2. Подберите значения `TakeProfitOffset`, `StopLossOffset` и `TrailingStopOffset` в соответствии с шагом цены и ликвидностью инструмента (например, 0.015 ≈ 150 пунктов для пятизнаковых форекс-котировок).
3. Настройте `RiskFraction` и `BaseVolume`, чтобы объём позиции соответствовал размеру счёта и требованиям риск-менеджмента.
4. Для отключения трейлинг-стопа установите `TrailingStopOffset` в 0.
5. В логах выводятся сообщения «Enter long», «Exit short» и т. п., что воспроизводит диагностические `Print` из MetaTrader.

## Структура каталога
```
API/2512_Up3x1/
├── CS/Up3x1Strategy.cs      # C#-реализация стратегии
├── README.md                # Документация на английском
├── README_cn.md             # Документация на китайском
└── README_ru.md             # Документация на русском (этот файл)
```

## Отказ от ответственности
Алгоритмическая торговля сопряжена с высокими рисками. Пример предназначен исключительно для обучения; перед использованием на реальном рынке протестируйте стратегию на исторических данных и в тестовой среде.
