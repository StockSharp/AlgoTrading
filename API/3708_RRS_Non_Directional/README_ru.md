# Стратегия RRS Non-Directional

## Обзор
Эта стратегия переносит советник MetaTrader 4 «RRS Non-Directional» на платформу StockSharp. Оригинальный советник формирует хедж из покупок и продаж в зависимости от выбранного режима и управляет сделками с помощью виртуальных уровней стоп-лосса, тейк-профита и трейлинга. Порт для StockSharp сохраняет настраиваемые режимы, отключение при достижении заданного риска и виртуальную защиту, адаптируя механику под неттинговую модель портфелей. Поэтому хеджевые режимы чередуют длинные и короткие позиции вместо одновременного удержания разнонаправленных ордеров.

## Торговая логика
- Подписка на поток Level-1, чтобы получать лучшие цены bid/ask. Перед каждой сделкой вычисляется спред и сравнивается с `MaxSpreadPoints`.
- Правила входа определяются параметром `TradingMode`:
  - `HedgeStyle` и `AutoSwap` имитируют двухсторонний режим, по очереди открывая лонг и шорт (StockSharp не может держать независимые buy/sell ордера одновременно).
  - `BuySellRandom` выбирает направление случайным образом.
  - `BuySell` всегда открывает противоположную сторону по отношению к последней закрытой позиции.
  - `BuyOrder` и `SellOrder` ограничивают торговлю одним направлением.
- Параметр `AllowNewTrades` повторяет внешнюю настройку `New_Trade` и позволяет мгновенно остановить открытие новых позиций.
- Каждый ордер выставляется с объёмом `TradeVolume` и комментарием `TradeComment` для удобства учёта у брокера.

## Управление рисками и выходы
- Значения стоп-лосса и тейк-профита задаются в пунктах MetaTrader и конвертируются в абсолютное смещение цены через `PriceStep`, что делает логику универсальной для разных инструментов.
- Параметры `StopMode`, `TakeMode` и `TrailingMode` переключают режимы «выключено», «виртуальный» и «классический». В реализации StockSharp оба активных режима работают как виртуальные проверки: позиция закрывается рыночным ордером при достижении порога, что обеспечивает предсказуемость на разных коннекторах.
- Трейлинг активируется после движения цены на `TrailingStartPoints` и удерживает плавающий стоп на расстоянии `TrailingGapPoints` от лучшей цены.
- Нереализованная прибыль/убыток пересчитывается при каждом обновлении Level-1. Если значение опускается ниже порога, рассчитанного по `RiskMode` и `MoneyInRisk`, позиция закрывается немедленно.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradingMode` | Выбор режима входа, перенесённый из оригинального советника. В хеджевых режимах позиции чередуются из-за неттинга. |
| `AllowNewTrades` | Разрешает или запрещает открытие новых ордеров. |
| `TradeVolume` | Базовый объём ордеров. |
| `StopMode` | Режим работы стоп-лосса (`Disabled`, `Virtual`, `Classic`). |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах MetaTrader. |
| `TakeMode` | Режим работы тейк-профита (`Disabled`, `Virtual`, `Classic`). |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах MetaTrader. |
| `TrailingMode` | Управление трейлинг-стопом (`Disabled`, `Virtual`, `Classic`). |
| `TrailingStartPoints` | Прибыль в пунктах, необходимая для включения трейлинга. |
| `TrailingGapPoints` | Шаг в пунктах, на котором удерживается трейлинг после активации. |
| `RiskMode` | Интерпретация `MoneyInRisk` как процента от баланса или абсолютной суммы. |
| `MoneyInRisk` | Величина риска или процент, при превышении которого позиция закрывается по плавающему убытку. |
| `MaxSpreadPoints` | Максимально допустимый спред в пунктах. |
| `SlippagePoints` | Информационный параметр проскальзывания, сохранённый для совместимости. |
| `TradeComment` | Комментарий, передаваемый в каждый ордер. |

## Особенности и ограничения
- Режим AutoSwap в MetaTrader опирается на данные по свопам. Большинство коннекторов StockSharp не предоставляют эти значения, поэтому стратегия переводит режим в `HedgeStyle` и фиксирует это в логах.
- Классические стоп-лосс, тейк-профит и трейлинг исполняются виртуально. Для брокеров, требующих реальные защитные заявки, потребуется доработка на более низком уровне API.
- Из-за неттинговой модели StockSharp в хеджевых режимах позиции открываются поочерёдно, а не одновременно. Это важно учитывать при тестировании и сравнении с MetaTrader.
