# N根K线 v2
[English](README.md) | [Русский](README_ru.md)

## 概述
该策略会寻找一段固定数量的连续同向K线。当连续收盘方向达到设定阈值后，系统会按照趋势方向开仓。实现完全遵循 MetaTrader 5 的 "N- candles v2" 智能交易顾问，并且只处理已经收盘的K线以减少噪音信号。

## 策略逻辑
1. 订阅选定周期的K线，并等待其完全收盘。
2. 将每根K线分类为阳线、阴线或十字线（无方向）。十字线会把连线计数器清零。
3. 维护一个连续同方向K线的计数器。
4. 当计数器达到 `CandlesCount` 时，以同样方向提交市价单。下单数量会把目标 `LotSize` 与当前反向仓位合并，使净头寸符合理想方向与数量。
5. 记录入场价，并根据设定的止损与止盈距离初始化保护水平。
6. 每根新K线都会更新可选的移动止损，并在价格触及止损、移动止损或止盈时离场。

## 仓位管理
- 初始止损和止盈基于价格最小变动单位 (`Security.PriceStep`)。若参数为0则表示禁用该保护。
- 移动止损为可选项。启用后，当价格至少再向有利方向移动 `TrailingStepPips` 时，会按 `TrailingStopPips` 的距离上调或下调止损。
- 仓位平仓后会清空所有缓存的价格水平，必须重新等待新的连续K线序列才会再次进场。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `CandlesCount` | 需要连续同方向收盘的K线数量。 | 3 |
| `LotSize` | 每次进场的头寸规模，系统会自动对冲反向持仓。 | 1 |
| `TakeProfitPips` | 自入场价起的止盈距离（价格步长）。 | 50 |
| `StopLossPips` | 自入场价起的止损距离（价格步长）。 | 50 |
| `TrailingStopPips` | 移动止损距离（价格步长），0 表示禁用。 | 10 |
| `TrailingStepPips` | 触发移动止损调整所需的额外价格移动。 | 4 |
| `CandleType` | 用于计算信号的K线周期。 | 1小时K线 |

## 备注
- 策略依赖于合约的 `PriceStep` 信息。如果该值为0，则使用1作为后备，与原始脚本保持一致。
- 只有在K线收盘后才会生成信号，从而保证回测与实盘之间的可比性。
