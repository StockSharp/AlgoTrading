# N свечей v2
[English](README.md) | [中文](README_cn.md)

## Обзор
Стратегия отслеживает заданное количество подряд закрывшихся свечей одного направления. Когда длина серии достигает порога, алгоритм открывает рыночную позицию в сторону выявленного импульса. Реализация повторяет логику советника MetaTrader 5 "N- candles v2" и использует только закрытые свечи, чтобы избежать ложных сигналов.

## Логика стратегии
1. Подписаться на выбранный поток свечей и ожидать их полного закрытия.
2. Классифицировать каждую свечу как бычью, медвежью или нейтральную (доджи). Доджи обнуляют счётчик серии.
3. Вести скользящий счётчик одинаковых по направлению свечей.
4. Когда счётчик достигает значения `CandlesCount`, отправить рыночный ордер в том же направлении. Объём заявки объединяет желаемый `LotSize` с противоположной позицией, чтобы итоговое нетто соответствовало требуемому знаку и величине.
5. Сохранить цену входа и рассчитать защитные уровни по заданным расстояниям стоп-лосса и тейк-профита.
6. На каждой новой свече обновлять трейлинг-стоп (если он включён) и закрывать позицию при достижении стоп-лосса, трейлинг-стопа или тейк-профита.

## Управление позицией
- Начальные стоп-лосс и тейк-профит измеряются в шагах цены (`Security.PriceStep`). Нулевое значение отключает соответствующий уровень.
- Трейлинг-стоп необязателен. При активации стоп подтягивается на расстояние `TrailingStopPips`, когда цена проходит дополнительно как минимум `TrailingStepPips` по направлению позиции.
- После закрытия позиции все кешированные уровни сбрасываются, и для нового входа требуется свежая серия свечей.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandlesCount` | Количество подряд идущих свечей одного направления перед входом. | 3 |
| `LotSize` | Размер позиции для каждой сделки. Противоположный объём закрывается автоматически. | 1 |
| `TakeProfitPips` | Расстояние тейк-профита в шагах цены от цены входа. | 50 |
| `StopLossPips` | Расстояние стоп-лосса в шагах цены от цены входа. | 50 |
| `TrailingStopPips` | Расстояние трейлинг-стопа в шагах цены. 0 — отключить. | 10 |
| `TrailingStepPips` | Дополнительный путь цены перед подтягиванием трейлинг-стопа. | 4 |
| `CandleType` | Таймфрейм свечей для расчётов сигналов. | Свечи 1 часа |

## Примечания
- Стратегия корректно работает с инструментами, у которых задан `PriceStep`. При значении 0 используется запасной вариант 1, повторяющий поведение исходного скрипта.
- Сигналы формируются только на закрытых свечах, что обеспечивает сопоставимость результатов тестирования и реальной торговли.
