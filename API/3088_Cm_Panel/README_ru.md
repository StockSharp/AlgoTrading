# Стратегия CM Panel

## Обзор
**CM Panel** — это перенос ручной панели для отложенных ордеров из MetaTrader 5. Вместо интерфейсных кнопок в терминале StockSharp стратегия предоставляет набор параметров, работающих как переключатели: при установке булевого параметра в `true` немедленно отправляется (или отменяется) соответствующий ордер, после чего значение автоматически сбрасывается в `false`. Для каждой стороны рынка задаются собственные расстояния, объёмы и уровни стопов/тейков, выраженные в пунктах.

Перенос выполнен на базе высокоуровневого API StockSharp. Вход в позицию происходит через вспомогательные методы `BuyStop` и `SellStop`, а защитные ордера создаются отдельными заявками сразу после исполнения отложки. Цены и объёмы автоматически подгоняются под шаг цены и шаг лота инструмента, поэтому нет необходимости вручную использовать `_Point`, `_Digits` или другие метатрейдеровские константы.

## Торговая логика
1. При переключении `PlaceBuyStop` в `true` стратегия считывает лучшую цену ask (при её отсутствии используется последняя сделка) и прибавляет к ней `BuyStopOffsetPoints`, переведённые в денежные единицы. На полученном уровне выставляется стоп-заявка объёмом `BuyVolume`. Одновременно вычисляются и сохраняются уровни стоп-лосса и тейк-профита.
2. При включении `PlaceSellStop` лучшая цена bid (или последняя сделка) уменьшается на `SellStopOffsetPoints`. На этом уровне размещается sell stop объёмом `SellVolume`, а защитные уровни записываются для последующего использования.
3. После исполнения любого из отложенных ордеров стратегия автоматически выставляет защитные заявки:
   - Для длинной позиции создаётся `SellStop` ниже входа и `SellLimit` выше него.
   - Для короткой позиции — `BuyStop` выше входа и `BuyLimit` ниже него.
   Каждый защитный ордер ставится только один раз; при срабатывании одного пара автоматически отменяется, что повторяет модель «один SL/TP» в MetaTrader.
4. Переключение `CancelPendingOrders` приводит к отмене всех активных buy stop и sell stop, созданных стратегией. Защитные ордера уже открытых позиций намеренно не трогаются, чтобы не оставить позиции без контроля риска.
5. Объёмы заявок корректируются с учётом `VolumeStep`, `MinVolume` и `MaxVolume`. Если после округления размер оказывается некорректным (например, ниже минимума), операция отменяется с записью предупреждения в журнал.
6. Все расстояния задаются в пунктах и преобразуются через `PriceStep`. При отсутствии данных о тиковом шаге используется запасное значение `0.0001`, что позволяет работать даже с инструментами без заполненной спецификации.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `BuyVolume` | `decimal` | `0.10` | Объём заявок buy stop с учётом шага лота инструмента. |
| `SellVolume` | `decimal` | `0.10` | Объём заявок sell stop. |
| `BuyStopOffsetPoints` | `int` | `100` | Сдвиг в пунктах вверх от текущего ask для размещения buy stop. |
| `SellStopOffsetPoints` | `int` | `100` | Сдвиг в пунктах вниз от текущего bid для размещения sell stop. |
| `BuyStopLossPoints` | `int` | `100` | Расстояние до стоп-лосса (в пунктах) для длинных позиций, открытых через buy stop. Ноль отключает защиту. |
| `SellStopLossPoints` | `int` | `100` | Расстояние до стоп-лосса (в пунктах) для коротких позиций, открытых через sell stop. Ноль отключает защиту. |
| `BuyTakeProfitPoints` | `int` | `150` | Расстояние до тейк-профита (в пунктах) для длинных позиций, открытых через buy stop. Ноль отключает защиту. |
| `SellTakeProfitPoints` | `int` | `150` | Расстояние до тейк-профита (в пунктах) для коротких позиций, открытых через sell stop. Ноль отключает защиту. |
| `PlaceBuyStop` | `bool` | `false` | Однократное выставление buy stop. После обработки параметр сбрасывается в `false`. |
| `PlaceSellStop` | `bool` | `false` | Однократное выставление sell stop. После обработки параметр сбрасывается в `false`. |
| `CancelPendingOrders` | `bool` | `false` | Отмена всех активных отложенных ордеров, созданных панелью. |

## Отличия от версии для MetaTrader
- В MetaTrader стоп-лосс и тейк-профит прикрепляются прямо к отложенному ордеру. В StockSharp они создаются отдельными защитными заявками сразу после входа в позицию.
- Все цены и объёмы автоматически приводятся к спецификации инструмента, поэтому не требуется вручную учитывать `_Point`, `_Digits` и т.п.
- Минимальные допустимые расстояния до стопов со стороны брокера автоматически не проверяются. Пользователь должен задать безопасные значения, как и в оригинальном скрипте.
- Переключатель `CancelPendingOrders` отменяет только отложенные заявки. Защитные ордера для действующих позиций остаются активными, чтобы не снимать защиту с открытых сделок.

## Рекомендации по использованию
- Перед переключением параметров обязательно назначьте инструмент и портфель. Иначе стратегия зафиксирует предупреждение и проигнорирует запрос.
- Чтобы повторить рабочий процесс оригинальной панели, добавьте стратегию в Designer или Runner, отобразите параметры в свойствах и управляйте ими вручную.
- Для корректного расчёта уровней требуется поток котировок Level 1. При отсутствии bid/ask используется цена последней сделки, что может привести к более близким уровням, чем ожидалось.
- Настраивайте расстояния в пунктах с учётом минимального стоп-уровня брокера — стратегия не накладывает дополнительных ограничений.
- Если необходимо выставить «голые» стоп-заявки без SL/TP, просто установите соответствующие расстояния в ноль.
