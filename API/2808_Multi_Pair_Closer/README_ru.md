# Стратегия Multi Pair Closer

## Обзор

**Multi Pair Closer** повторяет исходный скрипт MetaTrader: стратегия наблюдает за корзиной валютных пар и закрывает все открытые позиции, когда суммарная плавающая прибыль достигает целевого значения или общая просадка превышает допустимый лимит. Реализация на StockSharp использует высокоуровневый API, чтобы отслеживать прибыль, соблюдать минимальное время удержания позиции и выполнять одновременное закрытие для нескольких инструментов.

## Логика работы

1. Список контролируемых инструментов формируется из параметра `WatchedSymbols` (значения через запятую). Если поле пустое, используется основной `Security` стратегии.
2. Для каждого инструмента оформляется подписка на выбранный тип свечей (по умолчанию – минутные). Обработка выполняется только после закрытия свечи.
3. По каждому инструменту хранится:
   - Последняя рассчитанная прибыль через `Positions[i].PnL`.
   - Момент времени, когда позиция впервые стала ненулевой, чтобы соблюсти ограничение `MinAgeSeconds`.
4. После каждого обновления рассчитывается суммарная прибыль по корзине:
   - Если достигнут `ProfitTarget`, все позиции, «дожившие» до минимального возраста, закрываются через рыночные заявки (`BuyMarket` / `SellMarket`).
   - Если суммарный результат опускается ниже `-MaxLoss`, выполняется защитное закрытие по тем же правилам.
5. В логах выводится прибыль по каждому инструменту и общий итог — аналогично полю Comment в оригинальном скрипте.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `WatchedSymbols` | Идентификаторы инструментов для мониторинга (строка через запятую). | `"GBPUSD,USDCAD,USDCHF,USDSEK"` |
| `ProfitTarget` | Целевая прибыль корзины (в валюте портфеля), при достижении которой закрываются все позиции. | `60` |
| `MaxLoss` | Максимально допустимая просадка корзины (в валюте портфеля) перед принудительным закрытием. | `60` |
| `Slippage` | Параметр для совместимости с MQL-версией. Выходы выполняются рыночными ордерами, поэтому значение носит информационный характер. | `10` |
| `MinAgeSeconds` | Минимальное время удержания позиции (в секундах) перед возможным закрытием. | `60` |
| `CandleType` | Тип свечей, используемых для периодической проверки (по умолчанию 1-минутные). | `1 minute` |

## Особенности

- Стратегия опирается на значения `PnL`, предоставляемые StockSharp, без дополнительного расчёта исторических данных.
- Позиции, уже открытые к моменту старта, получают отметку времени запуска и будут закрыты лишь после истечения `MinAgeSeconds`.
- Для закрытия используются рыночные ордера, что минимизирует риск неполного выхода. Параметр `Slippage` сохранён ради соответствия оригиналу.
- Детализированное журналирование помогает контролировать результаты по каждому инструменту и по корзине в целом.

## Требования

- Необходим доступ к `SecurityProvider` или соединению, которое сможет найти все инструменты из `WatchedSymbols`.
- Убедитесь, что объём заявок позволяет полностью перекрыть текущий объём позиции при принудительном закрытии.

