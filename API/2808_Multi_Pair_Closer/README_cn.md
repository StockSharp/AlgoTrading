# 多品种利润平仓策略

## 概述

**多品种利润平仓策略** 重现了原始的 MetaTrader 脚本：持续监控一组货币对，在组合浮动利润达到目标或总浮亏超过容忍范围时立即平掉所有仓位。该转换基于 StockSharp 的高级 API，实现了利润跟踪、持仓最小时间控制以及跨多个标的的集中平仓。

## 策略流程

1. 从逗号分隔的 `WatchedSymbols` 参数解析需要监控的标的，若留空则退回到主 `Security`。
2. 为每个标的订阅所选的 K 线类型（默认 1 分钟）。每根收盘的 K 线都会触发一次组合利润检查。
3. 对于每个标的，策略保存：
   - `Positions[i].PnL` 提供的当前浮动盈亏。
   - 首次持仓出现的时间，用于满足 `MinAgeSeconds` 的最小持仓时长。
4. 累计全部标的的净利润后执行判断：
   - 净利润达到 `ProfitTarget` 时，调用 `BuyMarket` / `SellMarket` 平掉所有达到最小时长的仓位。
   - 净利润跌破 `-MaxLoss` 时，视为风险控制，同样执行集中平仓。
5. 日志输出会列出每个标的的盈亏及组合总盈亏，方便对比原脚本的 `Comment` 信息。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `WatchedSymbols` | 需要监控的证券 ID 列表（逗号分隔）。为空时使用主 `Security`。 | `"GBPUSD,USDCAD,USDCHF,USDSEK"` |
| `ProfitTarget` | 触发平仓的组合净利润（账户货币）。 | `60` |
| `MaxLoss` | 触发保护性平仓的最大可承受亏损（账户货币）。 | `60` |
| `Slippage` | 与原脚本一致的滑点设置。由于使用市价单平仓，该参数仅作信息展示。 | `10` |
| `MinAgeSeconds` | 允许平仓前的最小持仓秒数。 | `60` |
| `CandleType` | 用于定期检查的 K 线类型（默认 1 分钟）。 | `1 minute` |

## 注意事项

- 策略直接使用 StockSharp `Positions` 集合提供的盈亏数据，无需额外的成交历史。
- 如果策略启动时已经有持仓，则以启动时刻作为首次观察时间，需等待 `MinAgeSeconds` 后才会被强制平仓。
- 所有退出均通过市价单完成，以确保尽快离场；`Slippage` 参数主要用于保留原脚本配置。
- 在日志中可看到每个标的的盈亏以及组合净值，便于实时监控。

## 使用要求

- 需要一个可解析 `WatchedSymbols` 中标的的 `SecurityProvider` 或连接器。
- 请确保每个标的的下单数量设置合理，使得平仓市价单可以完全对冲当前仓位。

