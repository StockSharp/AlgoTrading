# Стратегия подтверждения свечных паттернов Стохастиком
[English](README.md) | [中文](README_cn.md)

Эта стратегия переносит эксперта MetaTrader **Expert_CP_Stoch** в инфраструктуру StockSharp. Она комбинирует японские свечные разворотные паттерны с фильтром по сигнальной линии стохастика %D. Алгоритм анализирует каждую закрытую свечу, проверяет три предыдущие свечи на наличие бычьих или медвежьих формаций и требует, чтобы стохастик находился в зоне перепроданности/перекупленности перед открытием позиции. Закрытие позиций происходит при появлении противоположного паттерна или при пересечении сигнальной линией заданных границ.

Параметры по умолчанию повторяют оригинал: %K = 33, %D = 37, замедление = 30, уровни перепроданности/перекупленности = 30/70, границы выходов = 20/80. Стохастик в StockSharp рассчитывается по High/Low/Close, что соответствует настройке STO_LOWHIGH. Распознавание паттернов использует 12 последних тел свечей для вычисления среднего размера, как в исходном советнике.

## Детали

- **Условия входа**:
  - **Лонг**: обнаружен один из бычьих паттернов (Три белых солдата, Поглощение снизу, Утренняя доджи, Бычье поглощение, Бычье харами, Утренняя звезда, Встречные бычьи линии) **и** значение %D на предыдущей свече ниже порога перепроданности (по умолчанию 30).
  - **Шорт**: обнаружен один из медвежьих паттернов (Три чёрные вороны, Тёмное облачное покрытие, Вечерняя доджи, Медвежье поглощение, Медвежье харами, Вечерняя звезда, Встречные медвежьи линии) **и** значение %D на предыдущей свече выше порога перекупленности (по умолчанию 70).
- **Условия выхода**:
  - **Лонг**: немедленное закрытие при появлении медвежьего паттерна либо при пробое %D ниже верхней (80) или нижней (20) границы выхода.
  - **Шорт**: немедленное закрытие при появлении бычьего паттерна либо при пробое %D выше нижней (20) или верхней (80) границы выхода.
- **Направление**: открывает позиции в обе стороны по симметричным правилам.
- **Стопы**: фиксированные стоп-лоссы и тейк-профиты не используются; выход основан на паттернах и пересечениях стохастика. При необходимости можно подключить защиту портфеля на уровне запуска.
- **Параметры по умолчанию**:
  - `Body Average Period` = 12 свечей для расчёта среднего тела.
  - `Stochastic %K` = 33, `Stochastic %D` = 37, `Stochastic Smoothing` = 30.
  - `Oversold Threshold` = 30, `Overbought Threshold` = 70.
  - `Lower Exit Level` = 20, `Upper Exit Level` = 80.
- **Фильтры**:
  - Категория: свечные паттерны + осциллятор.
  - Направление: лонг и шорт.
  - Индикаторы: стохастик и несколько свечных моделей.
  - Стопы: выход только по сигналам (без механических стопов/тейков).
  - Сложность: высокая (много условий и исторических расчётов).
  - Таймфрейм: любой, по умолчанию часовые свечи.
  - Сезонность: нет.
  - Нейросети: нет.
  - Дивергенция: отсутствует, подтверждение через уровни осциллятора.
  - Риск: средне-высокий из-за отсутствия жёстких стопов.

## Как работает алгоритм

1. Подписывается на выбранную серию свечей и привязывает стохастик (%K, %D, замедление).
2. Хранит три последние закрытые свечи и скользящие средние тел/закрытий для воспроизведения логики MetaTrader.
3. На каждой свече проверяет группы бычьих и медвежьих паттернов с точными математическими условиями (средние тела, отношения mid-point, гэпы и т.д.).
4. Извлекает значения %D за две предыдущие свечи, чтобы выявить зоны перепроданности/перекупленности и пересечения уровней.
5. При совпадении паттерна и фильтра открывает или закрывает позиции рыночными заявками через высокоуровневые методы `BuyMarket`/`SellMarket`.
6. Для добавления стоп-менеджмента можно активировать `StartProtection` в конфигураторе.

## Практические рекомендации

- Для корректной работы необходимо иметь минимум `Body Average Period + 3` исторических свечей; иначе среднее тело не рассчитано и сигналы будут отсутствовать.
- Фильтр стохастика использует значение %D именно на предыдущей свече, полностью повторяя условие `StochSignal(1)` из исходного MQL.
- Свечные паттерны чувствительны к гэпам и качеству данных. На низколиквидных инструментах возможны отклонения.
- Оптимизацию можно начинать с уровней перепроданности/перекупленности и периодов стохастика, не изменяя правила распознавания паттернов.
- Для варианта STO_CLOSECLOSE потребуется модификация индикатора в будущем, если вам нужен расчёт только по закрытиям.
