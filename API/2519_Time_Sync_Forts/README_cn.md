# FORTS 时间同步工具
[English](README.md) | [Русский](README_ru.md)

该策略完全复制 MetaTrader 5 专家顾问 **Time_sync_forts.mq5** 的行为，并不会发送任何订单。它订阅 FORTS 品种的逐笔交
易，在预设的维护时间窗口内调用 Windows `SetLocalTime` 接口，把本地系统时间校准到交易所服务器时间。

## 目标

- 读取期货市场的逐笔数据以获取交易所当前时间。
- 在每个维护窗口内执行一次 `SetLocalTime`，让工作站时钟与交易所保持一致。
- 在同一个窗口内只同步一次，并在窗口结束后重置内部状态等待下一次触发。

## 同步时间窗口

时间段与原始 MQL 程序完全一致（莫斯科时区）：

1. 09:45–10:00
2. 10:01–10:02
3. 13:58–14:00
4. 14:05–14:06
5. 18:43–18:45
6. 19:05–19:06
7. 23:48–23:50

当行情时间不在这些区间内时，策略只是等待并清除内部标记，以便下一次进入窗口时再次同步。

## 参数

- **FirstSkippedDay** – 需要跳过的星期（默认周六）。当服务器时间位于该星期时，仅重置内部状态。
- **SecondSkippedDay** – 额外需要跳过的星期（默认周日），与原脚本的周末逻辑一致。
- **LatencyCompensationMilliseconds** – 在调用 `SetLocalTime` 前附加到服务器时间上的毫秒数。原脚本根据终端的 ping
  估算网络延迟，这里可以手动设置正负偏移来微调校准结果。

所有参数均通过 `StrategyParam` 暴露，可在 StockSharp 界面中查看或用于优化。

## 数据订阅

策略声明一个工作数据对 `(Security, DataType.Ticks)`，并使用高阶 API 订阅逐笔成交。每个成交都带有服务器时间戳，
当时间落在允许窗口内时执行一次同步并写入日志。

## 平台要求

- 仅支持 Windows 操作系统，需要调用 `kernel32.dll` 中的 `SetLocalTime`。在其他系统上会记录警告并跳过同步。
- 修改系统时间通常需要管理员权限。
- 请将策略绑定到与 MetaTrader 中相同的 FORTS 合约，以确保收到的时间戳来自交易所服务器。

## 实现细节

- 通过 P/Invoke 封装 `SetLocalTime`，并检查 `SYSTEMTIME` 各字段的有效范围。
- 使用 `_isSyncCompleted` 标志避免在同一个窗口内重复同步，离开窗口或遇到被跳过的星期时会重置该标志。
- 日志中会输出同步后的本地时间、原始服务器时间以及调用失败时的 Win32 错误码，便于排查问题。
