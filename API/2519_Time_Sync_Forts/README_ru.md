# Утилита синхронизации времени FORTS
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет работу советника MetaTrader 5 **Time_sync_forts.mq5** и не выполняет торговых операций. Она отслеживает
поток тиков по инструменту FORTS и в строго определённые технологические интервалы выравнивает системное время Windows по времени
торгового сервера Московской биржи.

## Назначение

- Читать тиковые сделки, чтобы получить текущее серверное время биржи.
- Во время каждого регламентного интервала вызывать Win32-функцию `SetLocalTime`, синхронизируя часы рабочей станции с биржевыми.
- Исключить повторные корректировки, пока не откроется следующее окно синхронизации.

## Окна синхронизации

Список интервалов полностью совпадает с оригинальным скриптом (московское время):

1. 09:45–10:00
2. 10:01–10:02
3. 13:58–14:00
4. 14:05–14:06
5. 18:43–18:45
6. 19:05–19:06
7. 23:48–23:50

Вне этих интервалов стратегия только ждёт и сбрасывает внутренний флаг, чтобы следующая сессия снова запустила синхронизацию.

## Параметры

- **FirstSkippedDay** – день недели, который нужно пропустить (по умолчанию суббота). Если серверное время попадает на этот день,
  стратегия лишь обновляет внутренний флаг.
- **SecondSkippedDay** – дополнительный день, который следует пропустить (по умолчанию воскресенье), сохраняя логику MQL-версии.
- **LatencyCompensationMilliseconds** – миллисекунды, добавляемые к серверному времени перед вызовом `SetLocalTime`. В MetaTrader
  задержка оценивалась по значению ping, здесь можно задать аналогичную поправку (положительную или отрицательную) вручную.

Все параметры созданы через `StrategyParam`, поэтому отображаются в интерфейсе StockSharp и поддерживают оптимизацию.

## Используемые данные

Стратегия регистрирует единственный набор `(Security, DataType.Ticks)` и с помощью высокоуровневого API подписывается на сделки.
Каждый тик приходит как `ExecutionMessage` с отметкой серверного времени. При попадании тика в разрешённое окно выполняется одна
попытка синхронизации, результат которой записывается в лог.

## Требования к платформе

- Операционная система Windows. Вызов Win32 `kernel32.dll` обязателен; на других платформах стратегия выдаёт предупреждение и
  не меняет время.
- Для изменения системных часов зачастую нужны права администратора.
- Привяжите стратегию к тому же инструменту FORTS, который использовался в MetaTrader, чтобы получать актуальное биржевое время.

## Особенности реализации

- Вызов `SetLocalTime` осуществляется через P/Invoke, перед этим проверяются границы полей структуры `SYSTEMTIME`.
- Флаг `_isSyncCompleted` защищает от повторных корректировок внутри одного окна; он сбрасывается при выходе из интервала или при
  обнаружении выходных дней.
- В журнал записываются итоговое локальное время, исходное серверное время и код ошибки Win32 при неудачном вызове.
