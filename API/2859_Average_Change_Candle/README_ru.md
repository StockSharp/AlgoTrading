# Стратегия Average Change Candle

Конвертация советника MetaTrader `Exp_AverageChangeCandle` в среду StockSharp. Алгоритм сглаживает отношения цен свечи к базовой скользящей средней, присваивает свечам цвета и торгует при смене цвета.

## Идея

1. Рассчитать базовую скользящую среднюю (`MaMethod1`, `Length1`) по выбранной цене.
2. Выразить цену открытия и закрытия как отношение к базовой средней и возвести в степень `Power`.
3. Сгладить преобразованные значения второй средней (`MaMethod2`, `Length2`).
4. Определить цвет: бычий, если сглаженное закрытие выше открытия, медвежий — если ниже.
5. Отрабатывать смену цвета после задержки `SignalBar`.

Обрабатываются только завершённые свечи. Стратегия открывает позиции по направлению нового цвета и при необходимости закрывает противоположные.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|------------------------|----------|
| `OrderVolume` | `1` | Объём сделки при открытии новой позиции. |
| `MaMethod1` | `Lwma` | Метод сглаживания базовой средней (поддержка SMA/EMA/SMMA/LWMA/JJMA/AMA, остальные переходят в EMA). |
| `Length1` | `12` | Период базовой средней. |
| `Phase1` | `15` | Параметр фазы для вариантов Jurik. |
| `PriceSource` | `Median` | Используемая цена перед вычислением базовой средней. |
| `MaMethod2` | `Jjma` | Метод сглаживания преобразованных отношений. |
| `Length2` | `5` | Период второй средней. |
| `Phase2` | `100` | Параметр фазы для второй средней. |
| `Power` | `5` | Степень для отношений открытия/закрытия. |
| `SignalBar` | `1` | Сколько закрытых баров ждать перед реакцией. |
| `BuyOpenEnabled` | `true` | Разрешить открытие длинных позиций. |
| `SellOpenEnabled` | `true` | Разрешить открытие коротких позиций. |
| `BuyCloseEnabled` | `true` | Закрывать лонги при сигнале на шорт. |
| `SellCloseEnabled` | `true` | Закрывать шорты при сигнале на лонг. |
| `StopLossPoints` | `0` | Абсолютный размер стоп-лосса, `0` отключает. |
| `TakeProfitPoints` | `0` | Абсолютный тейк-профит, `0` отключает. |
| `CandleType` | Таймфрейм `H4` | Тип свечей, которые обрабатываются стратегией. |

## Правила торговли

- **Бычья смена** (`color = 2`): закрываем шорты (если разрешено) и открываем лонг при `Position <= 0` и включённом `BuyOpenEnabled`.
- **Медвежья смена** (`color = 0`): закрываем лонги (если разрешено) и открываем шорт при `Position >= 0` и включённом `SellOpenEnabled`.
- Цвет `1` (нейтральный) не вызывает сделок.
- Для имитации оригинального кода сигнал оценивается по свече, отстоящей на `SignalBar` баров от последней завершённой.

## Управление риском

`StopLossPoints` и `TakeProfitPoints` передаются в `StartProtection` как абсолютные расстояния. Нулевые значения отключают соответствующую защиту.

## Примечания

- Поддерживаются только те методы сглаживания, которые есть в StockSharp. JurX, ParMA, T3 и VIDYA заменены на EMA.
- Параметры фаз сохранены ради совместимости и работают только для Jurik/Kaufman сглаживания.
- Сделки исполняются рыночными ордерами, как в оригинальном советнике. Настройка проскальзывания из версии MQL не переносилась.
