# Стратегия Exp XRSI Histogram Vol

## Обзор

Стратегия представляет собой перенос оригинального советника MQL5 `Exp_XRSI_Histogram_Vol` на C#. Она торгует прорывы объёмно-взвешенной гистограммы RSI, интерпретируя пять цветовых состояний индикатора. Реализация построена на высокоуровневом API StockSharp и может работать на любом таймфрейме, доступном через подписку на свечи.

## Логика стратегии

1. Рассчитывается RSI на выбранном таймфрейме и из результата вычитается 50, чтобы центрировать осциллятор.
2. Центрированный RSI умножается на выбранный поток объёма (тик или реальный), чтобы подчеркнуть бары с высокой активностью.
3. Взвешенный RSI и исходный объём сглаживаются одной и той же скользящей средней с заданным методом и длиной.
4. Сглаженный объём умножается на четыре пользовательские величины, формируя адаптивные пороги. Гистограмма классифицируется следующим образом:
   - **0** – сильный бычий импульс (выше `HighLevel2`).
   - **1** – умеренный бычий импульс (между `HighLevel1` и `HighLevel2`).
   - **2** – нейтральная зона.
   - **3** – умеренный медвежий импульс (между `LowLevel2` и `LowLevel1`).
   - **4** – сильный медвежий импульс (ниже `LowLevel2`).
5. Правила входа и выхода повторяют MQL-реализацию:
   - Открыть первую длинную позицию, когда гистограмма переходит в состояние **1** после пребывания выше него.
   - Открыть вторую длинную позицию, когда гистограмма переходит в состояние **0** после пребывания выше него.
   - Открыть первую короткую позицию, когда гистограмма переходит в состояние **3** после пребывания ниже него.
   - Открыть вторую короткую позицию, когда гистограмма переходит в состояние **4** после пребывания ниже него.
   - Закрывать короткие позиции, если гистограмма находится в состояниях **0** или **1**.
   - Закрывать длинные позиции, если гистограмма находится в состояниях **3** или **4**.
6. Параметр `SignalBar` позволяет смещать сигнал на несколько закрытых свечей назад, имитируя обращение к буферам индикатора.

Для каждого направления предусмотрены две ступени входа, контролируемые множителями `Mm1` и `Mm2`. Перед открытием новой позиции вспомогательные методы закрывают встречную позицию, что воспроизводит логику исходного кода управления сделками.

## Управление капиталом и защита

- `Mm1` и `Mm2` умножаются на свойство стратегии `Volume`. Если объём не задан, используется значение 1.
- Глобальные стоп-лосс и тейк-профит активируются через `StartProtection`, когда у инструмента задан ненулевой шаг цены и соответствующие значения точек положительны. Параметры интерпретируются как количество шагов цены.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CandleType` | Таймфрейм свечей для расчётов. |
| `RsiPeriod` | Длина RSI. |
| `VolumeMode` | Тип объёма: тиковый или реальный. При отсутствии данных тик-режим использует вес 1. |
| `HighLevel2`, `HighLevel1`, `LowLevel1`, `LowLevel2` | Множители сглаженного объёма для формирования порогов гистограммы. |
| `MaMethod`, `MaLength`, `MaPhase` | Настройки сглаживания. Методы Parabolic, T3, VIDYA, AMA не имеют прямых аналогов и заменяются на SMA; `MaPhase` влияет только на расширенные методы вроде Jurik. |
| `SignalBar` | Количество закрытых свечей, отстоящих от текущей, используемых при чтении состояния гистограммы. |
| `Mm1`, `Mm2` | Множители объёма для первой и второй позиции в каждом направлении. |
| `BuyPosOpen`, `SellPosOpen`, `BuyPosClose`, `SellPosClose` | Флаги разрешения открытия и закрытия длинных/коротких позиций. |
| `StopLossPoints`, `TakeProfitPoints` | Стоп-лосс и тейк-профит в шагах цены. |

## Значения по умолчанию

- Таймфрейм: 4 часа.
- Длина RSI: 14.
- Режим объёма: тиковый.
- Пороги: `HighLevel2 = 17`, `HighLevel1 = 5`, `LowLevel1 = -5`, `LowLevel2 = -17`.
- Сглаживание: SMA с длиной 12 и фазой 15.
- Смещение сигнала: 1 свеча.
- Управление объёмом: `Mm1 = 0.1`, `Mm2 = 0.2`.
- Стопы: 1000 и 2000 пунктов (применяются только при наличии шага цены).

## Примечания

- Стратегия работает только с завершёнными свечами и игнорирует незакрытые бары.
- Jurik доступен через `JurikMovingAverage`. Методы ParMA, T3, VIDYA, AMA заменяются на SMA из-за отсутствия встроенных реализаций.
- Индикатор использует свойство `TotalVolume`. Если объём равен нулю, тик-режим применяет вес 1, чтобы избежать потери сигналов.
- Для визуального анализа на график выводится RSI, свечи и сделки. При необходимости можно добавить дополнительные элементы визуализации.
