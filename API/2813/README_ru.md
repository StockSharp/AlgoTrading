# Стратегия управления фьючерсным портфелем перед экспирацией

## Описание
Стратегия воссоздаёт советник MetaTrader 5 *Futures Portfolio Control Expiration* с использованием высокоуровневого API StockSharp. Она поддерживает три фьючерсные ноги портфеля, удерживает заданный объём по каждой ноге и автоматически переводит позицию на следующий контракт, когда до экспирации текущего остаётся меньше заданного количества часов.

Рабочий цикл выглядит следующим образом:
1. По короткому коду (например, `MXI`, `BR`) определяется актуальный торгуемый контракт соответствующего семейства.
2. Фактическая позиция синхронизируется с целевым объёмом (положительное значение — длинная позиция, отрицательное — короткая).
3. На каждой завершённой свече «сердцебиения» проверяется время до экспирации.
4. Если контракт скоро истекает, позиция закрывается, ищется следующий контракт того же семейства, и целевой объём восстанавливается уже на нём.

## Параметры
| Параметр | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `BoardCode` | Код биржевой площадки, добавляемый к идентификатору фьючерса (например, `FORTS`). Оставьте пустым, если провайдер не требует суффикса. | `FORTS` |
| `Symbol1`, `Symbol2`, `Symbol3` | Короткие коды трёх семейств фьючерсов. Стратегия перебирает будущие экспирации, формируя идентификаторы вида `CODE-M.YY`. | `MXI`, `BR`, `SBRF` |
| `Lot1`, `Lot2`, `Lot3` | Целевой объём по каждой ноге. Положительные значения формируют длинную позицию, отрицательные — короткую. | `-4`, `-1`, `5` |
| `HoursBeforeExpiration` | За сколько часов до экспирации начинать процесс ролловера. | `25` |
| `MonitoringCandleType` | Тип свечей, используемых как таймер для проверки экспирации (например, часовые свечи). | Таймфрейм 1 час |

## Роллирование и контроль позиций
- **Поиск контрактов.** Для каждой ноги просматривается до 12 будущих месяцев. Используются несколько форматов кода (`CODE-M.YY`, `CODE-MM.YY`, `CODEMMYY`, `CODEMYY`) с возможным добавлением `BoardCode`. В расчёт берутся только контракты, у которых дата экспирации позже текущего времени.
- **Сердцебиение.** Подписка на свечи активного контракта служит триггером для проверки времени до экспирации и выравнивания объёма позиции.
- **Алгоритм ролла.** Когда до экспирации остаётся меньше или равно `HoursBeforeExpiration`, текущая позиция закрывается, находится следующий контракт с более поздней датой, выполняется переподписка и восстанавливается целевой объём на новом контракте.
- **Синхронизация позиций.** После каждого «технического» тика фактическая позиция сравнивается с целевой, и при необходимости стратегия увеличивает или уменьшает объём рыночными ордерами (в том числе до нуля).

## Рекомендации по использованию
1. Проверьте, что `SecurityProvider` содержит все фьючерсные серии выбранных семейств. Если используются идентификаторы вида `Si-9.23@FORTS`, укажите корректный `BoardCode`.
2. Запускайте стратегию с желаемыми параметрами. Торговые команды отправляются только тогда, когда стратегия в онлайне и торговля разрешена.
3. Все назначения контрактов, корректировки позиций и роллы протоколируются в логах — используйте их для контроля соответствия коротких кодов реальным инструментам.
4. Так как подписка на свечи нужна только для тайминга, можно выбирать любой надёжно доступный таймфрейм.

## Особенности реализации
- Используются высокоуровневые методы (`SubscribeCandles`, `StrategyParam`, `BuyMarket`/`SellMarket`), полностью соответствующие проектным требованиям.
- Не создаются пользовательские коллекции истории; стратегия опирается только на актуальные свечи и текущее состояние позиций.
- Все комментарии в коде написаны на английском языке, что упрощает сопровождение и код-ревью.
