# Стратегия усреднения Amstell SL
[English](README.md) | [中文](README_cn.md)

Конвертация советника MetaTrader `exp_Amstell-SL`. Стратегия сразу открывает длинную и короткую позиции, добавляет новые ордера при движении цены против последнего входа на заданное количество пунктов и закрывает каждую сделку по виртуальным (программным) уровням тейк-профита и стоп-лосса.

## Логика стратегии

- **Стартовые входы**: при запуске, если открытых сделок нет, отправляются рыночные ордера Buy (по Ask) и Sell (по Bid).
- **Наращивание позиции при просадке**:
  - Для покупок: когда текущий Ask ниже цены последнего лонга на `ReentryPoints` пунктов (по умолчанию 10), отправляется новый Buy тем же объёмом.
  - Для продаж: когда текущий Bid выше цены последнего шорта на `ReentryPoints` пунктов, открывается дополнительный Sell тем же объёмом.
- **Правила выхода (виртуальное управление)**:
  - Для каждой сделки Buy контролируются лучшие Bid и Ask. Если Bid вырос на `TakeProfitPoints` пунктов от цены входа или Ask упал на `StopLossPoints` пунктов, лонг закрывается рыночной продажей.
  - Для каждой сделки Sell проверяется, ушёл ли Ask ниже на `TakeProfitPoints` пунктов или вырос ли Bid на `StopLossPoints`. В этих случаях шорт закрывается рыночной покупкой.
- **Последовательность действий**: сначала оцениваются условия выхода, и только затем рассматриваются новые входы, что повторяет логику оригинального эксперта, завершающего обработку тика сразу после закрытия сделки.

## Параметры

- `TakeProfitPoints` – расстояние в пунктах для фиксации прибыли. Значение по умолчанию: `30`.
- `StopLossPoints` – расстояние в пунктах для защиты от убытков. Значение по умолчанию: `30`.
- `Volume` – объём каждого нового ордера. Значение по умолчанию: `0.01`.
- `ReentryPoints` – величина неблагоприятного движения (в пунктах), после которой добавляется очередной ордер. Значение по умолчанию: `10`.

## Дополнительные замечания

- Размер пункта вычисляется по `Security.PriceStep`; если биржа его не предоставляет, используется значение `1`.
- Стратегия может одновременно удерживать лонги и шорты, так как независимо ведёт учёт покупок и продаж, что соответствует хеджирующему стилю оригинального советника.
- Уровни тейк-профита и стоп-лосса исполняются виртуально: на биржевой стакан они не выставляются, закрытие происходит через рыночные заявки.
- Риск быстро возрастает при сильном трендовом движении, поскольку новые ордера добавляются без сокращения предыдущей позиции.
- Наиболее уместно применять стратегию к инструментам, где «пункт» соответствует минимальному шагу цены (например, основные валютные пары на MetaTrader).
