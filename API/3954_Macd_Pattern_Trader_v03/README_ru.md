# Macd Pattern Trader v03 (порт на StockSharp)

## Общее описание
Macd Pattern Trader v03 — это стратегия StockSharp, перенесённая с советника MetaTrader 4 *MacdPatternTraderv03*. Исходный алгоритм ищет на основной линии MACD тройное формирование «пик/впадина» и частично фиксирует прибыль по сигналам скользящих средних. Версия на C# полностью повторяет эту идею, используя подписки StockSharp на свечи, индикаторы и рыночные заявки.

Стратегия ориентирована на поиск истощения тренда на ликвидных валютных парах. По умолчанию используется таймфрейм 30 минут (как и в оригинале) и объём 1 контракт/лот.

## Индикаторы и данные
- **MACD (EMA 5/13, сигнал 1)** — основа паттерна, анализируется только главная линия, без сигнальной.
- **EMA(7) и EMA(21)** — быстрые средние для менеджмента позиции.
- **SMA(98) и EMA(365)** — медленные фильтры, формирующие условия второй ступени фиксации.

Подписка на свечи выполняется через `SubscribeCandles`, а индикаторы связываются с обработчиками методом `Bind`/`BindEx`. Расчёт проводится только по закрывшимся свечам.

## Правила входа
### Короткая позиция
1. Активация происходит, когда MACD поднимается выше уровня **Upper Activation** (0.0030 по умолчанию).
2. Первый пик фиксируется, если MACD формирует локальный максимум выше двух предыдущих значений и затем падает ниже **Upper Threshold** (0.0045).
3. Второй пик запоминается при повторном выходе MACD выше порога, образовании более высокого максимума и обратном возврате под порог.
4. Паттерн подтверждён, когда третье снижение проходит при MACD ниже порога три свечи подряд, а последний максимум ниже предыдущего.
5. Любые длинные позиции закрываются, после чего открывается шорт заданного объёма.

### Длинная позиция
1. Активация — MACD опускается ниже **Lower Activation** (−0.0030).
2. Первый минимум фиксируется после локальной впадины ниже двух предыдущих значений и возврата выше **Lower Threshold** (−0.0045).
3. Второй минимум — повторный уход под порог с более глубокой впадиной и возвращение выше порога.
4. Паттерн подтверждён, если третье повышение проходит при MACD выше порога три свечи подряд и последняя впадина выше предыдущей.
5. Шорт закрывается, открывается лонг объёмом `Volume`.

Логика полностью воспроизводит флаги `stops`, `stops1`, `aop_ok*` из MQ4 и сбрасывает состояния при возврате MACD в активирующую область.

## Управление позицией
- **Поэтапная фиксация** — при достижении незафиксированной прибыли `(Close − Entry) * Position` выше `ProfitThreshold` (по умолчанию 5 ценовых единиц) выполняются два шага:
  - Шаг 1 (лонг): закрытие предыдущей свечи выше EMA(21) — продаётся треть первоначального объёма. Для шорта условие зеркально: закрытие ниже EMA(21), покупается треть начального шорта.
  - Шаг 2 (лонг): максимум предыдущей свечи должен пробить среднее значение SMA(98) и EMA(365) — закрывается половина исходного объёма. Для шорта используется минимум свечи и покупка половины объёма.
- **Оставшаяся позиция** остаётся в рынке без автоматического сопровождения, как и в оригинальном советнике.
- **Защитные заявки** — MQ4-версия ставила стоп-лосс и тейк-профит по экстремумам. В StockSharp такая логика не реализована, поэтому рекомендуется дополнительно подключить `StartProtection()` или внешние модули риск-контроля.

## Параметры
| Параметр | Значение по умолчанию | Назначение |
| -------- | --------------------- | ---------- |
| `Volume` | 1 | Объём входа при каждом сигнале. |
| `CandleType` | 30-минутные свечи | Таймфрейм для индикаторов. |
| `FastEmaLength` / `SlowEmaLength` | 5 / 13 | Периоды EMA в MACD. |
| `UpperThreshold` / `LowerThreshold` | 0.0045 / −0.0045 | Порог подтверждения паттерна. |
| `UpperActivation` / `LowerActivation` | 0.0030 / −0.0030 | Порог активации паттерна. |
| `EmaOneLength` / `EmaTwoLength` | 7 / 21 | Дополнительные EMA для визуализации и менеджмента. |
| `SmaLength` | 98 | Период SMA для второго шага фиксации. |
| `EmaFourLength` | 365 | Медленная EMA для второго шага фиксации. |
| `ProfitThreshold` | 5 | Минимальная незафиксированная прибыль (цена × объём) перед частичным закрытием. |

## Практические рекомендации
- Убедитесь, что брокер поддерживает частичное закрытие. Стратегия повторяет шаги 1/3 и 1/2 из оригинала.
- Стопы/тейки не создаются автоматически. Используйте `StartProtection()` или внешний риск-менеджер, если нужны жёсткие ограничения.
- Порог `ProfitThreshold` задан в ценовых единицах умноженных на объём. Подберите значение в зависимости от тикового размера инструмента, чтобы приблизить его к «5 денежным единицам» из MQ4.
- Паттерн эффективен на плавных трендах. На шумных инструментах количество сигналов может резко сократиться.

## Отличия от MQ4
- Используются индикаторные биндинги StockSharp вместо постоянных вызовов `iMACD`.
- Нереализованная прибыль рассчитывается через `Position` и `PositionAvgPrice`, что может отличаться от `OrderProfit()` в MetaTrader.
- Защитные ордера не выставляются автоматически.
- Параметр `sum_bars_bup`, присутствовавший в исходнике, не использовался и здесь исключён.
