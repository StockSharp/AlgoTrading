# Macd Pattern Trader v03（StockSharp 移植版）

## 概述
Macd Pattern Trader v03 是从 MetaTrader 4 指标顾问 *MacdPatternTraderv03* 转换而来的 StockSharp 策略。原始 EA 通过观察 MACD 主线的三重峰/谷模式并结合移动平均线的分批止盈来寻找趋势衰竭。本 C# 版本复现了核心逻辑，并使用 StockSharp 的烛线订阅、指标绑定与市价下单接口。

策略主要针对流动性较好的外汇品种，默认使用 30 分钟 K 线，与原脚本保持一致；默认手数为 1（在 StockSharp 中表示一个合约或等价手数）。

## 指标与数据流程
- **MACD（快 EMA=5、慢 EMA=13、信号=1）**：仅使用 MACD 主线判断模式，信号线不参与决策。
- **EMA(7)、EMA(21)**：用于仓位管理的短期与中期均线。
- **SMA(98)、EMA(365)**：用于二次减仓触发的慢速滤波器。

策略通过 `SubscribeCandles` 订阅所选周期的蜡烛，并通过 `Bind`/`BindEx` 将指标与回调绑定，确保只在 K 线收盘之后执行逻辑。

## 入场规则
### 做空模式
1. 当 MACD 主线上穿“上方激活阈值”（默认 0.0030）时准备做空。
2. 如果 MACD 在阈值上方形成局部顶点且随后跌破“上方确认阈值”（默认 0.0045），记录第一个峰值。
3. 若 MACD 再次回到确认阈值之上并形成更高的局部顶点，随后再度跌回阈值下方，则记录第二个峰值。
4. 当第三次回落出现，并且 MACD 连续三根 K 线都位于确认阈值下方，同时最后一个顶点低于前一个顶点，则确认做空模式。
5. 清空所有多头持仓后，以设定手数开立空单。

### 做多模式
1. 当 MACD 主线跌破“下方激活阈值”（默认 −0.0030）时准备做多。
2. 如果 MACD 在阈值下方形成局部低点且随后上穿“下方确认阈值”（默认 −0.0045），记录第一个谷值。
3. 若 MACD 再次跌回阈值下方并形成更低的局部低点，随后上穿阈值，则记录第二个谷值。
4. 当第三次上冲出现，并且 MACD 连续三根 K 线位于确认阈值上方，同时最新谷值高于上一谷值时，确认做多模式。
5. 平掉所有空头持仓后，以设定手数买入。

上述逻辑完整复刻了 MQ4 代码中的 `stops`、`stops1` 与 `aop_ok*` 状态机，并在 MACD 回到激活带内时立即复位。

## 仓位管理
- **分批止盈**：当未实现盈亏（`(收盘价 − 开仓价) * 持仓量`）超过 `ProfitThreshold`（默认 5 个价格单位）时启动分批减仓。
  - 阶段一（多头）：上一根 K 线的收盘价需位于 EMA(21) 之上，卖出初始多头仓位的三分之一。空头镜像条件为收盘价低于 EMA(21)，并买回初始空头仓位的三分之一。
  - 阶段二（多头）：上一根 K 线最高价需突破 SMA(98) 与 EMA(365) 的平均值，卖出初始仓位的一半；空头要求最低价跌破相同均值，并买回一半仓位。
- **剩余持仓**：按照原 EA 的做法，剩余仓位不再自动处理。
- **风险控制**：原脚本根据历史高低点设置止损/止盈。本移植版未自动挂出保护单，如需硬止损可结合 `StartProtection()` 或外部风控模块。

## 参数说明
| 参数 | 默认值 | 说明 |
| ---- | ------ | ---- |
| `Volume` | 1 | 每次入场的下单手数。 |
| `CandleType` | 30 分钟 K 线 | 指标计算所用的蜡烛类型。 |
| `FastEmaLength` / `SlowEmaLength` | 5 / 13 | MACD 的快慢均线周期。 |
| `UpperThreshold` / `LowerThreshold` | 0.0045 / −0.0045 | 确认形态的阈值带。 |
| `UpperActivation` / `LowerActivation` | 0.0030 / −0.0030 | 激活形态的外层阈值。 |
| `EmaOneLength` / `EmaTwoLength` | 7 / 21 | 可视化与分批逻辑使用的 EMA 周期。 |
| `SmaLength` | 98 | 与 EMA(365) 组合形成第二阶段触发。 |
| `EmaFourLength` | 365 | 长期 EMA，用于第二阶段条件。 |
| `ProfitThreshold` | 5 | 触发减仓所需的最低未实现盈亏（价格×数量单位）。 |

## 使用建议
- 仅在支持部分减仓的撮合/柜台上使用，策略会按 1/3 与 1/2 的比例执行市价减仓。
- 未自动附加保护单，若需要固定止损，可在策略启动后调用 `StartProtection()` 或组合其他风控策略。
- `ProfitThreshold` 以价格×数量计量，实际使用时需根据品种的点值或最小变动价位调整，才能与原脚本中的“5 个货币单位”保持一致。
- MACD 模式需要较平滑的走势，若在噪声较大的品种上运行，触发概率会显著下降。

## 与 MQ4 版本的差异
- 使用 StockSharp 指标绑定替代了重复的 `iMACD` 调用。
- 未实现盈亏通过 `Position` 与 `PositionAvgPrice` 计算，可能与 MetaTrader 中的 `OrderProfit()` 略有差异。
- 未自动生成止损/止盈委托，需要额外的风险控制模块。
- 原脚本中的 `sum_bars_bup` 参数在 MQ4 中也未被使用，因此在移植版中省略。
