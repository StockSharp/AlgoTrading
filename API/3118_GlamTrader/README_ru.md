# Стратегия GlamTrader

**GlamTrader** — перенос на высокоуровневый API StockSharp экспертного советника MetaTrader `GlamTrader.mq5`. Оригинальный алгоритм сочетает смещённую скользящую среднюю, осциллятор Laguerre RSI и Awesome Oscillator, чтобы отфильтровать импульс перед открытием единственной рыночной позиции. Перенос сохраняет схему принятия решений и правила управления риском, добавляя нативную для StockSharp отправку заявок, визуализацию и защиту позиций.

## Логика работы

1. Подписка на серию свечей `CandleType` (по умолчанию M15). Все индикаторы рассчитываются на этом таймфрейме.
2. Построение настраиваемой скользящей средней по выбранному источнику `AppliedPrice` с последующим смещением на `MaShift` баров — это имитирует буфер, используемый в MetaTrader.
3. Воссоздание фильтра Laguerre RSI внутри стратегии через четырёхступенчатый рекурсивный фильтр. Параметр `LaguerreGamma` управляет сглаживанием, значения остаются в диапазоне `[0;1]`, как у оригинального индикатора `laguerre.mq5`.
4. Вычисление Awesome Oscillator (разность 5/34 SMA от медианной цены) и сохранение текущего и предыдущего значений для оценки наклона.
5. Пока позиции нет:
   - **Лонг** — скользящая средняя расположена выше текущего закрытия, Laguerre RSI превышает `0.15`, Awesome Oscillator растёт относительно предыдущего бара.
   - **Шорт** — скользящая средняя ниже закрытия, Laguerre RSI опускается ниже `0.75`, Awesome Oscillator снижается по сравнению с прошлым баром.
6. При входе расстояния стоп-лосса и тейк-профита переводятся из пунктов в цены с учётом шага цены инструмента. Для трёх- и пятизначных котировок применяется множитель `Point * 10`, как в MQL.
7. Во время сопровождения позиции запускается трейлинг по оригинальному правилу: когда цена проходит больше, чем `TrailingStopPips + TrailingStepPips`, стоп подтягивается на расстояние `TrailingStopPips`. Выход осуществляется при достижении свечой уровня стопа или тейк-профита.

## Входы и выходы

- В любой момент открыта не более одной позиции; обратные сигналы игнорируются до закрытия текущей сделки.
- Лонг требует пересечения цены выше смещённой средней, выхода Laguerre из перепроданности (`> 0.15`) и нарастающего импульса Awesome Oscillator.
- Шорт требует пересечения цены ниже смещённой средней, падения Laguerre из перекупленности (`< 0.75`) и убывающего импульса Awesome Oscillator.
- Стопы и тейки проверяются по максимуму/минимуму свечи, что позволяет фиксировать внутрибара пробития, несмотря на обработку по закрытым свечам.
- Трейлинг реализует тот же порог, что и в MQL: стоп двигается только после прохождения расстояния `stop + step` и никогда не откатывается назад.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `CandleType` | `DataType` | `TimeSpan.FromMinutes(15).TimeFrame()` | Таймфрейм, на котором работают индикаторы и логика. |
| `TradeVolume` | `decimal` | `1` | Объём рыночных заявок. |
| `StopLossBuyPips` | `decimal` | `50` | Расстояние стоп-лосса (в пунктах) для лонгов. |
| `TakeProfitBuyPips` | `decimal` | `50` | Расстояние тейк-профита (в пунктах) для лонгов. |
| `StopLossSellPips` | `decimal` | `50` | Расстояние стоп-лосса (в пунктах) для шортов. |
| `TakeProfitSellPips` | `decimal` | `50` | Расстояние тейк-профита (в пунктах) для шортов. |
| `TrailingStopPips` | `decimal` | `5` | Дистанция трейлинг-стопа в пунктах. Значение `0` отключает трейлинг. |
| `TrailingStepPips` | `decimal` | `15` | Дополнительное движение (в пунктах), необходимое для переноса трейлинг-стопа. |
| `MaPeriod` | `int` | `14` | Период скользящей средней. |
| `MaShift` | `int` | `1` | Смещение скользящей средней в барах. |
| `MaMethod` | `MaMethod` | `LinearWeighted` | Тип скользящей средней (simple, exponential, smoothed, linear weighted). |
| `AppliedPrice` | `AppliedPrice` | `Weighted` | Источник цены для скользящей и фильтра Laguerre. |
| `LaguerreGamma` | `decimal` | `0.7` | Коэффициент сглаживания Laguerre (0–1). |

## Рекомендации по использованию

1. Выберите инструмент, убедитесь, что брокерская модель возвращает шаг цены, и задайте `CandleType` нужному таймфрейму.
2. Адаптируйте пунктовые параметры риска под волатильность инструмента. Перенос автоматически нормализует расстояния через `PriceStep`, а для пятизначных символов применяет множитель ×10.
3. Визуализация добавляет скользящую среднюю на график цены и выводит Awesome Oscillator на отдельную область вместе с вашими сделками.
4. Запустите стратегию — она самостоятельно выставит стопы и будет сопровождать трейлинг, полностью повторяя функции `OpenBuy`, `OpenSell` и `Trailing` из MQL.

## Дополнительно

- Реализация Laguerre RSI соответствует индикатору `laguerre.mq5`, включая нормировку `CU/(CU+CD)`.
- Awesome Oscillator берётся из библиотеки StockSharp, поэтому нет необходимости копировать буферы индикаторов вручную.
- Логика работает по завершённым свечам, что исключает тиковые перерисовки и обеспечивает воспроизводимость тестов.
