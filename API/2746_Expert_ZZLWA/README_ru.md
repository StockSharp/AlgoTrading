# Стратегия Expert ZZLWA

## Общее описание

Стратегия представляет собой перенос советника **ExpertZZLWA** из MetaTrader 5 на высокоуровневый API StockSharp. В оригинальной версии предлагались три режима работы и опциональное мартингейловое наращивание объёма. Перенос сохраняет структуру советника, адаптируя обработку данных под свечи и индикаторы StockSharp:

1. **Original** – чередует покупки и продажи на каждой завершённой свече при отсутствии позиции.
2. **ZigZag Addition** – воссоздаёт сигналы индикатора "ZigZag LW Addition" с помощью скользящих максимумов и минимумов.
3. **Moving Average Test** – повторяет пересечение сглаженной MA (150) и простой MA (10), как в MQL-коде.

Во всех режимах используются настраиваемые стоп-лосс и тейк-профит в пунктах. Дополнительно можно включить мартингейл: после убыточной сделки объём следующей заявки умножается на коэффициент, но ограничивается максимальным значением.

## Логика работы

### Режим Original

- Обработка выполняется только по закрытию свечи.
- При отсутствии позиции стратегия последовательно открывает длинные и короткие рыночные сделки на каждой новой свече.
- Защита устанавливается через `StartProtection`, что автоматически регистрирует стоп и тейк.
- После закрытия позиции направление меняется на противоположное для следующего сигнала.

### Режим ZigZag Addition

- Подписывается на выбранный тип свечей и рассчитывает индикаторы `Highest` и `Lowest`.
- Новая вершина фиксируется, когда максимум свечи достигает текущего максимума и предыдущий экстремум был не восходящим – формируется сигнал на продажу.
- Новая впадина фиксируется при достижении минимального значения – формируется сигнал на покупку.
- Сделки исполняются рыночными заявками сразу после закрытия свечи.

### Режим Moving Average Test

- Используются сглаженная скользящая средняя длиной 150 и простая скользящая средняя длиной 10.
- Сигнал на покупку формируется при пересечении сглаженной MA вверх через простую MA (сравниваются значения на текущей и предыдущей свечах).
- Сигнал на продажу – при пересечении вниз.
- Обработка сигналов выполняется только на завершённых свечах.

### Мартингейл

- В обработчике собственных сделок поддерживается текущая позиция и средняя цена входа.
- При полном закрытии позиции фиксируется результат последней сделки.
- Если сделка оказалась убыточной и включён мартингейл, объём следующего ордера равен `предыдущий_объём × MartingaleMultiplier`, но не превышает `MaximumVolume`.
- При прибыльной сделке или отключённом мартингейле объём возвращается к базовому значению.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|------------------------|----------|
| `StopLossPoints` | 600 | Расстояние до стоп-лосса в пунктах. |
| `TakeProfitPoints` | 700 | Расстояние до тейк-профита в пунктах. |
| `BaseVolume` | 0.01 | Базовый объём заявки при отключённом мартингейле. |
| `UseMartingale` | false | Включение мартингейлового увеличения объёма. |
| `MartingaleMultiplier` | 2 | Множитель, применяемый после убыточной сделки. |
| `MaximumVolume` | 10 | Максимально допустимый объём при мартингейле. |
| `Mode` | Original | Выбранный режим: `Original`, `ZigZagAddition`, `MovingAverageTest`. |
| `ZigZagTerm` | LongTerm | Предустановка чувствительности ZigZag (ShortTerm, MediumTerm, LongTerm). |
| `SlowMaPeriod` | 150 | Период сглаженной MA для режима MA Test. |
| `FastMaPeriod` | 10 | Период простой MA для режима MA Test. |
| `CandleType` | 15 минут | Тип свечей, используемых в расчётах. |

## Дополнительные замечания

- Расстояния стопа и тейка умножаются на `PriceStep` инструмента, что соответствует использованию `_Point` в MetaTrader.
- Стратегия полностью построена на высокоуровневом API (`SubscribeCandles` + привязка индикаторов).
- Предустановки ZigZag соответствуют длинам 12 (Short), 24 (Medium) и 48 (Long) для индикаторов `Highest`/`Lowest`.
- Для корректной работы мартингейла необходимы актуальные уведомления о собственных сделках.

## Отличия от MQL-версии

- Вместо бинарного индикатора "ZigZag LW Addition" используются стандартные индикаторы StockSharp, обеспечивающие аналогичные сигналы.
- Регистрация ордеров выполняется методами `BuyMarket` / `SellMarket` и защитой `StartProtection`, что упрощает управление заявками.
- В MQL объём брался из истории сделок терминала; портирование реализует тот же принцип через анализ приходящих сделок.
- Параметры скольжения и магического номера убраны как нерелевантные для StockSharp.

