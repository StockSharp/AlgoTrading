# Стратегия Forex Currency Power

## Обзор
**Forex Currency Power Strategy** переносит панель *FOREX Currency Power* из MetaTrader в экосистему StockSharp. Стратегия измеряет относительную силу пяти ключевых валют (EUR, USD, GBP, CHF и JPY), объединяя нормализованный импульс четырёх основных валютных пар для каждой валюты. Далее значения силы базовой и котируемой валют сравниваются, чтобы торговать в направлении «сильная против слабой».

Оригинальный скрипт только строил графическое окно. Перенос добавляет полноценную торговую логику: при превышении заданного порога базовая валюта открывает длинную позицию, при доминировании котируемой валюты стратегия разворачивается в шорт. Закрытие позиции происходит, когда разница сил сжимается ниже порога выхода. Все заявки рыночные, чтобы сигнал исполнялся без задержки.

## Ключевые идеи из MQL
- Использование минутных свечей и расчёт только по завершённым барам.
- Сила каждой валюты — это среднее четырёх пар:
  - **EUR**: EURUSD, EURGBP, EURCHF, EURJPY
  - **USD**: EURUSD, GBPUSD, USDCHF, USDJPY (пары с отрицательным весом инвертируются)
  - **GBP**: EURGBP, GBPUSD, GBPCHF, GBPJPY (EURGBP инвертируется)
  - **CHF**: EURCHF, USDCHF, GBPCHF, CHFJPY (EURCHF, USDCHF, GBPCHF инвертируются)
  - **JPY**: EURJPY, USDJPY, GBPJPY, CHFJPY (все пары инвертируются)
- Нормировка пары — положение цены закрытия в диапазоне максимум/минимум последних *N* свечей, что даёт шкалу 0–100, идентичную пользовательскому символу в MetaTrader.

## Реализация
- **Набор индикаторов.** Для каждой пары создаются индикаторы `Highest` и `Lowest` с общим периодом. Привязка реализована через `SubscribeCandles(...).BindEx(...)`, как требует high-level API.
- **Агрегация валют.** При поступлении нового нормализованного значения пересчитываются средние по валютам. Вклады с отрицательным весом инвертируются (`100 - value`), чтобы сохранить диапазон 0–100.
- **Торговый блок.** Решение принимается по свечам инструмента `Strategy.Security`. После проверки готовности данных и разрешения на торговлю стратегия сравнивает силу базовой и котируемой валют. Перед открытием позиции отменяются активные заявки и, при необходимости, закрывается встречный объём.
- **Логирование.** После каждой завершённой свечи торгового инструмента выводится строка с текущей таблицей сил, что заменяет MQL-панель.

## Параметры
| Имя | Описание | Значение по умолчанию | Оптимизация |
| --- | --- | --- | --- |
| `CandleType` | Тип свечей для всех подписок. | Таймфрейм 1 минута | Нет |
| `Lookback` | Число свечей в диапазоне максимум/минимум. | 5 | Да (3 → 20, шаг 1) |
| `EntryThreshold` | Минимальный перевес (база – котировка) для входа. | 15 | Да (5 → 30, шаг 5) |
| `ExitThreshold` | Абсолютная разница, ниже которой позиция закрывается. | 5 | Да (2 → 15, шаг 1) |
| `BaseCurrency` | ISO-код валюты, которую покупаем при лонге. | `EUR` | Нет |
| `QuoteCurrency` | ISO-код валюты, которую продаём при лонге. | `USD` | Нет |
| `EURUSD`, `EURGBP`, `EURCHF`, `EURJPY`, `GBPUSD`, `USDCHF`, `USDJPY`, `GBPCHF`, `GBPJPY`, `CHFJPY` | Инструменты, формирующие корзины. | *(обязательные)* | Нет |

## Рекомендации по использованию
1. До запуска задайте все десять валютных пар и рабочий инструмент. Значения `BaseCurrency` и `QuoteCurrency` должны совпадать с ISO-кодами торгуемой пары (например, `EUR`/`USD` для EURUSD).
2. Стратегии требуется накопить минимум `Lookback` свечей по каждой паре. Пока данные неполные, сделки не совершаются.
3. Пороговые уровни измеряются на шкале 0–100. Чтобы избежать дребезга вокруг точки входа, задайте `ExitThreshold` ниже `EntryThreshold`.
4. Так как используются рыночные заявки, на старте активируется `StartProtection()`. Управляйте размером позиции через стандартное поле `Strategy.Volume` и внешние ограничения риска.

## Особенности портирования
- Таймер и массивы MetaTrader заменены подписками StockSharp с `BindEx`.
- Расчёты выполняются только при `IsFinal`, что исключает влияние незавершённых баров.
- Графический интерфейс заменён структурированными логами и автоматическими сделками, что соответствует шаблону стратегий StockSharp.

