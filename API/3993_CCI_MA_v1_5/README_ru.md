# Стратегия CCI MA v1.5
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник MetaTrader «CCI_MA v1.5» на высокоуровневый API StockSharp. В оригинале сигналы возникают, когда Commodity Channel Index (CCI) пересекает простую скользящую среднюю, рассчитанную по самим значениям CCI, а дополнительный CCI контролирует возвраты из зон ±100. В версии для StockSharp сохранены порядок сигналов, опциональное мани-менеджмент правило и стопы/тейки в пунктах, при этом они реализованы через подписку на свечи и биндинг индикаторов.

## Логика работы
* **Источник данных** – Пользователь задаёт тип свечей (по умолчанию 15-минутные). Оба CCI считают значения по цене закрытия свечи, что повторяет использование `PRICE_CLOSE` в MetaTrader.
* **Основные индикаторы** – Базовый `CommodityChannelIndex` с периодом `CciPeriod` оценивает импульс. Скользящая средняя `SimpleMovingAverage` длиной `MaPeriod` применяется к потоку CCI и образует сигнальную линию. Второй CCI (`SignalCciPeriod`) отслеживает выходы из зон перекупленности/перепроданности около ±100.
* **Вход в позицию** – Длинная позиция открывается на свече, следующей за пересечением вверх: значение CCI на предыдущей свече должно быть выше своей SMA, а двумя свечами ранее – ниже. Короткий сигнал зеркален. При появлении нового сигнала существующая встречная позиция закрывается и переворачивается добавлением её объёма к новому ордеру, как и в MQL-версии.
* **Выход из позиции** – Лонг закрывается, когда контрольный CCI падает с выше +100 до ниже +100 или когда основной CCI пересекает SMA вниз (анализируются две уже закрытые свечи). Шорты закрываются по обратным условиям. Стоп-лосс и тейк-профит имитируют пунктовую систему MetaTrader: стратегия вычисляет размер пункта из `PriceStep` инструмента (для трёх- и пятизначных котировок множитель 10) и сравнивает экстремумы свечи с уровнями `вход ± расстояние` на каждой завершённой свече.
* **Размер позиции** – Параметр `LotVolume` задаёт базовый объём. Если включён `UseMoneyManagement`, объём умножается на целое число `floor(balance / DepositPerLot)` и ограничивается `MaxMultiplier`, что повторяет «лестницу» депозитов из оригинала. Перед отправкой объём приводится к `VolumeStep`, а также учитываются `MinVolume` и `MaxVolume` инструмента.

## Параметры
- **Candle Type** – Тип свечей для расчёта индикаторов.
- **CCI Period** – Период основного осциллятора CCI.
- **Exit CCI Period** – Период контрольного CCI для выходов по уровням ±100.
- **CCI MA Period** – Период простой скользящей средней, применяемой к основному CCI.
- **Lot Volume** – Базовый объём сделки до применения мани-менеджмента.
- **Enable Money Management** – Включает масштабирование объёма по балансу.
- **Deposit Per Lot** – Шаг баланса, который добавляет единицу к множителю объёма (используется только при активном мани-менеджменте).
- **Max Multiplier** – Максимальный множитель для масштабирования объёма.
- **Stop Loss (pips)** – Дистанция защитного стопа в пунктах (0 отключает).
- **Take Profit (pips)** – Дистанция тейк-профита в пунктах (0 отключает).

Перед первой сделкой стратегия ждёт две полностью закрытые свечи, чтобы двухсвечные сравнения точно совпали с задержкой исполнения в MQL. Проверка стоп-лосса и тейк-профита происходит по закрытым свечам и их экстремумам, что приближает работу серверных защитных заявок MetaTrader в рамках высокоуровневого API StockSharp.
