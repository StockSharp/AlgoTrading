# 多品种覆盖对冲策略

将 MetaTrader 4 专家顾问 **“Multicurrency hedge example EA (overlay hedge)”** 转换为 StockSharp 高层 API 版本。

## 概览
- 使用用户提供的外汇品种列表，对所有唯一的组合进行监控。
- 计算滚动皮尔逊相关系数和 ATR 比率，识别联动品种并调整两条腿的仓位大小。
- 构建合成的价格覆盖曲线，检测主品种相对对冲品种的偏离是否超过阈值。
- 根据相关性的正负号开立不同方向的对冲块（买/卖、买/买、卖/买、卖/卖）。
- 当两条腿的综合盈利达到点数或账户货币的目标时整体平仓。

## 工作流程
1. 为宇宙中的每个品种订阅收盘完成的蜡烛，并保存最新的高/低/收盘数据。
2. 为每个品种订阅Level1行情，用于下单前的点差过滤。
3. 每天一次（默认服务器时间 01:00）重新计算可交易的品种对：
   - 仅保留绝对相关系数大于 `CorrelationThreshold` 的组合。
   - 计算 ATR 比率以确定主腿相对于副腿的规模。
4. 在每根收盘蜡烛上检查覆盖差值：
   - 正相关：当偏离低于 `-OverlayThreshold` 时买主卖副；当偏离高于 `+OverlayThreshold` 时卖主买副。
   - 负相关：当偏离低于负阈值时两条腿同时买入；当偏离高于正阈值时两条腿同时卖出。
5. 持续监控已开仓的对冲块，一旦达到任一止盈条件立即整体平仓。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `Universe` | 需要扫描的 `Security` 集合，至少包含两个品种。 | 空 |
| `CandleType` | 用于计算的蜡烛类型。 | 1 分钟 |
| `RangeLength` | 计算价格区间的历史长度（条数）。 | 400 |
| `CorrelationLookback` | 计算皮尔逊相关系数的条数。 | 500 |
| `AtrLookback` | 计算 ATR 比率的条数。 | 200 |
| `CorrelationThreshold` | 仅当绝对相关系数超过该值时才交易该组合（0–1）。 | 0.90 |
| `OverlayThreshold` | 覆盖偏差阈值（以主品种价格步长计的点数）。 | 100 |
| `TakeProfitByPoints` / `TakeProfitPoints` | 启用及设置点数止盈。 | true / 10 |
| `TakeProfitByCurrency` / `TakeProfitCurrency` | 启用及设置货币止盈。 | false / 10 |
| `MaxOpenPairs` | 同时允许持有的对冲块数量。 | 10 |
| `BaseVolume` | 副腿的成交量；主腿成交量 = `BaseVolume * ATR ratio`。 | 1 |
| `RecalculationHour` | 每日重算统计的小时。 | 1 |
| `MaxSpread` | 每条腿允许的最大点差（点）。 | 10 |

## 数据要求
- 为 `Universe` 中的所有品种提供所选蜡烛类型的历史与实时数据。
- 为所有品种提供Level1行情数据，以便执行点差过滤。
- 可用的投资组合信息，用于发送市价单。

## 使用说明
- 策略不会自动构建品种宇宙，启动前需显式设置 `Universe`。
- 为了复现 MT4 的仓位控制，请将 `BaseVolume` 设置为副腿手数，主腿仓位会自动乘以 ATR 比率。
- 在收到第一份盘口数据前，策略会暂停开仓以避免未知点差。
- 综合盈利通过当前价差、价格步长与步长价值估算，不直接包含手续费或掉期。

## 与原始 EA 的差异
- 使用 StockSharp 的 `SubscribeCandles` 和 `SubscribeLevel1` 订阅机制，取代基于计时器的循环查询。
- 止盈通过价格步长估算实现，而非直接读取订单盈亏、佣金与掉期。
- 通过显式传入 `Universe`，可以在 StockSharp 支持的任意品种集合上运行。
- 所有订单均以带标签的市价单发送，便于追踪每个对冲块。

