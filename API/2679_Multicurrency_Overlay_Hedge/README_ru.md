# Стратегия Multicurrency Overlay Hedge

Конвертация советника MetaTrader 4 **«Multicurrency hedge example EA (overlay hedge)»** на высокоуровневый API StockSharp.

## Обзор
- Работает с пользовательским списком валютных инструментов и анализирует все уникальные пары.
- Рассчитывает скользящую корреляцию Пирсона и отношение ATR, чтобы находить связанные инструменты и корректировать объемы ног.
- Формирует синтетические «оверлеи» цен, отслеживая отклонение основной бумаги от связанной пары относительно заданного порога.
- В зависимости от знака корреляции открывает комбинированные блоки сделок: покупка/продажа, покупка/покупка, продажа/покупка или продажа/продажа.
- Закрывает весь блок при достижении совокупного тейк-профита в пунктах либо в валюте портфеля.

## Принцип работы
1. Подписка на завершённые свечи для каждого инструмента и сохранение последних значений High/Low/Close.
2. Подписка на Level1 каждого инструмента для контроля спреда перед отправкой хеджа.
3. Один раз в сутки (по умолчанию в 01:00 серверного времени) пересчёт доступных пар:
   - Остаются только пары, где модуль корреляции выше порога `CorrelationThreshold`.
   - Рассчитывается отношение ATR для масштабирования объёма основной ноги.
4. На каждой закрытой свече оценивается величина отклонения:
   - При положительной корреляции: «покупка основной / продажа вспомогательной» при отклонении ниже `-OverlayThreshold` и «продажа основной / покупка вспомогательной» при отклонении выше `+OverlayThreshold`.
   - При отрицательной корреляции: «покупка обеих» ниже отрицательного порога и «продажа обеих» выше положительного порога.
5. Для открытых блоков отслеживается общий результат и при достижении условий тейк-профита выполняется одновременное закрытие.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `Universe` | Набор объектов `Security`, доступных для поиска пар. Минимум два инструмента. | пусто |
| `CandleType` | Тип свечей, используемый для расчётов. | таймфрейм 1 минута |
| `RangeLength` | Количество баров для построения ценовых диапазонов. | 400 |
| `CorrelationLookback` | Число баров для оценки корреляции Пирсона. | 500 |
| `AtrLookback` | Число баров для расчёта отношения ATR. | 200 |
| `CorrelationThreshold` | Минимальный модуль корреляции, при котором пара включается в торговлю (0–1). | 0.90 |
| `OverlayThreshold` | Порог отклонения в пунктах (используется шаг цены основного инструмента). | 100 |
| `TakeProfitByPoints` / `TakeProfitPoints` | Включение и значение тейк-профита по пунктам. | true / 10 |
| `TakeProfitByCurrency` / `TakeProfitCurrency` | Включение и значение тейк-профита по валюте счёта. | false / 10 |
| `MaxOpenPairs` | Максимальное количество одновременных хедж-блоков. | 10 |
| `BaseVolume` | Объём вспомогательной ноги; объём основной ноги = `BaseVolume * ATR ratio`. | 1 |
| `RecalculationHour` | Час суток для пересчёта статистики. | 1 |
| `MaxSpread` | Максимальный допустимый спред по каждой ноге (в пунктах). | 10 |

## Требования к данным
- Исторические и потоковые свечи указанного типа для всех инструментов `Universe`.
- Поток Level1-сообщений по каждому инструменту для контроля спреда.
- Актуальные данные портфеля, необходимые для регистрации заявок.

## Особенности использования
- Стратегия не формирует список инструментов автоматически: необходимо задать `Universe` перед запуском.
- Для воспроизведения логики MT4 держите `BaseVolume` равным объёму «второй» ноги; «первая» нога масштабируется по отношению ATR.
- При отсутствии данных о спреде новые входы блокируются до получения первого снимка стакана.
- Расчёт совокупной прибыли выполняется по текущему отклонению цены и шагу цены/стоимости шага каждого инструмента.

## Отличия от оригинального советника
- Используются подписки StockSharp (`SubscribeCandles`, `SubscribeLevel1`) вместо таймера с циклическим опросом.
- Тейк-профит вычисляется по шагу цены, комиссии и свопы не учитываются напрямую.
- Необходимость явного задания торговой вселенной делает стратегию переносимой на любые инструменты StockSharp.
- Заявки отправляются как рыночные приказы StockSharp с комментариями, идентифицирующими хедж-блок.

