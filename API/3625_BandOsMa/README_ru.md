# Стратегия BandOsMa

## Обзор
**BandOsMa** — перенос эксперта MetaTrader 5 "BandOsMA" на платформу StockSharp. Стратегия анализирует гистограмму MACD (OsMA), строит на ней полосы Боллинджера и отслеживает пробои за пределы канала. Дополнительное скользящее среднее по OsMA помогает определить, когда сигнал перестаёт быть актуальным.

Стратегия работает с одним инструментом и таймфреймом, выбранными пользователем. Все расчёты выполняются на закрытых свечах через высокоуровневую подписку StockSharp.

## Логика торговли
1. **Индикаторы**
   - `MovingAverageConvergenceDivergenceSignal` используется для получения гистограммы MACD (OsMA).
   - `BollingerBands` применяется непосредственно к значениям OsMA для выявления экстремальных отклонений.
   - Настраиваемое скользящее среднее сглаживает OsMA и служит фильтром выхода.
2. **Вход в позицию**
   - **Покупка**: текущая OsMA закрывается ниже нижней полосы, а предыдущая свеча находилась выше неё.
   - **Продажа**: текущая OsMA закрывается выше верхней полосы, а предыдущая свеча была ниже неё.
3. **Выход**
   - Сигнал сбрасывается при обратном пересечении гистограммы и скользящей средней.
   - Если открытая позиция не соответствует активному сигналу, она закрывается немедленно.
   - На каждую сделку устанавливается стоп-лосс в пунктах, который одновременно используется как трейлинг-стоп с шагом `StopLossPoints / 50` (по аналогии с MQL-реализацией).

## Управление позицией
- **Стоп-лосс и трейлинг**: расстояние задаётся в пунктах MetaTrader и переводится в цену с помощью `PriceStep`. Тот же диапазон применён к трейлингу; стоп переносится вперёд при улучшении цены закрытия на величину шага трейлинга.
- **Единственная позиция**: стратегия держит только один нетто-объём. При появлении противоположного сигнала текущая позиция закрывается, после чего рассматривается новый вход.

## Параметры
| Группа | Параметр | Описание | Значение по умолчанию |
| --- | --- | --- | --- |
| General | `CandleType` | Таймфрейм для расчётов. | `H1` |
| Risk | `LotSize` | Торговый объём в лотах. | `0.01` |
| Risk | `StopLossPoints` | Стоп-лосс в пунктах MetaTrader (также задаёт трейлинг). | `1000` |
| Indicators | `MacdFastPeriod` | Быстрая EMA в MACD. | `12` |
| Indicators | `MacdSlowPeriod` | Медленная EMA в MACD. | `26` |
| Indicators | `MacdSignalPeriod` | EMA сигнальной линии MACD. | `9` |
| Indicators | `PriceType` | Тип цены для MACD (`Close`, `Open`, `High`, `Low`, `Median`, `Typical`, `Weighted`). | `Typical` |
| Indicators | `BollingerPeriod` | Период полос Боллинджера по OsMA. | `26` |
| Indicators | `BollingerShift` | Сдвиг буферов полос Боллинджера (неотрицательный). | `0` |
| Indicators | `BollingerDeviation` | Множитель стандартного отклонения. | `2` |
| Indicators | `MovingAveragePeriod` | Период сглаживающего скользящего среднего OsMA. | `10` |
| Indicators | `MovingAverageShift` | Сдвиг буфера скользящего среднего (неотрицательный). | `0` |
| Indicators | `MovingAverageMethod` | Тип скользящей средней (`Simple`, `Exponential`, `Smoothed`, `LinearWeighted`). | `Simple` |

## Особенности реализации
- Используется `WhenCandlesFinished`, поэтому расчёты выполняются только на завершённых свечах.
- Значения индикаторов сохраняются в списках, что позволяет имитировать сдвиги буферов MetaTrader. Отрицательные значения `shift` не поддерживаются.
- Трейлинг-стоп обновляется по ценам закрытия свечей. Для более точного тикового трейлинга можно увеличить расстояние в пунктах.

## Как использовать
1. Выберите инструмент и таймфрейм в StockSharp.
2. Настройте ключевые параметры (`CandleType`, `LotSize`, периоды индикаторов).
3. Запустите стратегию — она подпишется на свечи, рассчитает индикаторы и будет исполнять сделки в соответствии с описанной логикой.
