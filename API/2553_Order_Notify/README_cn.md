# 订单通知策略

## 概述
订单通知策略是对 MetaTrader 专家顾问 `OrderNotify.mq4` 的移植。策略本身不执行交易逻辑，而是持续监听自身成交，当出现新的持仓或已有持仓被关闭时生成详细通知。所有通知都会写入策略日志，并且可以通过 SMTP 服务器发送电子邮件。

该策略适用于无需盯盘却希望及时获知交易活动的场景。每条通知都会包含：

- 合约代码、交易方向、成交量以及价格；
- 若是平仓成交，还会给出平均入场价与本次平仓的实际盈亏；
- 当前投资组合的名称、余额与本策略会话累计利润。

## 转换说明
- 原始 MQL 程序使用 `OrdersTotal()` 监控持仓数量的变化，并通过 `SendMail` 发送提醒。迁移到 StockSharp 后，改为在 `OnOwnTradeReceived` 回调中处理自有成交，同时利用框架日志系统输出信息。
- 邮件发送由可配置的 SMTP 参数完成；若关闭邮件或未配置，通知仍会完整保留在日志中。
- 策略内部维护持仓规模与均价，以在出现部分减仓或反向开仓时准确复现 MetaTrader 的行为。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| **SendEmails** | 是否启用邮件通知。 | `false` |
| **SmtpHost** | SMTP 服务器主机名。 | 空 |
| **SmtpPort** | SMTP 服务器端口。 | `25` |
| **SmtpUseSsl** | 是否使用 SSL/TLS。 | `true` |
| **SmtpUser** | SMTP 登录名（可选）。 | 空 |
| **SmtpPassword** | SMTP 密码（可选）。 | 空 |
| **EmailFrom** | 发件人邮箱地址。 | 空 |
| **EmailTo** | 收件人邮箱地址。 | 空 |
| **SubjectPrefix** | 邮件主题前缀。 | `"Order Notify: "` |

以上参数均为 `StrategyParam`，可以在启动前随时修改。若保持 SMTP 相关字段为空，通知只会写入日志。

## 处理流程
1. 策略启动时缓存当前持仓数量，并重置内部的均价跟踪变量。
2. 每当产生自有成交时触发 `OnOwnTradeReceived`：
   - 如果成交方向与现有持仓一致，则视为新订单，更新均价并发送“New order”通知；
   - 如果成交方向与持仓相反，则计算被平仓数量的实际盈亏，发送“Closed order”通知，并根据剩余仓位调整均价；
   - 若成交导致持仓翻转，则先针对关闭部分发送通知，再将剩余仓位视为新订单处理。
3. `SendNotification` 会把最终文本写入日志，并在 SMTP 配置完整时发送邮件。

## 邮件配置示例
若希望通过邮件获取通知，请按照以下步骤设置：

1. 将 `SendEmails` 设为 `true`；
2. 填写 `SmtpHost`、`SmtpPort` 以及 `SmtpUseSsl`；
3. 若服务器要求身份验证，设置 `SmtpUser` 与 `SmtpPassword`；
4. 在 `EmailFrom` 中填写发件人地址，在 `EmailTo` 中填写收件人地址；
5. 如需区分不同策略，可自定义 `SubjectPrefix`。

策略内部使用 `System.Net.Mail.SmtpClient` 发送邮件。发送失败时会调用 `LogError` 输出异常信息，便于排查配置问题。

## 使用建议
- 将策略附加到需要监控的证券与组合上，它会针对该实例的所有成交生成通知；
- 可以与其他自动化策略一起运行，只要它们在同一连接器下执行交易，该通知策略就能捕获到成交；
- 日志已经包含了完整信息，仅在需要远程提醒时再启用邮件功能。

