# Стратегия Order Notify

## Обзор
Order Notify — сервисная стратегия, повторяющая функционал экспертного советника MetaTrader `OrderNotify.mq4`. Алгоритм не открывает сделки самостоятельно, а лишь следит за собственными исполнениями и формирует подробные уведомления при появлении новых позиций или закрытии существующих. Все уведомления попадают в лог стратегии и, при необходимости, отправляются по электронной почте через SMTP.

Стратегия полезна, когда нужно получать оперативную информацию о торговой активности без постоянного контроля терминала. Каждое уведомление содержит:

- Тикер инструмента, направление сделки, объём и цену исполнения;
- Для закрывающих сделок — среднюю цену входа и фактический результат по закрытому объёму;
- Сведения о портфеле: название, текущий баланс и накопленный PnL за сессию стратегии.

## Особенности конверсии
- В оригинальном MQL-скрипте использовалась функция `OrdersTotal()` для контроля количества открытых сделок и `SendMail` для отправки сообщений. В StockSharp используется обработчик `OnOwnTradeReceived`, который реагирует на собственные сделки, а также встроенная система логирования.
- Отправка почты реализована через настраиваемый SMTP-клиент. Если почта отключена или параметры не заданы, уведомления доступны в логе.
- Ведётся внутренний учёт позиции и средней цены, что позволяет корректно рассчитывать результат даже при частичном закрытии или развороте позиции.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| **SendEmails** | Включает отправку уведомлений по электронной почте. | `false` |
| **SmtpHost** | Имя хоста SMTP-сервера. | пусто |
| **SmtpPort** | Порт SMTP-сервера. | `25` |
| **SmtpUseSsl** | Использовать ли SSL/TLS. | `true` |
| **SmtpUser** | Учётная запись для авторизации (опционально). | пусто |
| **SmtpPassword** | Пароль для SMTP (опционально). | пусто |
| **EmailFrom** | Адрес отправителя. | пусто |
| **EmailTo** | Адрес получателя. | пусто |
| **SubjectPrefix** | Префикс темы письма. | `"Order Notify: "` |

Все параметры представлены типом `StrategyParam` и могут быть изменены до старта стратегии. Если не заполнять SMTP-поля, уведомления будут только в журнале.

## Логика работы
1. При запуске стратегия сохраняет текущий объём позиции и сбрасывает внутренние накопители средней цены.
2. Для каждой собственной сделки вызывается `OnOwnTradeReceived`:
   - Если сделка увеличивает позицию в ту же сторону, рассчитывается новая средняя цена и отправляется уведомление "New order".
   - Если сделка уменьшает позицию, вычисляется реализованный результат по закрытому объёму, формируется уведомление "Closed order", а средняя цена сохраняется или обнуляется в зависимости от остатка.
   - Если сделка приводит к развороту, сначала отправляется уведомление о закрытии предыдущей позиции, затем остаток рассматривается как новая позиция.
3. Метод `SendNotification` записывает текст в лог и при корректной настройке SMTP отправляет email.

## Пример настройки почты
Чтобы получать уведомления на почту, выполните следующие шаги:

1. Установите `SendEmails` в `true`.
2. Укажите `SmtpHost`, `SmtpPort` и при необходимости включите SSL через `SmtpUseSsl`.
3. Если сервер требует авторизацию, заполните `SmtpUser` и `SmtpPassword`.
4. Укажите адрес отправителя в `EmailFrom` и адрес получателя в `EmailTo`.
5. При желании измените `SubjectPrefix`, чтобы письма легко отфильтровать.

Для отправки используется `System.Net.Mail.SmtpClient`. При ошибках отправки вызывается `LogError`, поэтому проблемы конфигурации легко диагностировать.

## Рекомендации по использованию
- Привяжите стратегию к инструменту и портфелю, за которыми нужно следить. Все сделки этой стратегии будут попадать в уведомления.
- Можно запускать её вместе с другими алгоритмами: если они торгуют через тот же коннектор, уведомления будут формироваться для их сделок.
- Логи уже содержат всю необходимую информацию; включайте почтовые уведомления только при необходимости удалённых оповещений.

