# XP Trade Manager 策略

## 概述
**XP Trade Manager 策略** 完整移植自 MetaTrader 专家顾问“XP Trade Manager”。
策略本身不会开仓，而是负责监管手动或其它策略产生的持仓，自动处理止损、止盈、
移动止损以及保本锁盈逻辑。内置的隐身模式可以在不向交易所提交保护单的情况下，
于内部跟踪价格并触发平仓。

本实现基于 StockSharp 的高级 API，通过订阅 Level1 行情和仓位变化来作出响应。
所有保护动作均以“点”(pip) 为单位配置，并针对 3 位和 5 位报价的外汇品种做了与
原始 MQL 版本一致的点值转换。

## 工作流程
1. 在目标合约上启动策略，并通过人工或外部系统建立仓位。
2. 一旦出现净头寸，管理器会立即布置设定好的止损与止盈（隐身模式下则仅在内部记录）。
3. 当价格向持仓方向运行时，移动止损控制器会按照起始阈值、步长和距离逐步抬升/下移保护价。
4. 若关闭移动止损，则可启用保本逻辑，在达到指定盈利阈值后把止损移动到入场价附近。
5. 启用隐身模式时，一旦内部追踪的止损或止盈被触发，策略会直接发出市价单平仓。
6. 仓位被平掉（无论是人工还是策略操作）后，所有保护设置都会被清理并等待下一次建仓。

## 参数说明
| 参数 | 说明 |
|------|------|
| `StopLossPips` | 初始止损距离（以点为单位）。设为 0 可关闭止损。 |
| `TakeProfitPips` | 初始止盈距离（以点为单位）。设为 0 可关闭止盈。 |
| `UseBreakEven` | 当未启用移动止损时，是否启动保本锁盈逻辑。 |
| `BreakEvenActivationPips` | 触发保本逻辑所需的盈利点数。 |
| `BreakEvenLockPips` | 移动到保本位时锁定的盈利点数，同时也用于“TrailingEndsAtBreakEven”选项。 |
| `UseTrailingStop` | 是否启用移动止损。若为 true，则保本逻辑按原始 EA 的方式被忽略。 |
| `TrailingStartPips` | 开始移动止损所需的盈利点数。 |
| `TrailingStepPips` | 每次更新移动止损所需新增的盈利点数。 |
| `TrailingDistancePips` | 当前价与移动止损之间保持的距离。 |
| `TrailingEndsAtBreakEven` | 是否把移动止损限制在保本锁盈价之内，对应 MQL 中的 TSEndBE。 |
| `StealthMode` | 隐身模式，不向市场提交保护委托，改为在内部监控并用市价单平仓。 |

## 行为细节
- 点值换算遵循 MetaTrader 习惯：对于 3 位或 5 位报价的品种，会将价格步长乘以 10 后再换算成点距。
- 移动止损与原策略一致：仅在达到 `TrailingStartPips` 后启动，按照
  `floor(盈利点数 / TrailingStepPips)` 的方式推进，每次把止损保持在当前价
  `TrailingDistancePips` 点之外；若启用 `TrailingEndsAtBreakEven`，止损不会超过保本价。
- 当移动止损关闭时，保本逻辑会在达到 `BreakEvenActivationPips` 后，把止损移到入场价加上
  `BreakEvenLockPips` 点的锁盈位置。
- 隐身模式下不会提交任何止损/止盈单，而是监听买卖盘价格，在内部阈值被触发时立刻用市价单离场，
  复刻原始 EA 的“隐藏止损”行为。
- 净头寸归零或反向时，策略会自动撤销所有保护委托，并在下一次建仓时重新计算 trailing/保本状态。

## 使用建议
- 需确保 `Security` 对象具备有效的 `PriceStep`，否则点距换算会退化为 1。
- 为保证保护逻辑有效，策略必须持续运行；若停止策略，除隐身模式外的保护委托会被撤销。
- 隐身模式依赖即时流动性，若市场深度不足，实际效果可能与交易所托管的止损不同。
- 原始脚本会在图表上显示当日盈亏，本移植版本专注于风控逻辑，不提供图形化标签。

## 迁移提示
- 默认参数与原 EA 相同：20 点止损、40 点止盈，移动止损默认开启（10/10/15），保本触发为 50 点、锁盈 10 点。
- 原 EA 的 “OnlyCurrentPair” 选项在 StockSharp 中无需额外设置，只需将策略附着在目标合约即可。
- 通过 `StrategyParam` 已为所有关键输入配置了显示信息，可直接在 StockSharp 优化器中调优。
