# Стратегия XP Trade Manager

## Описание
**XP Trade Manager** — это прямой порт советника MetaTrader «XP Trade Manager». Стратегия не
открывает сделки самостоятельно и предназначена для сопровождения вручную открытых позиций или
позиций, созданных другими алгоритмами. Она автоматически выставляет и сопровождает стоп-лосс,
тейк-профит, трейлинг-стоп и перевод в безубыток. Дополнительный режим скрытой работы позволяет
не отправлять защитные заявки на биржу, закрывая позицию рыночным приказом при достижении целевых
уровней.

Реализация построена на высокоуровневом API StockSharp, подписывается на Level1-данные и
реагирует на каждое изменение позиции. Все расстояния задаются в пунктах (pip), а пересчёт в цену
учитывает трёх- и пятизначные котировки так же, как это делает исходный MQL-скрипт.

## Как работает стратегия
1. Запустите стратегию на нужном инструменте и откройте позицию вручную (или другой системой).
2. Как только появляется ненулевая позиция, менеджер сразу размещает указанные стоп-лосс и
   тейк-профит (или сохраняет их значения в памяти при включённом скрытом режиме).
3. При движении цены в сторону позиции трейлинг-контроллер подтягивает стоп в соответствии с
   заданными порогом запуска, шагом и расстоянием.
4. Если трейлинг выключен, включается модуль перевода в безубыток: стоп переносится к цене входа
   плюс защитный отступ, когда прибыль достигает порогового значения.
5. В режиме Stealth стратегия не регистрирует защитные заявки. Вместо этого она отслеживает
   котировки bid/ask и закрывает позицию рыночным ордером, когда внутренняя граница нарушена.
6. Закрытие позиции (вручную или защитой) очищает все заказы и сбрасывает состояние контроллеров.

## Параметры
| Параметр | Назначение |
|----------|------------|
| `StopLossPips` | Начальное расстояние стоп-лосса в пунктах. 0 — отключить. |
| `TakeProfitPips` | Начальное расстояние тейк-профита в пунктах. 0 — отключить. |
| `UseBreakEven` | Включает перевод в безубыток, если трейлинг-стоп отключён. |
| `BreakEvenActivationPips` | Прибыль в пунктах, после которой срабатывает перевод в безубыток. |
| `BreakEvenLockPips` | Количество пунктов, фиксируемых при переводе в безубыток. Используется также при ограничении трейлинга. |
| `UseTrailingStop` | Включает трейлинг-стоп. При значении true перевод в безубыток игнорируется, как в оригинальном советнике. |
| `TrailingStartPips` | Минимальная прибыль в пунктах для запуска трейлинга. |
| `TrailingStepPips` | Дополнительная прибыль в пунктах, необходимая для каждого шага трейлинга. |
| `TrailingDistancePips` | Расстояние между текущей ценой и трейлинг-стопом. |
| `TrailingEndsAtBreakEven` | Ограничивает трейлинг уровнем безубытка (флаг TSEndBE в MQL). |
| `StealthMode` | Скрытый режим: не выставляет заявки, закрывает позицию рыночным приказом. |

## Детали поведения
- Пересчёт пунктов повторяет логику MetaTrader: для трёх- и пятизначных котировок цена шага умножается
  на 10 перед вычислением дистанции.
- Трейлинг запускается после достижения `TrailingStartPips` и использует целочисленный коэффициент
  `floor(прибыль / TrailingStepPips)`. Каждый шаг удерживает стоп на расстоянии `TrailingDistancePips`
  от цены. При включённом `TrailingEndsAtBreakEven` стоп не поднимется выше уровня безубытка.
- Перевод в безубыток выполняется только при отключённом трейлинге и переносит стоп к цене входа плюс
  `BreakEvenLockPips` после достижения `BreakEvenActivationPips`.
- В режиме Stealth стратегия не размещает стоп/лимит-заявки, а просто отслеживает котировки и закрывает
  позицию при достижении внутренних уровней, полностью повторяя «скрытый» режим оригинального советника.
- При закрытии или развороте позиции все активные защитные заявки отменяются, а внутреннее состояние
  трейлинга и безубытка обнуляется.

## Рекомендации по использованию
- У инструмента должен быть корректно задан шаг цены (`PriceStep`), иначе расчёт пунктов будет выполнен с
  шагом 1.
- Для корректной работы защиты стратегия должна быть запущена постоянно; остановка стратегии отменяет
  активные защитные заявки (кроме режима Stealth).
- В скрытом режиме убедитесь в наличии достаточной ликвидности, чтобы рыночное закрытие максимально
  соответствовало ожидаемой цене.
- Оригинальный советник выводил на график статистику по прибыли за день. В данной реализации упор сделан на
  риск-менеджмент, поэтому графические подписи не создаются.

## Подсказки по миграции
- Значения по умолчанию совпадают с MQL-версией: стоп-лосс 20 пунктов, тейк-профит 40 пунктов, трейлинг
  10/10/15, безубыток активируется после 50 пунктов с фиксацией 10 пунктов.
- Опция "OnlyCurrentPair" реализуется автоматически: стратегия работает только с тем инструментом, к которому
  она подключена.
- Все параметры оформлены через `StrategyParam`, поэтому они доступны для оптимизации в стандартных
  инструментах StockSharp.
