# STO M5xM15xM30 策略

## 概述
该策略将 MetaTrader 4 中的 "STO_m5xm15xm30" 专家顾问迁移到 StockSharp 高级 API。核心思想是利用 M5、M15 与 M30 三个周期的随机指标，寻找同步的动量反转。所有关键常量都通过 `StrategyParam` 暴露，可在 StockSharp Designer 中直接优化。

## 交易逻辑
1. **多周期确认**
   - 主周期（默认 M5）随机指标必须出现金叉（`%K` 上穿 `%D`）。
   - 中周期（默认 M15）和慢周期（默认 M30）的 `%K` 已经位于 `%D` 之上。
   - 做空信号需要满足相反的条件。
2. **位移过滤**
   - 主周期随机指标会检查 `ShiftBars` 根之前的状态。做多时要求历史 `%K` 低于 `%D`，确保当前交叉是新的反转；做空时取反。
3. **价格动量过滤**
   - 当前收盘价必须高于上一根收盘价（做多）或低于上一根收盘价（做空），与原脚本中的 `Close[0] > Close[1]` 完全一致。
4. **入场规则**
   - 当没有持仓且满足做多条件时，以 `TradeVolume` 设定的数量买入。
   - 如果已有反向持仓，则先平仓再根据新信号开仓。做空逻辑相同。
5. **离场规则**
   - 单独的 M5 随机指标（周期 `ExitKPeriod`）使用上一根 K 线数据（`shift = 1`）。当多头 `%K` 下穿 `%D` 时平仓；空头 `%K` 上穿 `%D` 时平仓。
   - 触发离场后不会在同一根 K 线上立即反向开仓，贴合原始 EA 的循环顺序。

## 数据订阅与指标
- 主周期蜡烛：默认 5 分钟 (`CandleType`).
- 中周期确认蜡烛：默认 15 分钟 (`MiddleCandleType`).
- 慢周期确认蜡烛：默认 30 分钟 (`SlowCandleType`).
- 所有随机指标的 `%K` 平滑和 `%D` 平滑均为 3。

## 参数
| 参数 | 默认值 | 说明 |
| --- | --- | --- |
| `CandleType` | 5 分钟 | 主工作周期。 |
| `MiddleCandleType` | 15 分钟 | 第一次确认周期。 |
| `SlowCandleType` | 30 分钟 | 第二次确认周期。 |
| `FastKPeriod` | 5 | 主随机指标的 %K 周期。 |
| `MiddleKPeriod` | 5 | 中周期 %K。 |
| `SlowKPeriod` | 5 | 慢周期 %K。 |
| `ExitKPeriod` | 5 | 离场随机指标的 %K 周期。 |
| `ShiftBars` | 3 | 当前信号与历史参考之间的间隔 K 数。 |
| `TakeProfitPoints` | 30 | 止盈距离（点）。 |
| `StopLossPoints` | 10 | 止损距离（点）。 |
| `TradeVolume` | 0.1 | 每次开仓量。 |

所有参数都可以在 Designer 中优化，并实时反映到策略行为中。

## 风险控制
`StartProtection()` 会把原脚本中的 `TP` 和 `SL` 参数转换为 StockSharp 的保护性订单。如需关闭保护，将对应参数设为 0 即可。

## 实现细节
- 通过 `SubscribeCandles().BindEx(...)` 获取指标数值，完全符合 AGENTS.md 的高层 API 约束。
- `StochasticShiftBuffer` 辅助类模拟 MQL 的 `shift` 参数，无需显式访问 `GetValue`。
- 每根完成的蜡烛只处理一次：先执行离场逻辑，再评估新的入场条件。
- 代码中提供英文注释，说明各步骤如何对应原始 MQL 逻辑。

## 使用步骤
1. 在 StockSharp 方案或 Designer 中添加该策略。
2. 选择交易品种，并准备好 M5/M15/M30 周期的历史数据。
3. 根据需要调整参数（周期、位移、止盈止损、手数等）。
4. 启动策略后，系统会自动提交对应的止损/止盈单。
