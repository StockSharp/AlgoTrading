# Стратегия STO M5xM15xM30

## Обзор
Данная стратегия представляет собой конверсию советника MetaTrader 4 «STO_m5xm15xm30» на платформу StockSharp. Логика основана на согласованной работе трёх стохастических осцилляторов на таймфреймах M5, M15 и M30. Код использует высокоуровневый API, поэтому избавлен от ручной обработки заявок и полностью поддерживает оптимизацию параметров через `StrategyParam`.

## Логика торговли
1. **Мульти-таймфреймовое подтверждение**
   - Основной стохастик (по умолчанию M5) должен сформировать бычье пересечение (`%K` выше `%D`).
   - Стохастики на M15 и M30 уже должны находиться в бычьей фазе (`%K` выше `%D`).
   - Для продаж условия зеркальны.
2. **Фильтр смещения**
   - Используется значение стохастика на `ShiftBars` баров назад. Для покупки историческое значение `%K` должно быть ниже `%D`, что подтверждает свежий разворот. Для продажи — наоборот.
3. **Фильтр цены**
   - Текущая свеча должна закрыться выше предыдущей (для покупок) или ниже (для продаж). Это точное соответствие проверке `Close[0] > Close[1]` в MQL.
4. **Вход**
   - При отсутствии позиции и выполнении бычьих условий отправляется рыночная заявка на покупку с объёмом `TradeVolume`.
   - Если открыта противоположная позиция, она сначала закрывается, после чего открывается новая в соответствии с сигналом.
5. **Выход**
   - Дополнительный стохастик M5 с периодом `ExitKPeriod` анализирует предыдущую свечу (`shift = 1`). Лонг закрывается при падении `%K` ниже `%D`, шорт — при подъёме `%K` выше `%D`.
   - После закрытия позиции повторный вход на той же свече не выполняется, что повторяет логику оригинального советника.

## Подписки и индикаторы
- Свечи основного таймфрейма (`CandleType`, по умолчанию M5).
- Свечи подтверждения на M15 (`MiddleCandleType`).
- Свечи подтверждения на M30 (`SlowCandleType`).
- Все стохастики используют сглаживание `%K = 3`, `%D = 3`, как в исходном коде.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | Свечи M5 | Рабочий таймфрейм. |
| `MiddleCandleType` | Свечи M15 | Первое подтверждение. |
| `SlowCandleType` | Свечи M30 | Второе подтверждение. |
| `FastKPeriod` | 5 | Период %K основного стохастика. |
| `MiddleKPeriod` | 5 | Период %K на M15. |
| `SlowKPeriod` | 5 | Период %K на M30. |
| `ExitKPeriod` | 5 | Период %K выходного стохастика. |
| `ShiftBars` | 3 | Количество баров между текущим и контрольным пересечением. |
| `TakeProfitPoints` | 30 | Размер тейк-профита в пунктах. |
| `StopLossPoints` | 10 | Размер стоп-лосса в пунктах. |
| `TradeVolume` | 0.1 | Объём новой позиции. |

Все параметры доступны для оптимизации в Designer и сохраняются в настройках стратегии.

## Управление рисками
Метод `StartProtection()` автоматически преобразует параметры `TP` и `SL` из советника в защитные заявки StockSharp. Чтобы отключить защиту, установите значения в ноль.

## Особенности реализации
- Индикаторы подключаются через `SubscribeCandles().BindEx(...)`, что полностью соответствует рекомендациям AGENTS.md.
- Класс `StochasticShiftBuffer` эмулирует аргумент `shift` из MQL и позволяет обходиться без прямых вызовов `GetValue`.
- Обработка сигналов выполняется один раз на закрытии свечи. Сначала проверяется необходимость выхода, затем — условия для нового входа.
- В коде добавлены подробные англоязычные комментарии, поясняющие соответствие между MQL-логикой и реализацией StockSharp.

## Использование
1. Добавьте стратегию в схему StockSharp или в проект Designer.
2. Назначьте инструмент и убедитесь в наличии истории свечей M5, M15 и M30.
3. При необходимости скорректируйте параметры (объём, периоды стохастика, уровни TP/SL).
4. Запустите стратегию. Защитные ордера будут размещаться автоматически при каждой сделке.
