# Стратегия Nevalyashka Breakdown Level

## Обзор
Nevalyashka Breakdown Level — это конвертация советника MT4 *Nevalyashka_BreakdownLevel* на платформу StockSharp. Стратегия строит утренний диапазон между двумя настраиваемыми метками времени и торгует пробои этого диапазона. Если пробой оказывается ложным и срабатывает стоп, позиция немедленно переворачивается в противоположную сторону с увеличением объёма по мартингейлу, чтобы компенсировать убыток. Любая прибыльная сделка блокирует дальнейшие входы до конца торгового дня, что полностью соответствует оригинальному алгоритму.

## Основные идеи
- **Диапазон открытия:** Максимум и минимум свечей между `RangeStart` и `RangeEnd` задают границы канала на текущий день.
- **Входы по пробою:** Покупка выполняется, когда цена закрытия пересекает верхнюю границу диапазона, продажа — когда закрытие опускается ниже нижней границы.
- **Защитные уровни:** Стоп-лосс устанавливается на противоположной границе диапазона, тейк-профит располагается на расстоянии, равном ширине диапазона.
- **Перевод в безубыток:** При включённом параметре `UseBreakeven` стоп переносится в точку входа после прохождения половины пути к цели.
- **Мартингейл:** При срабатывании стопа стратегия сразу переворачивается, умножает объём на `MartingaleMultiplier` и выставляет симметричные уровни стопа/тейка, рассчитанные на возврат предыдущего убытка.
- **Блокировка на день:** Прибыльная или неубыточная фиксация позиции запрещает новые сделки до смены календарного дня.
- **Принудительное закрытие:** Если `OrdersCloseTime` больше `RangeEnd`, то по достижении этого времени все позиции закрываются и новые входы блокируются до следующего дня.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `RangeStart` | Время начала построения диапазона (включительно). | `04:00` |
| `RangeEnd` | Время окончания построения диапазона (включительно). | `09:00` |
| `OrdersCloseTime` | Время принудительного закрытия позиций. Если больше `RangeEnd`, то после этого момента новые входы запрещены. | `23:30` |
| `OrderVolume` | Объём каждой сделки по пробою. | `0.1` |
| `MartingaleMultiplier` | Множитель объёма следующей сделки после стоп-лосса. | `2` |
| `UseBreakeven` | Переводить ли стоп в безубыток после прохождения половины дистанции до тейка. | `true` |
| `CandleType` | Тип свечей для построения диапазона и сигналов. | Свечи 1 часа |

## Правила торговли
1. **Формирование диапазона.** Каждый торговый день стратегия собирает максимум и минимум всех завершённых свечей между `RangeStart` и `RangeEnd`.
2. **Условия входа.**
   - Длинная позиция открывается, если закрытие свечи выше верхней границы диапазона.
   - Короткая позиция открывается, если закрытие ниже нижней границы.
   - Входы пропускаются, если ожидается мартингейл-переворот, в текущий день уже была прибыльная сделка или текущее время позже `OrdersCloseTime` (при `OrdersCloseTime > RangeEnd`).
3. **Управление риском.**
   - Стоп всегда выставляется на противоположной границе диапазона.
   - Тейк располагается на расстоянии ширины диапазона от цены входа.
   - При активном `UseBreakeven` стоп переносится в точку входа, когда цена проходит половину пути к цели.
4. **Мартингейл-переворот.**
   - При стопе позиция закрывается, объём умножается на `MartingaleMultiplier`, и сразу отправляется заявка в противоположном направлении.
   - Новые уровни стопа и тейка рассчитываются из величины убытка на один лот, делённой на множитель, что повторяет логику оригинального советника.
5. **Блокировка дня.**
   - Любая сделка с неотрицательным результатом блокирует открытия до наступления следующего календарного дня.
6. **Принудительный выход.**
   - Если `OrdersCloseTime` находится после диапазона, то по достижении этого времени стратегия закрывает все позиции и прекращает торговлю до завтра.

## Дополнительные замечания
- Для подписки на данные используются высокоуровневые методы StockSharp (`SubscribeCandles().Bind(...)`).
- Вся необходимая оперативная информация (границы диапазона, состояние мартингейла, признак безубытка) хранится внутри стратегии, что устраняет обращения к истории.
- Поведение по календарным дням и немедленный мартингейл после стопа полностью повторяют исходный MT4 советник.
