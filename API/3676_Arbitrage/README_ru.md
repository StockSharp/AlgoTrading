# Стратегия Arbitrage

## Обзор
**Arbitrage Strategy** — порт стратегии MetaTrader `Arbitrage.mq5`. Она отслеживает валютные пары EURUSD, GBPUSD и EURGBP и сравнивает синтетическую котировку EURGBP (полученную делением EURUSD на GBPUSD) с реальной котировкой EURGBP. Если расхождение превышает суммарные комиссии и текущие спрэды трёх ног, стратегия открывает полностью захеджированный набор рыночных заявок, чтобы зафиксировать дисбаланс.

## Логика торговли
1. Подписка на поток Level 1 для всех трёх инструментов и сохранение лучших цен bid/ask.
2. На каждом обновлении пересчитываются два синтетических курса:
   - `syntheticSell = EURUSD_ask / GBPUSD_bid`
   - `syntheticBuy = EURUSD_bid / GBPUSD_ask`
3. Оцениваются торговые издержки:
   - Сумма текущих спрэдов (`ask - bid`).
   - Комиссия, пересчитанная из лотов в ценовые единицы через минимальный шаг цены кросса.
4. Стоимость округляется до числа знаков, поддерживаемых кроссом, и увеличивается на один пункт (`PriceStep`).
5. Условия входа:
   - **Продажа синтетики / покупка реального кросса**: Sell EURUSD, Buy GBPUSD, Buy EURGBP.
   - **Покупка синтетики / продажа реального кросса**: Buy EURUSD, Sell GBPUSD, Sell EURGBP.
6. В один момент времени разрешён только один арбитражный набор. Перед открытием противоположного набора стратегия закрывает соответствующие позиции, сохраняя нулевой чистый баланс.

## Параметры
| Название | Описание | Значение по умолчанию |
| --- | --- | --- |
| `FirstLeg` | Первая нога для построения синтетической котировки (EURUSD). Обязательный параметр. | — |
| `SecondLeg` | Вторая нога для построения синтетической котировки (GBPUSD). Обязательный параметр. | — |
| `CrossPair` | Кросс (EURGBP), с которым сравнивается синтетический курс. Обязательный параметр. | — |
| `LotSizePerThousand` | Количество лотов на каждые 1000 единиц капитала. Определяет размер корзины. | `0.01` |
| `CommissionPerLot` | Совокупная комиссия за три ноги, выраженная в лотах. | `7` |
| `LogMaxDifference` | Включает логирование максимального наблюдаемого расхождения. | `false` |

## Размер позиции
Объём сделки вычисляется по текущей стоимости портфеля:
```
rawVolume = (portfolioValue / 1000) * LotSizePerThousand
volume = round_to_volume_step(rawVolume, CrossPair.VolumeStep)
volume = min(volume, CrossPair.MaxVolume)
```
Вспомогательная функция использует шаг объёма кросса, чтобы соблюсти брокерские ограничения.

## Риски
- Все три инструмента должны торговаться с одного портфеля/счёта, иначе часть набора может не исполниться.
- Предполагается мгновенное исполнение рыночных ордеров; проскальзывание уменьшает ожидаемую прибыль.
- Следите за непрерывностью Level 1 данных. Сбитые или устаревшие котировки блокируют появление сигналов.
