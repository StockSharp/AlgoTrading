# Стратегия Consolidation Breakout

Эта стратегия повторяет ключевую логику советника **Consolidation Breakout** для MetaTrader. Она ищет короткие периоды консолидации, подтверждённые фильтрами Momentum и MACD, и открывает позицию по направлению выхода из диапазона. Управление риском выполняется с помощью фиксированных уровней тейк-профита и стоп-лосса, задаваемых в шагах цены (пипсах).

## Как работает стратегия

1. Основной таймфрейм задаётся параметром `CandleType`. Все проверки тренда и консолидации выполняются на свечах этого типа.
2. Две линейно-взвешенные скользящие средние (LWMA), рассчитанные по типичной цене, формируют трендовый фильтр. Для длинных сигналов быстрая LWMA должна находиться выше медленной, для коротких — наоборот.
3. Консолидация фиксируется, когда минимум свечи две бары назад остаётся ниже максимума предыдущей свечи (для покупок), либо когда минимум предыдущей свечи находится ниже максимума свечи две бары назад (для продаж). Это воспроизводит логику пересекающихся баров из оригинального кода MQL.
4. Momentum подтверждает импульс. Абсолютное значение индикатора относительно нуля должно превышать соответствующий порог для покупок или продаж — аналог фильтра вокруг уровня 100 в исходном советнике.
5. Отдельный MACD, рассчитанный на таймфрейме `MacdCandleType`, должен поддерживать направление сделки. Стратегия проверяет, чтобы линия MACD опережала сигнальную как в положительной, так и в отрицательной зонах.
6. Когда все условия выполнены и позиция либо отсутствует, либо имеет противоположное направление, отправляется рыночная заявка объёмом `TradeVolume`. Сразу после входа пересчитываются уровни стоп-лосса и тейк-профита в шагах цены, чтобы срабатывание могло произойти по экстремумам свечи.
7. После закрытия каждой свечи стратегия контролирует активные позиции. Если диапазон свечи касается стоп-лосса или тейк-профита, позиция закрывается по рынку, а защитные уровни сбрасываются.

## Используемые индикаторы

- Линейно-взвешенные скользящие средние (быстрая и медленная, типичная цена)
- Momentum
- MACD (периоды 12/26/9 на старшем таймфрейме)

## Параметры

- `CandleType` — основной таймфрейм для поиска пробоев.
- `MacdCandleType` — таймфрейм для подтверждающего фильтра MACD.
- `FastMaPeriod` — период быстрой LWMA.
- `SlowMaPeriod` — период медленной LWMA.
- `MomentumLength` — глубина расчёта Momentum.
- `MomentumBuyThreshold` — минимальное положительное значение Momentum для входа в длинную позицию.
- `MomentumSellThreshold` — минимальное отрицательное (по модулю) значение Momentum для входа в короткую позицию.
- `StopLossPips` — расстояние до стоп-лосса в шагах цены.
- `TakeProfitPips` — расстояние до тейк-профита в шагах цены.
- `TradeVolume` — объём рыночной заявки.

Значения по умолчанию совпадают с опубликованным советником: периоды LWMA 6 и 85, длина Momentum 14, пороги 0.3, стоп-лосс 20 пипсов и тейк-профит 50 пипсов. При торговле инструментами с другим шагом цены скорректируйте соответствующие параметры.

## Дополнительно

- Функции трейлинг-стопа, перевода в безубыток и денежного менеджмента из MQL-версии сознательно опущены, чтобы порт StockSharp сосредоточился на базовой логике пробоя.
- Убедитесь, что выбранные таймфреймы доступны у провайдера данных. Если старший таймфрейм даёт мало баров, уменьшите `MacdCandleType`, чтобы фильтр MACD оставался актуальным.
