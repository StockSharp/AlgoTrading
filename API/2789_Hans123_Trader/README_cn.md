# Hans123 Trader 策略

## 策略概述
Hans123 Trader 是将 MetaTrader 5 上的 *Hans123_Trader* 专家顾问移植到 StockSharp 的突破策略。策略在设定的时间窗口内监控最近 `RangeLength` 根蜡烛的最高价与最低价，并在区间边界上刷新买入/卖出止损挂单，同时支持止损、止盈以及追踪止损。

## 工作原理
1. 订阅指定周期的蜡烛数据，等待 `RangeLength` 个柱子形成完整的通道。
2. 每当有新的完整蜡烛产生时：
   - 更新最近 `RangeLength` 根蜡烛的最高价与最低价。
   - 若当前时间不在 `[StartHour, EndHour)` 区间内，取消所有挂单并跳过本根蜡烛。
   - 在区间内则撤销旧的挂单，并重新下单：
     - 在最高价处挂出 `OrderVolume` 手的买入止损单；
     - 在最低价处挂出 `OrderVolume` 手的卖出止损单。
3. 当任一挂单成交后：
   - 取消方向相反的挂单，避免双向持仓；
   - 如果设置了止损或止盈距离，则按照点差转换成价格，分别提交对冲方向的止损/止盈挂单。
4. 在持仓期间：
   - 若价格较开仓价移动了 `TrailingStopPips + TrailingStepPips` 点，则将止损价格向趋势方向推进 `TrailingStopPips` 点，实现保本或锁盈；
   - 当仓位回到零时，自动撤销所有保护单并清空内部状态。

## 参数说明
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `OrderVolume` | 突破时下单的手数/数量。 | `0.1` |
| `RangeLength` | 计算突破通道的蜡烛数量。 | `80` |
| `StopLossPips` | 止损距离（点）。填 0 表示不开启。 | `50` |
| `TakeProfitPips` | 止盈距离（点）。填 0 表示不开启。 | `50` |
| `TrailingStopPips` | 追踪止损基础距离（点）。填 0 表示关闭追踪。 | `10` |
| `TrailingStepPips` | 追踪止损再次触发所需的额外点数。追踪开启时必须为正数。 | `5` |
| `StartHour` | 允许挂单的起始小时（UTC，含）。 | `6` |
| `EndHour` | 允许挂单的结束小时（UTC，不含）。 | `10` |
| `CandleType` | 计算所用的蜡烛类型/周期。 | `1 小时` |

## 实践建议
- `CalculatePipSize` 会根据证券的小数位自动调整 pip 大小，外汇类 3/5 位报价会得到 ×10 的补偿。
- 如果 `StopLossPips` 为 0，但启用了追踪止损，则首次不会生成保护单，只有当价格达到激活距离后才会提交新的止损单。
- 请确保投资组合的最小/最大成交量限制与 `OrderVolume` 相匹配。
- 策略会绘制蜡烛、通道以及成交记录，方便在图表中验证逻辑。

## 与 MQL5 版本的差异
- 使用 StockSharp 的 `BuyStop`/`SellStop` 等高层 API 注册挂单，而非 MetaTrader 的交易请求接口。
- 参数通过 `StrategyParam` 暴露，可直接用于优化器，与原版默认值保持一致。
- 由于 StockSharp 基于蜡烛完成事件触发，挂单会在每根完成的蜡烛上更新，而非逐 Tick 轮询。

## 使用步骤
1. 将策略绑定到目标证券和投资组合，确认蜡烛周期与原始策略设定一致。
2. 根据交易品种波动性调整止损/止盈和交易时间窗口。
3. 启动策略并在图表上观察通道与成交标记，确保逻辑符合预期。
4. 如需回测或优化，可直接使用参数元数据在 StockSharp 测试框架中运行网格搜索。
