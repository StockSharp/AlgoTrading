# Стратегия Early Top Prorate V1

Данный документ описывает порт советника MetaTrader **earlyTopProrate_V1** на платформу StockSharp. Стратегия ищет внутридневные движения от дневного открытия и поэтапно фиксирует прибыль по трём целям. Конвертация выполнена с использованием высокоуровневого API StockSharp с сохранением ключевых идей управления позицией и капиталом.

## Основная логика

1. **Дневной контекст** – стратегия восстанавливает цену открытия, максимум и минимум текущего дня на основе поступающих свечей. Доминирующее направление определяется сравнением `high - open` и `open - low`.
2. **Торговое окно** – новые сделки открываются только между `StartHour` (включительно) и `EndHour` (исключительно). Значения по умолчанию охватывают раннюю европейскую сессию.
3. **Условия входа** –
   - При доминирующем восходящем движении и закрытии свечи выше дневного открытия открывается длинная позиция.
   - При доминирующем нисходящем движении и закрытии ниже дневного открытия открывается короткая позиция.
   - Одновременно допускается только одна рыночная позиция (`MaxPositions = 1`).
4. **Управление объёмом** – объём сделки рассчитывается выбранным режимом мани-менеджмента. Полученное значение округляется по шагу объёма инструмента и ограничивается биржевыми минимумами и максимумами.
5. **Сопровождение позиции** – после открытия сделки применяется набор выходов, описанный ниже. Логика повторяет оригинальный советник, но реализована через рыночные заявки StockSharp вместо прямого изменения стоп- и тейк-профитов.
6. **Закрытие сессии** – если позиция остаётся открытой к моменту `ClosingHour`, она принудительно закрывается по рынку.

## Управление сделкой

В MQL-версии стопы и тейк-профиты модифицировались вручную. Порт на StockSharp повторяет поведение посредством проверок на каждой закрытой свече:

- **Безубыток после просадки** (`BreakEvenTrigger`) – при движении против позиции на заданное количество пунктов стратегия ждёт возврата к цене входа и закрывает остаток в ноль.
- **Аварийный стоп** (`StopLoss0`) – при превышении допустимой просадки позиция немедленно закрывается.
- **Перенос стопа в безубыток** (`StopLoss1`) – после набранной прибыли стоп переносится на цену входа.
- **Стоп в прибыль** (`StopLoss2`) – при дальнейшем росте прибыли защитный стоп смещается выше (для лонга) или ниже (для шорта) цены входа. Смещение соответствует формуле `StopLoss2 - StopLoss1`, что воспроизводит расчёт `setSL2-35` из оригинала.
- **Частичное закрытие** (`TakeProfit1/2/3` и `Ratio1/2/3`) – каждая из трёх целей закрывает часть текущего объёма позиции. Проценты рассчитываются от остатка, поэтому последующие цели работают с уменьшенным объёмом. Третья цель ликвидирует весь остаток.

Все расстояния задаются в *пунктах*. Параметр `PointMultiplier` умножает биржевой `PriceStep`, повторяя метатрейдеровскую формулу `value * 10 * Point` (значение по умолчанию – 10).

## Режимы мани-менеджмента

Параметр `MoneyManagementType` выбирает один из четырёх вариантов расчёта объёма:

| Режим | Описание |
| --- | --- |
| `0` или `1` | Фиксированный объём, равный `BaseVolume` (как и в оригинальном советнике). |
| `2` | Корень из баланса – `0.1 * sqrt(balance / 1000) * MoneyManagementFactor`, где используется текущая стоимость портфеля. |
| `3` | Модель риска от капитала – `equity / price / 1000 * MoneyManagementRiskPercent / 100`, что повторяет формулу `AccountEquity/Close[0]` в MQL. |

После расчёта объём нормализуется по шагу объёма и биржевым ограничениям.

## Параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Свечной таймфрейм для принятия решений (по умолчанию 5 минут). |
| `StartHour` / `EndHour` | Часы начала и окончания торгового окна (0–23). |
| `ClosingHour` | Час, когда оставшиеся позиции закрываются. |
| `TimeZoneShift` | Справочный сдвиг часового пояса (сохранён для совместимости). |
| `BaseVolume` | Базовый лот до применения мани-менеджмента. |
| `MaxPositions` | Максимальное количество одновременных позиций. |
| `TakeProfit1`, `TakeProfit2`, `TakeProfit3` | Дистанции до трёх целей в пунктах. |
| `BreakEvenTrigger` | Просадка в пунктах, после которой включается выход в безубыток. |
| `StopLoss0`, `StopLoss1`, `StopLoss2` | Пороги для аварийного выхода и переноса стопов. |
| `Ratio1`, `Ratio2`, `Ratio3` | Проценты закрываемого объёма на каждой цели. |
| `MoneyManagementType` | Режим расчёта объёма (0–3). |
| `MoneyManagementFactor` | Множитель для корневой модели. |
| `MoneyManagementRiskPercent` | Процент риска для модели от капитала. |
| `PointMultiplier` | Множитель к биржевому шагу цены при переводе пунктов в реальные цены. |

## Практические рекомендации

- Выбирайте таймфрейм, соответствующий доступной ликвидности и вашему горизонту. 5-минутные свечи дают баланс между скоростью реакции и шумом.
- Если понятие «пункт» на площадке отличается от оригинального MetaTrader, скорректируйте `PointMultiplier`.
- Безубыточная и трейлинговая логика работает по закрытым свечам, поэтому внутрисвечное поведение может отличаться от тикового исполнения MetaTrader. Учтите это при тестах.
- Параметр `TimeZoneShift` носит информативный характер. Настраивайте реальные торговые часы через `StartHour`, `EndHour` и `ClosingHour`.

## Как начать работу

1. Добавьте стратегию в проект StockSharp либо запустите её в Designer/Runner.
2. Настройте свечную подписку (`CandleType`) и торговые часы под выбранный инструмент.
3. Подберите дистанции и доли частичного выхода с учётом волатильности актива.
4. Выберите режим мани-менеджмента и задайте соответствующие параметры (`BaseVolume`, `MoneyManagementFactor`, `MoneyManagementRiskPercent`).
5. Сначала протестируйте стратегию на демо или исторических данных, чтобы убедиться, что порт ведёт себя ожидаемо, прежде чем работать с реальными средствами.

