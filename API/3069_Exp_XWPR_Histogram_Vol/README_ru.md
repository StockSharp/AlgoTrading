# Стратегия Exp XWPR Histogram Vol

## Обзор
Данная стратегия — перенос на C# эксперта MetaTrader **Exp_XWPR_Histogram_Vol**. Алгоритм торгует по смене цветов
пользовательского индикатора XWPR Histogram Vol, который умножает Williams %R на объём свечи и сглаживает результат. В версии
для StockSharp сохранены два независимых торговых слота (основной и дополнительный объём) и полностью воспроизведены правила
входа и выхода, основанные на цветах индикатора.

Обработка ведётся только по закрытым свечам. После формирования новой свечи стратегия анализирует цветовую историю на заданное
количество баров назад и реагирует, когда цветовая зона пересекает бычьи или медвежьи пороги индикатора.

## Логика индикатора
1. Значение Williams %R (`WprPeriod`) сдвигается на +50 и умножается на выбранный тип объёма (`VolumeMode`).
2. Сглаживанию подвергаются и полученный произведение, и исходный объём с помощью одинаковых фильтров (`SmoothingMethod`,
   `SmoothingLength`, `SmoothingPhase`).
3. Из сглаженного объёма вычисляются четыре динамических уровня: `HighLevel2`, `HighLevel1`, `LowLevel1`, `LowLevel2`.
4. Цвета гистограммы соответствуют следующим зонам:
   - **0** – выше `HighLevel2` (сильная бычья зона).
   - **1** – между `HighLevel1` и `HighLevel2` (умеренно бычья зона).
   - **2** – между `LowLevel1` и `HighLevel1` (нейтральная зона).
   - **3** – между `LowLevel2` и `LowLevel1` (умеренно медвежья зона).
   - **4** – ниже `LowLevel2` (сильная медвежья зона).

## Правила сигналов
Для расчёта берутся два цвета: бар `SignalBar + 1` (более старый) и бар `SignalBar` (более новый).

- **Открыть основной лонг (`PrimaryVolume`)** — если старый цвет равен `1`, а новый переходит в `2`, `3` или `4`. Одновременно
  формируется запрос на закрытие шортов.
- **Открыть дополнительный лонг (`SecondaryVolume`)** — если старый цвет `0`, а новый отличается от `0`. Шорты закрываются.
- **Открыть основной шорт (`PrimaryVolume`)** — если старый цвет `3`, а новый поднимается в `0`, `1` или `2`. Лонги закрываются.
- **Открыть дополнительный шорт (`SecondaryVolume`)** — если старый цвет `4`, а новый становится `0`, `1`, `2` или `3`, также
  закрывая лонги.
- **Закрыть лонги** — когда старый цвет `3` или `4`.
- **Закрыть шорты** — когда старый цвет `0` или `1`.

Для каждого направления поддерживаются две независимые позиции. Сигнал приводит к заявке только тогда, когда соответствующий
слот свободен и разрешён вход (`AllowLongEntry`, `AllowShortEntry`).

## Управление рисками
- `StopLossSteps` и `TakeProfitSteps` переводятся в защитные заявки StockSharp через `StartProtection` и задаются в шагах цены.
- `DeviationSteps` сохранён ради совместимости с оригиналом и не влияет на выставление рыночных ордеров.

## Параметры
| Имя | Описание |
|-----|----------|
| `CandleType` | Таймфрейм свечей, которые поступают на индикатор. |
| `PrimaryVolume`, `SecondaryVolume` | Объёмы основного и дополнительного слота. |
| `AllowLongEntry`, `AllowShortEntry` | Разрешение на открытие длинных / коротких позиций. |
| `AllowLongExit`, `AllowShortExit` | Разрешение на закрытие длинных / коротких позиций. |
| `StopLossSteps`, `TakeProfitSteps` | Дистанции защитных ордеров в шагах цены (0 отключает). |
| `DeviationSteps` | Параметр совместимости, не используемый при заявках. |
| `SignalBar` | Сдвиг по закрытым свечам при чтении цвета (0 — последняя закрытая свеча). |
| `WprPeriod` | Период расчёта Williams %R. |
| `VolumeMode` | Источник объёма: `Tick` — количество тиков, `Real` — реальный объём. |
| `HighLevel2`, `HighLevel1` | Множители верхних бычьих уровней. |
| `LowLevel1`, `LowLevel2` | Множители нижних медвежьих уровней. |
| `SmoothingMethod` | Тип сглаживания гистограммы и базового объёма. |
| `SmoothingLength` | Длина сглаживающих фильтров. |
| `SmoothingPhase` | Фаза для сглаживателей на основе Jurik (для остальных методов игнорируется). |

## Примечания по использованию
- Стратегия торгует единственным инструментом из `GetWorkingSecurities()` и использует рыночные заявки.
- Сигналы рассчитываются один раз на закрытой свече, буфер истории предотвращает повторные заявки на том же баре.
- Основной и дополнительный слоты работают независимо; чтобы отключить слот, установите его объём в `0` или снимите флаг
  `Allow*Entry`.
- В переносе не используются MetaTrader magic number и режимы маржи. Размер позиции определяется параметрами `PrimaryVolume`
  и `SecondaryVolume`.
