# Стратегия Zone Recovery Area

## Обзор
**Zone Recovery Area Strategy** — это точная конверсия эксперта MetaTrader «Zone Recovery Area» из пакета `MQL/20266`. Логика зонального хеджирования перенесена на высокоуровневый API StockSharp, а все ключевые параметры вынесены в настройки, что позволяет настраивать поведение без изменения кода. После открытия первой позиции стратегия строит «корзину» из чередующихся сделок покупки и продажи, реагируя на выход цены из заданной зоны и возвращение к базовой цене. Цель — постепенно компенсировать плавающую просадку и закрыть серию с прибылью.

Особенности:
- Тренд фильтруется пересечением двух SMA (быстрая и медленная) вместе с месячным MACD (12/26/9).
- Реализована схема zone recovery: базовая сделка задаёт эталонную цену, а хеджирующие ордера открываются при входе/выходе из зоны вокруг этой цены.
- Поддерживаются три варианта фиксации прибыли: в деньгах, в процентах от баланса и по трейлингу.
- Объём каждой новой сделки может рассчитываться мультипликативно (мартингейл) или аддитивно.

## Данные и индикаторы
- **Основные свечи:** пользовательский таймфрейм (по умолчанию 30 минут) для сигналов и управления серией.
- **Месячные свечи:** строятся при необходимости из меньших таймфреймов и используются для MACD.
- **Индикаторы:**
  - Простые скользящие средние (SMA) на рабочем таймфрейме.
  - MACD с сигнальной линией на месячных свечах.

## Логика торговли
1. **Проверка тренда**
   - Дождаться формирования обеих SMA и месячного MACD.
   - **Бычий сценарий:** на предыдущей свече быстрая SMA ниже медленной, а линия MACD выше сигнальной.
   - **Медвежий сценарий:** на предыдущей свече быстрая SMA выше медленной, а MACD ниже сигнальной.
2. **Инициализация цикла**
   - При появлении сигнала открыть стартовую позицию (`InitialVolume`) и зафиксировать её цену как базовую.
   - Сбросить счётчики и зафиксированные значения прибыли для нового цикла.
3. **Механизм восстановления**
   - Рассчитать две границы: **зону восстановления** (`ZoneRecoveryPips`) относительно базовой цены и **цель по прибыли** (`TakeProfitPips`) в сторону сделки.
   - Пока цикл активен, на каждой закрывшейся свече:
     - Закрыть все позиции, если цена дошла до цели (`base ± take profit`).
     - Завершить цикл при срабатывании денежной, процентной или трейлинг-фиксации.
     - В остальных случаях определить, нужен ли новый хедж:
       - Для длинных циклов: открыть продажу при уходе ниже `base - zone` и покупку при возврате выше базовой цены.
       - Для коротких циклов: открыть покупку при росте выше `base + zone` и продажу при возврате ниже базовой цены.
     - Направление ордеров чередуется автоматически; объём определяется умножением предыдущего объёма или добавлением шага.
   - Общее число сделок в серии ограничено параметром `MaxTrades`.
4. **Управление прибылью**
   - `UseMoneyTakeProfit`: закрыть серию при достижении заданной денежной прибыли.
   - `UsePercentTakeProfit`: закрыть серию при прибыли, равной проценту от стоимости портфеля.
   - `EnableTrailing`: после достижения `TrailingStartProfit` зафиксировать максимум и закрыть серию при откате на `TrailingDrawdown`.

Все заявки отправляются через методы `BuyMarket`/`SellMarket`, что соответствует рекомендациям по использованию высокоуровневого API StockSharp.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --------------------- | -------- |
| `CandleType` | 30 минут | Таймфрейм для входов и контроля цикла. |
| `MonthlyCandleType` | 30 дней | Таймфрейм для расчёта MACD. |
| `FastMaLength` | 20 | Период быстрой SMA. |
| `SlowMaLength` | 200 | Период медленной SMA. |
| `TakeProfitPips` | 150 | Расстояние от базовой цены до цели закрытия серии. |
| `ZoneRecoveryPips` | 50 | Полуширина зоны восстановления. |
| `InitialVolume` | 1 | Объём стартовой сделки. |
| `UseVolumeMultiplier` | true | Включить мультипликативное увеличение объёма. |
| `VolumeMultiplier` | 2 | Множитель объёма при `UseVolumeMultiplier = true`. |
| `VolumeIncrement` | 0.5 | Аддитивный шаг объёма при `UseVolumeMultiplier = false`. |
| `MaxTrades` | 6 | Максимальное число сделок в одном цикле. |
| `UseMoneyTakeProfit` | false | Включить фиксацию прибыли в валюте счёта. |
| `MoneyTakeProfit` | 40 | Целевая прибыль в валюте счёта. |
| `UsePercentTakeProfit` | false | Включить фиксацию прибыли в процентах. |
| `PercentTakeProfit` | 5 | Целевой процент от стоимости портфеля. |
| `EnableTrailing` | true | Включить трейлинг-прибыль. |
| `TrailingStartProfit` | 40 | Порог, после которого активируется трейлинг. |
| `TrailingDrawdown` | 10 | Допустимый откат от максимальной прибыли. |

> **Перевод пунктов в цену:** параметры `TakeProfitPips` и `ZoneRecoveryPips` преобразуются в денежные значения с учётом `PriceStep`. Проверьте корректность шага цены и стоимости шага у выбранного инструмента.

## Практические рекомендации
1. Подключите стратегию к нужному инструменту и портфелю в Designer/API/Runner.
2. Настройте параметры под волатильность актива и допустимый риск.
3. Убедитесь, что история достаточна для прогрева SMA и MACD.
4. Следите за маржинальными требованиями: при мультипликативном наращивании объём растёт очень быстро.
5. Протестируйте стратегию на истории и демо-счёте, прежде чем запускать на реальном рынке.

## Управление риском
- Зональные/мартингейл системы подвержены накоплению большой позиции во время затяжного тренда. Используйте ограничение `MaxTrades` и подбирайте умеренные параметры.
- StockSharp ведёт единую чистую позицию; стратегия самостоятельно восстанавливает PnL серии, используя `PriceStep`/`StepPrice`. Сверяйте расчёты с данными брокера.
- Денежная и процентная фиксации зависят от модели портфеля. В тестах убедитесь, что поля `BeginValue`/`CurrentValue` заполнены.
- Жёсткий стоп-лосс отсутствует — риск контролируется механикой восстановления. При необходимости добавьте внешние портфельные ограничения.

## Файлы
- `CS/ZoneRecoveryAreaStrategy.cs` — реализация стратегии.
- `README.md` — документация на английском языке.
- `README_ru.md` — документация на русском языке (этот файл).
- `README_cn.md` — документация на китайском языке.

