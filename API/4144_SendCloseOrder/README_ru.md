# Стратегия Send Close Order

Send Close Order — порт эксперта MetaTrader 4 «SendCloseOrder», выпущенного Владимиром Хлыстовым в 2009 году. Исходный скрипт наносит на график четыре трендовые линии, построенные по фракталам Билла Вильямса, и открывает либо закрывает рыночные ордера при касании цены этих проекций. Версия под StockSharp полностью повторяет торговую логику, автоматически пересчитывает линии и работает на любой свечной серии.

## Логика торговли

1. **Определение фракталов** — каждая завершённая свеча сдвигает пятибарное окно. Когда окно заполнено, средняя свеча проверяется на соответствие условиям фрактала Билла Вильямса. Подтверждённые максимумы и минимумы сохраняются по времени.
2. **Перестроение линий**
   - *Sell line* соединяет два последних восходящих фрактала, между которыми есть нисходящий фрактал, образуя сопротивление.
   - *Close #1* — это sell line, сдвинутая вверх на `15` пунктов (15 × `Security.PriceStep`), выполняет роль выхода из длинных позиций.
   - *Buy line* соединяет два последних нисходящих фрактала, между которыми есть восходящий фрактал, формируя поддержку.
   - *Close #2* — buy line, сдвинутая вниз на `15` пунктов, является линией закрытия шортов.
3. **Фильтрация сигналов** — четыре линии экстраполируются к времени закрытия свечи. Если рассчитанная цена попадает в диапазон `High-Low` свечи (с допуском в две минимальные цены шага), срабатывает соответствующее действие.
4. **Управление ордерами**
   - Касание Close #1 или Close #2 приводит к немедленному закрытию всей позиции через `ClosePosition()`.
   - Касание Sell или Buy линии открывает рыночный ордер объёмом `TradeVolume`, если итоговая позиция не превысит `MaxOrders × TradeVolume`. При наличии противоположной позиции ордер сначала её компенсирует и только затем добавляет новый вход, имитируя хеджинговый режим MetaTrader.

## Параметры

| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `EnableSellLine` | `true` | Разрешить сделки при касании линии сопротивления. |
| `EnableBuyLine` | `true` | Разрешить сделки при касании линии поддержки. |
| `EnableCloseLongLine` | `true` | Разрешить закрытие длинных позиций по верхней линии (Close #1). |
| `EnableCloseShortLine` | `true` | Разрешить закрытие коротких позиций по нижней линии (Close #2). |
| `MaxOrders` | `1` | Максимальное число наращиваемых входов в одном направлении. |
| `TradeVolume` | `0.1` | Объём каждого рыночного ордера. |
| `CandleType` | таймфрейм 1 час | Свечная серия для расчёта фракталов. |

## Отличия от версии MetaTrader

- В StockSharp линии пересчитываются автоматически при появлении нового фрактала. В MetaTrader их приходилось перерисовывать вручную.
- Используется агрегированная нетто-позиция, поэтому одновременные лонги и шорты не поддерживаются.
- Касание определяется по диапазону завершённой свечи с допуском по шагу цены, а не по мгновенным котировкам Bid/Ask.
- Графические объекты (линии и подписи) не создаются, реализована только торговая логика.

## Рекомендации по использованию

- Стратегия работает на любом инструменте с доступными свечами и корректным `PriceStep`. Если шаг цены не задан, используется значение `0.0001`.
- Увеличивайте `MaxOrders`, чтобы повторить наращивание позиции из оригинального советника, и подбирайте `TradeVolume` с учётом минимального лота.
- Сдвиг линий фиксирован на уровне 15 пунктов — при изменении параметров в MetaTrader требуется корректировка кода.

Предоставлена только C#-версия. Перевод на Python можно добавить позднее при необходимости.
