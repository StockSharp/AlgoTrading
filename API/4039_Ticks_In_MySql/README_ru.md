# Стратегия записи тиков в MySQL

## Обзор
- Реализация эксперта MetaTrader 4 «TicksInMySQL» на платформе StockSharp.
- Устанавливает соединение с сервером MySQL и фиксирует каждую заявку уровня 1 вместе с текущими показателями портфеля.
- Сохраняет задействованную маржу, свободную маржу, собственный капитал, цены Bid/Ask и идентификатор инструмента. Торговые операции не выполняются.

Стратегия предназначена для инфраструктур, где требуется собирать телеметрию по счёту в сторонней базе данных для последующего контроля рисков или отчётности. Алгоритм не открывает и не закрывает позиции — он только записывает данные.

## Требования к MySQL
- Для работы необходим провайдер [MySql.Data](https://www.nuget.org/packages/MySql.Data/). Добавьте пакет в приложение, которое загружает стратегию (Backtester, Designer или собственный проект).
- Учётная запись MySQL должна иметь права на создание таблиц (если включена опция авто‑создания) и на добавление строк в целевую таблицу.
- Узел, на котором запускается стратегия, должен иметь сетевой доступ к серверу MySQL.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Server` | `localhost` | Имя хоста или IP-адрес сервера MySQL. |
| `Port` | `3306` | TCP-порт подключения к серверу. |
| `Database` | `mt4` | Имя базы данных с целевой таблицей. |
| `User` | `user` | Пользователь MySQL. |
| `Password` | `pwd` | Пароль пользователя (хранится в явном виде в настройках). |
| `TableName` | `ticks` | Имя таблицы, куда будут записываться строки. |
| `AutoCreateTable` | `true` | Создавать таблицу при запуске, если она отсутствует (требуются права DDL). |
| `PricePrecision` | `4` | Количество знаков после запятой для цен Bid/Ask (аналог `NormalizeDouble` из MQL). |

## Структура таблицы
При активированной опции `AutoCreateTable` стратегия выполняет запрос (название таблицы подставляется из параметра):

```sql
CREATE TABLE IF NOT EXISTS `ticks` (
    `id` BIGINT NOT NULL AUTO_INCREMENT,
    `margin` DECIMAL(19,6) NOT NULL,
    `freemargin` DECIMAL(19,6) NOT NULL,
    `date` DATETIME NOT NULL,
    `ask` DECIMAL(19,6) NOT NULL,
    `bid` DECIMAL(19,6) NOT NULL,
    `symbol` VARCHAR(64) NOT NULL,
    `equity` DECIMAL(19,6) NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB;
```

При необходимости подберите другие типы данных (например, увеличьте точность). Вставка, выполняемая в процессе работы, соответствует указанному порядку полей.

## Сохраняемые значения
Каждое обновление уровня 1, в котором присутствуют обе цены, приводит к записи строки со следующими данными:

- `margin` — текущее значение `Portfolio.BlockedValue` (задействованная маржа/средства в заявках).
- `freemargin` — рассчитанное значение `Portfolio.CurrentValue - Portfolio.BlockedValue`.
- `date` — отметка времени (UTC) из сообщения сервера, либо из `CurrentTime`, если серверное время отсутствует.
- `ask` — лучшая цена предложения, округлённая до `PricePrecision` знаков.
- `bid` — лучшая цена спроса, округлённая до `PricePrecision` знаков.
- `symbol` — идентификатор инструмента `Security.Id`.
- `equity` — текущий собственный капитал портфеля (`Portfolio.CurrentValue`, при недоступности используется `BeginValue`).

До появления обеих цен стратегия пропускает запись, чтобы не создавать неполные строки.

## Порядок работы
1. Подключите пакет MySql.Data в проект, который использует стратегию.
2. Укажите параметры подключения MySQL и назначьте портфель/инструмент перед запуском.
3. При необходимости включите `AutoCreateTable` для автоматического создания таблицы или создайте её вручную по схеме выше.
4. Запустите стратегию — она подпишется на данные Level 1 и начнёт записи после получения первого полного котировочного сообщения.
5. Следите за журналом: сообщения `LogError` сигнализируют о проблемах с подключением или вставкой. При ошибке подключения на этапе старта стратегия остановится.

## Эксплуатационные замечания
- Вставки в базу защищены блокировкой, что исключает параллельные обращения к одному соединению.
- Ответственность за безопасное хранение паролей лежит на приложении-хосте; стратегия не шифрует учетные данные.
- Алгоритм не содержит торговых правил и может запускаться параллельно с другими стратегиями, которые выполняют сделки.
- Для больших массивов данных добавьте индексы (например, по столбцу `date`), чтобы ускорить аналитические запросы.
