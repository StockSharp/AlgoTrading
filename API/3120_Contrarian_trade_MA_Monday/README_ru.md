# Стратегия Contrarian Trade MA Monday
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет работу советника MetaTrader **«Contrarian trade MA»**, но реализована на высокоуровневом API StockSharp. Она комбинирует недельный контекст и фильтр входа по понедельникам, чтобы торговать против экстремальных движений. Система ждёт открытия новой торговой недели, измеряет, насколько предыдущая неделя закрылась выше максимума или ниже минимума за выбранный период, и проверяет, располагается ли предыдущая величина скользящей средней по другую сторону от текущего недельного открытия. Если после закрытия первой дневной свечи недели выполняется хотя бы одно из условий, открывается контртрендовая позиция.

Логика работает только с закрытыми свечами. Дневной ряд (по умолчанию) управляет входами и выходами, а недельный ряд поставляет уровни экстремумов и сигнал скользящей средней. Каждый раз, когда закрывается свеча понедельника, стратегия оценивает, завершилась ли прошлая неделя выше диапазона максимумов/минимумов или же предыдущая MA оказалась выше/ниже текущего открытия недели. Предполагается, что такие растянутые движения склонны к возврату к среднему в течение недели.

## Принцип работы

1. Недельные свечи питают два индикатора:
   - `Highest` и `Lowest` находят максимум и минимум за `CalcPeriod` недель.
   - Настраиваемая скользящая средняя (`MaPeriod`, `MaMethod`, `MaShift`, `AppliedPrice`) рассчитывается по тем же свечам.
2. Дневные свечи (или любой выбранный `TradeCandleType`) запускают торговые решения после закрытия.
3. При закрытии первой свечи недели с `OpenTime.DayOfWeek == Monday` проверяются условия входа:
   - **Покупка**, если предыдущее недельное закрытие выше найденного максимума или если предыдущая MA больше текущего недельного открытия (цена открылась ниже средней).
   - **Продажа**, если предыдущее недельное закрытие ниже найденного минимума или если предыдущая MA меньше текущего недельного открытия (цена открылась выше средней).
4. Заявки выставляются по рынку (`BuyMarket`/`SellMarket`) с объёмом стратегии, усреднение не применяется. Одновременно может быть открыта только одна позиция.

## Управление выходом

- Фиксированный стоп рассчитывается как `StopLossPips * Security.PriceStep`. Когда значение больше нуля, стратегия контролирует максимумы и минимумы дневных свечей и закрывает позицию по рынку, если уровень стопа был достигнут внутри дня.
- Временной фильтр закрывает любую открытую позицию через семь дней после входа (604800 секунд, как в оригинале). Проверка выполняется на каждой закрытой дневной свече.
- Новая сделка не открывается, пока предыдущая полностью не закрыта.

## Индикаторы и данные

- **Недельные экстремумы:** индикаторы `Highest` и `Lowest`, подключённые к ряду `MaCandleType` (по умолчанию недельные свечи).
- **Недельная скользящая:** поддерживаются методы `Simple`, `Exponential`, `Smoothed`, `LinearWeighted`. Сдвиг `MaShift` позволяет имитировать параметр MetaTrader, а `AppliedPrice` задаёт источник цены.
- **Основной таймфрейм:** `TradeCandleType` определяет свечи, по которым оцениваются входы и стопы; по умолчанию используется дневной ряд, поэтому решение принимается после закрытия понедельника.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CalcPeriod` | `int` | `4` | Количество недельных свечей для расчёта максимумов и минимумов. |
| `StopLossPips` | `int` | `300` | Размер стопа в шагах цены. При `0` стоп отключён. |
| `MaPeriod` | `int` | `7` | Длина недельной скользящей средней. |
| `MaShift` | `int` | `0` | Сдвиг скользящей средней вперёд (в барах). |
| `MaMethod` | `MovingAverageMethod` | `LinearWeighted` | Метод сглаживания (`Simple`, `Exponential`, `Smoothed`, `LinearWeighted`). |
| `AppliedPrice` | `AppliedPriceType` | `Weighted` | Источник цены для скользящей (`Close`, `Open`, `High`, `Low`, `Median`, `Typical`, `Weighted`). |
| `TradeCandleType` | `DataType` | `TimeSpan.FromDays(1).TimeFrame()` | Таймфрейм, по которому принимаются решения и ведётся контроль стопа. |
| `MaCandleType` | `DataType` | `TimeSpan.FromDays(7).TimeFrame()` | Старший таймфрейм для расчёта экстремумов и MA. |

## Примечания

- Размер стопа адаптируется к инструменту: количество пунктов умножается на `Security.PriceStep`. Если шаг цены не задан, стоп фактически не используется.
- Поскольку учитываются только закрытые свечи, вход происходит по цене закрытия понедельника, а не по первому тика недели, что делает результаты воспроизводимыми.
- Стратегия работает с одной позицией: новая сделка появляется только после закрытия текущей по стопу или по сроку удержания.
