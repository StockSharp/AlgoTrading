# Стратегия Trailing Profit

## Обзор
Стратегия Trailing Profit переносит советника MetaTrader 4 `trailing_profit.mq4` в инфраструктуру StockSharp. Оригинальный скрипт не открывает сделок — он следит за плавающей прибылью всех открытых ордеров и после достижения заданного значения активирует трейлинг прибыли. Если незакрытая прибыль откатывается на указанную долю, стратегия мгновенно закрывает всю позицию, фиксируя большую часть накопленного результата. Версия для StockSharp полностью повторяет эту логику, используя высокоуровневый API для подписки на данные, логирования и модулей защиты.

## Принцип работы
1. При запуске стратегия оформляет подписку на тики через `SubscribeTrades()`, чтобы непрерывно отслеживать последнюю цену сделки выбранного инструмента.
2. Каждый пришедший тик пересчитывает плавающую прибыль по формуле `Position * (lastPrice - PositionPrice)`. При отсутствии позиции внутреннее состояние трейлинга сбрасывается.
3. Когда плавающая прибыль становится строго больше `ActivationProfit`, включается режим трейлинга. Первая контрольная граница рассчитывается как `profit - profit * TrailPercent / 100` и определяет минимальную сохраняемую прибыль.
4. При каждом новом максимуме прибыли граница поднимается по той же формуле, полностью повторяя MQL-советник, который обновляет значение `profit_off` при росте прибыли.
5. Если текущая прибыль опускается ниже границы, стратегия отправляет рыночные заявки на полное закрытие позиции. При изменении остаточного объёма (например, частичное исполнение) заявка отправляется повторно до полного выхода из позиции.
6. Когда объём позиции становится нулевым, флаги, граница и вспомогательные переменные сбрасываются. Как только появится новая позиция, цикл трейлинга начнётся заново — вручную или вместе с другой входной стратегией.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TrailPercent` | `33` | Доля прибыли, которую допускается потерять перед закрытием. Значение `33` эквивалентно сохранению 67% от максимальной прибыли. |
| `ActivationProfit` | `1000` | Минимальная плавающая прибыль, которую необходимо превысить для включения трейлинга. |

## Особенности реализации
- `GetWorkingSecurities` возвращает единственную пару `(Security, DataType.Ticks)`, поэтому логика реагирует на каждый тик и не зависит от завершённых свечей.
- Метод `ProcessTrade` повторяет MQL-цикл: включает трейлинг, повышает границу и инициирует закрытие, добавляя подробные сообщения в лог о каждом шаге.
- `ExecuteLiquidation` запоминает направление и объём последней заявки, предотвращая дублирование рыночных ордеров и одновременно пересылая их при изменении остаточного объёма.
- `OnPositionChanged` очищает состояние, как только стратегия выходит в ноль, что соответствует MQL-переменной `close_start`, сбрасывающей данные после закрытия всех ордеров.
- `StartProtection()` вызывается в `OnStarted`, чтобы можно было задействовать стандартные средства защиты StockSharp (стоп-лоссы, тейк-профиты и т.п.), хотя основная логика уже страхует прибыль.

## Использование
Подключите стратегию к инструменту, позицию по которому нужно сопровождать. Модуль не инициирует входы — он только защищает уже открытую позицию и может использоваться совместно с другой стратегией или ручной торговлей для автоматической фиксации прибыли при достижении заданного порога.
