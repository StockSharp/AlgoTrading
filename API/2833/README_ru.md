# Стратегия EA Moving Average

## Обзор
- Конвертация советника MetaTrader **"EA Moving Average"** (редакция barabashkakvn).
- Использует четыре независимые скользящие средние для сигналов входа и выхода в лонг и шорт.
- Рассчитана на один инструмент в неттинговом режиме. По умолчанию используется таймфрейм 15 минут, но можно выбрать любой тип свечей.
- В стратегии одновременно открыта только одна позиция. Пока позиция активна, проверяются только условия выхода.

## Логика торговли
### Вход в лонг
1. Текущая свеча должна закрыться выше скользящей *Buy Open*, открывшись ниже неё (кроссовер внутри одной свечи).
2. Параметр `UseBuy` должен быть включён.
3. Если `ConsiderPriceLastOut` включён, текущая цена должна быть меньше или равна цене последнего закрытия позиции. Это защищает от покупки выше предыдущего выхода.
4. При выполнении условий отправляется рыночная заявка на покупку с объёмом, рассчитанным моделью риска.

### Выход из лонга
1. Актуален только при открытой длинной позиции.
2. Свеча должна открыться выше *Buy Close* и закрыться ниже неё, что даёт медвежий кроссовер.
3. Вся позиция закрывается рыночным ордером.

### Вход в шорт
1. Свеча должна закрыться ниже скользящей *Sell Open* после открытия выше неё.
2. Параметр `UseSell` должен быть включён.
3. При активном `ConsiderPriceLastOut` текущая цена должна быть больше или равна цене последнего выхода, чтобы не продавать ниже предыдущего покрытия.
4. Отправляется рыночная заявка на продажу с объёмом по модели риска.

### Выход из шорта
1. Актуален только при короткой позиции.
2. Свеча должна открыться ниже *Sell Close* и закрыться выше неё.
3. Короткая позиция полностью закрывается по рынку.

## Риск и размер позиции
- `MaximumRisk` задаёт долю капитала, которой стратегия готова рискнуть в одной сделке. Значение умножается на стоимость портфеля и делится на текущую цену инструмента, формируя базовый объём.
- `DecreaseFactor` повторяет уменьшение лота из оригинального советника. После двух и более убыточных сделок подряд объём сокращается пропорционально серии убытков, делённой на `DecreaseFactor`.
- Итоговый объём приводится к шагу объёма инструмента и не опускается ниже одного шага. При сбое расчёта используется свойство `Volume` стратегии (по умолчанию 1 контракт/лот).

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `MaximumRisk` | `0.02` | Доля капитала, которой рискуем в сделке. |
| `DecreaseFactor` | `3` | Коэффициент уменьшения объёма после серии убытков (`0` отключает). |
| `BuyOpenPeriod` | `30` | Период скользящей средней для входа в лонг. |
| `BuyOpenShift` | `3` | Сдвиг (в барах) скользящей для входа в лонг. |
| `BuyOpenMethod` | `Exponential` | Метод скользящей средней для входа в лонг (`Simple`, `Exponential`, `Smoothed`, `LinearWeighted`). |
| `BuyOpenPrice` | `Close` | Тип цены для расчёта скользящей входа в лонг. |
| `BuyClosePeriod` | `14` | Период скользящей средней выхода из лонга. |
| `BuyCloseShift` | `3` | Сдвиг (в барах) скользящей выхода из лонга. |
| `BuyCloseMethod` | `Exponential` | Метод скользящей средней выхода из лонга. |
| `BuyClosePrice` | `Close` | Тип цены для выхода из лонга. |
| `SellOpenPeriod` | `30` | Период скользящей для входа в шорт. |
| `SellOpenShift` | `0` | Сдвиг (в барах) скользящей входа в шорт. |
| `SellOpenMethod` | `Exponential` | Метод скользящей для входа в шорт. |
| `SellOpenPrice` | `Close` | Тип цены для входа в шорт. |
| `SellClosePeriod` | `20` | Период скользящей выхода из шорта. |
| `SellCloseShift` | `2` | Сдвиг (в барах) скользящей выхода из шорта. |
| `SellCloseMethod` | `Exponential` | Метод скользящей выхода из шорта. |
| `SellClosePrice` | `Close` | Тип цены для выхода из шорта. |
| `UseBuy` | `true` | Разрешить длинные сделки. |
| `UseSell` | `true` | Разрешить короткие сделки. |
| `ConsiderPriceLastOut` | `true` | Требовать улучшение цены относительно последнего выхода. |
| `CandleType` | Свечи 15 минут | Тип свечей для расчётов. |

## Дополнительные замечания
- Цена последнего выхода и счётчик убыточных сделок берутся из фактических исполнений, что соответствует поведению в MetaTrader.
- В StockSharp сигналы обрабатываются на завершённых свечах, поэтому фильтр цены сравнивает закрытие свечи с последним выходом, что аппроксимирует проверку по ask/bid в исходном коде.
- Стратегия рассчитана на неттинг; одновременные разнонаправленные позиции не поддерживаются.
- Перед использованием на реальном счёте рекомендуется протестировать стратегию на исторических данных.
