# Стратегия Trade EA Template for News

## Общее описание
Trade EA Template for News Strategy — это порт на C# экспертного советника MetaTrader 4 «Trade EA Template for News». Оригинальная версия отключала торговлю перед и после выхода макроэкономических новостей, которые подгружались с внешних сайтов. Реализация для StockSharp сохраняет идею фильтра новостей и переносит её на высокоуровневый API:

- Работает с завершёнными свечами выбранного таймфрейма (по умолчанию H1).
- Открывает позиции только при отсутствии активных сделок, что полностью повторяет условие `OrdersTotal()<1` из MQL.
- Блокирует открытия сделок в заданные интервалы до и после новостей в зависимости от их важности.
- Автоматически ставит защитные стоп-лосс и тейк-профит на расстоянии 100 пунктов, рассчитанных через шаг цены инструмента.

## Логика торговли
1. На каждой закрытой свече стратегия пересчитывает расписание новостей. Открытие предыдущей свечи сохраняется, чтобы следующая свеча могла сравнить свой закрывающийся уровень с прошлым открытием.
2. Если текущее время попадает в любой запретный интервал, все заявки отменяются, а новые сделки не открываются.
3. При отсутствии позиции и разрешённой торговле:
   - Покупка открывается, если закрытие последней свечи выше открытия предыдущей свечи.
   - Продажа открывается, если закрытие последней свечи ниже открытия предыдущей свечи.
4. Параметры `TakeProfitPoints` и `StopLossPoints` задают расстояние до защитных ордеров в пунктах; фактический ценовой сдвиг рассчитывается умножением на `Security.Step`.

## Ручное расписание новостей
Вместо автоматического скачивания календаря необходимо вручную заполнить параметр `NewsEventsDefinition`. В нём перечисляются события, разделённые точкой с запятой или переводом строки. Каждая запись должна содержать минимум три поля, разделённые запятыми:

```
ГГГГ-ММ-ДД ЧЧ:ММ,ВАЛЮТЫ,ВАЖНОСТЬ[,НАЗВАНИЕ]
```

- `ГГГГ-ММ-ДД ЧЧ:ММ` — время события в UTC. Параметр `TimeZoneOffsetHours` сдвигает все события на указанное количество часов (например, `3` для UTC+3).
- `ВАЛЮТЫ` — коды валют или обозначения инструментов (`USD`, `EUR`, `EUR/USD`). Несколько кодов можно разделять через `/`, `,`, `;`, `|` или пробелы.
- `ВАЖНОСТЬ` — ключевое слово: поддерживаются `Low`, `Medium`, `Mid`, `Midle`, `Moderate`, `High`, `NFP`, а также любые строки, содержащие `Nonfarm` или `Non-farm`.
- `НАЗВАНИЕ` — необязательное описание, которое будет отображаться в логах.

Пример:

```
2024-03-01 13:30,USD,High,Nonfarm Payrolls;2024-03-01 15:00,USD,Low,Factory Orders
```

### Настройка запретных интервалов
- Флаги `UseLowNews`, `UseMediumNews`, `UseHighNews`, `UseNfpNews` включают или выключают соответствующие группы событий.
- Пары параметров `LowMinutesBefore/After`, `MediumMinutesBefore/After`, `HighMinutesBefore/After`, `NfpMinutesBefore/After` задают длительность запрета до и после новости.
- Параметр `OnlySymbolNews` ограничивает фильтр событиями, содержащими валюты из тикера текущего инструмента (например, `EURUSD` → `{EUR, USD}`). При отключении блокируется торговля по всем событиям.
- Если одновременно действует несколько новостей, приоритет имеет событие с наибольшей важностью. В лог выводятся сообщения с указанием причины блокировки и ближайшего релиза.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Тип свечей для подписки (по умолчанию часовые). | `1h` |
| `UseLowNews` | Учитывать новости низкой важности. | `true` |
| `LowMinutesBefore` / `LowMinutesAfter` | Минуты до/после низковажных новостей. | `15 / 15` |
| `UseMediumNews` | Учитывать новости средней важности. | `true` |
| `MediumMinutesBefore` / `MediumMinutesAfter` | Минуты до/после новостей средней важности. | `30 / 30` |
| `UseHighNews` | Учитывать новости высокой важности. | `true` |
| `HighMinutesBefore` / `HighMinutesAfter` | Минуты до/после новостей высокой важности. | `60 / 60` |
| `UseNfpNews` | Учитывать события Non-farm Payrolls. | `true` |
| `NfpMinutesBefore` / `NfpMinutesAfter` | Минуты до/после NFP. | `180 / 180` |
| `OnlySymbolNews` | Фильтровать события по валютам текущего инструмента. | `true` |
| `NewsEventsDefinition` | Строка с расписанием новостей. | пусто |
| `TimeZoneOffsetHours` | Сдвиг часов относительно UTC для всех событий. | `0` |
| `TakeProfitPoints` | Тейк-профит в пунктах. | `100` |
| `StopLossPoints` | Стоп-лосс в пунктах. | `100` |

Значение `Volume` наследуется от базового класса `Strategy` и определяет объём позиции.

## Отличия от MQL-версии
- Нет автоматического веб-запроса — расписание формируется вручную, что делает стратегию автономной и воспроизводимой.
- Визуальные линии и подписи заменены логами вида «Trading paused due to…» и «Next scheduled news…».
- В MQL фиксированный объём 0.01 лота, в StockSharp объём задаётся через `Volume`.
- Вся логика построена на высокоуровневой подписке свечей без прямых обращений к индикаторам.

## Рекомендации по запуску
1. Заполните `NewsEventsDefinition` перед стартом (после изменения параметра перезапустите стратегию, чтобы перечитать список).
2. Настройте `TimeZoneOffsetHours` и длительность окон в соответствии с вашим торговым расписанием.
3. Установите `Volume`, выберите портфель и инструмент, затем запустите стратегию.
4. Контролируйте журнал стратегии — там появятся сообщения о причинах паузы и времени ближайшей новости.

Python-версия намеренно не создаётся по требованию.
