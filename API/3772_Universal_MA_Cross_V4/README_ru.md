# Стратегия Universal MA Cross V4

## Обзор
**Universal MA Cross V4** — порт эксперта MetaTrader 4 «Universal MACross EA v4» на высокоуровневый API StockSharp. Алгоритм отслеживает взаимодействие быстрой и медленной скользящих средних с гибко настраиваемыми параметрами. Поддерживаются разные типы усреднения, выбор источника цены, фильтрация по часам, а также управление позицией с режимом стоп-и-разворот, защитными целями и трейлинг-стопом. Логика выполняется на завершённых свечах, полученных через подписку на тип свечей стратегии.

## Торговая логика
### Обработка индикаторов
* На каждой закрытой свече рассчитываются две скользящие средние. Для каждой можно задать собственный период, метод усреднения (простое, экспоненциальное, сглаженное или линейно-взвешенное) и ценовой источник (close, open, high, low, median, typical, weighted).
* Фильтр **MinCrossDistancePoints** требует, чтобы на свече сигнала быстая и медленная средние расходились минимум на указанное число пунктов. При включённом **ConfirmedOnEntry** проверка выполняется по предыдущей закрытой свече, повторяя режим «confirmed» исходного эксперта.
* Опция **ReverseCondition** меняет местами условия для длинных и коротких сделок без изменения индикаторных настроек.

### Условия входа
1. Длинная позиция открывается, когда быстрая средняя пересекает медленную снизу вверх и разница между ними не меньше **MinCrossDistancePoints**. Для короткой позиции требуется обратное пересечение.
2. При активном **StopAndReverse** появление противоположного сигнала сначала закрывает текущую позицию, после чего допускается разворот.
3. **OneEntryPerBar** не позволяет открыть больше одной позиции внутри одной свечи, стратегия запоминает время последнего входа.
4. Объём заявки задаётся параметром **TradeVolume** и автоматически передаётся в рыночные ордера StockSharp.

### Управление позицией
* **StopLossPoints** и **TakeProfitPoints** задают расстояние до стоп-лосса и тейк-профита в пунктах. Значение переводится в абсолютную цену через шаг цены инструмента. При включённом **PureSar** все защитные механизмы отключаются — это аналог режима «Pure SAR» в MQL-версии.
* Трейлинг-стоп повторяет оригинальный алгоритм: как только цена уходит дальше **TrailingStopPoints** от входа, уровень стопа переносится на то же расстояние за ценой. В режиме **PureSar** трейлинг не используется.
* На каждой закрытой свече стратегия проверяет, пересёк ли диапазон свечи активные уровни стопа или цели. При нарушении позиция закрывается рыночным ордером, что обеспечивает детерминированное поведение в тестах.

### Фильтр торговых часов
* Флаг **UseHourTrade** ограничивает входы интервалом от **StartHour** до **EndHour** (0–23, границы включены). Если окончание меньше начала, окно считается переходящим через полночь. Управление уже открытой позицией (включая трейлинг) продолжает работать вне сессии, но новые входы запрещены.

## Параметры
| Параметр | Описание |
|----------|----------|
| `FastMaPeriod`, `SlowMaPeriod` | Периоды быстрой и медленной скользящих средних. |
| `FastMaType`, `SlowMaType` | Типы усреднения: Simple, Exponential, Smoothed, LinearWeighted. |
| `FastPriceType`, `SlowPriceType` | Источники цен для каждой средней. |
| `StopLossPoints`, `TakeProfitPoints` | Расстояние до стоп-лосса и тейк-профита в пунктах (0 — отключить). |
| `TrailingStopPoints` | Дистанция трейлинг-стопа в пунктах (0 — не использовать). |
| `MinCrossDistancePoints` | Минимальная разница между средними для подтверждения сигнала. |
| `ReverseCondition` | Инвертировать правила для покупок и продаж. |
| `ConfirmedOnEntry` | Подтверждать сигналы по предыдущей свече. Отключение даёт немедленную реакцию. |
| `OneEntryPerBar` | Не более одного входа на свечу. |
| `StopAndReverse` | Закрыть текущую позицию и развернуться при противоположном сигнале. |
| `PureSar` | Отключить стоп-лосс, тейк-профит и трейлинг-стоп. |
| `UseHourTrade`, `StartHour`, `EndHour` | Ограничение торговли по часам. |
| `TradeVolume` | Объём рыночных сделок. |
| `CandleType` | Тип свечей, используемый для расчётов. |

## Особенности конверсии
* Параметры расстояний заданы в пунктах, как в MetaTrader. Метод `GetPriceOffset` переводит эти значения в абсолютные цены через шаг цены или количество знаков инструмента, сохраняя поведение оригинального советника.
* Трейлинг-стоп реализован внутри стратегии, поскольку высокоуровневые стратегии StockSharp работают с завершёнными свечами. Это гарантирует воспроизводимость результатов при тестировании на свечных данных.
* По требованию заказчика предоставлена только C#-версия и многоязычная документация; Python-вариант и соответствующая папка не создавались.
