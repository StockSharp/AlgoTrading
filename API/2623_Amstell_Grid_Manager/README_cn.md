# Amstell 网格管理策略
[English](README.md) | [Русский](README_ru.md)

本策略是 MetaTrader 专家顾问 "exp_Amstell-SL" 的高级 API 版本，用于运行双向加仓网格。策略分别跟踪最近一次的多头或空头成交价，当价格偏离最新成交价达到设定距离时继续加仓；当累计浮盈或浮亏达到设定的止盈、止损距离时，立即通过市价单平掉当前方向的全部仓位。实现基于 StockSharp 的蜡烛订阅与高层下单接口，因此只要有单品种的蜡烛数据即可运行。

为了适配 StockSharp 默认的净持仓模式，移植版本将多头网格与空头网格顺序执行：只要净持仓为非负则维护多头网格；当多头完全平仓后，才允许启动空头网格。

## 工作流程

### 数据与执行
- 订阅参数 `CandleType` 指定的蜡烛序列（默认 1 分钟），仅处理收盘后的蜡烛。
- 根据证券的 `PriceStep` 计算点值；当步长保留 3 或 5 位小数时乘以 10，复刻 MetaTrader 中 3/5 位报价的点值换算。
- 所有交易均通过 `BuyMarket` / `SellMarket` 市价助手完成，不使用挂单。

### 多头管理
- 当没有多头敞口且当前不在平空流程中时，以 `OrderVolume` 的数量开出初始多单。
- 持续记录最新多头成交价和当前多头批次的加权平均持仓价。
- 当收盘价相比最近一次多头成交价至少下跌 `BuyDistancePips`（换算成价格单位）时，加仓同样数量的多头。

### 空头管理
- 只有当多头全部平仓、净持仓不为正时，才允许空头信号生效。
- 若没有空头敞口则开出首笔空单；之后当价格相对于最近空头成交价上涨 `BuyDistancePips * SellDistanceMultiplier` 时继续加仓。
- 同样维护空头的最新成交价与当前批次的加权平均成交价。

### 平仓规则
- 对每个方向计算相对于平均价的未实现盈亏。
- 当多头浮盈达到 `TakeProfitPips` 点或浮亏达到 `StopLossPips` 点时，使用市价卖出全部多头仓位。
- 当空头浮盈达到 `TakeProfitPips` 点或浮亏达到 `StopLossPips` 点时，使用市价买入全部空头仓位。
- 平仓完成后重置所有缓存的价格与仓位信息，等待下一根蜡烛重新启动网格。

### 与原始 MQL 程序的差异
- 使用蜡烛收盘价而非逐笔报价触发逻辑。
- 因净头寸限制，多头与空头网格不能同时持有，而是顺序运行。
- 止盈止损在批次的加权平均价上评估，而不是针对每一张单独订单。

## 参数说明

| 参数 | 默认值 | 优化范围 | 说明 |
|------|--------|----------|------|
| `OrderVolume` | `0.01` | `0.01` – `0.10`（步长 `0.01`） | 每次网格下单的数量，必须大于零。 |
| `TakeProfitPips` | `30` | `10` – `150`（步长 `10`） | 当前批次的止盈距离，单位为点。 |
| `StopLossPips` | `30` | `10` – `150`（步长 `10`） | 当前批次允许的最大回撤距离，单位为点。 |
| `BuyDistancePips` | `10` | `5` – `60`（步长 `5`） | 多头加仓所需的最小回撤距离，必须小于止盈与止损。 |
| `SellDistanceMultiplier` | `10` | `2` – `15`（步长 `1`） | 空头加仓距离相对于多头距离的倍数。 |
| `CandleType` | 1 分钟时间框架 | — | 用于计算信号的蜡烛类型。 |

## 实现提示
- 若 `BuyDistancePips` 不小于 `TakeProfitPips` 或 `StopLossPips`，策略会在启动时抛出异常，以复制原版参数校验。
- 点值由 `PriceStep` 推导，若品种 tick 大小不同需相应调整参数。
- 在 `OnReseted` 中清空全部内部状态，可安全重复启动。
- 实现严格遵循本仓库的高层 API 指南，没有自定义颜色或手动注册指标。
