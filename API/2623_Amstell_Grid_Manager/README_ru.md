# Стратегия Amstell Grid Manager
[English](README.md) | [中文](README_cn.md)

Высокоуровневый порт эксперта MetaTrader "exp_Amstell-SL", реализующий двухсторонний усредняющий сеточный алгоритм. Стратегия хранит последние цены исполнения по каждой стороне и докупает/допродаёт позицию при отклонении цены на заданное расстояние, закрывая весь блок ордеров после достижения фиксированного тейк-профита или стоп-лосса. Реализация использует подписку на свечи и вспомогательные методы высокоуровневого API StockSharp, поэтому её можно подключить к любому источнику свечных данных по одному инструменту.

Перенос адаптирован к неттинговой модели StockSharp: длинная и короткая сетки управляются раздельно, но не удерживаются одновременно. Пока совокупная позиция не отрицательная, активна длинная сетка; после полного закрытия лонга управление передаётся короткой стороне.

## Как работает стратегия

### Поток данных и исполнение
- Подписывается на свечи типа `CandleType` (по умолчанию тайм-фрейм 1 минута) и обрабатывает только завершённые свечи.
- Пересчитывает точки (pips) из `PriceStep`. Если шаг цены имеет 3 или 5 знаков после запятой, он дополнительно умножается на 10 — аналогично оригинальной проверке MetaTrader для инструментов с 3/5-значной точкой.
- Все сделки выполняются рыночными ордерами через `BuyMarket`/`SellMarket`, отложенные заявки не используются.

### Управление длинной сеткой
- Открывает первичный лонг объёмом `OrderVolume`, когда нет существующего длинного экспозиционного блока и не выполняется принудительное закрытие шорта.
- Сохраняет последнюю цену покупки и средневзвешенную цену входа для текущего длинного блока.
- Добавляет очередной лонг тем же объёмом, если цена закрытия опустилась как минимум на `BuyDistancePips` (в пересчёте на цену) ниже последнего исполнения.

### Управление короткой сеткой
- Активируется только после полного закрытия длинного блока, когда чистая позиция не положительная.
- Открывает первый шорт, если нет активных коротких позиций; последующие шорты добавляются при росте цены на `BuyDistancePips * SellDistanceMultiplier` выше последнего короткого исполнения.
- Аналогично хранит последнюю цену продажи и средневзвешенную цену входа короткого блока.

### Правила закрытия
- Для каждого направления рассчитывает нереализованную прибыль относительно средневзвешенной цены входа.
- Закрывает весь длинный блок рыночной продажей при достижении `TakeProfitPips` пунктов прибыли либо `StopLossPips` пунктов просадки.
- Закрывает весь короткий блок рыночной покупкой при тех же расстояниях по прибыли/убытку.
- После ликвидации обнуляет накопленные цены и объёмы, чтобы следующий блок стартовал «с чистого листа».

### Отличия от оригинального эксперта MQL
- Логика основана на закрытиях свечей, а не на тиковых котировках.
- Лонг и шорт выполняются последовательно из-за неттинговой схемы StockSharp.
- Стопы и тейки проверяются относительно средневзвешенной цены блока, а не для каждой заявки отдельно.

## Параметры

| Параметр | Значение по умолчанию | Диапазон оптимизации | Описание |
|----------|-----------------------|----------------------|----------|
| `OrderVolume` | `0.01` | `0.01` – `0.10` (шаг `0.01`) | Объём каждой сеточной заявки. Должен быть положительным. |
| `TakeProfitPips` | `30` | `10` – `150` (шаг `10`) | Цель по прибыли для текущего блока в пунктах. |
| `StopLossPips` | `30` | `10` – `150` (шаг `10`) | Максимально допустимое противодвижение для блока. |
| `BuyDistancePips` | `10` | `5` – `60` (шаг `5`) | Минимальное отклонение вниз перед добором лонга. Должно быть меньше тейка и стопа. |
| `SellDistanceMultiplier` | `10` | `2` – `15` (шаг `1`) | Во сколько раз расстояние для шорта превышает длинное расстояние. |
| `CandleType` | тайм-фрейм 1 минута | — | Тип свечей, по которым выполняются расчёты. |

## Особенности реализации
- При запуске проверяется условие `BuyDistancePips < TakeProfitPips` и `BuyDistancePips < StopLossPips`; при нарушении генерируется исключение, как и в исходном советнике.
- Размер пункта вычисляется по `PriceStep`; при нетипичном шаге цены стоит пересмотреть параметры.
- Метод `OnReseted` полностью очищает внутренние состояния, чтобы повторный запуск начинался без остаточных данных.
- Код соответствует стилевым требованиям репозитория: используется только высокоуровневый API, без явной окраски графика и без ручной регистрации индикаторов.
