# 箭头与曲线策略

## 概述
该策略是 MetaTrader 5 "Arrows and Curves" 专家顾问的 C# 版本。策略在 StockSharp 高阶 API 中复现了原始指标驱动的交易逻辑，只针对单一标的进行操作。每次只有一笔持仓处于激活状态，新的信号会在没有仓位时开仓，或在已有仓位时执行平仓。

## 策略逻辑
- 通过 `SubscribeCandles` 订阅所选时间框的K线，并且只处理已完成的K线，这与原始 EA 仅在新柱出现时运作的方式一致。
- 在策略内部重建 Arrows and Curves 通道：算法在 `SSP` 回溯窗口内（向后偏移 `Relay` 根柱）查找最高价和最低价，再根据 `Channel %` 与 `Channel Stop %` 计算出外层与内层带状线。
- 指标状态变量 `uptrend` 和 `uptrend2` 的更新顺序完全按照 MQL 代码执行。上一根K线出现 Sell 箭头时，策略为多头做好准备；出现 Buy 箭头时，则为空头做好准备。这与原始 EA 在下一根柱读取索引为1的缓冲区值的逻辑一致。
- 当没有持仓时，使用上一根K线保存的信号开市价单，并且方向与箭头相反（Sell 箭头→买入，Buy 箭头→卖出）。
- 当已经有持仓时，若出现反向信号则先行平仓，但不会立刻反向开仓——这与 MT5 源码一致：先退出，再在下一根K线上重新评估入场。

## 风险管理
- 止损与止盈以“点”作为单位，并通过 `PriceStep` 转换为绝对价格距离。如果品种报价有3位或5位小数，则会将最小价位变动乘以10，以复刻 EA 中的点值调整方法。
- 拖尾止损遵循 EA 的实现：当浮动盈利超过 `Trailing Stop + Trailing Step` 时，保护性止损会按设定的距离跟随，并遵守最小移动步长。
- 每根完成的K线都会使用当根的最高价/最低价来近似检测止损或止盈是否触发，以模拟盘中触发效果。
- `Volume` 参数提供固定下单数量；当其设为0时，策略会按照 `Risk %` 将账户价值的一定比例暴露在配置的止损距离之内，从而得到动态下单数量。

## 参数
- `Volume`：固定下单数量；为0时启用风险百分比头寸管理。
- `Risk %`：在启用动态仓位时用于计算风险的账户百分比。
- `Stop Loss (pips)`：以点数表示的止损距离。
- `Take Profit (pips)`：以点数表示的止盈距离。
- `Trailing Stop (pips)`：拖尾止损距离，为0时禁用。
- `Trailing Step (pips)`：拖尾重新移动之前所需的附加点数。
- `SSP`：计算通道范围的回溯K线数量。
- `Channel %`：外层带状线百分比，完全对应原始 MT5 设置。
- `Channel Stop %`：控制内部状态翻转的内层带状线百分比。
- `Relay`：通道计算中使用的偏移量。
- `Candle Type`：参与计算的时间框或K线类型。

## 实现说明
- 策略仅保留计算指标所需的最小历史数据（`SSP + Relay + 5` 根K线）。
- 代码中的注释和辅助函数全部使用英文，以满足仓库约定。
- 与 MT5 不同，止损和止盈在此实现中通过K线的高低价模拟，因此盘中触发可能与原始 EA 略有差异；除这一点外，其余决策逻辑与原始脚本保持一致。
