# Стратегия Arrows and Curves

## Общее описание
Данная стратегия представляет собой перенос советника MetaTrader 5 "Arrows and Curves" на платформу StockSharp. Логика работы индикатора реализована средствами высокоуровневого API, поэтому поведение соответствует исходному MQL-скрипту. Стратегия торгует одним инструментом и одновременно поддерживает только одну открытую позицию: каждый новый сигнал либо инициирует сделку, либо закрывает существующую.

## Логика работы
- Подписка на свечи выполняется через `SubscribeCandles`, обрабатываются только закрытые свечи, что повторяет поведение советника на открытии нового бара.
- Внутри стратегии рассчитывается индикатор Arrows and Curves: для окна `SSP`, сдвинутого на `Relay`, определяются максимум и минимум, после чего строятся внешняя и внутренняя оболочки по процентам `Channel %` и `Channel Stop %`.
- Состояния индикатора (`uptrend` и `uptrend2`) обновляются в том же порядке, что и в оригинальном MQL-коде. Если предыдущая свеча сформировала стрелку Sell, стратегия готовит покупку; если появилась стрелка Buy, готовится продажа. Это соответствует чтению буфера индикатора с индексом 1 на следующем баре.
- При отсутствии позиции стратегия открывает рыночный ордер в направлении, противоположном стрелке (Sell → покупка, Buy → продажа).
- При наличии позиции и появлении противоположного сигнала текущая позиция закрывается, но немедленного разворота не происходит — новая сделка рассматривается уже на следующей свече, как и в исходном советнике.

## Управление рисками
- Стоп-лосс и тейк-профит задаются в пунктах и переводятся в абсолютное расстояние по `PriceStep`. Для инструментов с 3 или 5 знаками после запятой шаг умножается на 10, что повторяет корректировку пипсов в MT5.
- Трейлинг-стоп реализован по аналогии с исходным кодом: когда плавающая прибыль превышает сумму `Trailing Stop + Trailing Step`, стоп подтягивается на заданное расстояние с учетом минимального шага.
- На каждой закрытой свече проверяется достижение уровней стопа/тейка с использованием максимумов и минимумов свечи для аппроксимации внутридневных срабатываний.
- Объем ордера можно задать напрямую через параметр `Volume`. Если значение равно нулю, стратегия рассчитывает количество по проценту риска `Risk %` от стоимости портфеля относительно заданного стоп-лосса.

## Параметры
- `Volume` — фиксированный объем сделки; ноль включает расчет по риску.
- `Risk %` — доля капитала, которую следует рисковать при динамическом расчете объема.
- `Stop Loss (pips)` — расстояние до стоп-лосса в пунктах.
- `Take Profit (pips)` — расстояние до тейк-профита в пунктах.
- `Trailing Stop (pips)` — величина трейлинг-стопа; ноль отключает функцию.
- `Trailing Step (pips)` — минимальное дополнительное движение цены перед очередным переносом трейлинг-стопа.
- `SSP` — количество свечей в расчетном окне индикатора.
- `Channel %` — процент внешней оболочки, аналог MT5-параметра.
- `Channel Stop %` — процент внутренней оболочки для переключения состояния `uptrend2`.
- `Relay` — сдвиг расчетного окна.
- `Candle Type` — тип/таймфрейм свечей, которые обрабатывает стратегия.

## Особенности реализации
- Хранится только минимальный объем исторических данных, необходимый для индикатора (`SSP + Relay + 5` свечей).
- Все комментарии в коде приведены на английском языке в соответствии с требованиями репозитория.
- В отличие от MT5 фактические уровни стоп-лосса и тейк-профита исполняются по данным свечей, поэтому возможны отличия при внутридневных пробоях. Все прочие условия соответствуют оригинальному советнику, что делает перенос максимально точным.
