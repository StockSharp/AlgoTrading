# Стратегия Money Manager

## Обзор
Советник MetaTrader 5 «Money manager 1.0» не открывает новых сделок. Он следит за уже существующими позициями и немедленно закрывает их, когда незакрытая прибыль превышает заданный процент от баланса счёта (с учётом комиссий и текущего спреда) либо когда убыток выходит за предел допустимого процента. Это чистый модуль риск-менеджмента, накладываемый поверх других торговых алгоритмов.

Порт на StockSharp полностью повторяет поведение оригинала. Стратегия подписывается на поток котировок Level1, чтобы всегда иметь актуальные цены bid/ask, и при каждом обновлении пересчитывает плавающий финансовый результат агрегированной позиции. Как только прибыль достигает порога «ProfitDeal», вызывается `ClosePosition()`. Если убыток превышает ограничение «LossDeal», позиция также закрывается. Каждый из фильтров можно отключить, как и в версии MQL.

## Особенности переноса
- Вызов `AccountInfoDouble(ACCOUNT_BALANCE)` заменён на `Portfolio.CurrentValue`. Это ближайший аналог баланса счёта в инфраструктуре StockSharp, поэтому он используется при расчёте целевых значений.
- Котировки берутся через `SubscribeLevel1()`, что позволяет получать best bid/ask и вычислять спред по аналогии с `SymbolInfoDouble` из MetaTrader.
- Показатель `POSITION_PROFIT` воспроизводится через среднюю цену входа `PositionPrice` и цену закрытия, определяемую по лучшим bid/ask (для лонга и шорта соответственно). Тем самым сохраняется знак прибыли для любых направлений.
- Параметры оформлены через `StrategyParam<T>` и могут оптимизироваться или изменяться из пользовательского интерфейса StockSharp.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --------------------- | -------- |
| `ProfitDealEnabled` | `bool` | `true` | Включает закрытие по достижении целевой прибыли. |
| `LossDealEnabled` | `bool` | `true` | Включает ограничение убытка. |
| `ProfitPercent` | `decimal` | `5` | Процент от текущего баланса, который необходимо заработать прежде чем зафиксировать прибыль. |
| `LossPercent` | `decimal` | `5` | Максимально допустимый процент потерь от баланса. |
| `LotCommission` | `decimal` | `7` | Комиссия за один лот, прибавляемая к обоим порогам. |
| `LotSize` | `decimal` | `0.1` | Лот, используемый для пересчёта комиссии и спреда в денежный эквивалент. |

## Работа со стратегией
1. Назначьте стратегии инструмент и портфель, по которым уже есть позиции или они будут открыты другими алгоритмами.
2. Настройте параметры, связанные со стоимостью торговли (`LotCommission`, `LotSize`), чтобы они соответствовали спецификации брокера.
3. Задайте желаемые проценты фиксации прибыли и ограничения убытков. Оба параметра доступны для оптимизации.
4. Запустите стратегию. Она будет отслеживать поток Level1 и закрывать позицию, как только один из порогов Money Manager будет достигнут.

Порт не вмешивается в процесс генерации сделок и не изменяет объёмы – он лишь защищает позиции в соответствии с логикой советника MetaTrader.
