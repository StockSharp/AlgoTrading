# Стратегия Count Orders

## Общее описание
Эта стратегия представляет собой перенос эксперта MetaTrader **Count_Orders.mq4** на платформу StockSharp. Исходный советник
показывал количество открытых ордеров каждого направления через функцию `Comment()` и при запуске создавал три демонстрационные
сделки. Версия на StockSharp сохраняет ту же логику: она постоянно ведёт счёт активных покупок и продаж и выводит результат в
журнал стратегии, одновременно воспроизводя стартовую последовательность из двух покупок и одной продажи, чтобы статистика была
видна сразу после запуска.

Алгоритм полностью событийный: индикаторы не используются. Объём нормализуется единожды при запуске, последовательность ордеров
выполняется асинхронно, а обновление счётчиков происходит в обработчике `OnOrderChanged`.

## Последовательность работы
1. **Нормализация объёма** – перед размещением заявок стратегия подгоняет запрошенный объём под ограничения инструмента (`VolumeStep`,
   `VolumeMin`, `VolumeMax`) и фиксирует корректировки в журнале.
2. **Публикация тестовых ордеров** – отправляются две рыночные заявки на покупку и одна на продажу. Между ними выдерживается
   пауза (по умолчанию 2000 мс), что повторяет вызовы `Sleep()` из MQL, но не блокирует поток стратегии.
3. **Защитные уровни** – после каждого входа пытаемся выставить стоп-лосс и тейк-профит, используя точки MetaTrader. Если нет
   актуальной цены (нет котировок), защитные ордера пропускаются с предупреждением в логе.
4. **Подсчёт ордеров** – в `OnOrderChanged` ордер добавляется или удаляется из соответствующего множества (`HashSet<Order>` для
   покупок и продаж). После каждой смены статуса выводится строка вида: «Orders total now: X. Buys: Y. Sells: Z.».
5. **Остановка** – при остановке стратегии отменяется отложенная асинхронная задача, чтобы не оставлять фоновых задержек.

## Параметры
| Имя | Описание |
| --- | --- |
| **Magic Number** | Значение, которое записывается в `Order.UserOrderId`, полностью повторяя параметр `MAGICMA` из MQL. Помогает
фильтровать демонстрационные сделки в отчётах. |
| **Stop-Loss Points** | Дистанция защитного стоп-лосса в пунктах MetaTrader. Ноль отключает постановку стопа. |
| **Take-Profit Points** | Дистанция тейк-профита в пунктах MetaTrader. Ноль отключает постановку цели. |
| **Trade Volume** | Объём каждой демонстрационной сделки. Приводится к допустимому диапазону и шагу инструмента. |
| **Slippage** | Наследованный параметр скольжения. В StockSharp для рыночных ордеров не используется, оставлен для совместимости. |
| **Wait Time (ms)** | Задержка между демонстрационными ордерами в миллисекундах. Значение 0 отправит все ордера подряд. |

## Детали реализации
- Класс находится в пространстве имён `StockSharp.Samples.Strategies`; отступы выполнены табуляцией, как требует инструкция.
- Метод `StartProtection()` вызывается при запуске, чтобы `SetStopLoss` и `SetTakeProfit` могли управлять защитными уровнями
  результирующей позиции.
- Асинхронная последовательность создана через `Task.Run` и управляется `CancellationTokenSource`, который сбрасывается в
  `OnStopped`, поэтому незавершённые задержки отменяются мгновенно.
- Для подсчёта активных ордеров используются два набора `HashSet<Order>`: один для покупок, второй для продаж. В них попадают
  только ордера в состояниях `None`, `Pending` или `Active`.
- Цена для защитных ордеров берётся из лучшей котировки (ask/bid) с запасным вариантом в виде последней сделки. Если подходящей
  цены нет, стратегия выводит предупреждение и не создаёт уровни.

## Практические рекомендации
- Стратегия не подписывается на свечи и может работать на любом инструменте. После присвоения инструмента и запуска вы сразу
  увидите три демонстрационные сделки и сообщения со статистикой.
- Чтобы использовать только подсчёт ордеров без сделок, задайте **Trade Volume** равным нулю или остановите стратегию сразу после
  запуска.
- На инструментах с низкой ликвидностью первое время могут появляться предупреждения об отсутствии цены для выставления стопов.
  Это штатное поведение — уровни будут добавлены, как только появятся котировки.

## Особенности переноса
- Функция `OrdersCount()` заменена реакцией на события `OnOrderChanged`, что лучше вписывается в архитектуру StockSharp.
- Сообщения `Comment()` преобразованы в `AddInfoLog`, поэтому их легко найти в стандартном журнале стратегии или выгрузить в файл.
- Вызовы `Sleep()` заменены на `Task.Delay`, чтобы не блокировать поток исполнения и сохранить отзывчивость приложения.
