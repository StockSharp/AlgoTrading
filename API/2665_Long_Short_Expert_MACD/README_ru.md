# Стратегия Long/Short Expert MACD

## Обзор
**Long/Short Expert MACD** — это конвертация экспертной системы MetaTrader «LongShortExpertMACD» на StockSharp. Логика базируется на пересечениях MACD и его сигнальной линии, дополненных фиксированными стоп-лоссами и тейк-профитами. Стратегия может работать только в лонг, только в шорт или в обе стороны и автоматически рассчитывает защитные уровни в ценовых пунктах.

Реализация использует высокоуровневый API StockSharp: подписку на свечи и привязку индикаторов. Заявки регистрируются как рыночные, поэтому стратегию можно одинаково применять как на реальном потоке, так и в историческом тесте.

## Индикаторы и данные
- **Свечи** — один таймфрейм, задаётся параметром `CandleType` (по умолчанию минутные свечи). Подписка выполняется через `SubscribeCandles`.
- **MovingAverageConvergenceDivergenceSignal** — встроенный MACD с настраиваемыми периодами быстрого, медленного и сигнального EMA. Гистограмма implicitly получается как разница между линией MACD и сигналом.

## Торговая логика
1. **Подготовка сигнала**
   - На каждой завершённой свече стратегия получает значения MACD и сигнальной линии из привязанного индикатора.
   - Переменная `_prevIsMacdAboveSignal` запоминает положение MACD относительно сигнальной линии на предыдущей свече.

2. **Условия входа**
   - **Бычье пересечение**: MACD переходит выше сигнальной линии — открываем лонг, если выбранный режим допускает длинные позиции.
     - При активном шорте и разрешённых реверсах (`AllowedPosition = Both`) объём рыночной заявки включает величину текущего шорта, что обеспечивает закрытие и переворот в одном ордере.
     - В режиме «только лонг» активный шорт закрывается, но новый вход произойдёт только после следующего согласованного сигнала.
   - **Медвежье пересечение**: зеркальные правила для входа в короткую позицию.

3. **Условия выхода**
   - **Управление рисками**: стоп-лосс и тейк-профит пересчитываются от средней цены входа при каждой фиксации позиции. Расстояния выражаются в ценовых пунктах (`PriceStep * параметр`), поэтому логика корректно переносится на разные инструменты.
     - Лонги закрываются, если минимум свечи достигает стоп-лосса или максимум — тейк-профита.
     - Шорты закрываются, если максимум свечи пробивает стоп-лосс или минимум — тейк-профит.
   - **Обратное пересечение**: при разрешённой торговле в противоположную сторону позиция закрывается (и при необходимости разворачивается) сразу после смены соотношения линий MACD/сигнала.

4. **Дополнительные ограничения**
   - Логика выполняется только в состоянии `IsFormedAndOnlineAndAllowTrading`.
   - Защитные уровни обнуляются при отсутствии позиции, чтобы исключить использование устаревших значений.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `AllowedPosition` | `Both` | Разрешённые направления торговли: только лонг, только шорт или оба варианта. |
| `FastLength` | `12` | Период быстрого EMA внутри MACD. |
| `SlowLength` | `24` | Период медленного EMA внутри MACD. |
| `SignalLength` | `9` | Период сигнального EMA, определяющего пересечения. |
| `TakeProfitPoints` | `50` | Дистанция до тейк-профита в ценовых пунктах (`PriceStep * значение`). `0` отключает уровень. |
| `StopLossPoints` | `20` | Дистанция до стоп-лосса в ценовых пунктах. `0` отключает уровень. |
| `CandleType` | `TimeFrame(1 minute)` | Тип свечей, используемых для расчётов. |
| `Volume` | `1` | Объём каждой рыночной заявки. |

Все числовые параметры имеют заранее заданные диапазоны оптимизации, что упрощает перебор в Designer или Runner.

## Управление позицией
- **Реверс позиций**: при `AllowedPosition = Both` стратегия отправляет комбинированный объём, закрывая текущую позицию и открывая противоположную одним ордером — аналогично оригинальному эксперту MetaTrader.
- **Режимы long-only / short-only**: позиции, не соответствующие выбранному направлению, закрываются сразу, но новое открытие будет только при сигнале в допустимую сторону.
- **Актуализация стопов**: уровни стоп-лосса и тейк-профита пересчитываются каждый раз на основе `PositionAvgPrice`, что корректно отражает среднюю цену после частичных закрытий или доливок.

## Рекомендации по применению
- Убедитесь, что инструмент имеет корректный `PriceStep`. При его отсутствии стратегия использует значение `1.0`, что подходит для акций, но может потребовать корректировок на валютном рынке.
- Стратегия работает только по завершённым свечам. Для минимизации задержек выберите подходящий таймфрейм.
- Рыночные заявки не учитывают проскальзывание, поэтому на малоликвидных инструментах целесообразно закладывать дополнительный запас риска.
- При наличии графиков стратегия автоматически выводит свечи, индикатор MACD и собственные сделки.

## Замечания по конвертации
- В StockSharp сохранены все настраиваемые параметры MACD, стоп-лосс/тейк-профит и переключатель разрешённых позиций из MQL5.
- Модули трейлинг-стопа и управления капиталом исключены, так как в исходном эксперте использовались заглушки "None".
