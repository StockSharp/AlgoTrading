# Long/Short Expert MACD 策略

## 概述
**Long/Short Expert MACD** 策略是 MetaTrader 专家顾问「LongShortExpertMACD」的 StockSharp 版本。策略使用 MACD 与其信号线的交叉来产生买卖信号，同时在开仓后立即应用固定距离的止损和止盈。交易者可以选择仅做多、仅做空或允许双向交易，所有保护距离均以价格点数表示。

实现基于 StockSharp 的高级 API：策略订阅单一时间框架的蜡烛数据，并把 `MovingAverageConvergenceDivergenceSignal` 指标绑定到订阅上。所有订单均以市价提交，因此能够方便地用于实时运行或历史回测。

## 指标与行情
- **蜡烛数据**：由参数 `CandleType` 指定的时间框架（默认 1 分钟）。策略通过 `SubscribeCandles` 订阅该序列。
- **MovingAverageConvergenceDivergenceSignal**：StockSharp 内置的 MACD 指标，可分别设置快 EMA、慢 EMA 和信号 EMA 的周期。MACD 与信号线的差值隐含形成直方图。

## 交易逻辑
1. **信号准备**
   - 每根完成的蜡烛都会触发计算，指标绑定返回当前的 MACD 值与信号值。
   - 状态变量 `_prevIsMacdAboveSignal` 记录上一根蜡烛时 MACD 是否位于信号线上方，用于检测交叉。

2. **入场规则**
   - **向上交叉**：当 MACD 从下方穿越信号线时，若允许多头交易则开多。
     - 如果当前持有空头且允许反手 (`AllowedPosition = Both`)，下单数量会包含现有空头的绝对值，从而一次市价单即可完成平仓并开多。
     - 在多头专用模式中，若仍有空头仓位则立即平仓，但不会立即建立新的多头仓位，需等待下一次信号。
   - **向下交叉**：规则与多头对称，用于开空。

3. **出场规则**
   - **风险控制**：只要持有仓位，策略都会依据 `PositionAvgPrice` 重新计算止损与止盈水平。距离等于 `Security.PriceStep * 参数`，从而在不同合约之间保持一致。
     - 多头仓位在蜡烛最低价触及止损或最高价触及止盈时平仓。
     - 空头仓位在蜡烛最高价达到止损或最低价达到止盈时平仓。
   - **反向交叉**：如果允许反向交易，则一旦 MACD 与信号线关系发生反转，仓位会被平掉，并根据模式决定是否立即翻转。

4. **运行约束**
   - 只有当策略满足 `IsFormedAndOnlineAndAllowTrading` 时才会执行交易逻辑。
   - 当仓位归零时会重置所有保护价格，防止使用过期的水平。

## 参数
| 名称 | 默认值 | 描述 |
| --- | --- | --- |
| `AllowedPosition` | `Both` | 交易方向限制：仅多、仅空或双向。 |
| `FastLength` | `12` | MACD 快速 EMA 的周期。 |
| `SlowLength` | `24` | MACD 慢速 EMA 的周期。 |
| `SignalLength` | `9` | 信号 EMA 的周期，用于交叉判断。 |
| `TakeProfitPoints` | `50` | 止盈距离（价格点数，等于 `PriceStep * 值`）。设为 `0` 可关闭止盈。 |
| `StopLossPoints` | `20` | 止损距离（价格点数）。设为 `0` 可关闭止损。 |
| `CandleType` | `TimeFrame(1 minute)` | 计算所使用的蜡烛类型。 |
| `Volume` | `1` | 每笔市价单的下单数量。 |

所有数值型参数都配置了优化区间，可直接在 Designer 或 Runner 中进行批量测试。

## 仓位管理
- **翻转逻辑**：当允许双向交易时，策略通过单笔市价单完成平仓与反手，完全复刻原始 MQL 专家顾问的行为。
- **单向模式**：对于被禁止的方向，策略会立即平掉已有仓位，但不会反向开仓，直到出现符合方向的下一次信号。
- **保护水平更新**：每根蜡烛都会根据最新的 `PositionAvgPrice` 重新计算止损/止盈，适用于部分成交或分批加仓的情况。

## 使用建议
- 请确认交易标的提供了有效的 `PriceStep`。若缺失，该策略会退回到 1.0 的价格单位，这对股票合约通常适用，但在外汇品种上可能需要调整。
- 策略仅对完成的蜡烛做出反应，若希望减少滞后，可选用更低的时间框架。
- 市价单未考虑滑点，在流动性较差的市场上应额外评估执行风险。
- 在支持图表的终端中会自动绘制蜡烛、MACD 曲线以及自身成交，方便监控。

## 转换说明
- 保留了原 MQL 专家中的所有关键设置：MACD 周期、止损止盈点数以及可交易方向开关。
- 原策略使用的 `TrailingNone` 和 `MoneyNone` 模块本身不包含逻辑，因此在 StockSharp 版本中无需额外实现。
