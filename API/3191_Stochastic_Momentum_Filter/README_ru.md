# Стратегия Stochastic Momentum Filter

## Обзор
**Stochastic Momentum Filter Strategy** — порт на StockSharp эксперта `Stochastic.mq4` из папки `MQL/23473`. Оригинальный робот сочетает два стохастика, линейные взвешенные средние (LWMA), фильтр отклонения Momentum и MACD старшего таймфрейма. Версия на C# воспроизводит те же блоки на высокоуровневом API StockSharp и сохраняет многоступенчатую схему подтверждений:

1. **Фильтр тренда** — быстрая LWMA должна находиться выше (или ниже) медленной LWMA перед открытием лонга (или шорта).
2. **Подтверждение осцилляторами** — быстрый стохастик (5/2/2) и медленный стохастик (21/4/10) одновременно сигнализируют о перепроданности/перекупленности.
3. **Отклонение Momentum** — хотя бы одно из трёх последних значений Momentum должно отличаться от базового уровня 100 больше порога, как и в MQL-версии на базе `iMomentum`.
4. **MACD старшего таймфрейма** — на настраиваемом таймфрейме линия MACD должна быть выше сигнальной для лонгов (и ниже для шортов). Значение по умолчанию — 30-дневные свечи, что приближает фильтр к исходному месячному анализу.
5. **Защита позиции** — стоп-лосс, тейк-профит и трейлинг подключаются через `StartProtection`, повторяя защитные настройки эксперта. При развороте позиция автоматически закрывает противоположный объём.

Стратегия подписывается на два потока свечей: торговый таймфрейм и старший таймфрейм для MACD. Все расчёты выполняются штатными индикаторами StockSharp и обрабатываются через `Bind`.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `StochasticBuyLevel` | `30` | Уровень перепроданности, который должны пробить оба стохастика для покупок. |
| `StochasticSellLevel` | `80` | Уровень перекупленности для входа в продажи. |
| `FastMaPeriod` | `6` | Период быстрой LWMA. |
| `SlowMaPeriod` | `85` | Период медленной LWMA. |
| `FastStochasticPeriod` | `5` | Период `%K` быстрого стохастика. |
| `FastStochasticSignal` | `2` | Период сглаживания `%D` быстрого стохастика. |
| `FastStochasticSmoothing` | `2` | Дополнительное сглаживание (аналог параметра Slowing в MT4). |
| `SlowStochasticPeriod` | `21` | Период `%K` медленного стохастика. |
| `SlowStochasticSignal` | `4` | Период `%D` медленного стохастика. |
| `SlowStochasticSmoothing` | `10` | Дополнительное сглаживание медленного стохастика. |
| `MomentumPeriod` | `14` | Длина окна индикатора Momentum (как в `iMomentum`). |
| `MomentumThreshold` | `0.3` | Минимальное абсолютное отклонение от уровня 100 среди трёх последних значений. |
| `MacdFastPeriod` | `12` | Быстрая EMA для MACD старшего таймфрейма. |
| `MacdSlowPeriod` | `26` | Медленная EMA для MACD. |
| `MacdSignalPeriod` | `9` | Период сигнальной EMA MACD. |
| `TakeProfitPoints` | `50` | Размер тейк-профита в пунктах (0 — выключено). |
| `StopLossPoints` | `20` | Размер стоп-лосса в пунктах (0 — выключено). |
| `EnableTrailing` | `true` | Включает трейлинг стопа StockSharp. |
| `TradeVolume` | `1` | Целевой нетто-объём позиции при сигнале. |
| `MaxNetPositions` | `1` | Максимальное количество нетто-объёмов (множитель `TradeVolume`). |
| `CandleType` | `15m` | Рабочий таймфрейм. |
| `HigherTimeframe` | `30d` | Таймфрейм для MACD-фильтра. |

## Торговая логика
1. **Подготовка индикаторов** — стратегия привязывает две LWMA, два стохастика, Momentum и MACD к соответствующим подпискам на свечи.
2. **Память Momentum** — абсолютное отклонение Momentum от 100 сохраняется для трёх последних закрытых баров (аналог `MomLevelB/MomLevelS`).
3. **Правила входа**
   - **Лонг**: быстрая LWMA выше медленной, значения `%K`/`%D` обоих стохастиков ниже `StochasticBuyLevel`, Momentum превышает `MomentumThreshold`, а MACD выше сигнальной линии.
   - **Шорт**: быстрая LWMA ниже медленной, оба стохастика находятся выше `StochasticSellLevel`, Momentum превышает порог, а MACD ниже сигнальной линии.
4. **Управление позицией** — заявки отправляются методами `BuyMarket`/`SellMarket`. При смене направления стратегия закрывает обратный объём и открывает позицию в новую сторону.
5. **Защита** — `StartProtection` выставляет тейк/стоп (в пунктах). При `EnableTrailing = true` StockSharp сопровождает стоп, что сопоставимо с трейлингом из MQL.

## Отличия от MQL-версии
- **Масштабирование объёма**: в эксперте объём наращивается через `LotExponent` и несколько ордеров. Здесь используется управление нетто-позицией с целевым `TradeVolume` и ограничением `MaxNetPositions`.
- **Маржинальные проверки**: останов по эквити, рассылки и другие сервисные функции MT4 не реализованы, так как зависят от специфики терминала.
- **Freeze-level**: проверка биржевых ограничений перенесена на уровень шлюза StockSharp.
- **Безубыточность**: перенос стопа в безубыток заменён встроенным трейлингом `StartProtection`.

## Рекомендации по использованию
1. Назначьте инструмент и коннектор, затем запустите стратегию — подписки на оба таймфрейма создаются автоматически.
2. Если поставщик данных не поддерживает 30-дневные свечи, подберите альтернативный таймфрейм (дневной, недельный и т.д.) для параметра `HigherTimeframe`.
3. Настройте `TradeVolume` под размер депозита. Значение присваивается полю `Volume` в `OnStarted`, поэтому Designer/Runner используют его при отправке заявок.
4. Установите `TakeProfitPoints` или `StopLossPoints` в `0`, чтобы отключить соответствующие защитные уровни.
5. В исходнике все комментарии написаны на английском языке, отступы выполняются табуляцией в соответствии с требованиями репозитория.

## Состав папки
- `CS/StochasticMomentumFilterStrategy.cs` — реализация стратегии.
- `README.md` — описание на английском языке.
- `README_ru.md` — описание на русском (этот файл).
- `README_cn.md` — описание на китайском языке.
