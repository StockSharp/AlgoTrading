# Стратегия Terminator

## Описание

Стратегия Terminator переносит логику советника MetaTrader 4 "Terminator v2.0" на платформу StockSharp с использованием высокоуровневого API. Алгоритм отслеживает наклон MACD, открывает стартовую позицию по направлению сигнала и строит сетку усредняющих ордеров при движении цены против позиции на заданное количество пунктов. Управление корзиной включает произвольный стоп-лосс, тейк-профит, трейлинг и модуль защиты прибыли, закрывающий последний ордер при достижении целевого плавающего дохода.

## Логика торговли

1. **Формирование сигнала.** После закрытия каждой свечи рассчитывается значение MACD. Рост значения относительно предыдущего столбика трактуется как бычий импульс, снижение — как медвежий. Флаг `ReverseSignals` инвертирует интерпретацию.
2. **Первичный вход.** При отсутствии открытых сделок и выполнении временного фильтра (`StartYear`, `StartMonth`, `EndYear`, `EndMonth`) стратегия отправляет рыночный ордер, если не активирован режим `ManualTrading`.
3. **Мартигейл.** При наличии позиции стратегия дожидается неблагоприятного движения на `EntryDistancePips` пунктов и добавляет очередной ордер. Объём каждой новой сделки удваивается (или умножается на 1.5, если `MaxTrades` больше 12) до достижения лимита `MaxTrades`. При включении `UseMoneyManagement` стартовый лот рассчитывается от баланса и параметра `RiskPercent`.
4. **Защита.**
   - **Тейк-профит:** уровень рассчитывается из `TakeProfitPips` и распространяется на всю корзину.
   - **Стоп-лосс:** начальный стоп определяется `InitialStopPips`; нулевое значение отключает стоп.
   - **Трейлинг:** параметр `TrailingStopPips` запускает перенос стопа после достижения прибыли не менее суммы трейлинга и одного шага сетки.
   - **Защита счёта:** при включении `UseAccountProtection` и достижении `MaxTrades - OrdersToProtect` сделок плавающая прибыль сравнивается с `SecureProfit` (или с текущей стоимостью портфеля при `ProtectUsingBalance = true`). При превышении порога последний ордер закрывается, а новые входы запрещаются до полного закрытия корзины.
5. **Сброс состояния.** После выхода из позиции внутренние счётчики обнуляются, что позволяет начать новый цикл торговли.

## Параметры

- `TakeProfitPips` — расстояние до общего тейк-профита (в пунктах).
- `InitialStopPips` — стартовый стоп (в пунктах, 0 — отключено).
- `TrailingStopPips` — трейлинг-стоп (в пунктах, 0 — отключено).
- `MaxTrades` — максимальное число одновременных усредняющих сделок.
- `EntryDistancePips` — шаг сетки в пунктах.
- `SecureProfit` — минимальный плавающий доход для активации защиты.
- `UseAccountProtection` — включение модуля защиты счёта.
- `ProtectUsingBalance` — использовать текущую стоимость портфеля вместо `SecureProfit`.
- `OrdersToProtect` — число последних сделок, контролируемых защитой.
- `ReverseSignals` — инвертировать направление сигналов MACD.
- `ManualTrading` — запрет автоматического входа при сохранении управления корзиной.
- `LotSize` — базовый объём при отключённом мани-менеджменте.
- `UseMoneyManagement` — расчёт объёма от баланса по параметру `RiskPercent`.
- `RiskPercent` — процент риска (в долях от 100%).
- `IsStandardAccount` — режим расчёта для стандартного/мини счёта.
- `EurUsdPipValue`, `GbpUsdPipValue`, `UsdChfPipValue`, `UsdJpyPipValue`, `DefaultPipValue` — денежная ценность пункта для расчёта плавающей прибыли.
- `StartYear`, `StartMonth`, `EndYear`, `EndMonth` — календарные ограничения на новые корзины.
- `CandleType` — тип свечей для сигналов.
- `MacdFastLength`, `MacdSlowLength`, `MacdSignalLength` — параметры MACD.

## Особенности реализации

- Вся логика расчёта объёмов, шагов сетки и защиты прибыли основана на исходном MQ4-коде.
- Опции `AccountProtection` и `AllSymbolsProtect` объединены в `UseAccountProtection` и `ProtectUsingBalance`.
- Флаги `ReverseCondition` и `Manual` преобразованы в `ReverseSignals` и `ManualTrading`.
- Стопы и трейлинг применяются к совокупной позиции, аналогично поведению исходного советника.
- Другие режимы входа из MQ4 требуют кастомных индикаторов и поэтому не реализованы.

## Как запустить

1. Откройте решение в Visual Studio.
2. Добавьте стратегию в `StrategyRunner` или `StrategyConnector`.
3. Настройте параметры через интерфейс или код.
4. Запустите стратегию: она автоматически подпишется на нужные свечи и начнёт обработку сигналов.
