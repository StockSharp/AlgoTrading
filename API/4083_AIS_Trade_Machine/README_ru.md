# Стратегия AIS4 Trade Machine

## Общее описание
**AIS4 Trade Machine Strategy** — это порт ручного советника «AIS4 Trade Machine» из MetaTrader в StockSharp. Стратегия сохраняет концепцию «одна позиция за раз»: трейдер задаёт абсолютные уровни Stop Loss и Take Profit, выбирает команду, а стратегия рассчитывает рабочий объём с учётом текущей стоимости портфеля и параметров инструмента. После исполнения рыночной заявки автоматически выставляется пара защитных ордеров (стоп + лимит), чтобы зафиксировать заданные уровни риска и цели прямо на бирже.

Стратегия не генерирует собственных сигналов — она служит помощником для дискреционной торговли.

## Пошаговая работа
1. Убедитесь, что у выбранного инструмента заданы `PriceStep`, `StepPrice`, `VolumeStep`, `MinVolume` и `MaxVolume`. Эти значения необходимы для перевода ценового риска в количество контрактов и для корректной привязки объёма к биржевым ограничениям.
2. Перед отправкой команды задайте уровни `StopPrice` и `TakePrice` в абсолютных ценах.
3. Установите `Command` в значение `Buy` или `Sell`. Стратегия:
   - Проверяет, что нет другой открытой позиции.
   - Контролирует, чтобы указанные уровни соблюдали минимальную ценовую дистанцию.
   - Вычисляет риск на сделку как `OrderReserve` × текущая стоимость портфеля и сверяет его с резервом капитала (`AccountReserve`).
   - Оценивает объём сделки через расстояние до стопа и стоимость тика инструмента.
   - Отправляет рыночный ордер и сразу регистрирует защитные заявки (`SellStop` + `SellLimit` для лонга, `BuyStop` + `BuyLimit` для шорта).
4. После обработки команда автоматически возвращается в состояние `Wait`, что предотвращает повторный запуск.

### Управление активной позицией
- Измените уровни (можно оставить `0`, чтобы сохранить текущие значения) и установите `Command = Modify`. Стратегия отменит предыдущие защитные ордера и создаст новые по обновлённым ценам.
- Установите `Command = Close`, чтобы немедленно закрыть позицию по рынку и отменить все защитные заявки.

## Логика управления рисками
- **AccountReserve** — доля капитала, которая всегда остаётся в резерве. Пока доступная часть (`equity - peak_equity × (1 - AccountReserve)`) меньше требуемого риска на сделку, торговля блокируется.
- **OrderReserve** — доля текущей стоимости портфеля, выделяемая на следующую сделку. Этот бюджет переводится в объём через расстояние до стопа и стоимость шага цены (`PriceStep` × `StepPrice`).
- Если рассчитанный объём меньше `MinVolume` или нарушает шаг объёма `VolumeStep`, команда отклоняется с предупреждением в логе.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Command` | `Wait` | Ручная команда (`Buy`, `Sell`, `Modify`, `Close`). После обработки возвращается в `Wait`. |
| `StopPrice` | `0` | Абсолютный уровень Stop Loss. Для лонга должен быть ниже цены входа, для шорта — выше. |
| `TakePrice` | `0` | Абсолютный уровень Take Profit. Для лонга — выше цены входа, для шорта — ниже. |
| `AccountReserve` | `0.20` | Доля капитала, резервируемая «всегда». Чем выше значение, тем больше подушка безопасности нужна для новых сделок. |
| `OrderReserve` | `0.04` | Доля капитала, выделяемая под риск одной сделки. Используется при расчёте объёма через дистанцию до стопа. |
| `CandleType` | Таймфрейм 1 минута | Свечной поток, по которому считываются цены для валидации и журналирования. |

## Замечания и ограничения
- Одновременно поддерживается только одна позиция — так же, как в оригинальном советнике.
- Команды, нарушающие минимальные дистанции, резерв капитала или ограничения по объёму, игнорируются; соответствующее предупреждение записывается в лог.
- Защитные заявки переотправляются при каждом изменении или новом исполнении, чтобы объём совпадал с фактической позицией.
- Для корректной работы необходимы точные значения `PriceStep` и `StepPrice`. Без них стратегия не сможет безопасно рассчитать объём сделки.
