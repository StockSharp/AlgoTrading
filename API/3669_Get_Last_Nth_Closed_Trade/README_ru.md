# Стратегия Get Last Nth Closed Trade

## Обзор
Стратегия **Get Last Nth Closed Trade** повторяет советник MetaTrader, который просматривает историю и выводит _n_-ю по счёту закрытую сделку начиная с последней. Реализация на StockSharp не регистрирует новые заявки: она непрерывно слушает собственные исполнения стратегии, поддерживает скользящий список закрытых сделок и после каждого закрытия публикует подробный отчёт для выбранного индекса.

## Как это работает
1. Каждый приходящий `MyTrade` проверяется на соответствие опциональным фильтрам по инструменту и идентификатору стратегии.
2. Виртуальный учёт позиций накапливает входящие сделки, пересчитывает среднюю цену входа при наращивании позиции и уменьшает оставшийся объём при частичных выходах.
3. При уменьшении позиции формируется объект `ClosedTradeInfo` с направлением, ценами, временем, идентификаторами, объёмом и простой оценкой прибыли, основанной на средней цене входа.
4. В коллекции хранится до 100 последних закрытых сделок. После каждого закрытия стратегия выводит в журнал снимок в формате, близком к выводу MetaTrader.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `EnableStrategyIdFilter` | При `true` учитываются только сделки, у которых `StrategyId` совпадает со значением `StrategyIdFilter`. Если строка пустая, используется текущий идентификатор стратегии. | `false` |
| `StrategyIdFilter` | Идентификатор стратегии для фильтрации сделок. | `""` |
| `EnableSecurityFilter` | При включении обрабатываются только сделки по инструменту `Strategy.Security`. | `false` |
| `TradeIndex` | Номер закрытой сделки (от нуля), данные которой нужно выводить. | `0` |

## Примечания и ограничения
- StockSharp не предоставляет данные по стоп-лоссу и тейк-профиту в исполнениях, поэтому эти поля отсутствуют в отчёте.
- Прибыль вычисляется как разница цен умноженная на закрытый объём. Комиссии и проскальзывание необходимо учитывать отдельно при необходимости.
- Учёт позиций поддерживает дозагрузку и частичные выходы за счёт усреднения цены входа. При резкой смене направления сперва закрывается старая позиция, затем открывается новая на оставшийся объём.
- Формат логирования повторяет многострочный вывод MetaTrader, что облегчает копирование данных во внешние инструменты.
