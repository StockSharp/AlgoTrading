# Стратегия Order Execution

## Общее описание

`OrderExecutionStrategy` — порт эксперта MetaTrader 5 **OrderExecution.mq5** на платформу StockSharp. Исходный советник выполняет
роль исполняющего контура: он считывает ордера из CSV-файлов, синхронизируется с внешней аналитической системой и выставляет
рыночные заявки в заранее определённые часы. Перенос сохраняет файловый обмен и использует высокоуровневый API StockSharp для
реализации массового ввода ордеров, когда сигналы поступают извне.

## Архитектура на базе файлов

Стратегия использует три CSV-файла, полностью повторяя оригинальную схему:

| Файл | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `SymbolsFile` | Соответствие инструментов и часов исполнения (`SYMBOL,HOUR`). | `OrdersExecution/Symbols.csv` |
| `AccountFile` | Выгрузка `Balance`, `Equity` и `Positions` в момент съёма среза. | `OrdersExecution/Account.csv` |
| `OrdersFile` | Список ордеров, сформированных внешним процессом. | `OrdersExecution/Orders.csv` |

При наступлении часа съёма данных формируется заглушка экспорта в каталоге `DownloadDirectory`. В MetaTrader на этом шаге
сохранялись исторические бары; StockSharp-версия генерирует структурированный файл-заглушку, чтобы при необходимости легко
расширить метод `TryExportData`.

## Формат файла ордеров

Каждая строка файла должна содержать шесть полей через запятую:

```
SYMBOL,YYYY-MM-DD HH:MM,AMOUNT,STOPLOSS,TAKEPROFIT,IDENTIFIER
```

* `SYMBOL` — код инструмента. Если не совпадает с `Strategy.Security.Id`, запись игнорируется.
* `YYYY-MM-DD HH:MM` — локальное время исполнения. Заявка активируется на свече с совпадающей торговой датой.
* `AMOUNT` — объём сделки со знаком. Положительные значения открывают лонг, отрицательные — шорт, ноль закрывает позицию.
* `STOPLOSS` / `TAKEPROFIT` — зарезервированные числовые поля. Автоматическая отправка стопов в этой версии не реализована и может
  быть добавлена при необходимости.
* `IDENTIFIER` — произвольный идентификатор для стыковки ордеров на открытие и закрытие. Параметр `IgnoreTradeId` управляет тем,
  требуется ли совпадение идентификатора при закрытии.

Файл читается при старте и перед обработкой каждой завершённой свечи. Новые записи объединяются с текущим списком по ключу
`SYMBOL + TIME + IDENTIFIER`. При активной опции `RemoveOrdersFile` после чтения файл удаляется — так же, как в MetaTrader.

## Параметры

Главные настройки вынесены в `StrategyParam` и снабжены подсказками для интерфейса StockSharp:

| Параметр | Описание | Значение |
| --- | --- | --- |
| `SymbolsFile` | Путь к CSV с расписанием по инструментам. | `OrdersExecution/Symbols.csv` |
| `AccountFile` | Путь к файлу со снимком баланса и эквити. | `OrdersExecution/Account.csv` |
| `OrdersFile` | Путь к файлу с ордерами. | `OrdersExecution/Orders.csv` |
| `DownloadDirectory` | Каталог для экспортируемых данных. | `OrdersExecution/Data` |
| `LookBack` | Количество баров для потенциального экспорта. | `252` |
| `DownloadingHour` | Час съёма среза; `-1` отключает действие. | `21` |
| `TradingHour` | Общий час исполнения, перекрывающий расписание. | `23` |
| `IgnoreTradingHour` | Игнорировать фильтр по времени, ориентироваться только на дату. | `false` |
| `IgnoreTradeId` | Закрывать позицию вне зависимости от идентификатора. | `true` |
| `MaxPositions` | Максимально допустимый абсолютный размер позиции. | `1` |
| `RemoveOrdersFile` | Удалять файл ордеров после чтения. | `true` |
| `UseMultiplier` | Масштабировать объём через отношение текущей и начальной эквити. | `false` |
| `EnableDebug` | Вести лог `debug_file.txt` с динамикой эквити. | `false` |
| `CandleType` | Тип свечей для подписки и планирования. | `TimeFrameCandle(1h)` |

## Последовательность работы

1. **Старт** — загрузка расписания, первичное чтение ордеров, открытие опционального лог-файла.
2. **Обработка свечей** — каждое завершённое значение `SubscribeCandles(CandleType)` инициирует цикл. Файл ордеров перечитывается,
   чтобы подхватить новые инструкции без перезапуска стратегии.
3. **Снимок счёта** — когда час совпадает с `DownloadingHour`, переписывается `AccountFile`, а также создаётся файл-заглушка в
   `DownloadDirectory`.
4. **Исполнение** — выбираются записи с подходящей датой (и часом, если фильтр включён).
   * `AMOUNT = 0` — вызывается `ClosePosition()`. При отключённом `IgnoreTradeId` проверяется наличие идентификатора среди
     открытых сделок.
   * `AMOUNT ≠ 0` — отправляется рыночный ордер в указанном направлении; при активной опции `UseMultiplier` объём масштабируется
     по отношению эквити.
5. **Маркировка** — обработанные инструкции помечаются, что предотвращает повторное исполнение на следующей свече.

## Отличия от MetaTrader-версии

* Параметры стоп-лосса и тейк-профита сохранены как резерв, но ордера не выставляются автоматически (в оригинале передавались
  булевы значения вместо цены).
* Экспорт исторических данных представлен заглушкой; при необходимости добавьте реальную выгрузку из хранилища данных.
* Ограничение `MaxPositions` опирается на агрегированную позицию StockSharp. Если требуется подсчёт отдельных сделок, адаптируйте
  условие самостоятельно.

## Рекомендации по использованию

1. Подготовьте три CSV-файла или скорректируйте пути через параметры стратегии.
2. Выкладывайте новые инструкции во входной файл. При активном `RemoveOrdersFile` он будет удалён сразу после чтения.
3. Убедитесь, что коды инструментов в `SymbolsFile` совпадают с `Security.Id` и указаны корректные часы исполнения. Чтобы
   использовать только индивидуальное расписание, установите `TradingHour = -1`.
4. Запускайте стратегию в Designer, Shell или Runner. Как только нужная свеча закроется, ордера из файла будут обработаны.

При необходимости добавьте автоматическую установку стопов, лимитные заявки или расширенную отчётность, не меняя основную
структуру стратегии.
