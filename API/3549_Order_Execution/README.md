# Order Execution Strategy

## Overview

`OrderExecutionStrategy` is a StockSharp port of the MetaTrader 5 expert advisor **OrderExecution.mq5**. The original robot acts as
an execution layer that reads pending orders from CSV files, synchronises with an external research pipeline, and fires market
orders at pre-scheduled hours. This port keeps the file-driven workflow while adapting it to the StockSharp high level strategy
API. The strategy is intended for batch order entry scenarios where trade direction, size, and identifiers are distributed by an
external process.

## File-driven workflow

The strategy consumes three CSV files that mirror the MetaTrader setup:

| File | Purpose | Default path |
| --- | --- | --- |
| `SymbolsFile` | Maps symbols to execution hours (`SYMBOL,HOUR`). | `OrdersExecution/Symbols.csv` |
| `AccountFile` | Output file that stores `Balance`, `Equity`, and `Positions` when the snapshot hour is reached. | `OrdersExecution/Account.csv` |
| `OrdersFile` | List of trade instructions generated by the external process. | `OrdersExecution/Orders.csv` |

The strategy can also create a placeholder export in `DownloadDirectory` when the snapshot runs. In MetaTrader this step writes
historical bars; in the StockSharp version a stub CSV is produced to preserve compatibility with downstream tooling. Extend
`TryExportData` if full data exports are required.

## Orders file format

Each non-empty line of the orders file must contain six comma separated fields:

```
SYMBOL,YYYY-MM-DD HH:MM,AMOUNT,STOPLOSS,TAKEPROFIT,IDENTIFIER
```

* `SYMBOL` – instrument identifier. If it does not match `Strategy.Security.Id`, the entry is ignored.
* `YYYY-MM-DD HH:MM` – local execution time. Orders fire on the candle whose trading date matches this value.
* `AMOUNT` – signed trade volume. Positive values open long trades, negative values open shorts, zero closes positions.
* `STOPLOSS` / `TAKEPROFIT` – optional decimal placeholders retained for compatibility. This port does not submit stop or
  target orders automatically; extend the strategy if price-based exits are needed.
* `IDENTIFIER` – arbitrary string that links paired open/close requests. The flag `IgnoreTradeId` controls whether identifiers are
  enforced when closing positions.

The strategy reads the file on start and before every finished candle. New lines are merged into the in-memory list by the tuple
`SYMBOL + TIME + IDENTIFIER`. When `RemoveOrdersFile` is enabled the file is deleted after processing, matching the behaviour of
the original expert advisor.

## Parameters

The constructor exposes the most relevant configuration knobs through `StrategyParam` instances:

| Parameter | Description | Default |
| --- | --- | --- |
| `SymbolsFile` | Location of the symbol/hour mapping CSV. | `OrdersExecution/Symbols.csv` |
| `AccountFile` | Output CSV path for balance and equity snapshots. | `OrdersExecution/Account.csv` |
| `OrdersFile` | Input CSV path with trade instructions. | `OrdersExecution/Orders.csv` |
| `DownloadDirectory` | Folder where candle exports are written during the snapshot hour. | `OrdersExecution/Data` |
| `LookBack` | Number of candles to export when extending `TryExportData`. | `252` |
| `DownloadingHour` | Hour when the balance snapshot and data export occur. Set to `-1` to disable. | `21` |
| `TradingHour` | Global fallback trading hour. Values `>= 0` override per-symbol entries. | `23` |
| `IgnoreTradingHour` | Execute orders even when the configured hour does not match the current candle. | `false` |
| `IgnoreTradeId` | Close positions regardless of the identifier in the orders file. | `true` |
| `MaxPositions` | Maximum absolute strategy position allowed. | `1` |
| `RemoveOrdersFile` | Delete the orders file after it is parsed. | `true` |
| `UseMultiplier` | Scale volumes by the ratio `current equity / initial equity`. | `false` |
| `EnableDebug` | Write equity snapshots to `debug_file.txt` located next to the orders file. | `false` |
| `CandleType` | Candle subscription used to detect new bars and evaluate the schedule. | `TimeFrameCandle(1h)` |

All parameters are exposed as properties and support optimisation metadata via `SetDisplay`, matching the conventions used
throughout the repository.

## Execution flow

1. **Initialisation** – when the strategy starts it loads the symbol schedule, parses all available orders, and opens the optional
debug log.
2. **Scheduling** – finished candles delivered by `SubscribeCandles(CandleType)` trigger the execution loop. The strategy reloads
the orders file so newly dropped instructions are picked up without restarting the process.
3. **Account snapshot** – if the candle hour matches `DownloadingHour`, `AccountFile` is rewritten with the current balance,
equity, and net position. The placeholder export is also produced at this stage.
4. **Order processing** – instructions whose trading date matches the candle date and whose hour passes the filters are executed.
   * `AMOUNT = 0` closes positions (`ClosePosition()`), respecting identifiers when `IgnoreTradeId` is disabled.
   * Non-zero `AMOUNT` values open market orders. The requested size is multiplied by the equity ratio when `UseMultiplier` is
     enabled. Executed identifiers are cached so that close instructions can reference the corresponding trade.
5. **Book keeping** – executed instructions are flagged to avoid reprocessing in subsequent candles.

## Differences versus the MetaTrader version

* Stop-loss and take-profit parameters are preserved but not automatically sent. The MetaTrader code passed boolean flags as price
  levels; this port keeps them as numeric placeholders ready for future extensions.
* Historical data export is represented by a stub file. Implement actual storage calls if historical CSVs are required.
* Position counting relies on the net `Strategy.Position` because StockSharp aggregates trades per security. Adapt the
  `MaxPositions` rule if a different aggregation is preferred.

## Usage tips

1. Generate the three CSV files in the platform's working directory (or adjust the parameter paths).
2. Drop new instructions into `OrdersFile`. The strategy removes the file after reading when `RemoveOrdersFile = true`, emulating
   the MetaTrader workflow. Disable the flag if the file should persist.
3. Ensure the schedule in `SymbolsFile` contains the StockSharp security identifiers and the correct execution hours. Set
   `TradingHour = -1` to rely exclusively on per-symbol values.
4. Start the strategy inside StockSharp Designer, Shell, or Runner. Orders will be executed whenever the configured candle type
   produces a finished bar whose date matches an instruction.

Extend the class to attach limit orders, stop management, or more advanced reporting if required by the trading desk workflow.
