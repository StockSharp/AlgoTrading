# GBP 9 AM 挂单策略

该策略是将 `MQL/7687/Gbp9am.mq4` 中的 MetaTrader 4 智能交易系统移植到 StockSharp 的结果。它复刻了伦敦上午 9 点突破的思路：在参考价上下放置两个挂单，并确保任意时刻只有一笔持仓。

## 交易思路

1. 在设定的观察小时与分钟到来时，策略记录最新已完成 K 线的收盘价。
2. 在收盘价上方放置买入止损单，在下方放置卖出止损单。两笔挂单使用相同手数，分别带有独立的止损，且共享相同的止盈距离。
3. 当其中一笔挂单成交时，另一笔挂单立即被取消，确保最多只持有一笔仓位。
4. 成交后的仓位使用“合成”止损与止盈进行管理，每根完成的 K 线都会检测是否触及这些水平。
5. 可以启用每日平仓时间，在伦敦交易时段结束后清除挂单并强制平仓。
6. 如果两笔挂单在没有成交的情况下被移除，或者市场时间已经偏离观察小时，策略会像原版 EA 一样在下一交易日重新武装。

点差偏移是根据品种的最小跳动价自动估算的。当报价带有 3 或 5 位小数时，逻辑会自动按 0.1 点处理。

## 参数说明

| 参数 | 说明 |
|------|------|
| `Volume` | 两个挂单共用的下单手数。 |
| `LookHour` | 对应伦敦 9 点的交易所小时。 |
| `LookMinute` | 在观察小时内取价的具体分钟。 |
| `CloseHour` | 强制平仓与撤单的时间。 |
| `UseCloseHour` | 是否启用每日强制平仓逻辑。 |
| `TakeProfitPips` | 止盈距离（点），对多空方向相同。 |
| `BuyDistancePips` | 收盘价到买入止损挂单的点数距离。 |
| `SellDistancePips` | 收盘价到卖出止损挂单的点数距离。 |
| `BuyStopLossPips` | 多头仓位的止损距离。 |
| `SellStopLossPips` | 空头仓位的止损距离。 |
| `CandleType` | 用于计时与风控的 K 线类型（默认 1 分钟）。 |

## 行为细节

- 策略只处理状态为 *Finished* 的 K 线，避免在同一根 K 线上重复触发。
- 所有价格都会根据合约的最小跳动价进行四舍五入。
- 重新武装逻辑与原版 EA 的 `clear_to_send` 标志一致：只要当日挂单已经下发，就必须满足“没有挂单、没有持仓，并且市场时间已远离观察小时”或“距离下一次观察不足 10 分钟且处于前一个小时”这两个条件之一，才会允许再次下单。
- 启用 `UseCloseHour` 后，一旦到达 `CloseHour`，策略会使用市价单平掉所有仓位，同时撤销未成交挂单。
- 由于策略基于历史 K 线计算价格，和 MetaTrader 基于即时报价的做法相比，止损/止盈可能存在微小差异，尤其在点差较大的品种上更为明显。

## 风险控制

移植保持了原策略的固定止损与止盈，没有加入追踪止损或分批管理。`OnStarted` 中调用了 `StartProtection()`，以防连接中断时账户暴露风险。

## 使用步骤

1. 根据行情源所在时区设置 `Volume`、`LookHour` 与 `LookMinute`。
2. 按照经纪商的点差结构调整各类距离参数。
3. 将策略附加到 GBPUSD（或其他外汇品种）上，并在伦敦开盘前启动。
4. 通过 StockSharp 自动生成的图表监控成交与仓位变化。

该实现遵循 `AGENTS.md` 的要求：使用高级 K 线订阅 API、通过参数系统暴露配置项，并避免对历史数据的低级遍历。
