# Стратегия Spreader 2

## Обзор

**Spreader 2** — это реализованный на StockSharp вариант советника MetaTrader «Spreader 2». Алгоритм отслеживает два коррелирующих инструмента на минутном таймфрейме и реагирует на краткосрочные расхождения при сохранении положительной корреляции. Когда фильтры по волатильности и направлению подтверждают сигнал, стратегия открывает рыночно-нейтральный спред: покупает один актив и одновременно продаёт второй. Пара закрывается, как только суммарная плавающая прибыль достигает заданного значения или появляются признаки нарушения корреляции.

## Основная логика

1. Получать закрытые свечи по основному и дополнительному инструменту и выравнивать их по времени закрытия.
2. Хранить скользящие массивы цен закрытия, чтобы обращаться к значениям `ShiftLength`, `2 * ShiftLength` и `1440` баров назад.
3. Вычислять первые разности `x1`, `x2` (основной инструмент) и `y1`, `y2` (дополнительный инструмент), оценивая локальные импульсы.
4. Пропускать сделки, если любой инструмент показал однонаправленные движения на двух соседних отрезках, либо если произведение `x1 * y1` отрицательно (признак отрицательной корреляции).
5. Рассчитывать коэффициент волатильности `a / b`, где `a = |x1| + |x2|`, `b = |y1| + |y2|`, и продолжать работу только при значениях в диапазоне `[0.3; 3.0]`.
6. Масштабировать объём по второму инструменту в соответствии с коэффициентом и корректировать его с учётом шага, минимума и максимума лота.
7. Проверять сигнал по суточному горизонту (1440 баров) и торговать только если долгосрочное движение поддерживает краткосрочное.
8. Открывать оба плеча одновременно: основной инструмент торгуется объёмом `PrimaryVolume`, дополнительный — скорректированным объёмом в противоположном направлении.
9. В процессе удержания позиции подсчитывать плавающую прибыль по обоим инструментам и закрывать спред при достижении `TargetProfit`.
10. Защитные проверки закрывают оставшийся плечо при неожиданных выходах и при необходимости восстанавливают недостающую сторону, чтобы сохранить хедж.

## Параметры

- **SecondSecurity** — второй инструмент в паре (обязателен).
- **PrimaryVolume** — объём сделки по основному инструменту, по умолчанию `1`.
- **TargetProfit** — целевая прибыль в абсолютных деньгах, по умолчанию `100`.
- **ShiftLength** — количество свечей между опорными точками при расчёте разностей, по умолчанию `30`.
- **CandleType** — тип свечей для подписки; стандартно используется таймфрейм 1 минута.

## Правила торговли

- Обрабатываются только завершённые свечи, чтобы не реагировать на неполные данные.
- Последовательность движений по каждому инструменту должна быть разнонаправленной на двух последних интервалах `ShiftLength`.
- Требуется положительная корреляция и соблюдение диапазона волатильности `[0.3; 3.0]`.
- Дополнительное подтверждение по 1440 барам блокирует сделки против дневного тренда.
- Заявки выставляются рыночным типом, второе плечо регистрируется с явным указанием инструмента и портфеля — как в оригинальном советнике.
- Для контроля прибыли используются последние цены закрытия и сохранённые цены входа.

## Примечания

- Предполагается совместимость спецификаций контрактов. Если мультипликаторы инструментов различаются, стратегия выводит предупреждение и прекращает торговлю.
- Как и исходный алгоритм, порт на StockSharp ждёт накопления не менее 1440 свечей перед первым входом.
- Дополнительные механизмы управления риском (стопы, лимиты времени) можно подключать внешними инструментами StockSharp.
