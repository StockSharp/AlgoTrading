# Spreader 2 策略

## 概述

**Spreader 2 策略** 是从 MetaTrader 专家顾问“Spreader 2”移植而来的配对交易系统。策略在 1 分钟周期内监控两个相关品种的 K 线，当两者的短期波动在受控波动率范围内出现背离但仍保持正相关时，系统会同时买入一只、卖出另一只，建立市场中性头寸。当组合的浮动利润达到设定目标或相关性条件失效时，策略会平掉整个价差。

## 核心逻辑

1. 接收主品种和副品种的收盘完成 K 线，并根据收盘时间对齐。
2. 维护两个品种的滚动收盘价序列，便于引用 `ShiftLength`、`2 * ShiftLength` 以及 `1440` 根之前的数据。
3. 计算主品种的 `x1`、`x2` 与副品种的 `y1`、`y2` 一阶差分，用于识别短期波动方向。
4. 若任一品种连续两段同方向波动（趋势过滤）或 `x1 * y1` 为负（负相关），则放弃交易。
5. 计算波动率比值 `a / b`（其中 `a = |x1| + |x2|`、`b = |y1| + |y2|`），仅当比值处于 `0.3` 到 `3.0` 范围内时才继续。
6. 按照波动率比值缩放副品种仓位，并根据合约的最小成交量、步长与上限进行调整。
7. 使用 1440 根（约一天）历史数据确认方向，仅在长周期走势支持短周期信号时才开仓。
8. 同时开仓两个腿：主品种使用 `PrimaryVolume` 设定的手数，副品种使用调整后的手数反向交易。
9. 持仓期间实时累计两个腿的浮动盈亏，当总盈亏超过 `TargetProfit` 时立刻平仓并清空入场参考价。
10. 若出现单腿意外平仓，保护逻辑会自动关闭另一条腿或在条件允许时重新补仓，以保持价差对冲结构。

## 参数

- **SecondSecurity**：参与价差的副品种（必填）。
- **PrimaryVolume**：主品种的下单手数，默认 `1`。
- **TargetProfit**：组合浮动利润目标（绝对金额），默认 `100`。
- **ShiftLength**：差分计算时引用的间隔 K 线数量，默认 `30`。
- **CandleType**：订阅的 K 线类型，默认使用 1 分钟时间框架。

## 交易规则

- 仅处理状态为完成的 K 线，避免基于未结束数据下单。
- 两个品种最近两段的波动方向必须相反，才能视为回归机会。
- 相关性必须为正，且波动率比值需保持在 `[0.3, 3.0]` 区间。
- 1440 根的长周期检查必须支持当前方向，否则信号作废。
- 使用市价单开仓，副品种委托明确指定证券与组合，以匹配原始脚本的行为。
- 结合最新收盘价与记录的入场价计算浮动盈亏，从而判断是否达到获利目标。

## 备注

- 策略假设两个品种的合约乘数兼容。若乘数不一致，策略会记录警告并停止交易。
- 由于原始算法需要完整的一天历史数据，移植版本同样会等待至少 1440 根 K 线后才允许首次进场。
- 若需要额外的风险控制（例如止损、限时平仓），可在策略外部叠加其他风控组件。
