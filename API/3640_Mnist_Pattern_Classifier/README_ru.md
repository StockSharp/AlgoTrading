# Стратегия Mnist Pattern Classifier

## Источник

Стратегия представляет собой порт эксперта MetaTrader 5 **TestMnistOnnx.mq5** (MQL ID 47225). Оригинальный советник предоставляет
интерактивное полотно для рисования цифр, которые затем классифицируются встроенной моделью MNIST в формате ONNX. Версия для StockSharp
сохраняет идею распознавания образов, но вместо ручного ввода использует скользящую матрицу, построенную по завершённым свечам.

## Концепция

1. Используется окно из `LookbackPeriod` завершённых свечей (по умолчанию 28), которое интерпретируется как сетка 28×28 в стиле MNIST.
2. Рассчитываются статистические показатели — ширина диапазона, сила тренда, моментум, отклонение RSI и нормированный ATR — и объединяются
   в синтетическую метрику "достоверности", имитирующую вероятность, которую возвращал оригинальный ONNX.
3. Полученные признаки сопоставляются с одним из десяти классов (`0`–`9`), каждый из которых описывает рыночный режим (флэт, тренд,
   пробой, откат, разворот и т.п.).
4. Когда определённый класс совпадает с выбранным пользователем `TargetClass`, а достоверность выше `ConfidenceThreshold`, стратегия
   открывает или переворачивает позицию в заданном направлении. При смене класса или падении достоверности позиция закрывается.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `LookbackPeriod` | 28 | Количество завершённых свечей в матрице MNIST. |
| `TargetClass` | 1 | Номер класса (0–9), на основании которого совершаются сделки. |
| `ConfidenceThreshold` | 0.6 | Минимальная синтетическая вероятность для отправки заявок. |
| `Volume` | 1 | Объём новой позиции. |
| `CandleType` | 5-минутные свечи | Тип данных, по которым происходит подписка. |

## Классы паттернов

| Класс | Значение |
|-------|----------|
| 0 | Флэт или низкая волатильность. |
| 1 | Устойчивый восходящий тренд. |
| 2 | Устойчивый нисходящий тренд. |
| 3 | Пробой вверх с сильным развитием. |
| 4 | Пробой вниз с сильным развитием. |
| 5 | Широкий волатильный диапазон без направления. |
| 6 | Бычий откат внутри восходящего тренда. |
| 7 | Медвежий откат внутри нисходящего тренда. |
| 8 | Бычий разворот после продолжительного падения. |
| 9 | Медвежий разворот после продолжительного роста. |

## Правила торговли

- Обработка ведётся только после закрытия свечей, что соответствует поведению исходного советника, реагировавшего на завершённый рисунок.
- Применяются рыночные заявки (`BuyMarket`, `SellMarket`); при смене направления позиция закрывается перед открытием новой.
- Значение достоверности ограничено диапазоном `[0, 1]`; повышение `ConfidenceThreshold` уменьшает число слабых сигналов.
- Стратегия не выставляет стоп-ордера — управление рисками рекомендуется выполнять через защитные механизмы StockSharp.

## Рекомендации по использованию

- Подбирайте таймфрейм свечей под характер анализируемого инструмента: короткие периоды реагируют быстрее, но дают больше шума.
- Оптимизируйте `TargetClass` и `ConfidenceThreshold` совместно: отдельные классы встречаются реже и требуют меньших порогов.
- Классификатор полностью детерминирован и не требует внешних библиотек ONNX Runtime.
- Используйте совместно с `StartProtection` и другими защитными средствами StockSharp для ограничения потерь.

## Отличия от оригинала

- Вместо ручного ввода цифр выполняется автоматический анализ свечных данных.
- "Достоверность" рассчитывается детерминированно, без нейронной сети.
- Добавлена логика открытия/закрытия позиций по распознанным паттернам.
- Файл ресурсов MNIST не нужен в среде StockSharp.
