# Mnist 模式分类策略

## 来源

本策略基于 MetaTrader 5 专家顾问 **TestMnistOnnx.mq5**（MQL ID 47225）改写。原始脚本提供一个交互式画布，让用户手绘数字并通过内置的 MNIST ONNX 模型识别。StockSharp 版本保留了模式识别的理念，但用基于完成 K 线的滚动矩阵替代了手绘画布。

## 核心思想

1. 使用 `LookbackPeriod`（默认 28）根已完成的 K 线构造一个 28×28 的网格，模拟 MNIST 图像。
2. 计算多个统计特征——区间宽度、趋势强度、动量、RSI 偏离和 ATR 标准化——并组合成一个模拟神经网络输出的“置信度”。
3. 将这些特征映射到 0–9 的十个模式类别，每个类别代表一种市场状态（震荡、趋势、突破、回调、反转等）。
4. 当检测到的类别等于用户设定的 `TargetClass` 且置信度高于 `ConfidenceThreshold` 时，策略按该类别对应的方向开仓或反手；若类别变化或置信度不足，则平仓。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `LookbackPeriod` | 28 | 转换为 MNIST 网格的完成 K 线数量。 |
| `TargetClass` | 1 | 触发交易的目标类别编号（0–9）。 |
| `ConfidenceThreshold` | 0.6 | 允许发单的最小置信度。 |
| `Volume` | 1 | 新仓位的下单量。 |
| `CandleType` | 5 分钟周期 | 用于更新的蜡烛数据类型。 |

## 模式类别

| 类别 | 含义 |
|------|------|
| 0 | 低波动或窄幅震荡。 |
| 1 | 持续的多头趋势。 |
| 2 | 持续的空头趋势。 |
| 3 | 伴随强势延续的向上突破。 |
| 4 | 伴随强势延续的向下突破。 |
| 5 | 高波动但无明显方向的宽幅震荡。 |
| 6 | 上升趋势中的多头回调。 |
| 7 | 下降趋势中的空头回调。 |
| 8 | 长期下跌后的多头反转。 |
| 9 | 长期上涨后的空头反转。 |

## 交易规则

- 仅在蜡烛收盘后执行计算，以匹配原专家在绘图完成后才执行推理的行为。
- 使用市价单（`BuyMarket`、`SellMarket`），并在反手前先平掉原有仓位，保持单一持仓模式。
- 置信度被限制在 `[0, 1]` 范围内，提高 `ConfidenceThreshold` 可以过滤掉较弱的信号。
- 策略本身不设置止损止盈，风险控制应由 StockSharp 的保护工具或外部模块完成。

## 使用建议

- 选择能体现目标市场节奏的蜡烛周期；周期越短，反应越快但噪音越多。
- 需要同时调优 `TargetClass` 与 `ConfidenceThreshold`，部分模式较少出现，可适当降低阈值。
- 分类器完全基于确定性计算，不依赖外部 ONNX 运行时库。
- 建议结合 `StartProtection` 等 StockSharp 内建风险保护功能使用。

## 与原版的差异

- 取消交互式绘图，改为自动分析历史 K 线。
- “置信度”由指标组合生成，而非神经网络概率。
- 新增了基于识别结果的自动交易逻辑。
- 不再需要 MNIST 资源文件。
