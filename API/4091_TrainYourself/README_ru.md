# Стратегия TrainYourself

Стратегия является портом MetaTrader 4 советника **TrainYourself-V1_1-1** на платформу StockSharp. В оригинале построение канала и открытия/закрытия позиций выполнялись через элементы на графике. В версии для StockSharp канал рассчитывается автоматически на каждой завершённой свече, а для ручного управления предоставлены отдельные методы.

## Логика работы

1. **Построение канала**
   - На каждой завершённой свече выбранного `CandleType` вычисляется индикатор `DonchianChannels` длиной `ChannelLength`.
   - Верхняя и нижняя границы дополнительно расширяются на `BufferPoints`, умноженные на биржевой шаг цены (`PriceStep`). Это воспроизводит приём из MQL, где линии сначала ставились на расстоянии 50 пунктов от текущих bid/ask, а затем сдвигались к экстремумам последних баров.
   - Получившиеся значения доступны через свойства `UpperBand` и `LowerBand`, что позволяет отображать их в пользовательских панелях.

2. **Подготовка к пробою**
   - Пока открыта позиция или параметр `EnableTrendTrade` выключен, автоматическая логика не активна.
   - Если позиция отсутствует, а цена закрылась внутри канала и держится на расстоянии не менее `ActivationPoints` × `PriceStep` от обеих границ, флаг `_isArmed` становится `true`. Это полный аналог переменной `q` из оригинального советника.

3. **Открытие сделок**
   - При активном флаге `IsArmed` закрытие свечи выше или на уровне `UpperBand` вызывает рыночную покупку (при условии `AllowBuyOpen`).
   - Закрытие ниже или на уровне `LowerBand` формирует рыночную продажу (если `AllowSellOpen` разрешён).
   - После входа стратегия мгновенно сбрасывает состояние подготовки и ждёт, пока цена снова вернётся внутрь канала без открытых позиций.

4. **Управление рисками**
   - Метод `StartProtection` выставляет защитные ордера. Дистанции вычисляются как `TakeProfitPoints` × `PriceStep` и `StopLossPoints` × `PriceStep`. При отсутствии шага цены используется значение `0.0001`, что соответствует поведению MetaTrader.

5. **Ручной контроль**
   - Объекты `BUY_TRIANGLE`, `SELL_TRIANGLE` и `CLOSE_ORDER` заменены публичными методами `TriggerManualBuy()`, `TriggerManualSell()` и `ClosePositionManually()`.
   - Перед исполнением методы проверяют `AllowBuyOpen`/`AllowSellOpen` и состояние подключения через `IsFormedAndOnlineAndAllowTrading()`, а после исполнения отключают автоматический режим, чтобы ручные позиции не перекрывались мгновенно автоматикой.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CandleType` | таймфрейм `30m` | Основной поток свечей для расчётов. |
| `ChannelLength` | `20` | Количество баров в канале Дончиана. |
| `BufferPoints` | `50` | Дополнительный запас в пунктах вокруг последней цены закрытия. |
| `ActivationPoints` | `2` | Минимальная дистанция до границ канала перед активацией пробойной логики. |
| `StopLossPoints` | `100` | Размер стоп-лосса в пунктах (переводится в цену через `PriceStep`). |
| `TakeProfitPoints` | `100` | Размер тейк-профита в пунктах (переводится в цену через `PriceStep`). |
| `EnableTrendTrade` | `true` | Включает автоматические сделки по пробою. При `false` доступны только ручные методы. |
| `Volume` | `1` | Объём заявок для автоматических и ручных входов. |

## Рекомендации по эксплуатации

- В MetaTrader пользователь должен был перемещать элементы на графике, чтобы обновить линии. В StockSharp канал пересчитывается после каждой свечи, поэтому ручных действий не требуется.
- Свойства `UpperBand`, `LowerBand` и `IsArmed` позволяют строить собственные визуализации состояния стратегии.
- Чтобы отключить защитные ордера, установите `StopLossPoints` или `TakeProfitPoints` в ноль — это повторяет поведение MQL-версии.
- Ручные сделки используют тот же `Volume` и автоматически получают заданные стопы/профиты.
- Для принудительного сброса режима ожидания можно вызвать `ClosePositionManually()` или дождаться, когда цена вновь окажется внутри канала и выполнит условия активации.
