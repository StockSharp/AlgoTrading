# Стратегия OsMaMaster

## Общее описание
Стратегия OsMaMaster повторяет поведение оригинального советника **OsMaSter_V0** для MetaTrader 4. В основе лежит анализ гистограммы MACD (OsMA) для поиска разворотных точек импульса. Обработка выполняется только по завершённым свечам, что соответствует требованиям репозитория.

## Логика торговли
- **Набор индикаторов** – используется индикатор `MovingAverageConvergenceDivergence` с периодами, совпадающими с параметрами MQL (по умолчанию 9/26/5).
- **Тип цены** – параметр `AppliedPrice` соответствует константам MetaTrader `PRICE_*` (0 – закрытие, 1 – открытие, 2 – максимум, 3 – минимум, 4 – медианная цена, 5 – типичная, 6 – взвешенная). Выбранное значение напрямую подаётся на вход MACD.
- **Формирование сигнала** – хранятся четыре значения гистограммы OsMA согласно смещениям `Shift1`–`Shift4`. Базовая конфигурация (0,1,2,3) ищет локальный минимум или максимум:
  - Покупка: `OsMA[shift4] > OsMA[shift3]`, `OsMA[shift3] < OsMA[shift2]`, `OsMA[shift2] < OsMA[shift1]`.
  - Продажа: `OsMA[shift4] < OsMA[shift3]`, `OsMA[shift3] > OsMA[shift2]`, `OsMA[shift2] > OsMA[shift1]`.
- **Ограничение по позициям** – новая сделка открывается только при отсутствии текущей позиции, аналогично проверке `ExistPositions` в оригинальном эксперте.

## Управление позицией
- **Стоп‑лосс** – параметр `StopLossPips` задаёт расстояние в пунктах от цены входа до защитного стопа. Значение `0` отключает стоп.
- **Тейк‑профит** – параметр `TakeProfitPips` работает так же, как в MQL. При `0` фиксированная цель не выставляется.
- **Исполнение** – срабатывание стопа и тейка проверяется по минимуму и максимуму свечи. Если уровень достигнут внутри бара, выход выполняется рыночной заявкой по закрытию свечи.
- **Сброс состояния** – при закрытии позиции стоп и тейк обнуляются, чтобы следующая сделка выставила собственные уровни.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Таймфрейм свечей для расчётов. | 1 час |
| `FastEmaPeriod` | Период быстрой EMA внутри MACD. | 9 |
| `SlowEmaPeriod` | Период медленной EMA внутри MACD. | 26 |
| `SignalPeriod` | Период сигнальной EMA. | 5 |
| `AppliedPrice` | Код MetaTrader `PRICE_*`, определяющий тип цены. | 0 (закрытие) |
| `Shift1` | Первое смещение OsMA (обычно текущий бар). | 0 |
| `Shift2` | Второе смещение OsMA. | 1 |
| `Shift3` | Третье смещение OsMA. | 2 |
| `Shift4` | Четвёртое смещение OsMA. | 3 |
| `StopLossPips` | Стоп‑лосс в пунктах. | 50 |
| `TakeProfitPips` | Тейк‑профит в пунктах. | 50 |

## Особенности конвертации
- Вместо обращения к истории индикатора хранится компактный буфер из последних значений OsMA, что удовлетворяет требованиям по отказу от пользовательских коллекций.
- Все решения принимаются только на закрытых свечах.
- Логика стопов и тейков повторяет MQL-вариант через анализ экстремумов свечи и закрытие позиций рыночными ордерами.
- Базовый объём `Volume` установлен в **0.01**, как и параметр `Lots` в советнике.

## Рекомендации по использованию
- Подбирайте `CandleType` и периоды MACD под волатильность инструмента: для быстрых рынков подойдут меньшие значения.
- Чтобы сопровождать тренд вручную, установите `TakeProfitPips = 0` и управляйте выходом по собственному правилу.
- При изменении смещений убедитесь, что максимальный `Shift` не слишком велик – стратегия хранит ровно столько значений, сколько требуется.
- Работа по свечам подразумевает задержку между фактическим касанием уровня и фиксацией сделки; уменьшение таймфрейма снижает это запаздывание.
