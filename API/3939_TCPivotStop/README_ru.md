# Стратегия TCPivotStop

## Обзор

TCPivotStop — это прямой порт советника MetaTrader 4 `gpfTCPivotStop`. Стратегия торгует вокруг классического дневного пивота, рассчитанного по данным предыдущего торгового дня. Логика включает:

- Расчёт пивот-точки, трёх уровней сопротивления и поддержки на основании максимума, минимума и цены закрытия предыдущего дня.
- Ожидание пробоя пивота: закрытие текущей свечи выше пивота (сигнал на покупку) или ниже пивота (сигнал на продажу).
- Открытие рыночной позиции по направлению пробоя с установкой стоп-лосса и тейк-профита на выбранном уровне пивот-сетки.
- При необходимости — принудительное закрытие позиции в начале заданного часа сессии, повторяющее поведение оригинального советника.

Реализация построена на высокоуровневом API StockSharp. Размер позиции определяется свойством `Volume` базового класса `Strategy`.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `TargetLevel` | Уровень пивота, используемый для стоп-лосса и тейк-профита (1, 2 или 3). | `1` |
| `CloseAtSessionStart` | При включении закрывает позиции при наступлении указанного часа. | `false` |
| `SessionCloseHour` | Час (0-23), контролирующий закрытие при активном `CloseAtSessionStart`. | `0` |
| `CandleType` | Таймфрейм свечей, формирующих торговые сигналы. | `H1` |

## Логика торговли

1. Подписка на свечи выбранного таймфрейма для сигналов и на дневные свечи для расчёта пивот-уровней.
2. После закрытия каждой дневной свечи рассчитываются классические уровни пивота:
   - `Pivot = (High + Low + Close) / 3`
   - `R1 = 2 * Pivot - Low`, `S1 = 2 * Pivot - High`
   - `R2 = Pivot + (R1 - S1)`, `S2 = Pivot - (R1 - S1)`
   - `R3 = High + 2 * (Pivot - Low)`, `S3 = Low - 2 * (High - Pivot)`
3. При завершении сигнальной свечи выполняются проверки:
   - Если `CloseAtSessionStart` включён и свеча открылась в `SessionCloseHour`, позиция немедленно закрывается.
   - При отсутствии позиции и пробое пивота вверх открывается покупка с целями, заданными `TargetLevel`.
   - При отсутствии позиции и пробое пивота вниз открывается продажа с зеркальными целями.
   - При наличии позиции выход выполняется при достижении цены стоп-лосса или тейк-профита.

## Примечания

- Вызов `StartProtection()` подключает встроенную систему риск-менеджмента платформы. Фактические выходы по стопу и профиту реализованы внутри стратегии.
- В MetaTrader-версии присутствовали e-mail уведомления и динамический расчёт лота по риску. Эти возможности не перенесены; при необходимости используйте штатные модули StockSharp.
- Пара `CloseAtSessionStart` + `SessionCloseHour` воспроизводит режим `isTradeDay` оригинального кода (значение `0` соответствует полуночи).
