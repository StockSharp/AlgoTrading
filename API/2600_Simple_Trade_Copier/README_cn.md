# 简易同账户交易复制策略

## 概述

**简易同账户交易复制策略** 会复制进入同一个 StockSharp 连接器与投资组合的手动或外部交易。
当检测到没有特定前缀的新成交时，策略会计算原始敞口的变化，并按照设置的倍数提交一笔复制单。
所有复制单都带有可配置的备注前缀，便于识别和管理。

该实现将 MQL4 脚本 `trade_copier_v.mq4` 转换为 StockSharp 的高级策略，保持了在同一账户镜像交易的行为。
策略依赖 `Connector.NewMyTrade` 事件，可处理任何传入投资组合的证券，并自动同步源头与复制敞口。

## 核心逻辑

1. **成交监听** – 逐一分析新的 `MyTrade` 事件。带有配置前缀的成交视为复制单，其他成交视为需要镜像的原始交易。
2. **头寸跟踪** – 策略分别维护原始与复制头寸的字典，同时记录等待成交的调整量，以避免在尚未成交时重复下单。
3. **订单复制** – 当原始敞口与复制敞口不一致时，策略计算差值，检查滑点限制，并提交方向与数量相匹配的市价单。
4. **维护逻辑** – 已处理的成交编号会缓存一段可配置的时间，防止连接器重新发送历史成交时重复执行。遗留的
   `CheckInterval` 参数用于控制这一缓存窗口。

## 参数说明

- **Slippage（滑点）** – 允许的价格偏差（以价格跳动为单位）。若最新成交价与原始成交价之差超过该值，则不会发送复制单。
- **Multiplier（倍数）** – 复制单的成交量倍数。设置为 `1` 表示完全复制，设置为 `2` 则复制双倍仓位。
- **MaxOrderAge（最大订单年龄）** – 可接受的源头成交最大延迟。超过该值的成交会被忽略，避免复制过期或历史数据。
- **CommentPrefix（备注前缀）** – 附加在复制订单备注中的前缀，同时用于识别已有复制单并避免重复复制。
- **CheckInterval（检查间隔）** – 来自原始 MQL 脚本的遗留定时参数。StockSharp 策略采用事件驱动方式立即同步，
  该参数用于控制已处理成交编号的保留时长。

## 使用指南

1. 将策略附加到接收原始交易的同一连接器与投资组合。
2. 根据需要调整各项参数，尤其是倍数与滑点，以符合交易所或经纪商的执行要求。
3. 启动策略后，它会立即开始跟踪成交并保持复制头寸与源头头寸一致。
4. 如果希望某些交易不被复制，可在下单前将配置好的前缀写入订单备注。

## 其他说明

- 策略可处理 StockSharp 支持的任何标的，无需提前配置交易品种。
- 为保持与 MQL 版本一致，复制操作使用市价单实现。
- 当源头头寸平仓时，策略会自动提交相反方向的复制单，使复制敞口同步归零。
- 策略完全依赖事件驱动，同时使用锁保护内部数据结构，以在高频成交时保持线程安全。
