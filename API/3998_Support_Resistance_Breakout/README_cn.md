# 支撑阻力突破策略

## 概述
该策略复刻了 MetaTrader 上的 “SupportResistTrade” 专家顾问，通过 Donchian 通道确定最近的支撑与阻力，并结合长期 EMA 趋势过滤器来筛选方向。只有当价格突破区间边界并且 K 线开盘价位于 EMA 的同侧时才会开仓。策略使用即时保护性止损以及三阶逐步移动止损（+10/+20/+30 点）来管理风险。

## 数据与指标
- **主要数据源：** 单一 K 线订阅（默认 1 分钟，可通过 `CandleType` 参数调整）。
- **支撑/阻力：** `DonchianChannels`，长度为 `RangeLength`（默认 55），用于追踪最近区间的最高价与最低价。
- **趋势过滤：** `ExponentialMovingAverage`，周期为 `EmaPeriod`（默认 500），基于 K 线开盘价计算。只有当开盘价位于 EMA 上方/下方时才允许做多/做空。

## 交易逻辑
1. **市场分析：** 每根已完成 K 线都会更新 Donchian 区间与 EMA。上轨视为阻力，下轨视为支撑。
2. **入场条件：**
   - **做多：** K 线收盘价突破阻力，且开盘价高于 EMA。若持有空单则先平仓，再市价开多。
   - **做空：** K 线收盘价跌破支撑，且开盘价低于 EMA。若持有多单则先平仓，再市价开空。
3. **初始止损：** 成交后立即在最新支撑（多单）或最新阻力（空单）放置止损单，对应原 EA 的 `OrderSend` 参数。
4. **离场规则：**
   - 当持仓已有盈利且收盘价回到更新后的支撑/阻力另一侧时，立即市价平仓，与原策略的 `OrderClose` 条件一致。
   - 保护性止损始终挂单生效，以防突然的反向波动。

## 逐步移动止损
策略严格按照 EA 的三次 `OrderModify` 调整止损：
| 盈利阈值（点） | 新的止损位置（相对开仓点数） | 说明 |
| --- | --- | --- |
| `>= 20` | `10` | 多单止损抬高到开仓价 +10 点；空单止损下移到开仓价 −10 点。 |
| `>= 40` | `20` | 止损进一步移动到开仓价 ±20 点。 |
| `>= 60` | `30` | 最后一步锁定 30 点利润。 |
止损从不反向移动：多单止损只会上移，空单止损只会下移，确保盈利被逐步锁定。

## 风险控制
- 保护性止损通过原生 `SellStop`/`BuyStop` 订单实现，即使策略暂时离线也能由券商执行。
- 策略按净头寸运行，每次新信号都会先平掉反向仓位，再建立新的方向。

## 参数
| 参数 | 默认值 | 说明 |
| --- | --- | --- |
| `RangeLength` | `55` | 计算支撑（最低价）与阻力（最高价）所用的 K 线数量。 |
| `EmaPeriod` | `500` | 基于开盘价计算的 EMA 趋势过滤周期。 |
| `CandleType` | `1 分钟` | 所有指标使用的 K 线类型，可自由切换。 |

## 说明
- 实现完全基于 StockSharp 高级 API，通过指标绑定与 K 线订阅完成全部计算。
- 当前仅提供 C# 版本，实现位于 `CS` 文件夹；未创建 Python 版本或相应目录。
