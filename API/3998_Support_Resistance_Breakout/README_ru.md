# Стратегия пробоя поддержки и сопротивления

## Обзор
Стратегия повторяет логику советника MetaTrader «SupportResistTrade». Она ищет пробои диапазона, построенного по максимумам и минимумам последних свечей (Donchian-канал), и подтверждает направление длинной экспоненциальной средней. Сделки открываются только тогда, когда цена закрытия выходит за пределы канала, а цена открытия свечи находится по ту же сторону от EMA. Управление риском реализовано через мгновенные защитные стопы и трёхступенчатый трейлинг, фиксирующий прибыль на уровнях +10, +20 и +30 пунктов.

## Данные и индикаторы
- **Основной поток:** одна подписка на свечи (по умолчанию минутные, задаются параметром `CandleType`).
- **Поддержка/сопротивление:** `DonchianChannels` с длиной `RangeLength` (по умолчанию 55) — отслеживает максимум и минимум диапазона.
- **Фильтр тренда:** `ExponentialMovingAverage` с периодом `EmaPeriod` (по умолчанию 500), рассчитывается по ценам открытия свечей. Длинные допускаются только при открытии выше EMA, короткие — ниже EMA.

## Логика торговли
1. **Анализ:** после завершения свечи пересчитываются границы Donchian-канала и значение EMA. Верхняя граница интерпретируется как сопротивление, нижняя — как поддержка.
2. **Вход:**
   - **Покупка:** закрытие выше сопротивления и одновременное открытие свечи выше EMA. При наличии короткой позиции она закрывается, затем отправляется рыночная заявка на покупку.
   - **Продажа:** закрытие ниже поддержки и открытие свечи ниже EMA. При наличии длинной позиции она закрывается, после чего отправляется рыночная заявка на продажу.
3. **Начальный стоп:** сразу после исполнения сделки выставляется стоп-заявка на уровне текущей поддержки (для покупок) или сопротивления (для продаж), как в исходном `OrderSend`.
4. **Выход:**
   - Если позиция в прибыли и цена закрытия возвращается за пересчитанную поддержку/сопротивление, позиция закрывается рыночной заявкой — полностью повторяя `OrderClose` советника.
   - Защитный стоп остаётся активным и страхует от резких разворотов.

## Трейлинг-стоп
Алгоритм точно повторяет три вызова `OrderModify` в MQL:
| Порог прибыли (пункты) | Новый уровень стопа (относительно цены входа) | Комментарий |
| --- | --- | --- |
| `>= 20` | `10` | Для покупок стоп переносится на цену входа +10 пунктов; для продаж — на цену входа −10 пунктов. |
| `>= 40` | `20` | Стоп подтягивается на ±20 пунктов от цены входа. |
| `>= 60` | `30` | Финальный шаг фиксирует прибыль в 30 пунктов. |
Стоп никогда не отодвигается назад: у покупок он только повышается, у продаж — только понижается.

## Управление рисками
- Защитные стопы реализованы через биржевые `SellStop`/`BuyStop`, поэтому исполняются даже при краткосрочном отключении стратегии.
- Используется чистая позиция: каждый новый сигнал закрывает противоположное направление перед открытием новой сделки.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `RangeLength` | `55` | Количество свечей для расчёта поддержки (минимума) и сопротивления (максимума). |
| `EmaPeriod` | `500` | Период EMA по ценам открытия, используемой как фильтр тренда. |
| `CandleType` | `1 минута` | Тип свечей для всех расчётов, может быть изменён пользователем. |

## Примечания
- Реализация построена на высокоуровневом API StockSharp: используются подписки на свечи и привязка индикаторов.
- Python-версия не создавалась — весь код находится в папке `CS`.
