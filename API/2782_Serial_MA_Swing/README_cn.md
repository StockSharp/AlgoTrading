# Serial MA Swing 策略 (API/2782)

## 概述
- 将 MetaTrader 平台的 SerialMA 智能交易系统迁移到 StockSharp，高层 API 与自定义串行均线指标共同完成策略逻辑。
- 当串行均线与价格再次交叉时开立新的波段仓位，可选反转信号并限制同向持仓数量，复现原策略的“连环开仓”模式。
- 使用点数(PriceStep)定义的固定止损与止盈，和原始 EA 保持一致，在每根收盘 K 线时重新检查触发条件。

## 串行移动平均指标
原 EA 依赖自定义的 *SerialMA* 指标：价格每次穿越均线时，均线都会重新起算。本移植版本的指标按以下步骤工作：
1. 从最近一次交叉开始累加收盘价，计算区间的算术平均值。
2. 记录均值与当前收盘价的差值符号，用于检测方向变化。
3. 当符号发生变化时，重置内部窗口，使均线从交叉处重新起算，并向策略发出“已交叉”的标记。

指标输出移动平均值以及一个布尔标志，标志为 `true` 表示上一根 K 线完成了交叉，这让策略无需直接访问指标缓冲即可得到完整信息。

## 交易逻辑
1. 每当一根 K 线收盘，策略读取串行均线的数值和交叉标志。
2. 若上一根 K 线标记为交叉：
   - 上一根的收盘价高于上一根的均线，则产生做多信号。
   - 上一根的收盘价低于上一根的均线，则产生做空信号。
3. **ReverseSignals** 参数可以交换多空方向，实现反向交易。
4. **OpenedMode** 控制仓位叠加方式：
   - **AllSwing**：每次信号都新开仓，即使同向已有持仓。
   - **SingleSwing**：同向只允许一笔仓位，若已持仓则忽略新信号。
5. 开启新仓位前，会先平掉反向仓位，保持与原 EA 相同的“翻向再入场”风格。
6. 在每根收盘 K 线上，根据价格是否触及止损/止盈价位来平仓，止损止盈距离均以点数换算到实际价格。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `OpenedMode` | 波段持仓模式：叠加或单笔。 | `AllSwing` |
| `EnableBuy` | 是否允许做多。 | `true` |
| `EnableSell` | 是否允许做空。 | `true` |
| `ReverseSignals` | 是否反转信号。 | `false` |
| `TradeVolume` | 每次下单的手数。 | `1` |
| `StopLossPoints` | 止损点数，`0` 表示不启用。 | `0` |
| `TakeProfitPoints` | 止盈点数，`0` 表示不启用。 | `0` |
| `CandleType` | 用于计算的 K 线类型。 | 5 分钟 K 线 |

## 风险控制与持仓管理
- 多头持仓：若当前 K 线最低价跌破止损价，立即市价平仓；若最高价触及止盈价，同样市价平仓。
- 空头持仓：最高价触及止损，或最低价触及止盈时平仓。
- 所有价位均使用 `PriceStep` 换算。如果标的未提供价格步长，策略会跳过保护性检查，与原 EA 在缺少 `Point()` 时的表现相符。

## 使用提示
- 策略完全采用 StockSharp 高层接口 (`SubscribeCandles` + `BindEx`)，不需要手动维护指标缓存。
- 根据需求未提供 Python 版本；只有 `CS/SerialMASwingStrategy.cs` 中的 C# 实现。
- 若希望最大程度保持与原策略一致，可同时允许多空并保持 `AllSwing` 模式。
