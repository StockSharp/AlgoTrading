# Cryptocurrency Fibonacci MAs (версия StockSharp)

## Обзор
Стратегия переносит эксперт "Cryptocurrency Fibonacci MAs" с MetaTrader на высокоуровневый API StockSharp. Система отслеживает веер экспоненциальных скользящих средних с длинами 8/13/21/55, проверяет импульс на старшем таймфрейме и подтверждает глобальный тренд месячным MACD перед отправкой рыночных ордеров. Обрабатываются только завершённые свечи, а индикаторы обновляются через `Bind` и `BindEx`.

Изменения по сравнению с оригиналом:
- Удалены денежный тейк-профит, эквити-стоп, пошаговый трейлинг и перевод в безубыток. В версии StockSharp используется классический стоп/тейк в пунктах через `StartProtection`.
- Управление позицией выполняется в неттинговой модели: допускается только суммарная позиция по направлению. Развороты сначала закрывают встречный объём.
- Данные со старших таймфреймов поступают из отдельных подписок на свечи вместо единичных запросов индикаторов.

## Торговые правила
### Вход в лонг
1. EMA упорядочены по возрастанию: 8 > 13 > 21 > 55 на основном таймфрейме.
2. Импульс на старшем таймфрейме: абсолютное отклонение Momentum(14) от уровня 100 превышает порог для хотя бы одной из последних трёх свечей старшего таймфрейма.
3. MACD (месячный) — линия MACD выше сигнальной.
4. Текущая позиция должна быть пустой либо короткой и не превышать лимит `MaxPositions`.

### Вход в шорт
1. EMA упорядочены по убыванию: 8 < 13 < 21 < 55.
2. Импульс превышает порог для продажи.
3. Линия MACD ниже сигнальной.
4. Позиция должна быть пустой либо длинной и укладываться в лимит по объёму.

### Выходы
- `StartProtection` выставляет стоп-лосс и тейк-профит в пунктах. Дополнительного трейлинга и перевода в безубыток нет.
- При появлении сигнала разворота стратегия отправляет рыночный ордер противоположного направления, что автоматически закрывает текущую позицию.

## Соответствие таймфреймов
Настройки старшего таймфрейма для импульса повторяют таблицу из исходного советника:

| Основной TF | TF импульса |
| --- | --- |
| 1 мин | 15 мин |
| 5 мин | 30 мин |
| 15 мин | 1 час |
| 30 мин | 4 часа |
| 1 час | 1 день |
| 4 часа | 1 неделя |
| 1 день | 1 месяц |
| 1 неделя | 1 месяц |
| 1 месяц | 1 месяц |

MACD всегда рассчитывается по месячному (30-дневному) таймфрейму.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TradeVolume` | Объём сделки в лотах. | 0.1 |
| `StopLossPips` | Дистанция стоп-лосса в пунктах. | 20 |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | 50 |
| `MomentumBuyThreshold` | Минимальное отклонение импульса для входа в лонг. | 0.3 |
| `MomentumSellThreshold` | Минимальное отклонение импульса для входа в шорт. | 0.3 |
| `MaxPositions` | Максимальный нетто-объём в направлении (в кратных `TradeVolume`). | 1 |
| `CandleType` | Основной таймфрейм для расчёта EMA. | 1 час |

## Рекомендации по применению
1. Запустите стратегию на нужном инструменте и задайте таймфрейм через параметр `CandleType`.
2. Убедитесь, что поставщик данных отдаёт как основной, так и старшие таймфреймы (для импульса и месячного MACD).
3. Отстройте размеры стопа и тейка под размер шага цены инструмента — вспомогательная функция переводит пункты в шаги через `Security.PriceStep`.
4. Используйте оптимизацию для подбора порогов импульса и расстояний стоп/тейк в зависимости от инструмента.
