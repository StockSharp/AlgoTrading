# Virtual Profit/Loss Trail 策略

## 概述

`VirtualProfitLossTrailStrategy` 在 StockSharp 中复刻了 MetaTrader 的 “Virtual Profit Loss Trail” 专家顾问。该策略本身不会开仓，只是持续监控所选证券的当前仓位，并按照以下规则提供虚拟保护：

- 以点（pip）为单位的止盈距离；
- 以点为单位的止损距离；
- 在达到最低盈利后启动的虚拟移动止损，并且只有在价格进一步按照设定步长前进时才继续上移。

由于采用虚拟价格线，策略不会向交易所发送真实的止损或止盈单。当买一或卖一触碰到任一虚拟水平时，会立即通过市价单平仓。

## 参数

| 参数 | 说明 |
|------|------|
| **Take-profit (pips)** | 入场价与止盈目标之间的距离，设置为 `0` 可关闭止盈。 |
| **Stop-loss (pips)** | 入场价与止损价之间的距离，设置为 `0` 可关闭止损。 |
| **Trailing stop (pips)** | 计算移动止损所用的距离，设置为 `0` 时完全禁用移动止损。 |
| **Trailing step (pips)** | 移动止损再次上移之前必须增加的额外盈利，设置为 `0` 可在每次创新高/新低时即时移动。 |
| **Trailing activation (pips)** | 移动止损开始生效前需要锁定的最低盈利，设置为 `0` 表示入场后立即启用。 |

所有距离均以点为单位。策略会根据证券的最小价位变动自动推导点值：当报价保留三位或五位小数时，一个点等于十个最小跳动，否则等于一个跳动。

## 工作流程

1. **行情订阅**：策略订阅 Level1 数据，以获取最新的买一和卖一报价，确保在实时及历史回放中都能工作。
2. **多头管理**：当净头寸为多头时，策略按照平均入场价计算虚拟止损、止盈和移动止损。如果买一触及止损或止盈，将立即市价卖出。当达到激活盈利后，移动止损开始跟随价格上涨，并且仅在满足移动步长要求时才继续上移。
3. **空头管理**：对于净空头，逻辑对称地基于卖一价格执行。
4. **重置机制**：在仓位全部平仓后，内部的移动止损参考会被清除，避免误触发。

## 使用建议

- 将策略绑定到已经有持仓或由其他策略/手动交易产生持仓的证券和投资组合上，它会管理聚合仓位。
- 需要确保 Level1 数据可用，否则无法评估虚拟价格线。
- 可以与任意入场策略并行运行，只需确保只有一个实例负责保护性逻辑，以免互相冲突。

## 与 MQL 专家的差异

- StockSharp 版本针对聚合仓位工作，不再逐个订单处理，而是使用平台提供的平均入场价。
- 原策略中的图形线条和声音提示被日志输出取代，所有保护操作都会记录在策略日志中。
- 保留了原有基于点数的配置，包括移动止损的启动阈值与步长。

## 文件结构

- `CS/VirtualProfitLossTrailStrategy.cs` – 策略的 C# 实现。
- `README.md` – 英文说明。
- `README_cn.md` – 中文说明（当前文件）。
- `README_ru.md` – 俄文说明。
