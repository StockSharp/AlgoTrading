# Стратегия Virtual Profit/Loss Trail

## Общее описание

`VirtualProfitLossTrailStrategy` переносит эксперта MetaTrader "Virtual Profit Loss Trail" на платформу StockSharp. Стратегия не открывает новые позиции самостоятельно. Её задача — постоянно отслеживать текущую позицию по выбранному инструменту и применять виртуальные уровни защиты:

- настраиваемый тейк-профит в пунктах (pips);
- настраиваемый стоп-лосс в пунктах;
- виртуальный трейлинг-стоп, который активируется после достижения минимальной прибыли и сдвигается только при дополнительном движении цены на заданный шаг.

Поскольку уровни виртуальные, на биржу не отправляются реальные стоп- или лимитные заявки. При достижении соответствующего уровня лучшим бидом или аском стратегия закрывает позицию рыночным ордером.

## Параметры

| Параметр | Описание |
|----------|----------|
| **Take-profit (pips)** | Расстояние между ценой входа и целью по прибыли. Значение `0` отключает тейк-профит. |
| **Stop-loss (pips)** | Расстояние до защитного стоп-лосса. Значение `0` отключает стоп. |
| **Trailing stop (pips)** | Расстояние, используемое при расчёте трейлинг-стопа. Значение `0` полностью отключает трейлинг. |
| **Trailing step (pips)** | Дополнительное движение цены, необходимое для очередного сдвига трейлинга. При `0` трейлинг обновляется при каждом новом экстремуме. |
| **Trailing activation (pips)** | Минимальная прибыль, которую нужно зафиксировать до включения трейлинг-стопа. При `0` трейлинг активируется сразу после входа. |

Все расстояния задаются в пунктах. Размер пункта определяется автоматически по шагу цены инструмента: для трёх и пяти знаков после запятой один пункт равен десяти шагам цены, в остальных случаях — одному шагу.

## Алгоритм работы

1. **Подписка на данные** – стратегия подписывается на поток Level1, чтобы получать актуальные значения лучшего бида и аска.
2. **Управление лонгом** – при положительной позиции рассчитываются виртуальные уровни стоп-лосса, тейк-профита и трейлинга от средней цены входа. При касании бида позиция закрывается. После достижения порога активации трейлинг следует за ценой вверх и сдвигается при выполнении условия по шагу.
3. **Управление шортом** – логика зеркальна и опирается на значение лучшего аска.
4. **Сброс состояний** – после полного закрытия позиции внутренние переменные трейлинга очищаются, чтобы исключить ложные сигналы.

## Рекомендации по использованию

- Запускайте стратегию вместе с источником сделок (ручной торговлей или другой стратегией). Она будет контролировать совокупную позицию по инструменту.
- Убедитесь, что поток Level1 доступен, иначе виртуальные уровни не смогут рассчитываться.
- Не запускайте несколько экземпляров стратегии для одного и того же инструмента, чтобы избежать конфликтов при закрытии позиций.

## Отличия от MQL-версии

- В StockSharp стратегия работает с общей позицией, а не с отдельными тикетами ордеров, и использует среднюю цену, которую предоставляет платформа.
- Отрисовка линий и звуковые сигналы заменены протоколированием действий в журнале стратегии.
- Сохранены параметры, выраженные в пунктах, включая порог активации и шаг трейлинг-стопа.

## Структура

- `CS/VirtualProfitLossTrailStrategy.cs` – исходный код стратегии на C#.
- `README.md` – документация на английском языке.
- `README_cn.md` – документация на китайском языке.
- `README_ru.md` – текущий файл с описанием на русском языке.
