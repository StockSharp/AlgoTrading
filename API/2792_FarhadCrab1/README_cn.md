# Farhad Crab 策略 (C#)

## 概述
Farhad Crab 是一套趋势型策略，通过考察价格相对指数移动平均线 (EMA) 的位置来寻找回调入场机会，并使用固定止损、止盈、移动止损以及日线过滤器进行风险控制。原始的 MT5 专家顾问使用小时级别的 K 线执行交易，同时参考日线数据来决定是否平仓。本 C# 版本保持了这一框架，将工作周期的 EMA 与日线 EMA 交叉过滤结合使用。

## 核心思想
- **趋势过滤器：** 在工作周期上计算 EMA（默认是 1 小时 K 线上的 15 周期 EMA）。若上一根 K 线的最低价高于 EMA，则允许做多；若上一根 K 线的最高价低于 EMA，则允许做空。
- **日线过滤器：** 在日线周期上再计算一条 EMA。当日线 EMA 从下向上穿越日线收盘价时，平掉所有多单；当日线 EMA 从上向下穿越收盘价时，平掉所有空单。
- **风险管理：** 止损和止盈以点 (pip) 为单位设置。移动止损在浮盈超过“移动止损距离 + 止损步长”时上移/下移保护价位，模拟 MT5 中 `TrailingStop` 与 `TrailingStep` 的组合行为。
- **单一净头寸：** 策略只维持一个净持仓量。当方向反转时，会先平掉原有仓位，再按照 `Volume` 参数开出新仓。

## 交易规则
1. **入场条件（工作周期）：**
   - 若上一根 K 线的最低价高于 EMA（考虑 `MaShift` 设定的位移），则做多。
   - 若上一根 K 线的最高价低于 EMA，则做空。
2. **下单数量：** `Volume` 参数定义基准下单量。若需要反向开仓，会自动加上现有反向仓位的数量以完成净头寸切换。
3. **止损/止盈：**
   - 距离以点 (pip) 表示。点值根据品种的最小价格变动 (`PriceStep`) 自动计算，对三位或五位报价的外汇品种会额外乘以 10，以符合 MT5 的处理方式。
   - 将参数设为 `0` 即可关闭相应的止损或止盈。
4. **移动止损：**
   - 仅当 `TrailingStopPips` 大于 0 时启用。
   - 做多时，当浮盈超过 `TrailingStopPips + TrailingStepPips`，止损价格更新为 `当前价 - TrailingStopPips`；做空时对称处理。
   - 止损步长可避免过于频繁地调整保护价。
5. **日线平仓过滤：**
   - 使用最近两根已完成的日线。
   - 如果两天前日线 EMA 低于收盘价，而昨天日线 EMA 高于收盘价，则平掉多单。
   - 如果出现相反的穿越，则平掉空单。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | 1 小时时间框架 | 用于计算信号的工作周期。 |
| `MaLength` | `int` | 15 | 工作周期 EMA 的周期长度。 |
| `MaShift` | `int` | 0 | 将 EMA 值向后偏移的已完成 K 线数量。 |
| `DailyMaLength` | `int` | 15 | 日线 EMA 的周期长度，用于交叉平仓过滤。 |
| `StopLossPips` | `decimal` | 50 | 止损距离（点）。设为 0 可禁用。 |
| `TakeProfitPips` | `decimal` | 50 | 止盈距离（点）。设为 0 可禁用。 |
| `TrailingStopPips` | `decimal` | 10 | 移动止损距离（点）。设为 0 可禁用移动止损。 |
| `TrailingStepPips` | `decimal` | 5 | 重新上移/下移移动止损前所需的额外盈利（点）。 |
| `Volume` | `decimal` | 0.1 | 每次下单的基准数量。 |

## 与 MT5 版本的差异
- 仅实现指数移动平均，保持了原脚本的默认设置；其他平滑方式暂不支持。
- MT5 版本基于逐笔报价执行止损/止盈，这里改为在 K 线完成后根据最高价和最低价判断是否触发。
- 原代码中引用的 Parabolic SAR 指标未实际用于决策，因此在移植版本中移除。
- 移动止损通过内部记录的价格水平工作，不直接下发经纪商止损单；当价格触及计算出的水平时，策略会在下一根 K 线上执行平仓。

## 使用建议
- 根据目标交易节奏选择合适的 `CandleType`。默认的一小时 K 线可以重现原脚本的行为。
- 同时调整 `MaLength` 与 `DailyMaLength`，在入场敏感度与趋势过滤之间找到平衡。
- 对于五位报价的外汇产品，点值会自动换算为 0.0001。
- 回测时请确保获取到日线数据，以便日线 EMA 过滤器能够正常运行。
