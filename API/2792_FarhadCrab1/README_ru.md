# Стратегия Farhad Crab (C#)

## Описание
Farhad Crab — это трендовая стратегия, которая ищет входы на откатах к экспоненциальной скользящей средней (EMA) и управляет рисками с помощью фиксированных стопов, тейк-профитов, трейлинг-стопа и фильтра по старшему таймфрейму. Оригинальный советник MetaTrader 5 анализировал часовые свечи и контролировал выход по данным дневного таймфрейма. Перенос на C# сохраняет эту логику, комбинируя EMA рабочего таймфрейма и фильтр пересечения дневной EMA с ценой закрытия.

## Ключевые элементы
- **Фильтр тренда:** EMA на рабочем таймфрейме (по умолчанию 15-периодная EMA на часовых свечах). Лонг разрешён, если минимум предыдущей свечи находится выше EMA; шорт — если максимум ниже EMA.
- **Дневной фильтр:** Отдельная EMA на дневных свечах. Когда дневная EMA пересекает цену закрытия снизу вверх, все длинные позиции закрываются. Обратное пересечение закрывает короткие позиции.
- **Контроль рисков:** Фиксированные стоп-лосс и тейк-профит измеряются в пунктах. Трейлинг-стоп двигает уровень защиты, когда прибыль превышает заданный порог, повторяя связку параметров `TrailingStop` и `TrailingStep` из MT5.
- **Единая позиция:** Стратегия работает с единой суммарной позицией. При развороте сначала закрывается противоположная позиция, затем открывается новая в выбранном направлении.

## Правила торговли
1. **Входы:**
   - Лонг — если минимум предыдущей свечи выше сдвинутого значения EMA.
   - Шорт — если максимум предыдущей свечи ниже EMA.
2. **Объём:** Параметр `Volume` задаёт базовый объём. При развороте добавляется объём для закрытия обратной позиции.
3. **Стопы и тейк-профиты:**
   - Указываются в пунктах. Размер пункта вычисляется по `PriceStep`, для инструментов с 3/5 знаками точность умножается на 10, чтобы соответствовать MT5.
   - Значение `0` отключает стоп или тейк-профит.
4. **Трейлинг-стоп:**
   - Работает, если `TrailingStopPips` > 0.
   - Для лонга стоп переносится на `текущая цена - TrailingStopPips`, когда прибыль превысила сумму `TrailingStopPips + TrailingStepPips`.
   - Дополнительный шаг предотвращает частые модификации.
5. **Фильтр выхода по дневным данным:**
   - Используются две последние завершённые дневные свечи.
   - Длинные позиции закрываются, если два дня назад EMA была ниже цены закрытия, а вчера — выше.
   - Короткие позиции закрываются при обратном пересечении.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | Часовой таймфрейм | Таймфрейм для расчёта EMA и сигналов. |
| `MaLength` | `int` | 15 | Период EMA рабочего таймфрейма. |
| `MaShift` | `int` | 0 | Сдвиг EMA назад на указанное число свечей. |
| `DailyMaLength` | `int` | 15 | Период дневной EMA для фильтра выхода. |
| `StopLossPips` | `decimal` | 50 | Дистанция стоп-лосса в пунктах (0 — отключить). |
| `TakeProfitPips` | `decimal` | 50 | Дистанция тейк-профита в пунктах (0 — отключить). |
| `TrailingStopPips` | `decimal` | 10 | Дистанция трейлинг-стопа в пунктах (0 — отключить). |
| `TrailingStepPips` | `decimal` | 5 | Минимальное дополнительное движение для обновления трейлинга. |
| `Volume` | `decimal` | 0.1 | Базовый торговый объём. |

## Отличия от версии MT5
- Используется только экспоненциальная скользящая средняя (в MT5 по умолчанию стоял EMA).
- MT5-советник работал по тиковым котировкам, поэтому там стопы и тейки исполнялись ордерами брокера. В C#-версии проверки выполняются по максимумам/минимумам завершённых свечей.
- Индикатор Parabolic SAR присутствовал в исходнике, но не влиял на решения, поэтому в переносе не используется.
- Трейлинг изменяет внутренний уровень стопа; реальное закрытие позиции происходит при достижении ценой заданного уровня.

## Рекомендации по применению
- Подбирайте рабочий таймфрейм под желаемый горизонт торгов.
- Синхронно изменяйте `MaLength` и `DailyMaLength`, чтобы настроить баланс между чувствительностью входов и фильтрацией тренда.
- Для пятизначных валютных пар пункты автоматически конвертируются в шаг 0.0001.
- При тестировании убедитесь, что доступны дневные данные, иначе фильтр выхода не сработает.
