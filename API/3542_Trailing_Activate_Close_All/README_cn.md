# Trailing Activate Close All 策略

## 概述

**Trailing Activate Close All 策略** 是一个风险管理模块，用于复刻 MetaTrader 专家顾问 *Trailing Activate Close All* 的行为。它不会自行开仓，而是管理同一标的上由人工或其他策略建立的头寸。该模块会自动挂出止损和止盈单，在持仓获利后跟踪调整止损，并在浮动利润达到目标值时强制平掉所有头寸。

该逻辑针对以“点（point）”计价的品种设计（例如 1.00055 与 1.00045 之间的差为 10 点）。所有距离相关的参数都以点为单位，并通过标的的最小报价步长换算为实际价格距离。

## 功能特点

- 当缺少止损或止盈时自动补充保护性委托。
- 可选的追踪止损功能，带有激活阈值和移动步长。
- 可选择在每个行情更新时执行计算，或仅在指定周期的新 K 线完成后执行。
- 当汇总的未实现利润达到目标值时，自动关闭全部头寸。
- 通过可配置的安全倍数遵守交易所的止损/冻结距离限制。
- 针对关键操作输出详细日志信息。

## 参数说明

| 参数 | 说明 |
|------|------|
| **Candle Type** | 当选择在新 K 线上跟踪时所使用的时间框架。在逐笔模式下忽略。 |
| **Trailing Mode** | 在 `EveryTick`（逐笔）与 `NewBar`（新 K 线）之间切换保护逻辑的执行频率。 |
| **Stop Loss (points)** | 保护性止损距离当前市场价的点数，设为 0 表示不自动挂止损。 |
| **Take Profit (points)** | 保护性止盈距离，设为 0 表示不自动挂止盈。 |
| **Trailing Activate (points)** | 相对于开仓价的最小盈利距离，达到后才允许移动止损。 |
| **Trailing Stop (points)** | 追踪止损与当前价格之间的距离。大于 0 时启用追踪功能。 |
| **Trailing Step (points)** | 连续两次调整止损之间所需的最小价格改善。 |
| **Target Profit (money)** | 汇总未实现利润达到此值后关闭所有头寸。设为 0 表示关闭该功能。 |
| **Freeze Coefficient** | 当交易所未提供止损或冻结水平时，将点差乘以该系数作为安全缓冲。 |
| **Detailed Logging** | 启用后会输出关于修改与强制平仓的详细日志。 |

## 使用提示

1. 将策略附加到已经持仓或将由其他逻辑开仓的标的与投资组合上。
2. 距离类参数需按照点数配置，以适配具体品种的报价精度。
3. 策略需要 Level1 行情以获取买卖报价及交易所限制；在 `NewBar` 模式下还会订阅相应周期的 K 线数据。
4. 当满足追踪或目标盈利条件时，策略会先撤销已有保护单，再通过市价单平掉头寸。
5. 如果启用了追踪但步长参数为 0，策略会立即停止并报告配置错误，与原始 EA 的安全检查保持一致。

## 与 MQL 版本的差异

- 使用 StockSharp 的止损/止盈委托来替代 MetaTrader 的 `PositionModify` 调整。
- 根据标的的报价步长以及可能提供的止损/冻结水平来换算距离。
- 管理由策略整体持有的净头寸，而不是遍历 MetaTrader 的单个持仓票据。
- 针对每项重要决策输出结构化日志。

该模块可以与其他 StockSharp 策略组合，为任意支持的市场提供自动化风险控制。
