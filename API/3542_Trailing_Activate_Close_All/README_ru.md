# Стратегия Trailing Activate Close All

## Описание

**Trailing Activate Close All** — модуль управления рисками, повторяющий логику одноимённого эксперта MetaTrader. Стратегия не открывает сделки самостоятельно. Её задача — сопровождать позиции, которые были открыты вручную или сторонними алгоритмами по тому же инструменту. Модуль автоматически выставляет защитные стоп-лоссы и тейк-профиты, переносит стоп по мере роста прибыли и при достижении целевой доходности закрывает все открытые позиции.

Все расстояния задаются в «пунктах» MetaTrader (например, между 1.00055 и 1.00045 — 10 пунктов). Стратегия конвертирует эти значения в абсолютное расстояние по цене, используя минимальный шаг цены инструмента.

## Ключевые возможности

- Автоматическое выставление защитных приказов, если их нет у текущей позиции.
- Настраиваемый трейлинг-стоп с порогом активации и минимальным шагом переноса.
- Пересчёт логики на каждом тике или только по закрытию новых свечей выбранного таймфрейма.
- Принудительное закрытие всех позиций при достижении заданной суммарной прибыли.
- Учёт биржевых ограничений по стопам и «заморозке» через настраиваемый коэффициент.
- Подробные сообщения в журнале для всех важных действий.

## Параметры

| Параметр | Описание |
|----------|----------|
| **Candle Type** | Таймфрейм свечей, по которым запускается логика в режиме `NewBar`. В режиме `EveryTick` не используется. |
| **Trailing Mode** | Частота пересчёта логики: `EveryTick` (каждый тик) или `NewBar` (по закрытию свечи). |
| **Stop Loss (points)** | Расстояние до защитного стоп-лосса в пунктах. Значение 0 отключает автоматическую установку стопа. |
| **Take Profit (points)** | Расстояние до тейк-профита в пунктах. Значение 0 отключает установку. |
| **Trailing Activate (points)** | Минимальная прибыль от цены входа, после которой разрешается переносить стоп. |
| **Trailing Stop (points)** | Расстояние от текущей цены до трейлинг-стопа. Значение должно быть больше нуля для включения функции. |
| **Trailing Step (points)** | Минимальный прирост цены в пунктах, после которого стоп переносится повторно. |
| **Target Profit (money)** | Целевое значение плавающей прибыли, при достижении которого закрываются все позиции. 0 — отключить контроль. |
| **Freeze Coefficient** | Коэффициент для расчёта минимального отступа, когда брокер не сообщает уровни стопов/заморозки. Используется множитель к спреду. |
| **Detailed Logging** | Включает расширенные сообщения в журнале о переносах стопов и принудительных закрытиях. |

## Рекомендации по использованию

1. Подключайте стратегию к инструменту и портфелю, по которому уже существуют или ожидаются позиции от других систем.
2. Настраивайте дистанции в пунктах исходя из шага цены инструмента.
3. Для работы необходим поток данных Level1 (котировки bid/ask и биржевые ограничения). В режиме `NewBar` дополнительно требуется поток выбранных свечей.
4. При срабатывании трейлинга или достижении цели стратегия сначала снимает активные защитные приказы, затем закрывает позицию рыночными ордерами.
5. Если трейлинг включён, а шаг равен нулю, стратегия завершит работу с сообщением об ошибке конфигурации — аналогично оригинальному эксперту.

## Отличия от версии MQL

- Вместо `PositionModify` используются стандартные защитные приказы StockSharp.
- Расстояния пересчитываются с учётом шага цены и (при наличии) уровней стопов/заморозки от брокера.
- Управление ведётся по совокупной позиции стратегии, без перебора отдельных тикетов MetaTrader.
- Для всех решений выводятся структурированные сообщения в журнал.

Стратегию можно сочетать с другими алгоритмами StockSharp, чтобы обеспечить автоматическое сопровождение позиций на любой поддерживаемой площадке.
