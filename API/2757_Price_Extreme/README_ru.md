# Стратегия Price Extreme

## Общее описание

**Price Extreme Strategy** — это перенос эксперта MetaTrader `Price_Extreme_Strategy` на высокоуровневый API StockSharp. Система строит динамический ценовой канал на основе максимальных и минимальных значений за заданное количество закрытых свечей. Как только выбранная для анализа свеча закрывается выше верхней границы или ниже нижней границы канала, формируется сигнал на пробой. Логику можно инвертировать, превратив пробой в контртрендовую сделку.

Алгоритм реагирует строго по факту закрытия свечи, что соответствует оригинальному MQL-советнику, который принимал решения на первом тике следующей свечи.

## Логика индикатора

Для построения границ канала используются стандартные индикаторы StockSharp `Highest` и `Lowest`:

- `Highest` вычисляет максимум по ценам High за последние *N* свечей.
- `Lowest` вычисляет минимум по ценам Low за последние *N* свечей.

Эти буферы повторяют поведение пользовательского индикатора `Price_Extreme_Indicator`. Длина расчёта задаётся параметром **Level Length**. Дополнительный параметр **Signal Shift** определяет, какую закрытую свечу брать в качестве опорной при проверке пробоя. Значение `1` означает «использовать только что закрытую свечу», более высокие значения позволяют сместить точку входа.

## Правила торговли

1. На каждой завершённой свече пересчитать верхнюю и нижнюю границы канала.
2. Получить свечу с нужным смещением из внутреннего буфера истории.
3. Рассчитать намерения:
   - **Пробой вверх** — цена закрытия свечи выше верхней границы.
   - **Пробой вниз** — цена закрытия свечи ниже нижней границы.
4. При активном флаге **Reverse Signals** сигналы меняются местами (пробой вверх → продажа, пробой вниз → покупка).
5. Перед отправкой заявки проверить разрешения **Enable Long** и **Enable Short**.
6. Перед открытием новой позиции закрыть противоположное направление, чтобы стратегия работала только с одной чистой позицией.

## Управление рисками

- Параметры **Stop Loss** и **Take Profit** задаются в шагах цены (`Security.PriceStep`). Значение `0` отключает соответствующий уровень.
- Целевые цены пересчитываются при каждом изменении размера позиции.
- Если диапазон завершённой свечи пересекает защитные уровни, позиция закрывается рыночной заявкой, а целевые значения очищаются.
- В методе `OnStarted` вызывается `StartProtection()`, активируя встроенные механизмы защиты StockSharp.

## Параметры

| Параметр | Описание | Значение по умолчанию | Группа |
|----------|----------|-----------------------|--------|
| `LevelLength` | Количество свечей в расчёте максимума/минимума. | 5 | Indicator |
| `SignalShift` | Какая закрытая свеча участвует в проверке пробоя (1 = последняя). | 1 | Indicator |
| `EnableLong` | Разрешить сделки на покупку. | `true` | Trading |
| `EnableShort` | Разрешить сделки на продажу. | `true` | Trading |
| `ReverseSignals` | Инверсия реакции на пробой. | `false` | Trading |
| `OrderVolume` | Объём рыночных заявок. | 1 | Trading |
| `StopLossPoints` | Размер стоп-лосса в шагах цены. | 0 | Risk |
| `TakeProfitPoints` | Размер тейк-профита в шагах цены. | 0 | Risk |
| `CandleType` | Таймфрейм свечей. | 5 минут | Data |

Все параметры оформлены через `StrategyParam<T>` и снабжены метаданными для отображения и оптимизации в Designer.

## Рекомендации по использованию

1. Выберите инструмент и задайте таймфрейм в параметре **Candle Type** согласно исходной конфигурации в MetaTrader.
2. Настройте **Level Length**, чтобы расширить или сузить канал Price Extreme.
3. Используйте **Signal Shift** для смещения точки входа или подтверждения сигнала.
4. Включите нужные направления (**Enable Long**, **Enable Short**) и при необходимости активируйте **Reverse Signals**.
5. Установите **Order Volume**, **Stop Loss** и **Take Profit** под свои требования к риску (значения в шагах цены).
6. Запустите стратегию. При наличии области графика автоматически выводятся свечи, индикаторные линии и собственные сделки.

## Дополнительные замечания

- Стратегия всегда поддерживает только одну чистую позицию, повторяя поведение MQL-версии, которая закрывала противоположные позиции перед открытием новых.
- Стопы и цели проверяются на закрытии свечи, что максимально приближает модель к реальным защитным заявкам оригинального эксперта.
- Python-реализация и соответствующая папка не создавались по требованию.
