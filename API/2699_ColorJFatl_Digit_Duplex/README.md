# Color JFATL Digit Duplex Strategy

## Overview
The Color JFATL Digit Duplex strategy is a dual-module system converted from the MetaTrader 5 expert advisor `Exp_ColorJFatl_Digit_Duplex`. It operates two independent signal streams based on the Color Jurik Fast Adaptive Trend Line (JFATL) indicator. The long module seeks bullish transitions in the indicator colour map, while the short module reacts to bearish transitions. Each side has its own smoothing parameters, price source, rounding precision, bar shift, and protective offsets.

The StockSharp implementation uses the high-level API with candle subscriptions and a dedicated indicator class that reproduces the FATL kernel weights and Jurik smoothing. The indicator outputs the rounded JFATL value together with the current and previous colour codes required for signal detection.

## Indicator Logic
1. **FATL convolution** – the last 39 prices (selected by the applied price option) are weighted with the original FATL coefficients to produce a filtered series.
2. **Jurik smoothing** – the FATL output is passed through a Jurik Moving Average (JMA). The phase parameter is emulated by applying a differential adjustment that shifts the smoothed value forward or backward.
3. **Digit rounding** – the result is rounded to the specified number of digits to mimic the “digitized” output of the original indicator.
4. **Colour assignment** – the colour buffer is set to 2 when the current value rises, 0 when it falls, and otherwise inherits the previous colour. A configurable `SignalBar` parameter selects which historical bar to inspect, together with its preceding bar.

The indicator returns a complex value containing the rounded JFATL reading, the colour at `SignalBar`, the previous colour, and the signal bar close time. Strategy handlers use this information to identify state transitions exactly as in the MetaTrader code.

## Trading Rules
- **Long module**
  - Opens a long position when the colour at `SignalBar` turns to 2 while the previous colour was not 2 and no long exposure is present.
  - Closes an existing long position when the colour at `SignalBar` becomes 0.
- **Short module**
  - Opens a short position when the colour at `SignalBar` turns to 0 while the previous colour was above 0 and no short exposure is present.
  - Closes an existing short position when the colour at `SignalBar` becomes 2.
- **Position handling** – orders are sized to flatten the opposite exposure before opening a new trade on the other side. `ClosePosition()` is used for exits so the strategy maintains a single net position at any time.

## Risk Management
Each module has individual stop-loss and take-profit distances expressed in price steps. When a new position is opened the strategy records the entry price and calculates the protective levels using the current security `PriceStep`. On every indicator update the corresponding candle high/low is tested against the stored levels:

- For long trades the strategy closes the position if the candle low reaches the stop price or the candle high reaches the take-profit price.
- For short trades the logic is mirrored using candle high for the stop and candle low for the take profit.

Disabling the stop or take by setting the distance to zero leaves the trade unmanaged until the indicator issues an exit signal.

## Parameters
| Group | Parameter | Description |
| --- | --- | --- |
| General | `LongCandleType` | Timeframe used for the long indicator subscription. |
| General | `ShortCandleType` | Timeframe used for the short indicator subscription. |
| Indicator (Long) | `LongJmaLength` | Jurik moving average length for the long module. |
| Indicator (Long) | `LongJmaPhase` | Phase adjustment applied to the long JMA output (range −100…100). |
| Indicator (Long) | `LongAppliedPrice` | Applied price source used in the FATL convolution. |
| Indicator (Long) | `LongDigit` | Number of digits used to round the indicator value. |
| Indicator (Long) | `LongSignalBar` | Historical bar offset inspected for signals (0 = current closed bar). |
| Risk (Long) | `LongStopLossPoints` | Stop-loss distance for longs measured in price steps. |
| Risk (Long) | `LongTakeProfitPoints` | Take-profit distance for longs measured in price steps. |
| Trading (Long) | `EnableLongOpen` | Enables or disables new long entries. |
| Trading (Long) | `EnableLongClose` | Enables or disables long exits generated by the indicator. |
| Indicator (Short) | `ShortJmaLength` | Jurik moving average length for the short module. |
| Indicator (Short) | `ShortJmaPhase` | Phase adjustment applied to the short JMA output. |
| Indicator (Short) | `ShortAppliedPrice` | Applied price source for the short indicator. |
| Indicator (Short) | `ShortDigit` | Number of digits used to round the short indicator value. |
| Indicator (Short) | `ShortSignalBar` | Historical bar offset inspected for short signals. |
| Risk (Short) | `ShortStopLossPoints` | Stop-loss distance for shorts measured in price steps. |
| Risk (Short) | `ShortTakeProfitPoints` | Take-profit distance for shorts measured in price steps. |
| Trading (Short) | `EnableShortOpen` | Enables or disables new short entries. |
| Trading (Short) | `EnableShortClose` | Enables or disables short exits generated by the indicator. |

## Usage Notes
1. Assign appropriate candle types for the long and short modules. They can point to different timeframes if desired.
2. Configure the applied price and rounding digits to match the instrument characteristics from the original Expert Advisor.
3. The `SignalBar` parameter controls how many closed candles back the signal is validated. Set it to 1 to replicate the MT5 default (previous completed candle).
4. Ensure the strategy `Volume` property reflects the desired trade size. When reversing positions the strategy automatically adds the magnitude of the existing exposure so the net position flips correctly.
5. Stops and targets rely on the security `PriceStep`. For instruments without a defined tick size the offsets default to raw numeric steps.

## Conversion Notes
- The Jurik phase parameter in StockSharp is emulated by applying a differential lead/lag adjustment because the packaged `JurikMovingAverage` does not expose a direct phase property. This preserves the behaviour of the original expert, including aggressive or delayed responses.
- The strategy uses a single net position model. The MetaTrader version could run multiple orders per direction; in StockSharp the logic consolidates them into one long or short exposure at a time.
- Protective levels are evaluated on each indicator candle close rather than on every tick. This matches the signal frequency of the MT5 expert and keeps the implementation within the high-level API guidelines.

## Files
- `CS/ColorJfatlDigitDuplexStrategy.cs` – strategy implementation with the custom indicator.
- `README.md` / `README_cn.md` / `README_ru.md` – documentation in English, Chinese, and Russian.
