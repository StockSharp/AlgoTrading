# Стратегия Color JFATL Digit Duplex

## Обзор
Color JFATL Digit Duplex — это конвертация эксперта MetaTrader 5 `Exp_ColorJFatl_Digit_Duplex` на платформу StockSharp. Стратегия состоит из двух независимых модулей: первый обслуживает длинные позиции, второй — короткие. Оба модуля используют индикатор Color Jurik Fast Adaptive Trend Line (JFATL), который окрашивает линию в зависимости от направления локального тренда. Каждый блок имеет собственные параметры сглаживания, источник цены, глубину округления, сдвиг сигнальной свечи и отступы стопов/тейков.

В реализации StockSharp применяется высокоуровневый API: свечи запрашиваются через `SubscribeCandles`, а логика индикатора вынесена в отдельный класс. Индикатор воспроизводит исходные коэффициенты FATL, выполняет сглаживание Jurik Moving Average, округляет результат и возвращает цвет текущей и предыдущей свечей для точного определения сигналов, как в оригинальном коде MQL5.

## Логика индикатора
1. **FATL-фильтр** — последние 39 значений (в соответствии с выбранным типом цены) умножаются на исходные веса фильтра FATL, формируя сглаженный ряд.
2. **Сглаживание Jurik** — полученный ряд проходит через Jurik Moving Average. Параметр Phase эмулируется дифференциальной поправкой, которая смещает результат вперёд или назад во времени.
3. **Округление** — значение приводится к заданному количеству знаков (Digit), что соответствует «оцифрованному» выходу индикатора в MetaTrader.
4. **Определение цвета** — если текущее значение больше предыдущего, присваивается цвет 2 (бычий); если меньше — цвет 0 (медвежий); при равенстве используется прошлый цвет. Параметр `SignalBar` указывает, какую из завершённых свечей анализировать вместе с предшествующей ей свечой.

Индикатор возвращает комплексное значение: округлённый JFATL, текущий цвет, предыдущий цвет и время закрытия сигнальной свечи. Стратегия использует эти данные для генерации торговых команд.

## Правила торговли
- **Длинный модуль**
  - Открывает покупку, когда цвет на `SignalBar` изменяется на 2, а предыдущий цвет был отличен от 2 и текущая позиция не положительная.
  - Закрывает длинную позицию, когда цвет на `SignalBar` становится 0.
- **Короткий модуль**
  - Открывает продажу, когда цвет на `SignalBar` меняется на 0, предыдущий цвет был > 0 и текущая позиция не отрицательная.
  - Закрывает короткую позицию, когда цвет на `SignalBar` принимает значение 2.
- **Управление позицией** — при открытии противоположной позиции стратегия добавляет величину текущего объёма, чтобы полностью закрыть прежнее направление. Для выхода используется `ClosePosition()`, поэтому одновременно поддерживается только одна чистая позиция.

## Управление рисками
Для длинной и короткой частей задаются собственные стоп-лоссы и тейк-профиты в шагах цены. После открытия сделки фиксируется цена входа, и на её основе рассчитываются уровни защиты с учётом `Security.PriceStep`. На каждом завершении свечи, поступающей от индикатора, выполняется проверка:

- Для длинных позиций при пробитии минимумом стоп-уровня или максимумом тейк-уровня позиция закрывается.
- Для коротких позиций условия зеркальны: максимум тестирует стоп, минимум — тейк.

Если расстояние равно нулю, соответствующая защита отключена, и выход осуществляется только по сигналу индикатора.

## Параметры
| Группа | Параметр | Описание |
| --- | --- | --- |
| Общие | `LongCandleType` | Тип свечей/таймфрейм для длинного индикатора. |
| Общие | `ShortCandleType` | Тип свечей для короткого индикатора. |
| Индикатор (Long) | `LongJmaLength` | Длина Jurik Moving Average для длинного модуля. |
| Индикатор (Long) | `LongJmaPhase` | Фазовый сдвиг Jurik (диапазон −100…100). |
| Индикатор (Long) | `LongAppliedPrice` | Источник цен, используемый в фильтре FATL. |
| Индикатор (Long) | `LongDigit` | Количество знаков при округлении значения индикатора. |
| Индикатор (Long) | `LongSignalBar` | Номер завершённой свечи, по которой анализируется сигнал. |
| Риск (Long) | `LongStopLossPoints` | Стоп-лосс в шагах цены для длинных позиций. |
| Риск (Long) | `LongTakeProfitPoints` | Тейк-профит в шагах цены для длинных позиций. |
| Торговля (Long) | `EnableLongOpen` | Разрешение на открытие новых длинных позиций. |
| Торговля (Long) | `EnableLongClose` | Разрешение на закрытие длинных позиций по сигналу. |
| Индикатор (Short) | `ShortJmaLength` | Длина Jurik Moving Average для короткого модуля. |
| Индикатор (Short) | `ShortJmaPhase` | Фазовый сдвиг Jurik для короткого модуля. |
| Индикатор (Short) | `ShortAppliedPrice` | Источник цен для короткого индикатора. |
| Индикатор (Short) | `ShortDigit` | Количество знаков округления для короткого индикатора. |
| Индикатор (Short) | `ShortSignalBar` | Номер свечи для анализа коротких сигналов. |
| Риск (Short) | `ShortStopLossPoints` | Стоп-лосс в шагах цены для коротких позиций. |
| Риск (Short) | `ShortTakeProfitPoints` | Тейк-профит в шагах цены для коротких позиций. |
| Торговля (Short) | `EnableShortOpen` | Разрешение на открытие новых коротких позиций. |
| Торговля (Short) | `EnableShortClose` | Разрешение на закрытие коротких позиций по сигналу. |

## Рекомендации по использованию
1. Настройте подходящие таймфреймы для каждого модуля; при необходимости можно использовать разные интервалы.
2. Подберите тип цены и степень округления под характеристики инструмента и параметры оригинального советника.
3. `SignalBar` определяет, сколько закрытых свечей назад ищется сигнал. Значение 1 соответствует стандартной логике MT5 (предыдущая завершённая свеча).
4. Проверьте свойство `Volume` у стратегии — оно определяет торговый объём. При развороте позиции стратегия автоматически добавляет текущий объём для полного закрытия противоположной стороны.
5. Стопы и тейки рассчитываются через `PriceStep`. Если шаг цены неизвестен, используется прямой числовой отступ.

## Особенности конверсии
- Поскольку библиотека StockSharp не предоставляет явного свойства Phase у JurikMovingAverage, фазовый сдвиг реализован через дифференциальную поправку, что сохраняет характер реагирования, знакомый по MQL5.
- В отличие от оригинала, здесь используется единая нетто-позиция вместо множества отдельных ордеров. Это лучше сочетается с моделью портфеля StockSharp.
- Контроль стопов и тейков выполняется на закрытии свечей индикаторного таймфрейма. Такой подход соответствует требованиям высокоуровневого API и совпадает с частотой сигналов исходной стратегии.

## Состав репозитория
- `CS/ColorJfatlDigitDuplexStrategy.cs` — код стратегии и индикатора.
- `README.md` / `README_cn.md` / `README_ru.md` — документация на английском, китайском и русском языках.
