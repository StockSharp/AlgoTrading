# Стратегия Pinball Machine

## Обзор
Стратегия представляет собой прямую конвертацию советника MetaTrader 4 `Pinball_machine.mq4` в среду StockSharp. В исходном
советнике на каждом тике генерировались случайные числа и при совпадении пары значений открывалась рыночная позиция. В версии
для StockSharp логика сохранена: на каждой закрывшейся свече выбранного таймфрейма выполняются две серии случайных бросков, и при
совпадении чисел стратегия открывает длинную или короткую позицию. Дистанции стоп-лосса и тейк-профита также выбираются случайным
образом при каждом проходе, что сохраняет “пинбольный” характер торговли.

## Логика работы
- Подписаться на свечи типа `CandleType` и ждать их завершения.
- Для каждой закрывшейся свечи сгенерировать четыре равномерно распределённых целых числа в диапазоне `[0, RandomMaxValue]`. Первая
  пара относится к потенциальной покупке, вторая — к потенциальной продаже.
- Дополнительно получить два случайных значения в пределах `MinStopLossPoints`/`MaxStopLossPoints` и `MinTakeProfitPoints`/
  `MaxTakeProfitPoints`, определяющие расстояние до защитных ордеров (в шагах цены). Эти расстояния используются обеими сторонами
  одновременно.
- Если первое и второе значения совпали — отправить рыночную заявку на покупку объёмом `TradeVolume`. Если совпали третье и четвёртое
  значения — отправить рыночную заявку на продажу тем же объёмом. Оба условия могут выполниться в рамках одной свечи, как и в MQL-версии.
- При наличии положительных защитных расстояний немедленно повесить тейк-профит и стоп-лосс. Значения интерпретируются как множители
  `PriceStep`, аналогично тому, как оригинал умножал на `Point`.

## Управление ордерами и рисками
- При запуске вызывается `StartProtection()`, чтобы StockSharp автоматически сопровождал защитные заявки.
- После открытия позиции вычисляется результирующий размер позиции (`Position ± TradeVolume`), и именно он передаётся в методы
  `SetStopLoss` и `SetTakeProfit`, что позволяет объединять защитные ордера даже при одновременных сделках.
- Если минимальные или максимальные значения дистанций равны нулю либо отрицательны, соответствующие защитные ордера в текущем цикле
  не выставляются.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Объём рыночного ордера для каждого случайного входа. |
| `CandleType` | Тип свечей, по закрытию которых выполняются случайные броски. Короткие интервалы имитируют тиковый режим исходного советника. |
| `RandomMaxValue` | Верхняя граница (включительно) для случайных чисел. Чем больше значение, тем реже совпадения и тем ниже частота сделок. |
| `MinStopLossPoints` | Нижняя граница дистанции стоп-лосса (в шагах цены). |
| `MaxStopLossPoints` | Верхняя граница дистанции стоп-лосса. |
| `MinTakeProfitPoints` | Нижняя граница дистанции тейк-профита. |
| `MaxTakeProfitPoints` | Верхняя граница дистанции тейк-профита. |
| `RandomSeed` | Зерно генератора псевдослучайных чисел. Ноль — инициализация по текущему времени, любое другое значение делает последовательность повторяемой. |

## Особенности реализации
- Исходный советник реагировал на каждый тик, поэтому в StockSharp используется закрытие свечей — так работает высокоуровневый API. Выбор очень короткого таймфрейма (секундные или тиковые свечи) позволяет приблизиться к оригинальному темпу.
- Значения стоп-лосса и тейк-профита генерируются один раз на проход и применяются одновременно для покупок и продаж — как в MQL-версии.
- Убедитесь, что для выбранного инструмента задан корректный `PriceStep`, иначе дистанции, выраженные в пунктах, потребуют ручной корректировки.
