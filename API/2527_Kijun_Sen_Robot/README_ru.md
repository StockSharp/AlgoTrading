# Стратегия Kijun Sen Robot

## Общее описание
**Kijun Sen Robot** — это перенос советника MetaTrader 5 «Kijun Sen Robot» на высокоуровневый API StockSharp. По умолчанию стратегия работает на 30‑минутных свечах и ищет пробой цены через линию Kijun индикатора Ichimoku, подтверждая импульс 20‑периодной линейно-взвешенной скользящей средней (LWMA). Стратегия сохраняет идею оригинала: торговать только в активные часы и постоянно защищать позицию с помощью стоп-лосса, перевода в безубыток и трейлинг-стопа.

## Используемые данные и индикаторы
- **Ichimoku** с периодами Tenkan/Kijun/Senkou Span B = 6/12/24.
- **Линейно-взвешенная скользящая средняя** длиной 20 баров — фильтр направления и расстояния до Kijun.
- **Свечной поток** (по умолчанию 30 минут), задаётся параметром `CandleType`.

## Логика торговли
### Вход в длинную позицию
1. Текущая свеча пробивает Kijun снизу вверх: открытие ниже линии, закрытие выше либо касание линии внутри бара при условии, что предыдущая свеча закрылась ниже.
2. Значение Kijun не падает относительно уровня двумя барами ранее.
3. LWMA находится минимум на `MaFilterPips` пунктов ниже Kijun (значение автоматически переводится в цены).
4. Наклон LWMA положительный: текущее значение выше предыдущего.
5. Время находится в пределах `[TradingStartHour, TradingEndHour)` (по умолчанию 07:00–19:00 по времени площадки).

Если условия выполнены и нет открытого лонга (Position ≤ 0), отправляется рыночная покупка. При наличии шорта он закрывается тем же ордером. Цена входа соответствует закрытию свечи.

### Вход в короткую позицию
1. Свеча пробивает Kijun сверху вниз (зеркальное условие).
2. Kijun не растёт относительно значения двумя барами ранее.
3. LWMA минимум на `MaFilterPips` пунктов выше линии Kijun.
4. LWMA снижается (текущее значение ниже предыдущего).
5. Сигналы принимаются только в разрешённый временной интервал.

При выполнении условий и отсутствии действующего шорта (Position ≥ 0) стратегия продаёт по рынку, закрывая возможные лонги.

### Управление позицией и выходы
- **Начальный стоп-лосс** выставляется на расстоянии `StopLossPips`, переведённом в цену через `PriceStep`. Это прямой аналог стопа в исходном советнике.
- **Перевод в безубыток** срабатывает, когда прибыль достигает `BreakEvenPips`: стоп переносится на цену входа плюс/минус один пункт.
- **Трейлинг-стоп** активируется после прохождения `TrailingStopPips` пунктов прибыли и двигается только в сторону фиксации прибыли.
- **Фиксированный тейк-профит** (`TakeProfitPips`) опционален, значение 0 отключает цель.
- **Защитное закрытие по наклону LWMA**: если до перевода стопа в безубыток скользящая разворачивается против позиции, сделка закрывается немедленно.
- **Временной фильтр** запрещает новые входы вне торгового окна, но текущая позиция продолжает сопровождаться.
- **Типы ордеров** — только рыночные; сложный выбор между лимитными и рыночными заявками из MT5 упрощён из-за работы с свечами, а не тиками.

Если внутри одной свечи выполнены и условия стопа, и тейк-профита, приоритет отдаётся стоп-лоссу — консервативная оценка без внутрибара.

## Параметры
| Параметр | Значение по умолчанию | Назначение |
|----------|------------------------|------------|
| `TenkanPeriod` | 6 | Период линии Tenkan-сен. |
| `KijunPeriod` | 12 | Период линии Kijun-сен. |
| `SenkouSpanBPeriod` | 24 | Период Senkou Span B. |
| `LwmaPeriod` | 20 | Длина LWMA-фильтра. |
| `MaFilterPips` | 6 | Минимальное расстояние между Kijun и LWMA в пунктах. |
| `StopLossPips` | 50 | Размер стартового стоп-лосса. |
| `BreakEvenPips` | 9 | Прибыль для перевода стопа в безубыток. |
| `TrailingStopPips` | 10 | Шаг трейлинг-стопа. |
| `TakeProfitPips` | 120 | Фиксированный тейк-профит (0 — отключён). |
| `TradingStartHour` | 7 | Начало торгового окна (включительно). |
| `TradingEndHour` | 19 | Конец торгового окна (не включается). |
| `CandleType` | 30 минут | Тип свечей для расчётов. |

Все параметры, заданные в пунктах, автоматически переводятся в ценовые значения через `Security.PriceStep` (или `Security.MinPriceStep`). Для инструментов с точностью 3 или 5 знаков шаг умножается на 10 — аналог MT5 `digits_adjust`.

## Особенности реализации
- Переменные `_pendingLongLevel` и `_pendingShortLevel` воспроизводят механику `longcross/shortcross`, не позволяя повторно входить без нового пробоя.
- Проверки «последнего бид/аск» заменены на условия по свечам (Open/High/Low/Close), что делает поведение стабильным в тестере.
- Стопы сопровождаются внутри стратегии: используется `ClosePosition()`, а не модификация заявок на сервере.
- Метод `ConvertPips` выполняет перевод пунктов в цену, учитывая корректировку для пятизначных/трёхзначных инструментов.
- Индикаторы подключаются через `SubscribeCandles().BindEx(...)`, на графике отображаются свечи, Ichimoku, LWMA и собственные сделки.

## Рекомендации по применению
1. Выберите инструмент с доступными 30‑минутными свечами (при необходимости измените `CandleType`).
2. До старта задайте нужный объём сделки в свойстве `Volume`.
3. Подстройте параметры в пунктах под волатильность конкретного инструмента или используйте найденные оптимизации.
4. Запускайте стратегию в бэктестере или в реальном времени — управление позициями и расписание выполняется автоматически.
5. Следите за журналом или графиком, чтобы видеть срабатывание перевода в безубыток и трейлинга. Все комментарии в коде даны на английском языке.

Python-версия сознательно не создавалась, в каталоге присутствует только реализация на C#.
