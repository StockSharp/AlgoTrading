# Стратегия Envelopes EA

## Обзор
Стратегия повторяет советник MetaTrader 4 «EnvelopesEA». На основной серии свечей рассчитывается экспоненциальная скользящая средняя (EMA) и строится ценовой коридор. При выходе цены далеко за границы коридора открывается встречная сделка, а при возврате внутрь позиция закрывается. Оригинальный эксперт тестировался на EUR/USD в 2019 году; порт на StockSharp полностью сохраняет исходную логику и предоставляет все ключевые параметры для оптимизации.

## Логика торговли
1. Вычислить EMA длиной `EnvelopePeriod` на выбранных свечах.
2. Построить верхнюю и нижнюю границы, умножив EMA на `UpperDeviationPercent` и `LowerDeviationPercent`.
3. Добавить дополнительный буфер входа `EntryOffsetPoints`, умноженный на шаг цены инструмента.
4. При отсутствии позиции:
   - Открыть покупку, если цена закрытия опускается ниже нижней границы минус буфер.
   - Открыть продажу, если цена закрытия поднимается выше верхней границы плюс буфер.
5. При наличии позиции:
   - Закрыть покупки, когда цена закрытия уходит выше верхней границы.
   - Закрыть продажи, когда цена закрытия уходит ниже нижней границы.

В рынке находится не более одной позиции, все сделки выполняются рыночными ордерами.

## Управление капиталом
Размер заявки задаётся параметром `Volume` в лотах. Алгоритм не содержит мартингейла или наращивания позиции, что соответствует актуальной версии MQ4, где дополнительные блоки по умолчанию отключены.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `Volume` | Объём ордера в лотах. | 0.2 |
| `EnvelopePeriod` | Длина EMA, формирующей основу коридора. | 50 |
| `UpperDeviationPercent` | Процентное отклонение верхней границы от EMA. | 0.5 |
| `LowerDeviationPercent` | Процентное отклонение нижней границы от EMA. | 0.5 |
| `EntryOffsetPoints` | Дополнительное смещение в шагах цены для подтверждения выхода за границу. | 100 |
| `CandleType` | Таймфрейм свечей для расчётов. | 30 минут |

Все числовые параметры, кроме `CandleType`, отмечены как оптимизируемые, что облегчает повторение оригинальных прогонов.

## Примечания
- В отличие от ранних вариантов с SMA, здесь используется EMA, что соответствует последнему MQ4 и ускоряет реакцию на резкие движения.
- Буфер входа домножается на `PriceStep` инструмента. Убедитесь, что в описании бумаги задан корректный шаг; иначе применяется запасное значение `0.0001`.
- Визуализация на графике содержит свечи, EMA-коридор и сделки стратегии, что позволяет быстро сверить сигналы с работой советника.
