# Стратегия «Candle Shadow Percent»

## Обзор
**Candle Shadow Percent** — портированная из MetaTrader экспертная система *Candle shadow percent*. Стратегия отслеживает свечи, у которых верхняя или нижняя тень превышает настраиваемый процент от тела. Высокая верхняя тень приводит к открытию короткой позиции, длинная нижняя тень — к длинной. Логика входов и управление рисками повторяют оригинальный советник.

## Особенности конверсии
* В исходном решении использовался внешний индикатор. В версии для StockSharp пропорции тени и тела рассчитываются напрямую по завершённым свечам, поэтому дополнительные индикаторы не требуются.
* Значения «пунктов» вычисляются из `Security.PriceStep`. При необходимости подберите `StopLossPips`, `TakeProfitPips` и `MinBodyPips` под шаг цены инструмента.
* Размер позиции формируется аналогично `CMoneyFixedMargin`: доля капитала (`RiskPercent`) делится на расстояние до стоп-лосса.

## Фильтр свечей
Свеча участвует в анализе, если:
1. Абсолютная величина тела не менее `MinBodyPips * Security.PriceStep`.
2. Соответствующая тень положительна.
3. Выполняется условие по проценту тени:
   * **Верхняя тень (шорт)**: `(High − max(Open, Close)) / Body * 100` сравнивается с `TopShadowPercent`. При `TopShadowIsMinimum = true` доля должна быть не меньше порога, иначе — не больше.
   * **Нижняя тень (лонг)**: `(min(Open, Close) − Low) / Body * 100` сравнивается с `LowerShadowPercent` по аналогичному правилу `LowerShadowIsMinimum`.
4. Если обе тени удовлетворяют требованиям, выбирается направление с большим относительным размером тени — это исключает двойное срабатывание.

## Правила входа
* **Шорт** — при сигнале верхней тени и отсутствии короткой позиции. При наличии длинной позиции выполняется разворот и сразу выставляются уровни защиты.
* **Лонг** — при сигнале нижней тени и отсутствии длинной позиции. Активная короткая позиция закрывается перед открытием новой длинной.

## Правила выхода
* **Стоп-лосс**: задаётся на расстоянии `StopLossPips * Security.PriceStep` от цены входа (ниже для лонга, выше для шорта).
* **Тейк-профит**: располагается на расстоянии `TakeProfitPips * Security.PriceStep`. Значение `0` отключает цель и оставляет только стоп-лосс или разворот по противоположному сигналу.
* Контроль осуществляется на закрытых свечах. Если диапазон свечи достигает стопа или цели, позиция ликвидируется при следующей обработке.

## Управление размером позиции
* Риск на сделку равен `Portfolio.CurrentValue * (RiskPercent / 100)`. Если данные портфеля недоступны, используется стандартный объём стратегии.
* Объём = риск / расстояние до стопа. При развороте к рассчитанному объёму добавляется величина текущей позиции, что полностью повторяет поведение оригинального советника.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип/таймфрейм свечей, по которым ведётся расчёт. |
| `StopLossPips` | Расстояние стоп-лосса в пунктах/тиках. Значение > 0. |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах/тиках. `0` — цель отключена. |
| `RiskPercent` | Доля капитала, рискуемая в одной сделке. |
| `MinBodyPips` | Минимальный размер тела свечи для оценки теней. |
| `EnableTopShadow` | Включить сигналы по верхней тени (шорт). |
| `TopShadowPercent` | Порог процента верхней тени относительно тела. |
| `TopShadowIsMinimum` | Интерпретация порога: минимум (`true`) или максимум (`false`). |
| `EnableLowerShadow` | Включить сигналы по нижней тени (лонг). |
| `LowerShadowPercent` | Порог процента нижней тени. |
| `LowerShadowIsMinimum` | Интерпретация порога нижней тени. |

## Рекомендации по использованию
* Для начала используйте 5-минутные свечи, как в оригинальном советнике, и подберите параметры под ваш инструмент.
* Увеличивайте `MinBodyPips`, если возникает слишком много ложных сигналов; уменьшайте, если нужно больше входов.
* При необходимости расширяйте стратегию фильтрами тренда — дополнительные индикаторы можно привязать в методе `OnStarted`.
* Перед торговлей на реальном счёте протестируйте настройки на демо, чтобы проверить корректность шага цены и управления рисками.
