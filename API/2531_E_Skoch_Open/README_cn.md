# E-Skoch-Open 策略（StockSharp 版本）

## 概览
**E-Skoch-Open** 策略复刻了原始的 MetaTrader 5 智能交易顾问，其核心是一个三根 K 线收盘价的形态过滤。该移植版本在每根完成的 K 线结束后运行，检测最近收盘价的反转信号，并在条件满足时开仓。风险控制来自以调整后的点值（相当于外汇中的“点”/pip）表示的固定止损和止盈，以及一个基于账户权益增长的总平仓触发器。仓位规模采用马丁格尔方式：亏损后下一笔订单乘以 1.6，而盈利后恢复为初始手数。

## 交易流程
1. 使用 `CandleType` 参数指定的时间框架（默认 1 小时）。
2. 等待至少三根完成的 K 线形成。
3. **做多条件**：如果 `Close[n-3] > Close[n-2]` 且 `Close[n-1] < Close[n-2]`，并且允许做多，则开多单。
4. **做空条件**：如果 `Close[n-3] > Close[n-2]` 且 `Close[n-2] < Close[n-1]`，并且允许做空，则开空单。
5. 当 `CloseOnOppositeSignal` 为真时，出现相反信号会立即平掉现有仓位，并且本根 K 线不再开新单。
6. 每次开仓都会根据当前收盘价和参数设置计算出固定的止损、止盈价格。只要后续完成的 K 线最高/最低价触及其中之一，就会执行平仓。
7. 策略持续监控组合权益。与上次空仓时相比，当权益增长超过 `TargetProfitPercent` 百分比时，会立即平掉所有仓位。
8. 当一次交易以亏损结束时，下一次下单的手数乘以 1.6；若盈利，则重置为初始手数。下单量会根据品种的 `VolumeStep`、`VolumeMin`、`VolumeMax` 自动进行归一化。

## 参数说明
| 参数 | 说明 |
| --- | --- |
| `CandleType` | 用于识别形态的时间框架，可使用 StockSharp 支持的任意 K 线类型。 |
| `InitialOrderVolume` | 第一笔订单的基础手数（默认 0.01）。 |
| `StopLossPoints` | 止损距离，以调整后的点值表示；当价格精度为 5 位或 3 位小数时点值为 `PriceStep * 10`，其他情况为 `PriceStep`。 |
| `TakeProfitPoints` | 止盈距离，采用与止损相同的点值计算。 |
| `EnableBuySignals` / `EnableSellSignals` | 分别控制是否允许做多或做空。 |
| `MaxBuyTrades` / `MaxSellTrades` | 每个方向允许的最大连续交易次数，设置为 `-1` 则不限制。本移植默认每个方向仅持有一个净仓位。 |
| `TargetProfitPercent` | 达到该权益增幅百分比后立即平掉所有仓位（默认 1.2%）。 |
| `CloseOnOppositeSignal` | 若启用，相反信号会先将仓位平掉，然后再等待新的机会。 |

## 风险与执行注意事项
- 止损/止盈是依据完成的 K 线最高/最低价模拟的；在实盘中，服务器端委托的执行顺序可能与 MetaTrader 不同。
- 1.6 的马丁格尔系数会在回撤中迅速放大仓位，请确保账户保证金和品种 `VolumeMax` 许可足够的资金使用率。
- 基于权益的平仓逻辑依赖 `Portfolio.CurrentValue`，需要交易账户提供实时权益数据。

## 使用建议
- 根据原策略的运行周期调整 `CandleType`。
- `StopLossPoints` 和 `TakeProfitPoints` 需要结合品种波动率调整，点值换算由策略自动完成。
- 若经纪商不允许对冲或风险偏好较低，可关闭单方向交易。
- 长时间回测或实盘前，请评估权益止盈和马丁格尔组合带来的最大头寸规模。
