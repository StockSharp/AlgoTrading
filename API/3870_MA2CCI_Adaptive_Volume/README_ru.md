# Стратегия MA2CCI Adaptive Volume

## Обзор
MA2CCI — это точный порт советника MetaTrader 4 «MA2CCI.mq4». Стратегия использует пересечение двух простых скользящих средних (быстрой и медленной) и подтверждает сигнал пересечением индекса товарного канала (CCI) через нулевую линию. Каждая подтверждённая комбинация открывает единственную рыночную позицию и сразу выставляет защитный стоп по волатильности, основанный на индикаторе Average True Range (ATR). Размер позиции рассчитывается по той же схеме, что и в оригинале: объём масштабируется в зависимости от капитала и снижается после серии убыточных сделок.

## Индикаторы и данные
- **Быстрая и медленная SMA** на выбранном таймфрейме фиксируют смену тенденции.
- **CCI** на том же ряду цен подтверждает импульс через пересечение нулевой отметки.
- **ATR** измеряет текущую волатильность и задаёт расстояние до стоп-лосса.
- **Свечи** выбранного таймфрейма (по умолчанию 15 минут) служат источником данных для всех индикаторов.

## Торговые правила
- **Вход в лонг**: быстрая SMA пересекает медленную снизу вверх, CCI переходит из отрицательной области в положительную, активных позиций нет. Оформляется рыночная покупка и ставится стоп `close − ATR × AtrMultiplier`.
- **Вход в шорт**: быстрая SMA пересекает медленную сверху вниз, CCI опускается из положительной зоны ниже нуля, открытых позиций нет. Отправляется рыночная продажа со стопом `close + ATR × AtrMultiplier`.
- **Выход из лонга**: если быстрая SMA снова опускается ниже медленной, длинная позиция закрывается по рынку, а защитный стоп снимается.
- **Выход из шорта**: если быстрая SMA поднимается выше медленной, короткая позиция закрывается по рынку, стоп снимается.
- **Стоп-лосс**: при каждом новом входе выставляется свежий условный ордер стоп-лосс. После смены или закрытия позиции стоп автоматически отменяется.

## Управление объёмом
- Базовый лот задаётся параметром `BaseVolume` (по умолчанию 0.1 лота).
- Если `RiskFraction` больше нуля, дополнительно рассчитывается объём `equity × RiskFraction / 1000`, что повторяет формулу `AccountFreeMargin` из MQL4. Используется максимум между базовым и рассчитанным значением.
- После двух и более убыточных сделок подряд объём уменьшается на `volume × losses / DecreaseFactor`, что соответствует параметру `DcF` в оригинале.
- Итоговый объём нормируется на шаг `VolumeStep` инструмента.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `FastMaPeriod` | 4 | Период быстрой SMA. |
| `SlowMaPeriod` | 8 | Период медленной SMA. |
| `CciPeriod` | 4 | Период расчёта CCI. |
| `AtrPeriod` | 4 | Период ATR для вычисления стопа. |
| `AtrMultiplier` | 1.0 | Множитель, применяемый к ATR при постановке стопа. |
| `BaseVolume` | 0.1 | Минимальный размер позиции до корректировок по риску. |
| `RiskFraction` | 0.02 | Доля капитала, используемая в формуле расчёта объёма (на 1000 валютных единиц). |
| `DecreaseFactor` | 3 | Делитель, регулирующий снижение объёма после убыточных сделок. |
| `CandleType` | 15-минутные свечи | Таймфрейм для индикаторов и сигналов. |

## Примечания
- Почтовые уведомления (`SndMl`) из версии MT4 не реализованы.
- В любой момент времени открывается только одна позиция, как и в исходном коде.
- Защитные стопы пересоздаются при каждом развороте или закрытии, чтобы не оставлять «зависших» ордеров в стакане.
