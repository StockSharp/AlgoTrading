# EA Framework Layout (управление позицией)

## Обзор

Данная стратегия — порт оригинального советника MQL5 «EA框架布局». Изначально он не генерирует торговые сигналы, а управляет уже открытыми позициями: контролирует время удержания и закрывает сделки, когда условия больше не выполняются. Версия на StockSharp сохраняет тот же подход. Стратегия подписывается на одну серию свечей (по умолчанию H1), рассчитывает шесть EMA с периодами 2, 4, 6, 8, 12 и 16 и после закрытия каждой свечи решает, требуется ли закрыть позицию.

## Логика работы

1. **Отслеживание позиции.** При появлении новой позиции или смене направления внутренние счётчики обнуляются — окно управления начинается с момента последнего входа.
2. **Фильтр направления.** Пользователь может разрешить только длинные или только короткие позиции. Если текущая позиция не соответствует разрешённому направлению, она немедленно закрывается.
3. **Проверка расположения EMA.** Две последние завершённые свечи (смещения 1 и 2) должны сохранять строгий порядок шести EMA и их одинаковый наклон. Потеря упорядоченности приводит к закрытию позиции. Это прямой аналог функции `MA_Direction` из исходного фреймворка.
4. **Выход по времени.** Параметр `AutoCloseAfterXH1` задаёт, сколько завершённых часовых свечей разрешено удерживать позицию. После каждой свечи счётчик увеличивается; по достижении порога стратегия закрывает позицию рыночной заявкой.
5. **Ручные входы.** Стратегия не открывает сделки самостоятельно. Предполагается, что позиция создаётся вручную или другим модулем. Параметр `TradeInitLots` оставлен для совместимости и возможного расширения логики усреднения.

## Параметры

| Название | Описание |
| --- | --- |
| `LotAmplifier` | Множитель базового объёма. Сохранён для совместимости, сейчас не используется. |
| `TradeInitLots` | Базовый объём позиции. Значение копируется в свойство `Volume` стратегии. |
| `AutoCloseAfterXH1` | Количество завершённых часовых свечей до принудительного выхода. |
| `IsReverse` | Флаг из MQL-версии. В текущей реализации обратные сделки не выполняются, но параметр сохранён. |
| `DirectionAllow` | Разрешённое направление (`Both`, `Up`, `Down`). |
| `UsTimeLeftBound` / `UsTimeRightBound` | Границы активной сессии США (часы с десятичной частью). Пока используются только для совместимости. |
| `NonUsTimeLeftBound` / `NonUsTimeRightBound` | Границы дополнительного временного окна. |
| `CandleType` | Тип свечей, по которым вычисляются индикаторы (по умолчанию 1 час). |

## Рекомендации по использованию

* Стратегия предназначена для управления существующими сделками и не подаёт заявок на открытие.
* Для сохранения поведения оригинального советника рекомендуется использовать часовой таймфрейм. При смене периода изменится смысл параметра автоматического выхода.
* Пока индикаторы не накопят достаточно истории (две завершённые свечи), проверка упорядоченности EMA игнорируется, чтобы исключить ложные сигналы.
* Вспомогательные функции работы с торговыми сессиями (`IsInDealTime`) оставлены для возможных расширений пользователем.

## Особенности переноса

При конвертации использован высокоуровневый API StockSharp: данные поступают через `SubscribeCandles`, индикаторы подключаются через `Bind`, а закрытие выполняется функциями `BuyMarket`/`SellMarket`. Алгоритм `MA_Direction` переписан на C#, что позволяет анализировать порядок EMA без хранения больших коллекций.
