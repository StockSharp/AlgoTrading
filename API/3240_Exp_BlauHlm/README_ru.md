# Стратегия Exp Blau HLM

## Описание

**Exp Blau HLM** — порт советника MetaTrader 5 `Exp_BlauHLM.mq5` на платформу StockSharp. Алгоритм использует осциллятор Blau High-Low Momentum (HLM), сравнивающий экстремумы последних баров, сглаживает разницу каскадом XMA и поддерживает три режима работы:

- **Breakdown** — торговля пробоев нулевой линии гистограммы.
- **Twist** — поиск «скруток» в наклоне гистограммы для фиксации смены импульса.
- **CloudTwist** — анализ верхней и нижней оболочек индикатора с реакцией на их пересечения.

В порте сохранены все параметры и логика оригинала; управление размером позиции осуществляется через свойство `Volume` базовой стратегии.

## Торговые правила

1. После закрытия свечи выбранного таймфрейма рассчитывается осциллятор Blau HLM:
   - Определяется разница между текущим максимумом и максимумом `XLength - 1` баров назад, а также зеркальная разница по минимумам.
   - Отрицательные значения обнуляются, после чего формируется исходный HLM (в пунктах при наличии шага цены).
   - Значение проходит через четыре одинаковых по типу, но независимых по длине сглаживания.
2. В зависимости от выбранного режима:
   - **Breakdown** открывает покупки при положительном старом значении гистограммы и неположительном новом (возврат выше нуля) и закрывает шорты в той же ситуации. Симметрично для продаж.
   - **Twist** оценивает наклон гистограммы по трём точкам. Ускорение (рост средней точки после снижения) даёт сигнал на покупку, замедление — на продажу.
   - **CloudTwist** контролирует две сглаженные линии. Если старший верхний канал выше нижнего и на следующем баре происходит обратное пересечение, генерируются сигналы.
3. Разрешения `BuyOpen`, `SellOpen`, `BuyClose`, `SellClose` определяют открытие и закрытие позиций. Перед открытием противоположного направления активная позиция закрывается рыночной заявкой.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
| -------- | --- | --------------------- | -------- |
| `CandleType` | `DataType` | Свечи H4 | Таймфрейм, на котором строится осциллятор. |
| `SmoothingMethod` | `SmoothMethod` | `Exponential` | Тип сглаживания XMA (несовместимые варианты заменяются на EMA). |
| `XLength` | `int` | `2` | Число баров для расчёта необработанного импульса high/low. |
| `FirstLength` | `int` | `20` | Длина первого этапа сглаживания. |
| `SecondLength` | `int` | `5` | Длина второго этапа сглаживания. |
| `ThirdLength` | `int` | `3` | Длина третьего этапа сглаживания. |
| `FourthLength` | `int` | `3` | Длина финального сигнального сглаживания. |
| `Phase` | `int` | `15` | Параметр фазы для Jurik (ограничен диапазоном ±100). |
| `SignalBar` | `int` | `1` | Смещение по истории для сравнения значений индикатора. |
| `EntryMode` | `Mode` | `Twist` | Режим торговли (`Breakdown`, `Twist`, `CloudTwist`). |
| `BuyOpen` / `SellOpen` | `bool` | `true` | Разрешение на открытие длинных/коротких позиций. |
| `BuyClose` / `SellClose` | `bool` | `true` | Разрешение на закрытие длинных/коротких позиций по встречному сигналу. |

## Особенности порта

- Библиотека `SmoothAlgorithms.mqh` содержит проприетарные фильтры (JJMA, JurX, ParMA, T3, VIDYA, AMA). В StockSharp используются ближайшие аналоги; неподдерживаемые методы заменены на экспоненциальное сглаживание.
- Параметры управления капиталом (`MM`, `MarginMode`, `StopLoss`, `TakeProfit`, `Deviation`) в MT5 определяли объём и цены исполнения. В порте размер позиции задаётся через `Volume`, сделки открываются по рынку.
- Логика `SignalBar` сохранена: стратегия ведёт буфер значений индикатора и сравнивает именно исторические точки, что обеспечивает сопоставимость оптимизаций.
- Функция `StartProtection()` запускает базовую защиту. Для стоп-лоссов/тейк-профитов используйте глобальные настройки стратегии или коннектора.

## Рекомендации по использованию

1. Перед запуском задайте `Volume`, чтобы определить объём сделки.
2. На инструментах без корректного `PriceStep` осциллятор работает в абсолютных ценах — при крупном тике подберите длины сглаживания вручную.
3. Экстремальные значения `Phase` при коротких периодах делают сигналы шумными; при необходимости увеличьте длины.
4. Дополните стратегию портфельными ограничениями или внешними правилами управления риском, чтобы повторить поведение оригинальных стопов.

