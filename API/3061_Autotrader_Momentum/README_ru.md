# Стратегия Autotrader Momentum

## Обзор
**Autotrader Momentum** — это перенос советника MetaTrader 5 *Autotrader Momentum (редакция barabashkakvn)* на платформу StockSharp. Алгоритм оценивает импульс, сравнивая цену закрытия контролируемой свечи с закрытием исторической свечи. Если текущий закрытие выше выбранного эталона, открывается длинная позиция; если ниже — короткая. Сделки исполняются рыночными заявками через высокоуровневый API StockSharp, что полностью повторяет логику оригинального эксперта «по новой свече».

Как и в версии для MQL, все параметры риска задаются в пунктах (pip). Перед выставлением стоп-ордеров значения преобразуются в абсолютные ценовые смещения с учётом `PriceStep` инструмента. Для трёх- и пятизнаковых котировок применяется множитель 10, что соответствует обработке в исходном коде. На каждой завершённой свече сначала выполняется блок сопровождения позиции (трейлинг и защитные выходы), а уже затем рассматриваются новые сигналы.

## Логика торговли
1. Подписка на свечи типа `CandleType` и обработка только завершённых (`Finished`) свечей.
2. Поддержание скользящего окна закрытий размером `max(CurrentBarIndex, ComparableBarIndex) + 1`.
3. Сравнение закрытия контролируемой свечи (`CurrentBarIndex`, по умолчанию 0) со свечой-эталоном (`ComparableBarIndex`, по умолчанию 15).
4. Если закрытие контролируемой свечи выше, закрываем короткие позиции и покупаем заданный объём.
5. Если ниже — закрываем длинные позиции и продаём заданный объём.
6. После каждого входа пересчитываем среднюю цену позиции и обновляем уровни стоп-лосса, тейк-профита и трейлинг-стопа.

Поскольку StockSharp ведёт учёт совокупной позиции, при реверсе объём заявки включает как объём для закрытия текущей позиции, так и базовый объём `TradeVolume`. Это соответствует оригинальному советнику, который сначала закрывал противоположные сделки, а затем открывал новую в нужном направлении.

## Параметры
- `CandleType` – таймфрейм для анализа (по умолчанию 1 час).
- `TradeVolume` – базовый объём рыночной заявки по каждому сигналу.
- `StopLossPips` – расстояние до стоп-лосса в пунктах (0 — выключить).
- `TakeProfitPips` – расстояние до тейк-профита в пунктах (0 — выключить).
- `TrailingStopPips` – дистанция трейлинг-стопа в пунктах (0 — отключить трейлинг).
- `TrailingStepPips` – минимальное приращение цены до очередного подтягивания трейлинга; должно быть > 0 при включённом трейлинге.
- `CurrentBarIndex` – индекс анализируемой свечи (0 = последняя завершённая).
- `ComparableBarIndex` – индекс исторической свечи для сравнения.

Все значения в пунктах конвертируются в смещения цен с использованием `PriceStep`. Для трёх- и пятизнаковых инструментов применяется поправка ×10, чтобы сохранить поведение MetaTrader.

## Управление рисками
- **Фиксированные уровни:** при ненулевых `StopLossPips` и `TakeProfitPips` уровни пересчитываются относительно средневзвешенной цены входа.
- **Трейлинг:** работает только при положительных `TrailingStopPips` и `TrailingStepPips`. Стоп переносится, когда цена прошла в нужную сторону минимум `TrailingStopPips + TrailingStepPips`, что повторяет ограничение исходного советника.
- **Сброс состояния:** при полном закрытии позиции (как самим алгоритмом, так и внешне) кэшированные уровни очищаются, чтобы избежать устаревших значений.

## Особенности реализации
- Используется только высокоуровневый API StockSharp (`BuyMarket`, `SellMarket`), без собственных коллекций индикаторов.
- Закрытия хранятся в простом скользящем списке, поэтому индексы свечей можно менять во время работы стратегии.
- В случае наращивания позиции пересчитывается средневзвешенная цена входа, после чего обновляются стоп-уровни.
- Защитные выходы и трейлинг вызываются перед поиском новых сигналов на каждой свече, что предотвращает повторные входы на баре, где уже сработал выход.

## Источник
- **Файл:** `MQL/22409/Autotrader Momentum.mq5`
- **Автор:** barabashkakvn (сообщество MetaTrader)
