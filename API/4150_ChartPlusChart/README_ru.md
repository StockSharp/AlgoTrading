# Стратегия Chart Plus Chart

## Обзор
Chart Plus Chart — это утилитарная стратегия, портированная из MetaTrader-скриптов *Chart1.mq4* и *Chart2.mq4*. В исходном решении
использовалась DLL `SharedVarsDLLv2`, которая при каждом тике записывала в общую память четыре значения: последнюю цену закрытия,
количество открытых ордеров, баланс счёта и плавающий результат по первому ордеру. Остальные скрипты могли считывать эти значения
и показывать их на пользовательских панелях.

В версии для StockSharp сохранена идея обмена данными, но исключены внешние зависимости. Вместо DLL используется статический
класс-помощник `ChartPlusChartSharedStorage`, который потокобезопасно хранит числа в индексированных ячейках. Стратегия
`ChartPlusChartStrategy` сама по себе не торгует — она лишь отслеживает назначенный инструмент и портфель и обновляет общую память
актуальными статистиками.

## Публикуемые метрики
1. Подписка на свечи типа `CandleType` с обработкой только закрытых (`Finished`) свечей, чтобы использовать финальную цену закрытия.
2. Подсчёт активных ордеров стратегии с фильтрацией завершённых, отменённых и неудачных заявок, аналогично `OrdersTotal()` в MQL.
3. Получение актуальной величины счёта: преимущественно `Portfolio.CurrentValue`, либо `Portfolio.BeginValue`, если текущая оценка
   отсутствует.
4. Расчёт плавающего результата по текущей нетто-позиции через последнюю цену и среднюю цену входа.
5. Запись четырёх величин в хранилище:
   - `SetFloat(baseIndex, closePrice)`
   - `SetInt(baseIndex, activeOrders)`
   - `SetFloat(baseIndex + 1, accountValue)`
   - `SetFloat(baseIndex + 2, floatingPnL)`
6. При каждом собственном сделанном трейде обработчик вызывается повторно, поэтому изменения состояния видны без ожидания новой свечи.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | Таймфрейм 1 минута | Основной ряд свечей, который обрабатывается перед публикацией данных. |
| `ChannelIndex` | `int` | `10` | Базовый индекс в `ChartPlusChartSharedStorage`, куда сохраняются значения. |

## Отличия от оригинальных скриптов MetaTrader
- Отсутствует внешняя DLL — вся логика общей памяти реализована во внутреннем словаре `ChartPlusChartSharedStorage`.
- В MetaTrader обновление выполнялось на каждом тике. В StockSharp данные публикуются по закрытию свечи и после собственной сделки,
  что уменьшает шум от промежуточных цен и при этом сохраняет оперативность.
- MQL-версия использовала `OrderProfit()` для первого найденного ордера. StockSharp-версия рассчитывает плавающий PnL по нетто-позиции,
  что соответствует модели учёта в платформе.
- При остановке стратегии соответствующие ячейки очищаются, чтобы другие компоненты понимали, что данные больше не поддерживаются.

## Советы по использованию
- Запустите `ChartPlusChartStrategy` на нужном счёте и настройте одинаковый `ChannelIndex` у источника и потребителя, чтобы работать с
  одними и теми же ячейками.
- Внешние панели или вспомогательные стратегии могут получать данные через `ChartPlusChartSharedStorage.TryGetFloat` и
  `TryGetInt`.
- Так как стратегия не создаёт заявок, её можно безопасно запускать параллельно с основной торговой системой и использовать как
  лёгкий модуль телеметрии.
