# Стратегия Andrew's Pitchfork

Порт советника MetaTrader «Andrew's Pitchfork». В оригинале требовалось вручную наносить объект «Вилы Эндрюса», после чего робот сверял направление вил с фильтрами по моментуму, скользящим средним на старшем таймфрейме и MACD. В версии для StockSharp индикаторы сохранены, а проверка направленности вил заменена автоматическим определением тренда и полностью воссоздан блок управления сделками (ограничение количества входов, стоп-лосс, тейк-профит, перевод в безубыток и трейлинг).

## Логика работы

1. **Индикаторы**
   - Две *Linear Weighted Moving Average* по типичной цене выбранного таймфрейма.
   - Осциллятор *Momentum* на том же таймфрейме, анализируется абсолютное отклонение от уровня 100.
   - Классический *MACD (12, 26, 9)* со строкой сигнала.
2. **Условия входа**
   - **Покупка** выполняется, когда быстрая LWMA выше медленной, хотя бы одно из трёх последних значений моментума превышает `MomentumBuyThreshold`, а линия MACD располагается выше сигнальной.
   - **Продажа** требует зеркально противоположных условий.
   - Разрешено наращивание позиции базовым объёмом `Volume`, пока модуль позиции меньше `Volume * MaxPyramids`. При смене направления прежняя позиция закрывается и сразу открывается новая.
3. **Управление риском**
   - Первичные уровни стоп-лосса и тейк-профита выставляются в шагах цены относительно входа и пересчитываются при изменении позиции.
   - Перевод в безубыток срабатывает после прохождения указанного количества шагов в прибыльную сторону.
   - Трейлинг сопровождает максимум/минимум цены с заданным отступом.

По сравнению с MQL-версией направление вил определяется автоматически по наклону LWMА, без необходимости вручную рисовать объект. Остальные фильтры (моментум, MACD, лимит на количество ордеров) и блок управления позициями перенесены на высокоуровневый API StockSharp.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
|-----|-----|-----------------------|----------|
| `CandleType` | `DataType` | таймфрейм 15 минут | Основной ряд свечей для всех индикаторов. |
| `FastMaPeriod` | `int` | 6 | Период быстрой LWMA по типичной цене. |
| `SlowMaPeriod` | `int` | 85 | Период медленной LWMA по типичной цене. |
| `MomentumPeriod` | `int` | 14 | Глубина расчёта моментума. |
| `MomentumBuyThreshold` | `decimal` | 0.3 | Минимальное значение \|Momentum − 100\| для покупок. |
| `MomentumSellThreshold` | `decimal` | 0.3 | Минимальное значение \|Momentum − 100\| для продаж. |
| `MaxPyramids` | `int` | 1 | Максимальное число базовых лотов в одном направлении. |
| `StopLossSteps` | `int` | 20 | Дистанция стоп-лосса в шагах цены. |
| `TakeProfitSteps` | `int` | 50 | Дистанция тейк-профита в шагах цены. |
| `EnableTrailing` | `bool` | `true` | Включает трейлинг стоп. |
| `TrailingTriggerSteps` | `int` | 40 | Прибыль в шагах, после которой активируется трейлинг. |
| `TrailingDistanceSteps` | `int` | 40 | Отступ в шагах между экстремумом и трейлинг-стопом. |
| `TrailingPadSteps` | `int` | 10 | Дополнительный буфер для трейлинг-стопа. |
| `EnableBreakEven` | `bool` | `true` | Переводит стоп в безубыток. |
| `BreakEvenTriggerSteps` | `int` | 30 | Прибыль в шагах, необходимая для перевода в безубыток. |
| `BreakEvenOffsetSteps` | `int` | 30 | Смещение в шагах за точку входа при срабатывании безубытка. |

## Примечания

- Для корректной работы нужен установленный `PriceStep` инструмента — именно он используется для перевода шагов в цены. Если шаг не задан, трейлинг и безубыток не выполняются.
- Стоп- и тейк-профит автоматически переустанавливаются при изменении позиции, чтобы сопровождать усреднения и развороты.
- Значения по умолчанию соответствуют настройкам оригинального советника и могут оптимизироваться через диапазоны `StrategyParam`.
