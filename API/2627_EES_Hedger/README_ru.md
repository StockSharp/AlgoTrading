# Стратегия EES Hedger

## Описание

Стратегия EES Hedger повторяет логику одноимённого советника для MetaTrader и автоматически хеджирует позиции, открытые другим алгоритмом или вручную. Когда на счёте появляется сделка, удовлетворяющая заданному фильтру, стратегия немедленно открывает противоположную позицию со своими параметрами. Это позволяет свести рыночную экспозицию к нулю, сохраняя исходную сделку в рынке.

Реализация использует высокоуровневый API StockSharp: стратегия отслеживает сделки счёта, выставляет ордера для хеджа и управляет защитой через стоп-лосс, тейк-профит и трейлинг-стоп. Алгоритм трейлинга копирует оригинал: стоп переносится только после того, как цена прошла расстояние, превышающее сумму `TrailingStopPips` и `TrailingStepPips`.

## Параметры

| Параметр | Назначение |
| --- | --- |
| `HedgeVolume` | Фиксированный объём встречного ордера. Не зависит от объёма исходной сделки. |
| `StopLossPips` | Расстояние до начального стоп-лосса. Значение 0 отключает стартовый стоп. |
| `TakeProfitPips` | Расстояние до тейк-профита. Значение 0 означает отсутствие цели. |
| `TrailingStopPips` | Расстояние трейлинг-стопа от текущей цены. |
| `TrailingStepPips` | Минимальный шаг для очередного переноса трейлинг-стопа. При включённом трейлинге должен быть больше нуля. |
| `OriginalOrderComment` | Необязательный фильтр по комментарию. Хеджируются только сделки с совпадающим комментарием (без учёта регистра). Пустое значение — все сделки. |
| `HedgerOrderComment` | Необязательный комментарий для идентификации собственных хеджевых сделок. Совпадающие комментарии игнорируются, чтобы исключить повторный хедж. |

## Логика работы

1. **Отслеживание сделок.** Стратегия подписывается на событие `NewMyTrade` коннектора и анализирует каждую сделку по выбранному инструменту.
2. **Выставление хеджа.** При появлении подходящей сделки открывается рыночный ордер противоположного направления объёмом `HedgeVolume`.
3. **Настройка защиты.** После каждого собственного исполнения отменяются старые защитные ордера и выставляются новые стоп-лосс и тейк-профит, рассчитанные от средней цены позиции.
4. **Трейлинг-стоп.** Каждый новый тик проверяет условия трейлинга. Когда цена прошла в прибыльную сторону не меньше `TrailingStopPips + TrailingStepPips`, стоп подтягивается ближе к рынку (под цену для лонга и над ценой для шорта).
5. **Завершение цикла.** При полном закрытии хеджевой позиции оставшиеся ордера отменяются, и стратегия ожидает следующую исходную сделку.

## Рекомендации по использованию

- Убедитесь, что коннектор передаёт все сделки счёта, включая операции других систем.
- Расчёт величины пункта выполняется на основе `PriceStep`; для инструментов с 3 или 5 знаками после запятой добавляется множитель 10, как в версии MQL.
- Чтобы хеджировать только определённый алгоритм, укажите его комментарий в `OriginalOrderComment`. Для ручных операций оставьте поле пустым.
- При активном трейлинге параметр `TrailingStepPips` должен быть положительным, иначе стратегия завершит работу при запуске.
- Поскольку объём хеджа постоянный, настройте `HedgeVolume` в соответствии со средней позицией исходной системы, чтобы достичь требуемого уровня защиты.
