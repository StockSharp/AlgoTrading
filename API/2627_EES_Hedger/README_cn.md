# EES 对冲策略

## 概述

EES 对冲策略复刻了经典的 MetaTrader 智能交易程序，通过自动在账户中开立与原始交易方向相反的持仓来进行风险对冲。只要监控到符合过滤条件的外部交易（来自其他自动化策略或人工操作），本策略就会立即按照自身参数开仓，从而抵消净敞口，同时保留原始仓位的运行空间。

策略基于 StockSharp 的高级 API 编写：订阅账户成交、发送对冲单，并通过止损、止盈及追踪止损来管理防护订单。追踪止损的实现严格遵循原始 MQL 版本，只有当价格变动超过止损距离与追踪步长之和时才会移动止损价位。

## 参数

| 参数 | 说明 |
| --- | --- |
| `HedgeVolume` | 对冲单的固定手数，不会根据外部成交的数量自动调整。 |
| `StopLossPips` | 对冲仓位初始止损的点数距离。为 0 表示不设置初始止损。 |
| `TakeProfitPips` | 对冲仓位止盈的点数距离。为 0 表示不放置止盈。 |
| `TrailingStopPips` | 追踪止损的距离，表示与当前价格保持的点差。 |
| `TrailingStepPips` | 每次更新追踪止损所需的最小价格位移。启用追踪功能时必须为正值。 |
| `OriginalOrderComment` | 可选的订单注释过滤器，仅对注释与此值匹配（忽略大小写）的交易执行对冲。留空表示对所有交易生效。 |
| `HedgerOrderComment` | 可选注释，用于识别策略自身的对冲单。当成交注释与该值相同时时将忽略，避免重复对冲。 |

## 行为流程

1. **成交监听**：策略订阅连接器的 `NewMyTrade` 事件，对每一笔属于目标证券且满足过滤条件的成交视为外部进场信号。
2. **对冲下单**：当检测到有效成交时，立即使用 `HedgeVolume` 以市价在相反方向开仓。
3. **防护设置**：每次自身成交后都会撤销现有的防护单，并根据当前持仓均价重新挂出止损与止盈订单。
4. **追踪止损**：利用收到的逐笔成交数据评估追踪条件；当浮盈超过 `TrailingStopPips + TrailingStepPips` 时，向有利方向移动止损价。多头止损跟随在价格下方，空头则在价格上方。
5. **仓位归零**：当对冲仓位被完全平仓（触发止损或止盈）后，会自动撤销剩余的防护订单并等待下一笔外部信号。

## 使用建议

- 请确保连接器能够返回所有账户成交，包括由其他程序生成的订单。
- 点值计算参考品种的最小价格跳动，对于 3 位或 5 位报价会自动乘以 10，以模拟 MQL 中对 Point 的调整。
- 若只希望对特定策略的交易进行对冲，可设置 `OriginalOrderComment` 与其订单注释一致；对人工交易对冲时可保持为空。
- 启用追踪止损时务必保证 `TrailingStepPips` 大于零，否则策略会在启动阶段直接终止。
- 由于对冲手数固定，建议结合主策略的平均持仓规模调节 `HedgeVolume`，以获得最佳的风险覆盖效果。
