# Trailing Close Manager 策略

## 概述

**TrailingCloseManagerStrategy** 复刻了 MetaTrader 指标 *Trailing Only with Close All Button v2* 的功能。策略本身不会寻找入场信号，而是专注于管理已有持仓：根据设定的点数应用初始止损/止盈，启用跟踪止损，并通过三个布尔参数模拟手动按钮，快速平掉全部、盈利或亏损头寸。

## 主要特性

- **初始保护距离**：当检测到持仓时，根据参数计算出以点数表示的止损和止盈距离；每当仓位数量变化时重新计算。
- **动态跟踪止损**：价格向有利方向移动到达设定距离后激活跟踪止损，并按照跟踪步长向前移动，同时支持多头与空头。
- **手动平仓按钮**：`Close All`、`Close Profit`、`Close Losing` 三个布尔参数模拟原版的图形按钮。触发后会按照设置的尝试次数与延迟反复执行平仓。
- **浮动盈亏阈值**：当账户浮动收益达到正阈值或浮动亏损跌破负阈值时，立即平掉所有仓位。
- **重复尝试机制**：每个手动平仓过程都可以按照 `Retry Count` 和 `Retry Delay` 重复执行，默认重试 5 次，每次间隔 500 毫秒，与 MQL 脚本的循环相呼应。

## 参数说明

| 名称 | 说明 |
| --- | --- |
| `Stop Loss (pips)` | 初始止损点数，0 表示禁用。
| `Take Profit (pips)` | 初始止盈点数，0 表示禁用。
| `Trailing Stop (pips)` | 激活后，价格与跟踪止损之间的距离。
| `Trailing Step (pips)` | 再次移动跟踪止损所需的额外点数。
| `Close Profit Threshold` | 当浮动盈利达到该值时平掉全部仓位。
| `Close Loss Threshold` | 当浮动亏损低于该负值时平掉全部仓位。
| `Retry Count` | 手动平仓时的重试次数。
| `Retry Delay` | 两次重试之间的延迟。
| `Close All` | 手动平掉所有仓位的按钮。
| `Close Profit` | 手动平掉所有盈利仓位的按钮。
| `Close Losing` | 手动平掉所有亏损仓位的按钮。

## 使用建议

1. **配合其他入场策略使用**。本策略假定仓位由人工或其它算法开立。
2. **根据品种调整点值**。策略会在小数位为 3 或 5 的品种上，将价格最小变动乘以 10，与原版 EA 的点值计算保持一致。
3. **关注日志输出**。日志中会记录跟踪止损的启用与移动、手动按钮触发以及重试耗尽等事件。
4. **虚拟化风控**。策略通过市价单离场，而不是修改实际的止损/止盈订单，更贴合 StockSharp 高阶 API 的最佳实践。

## 转换说明

- MetaTrader 图形界面的按钮转化为布尔参数，触发后自动恢复为 `false`。
- 策略订阅成交数据（ticks）来驱动跟踪止损，与原脚本的逐笔更新逻辑一致。
- 所有退出操作采用市价单完成，以保持实现简单并兼容不同的交易连接。
