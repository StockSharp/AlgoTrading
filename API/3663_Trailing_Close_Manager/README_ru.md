# Стратегия Trailing Close Manager

## Обзор

**TrailingCloseManagerStrategy** повторяет функциональность советника MetaTrader *Trailing Only with Close All Button v2*. Стратегия не ищет точки входа. Она контролирует уже открытые позиции, применяет фиксированные и плавающие защитные уровни и предоставляет оператору три "кнопки" в виде булевых параметров для мгновенного закрытия всех, только прибыльных или только убыточных сделок.

## Основные возможности

- **Начальные защитные уровни** – при появлении позиции стратегия рассчитывает стоп-лосс и тейк-профит в пипсах. При изменении объёма уровня пересчитываются.
- **Динамический трейлинг** – после прохождения ценой заданного расстояния включается трейлинг-стоп, который сопровождает цену с учётом шага смещения. Поддерживаются длинные и короткие позиции.
- **Ручные кнопки закрытия** – параметры `Close All`, `Close Profit` и `Close Losing` имитируют кнопки из оригинального советника. После переключения запускается серия попыток закрытия с заданной задержкой.
- **Защита по совокупной прибыли/убытку** – при достижении положительного порога плавающей прибыли или отрицательного порога плавающего убытка стратегия закрывает все позиции портфеля.
- **Повторы закрытия** – каждая процедура закрытия может повторяться несколько раз (по умолчанию пять раз с паузой 500 мс), что соответствует логике MQL-советника.

## Параметры

| Название | Описание |
| --- | --- |
| `Stop Loss (pips)` | Стоп-лосс в пипсах. Ноль отключает уровень.
| `Take Profit (pips)` | Тейк-профит в пипсах. Ноль отключает уровень.
| `Trailing Stop (pips)` | Расстояние между ценой и трейлинг-стопом после его активации.
| `Trailing Step (pips)` | Минимальное дополнительное движение цены перед переносом трейлинг-стопа.
| `Close Profit Threshold` | Закрыть все позиции при достижении указанной плавающей прибыли.
| `Close Loss Threshold` | Закрыть все позиции при достижении указанного (отрицательного) плавающего убытка.
| `Retry Count` | Количество повторов процедуры закрытия.
| `Retry Delay` | Задержка между повторами.
| `Close All` | Ручная кнопка полного закрытия портфеля.
| `Close Profit` | Ручная кнопка закрытия только прибыльных позиций.
| `Close Losing` | Ручная кнопка закрытия только убыточных позиций.

## Советы по использованию

1. **Запускайте вместе с другими системами.** Стратегия предназначена для сопровождения уже открытых сделок.
2. **Настройте пипсовые значения под инструмент.** Размер пипса автоматически масштабируется для трёх- и пятизначных котировок так же, как в оригинальном советнике.
3. **Следите за журналом.** В лог пишутся сообщения об активации/перемещении трейлинга, срабатывании кнопок и исчерпании попыток закрытия.
4. **Комбинируйте с алгоритмами входа.** Стратегию удобно использовать как модуль управления риском поверх сторонних входных моделей.

## Особенности конверсии

- Кнопки графического интерфейса MetaTrader заменены на булевые параметры, которые автоматически сбрасываются в `false` после срабатывания.
- Трейлинг работает по ценам сделок из подписки на тики, что воспроизводит обновление на каждом тике в MQL.
- Вместо модификации стоп-ордеров стратегия закрывает позиции рыночными заявками – так рекомендует использовать высокоуровневый API StockSharp.
