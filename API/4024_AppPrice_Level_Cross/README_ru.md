# Стратегия App Price Level Cross

## Общее описание
- Перенос эксперта MetaTrader 4 **BT_v4** (файл `MQL/8543/BT_v4.mq4`) на платформу StockSharp.
- Используется только высокоуровневый API: подписка на свечи, обработка сигналов без индикаторов и стандартные защитные механизмы `StartProtection`.
- Цель стратегии — реагировать на пересечение ценой закрытия фиксированного уровня `AppPrice` и повторять поведение оригинального советника.

## Логика торговли
1. Стратегия анализирует только завершённые свечи (`CandleStates.Finished`), что полностью соответствует оригиналу.
2. Если цена закрытия **пересекает уровень вверх** (текущая свеча выше `AppPrice`, а предыдущая была ниже или равна ему):
   - Сигнал используется только при `BuyOnly = true` (режим «только покупки» как в исходном скрипте).
   - Отменяются отложенные заявки, затем одним рыночным ордером закрываются возможные короткие позиции и открывается новая длинная позиция требуемого объёма.
3. Если цена закрытия **пересекает уровень вниз** (текущая свеча ниже `AppPrice`, а предыдущая была выше или равна ему):
   - Срабатывает только при `BuyOnly = false` (режим «только продажи»).
   - Отменяются отложенные заявки, закрываются длинные позиции и открывается короткая позиция базового объёма.
4. Алгоритм не использует дополнительные индикаторы и не обращается к историческим данным с помощью запрещённых методов `GetValue`.

## Управление объёмом
- При `EnableMoneyManagement = false` отправляется фиксированный объём `FixedVolume` (полный аналог параметра `Lots`).
- При `EnableMoneyManagement = true` объём рассчитывается по формуле исходного эксперта:
  
  \[
  \text{lot} = \text{round}_{\text{LotPrecision}} \left( \frac{\text{LotBalancePercent}}{100} \times \frac{\text{Balance}}{\text{divisor}} \right)
  \]
  
  - Делитель `divisor = 1000` для одной десятичной позиции и `100` для двух (точно как `LotPrec` в MQL).
  - Результат ограничивается диапазоном [`MinLot`, `MaxLot`] и дополнительно приводится к биржевым ограничениям (`VolumeStep`, `VolumeMin`, `VolumeMax`).
  - Если данные о балансе портфеля недоступны, стратегия автоматически возвращается к фиксированному объёму.

## Управление риском
- `StopLossPoints` и `TakeProfitPoints` задаются в ценовых пунктах (минимальных шагах цены).
- При ненулевых значениях вызывается `StartProtection`, расстояния переводятся в цены через `Security.PriceStep`.
- Нулевое значение выключает соответствующую защиту, что соответствует поведению MQL-версии.

## Параметры
| Параметр | Назначение | Значение по умолчанию |
| -------- | ---------- | --------------------- |
| `AppPrice` | Уровень, при пересечении которого формируются сигналы. | `0` |
| `BuyOnly` | `true` — только покупки, `false` — только продажи. | `true` |
| `FixedVolume` | Объём сделки при отключённом ММ. | `0.1` |
| `EnableMoneyManagement` | Включение расчёта объёма от баланса. | `false` |
| `LotBalancePercent` | Доля баланса для ММ. | `10` |
| `MinLot` / `MaxLot` | Минимальный и максимальный объём после расчёта. | `0.1` / `5` |
| `LotPrecision` | Количество знаков после запятой у рассчитанного объёма. | `1` |
| `StopLossPoints` | Стоп-лосс в пунктах (0 = отключён). | `140` |
| `TakeProfitPoints` | Тейк-профит в пунктах (0 = отключён). | `180` |
| `CandleType` | Таймфрейм свечей, используемых в расчётах. | `1 минута` |

## Особенности реализации
- Используется `SubscribeCandles(...).Bind(...)`, поэтому данные индикаторов не требуются, а код соблюдает ограничения из `AGENTS.md` (никаких `GetValue`).
- Объём рыночного ордера увеличивается на величину текущей противоположной позиции, что позволяет закрыть её и открыть новую в одном действии.
- Перед отправкой рыночного ордера вызывается `CancelActiveOrders()` для защиты от случайного исполнения старых заявок.
- Параметры `Magic`, `Slippage` и цветовые настройки из MQL не имеют значения в StockSharp и потому опущены.
- Убедитесь, что у инструмента заполнены `PriceStep`, `VolumeStep`, `VolumeMin`, `VolumeMax`, иначе расчёт стопов и объёмов может не совпадать с требованиями брокера.

## Рекомендации по использованию
- Настройте `AppPrice` на нужный горизонтальный уровень (психологическая отметка, уровень поддержки/сопротивления и т.п.).
- Для режима «только продажи» установите `BuyOnly = false`; по умолчанию включён режим «только покупки».
- При включении ММ убедитесь, что подключённый портфель передаёт актуальный баланс; иначе стратегия использует фиксированный объём.
- По запросу пользователя создана только версия на C# — папка и скрипты для Python не добавлялись.
