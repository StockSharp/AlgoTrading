# 摩斯密码策略
[English](README.md) | [Русский](README_ru.md)

## 概述
摩斯密码策略重现了原始 MetaTrader 5 专家顾问的思想：把每一根收盘完成的 K 线看成「划」或「点」。收盘价大于或等于开盘价的 K 线被编码为 `1`，收盘价小于或等于开盘价的 K 线被编码为 `0`。策略持续读取最近的 K 线序列，并与所选的二进制掩码逐位比较。一旦序列完全匹配，即刻按照指定方向开仓，并同步设置以点（pip）为单位的止盈与止损。

实现完全依赖 StockSharp 的高级 API：K 线订阅提供数据流，`Bind` 负责把完成的 K 线传递给策略，而 `StartProtection` 自动管理出场订单。无需自定义集合或手动访问指标值，逻辑保持精炼且稳定。

## 模式逻辑
- 仅在 K 线完全收盘 (`CandleStates.Finished`) 后才参与判断。
- 每根 K 线都会转换成一个二进制位：
  - `1` – 多头或中性 K 线（`Close >= Open`）。
  - `0` – 空头或中性 K 线（`Close <= Open`）。十字星同时满足两个值，这与 MT5 原版保持一致。
- 掩码由 `MorsePatternMask` 枚举提供，涵盖了原策略中出现的所有长度 1–5 的二进制组合（例如 `000`、`1011`、`11111`）。
- 策略维护一段滑动窗口，始终保存最近若干根 K 线。当窗口与掩码完全一致时，即触发入场信号。

该流程等同于 MT5 版本中使用 `CopyRates` 逐字符比较字符串的实现方式。

## 交易流程
1. 订阅指定的 K 线类型，等待累积到足够覆盖掩码长度的历史数据。
2. 对每一根收盘完成的 K 线执行以下步骤：
   - 更新内部的多头/空头掩码以记录当前 K 线的走势方向。
   - 在未达到掩码所需的 K 线数量前跳过进一步检查。
   - 若最新窗口与掩码完全相同，则根据参数选择交易方向。
   - 调用 `BuyMarket` 或 `SellMarket` 发送市价单。当持有相反方向的仓位时，会自动增加委托数量以先平仓再反向开仓，复现 MT5 交易类的行为。
3. `StartProtection` 立即以价格单位设置止盈与止损，并使用市价出场，以降低无法成交的风险。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `CandleType` | 5 分钟 (`TimeSpan.FromMinutes(5).TimeFrame()`) | 用于生成摩斯序列的 K 线类型。 |
| `Pattern` | `_0` (`"0"`) | 与最新 K 线比较的二进制掩码，取自 `MorsePatternMask` 枚举。 |
| `Direction` | `Sides.Buy` | 掩码匹配时执行的方向：做多或做空。 |
| `TakeProfitPips` | `50` | 止盈距离，单位为点。策略会在遇到 3/5 位报价的外汇品种时自动把 `PriceStep` 乘以 10。 |
| `StopLossPips` | `50` | 止损距离，单位为点，计算方式与止盈一致。 |
| `Volume`（策略属性） | 用户自定义 | 下单手数或合约数，对应 MT5 中的 `InpLot`。 |

所有参数均可在 StockSharp 参数窗口中调整，也支持加入优化流程。

## 风险控制
- `StartProtection` 根据点数计算出价格偏移，并使用市价单离场，模拟 MT5 在下单时同时设置止盈/止损的机制。
- 策略不会在已有同向仓位时加仓；若信号出现时持有反向仓位，会自动增大委托数量完成反手。
- 日志会记录每一次开仓，方便回溯测试结果。

## 使用建议
- 掩码长度最多 5 根 K 线，突出摩斯密码的「短促信号」特性。若需要更多模式，可在组合层面部署多组策略。
- 点数换算基于 `PriceStep`。若标的使用特殊报价单位，请手动微调 `TakeProfitPips` 与 `StopLossPips`。
- 策略未内置时间或波动率过滤，可根据需要叠加会话管理或其他指标过滤器。
- 回测或实盘前，请确认 `Volume` 设置符合期望手数，以便保护模块正常工作。

## 掩码示例
- `_0` → `"0"`：单根空头 K 线。
- `_5` → `"11"`：连续两根多头 K 线。
- `_20` → `"0110"`：空头—多头交替形成的锯齿形。
- `_33` → `"00011"`：三根空头后跟随两根多头。
- `_61` → `"11111"`：连续五根多头 K 线。

策略面板中可选择全部 62 种掩码，从而精确复现所需的摩斯信号。
