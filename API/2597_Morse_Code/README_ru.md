# Стратегия Morse Code
[English](README.md) | [中文](README_cn.md)

## Обзор
Стратегия Morse Code повторяет оригинального советника MetaTrader 5, который рассматривает каждую завершённую свечу как «тире» или «точку». Бычья свеча (цена закрытия больше или равна цене открытия) кодируется как `1`, медвежья свеча (цена закрытия меньше или равна цене открытия) — как `0`. Стратегия анализирует последовательность последних свечей и сравнивает её с выбранной двоичной маской. Когда последовательность полностью совпадает с маской, открывается позиция в заданном направлении и сразу выставляются заявки на тейк-профит и стоп-лосс в пипсах.

Реализация использует только высокоуровневые API StockSharp: подписка на свечи обеспечивает поток данных, метод `Bind` передаёт готовые значения, а модуль `StartProtection` управляет выходами. Не требуются собственные коллекции или прямой доступ к значениям индикаторов, поэтому код остаётся компактным и устойчивым.

## Логика паттерна
- Анализируются только полностью завершённые свечи (`CandleStates.Finished`).
- Каждая свеча преобразуется в двоичную цифру:
  - `1` — свеча бычья или нейтральная (`Close >= Open`).
  - `0` — свеча медвежья или нейтральная (`Close <= Open`). Дожи подходят под оба значения, как и в исходном советнике.
- Маска выбирается из перечисления `MorsePatternMasks`, включающего все комбинации длиной от одной до пяти свечей, присутствовавшие в MT5-версии (например, `000`, `1011`, `11111`).
- Стратегия поддерживает скользящее окно последних свечей. Когда окно совпадает с выбранной маской, формируется сигнал на вход.

Такое поведение полностью повторяет оригинальный код MT5, где использовался `CopyRates` и посимвольное сравнение строки маски с каждой свечой.

## Торговый процесс
1. Подписаться на выбранный тип свечей и дождаться накопления количества баров, достаточного для длины маски.
2. Для каждой завершённой свечи:
   - Обновить внутренние маски, классифицирующие свечу как бычью, медвежью или нейтральную.
   - Пропустить проверку, пока не накоплено столько свечей, сколько требует маска.
   - Если последовательность совпадает с маской, проверить выбранное направление сделки.
   - Отправить рыночную заявку (`BuyMarket` или `SellMarket`). Если уже открыта позиция в противоположную сторону, объём автоматически увеличивается для закрытия старой позиции и открытия новой — как делал MT5-советник.
3. `StartProtection` немедленно навешивает стоп-лосс и тейк-профит, выраженные в ценовых единицах. Защитные заявки исполняются рыночными ордерами, что снижает риск неполучения исполнения.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | Свечи 5 минут (`TimeSpan.FromMinutes(5).TimeFrame()`) | Тип данных, из которых строится последовательность. |
| `Pattern` | `_0` (`"0"`) | Двоичная маска для сравнения с последними свечами. Значения берутся из перечисления `MorsePatternMasks`. |
| `Direction` | `Sides.Buy` | Какую позицию открывать при совпадении маски: длинную или короткую. |
| `TakeProfitPips` | `50` | Расстояние до тейк-профита в пипсах. Стратегия автоматически корректирует шаг для 3- и 5-знаковых форекс-котировок, умножая ценовой шаг на десять. |
| `StopLossPips` | `50` | Расстояние до стоп-лосса в пипсах, рассчитывается тем же способом. |
| `Volume` (свойство стратегии) | задаётся пользователем | Объём заявки в лотах/контрактах, аналог параметра `InpLot` из MT5. |

Все параметры доступны в окне настроек StockSharp, поддерживают оптимизацию и могут быть изменены до запуска стратегии.

## Управление рисками
- `StartProtection` задаёт цели в абсолютных ценовых единицах, рассчитанных из настроек пипсов. Выходы выполняются рыночными ордерами, что имитирует установку стоп-лосса и тейк-профита в MT5 сразу при открытии сделки.
- Новая сделка в ту же сторону не открывается, пока текущая позиция не закрыта. Если сигнал появляется при противоположной позиции, объём автоматически увеличивается для переворота.
- Журнал StockSharp фиксирует каждое срабатывание, упрощая анализ результатов.

## Рекомендации по использованию
- Маски короткие (до пяти свечей), что подчёркивает «азбуку Морзе». Для расширения набора сигналов можно комбинировать несколько стратегий с разными масками.
- Конвертация в пипсы основывается на `PriceStep`. Для инструментов с нестандартным шагом подберите значения `TakeProfitPips` и `StopLossPips` вручную.
- Стратегия не фильтрует время суток и волатильность. При необходимости подключите внешние фильтры или управляющую стратегию.
- Перед тестированием убедитесь, что свойство `Volume` соответствует ожидаемому торговому лоту. Тестер StockSharp применит те же защитные механизмы, что и в реальной торговле.

## Справка по маскам
Примеры значений перечисления:
- `_0` → `"0"` (одна медвежья свеча)
- `_5` → `"11"` (две последовательные бычьи свечи)
- `_20` → `"0110"` (зигзаг из медвежьих и бычьих свечей)
- `_33` → `"00011"` (три медвежьих свечи и две бычьих)
- `_61` → `"11111"` (пять бычьих свечей подряд)

Любая из 62 масок доступна в панели параметров, что позволяет точно воспроизвести нужный «азбуковый» сигнал.
