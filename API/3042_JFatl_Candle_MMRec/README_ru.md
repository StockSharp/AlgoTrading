# Стратегия JFatl Candle MMRec

Стратегия переносит логику советника **Exp_JFatlCandle_MMRec.mq5** в инфраструктуру StockSharp.
Она отслеживает смену цветов свечей, построенных с помощью фильтра JFatl, и дополняет их блоком управления
рисками MMRec, который уменьшает объём позиции после серии убыточных сделок.

## Торговая идея

* Формируются синтетические свечи: исходные OHLC значения сглаживаются ядром Fast Adaptive Trend Line (FATL).
  Используются оригинальные 39 коэффициентов фильтра; затем применяется экспоненциальное сглаживание,
  приближающее Jurik Moving Average из версии MT5.
* Цвета свечей трактуются по величине разницы между фильтрованными open и close:
  * значение **2** — бычья свеча (close выше open);
  * значение **0** — медвежья свеча (close ниже open);
  * значение **1** — нейтральное тело.
* Бычий цвет на свече `SignalBar + 1` бара назад приводит к закрытию коротких позиций и подготовке к новому
  входу в лонг, когда свеча `SignalBar` баров назад перестает быть бычьей.
* Аналогично, медвежий цвет закрывает лонги и разрешает открытие короткой позиции, если более свежая свеча уже не медвежья.
* Объём сделок вычисляется через MMRecounter: если из последних `TotalTrigger` сделок нужного направления не менее
  `LossTrigger` завершились убытком, используется уменьшенный лот, иначе — нормальный.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CandleType` | Таймфрейм свечей, поступающих на вход фильтра FATL (по умолчанию 12 часов).
| `SignalBar` | Сдвиг для поиска сигнальной свечи. `0` — текущая закрытая свеча, `1` — настройка, соответствующая MT5.
| `SmoothingLength` | Длина экспоненциального сглаживания после ядра FATL.
| `NormalVolume` | Базовый объём позиции при стабильных результатах.
| `ReducedVolume` | Уменьшенный объём, активируется при серии убыточных сделок.
| `BuyTotalTrigger` / `SellTotalTrigger` | Количество последних сделок каждого направления, которые анализирует MMRecounter.
| `BuyLossTrigger` / `SellLossTrigger` | Минимум убыточных сделок в окне анализа, после которого включается ReducedVolume.
| `EnableBuyEntries` / `EnableSellEntries` | Разрешение на открытие длинных/коротких позиций.
| `EnableBuyExits` / `EnableSellExits` | Разрешение на закрытие позиций при появлении противоположного сигнала.
| `StopLossPoints` | Необязательный стоп-лосс в шагах цены инструмента. `0` отключает защиту.
| `TakeProfitPoints` | Тейк-профит в шагах цены. `0` отключает цель.

## Правила торговли

1. После накопления достаточной истории (не менее 39 свечей) рассчитываются фильтрованные OHLC и цвет свечи.
2. Пусть `C1` — цвет свечи `SignalBar + 1` баров назад, `C0` — цвет свечи `SignalBar` баров назад
   (при `SignalBar = 0` используется текущая свеча как `C0`, предыдущая — как `C1`).
3. Если `C1 == 2` (бычий цвет):
   * закрыть все короткие позиции, если `EnableSellExits` включён;
   * открыть длинную позицию рассчитанным объёмом, если `EnableBuyEntries` включён и `C0 != 2`.
4. Если `C1 == 0` (медвежий цвет):
   * закрыть все длинные позиции, если активирован `EnableBuyExits`;
   * открыть короткую позицию, если `EnableSellEntries` включён и `C0 != 0`.
5. Позиции также закрываются при достижении уровней стоп-лосса или тейк-профита в пределах диапазона свечи.

## Деньги-менеджмент

После каждой закрытой позиции стратегия сохраняет результат отдельно для лонгов и шортов.
Перед входом она анализирует до `TotalTrigger` прошлых сделок выбранного направления.
Если количество убыточных результатов достигает `LossTrigger`, новая позиция открывается уменьшенным объёмом,
в противном случае — стандартным.

## Примечания

* Расчёт стоп-лосса и тейк-профита ведётся в шагах цены (`Security.PriceStep`). При отсутствии данных используется шаг `1`.
* Пока фильтр FATL не накопит 39 значений, сигналы и сделки не формируются.
* История сделок для MMRecounter ограничена 100 записями — старые результаты автоматически удаляются.
