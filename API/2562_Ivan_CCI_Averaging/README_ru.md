# Стратегия Ivan CCI Averaging
[English](README.md) | [中文](README_cn.md)

Порт советника MetaTrader «Ivan», торгующего экстремумы индикатора CCI с усредняющими входами и стопом по сглаженной скользящей средней. Стратегия отслеживает долгосрочный CCI(100) для включения глобального бычьего или медвежьего режима, при необходимости наращивает позицию при откатах CCI(13) и управляет риском через перенос стопа в безубыток и трейлинг вокруг сглаженной средней. Размер позиции повторяет модель риска в процентах от капитала, а коэффициент защиты прибыли закрывает все позиции при кратном росте эквити.

## Детали

- **Условия входа**:
  - **Глобальный лонг**: CCI(100) поднимается выше `GlobalSignalLevel`, пока режим покупок не активен. Открывается рыночный лонг со стопом на значении сглаженной средней при условии, что стоп минимум на `MinStopDistance` ниже цены.
  - **Усреднение лонга**: при активном флаге покупок и включённом `UseAveraging` любое падение CCI(13) ниже `-GlobalSignalLevel` добавляет ещё один лонг по тому же шаблону стопа.
  - **Глобальный шорт**: CCI(100) опускается ниже `-GlobalSignalLevel`, пока режим продаж не активен, что открывает шорт при условии, что стоп от MA минимум на `MinStopDistance` выше цены.
  - **Усреднение шорта**: при включённом `UseAveraging` рост CCI(13) выше `GlobalSignalLevel` в режиме продаж добавляет к шортовой позиции.
- **Направление**: работает в обе стороны и может пирамидить позиции внутри активного режима.
- **Условия выхода**:
  - Возврат CCI(100) внутрь диапазона `±ReverseLevel` отменяет оба режима и принудительно закрывает позиции.
  - Рост эквити портфеля выше `ProfitProtectionFactor` от стартового баланса закрывает все сделки и фиксирует результат.
  - Достижение отслеживаемого стопа (безубыток или трейлинг по MA) закрывает соответствующее плечо.
- **Стопы**:
  - Базовый стоп берётся из сглаженной скользящей средней со сроком `StopLossMaPeriod`.
  - Перенос в безубыток двигает стоп на цену входа после прохождения `BreakEvenDistance` (0 отключает функцию).
  - Трейлинг подтягивает стоп только если MA продвинулась минимум на `TrailingStep` за текущий уровень.
- **Фильтры**:
  - `UseZeroBar` повторяет опцию MT5 — использовать значения только что открывшейся свечи или последней закрытой.
  - `MinStopDistance` блокирует сделки, когда стоп от MA слишком близок к цене.
- **Размер позиции**:
  - Каждый новый ордер рискует `RiskPercent` текущего портфеля, делённым на расстояние до стопа; `MinimumVolume` задаёт нижний предел объёма.

## Параметры

- **Use Averaging** *(bool, по умолчанию: true)* — разрешить дополнительные усредняющие входы в активном режиме.
- **Stop MA Period** *(int, по умолчанию: 36)* — период сглаженной MA, от которой берётся стоп.
- **Risk %** *(decimal, по умолчанию: 10)* — доля капитала, которую стратегия рискует на каждом новом входе.
- **Use Zero Bar** *(bool, по умолчанию: true)* — использовать нулевую свечу; при `false` расчёт ведётся по последней закрытой.
- **Reverse Level** *(decimal, по умолчанию: 100)* — модуль порога CCI, при котором режимы сбрасываются и позиции закрываются.
- **Global Level** *(decimal, по умолчанию: 100)* — модуль порога CCI, при достижении которого формируется глобальный сигнал.
- **Min Stop Distance** *(decimal, по умолчанию: 0.005)* — минимальный зазор между ценой и стопом (0.005 ≈ 50 пунктов для 5-значных валютных пар).
- **Trailing Step** *(decimal, по умолчанию: 0.001)* — минимальное продвижение MA, необходимое для подтяжки трейлинг-стопа.
- **BreakEven Distance** *(decimal, по умолчанию: 0.0005)* — ход цены, после которого стоп переносится в точку входа; 0 отключает перенос.
- **Profit Protection** *(decimal, по умолчанию: 1.5)* — коэффициент роста эквити, при котором все позиции закрываются.
- **Minimum Volume** *(decimal, по умолчанию: 1)* — минимальный объём сделки при недостаточном рассчитанном объёме.
- **Candle Type** *(DataType)* — тип используемых свечей (по умолчанию таймфрейм 15 минут).

## Примечания

- Расстояния `MinStopDistance`, `TrailingStep` и `BreakEvenDistance` задаются в ценовых единицах и требуют адаптации под шаг цены инструмента.
- Предполагается мгновенное исполнение `BuyMarket`/`SellMarket`; при ожидании проскальзываний или частичных исполнений скорректируйте настройки исполнения.
- Расчёт объёма по портфелю требует подключённого портфельного адаптера; иначе будет использоваться значение `MinimumVolume`.
