# Стратегия Commission Calculator

## Общее описание
**Commission Calculator Strategy** — утилитарная стратегия, повторяющая оригинальный скрипт MetaTrader. Она отправляет одну дискреционную заявку выбранного типа (рыночная, лимитная или стоповая) и рассчитывает брокерскую комиссию по каждой сделке. Все комиссии накапливаются, а при остановке стратегия выводит подробный отчет с начальным балансом, суммарными сборами и скорректированным балансом.

В отличие от классических торговых систем стратегия не нуждается в рыночных данных и индикаторах — её задача состоит в автоматическом учете комиссий при ручной или полуавтоматической торговле.

## Логика работы
1. При запуске стратегия запоминает стартовый баланс портфеля и устанавливает объем для вспомогательных методов (`BuyMarket`, `SellLimit` и т. д.).
2. Если заданы цены входа и защит, активируется `StartProtection`: дистанции стоп-лосса и тейк-профита рассчитываются в абсолютных ценовых единицах, что повторяет MQL-реализацию.
3. Выбранный режим исполнения отрабатывается один раз. При некорректных параметрах (например, отсутствует цена входа для лимитной заявки) стратегия фиксирует проблему в журнале и не отправляет заявку.
4. Каждый `MyTrade` используется для расчета комиссии по формуле `цена × объем × комиссия / 100`.
5. Комиссии суммируются, последняя величина сохраняется отдельно, а при остановке стратегия выводит детальный отчет.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `Quantity` | `0.001` | Объем сделки, который будет использоваться вспомогательными методами отправки заявок. |
| `EntryPrice` | `31365` | Цена для лимитных/стоповых заявок и база для расчета защитных дистанций. |
| `StopLossPrice` | `31200` | Уровень стоп-лосса. Если расстояние не положительно, защита отключается. |
| `TakeProfitPrice` | `32100` | Уровень тейк-профита. Если расстояние не положительно, защита отключается. |
| `CommissionRate` | `0.04` | Размер комиссии в процентах от оборота. |
| `Mode` | `None` | Тип заявки, которую необходимо отправить при старте. Варианты: `None`, `MarketBuy`, `MarketSell`, `BuyLimit`, `SellLimit`, `BuyStop`, `SellStop`. |

## Рекомендации
- Запускайте стратегию на портфеле, поддерживающем ручные операции. Подписки на данные не требуются.
- Убедитесь, что параметр `CommissionRate` соответствует тарифу брокера, иначе расчеты будут некорректными.
- Для отложенных заявок заранее задайте корректную `EntryPrice`, иначе заявка не будет размещена.
- При включенных защитах стратегия использует рыночное закрытие позиции, чтобы максимально точно повторить поведение исходного MQL-кода.

## Отчетность
В методе `OnStopped` в журнал выводится:
- начальный баланс (зафиксирован в момент запуска);
- суммарная величина комиссий;
- итоговый баланс с учетом удержанных комиссий.

Такой подход позволяет быстро проверять тарифы брокера и проводить «что если» расчеты в режиме бэктеста.
