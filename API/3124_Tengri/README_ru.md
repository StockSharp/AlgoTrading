# Стратегия Tengri (порт на StockSharp)

Данный проект переносит советник MetaTrader *Tengri* на высокоуровневый API StockSharp. Оригинальный советник торгует EURUSD и USDCHF, комбинируя RSI, фирменный индикатор «Silence» и EMA-фильтр тренда, а также использует сеточную схему наращивания позиций. Перенос сохраняет логику, но адаптирован к учёту нетто-позиций и инфраструктуре S#. 

## Основные идеи

- **Определение направления** – сравнивается текущая цена bid и цена открытия свечи старшего таймфрейма (по умолчанию 30 минут). Если bid выше открытия – ищем покупки, если ниже – продажи.
- **Фильтр импульса** – RSI c периодом 14 на часовом графике. Для покупок значение должно быть ниже 70, для продаж выше 30, как и в MQL-версии.
- **Фильтры «тишины»** – проприетарный индикатор заменён на ATR, сглаженный EMA, для двух различных таймфреймов. Оба значения должны находиться ниже заданных порогов, чтобы разрешить вход или доливку.
- **Подтверждение тренда** – EMA среднего таймфрейма не позволяет усредняться против тенденции: лонги добавляются только при цене выше EMA, шорты – ниже EMA.
- **Сеточное наращивание** – первый ордер выставляется фиксированным лотом либо пропорционально капиталу. Каждый следующий ордер умножает предыдущий объём на заданные коэффициенты (по умолчанию 1.70 до `StepX` и 2.08 после).
- **Расстояние между усреднениями** – использует два базовых шага в пунктах (10 и 20) и показатель `PipStepExponent` для экспоненциального роста дистанции.

## Логика торговли

1. **Проверка входа** (по `EntryCandleType`, по умолчанию M1):
   - Получить направление из свечи `DealCandleType`.
   - Проверить RSI и первый фильтр «тишины».
   - Убедиться, что нет активных ордеров в том же направлении (при наличии противоположной позиции она сначала закрывается, поскольку StockSharp ведёт нетто-учёт).
   - Открыть рынок с рассчитанным объёмом и сохранить цель по тейк-профиту для первого ордера.
2. **Проверка усреднения** (по `ScaleCandleType`, по умолчанию M1):
   - Убедиться, что EMA поддерживает текущий тренд, и второй фильтр «тишины» находится ниже порога.
   - Проверить, что цена ушла от последнего входа на требуемое расстояние в пунктах.
   - Добавить позицию с мартингейльным объёмом, если не превышено ограничение `MaxTrades`.
3. **Сопровождение**:
   - Опциональный глобальный лимит прибыли (`UseLimit`) закрывает позицию, когда суммы плавающих PnL по лонгам и шортам превышают `Equity / LimitDivisor`.
   - Хранится цель по тейк-профиту для первого ордера; при достижении этого уровня вся позиция закрывается.
   - Стоп-лосс не используется, как и в исходном советнике.

## Параметры

| Параметр | Назначение |
|----------|------------|
| `DealCandleType` | Таймфрейм для сравнения цены открытия и текущего bid. |
| `EntryCandleType` | Таймфрейм проверки сигналов на вход. |
| `ScaleCandleType` | Таймфрейм проверки доливки. |
| `MaCandleType` | Таймфрейм EMA-тренда. |
| `Silence1CandleType` / `Silence2CandleType` | Таймфреймы ATR-фильтров. |
| `RsiPeriod` | Период RSI (по умолчанию 14). |
| `SilencePeriod1/2`, `SilenceInterpolation1/2`, `SilenceLevel1/2` | Настройки ATR-сглаживания и порогов. |
| `MaPeriod` | Период EMA. |
| `PipStep`, `PipStep2`, `PipStepExponent` | Расстояния между усреднениями. |
| `LotExponent1`, `LotExponent2`, `StepX` | Коэффициенты увеличения объёма. |
| `LotSize`, `FixLot`, `LotStep` | Денежный менеджмент первого входа. |
| `SlTpPips` | Тейк-профит в пунктах для первого ордера (0 — отключено). |
| `MaxTrades` | Максимальное число ордеров в одном направлении. |
| `UseLimit`, `LimitDivisor` | Глобальный лимит прибыли. |
| `CloseFriday`, `CloseFridayHour` | Фильтр на поздние пятничные сделки. |

## Отличия от MQL-версии

- **Замена Silence** – вместо оригинального индикатора используется ATR с EMA-сглаживанием. Пороговые значения оставлены такими же, но при необходимости их можно перенастроить.
- **Нетто-позиция** – StockSharp агрегирует позицию, поэтому стратегия закрывает встречные ордера перед открытием новой серии, вместо «хеджирования» двух направлений одновременно.
- **Тейк-профит** – в MetaTrader он задаётся только первому ордеру. В порте при достижении цели закрывается весь нетто-объём, а доливки остаются без TP, как и в оригинале.
- **Выбор инструмента** – стратегия работает с тем `Security`, который установлен в экземпляре. Для торговли несколькими инструментами запускайте отдельные копии стратегии.

## Рекомендации по эксплуатации

- Проверьте шаг объёма (`VolumeStep`) и минимальный/максимальный объём инструмента, чтобы нормализация лота соответствовала требованиям брокера.
- Для корректной работы необходим поток стакана (bid/ask) – без Level1 данных невозможно определять направление и закрывать тейк-профит.
- Отсутствие стоп-лосса предполагает внешний контроль риска (например, ограничения по капиталу или ручной мониторинг).

## Визуализация

Подключите графики с используемыми таймфреймами, добавьте EMA и отображение ATR, чтобы оценивать работу фильтров и сетку ордеров. Это приближает отладку к той, что использовалась в MetaTrader.
