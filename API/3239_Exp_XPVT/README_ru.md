# Стратегия Exp XPVT

**Exp XPVT** — порт стратегии MetaTrader 5 *Exp_XPVT* на платформу StockSharp. Торговая идея основана на пересечениях индикатора Price and Volume Trend (PVT) и его сглаженной версии. Когда «сырое» значение PVT опускается ниже сигнальной кривой, стратегия открывает длинную позицию; обратное пересечение запускает короткую позицию. Дополнительные параметры стоп-лосса и тейк-профита повторяют защиту капитала оригинального эксперта.

## Принцип работы индикатора
- PVT накапливает изменения цены в процентах, взвешенные выбранным типом объёма, используя гибко задаваемую цену (close, open, median, trend-follow и т.д.).
- Сигнальная линия формируется с помощью настраиваемого сглаживания: SMA, EMA, SMMA, LWMA, Jurik, T3, приближение VIDYA либо адаптивная средняя Кауфмана.
- Параметр `Signal Bar` полностью повторяет MT5-логику: для принятия решения сравниваются значения PVT и сигнальной линии с отступом на одну и две свечи назад.
- В качестве веса допускается использование тикового либо биржевого объёма; при отсутствии выбранного источника выполняется автоматическое резервное переключение.

## Алгоритм торговли
1. На закрытии каждой свечи вычисляется новое значение PVT согласно выбранной цене и типу объёма.
2. Обновляется сглаживающий индикатор и сохраняются последние значения с учётом сдвига `Signal Bar`.
3. Если на предыдущей свече PVT находился выше сигнальной кривой, стратегия закрывает все короткие позиции. Если при этом актуальное значение PVT меньше либо равно сигналу и разрешено открытие покупок, выполняется вход в лонг.
4. Если на предыдущей свече PVT находился ниже сигнальной кривой, закрываются все длинные позиции. Если актуальное значение PVT больше либо равно сигналу и разрешено открытие продаж, выполняется вход в шорт.
5. После открытия позиции выставляются стоп-лосс и тейк-профит на заданном расстоянии (в шагах цены), если соответствующие параметры больше нуля.
6. Новый объём рассчитывается на основе параметра `Order Volume`; при смене направления добавляется объём, необходимый для полного разворота позиции.

## Параметры
- **Order Volume** — базовый объём для сделок и разворотов.
- **Stop Loss / Take Profit** — расстояние до защитных ордеров в шагах цены (0 отключает установку).
- **Allow Buy Entry / Allow Sell Entry** — разрешение на открытие длинных и коротких позиций.
- **Allow Buy Exit / Allow Sell Exit** — автоматическое закрытие текущих позиций при противоположных сигналах.
- **Candle Type** — таймфрейм, на котором рассчитываются индикаторы.
- **Volume Source** — источник объёма (тики или реальный объём) для взвешивания PVT.
- **Smoothing Method / Length / Phase** — метод и параметры сглаживания PVT (фаза применяется только для Jurik-подобных методов).
- **Applied Price** — формула цены, подаваемой на вход PVT (close, open, DeMark и др.).
- **Signal Bar** — сдвиг по истории при оценке пересечения, соответствующий реализации MT5.

## Дополнительные замечания
- Обработка ведётся только по завершённым свечам, что обеспечивает устойчивость индикаторов.
- Вызов `StartProtection()` активирует встроенную защиту позиций StockSharp, как и в оригинальном эксперте.
- Настройка фазы Jurik выполняется через отражение; если свойство недоступно, параметр пропускается.
- При отсутствии данных по объёму стратегия использует значение 0, предотвращая накопление ошибочных сумм в PVT.
