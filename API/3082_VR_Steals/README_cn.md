# VR STEALS 跟踪止损管理器

## 来源
本策略来自 MetaTrader 5 专家顾问 **VR---STEALS** 的移植版本。原脚本只负责管理已有持仓，不会自行产生交易信号。当前实现遵循 StockSharp 的高层 API，同时保留原有的风控思路。

## 策略概览
VR STEALS 模块用于监控账户中已经建立的头寸，并执行以下三项风险控制功能：

1. **固定止损**：当价格朝不利方向运行到设定距离时立即平仓。
2. **固定止盈**：当价格向有利方向达到目标距离时锁定利润。
3. **阶梯式跟踪止损**：盈利后以固定距离跟随价格移动，分阶段上调或下调保护价位。

策略本身不会开仓，适合作为手动交易、信号复制或其他自动策略的风控组件。

## 数据要求
- 适用于 StockSharp 支持的任何标的。
- 订阅成交数据（`DataType.Ticks`），以获得与原始 MQL 程序相同的逐笔价格更新。
- 所有距离参数均使用绝对价格单位。若要复用 MetaTrader 的“点数”设置，请将点值乘以标的的 `PriceStep`。

## 参数
| 参数 | 说明 | 常见取值 |
|------|------|----------|
| `StopLossDistance` | 触发止损的绝对价差，设为 `0` 表示关闭。 | 对 EURUSD 可设 `0.0050`（约 50 点） |
| `TakeProfitDistance` | 触发止盈的绝对价差，设为 `0` 表示关闭。 | `0.0050` 或更高 |
| `TrailingStopDistance` | 跟踪止损与当前价格保持的基础距离，仅在浮动盈利时生效。 | `0.0030` |
| `TrailingStepDistance` | 每次上调/下调跟踪止损所需的最小额外收益。启用跟踪功能时必须大于 0。 | `0.0005` |

所有参数均可用于优化，根据品种波动率调节合适的值。

## 执行逻辑
1. **止损监控**
   - 多头：若 `entryPrice - lastPrice >= StopLossDistance`，发送 `SellMarket` 平仓。
   - 空头：若 `lastPrice - entryPrice >= StopLossDistance`，发送 `BuyMarket` 平仓。
2. **止盈监控**
   - 多头：满足 `lastPrice - entryPrice >= TakeProfitDistance` 时平仓。
   - 空头：满足 `entryPrice - lastPrice >= TakeProfitDistance` 时平仓。
3. **跟踪止损**
   - 只有当浮盈超过 `TrailingStopDistance + TrailingStepDistance` 时才会启动。
   - 新的保护价必须比上一次记录的位置至少靠近 `TrailingStepDistance` 才会更新。
   - 价格跌破（多头）或突破（空头）记录的保护价时立即平仓。
4. **重复下单保护**
   - 记录是否已经发送平仓指令，在仓位变化之前不会重复发单。

## 使用步骤
1. 将策略添加到 StockSharp 项目并选择目标证券。
2. 根据标的的 `PriceStep` 和波动率设置距离参数，可将 MT5 的点数换算成绝对价差。
3. 在开仓前或刚刚开仓后启动策略，它会自动接管当前持仓。
4. 启用跟踪止损时必须同时指定正值的 `TrailingStepDistance`，否则启动阶段会抛出异常，提醒用户修正配置。
5. 可与任意开仓策略组合使用，实现完整的自动化或半自动化交易流程。

## 与 MQL 版本的差异
- 不再修改经纪商端的止损订单，而是在内部存储期望的价位并通过市价单平仓。
- 使用成交数据代替独立的 Bid/Ask 流，符合 StockSharp 推荐的高阶编程方式。
- 参数采用十进制价格而非点数，需要在迁移时进行换算。
- 按仓库规范补充了详细注释和说明文档。

## 注意事项
- 若要启用跟踪止损，`TrailingStopDistance` 与 `TrailingStepDistance` 必须都大于 0。
- 平仓通过市价单实现，实际滑点取决于市场流动性。
- 策略根据 `Strategy.Position` 处理聚合仓位，多个开仓将合并计算。
- 回测时请确保成交流具有足够的时间分辨率，否则可能漏触发条件。

## 推荐扩展
- 搭配开仓策略组成完整的交易系统。
- 将每次更新的跟踪止损价格写入日志或绘制在图表上。
- 追加可选的保本机制，在达到一定利润后把止损移动到入场价附近。
