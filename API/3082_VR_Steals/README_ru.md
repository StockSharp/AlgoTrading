# Управляющий трейлинг-стопом VR STEALS

## Происхождение
Стратегия является переносом эксперта **VR---STEALS** с платформы MetaTrader 5. Оригинал занимался исключительно сопровождением уже открытых сделок и не генерировал торговых сигналов. В портированной версии логика адаптирована под высокоуровневый API StockSharp, сохраняя первоначальные торговые идеи.

## Общее описание
Модуль VR STEALS выступает как слой управления рисками поверх ваших существующих позиций. Он выполняет три функции:

1. **Фиксированный стоп-лосс** — закрывает позицию, если цена ушла против входа на заданное расстояние.
2. **Фиксированный тейк-профит** — фиксирует прибыль, когда цена прошла нужную дистанцию в благоприятную сторону.
3. **Ступенчатый трейлинг-стоп** — при росте прибыли подтягивает защитный уровень, сохраняя запас между ценой и стопом.

Стратегия не открывает сделки самостоятельно. Её можно подключить к ручной торговле, внешнему генератору сигналов или встроить в более сложную систему, делегировав ей управление стопами.

## Требования к данным
- Работает с любыми инструментами, поддерживаемыми StockSharp.
- Подписывается на сделки (`DataType.Ticks`), поскольку исходный алгоритм анализировал тиковые цены для оперативного обновления стопов.
- Дистанции задаются в абсолютных ценовых единицах. Если вы переносите настройки из MetaTrader, умножьте значение в пунктах на `PriceStep` выбранного инструмента.

## Параметры
| Параметр | Назначение | Пример значения |
|----------|------------|-----------------|
| `StopLossDistance` | Расстояние, при котором позиция закрывается с убытком. `0` отключает контроль. | `0.0050` для EURUSD (≈50 пунктов при шаге 0.0001) |
| `TakeProfitDistance` | Дистанция фиксации прибыли. `0` — без тейк-профита. | `0.0050` |
| `TrailingStopDistance` | Базовое расстояние между ценой и трейлинг-стопом. Работает только при положительной прибыли. | `0.0030` |
| `TrailingStepDistance` | Минимальный шаг, на который цена должна уйти вперёд, чтобы стоп подтянулся. При активном трейлинге должен быть > 0. | `0.0005` |

Каждый параметр доступен для оптимизации. Подбирайте значения с учётом волатильности и размера шага цены инструмента.

## Логика работы
1. **Контроль стоп-лосса**
   - Для покупок: если `entryPrice - lastPrice >= StopLossDistance`, отправляется рыночная продажа на объём позиции.
   - Для продаж: если `lastPrice - entryPrice >= StopLossDistance`, стратегия покупает для закрытия.
2. **Контроль тейк-профита**
   - Лонг закрывается при `lastPrice - entryPrice >= TakeProfitDistance`.
   - Шорт закрывается при `entryPrice - lastPrice >= TakeProfitDistance`.
3. **Трейлинг-стоп**
   - Активируется, когда прибыль превысила `TrailingStopDistance + TrailingStepDistance`.
   - Новый уровень стопа сохраняется только если он ближе к цене как минимум на `TrailingStepDistance`.
   - Если цена пересекает сохранённый уровень (ниже для лонга, выше для шорта), позиция закрывается.
4. **Защита от повторных заявок**
   - После отправки заявки на закрытие стратегия ждёт изменения позиции, прежде чем формировать новые заявки.

## Порядок применения
1. Добавьте стратегию в проект и выберите инструмент.
2. Настройте дистанции в ценовых единицах. При необходимости конвертируйте значения из пунктов.
3. Запустите стратегию до открытия сделок либо сразу после него — она автоматически подхватит текущую позицию.
4. Следите за журналом. При включённом трейлинге без положительного шага запуск завершится исключением — это повторяет проверку из MQL.
5. Используйте стратегию в паре с другими модулями, отвечающими за генерацию сигналов.

## Отличия от версии MQL
- Не происходит модификации стоп-заявок у брокера. Вместо этого расчётный уровень хранится внутри стратегии, а выход выполняется рыночной заявкой.
- Обработка ведётся по сделкам без разделения на Bid/Ask, что упрощает интеграцию с высокоуровневым API.
- Параметры определяются в ценовых величинах, а не в «пунктах».
- Добавлены подробные комментарии и документация в соответствии со стандартами репозитория.

## Ограничения и замечания
- Для работы трейлинга необходимо задать положительные `TrailingStopDistance` и `TrailingStepDistance`.
- Закрытие по рынку может сопровождаться проскальзыванием в зависимости от ликвидности.
- Управление ведётся по агрегированной позиции стратегии; если открыто несколько сделок, объёмы суммируются.
- Для точного тестирования убедитесь, что источник данных передаёт сделки с достаточной детализацией.

## Возможные расширения
- Объединить стратегию с модулем входов, чтобы получить полностью автоматизированный комплекс.
- Добавить запись уровней трейлинга в лог или на график для анализа.
- Реализовать режим переноса стопа в безубыток при достижении минимальной прибыли.
