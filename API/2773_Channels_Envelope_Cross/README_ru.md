# Стратегия Channels Envelope Cross

## Общее описание

Channels Envelope Cross — это точный перенос советника MetaTrader «Channels» на платформу StockSharp. Стратегия работает на часовом таймфрейме и отслеживает двухпериодные экспоненциальные средние (EMA) по ценам открытия и закрытия относительно трёх оболочек (0.3%, 0.7% и 1.0%), построенных вокруг медленной EMA с периодом 220. Пробои быстрой EMA через границы оболочек формируют торговые сигналы, а опциональный фильтр по времени ограничивает торговлю заданным интервалом часов.

## Логика работы

1. **Набор индикаторов**
   - Быстрая EMA (период 2) по ценам закрытия свечи.
   - Быстрая EMA (период 2) по ценам открытия свечи.
   - Медленная EMA (период 220) по ценам закрытия.
   - Верхние и нижние границы оболочек, рассчитанные от медленной EMA с отклонениями 0.3%, 0.7% и 1.0%.
2. **Условия для покупки**
   - Срабатывают, когда быстрая EMA по закрытию пробивает снизу-вверх нижние границы оболочек 1.0% или 0.7%, остаётся ниже нижней границы 0.3% две свечи подряд, пересекает медленную EMA или пробивает верхние границы 0.3%/0.7%. Любое из условий открывает длинную позицию при отсутствии открытых сделок.
3. **Условия для продажи**
   - Срабатывают, когда быстрая EMA по открытию пробивает сверху-вниз любую из верхних оболочек, опускается ниже медленной EMA или пересекает нижние границы сверху-вниз. Любое из условий открывает короткую позицию, если нет активной позиции.
4. **Управление рисками**
   - Фиксированные стоп-лоссы и тейк-профиты задаются в пунктах отдельно для лонгов и шортов. Значение «0» отключает соответствующий уровень.
   - Независимые трейлинг-стопы для длинных и коротких позиций подтягивают защитный стоп, когда прибыль превышает расстояние трейлинга плюс минимальный шаг.
5. **Фильтр по времени**
   - При включении стратегиия проверяет час открытия свечи и допускает новые входы только в пределах указанного диапазона (включительно). Управление открытыми позициями продолжается всегда.

## Параметры

| Параметр | Значение |
|----------|----------|
| `OrderVolume` | Объём сделки (лоты/контракты). |
| `UseTradeHours` | Включает фильтр торговых часов. |
| `FromHour` / `ToHour` | Начальный и конечный час торгового окна (поддерживается переход через полночь). |
| `StopLossBuyPips` / `StopLossSellPips` | Размер стоп-лосса в пунктах для лонга/шорта. |
| `TakeProfitBuyPips` / `TakeProfitSellPips` | Размер тейк-профита в пунктах для лонга/шорта. |
| `TrailingStopBuyPips` / `TrailingStopSellPips` | Дистанция трейлинг-стопа в пунктах для лонга/шорта. |
| `TrailingStepPips` | Минимальный шаг изменения трейлинг-стопа (в пунктах). |
| `CandleType` | Тип свечей, используемых в расчётах (по умолчанию — часовые). |

## Управление позициями

- При открытии позиции фиксируется цена входа, рассчитываются уровни стоп-лосса и тейк-профита в абсолютных ценах, трейлинг-стоп сбрасывается.
- Для длинных позиций стоп подтягивается выше, когда прибыль превышает сумму `TrailingStopBuyPips + TrailingStepPips`. Закрытие происходит по стопу или тейк-профиту — что наступит раньше.
- Для коротких позиций стоп опускается ниже при аналогичном условии, закрытие выполняется симметрично.

## Дополнительные замечания

- Размер пункта определяется по шагу цены инструмента; для инструментов с тремя или пятью знаками после запятой пункт умножается на десять, как в оригинальном советнике.
- Стратегия работает только с одной позицией одновременно: новый вход возможен после полного закрытия предыдущего.
- Метод `StartProtection()` уже активирован, что защищает от «зависших» позиций после перезапуска.
