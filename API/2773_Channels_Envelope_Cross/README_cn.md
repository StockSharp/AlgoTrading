# Channels Envelope Cross 策略

## 概述

Channels Envelope Cross 策略是 MetaTrader 平台上 "Channels" 智能交易系统的完全移植版本。策略在 1 小时 K 线上运行，计算两条周期为 2 的指数移动平均线（EMA），分别基于开盘价和收盘价，并与由 220 周期 EMA 构建的三条价格通道（偏离度 0.3%、0.7%、1.0%）进行比较。当快速 EMA 突破这些通道时产生交易信号，另外可以启用时间过滤器，将交易限制在指定的小时范围内。

## 交易逻辑

1. **指标体系**
   - 快速 EMA（周期 2，使用收盘价）。
   - 快速 EMA（周期 2，使用开盘价）。
   - 慢速 EMA（周期 220，使用收盘价）。
   - 以慢速 EMA 为基准的三组包络线（±0.3%、±0.7%、±1.0%）。
2. **做多条件**
   - 当收盘价 EMA 向上突破 1.0% 或 0.7% 的下轨、连续两根 K 线位于 0.3% 下轨之下、向上突破慢速 EMA，或突破 0.3%/0.7% 上轨时，在当前没有持仓的情况下建立多头。
3. **做空条件**
   - 当开盘价 EMA 向下突破任意一条上轨、跌破慢速 EMA，或从上向下穿越下轨时，在没有持仓时建立空头。
4. **风控管理**
   - 多头和空头可分别设置固定的止损和止盈，单位为点（pip）。当参数为 0 时，表示不启用该水平。
   - 多、空分别拥有独立的追踪止损，只有当浮动利润超过“追踪距离 + 最小步长”时才会上调/下调保护性止损。
5. **时间过滤**
   - 启用后，策略仅在设定的小时区间（包含端点，支持跨日）内产生新的入场信号；已开仓的头寸仍会被持续管理。

## 参数说明

| 参数 | 说明 |
|------|------|
| `OrderVolume` | 每次下单的数量（手数或合约数）。 |
| `UseTradeHours` | 是否启用交易时间过滤。 |
| `FromHour` / `ToHour` | 允许交易的起始和结束小时（可跨越午夜）。 |
| `StopLossBuyPips` / `StopLossSellPips` | 多/空仓位的止损距离（点）。 |
| `TakeProfitBuyPips` / `TakeProfitSellPips` | 多/空仓位的止盈距离（点）。 |
| `TrailingStopBuyPips` / `TrailingStopSellPips` | 多/空追踪止损的基础距离（点）。 |
| `TrailingStepPips` | 调整追踪止损所需的最小点数增量。 |
| `CandleType` | 计算所使用的蜡烛类型（默认 1 小时）。 |

## 仓位管理

- 建仓时记录进场价格，换算出止损和止盈的绝对价格，并重置追踪止损。
- 多头持仓时，如果利润超过 `TrailingStopBuyPips + TrailingStepPips`，止损会向上移动；若价格回落到止损或上涨至止盈则平仓。
- 空头持仓时采用对称逻辑：利润达到阈值后向下移动止损，触发止损或止盈即退出。

## 其他说明

- 策略根据品种的最小价格跳动计算点值。若证券价格保留 3 或 5 位小数，则点值乘以 10，以匹配原始 MQL 实现。
- 同一时间只持有一个方向的仓位。必须先平仓，才会发出新的入场信号。
- 代码中已调用 `StartProtection()`，以防止重启后出现意外持仓。
