# Cs2011 策略

## 概述
Cs2011 策略改编自原始的 `cs2011.mq5` 专家顾问，是一套基于 MACD 的反转系统。它在每根完成的 K 线收盘时检查 MACD 柱状图与信号线，寻找零轴附近的衰竭形态。C# 版本保持了核心的触发条件，并使用 StockSharp 的高级 API 进行封装。

## 交易逻辑
- **零轴反转**：如果上一根柱子的 MACD 值大于 0 而再前一根小于 0，则触发 **做空** 信号；若上一根小于 0 而再前一根大于 0，则触发 **做多** 信号。这与原版 EA 中的逆势入场规则一致。
- **信号线极值**：策略保存最近三次信号线读数。当 MACD 持续为负且信号线形成局部峰值时，产生额外的空头信号；当 MACD 持续为正且信号线形成局部谷值时，产生额外的多头信号。这复刻了源代码中对 `Sig[0]`、`Sig[1]`、`Sig[2]` 的判断。
- 只有 `SubscribeCandles` 提供的已完成 K 线会被处理，未收盘的数据会被忽略。

## 仓位管理
- 策略以固定的绝对仓位 `TargetVolume` 为目标。出现多头信号时买入至 `+TargetVolume`，出现空头信号时卖出至 `-TargetVolume`。如果当前仓位已经达到目标，则不会下达额外委托。
- `StartProtection` 用于还原原 EA 的止盈和止损设置。参数以点数表示，并转换为 `UnitTypes.Point` 后交给 StockSharp 的风险模块；参数为 `0` 时相应保护被关闭。
- 订单通过高级方法 `BuyMarket` / `SellMarket` 完成，不再使用 MQL 中的底层请求结构。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `TargetVolume` | `1` 手 | 每次触发后的目标绝对仓位，替代 EA 中基于 `Risk` × 余额的头寸算法。 |
| `TakeProfitPoints` | `2200` | 以点数表示的止盈距离，设为 `0` 可禁用。 |
| `StopLossPoints` | `0` | 以点数表示的止损距离，默认禁用，与原 EA 一致。 |
| `FastEmaPeriod` | `30` | MACD 快速 EMA 的周期。 |
| `SlowEmaPeriod` | `500` | MACD 慢速 EMA 的周期。 |
| `SignalPeriod` | `36` | MACD 信号线的平滑周期。 |
| `CandleType` | 1 小时时间框架 | `SubscribeCandles` 使用的 K 线类型，可根据 MetaTrader 的图表周期调整。 |

所有参数都通过 `Param()` 注册，因此可以在 StockSharp 优化器界面中进行回测和优化。

## 与 MQL5 版本的差异
- 原版的 `Money_M` 函数依赖账户历史成交与余额，C# 版本改为简单的 `TargetVolume` 参数，方便接入任何自定义资金管理方案。
- 下单逻辑精简为单笔市价单，重试、价差和交易上下文检查由 StockSharp 基础设施负责。
- 策略基于蜡烛订阅运行，取代了自定义的 `IsNewBar` 函数，确保只处理完整的 K 线。

## 使用建议
1. 启动前配置交易标的、投资组合和所需的 `CandleType`。
2. 根据目标手数调整 `TargetVolume`。
3. 需要时修改 `TakeProfitPoints` 与 `StopLossPoints` 以还原 EA 的保护参数。
4. 启动策略后，可通过日志查看每次触发的方向及目标仓位。

源代码包含英文注释，解释移植过程中每一步的处理方式。
