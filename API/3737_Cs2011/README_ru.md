# Стратегия Cs2011

## Общее описание
Cs2011 — это реверсивная система, портированная из оригинального эксперта `cs2011.mq5`. Стратегия отслеживает гистограмму MACD и сигнальную линию на каждой завершённой свече, ищет разворотные паттерны возле нулевой отметки и реализована через высокоуровневый API StockSharp.

## Логика входов
- **Развороты на нулевой линии.** Если значение MACD на предыдущей свече было положительным, а ещё на свечу раньше — отрицательным, формируется сигнал на **продажу**. Обратная ситуация (от положительного к отрицательному) даёт сигнал на **покупку**. Это повторяет контртрендовые условия оригинального советника.
- **Экстремумы сигнальной линии.** Хранятся три последних значения линии сигнала. При сохранении отрицательного MACD и образовании локального максимума генерируется дополнительный шорт; при положительном MACD и локальном минимуме — лонг. Так воспроизводятся проверки массивов `Sig[0]`, `Sig[1]`, `Sig[2]` из MQL5.
- Обработка выполняется только по завершённым свечам, которые поступают через `SubscribeCandles`.

## Управление позицией
- Стратегия стремится к фиксированному абсолютному размеру позиции `TargetVolume`. При бычьем сигнале открывается лонг до `+TargetVolume`, при медвежьем — шорт до `-TargetVolume`. Если текущая позиция уже равна цели, дополнительные заявки не выставляются.
- Метод `StartProtection` переводит значения стоп-лосса и тейк-профита (в пунктах) в объекты `UnitTypes.Point` и передаёт их в встроенный модуль защиты. Нулевые значения отключают соответствующие барьеры, как и в оригинале.
- Для сделок используются высокоуровневые вызовы `BuyMarket` и `SellMarket` вместо ручного заполнения торгового запроса.

## Параметры
| Название | Значение по умолчанию | Назначение |
| --- | --- | --- |
| `TargetVolume` | `1` лот | Желаемый абсолютный объём после сигнала. Заменяет функцию `Risk` × баланс из MQL5. |
| `TakeProfitPoints` | `2200` | Дистанция тейк-профита в пунктах. `0` — без тейк-профита. |
| `StopLossPoints` | `0` | Дистанция стоп-лосса в пунктах. По умолчанию выключен, как в оригинале. |
| `FastEmaPeriod` | `30` | Период быстрой EMA в MACD. |
| `SlowEmaPeriod` | `500` | Период медленной EMA в MACD. |
| `SignalPeriod` | `36` | Период сглаживания сигнальной линии. |
| `CandleType` | Таймфрейм 1 час | Тип свечей, подаваемых через `SubscribeCandles`. При необходимости подберите под используемый график. |

Все параметры зарегистрированы через `Param()`, поэтому доступны для оптимизации и бэктестов в интерфейсе StockSharp.

## Отличия от MQL5 реализации
- Функция `Money_M` в MetaTrader опиралась на историю сделок и баланс счёта. В StockSharp она заменена параметром `TargetVolume`, что упрощает интеграцию собственных алгоритмов мани-менеджмента.
- Торговые запросы сведены к одиночным рыночным заявкам. Проверки отклонений, повторные попытки и прочие сервисные задачи обрабатываются инфраструктурой платформы.
- Вместо самописной проверки `IsNewBar` используется подписка на свечи, поэтому сигналы рассчитываются только на полностью сформированных барах.

## Рекомендации по использованию
1. Перед стартом выберите инструмент, портфель и желаемый `CandleType`.
2. Установите `TargetVolume` согласно необходимому объёму сделки.
3. При необходимости скорректируйте `TakeProfitPoints` и `StopLossPoints`, чтобы повторить защитные уровни оригинала.
4. Запустите стратегию и контролируйте сообщения лога — они фиксируют каждое срабатывание и целевой размер позиции.

В исходниках оставлены комментарии на английском языке, объясняющие ключевые этапы портирования.
