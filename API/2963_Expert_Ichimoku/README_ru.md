# Экспертная стратегия Ichimoku

## Обзор

Стратегия Expert Ichimoku представляет собой перенос оригинального советника MQL5 "Expert Ichimoku" на инфраструктуру StockSharp. Модель относится к трендовым системам: она анализирует индикатор Ichimoku Kinko Hyo, оценивает характер предыдущей свечи и при необходимости удваивает объём после убыточной сделки (опционально, в духе мартингейла).

Расчёты выполняются только на закрытых свечах выбранного таймфрейма. Стратегия работает с одной чистой позицией: при смене направления текущая позиция закрывается рыночной заявкой и лишь затем открывается противоположная. Вся информация берётся из подписки на свечи, дополнительные источники данных не требуются.

## Логика работы

### Настройка индикатора

* **Tenkan-sen (конверсионная линия)** — быстрый компонент для отслеживания пересечений.
* **Kijun-sen (базовая линия)** — медленный компонент, образующий сигнал пересечения.
* **Senkou Span A / B** — границы облака, оцениваемые по предыдущей свече для фильтрации тренда.
* **Chikou Span (запаздывающая линия)** — подтверждает импульс прорывом относительно исторических цен.

Длины линий по умолчанию совпадают с настройками советника: 9 / 26 / 52 и могут изменяться пользователем.

### Правила входа

**Покупка** выполняется, если соблюдены все условия:

1. **Импульс**: либо Tenkan пересекает Kijun снизу вверх на последней закрытой свече, либо Chikou пробивает выше цены 10–11 свечей назад.
2. **Позиция цены относительно облака**: текущая цена закрытия находится выше обеих линий Senkou на предыдущей свече (цена выше облака).
3. **Характер предыдущей свечи**: свеча t-1 закрылась ростом (Close<sub>t-1</sub> > Open<sub>t-1</sub>).
4. **Позиционный фильтр**: нет активной длинной позиции. Если была короткая, она закрывается перед открытием новой длинной.

**Продажа** симметрична:

1. Tenkan пересекает Kijun сверху вниз или Chikou уходит ниже исторической цены (используются открытия свечей для проверки).
2. Текущая цена закрытия ниже обеих Senkou (цена ниже облака).
3. Предыдущая свеча медвежья (Close<sub>t-1</sub> < Open<sub>t-1</sub>).
4. Перед открытием короткой позиции закрываются все длинные объёмы.

### Управление объёмом

* Базовый объём равен свойству `Volume` стратегии.
* Если включена опция **Use Martingale**, следующий вход после убыточного выхода выполняется удвоенным объёмом. Прибыль или отсутствие потерь сбрасывают множитель.
* Итоговый объём ограничивается значением `Volume × Max Position Multiplier`, что соответствует ограничению по количеству одновременно открытых позиций в оригинальном советнике.

### Управление риском

* **Фиксированный стоп-лосс и тейк-профит** задаются абсолютным отступом от цены входа. Значение 0 отключает соответствующий уровень.
* **Трейлинг-стоп** активируется, если заданы ненулевые `Trailing Stop Offset` и `Trailing Step`. Стоп подтягивается только после того, как цена прошла расстояние `offset + step` в сторону прибыли, точно так же как в версии MQL5.
* После закрытия позиции рассчитывается фактический результат, чтобы определить, нужно ли удваивать объём на следующем сигнале.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| Tenkan Period | Длина линии Tenkan-sen. | 9 |
| Kijun Period | Длина линии Kijun-sen. | 26 |
| Senkou Span B Period | Длина Senkou Span B. | 52 |
| Stop Loss Offset | Абсолютное расстояние до стоп-лосса, 0 — отключён. | 0 |
| Take Profit Offset | Абсолютное расстояние до тейк-профита, 0 — отключён. | 0 |
| Trailing Stop Offset | Базовое расстояние трейлинг-стопа. | 0 |
| Trailing Step | Минимальное дополнительное движение для подтягивания стопа. | 0 |
| Max Position Multiplier | Максимальный множитель объёма относительно `Volume`. | 5 |
| Use Martingale | Включить удвоение объёма после убыточной сделки. | true |
| Candle Type | Таймфрейм используемых свечей. | 1 час |

## Практические рекомендации

* Для полноценной работы требуется не менее 12 закрытых свечей — проверки по Chikou используют цены до 11 баров назад.
* Поскольку StockSharp оперирует чистой позицией, параметр `Max Position Multiplier` ограничивает максимальный объём ордера вместо ведения нескольких отдельных сделок.
* Если трейлинг-стоп выключен (один из параметров равен 0), уровни не корректируются. При ненулевых значениях стоп смещается ступенчато при превышении порога `offset + step`.
* Все события входа/выхода выводятся в журнал, что облегчает анализ на исторических данных.

## Порядок использования

1. Настройте инструмент и таймфрейм свечей в контейнере стратегии или дизайнере.
2. Укажите базовый `Volume` и переведите точки (pip) из оригинальной версии в абсолютные ценовые отступы для выбранного рынка.
3. Запустите стратегию. После накопления достаточной истории индикатор будет анализировать каждый завершённый бар, автоматически управляя позициями, стопами и опциональным удвоением объёма.

