# N Candles v5 策略

## 概述
N Candles v5 策略会寻找连续同向的蜡烛，并在满足条件时沿同一方向开仓。
原始的 MQL 版本由 Vladimir Karputov 编写，此处将其迁移到 StockSharp 的
高级 API。策略仅处理已完成的蜡烛，可用于任意时间框架，默认使用 1 小时
K 线。

## 交易逻辑
1. 每根蜡烛收盘后，策略判断其为阳线（收盘价高于开盘价）、阴线
   （收盘价低于开盘价）或横盘（收盘价等于开盘价）。
2. 连续阳线会增加多头计数并重置空头计数，连续阴线则相反；横盘蜡烛
   会将两个计数同时归零。
3. 当阳线计数达到 `CandlesCount` 且当前净持仓为零或为空头时，策略按
   市价买入。若存在空头仓位，会先行平仓，再按照 `TradeVolume` 建立多头。
4. 当阴线计数达到 `CandlesCount` 且当前净持仓为零或为多头时，策略按
   市价卖出。若存在多头仓位，会先平仓，再建立空头。
5. 只有在启用 `UseTradingHours` 并且时间位于 `StartHour` 与 `EndHour`
   之间时才允许新开仓。止盈、止损和追踪止损在时段之外仍然生效，以保证
   风险控制。
6. `MaxNetVolume` 限制了绝对仓位规模，避免持仓超过指定上限，保持了
   原版脚本的风险约束。

## 风险控制
- **止盈 / 止损** – 以点数表示，根据标的的价格步长转换为绝对价格。
  将数值设为 0 可关闭对应功能。
- **追踪止损** – 当价格相对入场价移动 `TrailingStopPips` 点时激活，之后
  每当价格再前进 `TrailingStepPips` 点就会收紧止损水平。
- **交易时段过滤** – `UseTradingHours` 打开后，策略仅在指定时段内开仓，
  但会在任意时间继续处理已有仓位的风险。
- **最大净仓位** – 绝对持仓不会超过 `MaxNetVolume`。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `TradeVolume` | 新开仓时使用的交易量。 | `1` |
| `CandlesCount` | 触发信号所需的连续同向蜡烛数量。 | `3` |
| `TakeProfitPips` | 止盈距离（点），0 表示关闭。 | `50` |
| `StopLossPips` | 止损距离（点），0 表示关闭。 | `50` |
| `TrailingStopPips` | 激活追踪止损的距离（点），0 表示关闭。 | `10` |
| `TrailingStepPips` | 收紧追踪止损所需的追加移动距离（点）。 | `4` |
| `UseTradingHours` | 是否启用交易时段过滤。 | `true` |
| `StartHour` | 允许开仓的起始小时（0–23）。 | `11` |
| `EndHour` | 允许开仓的结束小时（0–23）。 | `18` |
| `MaxNetVolume` | 允许的最大净仓位规模。 | `2` |
| `CandleType` | 用于分析的蜡烛类型，默认 1 小时。 | `TimeSpan.FromHours(1)` |

## 使用建议
- 策略通过 `SubscribeCandles` 订阅蜡烛数据，适用于提供蜡烛序列的任何市场
  品种。
- 由于逻辑基于已收盘蜡烛，在噪声较低的日内或更高级别时间框架上表现更
  稳定。
- 根据标的的最小价格变动和点差调整止盈、止损与追踪参数，避免过度紧密。
- 在点差波动较大的品种上运行时，建议先用历史数据验证追踪止损设置，防止
  因正常波动而提前出场。

