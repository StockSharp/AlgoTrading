# Exp Color PEMA Digit TM Plus MMRec Duplex (C#)

## Общее описание
Стратегия воспроизводит советник «Exp_ColorPEMA_Digit_Tm_Plus_MMRec_Duplex» на платформе StockSharp и использует высокоуровневый API. Для лонгов и шортов строятся независимые потоки пятиступенчатой экспоненциальной средней (PEMA), причём для каждого потока можно задать собственный таймфрейм и тип цены. Лонговый модуль открывает сделки при переходе наклона PEMA в бычью зону, шортовый — при появлении медвежьего наклона. Дополнительно реализован таймер, который закрывает позицию по истечении заданного количества минут.

## Индикаторы
* **Pentuple EMA** — каскад из восьми экспоненциальных средних одинаковой длины, комбинируемых коэффициентами 8, -28, 56, -70, 56, -28, 8, -1. Индикатор возвращает текущее и предыдущее значение для оценки направления наклона.
* **Цветовая логика** — наклон переводится в три состояния (вверх, вниз, нейтрально), что повторяет работу оригинального индикатора ColorPEMA.

## Генерация сигналов
### Лонговый модуль
1. Ожидает закрытия свечи выбранного таймфрейма.
2. Рассчитывает PEMA с учётом выбранного типа цены и количества знаков округления.
3. Анализирует цвет `SignalBar` свечей назад и сравнивает его с предыдущим значением.
4. **Вход**: при смене цвета на `Up` и разрешённом входе выполняется покупка с объёмом `TradeVolume`, фиксируется время входа.
5. **Выход**: при появлении цвета `Down` позиция закрывается, если разрешены выходы по индикатору.
6. **Таймер**: если позиция открыта дольше `LongTimeExitMinutes`, она закрывается независимо от индикаторных условий.

### Шортовый модуль
Работает аналогично:
1. Обрабатывает свечи шортового таймфрейма.
2. Строит поток короткой PEMA.
3. Проверяет цвет `ShortSignalBar` свечей назад.
4. **Вход**: при переходе цвета в `Down` выполняется продажа, если она разрешена.
5. **Выход**: цвет `Up` инициирует закрытие шорта при включенных выходах.
6. **Таймер**: превышение `ShortTimeExitMinutes` приводит к принудительному закрытию.

## Управление рисками
* Объём заявок задаётся параметром `TradeVolume`.
* Параметры `StopLossSteps` и `TakeProfitSteps` (в шагах цены) активируют защитный модуль `StartProtection` и имитируют блок управления капиталом из MQL-версии.
* Отдельные таймеры для лонгов и шортов не позволяют сделкам оставаться в рынке слишком долго.

## Параметры
| Параметр | Описание |
|----------|----------|
| `LongCandleType` | Таймфрейм для лонгового потока. |
| `ShortCandleType` | Таймфрейм для шортового потока. |
| `LongEmaLength`, `ShortEmaLength` | Длина сглаживания PEMA (поддерживаются дробные значения). |
| `LongPriceMode`, `ShortPriceMode` | Тип цены для каждого потока (close, open, high, low, median, typical, weighted, simple, quarter, trend-following, Demark). |
| `LongDigits`, `ShortDigits` | Количество знаков округления PEMA. |
| `LongSignalBar`, `ShortSignalBar` | Сколько завершённых свечей учитывать при анализе цвета. |
| `LongAllowOpen`, `ShortAllowOpen` | Разрешение на входы. |
| `LongAllowClose`, `ShortAllowClose` | Разрешение на выходы по индикатору. |
| `LongAllowTimeExit`, `ShortAllowTimeExit` | Включение таймера по времени удержания. |
| `LongTimeExitMinutes`, `ShortTimeExitMinutes` | Максимальное время удержания позиции (в минутах). |
| `TradeVolume` | Базовый объём сделок. |
| `StopLossSteps`, `TakeProfitSteps` | Дистанции стоп-лосса и тейк-профита в шагах цены. |

## Примечания
* Если оба таймфрейма совпадают, StockSharp использует один поток свечей для обоих модулей.
* Лонговый и шортовый блоки работают независимо, но используют общую настройку инструмента и объёма.
* Расчёт индикатора выполняется только на закрытых свечах, что исключает перерисовку.
