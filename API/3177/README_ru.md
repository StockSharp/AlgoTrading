# Стратегия iMA iStochastic Custom

## Общая информация
Стратегия переносит советника **iMA iStochastic Custom** из MetaTrader в экосистему StockSharp. Она использует комбинированный сигнал: ценовой канал на основе скользящей средней и фильтр по стохастическому осциллятору. Все расчёты выполняются на закрытых свечах указанного таймфрейма (`CandleType`). Ниже сохранена терминология оригинального робота.

Основные блоки:

1. **Канал скользящей средней** – базовая средняя смещается на `LevelUpPips` и `LevelDownPips` (в пунктах), формируя верхнюю и нижнюю границы. Доступны те же методы расчёта, что и в MT5: простая, экспоненциальная, сглаженная (SMMA) и линейно-взвешенная.
2. **Стохастический осциллятор** – параметры %K, %D и сглаживание совпадают с MQL-входами, а уровни `StochasticLevel1` и `StochasticLevel2` задают фильтры перекупленности/перепроданности.
3. **Управление капиталом** – флаг `ManagementMode` повторяет выбор между фиксированным лотом и риском в процентах. В режиме `RiskPercent` объём вычисляется по формуле `Equity * VolumeValue / 100 / perUnitRisk`, что эквивалентно поведению класса `CMoneyFixedMargin`.
4. **Защитные механизмы** – стоп-лосс, тейк-профит и трейлинг задаются в пунктах и проверяются на каждой закрытой свече. Трейлинг срабатывает после движения цены на `TrailingStopPips` и требует дополнительного улучшения не менее `TrailingStepPips` перед каждой корректировкой.

## Логика входа
Правила симметричны для длинных и коротких позиций:

- **Покупка**: закрытие свечи выше верхней границы (`ma + LevelUpPips`) и хотя бы одна линия стохастика выше `StochasticLevel1`.
- **Продажа**: закрытие свечи ниже нижней границы (`ma + LevelDownPips`) и хотя бы одна линия стохастика ниже `StochasticLevel2`.
- Параметр `ReverseSignals` инвертирует направление сделок.

В рынке удерживается только одна суммарная позиция. При смене сигнала стратегия выставляет заявку, перекрывающую текущий объём и открывающую позицию противоположного знака.

## Риск-менеджмент и выходы
- **Стоп-лосс / тейк-профит** – конвертируются из пунктов через `PriceStep` и контролируются по минимуму/максимуму текущей свечи.
- **Трейлинг-стоп** – активируется после прохождения `TrailingStopPips` и сдвигается лишь при дополнительном прогрессе минимум на `TrailingStepPips`.
- **Размер позиции** – в режиме риска процент вычисляется на основе текущей/стартовой стоимости портфеля. При нулевом стоп-лоссе объём равен нулю, что совпадает с оригинальным поведением.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Таймфрейм свечей. |
| `StopLossPips`, `TakeProfitPips` | Расстояния защитных ордеров в пунктах. |
| `TrailingStopPips`, `TrailingStepPips` | Параметры трейлинг-стопа, 0 отключает. |
| `ManagementMode`, `VolumeValue` | Режим расчёта объёма: фиксированный лот или риск в процентах. |
| `MaPeriod`, `MaShift`, `MaMethod` | Период, сдвиг и метод скользящей средней. |
| `LevelUpPips`, `LevelDownPips` | Смещения верхней/нижней границы канала (возможны отрицательные значения). |
| `StochasticKPeriod`, `StochasticDPeriod`, `StochasticSlowing` | Настройки стохастика. |
| `StochasticLevel1`, `StochasticLevel2` | Пороговые уровни подтверждения. |
| `ReverseSignals` | Обратная логика сигналов. |

## Особенности реализации
- Используется высокоуровневое API (`SubscribeCandles().BindEx(...)`), что избавляет от ручной работы с буферами индикаторов.
- Размер пункта автоматически адаптируется к инструментам с 3/5 знаками после запятой (при необходимости умножается на 10).
- Трейлинг и защитные условия рассчитываются на закрытых свечах, что упрощает бэктест и повторяемость результатов. Для внутрибарного трейлинга можно подписаться на поток тиков.
- По требованию отсутствует Python-версия, директория `PY` не создаётся.

## Отличия от оригинала
- Класс `CMoneyFixedMargin` заменён прозрачной формулой с использованием портфельной оценки и параметров инструмента. Логика полностью повторяет MT5 вплоть до блокировки сделок без стоп-лосса.
- Проверка стопов и трейлинга происходит по экстремумам свечи. В терминах StockSharp это единственный универсальный вариант, работающий и в тестах, и в реальном времени.
- Параметр `InpPrintLog` убран, так как StockSharp предоставляет встроенную систему логирования.

Стратегию можно сразу запускать в StockSharp Designer/Runner и использовать как исходную заготовку для дальнейшей адаптации под конкретные инструменты.
