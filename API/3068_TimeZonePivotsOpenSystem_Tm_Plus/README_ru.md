# Стратегия Exp TimeZone Pivots Open System Tm Plus
[English](README.md) | [中文](README_cn.md)

Стратегия представляет собой перенос советника **Exp_TimeZonePivotsOpenSystem_Tm_Plus** на высокоуровневый API StockSharp. В коде восстановлен индикатор *TimeZonePivotsOpenSystem*: на основе цены открытия сессии строятся верхняя и нижняя зоны пробоя, а сделки выполняются при возврате цены после выхода за границы. Все элементы оригинала — задержка сигнала, ограничение по времени удержания, асимметричное закрытие позиций и режимы мани-менеджмента — вынесены в параметры, что позволяет добиться поведения, максимально близкого к версии MQL5.

## Логика торговли

1. В момент, когда `StartHour` совпадает с часом новой свечи, фиксируется цена открытия сессии. На расстоянии `OffsetPoints` (в пунктах) вверх и вниз строятся динамические уровни.
2. Если закрывшаяся свеча оказалась **выше** верхнего уровня:
   - Планируется вход в длинную позицию на следующей свече (с учётом задержки `SignalBar`), но только если текущая свеча уже не находится выше зоны.
   - Немедленно закрывается короткая позиция, если разрешено `SellPosClose`.
3. Если закрывшаяся свеча ушла **ниже** нижнего уровня:
   - Планируется вход в короткую позицию на следующей свече при условии, что текущая свеча больше не находится ниже зоны.
   - Немедленно закрывается длинная позиция, если активирован `BuyPosClose`.
4. Входы исполняются при первом обновлении новой свечи в методе `TryExecutePendingEntries`, что соответствует оригинальному советнику, откладывающему заявку до начала нового бара.

Параметр `SignalBar` воспроизводит смещение `CopyBuffer`: значение `0` реагирует на последнюю закрытую свечу, а `1` (значение по умолчанию) добавляет одну свечу ожидания для дополнительного подтверждения.

## Управление позициями

* **Стоп и тейк-профит** — `StopLossPoints` и `TakeProfitPoints` задаются в пунктах, пересчитываются в цену с учётом шага цены инструмента и контролируются по экстремумам свечей, поэтому срабатывают даже при внутрисвечном касании.
* **Временной фильтр** — при `TimeTrade = true` позиция закрывается по истечении `HoldingMinutes`, как и таймер `nTime` в MQL5.
* **Принудительное закрытие** — пробой противоположной зоны закрывает открытую позицию, если включены флаги `BuyPosClose` или `SellPosClose`.

## Мани-менеджмент

Параметр `MoneyMode` соответствует перечислению `MarginMode` из оригинала:

- `Lot` — фиксированный объём, равный `MoneyManagement`.
- `Balance` и `FreeMargin` — доля от капитала или свободной маржи (`MoneyManagement * капитал / цена`).
- `LossBalance` и `LossFreeMargin` — риск-ориентированное вычисление, делящее желаемую долю капитала на расстояние до стоп-лосса.

Если `StopLossPoints = 0`, риск-режимы автоматически переключаются на расчёт от цены, чтобы избежать деления на ноль.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `MoneyManagement` | Базовый коэффициент объёма, используемый в выбранном режиме `MoneyMode`. | `0.1` |
| `MoneyMode` | Тип расчёта объёма (`Lot`, `Balance`, `FreeMargin`, `LossBalance`, `LossFreeMargin`). | `Lot` |
| `StopLossPoints` | Расстояние до стоп-лосса в пунктах. | `1000` |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах. | `2000` |
| `DeviationPoints` | Информационный параметр из оригинала (допустимое проскальзывание). | `10` |
| `BuyPosOpen` / `SellPosOpen` | Разрешение на открытие длинных и коротких позиций. | `true` |
| `BuyPosClose` / `SellPosClose` | Разрешение на закрытие позиций противоположным сигналом. | `true` |
| `TimeTrade` | Включение ограничения по времени удержания. | `true` |
| `HoldingMinutes` | Максимальное время удержания позиции в минутах. | `720` |
| `OffsetPoints` | Смещение уровней относительно цены открытия сессии в пунктах. | `200` |
| `SignalBar` | Количество свечей задержки сигнала (0 — последняя закрытая свеча). | `1` |
| `CandleType` | Таймфрейм, на котором рассчитывается индикатор. | `TimeSpan.FromHours(1).TimeFrame()` |
| `StartHour` | Час (0–23), фиксирующий цену открытия сессии. | `0` |

## Рекомендации по применению

- Необходимо, чтобы инструмент предоставлял корректный `PriceStep`. При его отсутствии используется запасное значение `0.0001`.
- Вход выполняется на первом тике новой свечи, поэтому фактическая цена исполнения будет рыночной и может отличаться от теоретического открытия при резких движениях.
- Для визуального совпадения с индикатором MQL5 используйте таймфреймы не выше H1.
- Значение `SignalBar = 0` делает стратегию более чувствительной, а `1` добавляет паузу для подтверждения пробоя.

