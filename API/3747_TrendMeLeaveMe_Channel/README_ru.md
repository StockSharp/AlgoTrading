# Стратегия отложенных ордеров TrendMeLeaveMe
[English](README.md) | [中文](README_cn.md)

Эта реализация StockSharp повторяет логику советника MetaTrader «TrendMeLeaveMe». Изначально трейдер вручную рисовал наклонный трендовый канал и выставлял отложенные стоп-ордера, когда цена прижималась к линии тренда. В версии для StockSharp центральная линия канала пересчитывается автоматически при помощи индикатора линейной регрессии, а смещения верхней и нижней границ воспроизводят те же шаги по цене, что использовались в MQL.

Стратегия умеет работать как в лонг, так и в шорт. После срабатывания отложенного ордера позиция немедленно защищается фиксированными уровнями стоп-лосса и тейк-профита, соответствующими параметрам оригинального советника. Заявки постоянно обновляются, чтобы уровни входа следовали за текущим значением регрессионной линии.

## Как это работает

1. Подписка на свечи рассчитывает индикатор `LinearRegression`, который служит центральной трендовой линией.
2. Трейдер задаёт четыре смещения (верх/низ для покупок и продаж) в шагах цены инструмента. Стратегия переводит их в абсолютные ценовые уровни.
3. Если последняя свеча закрывается между линией тренда и заданным нижним смещением, на верхней границе размещается buy stop. Симметрично, когда цена закрывается между линией и верхним смещением, на нижней границе ставится sell stop.
4. Когда рынок выходит за пределы активационной зоны, соответствующий отложенный ордер отменяется, чтобы не загромождать стакан.
5. После исполнения стоп-ордера для позиции создаются статические стоп-лосс и тейк-профит с теми же расстояниями в шагах цены, что и в версии для MetaTrader.

## Торговые сигналы

- **Покупка**: закрытие свечи не выше регрессионной линии, но выше buy lower offset. Buy stop выставляется на уровне верхнего смещения и двигается вслед за линией, пока условие выполняется.
- **Продажа**: закрытие свечи не ниже регрессионной линии, но ниже sell upper offset. Sell stop размещается на нижнем смещении и сопровождает линию тренда.
- **Нет сигнала**: если цена вне коридора активации, существующие отложенные заявки снимаются.

## Управление рисками

- Для лонгов используются параметры `BuyStopLossSteps` и `BuyTakeProfitSteps`, задающие расстояние до стоп-лосса и тейк-профита в шагах цены.
- Для шортов применяются `SellStopLossSteps` и `SellTakeProfitSteps` с аналогичным смыслом.
- Защитные заявки пересчитываются только при смене знака позиции, что имитирует прикреплённые стоп-уровни в исходном советнике.

## Параметры

- `CandleType` – тип свечей, по которым строится линия тренда.
- `TrendLength` – длина окна линейной регрессии в свечах.
- `BuyStepUpper` / `BuyStepLower` – смещения (в шагах цены) для активации и срабатывания лонговых отложенных ордеров.
- `SellStepUpper` / `SellStepLower` – смещения (в шагах цены) для шортовых сигналов.
- `BuyTakeProfitSteps` / `BuyStopLossSteps` – расстояния до тейк-профита и стоп-лосса для лонга.
- `SellTakeProfitSteps` / `SellStopLossSteps` – расстояния для шорта.
- `BuyVolume` / `SellVolume` – объём заявок на соответствующей стороне.

## Особенности

- В отсутствие ручных трендовых линий роль центральной линии выполняет регрессия; длину окна можно подбирать под индивидуальный стиль анализа.
- Сделки допускаются только при активном подключении и разрешении на торговлю (`IsFormedAndOnlineAndAllowTrading`).
- Если позиция по направлению уже открыта, соответствующий отложенный ордер снимается, повторяя поведение оригинального советника с одним ордером на сторону.
