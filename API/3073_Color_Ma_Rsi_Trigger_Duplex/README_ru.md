# Стратегия Color Ma RSI Trigger Duplex

Стратегия переносит советник **Exp_ColorMaRsi-Trigger_Duplex.mq5** на высокий уровень API StockSharp.
Внутри работают два независимых блока MaRsi-Trigger: **длинный блок** отвечает за открытие и закрытие
длинных позиций, а **короткий блок** обслуживает короткие позиции. Каждый блок оценивает состояние
кастомного индикатора, который может принимать значения `+1` (бычий фон), `0` (нейтрально) или `-1`
(медвежий фон). Логика MetaTrader сохранена полностью, включая задержку на две завершённые свечи
перед реакцией и раздельные настройки управления капиталом для каждого направления.

## Торговая идея

1. Для каждого блока рассчитываются две экспоненциальные скользящие средние (быстрая и медленная)
   и два RSI (быстрый и медленный) на выбранной серии свечей.
2. На каждой завершённой свече индикатор возвращает `+1`, если быстрые линии превышают медленные,
   `-1`, если они ниже, и `0` в остальных случаях. Значение ограничивается диапазоном `[-1, 1]`, как в MT5.
3. Стратегия хранит историю значений индикатора. Для заданного смещения `SignalBar` сравниваются значение
   свечи `SignalBar + 1` (переменная `older`) и значение свечи `SignalBar` (переменная `recent`).
4. Длинный блок:
   - Если `older < 0`, закрывает текущую длинную позицию (если включено закрытие).
   - Если `older > 0` **и** `recent <= 0`, подготавливает открытие новой длинной позиции (если включено открытие).
5. Короткий блок работает зеркально:
   - Если `older > 0`, закрывает короткие позиции (при включённом закрытии).
   - Если `older < 0` **и** `recent >= 0`, открывает новую короткую позицию (при включённом открытии).
6. Дополнительные стоп-лосс и тейк-профит в шагах цены закрывают позиции при достижении уровней.

Два блока могут работать на разных таймфреймах и с разными типами цены, что позволяет воспроизвести
поведение оригинального советника или исследовать другие комбинации.

## Параметры

| Параметр | Описание |
|----------|----------|
| `LongCandleType`, `ShortCandleType` | Серия свечей для длинного и короткого блока (по умолчанию 4 часа). |
| `LongVolume`, `ShortVolume` | Объём рыночных заявок при открытии новой позиции. |
| `LongAllowOpen`, `ShortAllowOpen` | Разрешение на открытие позиций каждым блоком. |
| `LongAllowClose`, `ShortAllowClose` | Разрешение на закрытие позиций каждым блоком. |
| `LongStopLossPoints`, `ShortStopLossPoints` | Размер стоп-лосса в шагах цены (0 = выключено). |
| `LongTakeProfitPoints`, `ShortTakeProfitPoints` | Размер тейк-профита в шагах цены (0 = выключено). |
| `LongSignalBar`, `ShortSignalBar` | Количество завершённых свечей между текущей и анализируемой свечой. |
| `LongRsiPeriod`, `LongRsiLongPeriod`, `ShortRsiPeriod`, `ShortRsiLongPeriod` | Периоды быстрого и медленного RSI. |
| `LongMaPeriod`, `LongMaLongPeriod`, `ShortMaPeriod`, `ShortMaLongPeriod` | Периоды быстрых и медленных скользящих. |
| `LongRsiPrice`, `ShortRsiPrice` | Тип цены для быстрого RSI. |
| `LongRsiLongPrice`, `ShortRsiLongPrice` | Тип цены для медленного RSI. |
| `LongMaPrice`, `ShortMaPrice` | Тип цены для быстрой скользящей средней. |
| `LongMaLongPrice`, `ShortMaLongPrice` | Тип цены для медленной скользящей средней. |
| `LongMaType`, `ShortMaType` | Вид скользящей средней для быстрой линии (простая, экспоненциальная, сглаженная, взвешенная). |
| `LongMaLongType`, `ShortMaLongType` | Вид скользящей средней для медленной линии. |

## Правила торговли

1. Дождаться появления завершённых свечей и прогрева индикаторов.
2. На каждой новой свечке обновлять значение индикатора и историю.
3. Когда в истории есть минимум `SignalBar + 2` значений, проверять условия для длинных и коротких сигналов.
4. Перед открытием позиции стратегия при необходимости закрывает противоположную позицию (если закрытие разрешено).
5. После открытия позиции на каждой свече контролируются уровни стоп-лосса и тейк-профита.
6. Заявки выставляются рыночными ордерами через методы `BuyMarket` и `SellMarket`.

## Управление рисками

* Стопы и тейки рассчитываются через `Security.PriceStep`. Если шаг цены отсутствует, используется значение `1`.
* Для длинных и коротких позиций задаются независимые параметры стоп-лосса и тейк-профита.
* Дополнительные защитные механизмы (трейлинг и т.п.) не используются, что соответствует поведению MT5-советника.

## Замечания

* В MetaTrader заявки планировались на открытие следующей свечи. В StockSharp ордера отправляются сразу после
  закрытия свечи, что приводит к тем же моментам входа/выхода.
* В MT5 были реализованы режимы управления капиталом (`LOT`, `BALANCE` и др.). В StockSharp используются прямые
  значения объёмов (`LongVolume`/`ShortVolume`).
* Параметры проскальзывания и «магические» номера из MT5 не требуются и не перенесены.
* Индикатор построен на стандартных классах StockSharp (MA и RSI) и дополнительно ограничивает результат диапазоном `[-1, 1]`,
  как в оригинальном индикаторе `ColorMaRsi-Trigger`.
