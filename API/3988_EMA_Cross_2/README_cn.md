# EMA Cross 2 策略

## 概述
该策略是 MetaTrader 4 专家顾问 **“EMA_CROSS_2”** 的 StockSharp 移植版本。原始脚本监控两条指数移动平均线（EMA），当两条均线互换位置时就会开仓。移植版保留了原策略的反向特点——当长周期 EMA 高于短周期 EMA 时买入，当短周期 EMA 高于长周期 EMA 时卖出——并将全部逻辑封装在 StockSharp 的高级策略框架中。

策略基于可配置的 K 线数据类型，只在收盘后对完整 K 线进行分析，以避免在同一根 K 线内重复触发信号。风险管理模块沿用 MetaTrader 的做法，使用以“点（point）”为单位的止盈、止损和移动止损距离。

## 交易逻辑
1. **指标计算**
   - 在每根完成的 K 线上计算短周期与长周期 EMA。
   - 按照原始 EA 中的 `first_time` 标志，第一次计算被忽略，不会产生交易。
   - 之后只要长、短 EMA 的相对位置发生翻转，就视为新的方向变化。
2. **信号解释**
   - 当长周期 EMA 上穿短周期 EMA 时视为做多信号。移植版保留这种逆势做法，即便它与常见的均线交叉策略相反。
   - 当短周期 EMA 收盘价高于长周期 EMA 时发出做空信号。
   - 只有在账户没有持仓时才允许开新仓，对应原策略的 `OrdersTotal() < 1` 限制。
3. **下单执行**
   - 信号触发后按固定的可配置手数发送市价单。
   - 成交时根据参数记录止盈与止损价格，距离以点数换算。
4. **风险管理**
   - 每根完成的 K 线都会检查价格是否触及止盈或止损。一旦突破即通过市价单平仓。
   - 当浮盈超过设置的移动止损距离时，启动移动止损。多头仓位上移保护价，空头仓位下移保护价。
   - 仓位归零后会清除所有保护性价格。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 用于指标计算和信号检测的 K 线类型。 | 15 分钟周期 |
| `OrderVolume` | 每次市价单的成交量（手数/合约数）。 | 2 |
| `TakeProfitPoints` | 止盈距离，单位为交易商点（price step）。设为 `0` 表示不启用止盈。 | 20 |
| `StopLossPoints` | 止损距离，单位为交易商点。设为 `0` 表示不启用止损。 | 30 |
| `TrailingStopPoints` | 移动止损距离，单位为交易商点。`0` 表示关闭移动止损。 | 50 |
| `ShortEmaPeriod` | 短周期 EMA 的长度。 | 5 |
| `LongEmaPeriod` | 长周期 EMA 的长度。 | 60 |

## 实现细节
- 使用 `SubscribeCandles().Bind(shortEma, longEma, ProcessCandle)` 将 K 线数据与 EMA 指标绑定，完全依赖 StockSharp 的高级 API，无需手动维护缓冲区。
- 在回调函数中直接获得经过解包的指标数值，无需调用 `GetValue()`。
- 防护距离通过乘以品种的 `PriceStep` 将 MetaTrader 点值转换成实际价格。如果品种采用 3 位或 5 位小数报价，辅助函数会自动返回合适的“pip”大小。
- 止盈、止损与移动止损通过内部的市价平仓实现，因为 StockSharp 中没有 MetaTrader 4 `OrderModify` 的等价函数。逻辑与原版一致：每根 K 线检查一次，一旦突破立即退出。
- 首次均线比较被刻意忽略，以复刻原脚本中避免首根信号误触发的机制。

## 与 MetaTrader 版本的差异
- **资金管理**：原 EA 始终按照 `Lots` 参数交易。移植版通过 `OrderVolume` 参数暴露同一概念，并同步到策略的 `Volume` 属性，方便在设计器和优化器中使用。
- **下单方式**：MetaTrader 在 `OrderSend` 中直接设置止盈止损。StockSharp 版本改为在策略内部追踪这些价位，并在触发后以市价单平仓。
- **移动止损精度**：原脚本基于即时的 `Bid/Ask` 逐点移动。移植版在 K 线收盘时更新移动止损，这是示例项目中可用的最细粒度。触发条件和距离保持不变。
- **日志处理**：省略了 MQL 中的错误码输出，改用 StockSharp 自带的日志系统记录事件。

## 使用建议
- 将 `CandleType` 设为与回测或实盘时段一致的周期，以保持 EMA 行为一致。
- 对于带有小数点后 3 位或 5 位报价的外汇品种，请确认参数中的“点”对应期望的 pip 数（例如 EURUSD 中 10 点约等于 1 pip）。
- 根据交易平台的要求设置 `OrderVolume`。策略不会自动调整手数。
- 可以在设计器中启用参数的优化开关，像在 MetaTrader 中那样组合测试不同的 EMA 周期和风控距离。

## 文件列表
- `CS/EmaCross2Strategy.cs` —— 策略源码。
- `README.md` —— 英文文档。
- `README_cn.md` —— 中文文档（本文件）。
- `README_ru.md` —— 俄文文档。
