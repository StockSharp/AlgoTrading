# Стратегия EMA Cross 2

## Обзор
Эта стратегия представляет собой перенос на StockSharp эксперта MetaTrader 4 **«EMA_CROSS_2»**. Первоначальная версия следила за двумя экспоненциальными скользящими средними (EMA) и открывала сделки при смене их относительного положения. Конвертация сохраняет контртрендовый характер алгоритма: покупка выполняется, когда длинная EMA оказывается выше короткой, а продажа — когда короткая EMA закрывается выше длинной. Логика обёрнута в высокоуровневый каркас стратегий StockSharp.

Стратегия работает с завершёнными свечами выбранного типа. Сигналы анализируются на закрытии свечи, что исключает повторные срабатывания внутри одного бара. Модуль управления рисками воспроизводит поведение MetaTrader — уровни стоп-лосса, тейк-профита и трейлинг-стопа задаются в пунктах (price step).

## Торговая логика
1. **Расчёт индикаторов**
   - На каждой завершённой свече вычисляются короткая и длинная EMA.
   - Первая итерация пропускается в соответствии с флагом `first_time` исходного эксперта.
   - Далее фиксируется изменение направления, когда длинная и короткая EMA меняются местами.
2. **Интерпретация сигналов**
   - Если длинная EMA поднимается выше короткой, формируется сигнал на покупку. Стратегия сохраняет эту контртрендовую трактовку, несмотря на то что она противоположна классическому пересечению средних.
   - Если короткая EMA закрывается выше длинной, отправляется рыночная заявка на продажу.
   - Новая позиция открывается только при отсутствии текущего экспозиции, что повторяет условие `OrdersTotal() < 1` в MQL4.
3. **Исполнение ордеров**
   - Заявки отправляются по рынку с фиксированным объёмом.
   - При входе фиксируются уровни стоп-лосса и тейк-профита, рассчитанные из параметров в пунктах.
4. **Управление рисками**
   - После закрытия каждой свечи проверяется, достигла ли цена стоп-уровней. При пробое позиция немедленно закрывается рыночным ордером.
   - Трейлинг-стоп активируется, когда цена проходит в прибыльном направлении больше заданной дистанции. Для лонга защитный уровень подтягивается вверх, для шорта — опускается вниз.
   - При отсутствии позиции все защитные уровни очищаются.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип свечей для расчёта индикаторов и поиска сигналов. | Таймфрейм 15 минут |
| `OrderVolume` | Объём рыночной заявки в лотах/контрактах. | 2 |
| `TakeProfitPoints` | Дистанция до тейк-профита в пунктах (price step). `0` — без тейк-профита. | 20 |
| `StopLossPoints` | Дистанция до стоп-лосса в пунктах. `0` — без стоп-лосса. | 30 |
| `TrailingStopPoints` | Дистанция трейлинг-стопа в пунктах. `0` — трейлинг отключён. | 50 |
| `ShortEmaPeriod` | Период короткой EMA. | 5 |
| `LongEmaPeriod` | Период длинной EMA. | 60 |

## Особенности реализации
- Для получения данных используется высокоуровневый вызов `SubscribeCandles().Bind(shortEma, longEma, ProcessCandle)`, что избавляет от ручного управления буферами.
- Значения индикаторов поступают в обработчик уже в виде `decimal`, поэтому не требуется обращаться к `GetValue()`.
- Все дистанции пересчитываются из пунктов MetaTrader в реальные цены умножением на `PriceStep`. Для инструментов с дробными пунктами (3 или 5 знаков) вспомогательная функция корректно определяет размер pip.
- Стоп-лосс, тейк-профит и трейлинг реализованы через рыночные выходы, поскольку в StockSharp отсутствует прямой аналог `OrderModify`. При этом логика остаётся эквивалентной: уровни проверяются на каждой свече и при пробое позиция закрывается.
- Первое пересечение игнорируется намеренно, чтобы повторить защиту от ложного старта в оригинальном коде.

## Отличия от версии MetaTrader
- **Управление объёмом.** В MQL4 торговля велась строго по параметру `Lots`. В перенесённой версии этот параметр представлен как `OrderVolume` и дополнительно присваивается свойству `Volume` стратегии для удобства оптимизации.
- **Регистрация заявок.** MetaTrader выставлял стоп-уровни прямо в `OrderSend`. В StockSharp значения сохраняются внутри стратегии и приводят к рыночному выходу при достижении.
- **Точность трейлинга.** В исходном эксперте уровни подтягивались по тиковой цене `Bid/Ask`. Здесь обновление происходит на закрытии свечи — это максимальная доступная частота в демонстрационном проекте. Правила активации остаются прежними.
- **Обработка ошибок.** Вместо вывода кодов ошибок MetaTrader используется стандартный журнал StockSharp.

## Рекомендации по использованию
- Подбирайте `CandleType` в соответствии с тестовым или боевым таймфреймом, чтобы поведение EMA совпадало с оригиналом.
- Для инструментов с дробными пунктами проверяйте, соответствует ли заданное количество `Points` желаемому числу пунктов (например, на EURUSD 10 points ≈ 1 pip).
- Настройте `OrderVolume` под требования вашей торговой площадки — автоматического масштабирования нет.
- Задействуйте встроенные флаги оптимизации у параметров, чтобы подбирать периоды EMA и дистанции риск-менеджмента аналогично оптимизации входных данных в MetaTrader.

## Файлы
- `CS/EmaCross2Strategy.cs` — исходный код стратегии.
- `README.md` — документация на английском языке.
- `README_cn.md` — документация на китайском языке.
- `README_ru.md` — документация на русском языке (данный файл).
