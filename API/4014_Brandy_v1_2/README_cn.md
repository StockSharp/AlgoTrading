# Brandy v1.2 策略（C# 版本）

## 概览
**Brandy v1.2 策略** 是对 MetaTrader 4 专家顾问 "Brandy_v1_2.mq4" 的完整移植，基于 StockSharp 高级策略 API 实现。系统同时计算两条基于收盘价的简单移动平均线（SMA），并对它们施加与原始脚本相同的位移。只有当长周期与短周期 SMA 的斜率同时指向同一方向时才允许开仓；持仓阶段则通过趋势反转、固定止损以及可选的跟踪止损进行管理。

原始 EA 只在每根新 K 线生成时执行一次逻辑。本移植版本同样仅在 `CandleStates.Finished` 状态下处理蜡烛数据，确保所有信号都基于已收盘的价格信息。

## 交易逻辑
1. **指标准备**
   - 构建两条简单移动平均线：`LongPeriod` 代表长周期均线，`ShortPeriod` 代表短周期均线。
   - 每条均线都会读取两个数值：上一根 K 线的值（位移 1）以及距今 `LongShift`/`ShortShift` 根 K 线的值，以完全复刻 `iMA(..., shift)` 的计算方式。
2. **开仓条件**
   - **做多**：当上一根 K 线的长短两条 SMA 均高于各自的位移值（均线斜率向上）且当前没有持仓时开多。
   - **做空**：当上一根 K 线的长短两条 SMA 均低于各自的位移值（均线斜率向下）且当前没有持仓时开空。
   - 任何时刻最多只保留一笔头寸，对应原脚本中的 `k == 0` 限制。
3. **平仓条件**
   - **斜率反转**：持有多单时若长周期 SMA 转为向下（`longPrev < longShifted`），立即平仓；持有空单时若长周期 SMA 转为向上（`longPrev > longShifted`），立即回补。
   - **固定止损**：开仓后记录入场价，并按照 `StopLossPoints × PriceStep` 计算绝对止损价位；每根完成的 K 线都会检查该止损是否被突破。
   - **跟踪止损**：当 `TrailingStopPoints ≥ 100` 时启用。只有在浮动盈利超过跟踪距离且当前止损离价格的距离仍大于该值时，才会将止损上移/下移到 `currentPrice ± trailingDistance`，完全模拟原 EA 的 `OrderModify` 行为。

## 参数说明
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `LongPeriod` | 70 | 长周期 SMA 的长度（对应 MQL 中的 `p1`）。必须为正数。 |
| `LongShift` | 5 | 长周期 SMA 的位移量（对应 `s1`）。允许为 0。 |
| `ShortPeriod` | 20 | 短周期 SMA 的长度（对应 `p2`）。必须为正数。 |
| `ShortShift` | 5 | 短周期 SMA 的位移量（对应 `s2`）。允许为 0。 |
| `StopLossPoints` | 50 | 固定止损距离（以最小价格跳动为单位，对应 `sl`）。设为 0 可关闭硬止损。 |
| `TrailingStopPoints` | 150 | 跟踪止损距离（以最小价格跳动为单位，对应 `ts`）。只有当值 ≥ 100 时才会启动跟踪。 |
| `Volume` | 0.1 | 下单手数（对应 `lots`）。 |
| `CandleType` | 15 分钟 | 使用的蜡烛类型，可在 UI 中修改。 |

### 价格步长依赖
止损与跟踪止损都以“点”为单位。策略会读取 `Security.PriceStep` 将其转换为绝对价格距离；若行情源未提供 `PriceStep`，则回退到 0.0001 作为估算值。实际交易前请确认交易品种的价格步长配置正确。

## 风险管理
- **硬止损**：每根完成的蜡烛都会检查是否触及止损价位，一旦突破立即通过 `SellMarket` 或 `BuyMarket` 平掉全部仓位。
- **跟踪止损**：复制原 EA 的触发条件，仅在收益充足且现有止损仍然过远时才向价格方向移动。
- **单一仓位**：策略不会加仓或对冲，始终保持“多 / 空 / 空仓”三种状态之一。

## 实现细节
- `OnReseted()` 会清空所有内部状态（入场价、止损、SMA 历史值），方便重复回测或重启。
- 为了模拟 `shift` 功能，使用短队列维护 SMA 历史值，而不是调用被禁止的 `GetValue()` 方法。
- 代码中的注释全部采用英文，符合仓库规范。
- 按需求仅提供 C# 版本（`CS/BrandyV12Strategy.cs`），未创建 Python 目录或脚本。

## 使用步骤
1. 在 StockSharp 终端中加载策略，选择目标品种，并确保蜡烛数据与 `CandleType` 参数一致。
2. 根据需求调整参数，默认值完全复刻 MT4 原始设置。
3. 启动策略后，它会自动订阅蜡烛数据、绘制两条 SMA，并根据上述规则管理仓位。

> **免责声明：** 本策略仅用于教育与测试。正式上实盘前请先在历史数据和模拟账户中充分验证。
