# Стратегия Brandy v1.2 (C#)

## Общее описание
**Brandy v1.2** — это порт MetaTrader 4 эксперта "Brandy_v1_2.mq4" на высокоуровневый API StockSharp. Алгоритм анализирует две простые скользящие средние (SMA), построенные по ценам закрытия выбранного таймфрейма. Для каждой SMA вычисляются значения сдвинутые назад на одну и несколько свечей, что полностью повторяет вызовы `iMA` в оригинальном советнике. Сделки открываются только тогда, когда обе средние демонстрируют согласованное движение в одну сторону. Существующие позиции закрываются при развороте наклона, срабатывании фиксированного стоп-лосса или при переносе трейлинг-стопа.

Изначальный MQL-скрипт выполнялся ровно один раз на закрытии каждой новой свечи. Порт в StockSharp работает по тому же принципу: вся логика выполняется в обработчике завершённых свечей (`CandleStates.Finished`), поэтому решения принимаются исключительно на основании закрытых данных.

## Логика торговли
1. **Подготовка индикаторов**
   - Рассчитываются две SMA: «длинная» (`LongPeriod`) и «короткая» (`ShortPeriod`).
   - Для каждой средней берётся два значения: предыдущее (`shift = 1`) и значение, смещённое на `LongShift`/`ShortShift` баров назад. Таким образом, сравниваются направления наклона скользящих.
2. **Условия входа**
   - **Покупка**: если обе SMA на предыдущей свече выше своих сдвинутых значений (наклон вверх) и стратегия не удерживает позицию.
   - **Продажа**: если обе SMA на предыдущей свече ниже своих сдвинутых значений (наклон вниз) и позиция отсутствует.
   - Одновременно допускается только одна позиция — это аналог счётчика `k` в MQL-варианте.
3. **Условия выхода**
   - **Разворот наклона**: длинная позиция закрывается, когда длинная SMA опускается ниже сдвинутого значения (`longPrev < longShifted`). Короткая позиция закрывается при обратном условии (`longPrev > longShifted`).
   - **Фиксированный стоп-лосс**: при открытии позиции запоминается цена входа и рассчитывается стоп на расстоянии `StopLossPoints × PriceStep`. На каждой закрытой свече проверяется, пробита ли эта отметка.
   - **Трейлинг-стоп**: активируется, если параметр `TrailingStopPoints` не меньше 100. Когда плавающая прибыль превышает заданное расстояние и текущий стоп расположен дальше этой величины, стоп переносится ближе к цене на расстояние `TrailingStopPoints × PriceStep`. Логика полностью копирует `OrderModify` из оригинала.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `LongPeriod` | 70 | Период длинной SMA (`p1`). Значение должно быть положительным. |
| `LongShift` | 5 | Сдвиг длинной SMA (`s1`). Допускается ноль. |
| `ShortPeriod` | 20 | Период короткой SMA (`p2`). Значение должно быть положительным. |
| `ShortShift` | 5 | Сдвиг короткой SMA (`s2`). Допускается ноль. |
| `StopLossPoints` | 50 | Расстояние до стоп-лосса в шагах цены (`sl`). Ноль отключает жёсткий стоп. |
| `TrailingStopPoints` | 150 | Расстояние трейлинг-стопа в шагах цены (`ts`). Работает только при значении ≥ 100. |
| `Volume` | 0.1 | Объём заявки при открытии позиции (`lots`). |
| `CandleType` | 15 минут | Тип свечей, используемых стратегией. Параметр изменяемый пользователем. |

### Зависимость от шага цены
Стопы задаются в «пунктах» и переводятся в абсолютные цены через `Security.PriceStep`. Если поставщик данных не передаёт шаг цены, стратегия применяет запасное значение `0.0001`. Перед запуском убедитесь, что у инструмента корректно настроен `PriceStep` и объём контракта.

## Управление рисками
- **Жёсткий стоп**: хранится в полях стратегии и проверяется на каждой закрытой свече. При достижении уровня позиция закрывается рыночной заявкой.
- **Трейлинг-стоп**: переносит стоп только при достаточной прибыли и при условии, что текущий уровень стоит дальше заданного расстояния.
- **Один вход — одна позиция**: стратегия не накапливает несколько сделок в одном направлении и не усредняет позиции.

## Особенности реализации
- Метод `OnReseted()` очищает историю SMA, цены входа и текущий стоп, поэтому стратегия корректно перезапускается между тестами.
- Для имитации сдвигов используются небольшие списки с историей значений SMA. Это позволяет соблюдать требования репозитория и не обращаться к `GetValue()` у индикаторов.
- Все комментарии внутри кода написаны на английском языке в соответствии с требованиями `AGENTS.md`.
- По запросу реализована только C#-версия. Папка `PY` и Python-скрипты не создавались.

## Как использовать
1. Добавьте стратегию в своё решение StockSharp, выберите нужный инструмент и таймфрейм, соответствующий параметру `CandleType`.
2. Настройте параметры под свои задачи. Значения по умолчанию совпадают с оригинальным экспертом.
3. Запустите стратегию. Она подпишется на поток свечей, отобразит SMA на графике и будет автоматически управлять сделками.

> **Внимание:** используйте стратегию только после тщательного тестирования на исторических данных и в режиме демо. Автор не несёт ответственности за финансовые результаты.
