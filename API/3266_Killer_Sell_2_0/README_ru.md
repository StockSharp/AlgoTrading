# Killer Sell 2.0 (C#)

## Обзор
Killer Sell 2.0 — это эксперт MetaTrader 4, который работает исключительно
в короткую сторону. Он ищет точки входа после затяжного перекупленного
движения и закрывает позиции, когда импульс переходит в область перепроданности.
Перенос выполнен на высокоуровневом API StockSharp: индикаторы обновляются через
`SubscribeCandles().BindEx(...)`, а правила управления капиталом инкапсулированы
внутри класса стратегии.

## Логика торговли
На закрытии каждой свечи выбранного таймфрейма стратегия выполняет цепочку действий:

1. **Подготовка данных.** Рассчитываются MACD (12/120/9), два индикатора
   Williams %R (по 350 периодов) и две версии стохастика (10/1/3 для входа и 90/7/1
   для выхода). Значения используются только для завершённых свечей.
2. **Фильтр входа.** Сделка открывается при выполнении всех условий:
   - Williams %R поднимается выше отметки −10.
   - Основная линия MACD превышает `0.0014`.
   - %K входного стохастика пересекает сверху вниз заданный уровень (по умолчанию 90).
3. **Размещение ордера.** При выполнении фильтров отправляется рыночный ордер Sell
   с текущим объёмом по мартингейлу. Через `StartProtection` к сделке прикрепляется
   защитный тейк-профит (100 пунктов по умолчанию).
4. **Управление выходом.** Пока открыта короткая позиция, стратегия вычисляет среднюю
   прибыль открытых сделок в пунктах:
   - Если среднее значение ниже 10 пунктов и Williams %R опускается ниже −80,
     все продажи закрываются немедленно.
   - Если средняя прибыль превышает 15 пунктов и выходной стохастик %K падает ниже 12,
     позиция закрывается для фиксации результата.

## Управление капиталом
Перенос сохраняет мартингейл из оригинального советника. Для имитации тикетов MT4
стратегия ведёт список открытых коротких сделок (цена + объём) и использует его для
перерасчёта средней прибыли и выбора следующего шага лестницы:

- Первая сделка открывается объёмом `InitialVolume` (по умолчанию 0.05 лота).
- Положительный или нулевой результат сбрасывает объём к исходному значению.
- Убыточная серия увеличивает следующий объём в `MartingaleMultiplier` раза
  (по умолчанию ×1.2), при этом `MaxVolume` ограничивает максимальную величину.

Реализованная прибыль фиксируется при обработке сделок, чтобы определить исход
предыдущего цикла.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Таймфрейм, по которому строятся свечи и индикаторы. |
| `EntryWprPeriod` / `ExitWprPeriod` | Периоды Williams %R для входа и выхода. |
| `MacdFastPeriod` / `MacdSlowPeriod` / `MacdSignalPeriod` | Настройки MACD. |
| `MacdThreshold` | Минимальное значение MACD, разрешающее продажу. |
| `StochasticEntryKPeriod`, `StochasticEntryDPeriod`, `StochasticEntrySlow` | Параметры стохастика для входа. |
| `EntryStochasticLevel` | Уровень, который %K должен пересечь сверху вниз. |
| `StochasticExitKPeriod`, `StochasticExitDPeriod`, `StochasticExitSlow` | Стохастик для выхода. |
| `ExitStochasticLevel` | Верхняя граница перепроданности перед фиксацией прибыли. |
| `EntryWprThreshold` / `ExitWprThreshold` | Пороговые значения Williams %R. |
| `LossExitPips` / `ProfitExitPips` | Средняя прибыль (в пунктах), инициирующая защитный выход или фиксацию. |
| `TakeProfitPips` | Расстояние защитного тейк-профита. |
| `InitialVolume` | Начальный объём мартингейла. |
| `MartingaleMultiplier` | Множитель после убыточной серии. |
| `MaxVolume` | Предельный объём одной сделки. |

## Особенности переноса
- MetaTrader работает с отдельными тикетами, тогда как StockSharp использует
  совокупную позицию. Чтобы воспроизвести логику усреднения, стратегия хранит
  каждую короткую сделку во внутреннем списке.
- В блоке «Sell Now» исходного проекта были доступны десятки режимов управления
  капиталом, но выбран был именно мартингейл. В портированной версии реализован
  только он.
- Жёсткий стоп-лосс в исходнике отключён. В C#-версии сделки получают только тейк-профит,
  а закрытие по убытку контролируется индикаторами.

## Рекомендации по использованию
1. Подключите стратегию к нужному инструменту и портфелю и задайте таймфрейм,
   на котором тестировался оригинальный советник (по умолчанию предполагается H1).
2. Убедитесь, что поставщик данных передаёт завершённые свечи — индикаторы работают
   только по состоянию `CandleStates.Finished`.
3. Настройте параметры объёма (`InitialVolume`, `MaxVolume`) с учётом плеча и
   требований брокера.
4. Мартингейл значительно увеличивает риски при сильных трендах против позиций,
   поэтому рекомендуется предварительное тестирование и строгий контроль капитала.

