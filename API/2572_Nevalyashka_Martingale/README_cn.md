# Nevalyashka Martingale 策略

## 概览
Nevalyashka Martingale 是 MetaTrader 5 专家顾问 “Nevalyashka3_1” 的移植版。策略只处理一个品种，通过在亏损后交替做多和做空来实现马丁格尔逻辑。启动时会先建立一个空头头寸。每次平仓后，策略都会检查账户权益：如果权益创出新高，下一笔交易使用基础手数并保持原方向；如果权益没有超过历史峰值，则将手数乘以系数并改变方向，以尝试弥补回撤。

## 运行机制
- **首次交易**：在第一根完成的 K 线收盘时，以基础手数开空。
- **权益跟踪**：策略保存权益峰值，只有在没有持仓时才比较当前权益和峰值。
  - 权益创新高 → 下一单沿用上一笔的方向，手数回到基础值。
  - 权益未创新高 → 下一单手数乘以系数，同时方向反向。
- **止损/止盈**：每个订单都带有固定距离的止损和止盈，单位为“点”（价格最小变动）。止损距离为 `StopLossPoints`，止盈距离为 `TakeProfitPoints`。
- **移动止损**：当价格向有利方向运行 `MoveProfitPoints` 后，止损开始上移/下移。两次调整之间必须满足额外的 `MoveStepPoints` 缓冲，避免过于频繁地修改。止损超过进场价后，计划手数会除以系数，逐步回到基础规模。
- **平仓**：当蜡烛的最高价或最低价触及止损/止盈时立即市价平仓，然后根据最新权益决定下一次交易。

## 参数
- `BaseVolume`：基础手数，适用于初始交易以及盈利周期（默认 0.1）。
- `VolumeMultiplier`：在亏损后放大下一笔手数的倍数（默认 1.1）。
- `TakeProfitPoints`：止盈距离，单位为点（默认 94）。
- `MoveProfitPoints`：触发移动止损所需的最小盈利点数（默认 25）。
- `MoveStepPoints`：两次移动止损之间必须额外满足的点差（默认 11）。
- `StopLossPoints`：初始止损距离，单位为点（默认 70）。
- `CandleType`：用于管理交易的蜡烛类型，默认使用 5 分钟周期。

## 持仓管理细节
- `_plannedVolume` 对应 MT5 中的 `Lot` 变量，只会在平仓或止损超过进场价时更新。
- `AdjustVolume` 会根据交易所的限制自动对齐手数，遵守 `VolumeStep`、`MinVolume` 与 `MaxVolume`。
- `GetPointValue` 复刻 MT5 的 “adjusted point” 逻辑：如果报价有 3 或 5 位小数，则将点值乘以 10，以便以标准的 pip 为单位。
- `HandleLongPosition` 和 `HandleShortPosition` 通过蜡烛的最高价/最低价来模拟 MT5 中的止损移动与离场动作，无需额外的指标缓存。

## 使用提示
- 策略默认只针对一个证券，请在启动前设置好 `Security` 和 `Portfolio`。
- 马丁格尔在连续亏损时会迅速扩大风险，应谨慎调整 `BaseVolume` 和 `VolumeMultiplier`，并在有真实保证金约束的环境中测试。
- 止损和止盈使用价格点差，请确保证券元数据（`PriceStep`、`VolumeStep`、`MinVolume`）完整，以避免与经纪商设置不一致。
- 移动止损基于已完成的蜡烛计算，实盘中价格在蜡烛内的波动可能提前触发止损。
