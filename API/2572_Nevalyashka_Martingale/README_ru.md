# Стратегия Nevalyashka Martingale

## Обзор
Nevalyashka Martingale — это перенос эксперта MetaTrader 5 «Nevalyashka3_1». Стратегия торгует одним инструментом и реализует мартингейл, чередуя покупки и продажи после убыточных сделок. Запуск начинается с короткой позиции. После закрытия сделок стратегия анализирует капитал счёта: если капитал вырос, объём сбрасывается на базовый и направление сохраняется; если капитал не обновил максимум, объём умножается на коэффициент и направление меняется, чтобы попытаться отыграть просадку.

## Логика работы
- **Стартовая сделка** — на первой завершённой свече открывается шорт базовым объёмом.
- **Контроль equity** — стратегия хранит максимум капитала. Пока позиции нет, текущий капитал сравнивается с пиком.
  - Новый максимум → следующая сделка идёт прежним направлением и базовым объёмом.
  - Без обновления максимума → объём умножается на коэффициент, направление переключается (лонг ↔ шорт).
- **Стоп и тейк** — для каждой сделки выставляется фиксированный стоп и тейк, задаваемый в «пунктах» (шага цены).
- **Трейлинг-стоп** — когда цена проходит `MoveProfitPoints`, стоп подтягивается. Дополнительный буфер `MoveStepPoints` не позволяет переносить стоп слишком часто. Если стоп выходит за точку входа, планируемый объём делится на коэффициент, возвращая его к базовому значению.
- **Выход из позиции** — при достижении стопа или тейка по максимуму/минимуму свечи позиция закрывается рыночным приказом. Далее происходит повторная оценка капитала и подготовка следующего входа.

## Параметры
- `BaseVolume` — базовый объём первой и прибыльных сделок (по умолчанию 0.1).
- `VolumeMultiplier` — множитель для увеличения объёма после убытка (по умолчанию 1.1).
- `TakeProfitPoints` — расстояние до тейк-профита в пунктах (по умолчанию 94).
- `MoveProfitPoints` — минимальное движение в прибыль до включения трейлинг-стопа (по умолчанию 25).
- `MoveStepPoints` — дополнительный буфер между переносами стопа (по умолчанию 11).
- `StopLossPoints` — исходное расстояние стоп-лосса в пунктах (по умолчанию 70).
- `CandleType` — тип свечей, по умолчанию пятиминутный таймфрейм.

## Особенности управления позицией
- Поле `_plannedVolume` повторяет MT5-переменную `Lot`: оно меняется только после закрытия сделки или переноса стопа за точку входа.
- `AdjustVolume` подгоняет объём под биржевые ограничения (`VolumeStep`, `MinVolume`, `MaxVolume`).
- `GetPointValue` повторяет MT5-логику «adjusted point»: для котировок с 3 или 5 знаками величина пункта умножается на 10, чтобы работать с пипсами.
- Методы `HandleLongPosition` и `HandleShortPosition` используют high/low свечи для имитации переноса стопов и закрытия, как в оригинале.

## Рекомендации по применению
- Стратегия рассчитана на один инструмент: перед стартом укажите `Security` и `Portfolio` у стратегии.
- Мартингейл быстро наращивает риск при серии убытков. Тщательно подбирайте `BaseVolume` и `VolumeMultiplier`, учитывая требования по марже.
- Стопы и тейки задаются в шагах цены. Убедитесь, что у инструмента заполнены `PriceStep`, `VolumeStep`, `MinVolume`, иначе смещения и объёмы могут отличаться от брокерских.
- Трейлинг оценивается на закрытых свечах. В реальной торговле стоп может сработать внутри свечи, если цена вернётся.
