# Стратегия CCFp Advisor

Стратегия повторяет работу советника **CCFp** (Currency Comparative Force) из MetaTrader. Она сравнивает скорости укрепления восьми валют по семи основным парам с долларом США, используя составные скользящие средние, и ведёт портфель, где удерживается один лонг по самой сильной валюте и один шорт по самой слабой. Все вычисления выполняются по закрытым свечам и через высокоуровневый API StockSharp.

## Как работает

1. Подписывается на свечи выбранного таймфрейма для EURUSD, GBPUSD, AUDUSD, NZDUSD, USDCHF, USDJPY и USDCAD.
2. Для каждого инструмента рассчитываются две составные скользящие – быстрая и медленная. Базовые периоды `FastPeriod` и `SlowPeriod` умножаются на набор множителей, идентичный функции `ma()` в исходном MQL, после чего значения суммируются.
3. Полученные величины преобразуются в индексы силы валют с помощью тех же формул, что и в оригинальном индикаторе CCFp. Для дальнейшего анализа сохраняются текущий (последний завершённый бар) и предыдущий снимки.
4. Валюта с максимальным значением считается «сильной», а с минимальным – «слабой». Сделка открывается только если лидер (или аутсайдер) сменился по сравнению с предыдущей свечой – это повторяет фильтры `MAX1` и `MIN1` исходного кода.
5. Если активная позиция перестаёт соответствовать текущему лидеру/аутсайдеру, она закрывается. Защитный стоп в пунктах моделируется на основе цен High/Low свечи относительно последней цены закрытия.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `MaType` | `MovingAverageMode` | `Exponential` | Тип скользящей для составных средних (Simple, Exponential, Smoothed, Weighted). |
| `PriceMode` | `CandlePrice` | `Close` | Цена свечи, подающаяся на вход индикатора, соответствует параметру Applied Price в MQL. |
| `FastPeriod` | `int` | `3` | Базовый период быстрой составной скользящей. |
| `SlowPeriod` | `int` | `5` | Базовый период медленной составной скользящей. |
| `StopLossPips` | `decimal` | `200` | Дистанция защитного стопа в пунктах. Значение `0` отключает виртуальный стоп. |
| `TradeVolume` | `decimal` | `0.1` | Фиксированный объём (лоты) каждой заявки. |
| `CandleType` | `DataType` | `H1` | Тип/таймфрейм свечей для расчётов. Множители полностью совпадают с оригинальной таблицей для M1/M5/M15/M30/H1/H4/D1/W1/MN. |
| `EurUsdSecurity` | `Security` | – | Инструмент для торговли, когда лидирует или отстаёт EUR. |
| `GbpUsdSecurity` | `Security` | – | Инструмент для GBP. |
| `AudUsdSecurity` | `Security` | – | Инструмент для AUD. |
| `NzdUsdSecurity` | `Security` | – | Инструмент для NZD. |
| `UsdChfSecurity` | `Security` | – | Инструмент для CHF (торговля через USDCHF). |
| `UsdJpySecurity` | `Security` | – | Инструмент для JPY (торговля через USDJPY). |
| `UsdCadSecurity` | `Security` | – | Инструмент для CAD (торговля через USDCAD). |

Перед запуском необходимо назначить все семь инструментов. USD участвует в расчётах силы, но напрямую не торгуется, как и в MetaTrader-версии.

## Особенности портирования

- Составные скользящие средние повторяют падающий `switch` из функции `ma()` оригинального индикатора, поэтому набор периодов для каждого таймфрейма совпадает с MQL.
- Формулы перерасчёта в индексы силы целиком перенесены из CCFp, что гарантирует совпадение рейтингов при одинаковых исходных данных.
- В отличие от MQL, стоп-ордера моделируются внутри стратегии: при достижении цены High/Low установленного уровня позиция закрывается рыночной заявкой.
- Для «сильной» и «слабой» стороны ведутся отдельные состояния. При смене лидера прежняя позиция закрывается, что соответствует логике `magicMAX`/`magicMIN` из исходного кода.

## Как использовать

1. Подключите стратегию к коннектору с котировками всех перечисленных валютных пар и заполните параметры `Security`.
2. Выберите требуемый таймфрейм свечей и убедитесь, что по всем инструментам приходят синхронные завершённые бары.
3. Настройте периоды скользящих, режим цены и стоп в пунктах под нужную конфигурацию CCFp.
4. Запустите стратегию – она автоматически подпишется на данные, рассчитает индексы силы валют и будет держать не более одной позиции по лидеру и одной по аутсайдеру.
