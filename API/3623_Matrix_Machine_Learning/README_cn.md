# 矩阵机器学习策略

## 概述
矩阵机器学习策略源自 MetaTrader 5 平台上的 "MQL5Book" 教程脚本。原版程序收集一段最新报价，将相邻价格差分转换成二进制序列，并使用霍普菲尔德递归神经网络进行训练。训练好的网络会在样本内与样本外片段上进行验证，最终根据预测向量的第一个元素（`+1` 代表看涨，`-1` 代表看跌）决定交易方向。

C# 版本采用 StockSharp 高级 API，并使用收盘完成的 K 线代替逐笔数据，以获得更稳定的跨平台表现。每当 K 线收盘时，策略都会更新价格二进制模式、重新训练霍普菲尔德网络、评估历史准确度，并生成下一步的在线预测。

## 算法细节
1. 收集最近 `HistoryDepth` 根 K 线的收盘价。最新的 `ForwardDepth` 个点作为样本外验证段，其余数据用于训练。
2. 将连续收盘价的差值转换为二进制序列：非负差值映射为 `+1`，负差值映射为 `-1`。
3. 根据 `PredictorLength`（输入长度）与 `ForecastLength`（输出长度）滑动窗口计算外积之和，构造霍普菲尔德权重矩阵。
4. 在训练集与验证集上评估该矩阵。准确度指标与原脚本保持一致：对预测向量与真实向量求点积，取平均后换算成百分比。
5. 构建最新的在线二进制模式，运行霍普菲尔德推理循环（tanh 激活与收敛阈值），预测向量的第一个元素用于驱动交易决策。

## 参数说明
- **History Depth** – 霍普菲尔德网络持有的历史收盘数量，应大于 `ForwardDepth`，且至少满足 `PredictorLength + ForecastLength + 1`。
- **Forward Depth** – 保留用于样本外验证的收盘数量，至少需要 `ForecastLength + 1` 根 K 线。
- **Predictor Length** – 神经网络输入向量的长度。
- **Forecast Length** – 神经网络输出向量预测的未来步数。
- **Candle Type** – 指定由连接器订阅的 K 线数据类型。
- **Debug Log** – 启用后会在日志中输出详细的中间向量、样本比较以及在线预测结果。

## 交易逻辑
- 当预测向量的首个元素为正且当前持仓≤0 时，策略以 `Volume + |Position|` 的数量市价买入，转为多头。
- 当预测向量的首个元素为负且当前持仓≥0 时，策略以 `Volume + |Position|` 的数量市价卖出，转为空头。
- 若预测结果为零，则忽略信号以避免不必要的交易频率。

若图表区域可用，策略会自动绘制 K 线与成交记录。霍普菲尔德网络在每根 K 线收盘时重新训练，使权重始终跟随最新的市场结构。
