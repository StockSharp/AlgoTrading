# Стратегия CashMachine

## Общая информация
Стратегия CashMachine повторяет оригинального советника MQL4, который торговал хеджированную корзину EURUSD/USDCHF. Она одновременно работает с базовым инструментом (`Security` стратегии) и хеджирующим инструментом, открывая позиции только при одновременном выполнении трёх фильтров:

1. Быстрая EMA базового инструмента располагается выше или ниже медленной EMA.
2. RSI базового инструмента указывает на перепроданность (<= 30) или перекупленность (>= 70).
3. Пирсоновская корреляция между дневными отклонениями базового и хеджирующего инструментов отрицательна, что намекает на синхронное движение пары.

Все сделки ведутся одинаковым объёмом на обоих инструментах. Как только суммарная плавающая прибыль по двум ногам достигает параметра `TakeProfit`, стратегия закрывает позиции и возвращается в режим ожидания.

## Детали алгоритма
1. **Подготовка индикаторов**
   - Подписка на внутридневные свечи `CandleType` для обоих инструментов и расчёт двух EMA и RSI на базовом инструменте.
   - Подписка на старший таймфрейм `DailyCandleType` для обоих инструментов; значения закрытия прогоняются через простую среднюю длиной `CorrelationLookback`.
   - Суточное отклонение определяется как `Close - SMA`; последние `CorrelationLookback` пар отклонений используются для вычисления корреляции Пирсона.
2. **Торговое окно**
   - В точности воспроизводится ограничение оригинального советника: сделки разрешены только в первые пять календарных дней месяца и прекращаются после 18:00 пятого дня.
3. **Условия входа**
   - Нет открытых позиций ни по базовому, ни по хеджирующему инструменту.
   - Корреляция отрицательная и накоплено не менее `CorrelationLookback` пар значений.
   - Для покупок: `fast EMA > slow EMA` и `RSI <= RsiOversold`. Оба инструмента покупаются по рынку одинаковым объёмом.
   - Для продаж: `fast EMA < slow EMA` и `RSI >= RsiOverbought`. Оба инструмента продаются по рынку.
4. **Фиксация прибыли**
   - Каждая завершённая свеча обновляет последние цены закрытия. Если совокупная плавающая прибыль превышает `TakeProfit`, обе позиции закрываются немедленно.
5. **Учёт позиций**
   - Для каждой ноги хранятся средняя цена входа и текущий объём, что позволяет корректно оценивать плавающий результат по последним ценам.

## Параметры
| Название | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `TakeProfit` | `decimal` | `10` | Суммарная плавающая прибыль, при достижении которой закрываются обе позиции. |
| `EmaShortPeriod` | `int` | `8` | Период быстрой EMA на базовом инструменте. |
| `EmaLongPeriod` | `int` | `21` | Период медленной EMA на базовом инструменте. |
| `RsiPeriod` | `int` | `14` | Период RSI. |
| `RsiOversold` | `decimal` | `30` | Порог RSI для разрешения длинных позиций. |
| `RsiOverbought` | `decimal` | `70` | Порог RSI для разрешения коротких позиций. |
| `CorrelationLookback` | `int` | `60` | Количество дневных отклонений, участвующих в расчёте корреляции. |
| `CandleType` | `DataType` | `TimeSpan.FromHours(1).TimeFrame()` | Внутридневные свечи для EMA и RSI. |
| `DailyCandleType` | `DataType` | `TimeSpan.FromDays(1).TimeFrame()` | Дневные свечи для статистики корреляции. |
| `HedgeSecurity` | `Security` | `null` | Хеджирующий инструмент. Нужно задать перед запуском. |

> **Объём сделок:** размер ордеров определяется свойством `Volume` стратегии. Значение нормализуется по `VolumeStep`, `VolumeMin` и `VolumeMax` каждого инструмента и автоматически принимает `0.1`, если `Volume` не задан.

## Условия входа и выхода
- **Покупка корзины**
  - Условия: `fast EMA > slow EMA`, `RSI <= RsiOversold`, корреляция < 0, открытых позиций нет.
  - Действия: рыночная покупка базового инструмента и одновременная покупка хеджа.
- **Продажа корзины**
  - Условия: `fast EMA < slow EMA`, `RSI >= RsiOverbought`, корреляция < 0, открытых позиций нет.
  - Действия: рыночная продажа обоих инструментов.
- **Выход**
  - Автоматически при достижении `TakeProfit` по суммарной плавающей прибыли.
  - После истечения торгового окна стратегия новых сделок не открывает, тем самым полностью повторяя логику исходного советника.

## Особенности реализации
- Корреляция хранится в буферах фиксированной длины, что соответствует вызову `Period()` в MQL4-версии.
- Дневное отклонение реализовано как `Close - SMA` по свечам `DailyCandleType`, что совпадает с выражением `iClose - iMA` на таймфрейме D1.
- Python-версия и соответствующая папка не создавались согласно требованиям.
