# Стратегия News Filter (конвертация из MQL)

## Общая информация

**News Filter Strategy** — это порт оригинального эксперта "NEWS_Filter" для MetaTrader 4. Стратегия автоматически загружает экономический календарь FXStreet, отбирает новости по валюте и значимости, и определяет, следует ли приостановить торговлю за заданное время до события и после него. Логика полностью повторяет исходное поведение MQL-скрипта, но реализована на высокоуровневом API StockSharp.

## Как работает стратегия

1. Раз в минуту проверяется, не устарели ли данные календаря. Если прошло больше `RefreshIntervalMinutes`, выполняется новое скачивание на ближайшие 7 дней.
2. Для каждой новости сохраняется время публикации, валюта, важность (количество звёзд), текст события и значения факта/прогноза/предыдущего отчёта.
3. Применяются фильтры по валютному списку, уровню важности и (опционально) по ключевому слову в названии новости.
4. Для подходящих событий формируется окно запрета торговли: от `Time - StopBeforeNewsMinutes` до `Time + StartAfterNewsMinutes`.
5. Флаг `IsNewsActive` становится `true`, если текущий момент попадает в любое окно. В журнал пишется сообщение с описанием новости; за пределами окна выводится ближайшее событие и флаг сбрасывается в `false`.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `EnableNewsFilter` | `true` | Включить / выключить фильтр новостей. |
| `UseLowImportance` | `false` | Учитывать ли события с одной звездой (низкая важность). |
| `UseMediumImportance` | `true` | Учитывать ли события с двумя звёздами (средняя важность). |
| `UseHighImportance` | `true` | Учитывать ли события с тремя звёздами (высокая важность). |
| `StopBeforeNewsMinutes` | `30` | Количество минут до новости, когда торговля должна быть остановлена. |
| `StartAfterNewsMinutes` | `30` | Количество минут после новости до возобновления торговли. |
| `CurrenciesFilter` | `USD,EUR,CAD,AUD,NZD,GBP` | Список валют, разделённых запятыми, для которых применяется фильтр. |
| `FilterByKeyword` | `false` | Включить фильтрацию по ключевому слову. |
| `Keyword` | `employment` | Ключевое слово, которое должно встречаться в названии события. |
| `RefreshIntervalMinutes` | `10` | Интервал между загрузками календаря (в минутах). Таймер проверяет состояние каждую минуту. |

## Логика остановки торговли

- Внутренний таймер работает каждую минуту и выполняет две задачи: обновляет календарь при необходимости и проверяет текущее время на попадание в запрещённое окно.
- Интервал рассчитывается как `[время новости − StopBeforeNewsMinutes, время новости + StartAfterNewsMinutes]`.
- Если событие активно, стратегия пишет информационное сообщение вида `News time: USD CPI m/m at 2024-04-12 12:30` и устанавливает `IsNewsActive = true`.
- Когда активных событий нет, в отладочном журнале отображается ближайшая подходящая новость и `IsNewsActive = false`.
- Внешние стратегии могут считывать флаг и приостанавливать выставление заявок, копируя поведение переменной `NEWS_ON` и функции `Comment()` из исходного эксперта.

## Особенности портирования

- Парсинг HTML реализован через регулярные выражения и способен обрабатывать альтернативный JSON-формат, если поставщик данных его добавит.
- Графические объекты (вертикальные линии и подписи), присутствовавшие в MQL-версии, не переносятся — вместо них используется логирование.
- Времена новостей интерпретируются как UTC, аналогично расчётам с `TimeGMTOffset()` в оригинале.
- Стратегия не совершает сделок самостоятельно и предназначена для совместного использования с торговыми алгоритмами, которым требуется остановка на время важных новостей.

## Практические рекомендации

1. Запустите стратегию в тестовом окружении StockSharp и привяжите к нужному инструменту.
2. Следите за сообщениями в журнале: они покажут, когда фильтр активен и какое событие его вызвало.
3. Перед отправкой ордеров в других стратегиях проверяйте значение `IsNewsActive`. Если оно `true`, отложите торговые действия до завершения окна.
4. Настройте список валют, уровни важности и ключевые слова под ваши торговые инструменты, чтобы концентрироваться на действительно значимых новостях.

