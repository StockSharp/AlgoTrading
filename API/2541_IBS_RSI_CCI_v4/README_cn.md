# IBS RSI CCI v4 策略

## 概述
**IBS RSI CCI v4 策略** 是一套逆势交易系统，将三种动量振荡指标结合在一起：

- **IBS（Internal Bar Strength）**：衡量收盘价在当根 K 线高低区间中的相对位置，并通过可配置的均线进行平滑。
- **RSI（Relative Strength Index）**：围绕 50 中性水平捕捉价格动量。
- **CCI（Commodity Channel Index）**：评估价格相对均线的偏离程度。

三个指标会按原始脚本的权重组合成一个综合振荡器。综合信号会受“步长阈值”限制，并通过高低点通道过滤。综合信号与通道中轴的交叉用于寻找反转机会。

## 交易逻辑
1. 订阅指定周期的 K 线（默认 4 小时）。
2. 计算每根已完成 K 线的 IBS 值，并用指定类型的均线进行平滑。
3. 计算 RSI 与 CCI 指标，使用各自的周期参数。
4. 按原脚本的权重构建综合振荡器：
   - IBS 贡献 × 700
   - RSI 相对 50 的偏离 × 9
   - 原始 CCI 值 × 1
5. 对综合信号应用步长阈值，避免信号在相邻 K 线之间跳跃过大。
6. 计算综合信号在设定窗口内的最高值与最低值，并进行二次平滑，得到动态包络带。其中心线即为基准线（对应原 MQL 指标的第二缓冲区）。
7. **仓位管理**
   - 当综合信号位于基准线下方且信号已确认时，平掉多单。
   - 当综合信号位于基准线上方且信号已确认时，平掉空单。
   - 当上一根确认 K 线的信号在基准线上方，而最新信号下穿基准线时，逆势开多。
   - 当上一根确认 K 线的信号在基准线下方，而最新信号上穿基准线时，逆势开空。

## 参数说明
| 参数 | 说明 |
|------|------|
| `CandleType` | 用于计算指标的 K 线类型。 |
| `IbsPeriod` | IBS 平滑所使用的周期。 |
| `IbsAverageType` | IBS 平滑所采用的均线类型（简单、指数、平滑、线性加权）。 |
| `RsiPeriod` | RSI 计算周期。 |
| `CciPeriod` | CCI 计算周期。 |
| `RangePeriod` | 综合信号滚动高低区间的窗口长度。 |
| `SmoothPeriod` | 包络带高低端再次平滑所用的周期。 |
| `RangeAverageType` | 包络带平滑使用的均线类型（简单、指数、平滑、线性加权）。 |
| `StepThreshold` | 综合信号在相邻 K 线之间允许的最大调整值。 |
| `SignalBar` | 用于确认信号的已完成 K 线数量（默认 1 与原 EA 相同）。 |
| `EnableLongOpen` | 是否允许开多。 |
| `EnableShortOpen` | 是否允许开空。 |
| `EnableLongClose` | 是否允许平多。 |
| `EnableShortClose` | 是否允许平空。 |
| `OrderVolume` | 下单时使用的基础成交量。 |

## 实现细节
- 步长阈值用于模拟 MQL 指标中的缓冲限制逻辑；增大该值会让综合信号变化更平滑。
- 由于 StockSharp 标准库不包含原指标使用的特殊平滑算法，本版本仅支持四种常见均线类型。
- `SignalBar` 参数会将入场/出场信号延后到已经收盘的 K 线，保持与原 EA 一致的“确认”逻辑。
- 策略默认是逆势模式：当信号向下穿越基准线时做多，向上穿越时做空。可通过布尔参数限制只做单边方向。

## 使用方法
1. 根据目标品种设置 `CandleType` 周期。
2. 根据波动特征调整各项周期与 `StepThreshold`。
3. 通过布尔参数启用或禁用多空开仓/平仓动作。
4. 设置 `OrderVolume` 控制下单数量，启动策略。默认启用了 `StartProtection()`，如需固定止损/止盈可在风险模块中另行配置。
5. 在图表（若可用）中观察价格、综合振荡器与成交记录。

## 与 MetaTrader 版本的差异
- 原 EA 中的资金管理、滑点设置改为使用 StockSharp 的 `OrderVolume` 与市价单接口。
- 保留了原始指标权重与逆势逻辑，但仅实现常用的均线平滑方式。
- 默认不包含固定止损/止盈，若需要可结合 StockSharp 的风险管理组件。
