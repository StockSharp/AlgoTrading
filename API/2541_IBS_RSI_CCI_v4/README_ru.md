# Стратегия IBS RSI CCI v4

## Общее описание
**IBS RSI CCI v4** — контртрендовая стратегия, построенная на комбинации трёх осцилляторов:

- **IBS (Internal Bar Strength)** — показывает положение закрытия внутри диапазона свечи и дополнительно сглаживается выбранным типом скользящей средней.
- **RSI (Relative Strength Index)** — оценивает импульс цены вокруг нейтрального уровня 50.
- **CCI (Commodity Channel Index)** — измеряет отклонение цены от скользящей средней.

Сигналы индикаторов масштабируются исходными коэффициентами из MQL-версии и объединяются в составной осциллятор. Полученная кривая ограничивается «шаговым» порогом и проходит через динамический диапазон максимумов/минимумов. Пересечения составного сигнала с центральной линией диапазона формируют точки входа и выхода.

## Логика работы
1. Подписка на свечи выбранного таймфрейма (по умолчанию 4 часа).
2. Вычисление IBS для каждой завершённой свечи и сглаживание по выбранному типу MA.
3. Получение значений RSI и CCI с заданными периодами.
4. Формирование составного осциллятора по формулам оригинального эксперта:
   - вклад IBS × 700;
   - отклонение RSI от уровня 50 × 9;
  - значение CCI × 1.
5. Применение «StepThreshold» — максимального шага изменения между соседними свечами.
6. Построение диапазона (Donchian-style): поиск максимума и минимума составного сигнала на окне `RangePeriod`, сглаживание верхней и нижней границ и вычисление средней линии (аналог второго буфера индикатора в MQL).
7. Управление позициями:
   - Закрывать лонг, если подтверждённый сигнал находится ниже средней линии.
   - Закрывать шорт, если подтверждённый сигнал находится выше средней линии.
   - Открывать лонг, когда предыдущий подтверждённый сигнал был выше линии, а текущий пересекает её сверху вниз (контртрендовое вход).
   - Открывать шорт, когда предыдущий сигнал был ниже линии, а текущий пересекает её снизу вверх.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей для расчёта индикаторов. |
| `IbsPeriod` | Период сглаживания IBS. |
| `IbsAverageType` | Тип скользящей средней для IBS (Simple, Exponential, Smoothed, Linear Weighted). |
| `RsiPeriod` | Период RSI. |
| `CciPeriod` | Период CCI. |
| `RangePeriod` | Длина окна для поиска экстремумов составного сигнала. |
| `SmoothPeriod` | Период сглаживания верхней и нижней границ диапазона. |
| `RangeAverageType` | Тип скользящей средней для сглаживания диапазона. |
| `StepThreshold` | Максимальный шаг изменения составного сигнала между свечами. |
| `SignalBar` | Количество закрытых свечей для подтверждения сигнала (1 — как в оригинале). |
| `EnableLongOpen` | Разрешение на открытие длинных позиций. |
| `EnableShortOpen` | Разрешение на открытие коротких позиций. |
| `EnableLongClose` | Разрешение на закрытие длинных позиций. |
| `EnableShortClose` | Разрешение на закрытие коротких позиций. |
| `OrderVolume` | Базовый объём рыночных заявок. |

## Особенности реализации
- Порог `StepThreshold` повторяет ограничение изменения буфера в MQL-скрипте. Чем значение больше, тем мягче изменяется составной сигнал.
- Используются только четыре стандартных типа скользящих средних, так как специфические фильтры из файла `SmoothAlgorithms.mqh` отсутствуют в библиотеке StockSharp.
- Параметр `SignalBar` обеспечивает задержку на количество закрытых свечей и позволяет избежать перерисовок.
- По умолчанию стратегия работает как контртрендовая. С помощью булевых параметров можно отключить любую сторону торговли.

## Порядок использования
1. Настройте `CandleType` в соответствии с торгуемым инструментом.
2. Подберите периоды индикаторов и значение `StepThreshold` под волатильность рынка.
3. Включите или отключите открытие/закрытие лонгов и шортов.
4. Задайте `OrderVolume`, запустите стратегию. При необходимости добавьте модули риска StockSharp для стоп-лоссов и тейк-профитов.
5. Отслеживайте динамику на графике: цены, составной сигнал, сделки.

## Отличия от версии MetaTrader
- Вместо параметров лотов и допустимого отклонения используются стандартные рыночные заявки StockSharp и параметр `OrderVolume`.
- Сохранены исходные весовые коэффициенты и логика входов/выходов, но применяются только доступные типы сглаживания.
- По умолчанию не задаются фиксированные стопы и тейки; при необходимости используйте защитные механизмы StockSharp.
