# Стратегия Exp Color TSI Oscillator

## Общее описание
- Конвертация советника MetaTrader 5 **Exp_ColorTSI-Oscillator** в инфраструктуру StockSharp.
- Полностью перестраивает осциллятор ColorTSI: двойное сглаживание True Strength Index с отложенной линией-триггером и набором методов сглаживания из `SmoothAlgorithms.mqh`.
- Торговые решения повторяют логику оригинала: вход при развороте осциллятора вверх или вниз относительно смещённой линии.

## Восстановление индикатора
- Исходные цены выбираются параметром `ColorTsiAppliedPrice` (close, open, median, typical, weighted, Demark и т. д.).
- Импульс (`price[n] - price[n-1]`) и его абсолютное значение проходят две ступени сглаживания:
  1. **Первая ступень** — метод `ColorTsiSmoothingMethod` (`Sma`, `Ema`, `Smma`, `Lwma`, `Jjma`, `Jurx`, `Parma`, `T3`, `Vidya`, `Ama`) с длиной `FirstLength` и фазой `FirstPhase` (используется для Jurik-подобных фильтров).
  2. **Вторая ступень** — аналогичный набор методов с параметрами `SecondLength`/`SecondPhase`, применёнными к результату первой ступени.
- Значение осциллятора вычисляется как `TSI = 100 * smoothMomentum / smoothAbsMomentum`; если знаменатель равен нулю, значение пропускается.
- Линия-триггер получается задержкой `TSI` на `TriggerShift` баров — точная копия буфера MetaTrader.
- Внутреннее хранилище значений организовано так, чтобы индекс `SignalBar` соответствовал обращению `CopyBuffer` (`SignalBar` — последний завершённый бар, `SignalBar + 1` — предыдущий и т. д.).

## Правила торговли
- Расчёты выполняются только на завершённых свечах типа `CandleType` (по умолчанию H4).
- Обозначим `TSI[k]` — значение осциллятора, `Trigger[k]` — смещённая линия.
- **Бычий контекст**: `TSI[SignalBar + 1] > Trigger[SignalBar + 1]` — предыдущий бар показывал рост импульса.
  - При `EnableShortExits = true` закрываем короткие позиции.
  - При `EnableLongEntries = true` и `TSI[SignalBar] ≤ Trigger[SignalBar]` открываем длинную позицию (разворот вверх после просадки).
- **Медвежий контекст**: `TSI[SignalBar + 1] < Trigger[SignalBar + 1]` — импульс был вниз.
  - При `EnableLongExits = true` закрываем длинные позиции.
  - При `EnableShortEntries = true` и `TSI[SignalBar] ≥ Trigger[SignalBar]` открываем короткую позицию.
- Сигналы привязываются ко времени анализируемого бара плюс полный таймфрейм; дополнительные входы по тому же бару блокируются `_lastLongEntryTime` / `_lastShortEntryTime`.
- Используются рыночные ордера. Перед разворотом противоположные позиции закрываются.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Источник данных для расчётов (любой `DataType`). | Свечи H4 |
| `Volume` | Фиксированный объём ордера вместо блога MM в MQL. | 0.1 |
| `FirstMethod`, `FirstLength`, `FirstPhase` | Первая ступень сглаживания импульса и модуля импульса. | SMA, 12, 15 |
| `SecondMethod`, `SecondLength`, `SecondPhase` | Вторая ступень сглаживания. | SMA, 12, 15 |
| `PriceMode` | Тип цены, подаваемый на вход осциллятора. | Close |
| `SignalBar` | Бар, сдвинутый на `SignalBar` позиций назад (1 = последний закрытый бар). | 1 |
| `TriggerShift` | Задержка линии-триггера в барах. | 1 |
| `EnableLongEntries` / `EnableShortEntries` | Разрешение на открытие длинных/коротких позиций. | true |
| `EnableLongExits` / `EnableShortExits` | Разрешение на закрытие позиций по противоположному контексту. | true |
| `StopLossPoints` | Стоп-лосс в пунктах (переводится через `PriceStep`). | 1000 |
| `TakeProfitPoints` | Тейк-профит в пунктах. | 2000 |

## Управление рисками
- В MQL-версии постановка SL/TP выполнялась через функции `TradeAlgorithms.mqh`. В C# используется `StartProtection`, куда передаются расстояния, умноженные на шаг цены инструмента.
- Значение 0 отключает соответствующий защитный приказ.
- Нет трейлинг-стопа или наращивания позиции — как и в оригинале.

## Отличия от версии MetaTrader
- Сложная схема `MM`/`MMMode` заменена фиксированным объёмом `Volume`, что обеспечивает повторяемость на разных счётах.
- Параметр проскальзывания (`Deviation_`) не используется, потому что у рыночных ордеров StockSharp нет прямого аналога.
- Сглаживание осциллятора полностью воссоздано средствами StockSharp (включая фазу Jurik через reflection), поэтому значения совпадают с MQL.
- Python-реализация специально не создавалась.

## Рекомендации по использованию
- Убедитесь, что по выбранному инструменту доступен поток, указанный в `CandleType` (для стандартных таймфреймов используйте `TimeSpan.FromHours(x).TimeFrame()`).
- Для корректной работы требуется `SignalBar ≥ TriggerShift`; пока истории недостаточно, сигналы пропускаются.
- Торговля начинается только после `IsFormedAndOnlineAndAllowTrading() = true`.
- Графическая панель отображает только свечи и сделки; индикаторные кривые рассчитываются внутри стратегии.
- Чтобы воспроизвести заводские настройки: обе ступени сглаживания — SMA с длиной 12, все флаги входа/выхода включены, стоп/тейк оставлены по умолчанию.
