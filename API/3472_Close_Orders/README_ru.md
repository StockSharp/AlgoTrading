# Стратегия Close Orders

## Общее описание
**Close Orders Strategy** — утилита для управления рисками, повторяющая логику MQL-советника *CloseOrders.mq4*. Стратегия непрерывно отслеживает плавающий финансовый результат открытых позиций и автоматически закрывает подходящие ордера при достижении целевой прибыли или заданного уровня убытка. Такой подход помогает защищать счёт и синхронизировать выходы в комплексных торговых системах.

## Принцип работы
1. Стратегия подписывается на настраиваемую серию свечей (по умолчанию 1 минута) и пересчитывает плавающий PnL после закрытия каждой свечи.
2. Плавающий результат вычисляется по позициям портфеля. Если указан магический номер, учитываются только позиции с `StrategyId`, совпадающим с выбранным значением.
3. Когда плавающая прибыль достигает или превышает целевое значение, все соответствующие ордера и позиции закрываются.
4. Если плавающий результат опускается до заданного уровня убытка (отрицательное число), запускается процедура принудительного закрытия для ограничения потерь.
5. Перед отправкой рыночных заявок стратегия отменяет активные ордера, удовлетворяющие фильтру магического номера, чтобы во время ликвидации не открывались новые позиции.

Процедура ликвидации повторяется до полного закрытия всех подходящих позиций, что позволяет корректно обработать частичные исполнения.

## Параметры
| Параметр | Описание |
| --- | --- |
| **Target Profit Money** | Минимальная величина плавающей прибыли (в валюте счёта), при которой инициируется закрытие. Значение должно быть больше нуля. |
| **Cut Loss Money** | Допустимый уровень плавающего убытка (в валюте счёта). Значение `0` отключает контроль по убытку. |
| **Magic Number** | Необязательный идентификатор стратегии. Если оставить поле пустым, будут обрабатываться все позиции; при заполнении закрываются только позиции с соответствующим `StrategyId`. |
| **Candle Type** | Тип свечей, используемый для периодической проверки PnL. При необходимости можно выбрать более короткий таймфрейм для ускоренной реакции. |

## Особенности реализации
- Магический номер из MQL сопоставляется со значениями `UserOrderId`/`StrategyId` в StockSharp. В управляемых стратегиях следует использовать одинаковый идентификатор.
- Код оформлен с использованием табуляции и соответствует общему шаблону конвертируемых стратегий.
- Перед ликвидацией позиции отменяются соответствующие отложенные ордера, что исключает повторный вход в рынок.
- При интеграции с живыми торговыми роботами можно дополнительно активировать защитные механизмы (например, `StartProtection()`).

## Рекомендации по применению
- Запускайте стратегию вместе с торговыми алгоритмами, которые проставляют собственный `StrategyId`, чтобы централизованно управлять выходом из позиций.
- Корректируйте параметр `Candle Type`, подбирая баланс между скоростью реакции и нагрузкой на систему.
- Подключите уведомления, чтобы оперативно узнавать о срабатывании автоматического закрытия позиций.
