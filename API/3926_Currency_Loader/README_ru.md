[English](README.md) | [中文](README_cn.md)

# Стратегия Currency Loader

Стратегия переносит служебный скрипт MetaTrader **Currency_Loader.mq4** на платформу StockSharp.
Она непрерывно отслеживает несколько таймфреймов свечей, регулярно выгружает их историю в CSV-файлы
и повторяет логику журналирования оригинала. Торговых операций стратегия не совершает — это чистый сервис для экспорта данных.

## Принцип работы

- При запуске создаётся каталог `Export_History/<symbol>` на основе идентификатора выбранного инструмента.
- Выбранные таймфреймы подписываются через высокоуровневый API `SubscribeCandles`. Завершённые свечи накапливаются в буфере до `MaxBarsInFile` записей.
- Периодический таймер (`FrequencyUpdateSeconds`) перезаписывает CSV-файлы, как только накоплено не менее `BarsMin` свечей.
- Каждая выгрузка полностью перезаписывает файл, чтобы поддерживать актуальный снимок истории, как в версии MQL.
- Опционально формируются сообщения в системный лог StockSharp (`AllowInfo`) и отдельный текстовый лог (`AllowLogFile`).

## Формат выгрузки

Для каждого активного таймфрейма создаётся файл `<symbol>_<TF>.csv` в каталоге экспорта. Формат идентичен оригинальному скрипту:

```
"Date" "Time" "Open" "High" "Low" "Close" "Volume"
2023.09.11,14:25,1.07230,1.07310,1.07180,1.07250,123
...
```

- Дата печатается в формате `yyyy.MM.dd`, время — `HH:mm` (точность до минут, аналог `TIME_MINUTES`).
- Цены форматируются с учётом шага цены инструмента, поэтому количество знаков соответствует поставщику данных.
- Объём округляется до ближайшего целого, как в MQL-скрипте.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `BarsMin` | Минимальное число завершённых свечей перед первой выгрузкой. | 100 |
| `MaxBarsInFile` | Максимум свечей, хранимых для каждого таймфрейма; старые строки отбрасываются. | 20000 |
| `FrequencyUpdateSeconds` | Интервал таймера, запускающего перезапись файлов. | 60 |
| `LoadM1` / `LoadM5` / ... / `LoadMN` | Включение выгрузки для соответствующего таймфрейма (M1, M5, M15, M30, H1, H4, D1, W1, MN1). | `false` |
| `AllowInfo` | Запись служебных сообщений в лог StockSharp. | `true` |
| `AllowLogFile` | Добавление строк в файл `LOGCurrency_Loader_<date>.log` внутри каталога экспорта. | `true` |

## Отличия от скрипта MQL

- Структура папок сохраняется, но имя инструмента очищается от недопустимых символов файловой системы.
- Таймер реализован средствами StockSharp, а не через `Sleep()`, поэтому корректно работает в тестах.
- Свечи получаются через `SubscribeCandles().Bind(...)`, вместо ручного `ArrayCopyRates`.
- Журналирование интегрировано с инфраструктурой StockSharp, при этом остаётся возможность вести отдельный файл.
- CSV сохраняет тот же заголовок, порядок и формат чисел, что и оригинал.

## Рекомендации по использованию

1. До запуска выберите инструмент и включите нужные таймфреймы в параметрах стратегии.
2. Убедитесь, что история свечей доступна, иначе требуемое значение `BarsMin` не будет достигнуто и файлы не создадутся.
3. Останавливайте стратегию, чтобы принудительно выполнить финальную выгрузку — после остановки буфер очищается.
4. Контролируйте содержимое каталога `Export_History/<symbol>` для получения CSV и при необходимости файла `LOGCurrency_Loader_<date>.log`.
