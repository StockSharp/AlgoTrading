# Стратегия XIT Three MA Cross
[English](README.md) | [中文](README_cn.md)

Эта стратегия повторяет эксперта MetaTrader 5 **XIT_THREE_MA_CROSS.mq5** на платформе StockSharp. Алгоритм синхронизирует три скользящих средних, проверяет расхождение линий MACD и рассчитывает объём сделки на основе ATR. Получается трендовая методика с подтверждением импульса, рассчитанная на среднесрочные движения ликвидных валютных пар или индексов.

## Общие сведения

- **Тип рынка**: Наиболее эффективна на инструментах, которые формируют устойчивые движения в рамках выбранного таймфрейма.
- **Используемые индикаторы**:
  - Медленная, промежуточная и быстрая скользящие средние (тип выбирается пользователем) на основном таймфрейме.
  - MACD (на EMA) для оценки направления импульса и разницы между линией и сигналом.
  - Два индикатора ATR одинаковой длины на независимых таймфреймах для вычисления стоп-лосса и тейк-профита.
- **Направление торгов**: Двусторонняя торговля, возможны длинные и короткие позиции.
- **Размер позиции**: Рассчитывается из заданного процента риска и дистанции стопа по ATR. Если у инструмента нет полной информации о тиках, стратегия возвращается к стандартному значению `Volume`.

## Логика торговли

### Вход в покупку

Длинная позиция открывается на закрытой свече, когда одновременно выполняются условия:

1. Значение MACD растёт относительно предыдущей свечи (`MACD[t] > MACD[t-1]`).
2. Сигнальная линия MACD также растёт.
3. Разница между MACD и сигналом превышает `MacdTriggerPoints * PriceStep`.
4. Промежуточная скользящая средняя увеличилась по сравнению с прошлым значением.
5. Быстрая скользящая средняя увеличилась.
6. Промежуточная средняя находится выше медленной.
7. Быстрая средняя выше промежуточной.
8. Оба значения ATR доступны для расчёта стопа и цели.

### Вход в продажу

Короткий вход является зеркальным отражением длинного сценария:

1. Линия MACD уменьшается относительно прошлой свечи.
2. Сигнальная линия MACD уменьшается.
3. Сигнальная линия превышает MACD минимум на `MacdTriggerPoints * PriceStep`.
4. Промежуточная средняя снижается относительно предыдущего значения.
5. Быстрая средняя снижается.
6. Промежуточная средняя ниже медленной.
7. Быстрая средняя ниже промежуточной.
8. ATR на обоих таймфреймах сформированы.

### Выход

- **Длинная позиция** закрывается при пересечении: быстрая средняя уходит ниже промежуточной, либо цена достигает ATR-стопа/тейк-профита.
- **Короткая позиция** закрывается, когда быстрая средняя поднимается выше промежуточной, либо при касании ценой уровней ATR.
- После фиксации позиции стратегия дожидается следующей свечи, что повторяет поведение исходного советника.

## Управление рисками

- **Стоп-лосс**: Дистанция равна значению ATR с таймфрейма `AtrStopCandleType`. Для покупок стоп = `Entry - ATR`, для продаж = `Entry + ATR`.
- **Тейк-профит**: Расстояние равно ATR с таймфрейма `AtrTakeCandleType`, уровни зеркально расположены относительно цены входа.
- **Процент риска**: Денежная потеря на единицу позиции оценивается по расстоянию до стопа. Если заданы `PriceStep` и `PriceStepCost`, используется стоимость тика. Иначе применяется чистая ценовая дистанция. Размер позиции = `RiskPercent%` от текущей стоимости портфеля, делённые на риск на единицу и округлённые вниз до шага объёма.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Таймфрейм, на котором рассчитываются скользящие средние и MACD. | Свечи 1 час |
| `SlowMaLength` / `IntermediateMaLength` / `FastMaLength` | Периоды скользящих средних. | 60 / 14 / 4 |
| `SlowMaType`, `IntermediateMaType`, `FastMaType` | Типы средних (Simple, Exponential, Smoothed, Weighted). | Simple |
| `MacdFastLength`, `MacdSlowLength`, `MacdSignalLength` | Быстрый, медленный и сигнальный периоды MACD. | 12 / 26 / 9 |
| `MacdTriggerPoints` | Минимальная дистанция между MACD и сигналом в пунктах инструмента. Конвертируется через `PriceStep`. | 7 |
| `AtrLength` | Период обоих ATR. | 14 |
| `AtrTakeCandleType` / `AtrStopCandleType` | Таймфреймы ATR для тейк-профита и стоп-лосса. | Свечи 4 часа |
| `RiskPercent` | Доля портфеля, которую допускается потерять в одной сделке. | 10% |

## Рекомендации по использованию

1. Подключайте стратегию к инструментам с корректными параметрами `PriceStep`, `PriceStepCost` и `VolumeStep`, чтобы позиционирование рассчитывалось точно.
2. Загрузите историю для всех таймфреймов подписки (`CandleType`, `AtrTakeCandleType`, `AtrStopCandleType`). При отсутствии ATR входы откладываются.
3. Алгоритм работает по закрытым свечам и игнорирует внутрисвечные колебания, аналогично исходному советнику, который считывает текущие и предыдущие буферы индикаторов.
4. При необходимости адаптируйте типы скользящих средних под специфику торгуемого рынка.

## Файлы

- `CS/XitThreeMaCrossStrategy.cs` – C#-реализация на высокоуровневом API StockSharp с подписками ATR и управлением риском.
- `README.md` – английская версия описания.
- `README_cn.md` – китайский перевод документации.
