# Стратегия Stopreversal Tm

## Общее описание
Stopreversal Tm — это прямая конвертация эксперта MetaTrader 5 `Exp_Stopreversal_Tm.mq5`. В основе лежит индикатор Stopreversal: он рассчитывает плавающий трейлинг-стоп от выбранного типа цены и формирует сигналы разворота при пересечении уровня ценой. Стратегия работает с одним инструментом и одним потоком свечей, сохраняя поддержу пользовательского торгового сеанса из оригинальной версии.

## Формирование сигналов
Индикатор Stopreversal получает опорную цену из выбранного режима (close, open, медианная цена, trend-following, Demark и т.д.), после чего смещает трейлинг на величину `Sensitivity` (`nPips`). Если новая цена оказывается выше трейлинга, а предыдущая свеча была ниже, возникает сигнал на покупку. Если цена опускается ниже трейлинга, а предыдущая свеча была выше, появляется сигнал на продажу. Бычий сигнал одновременно инициирует закрытие шортов и открытие лонга, медвежий — закрытие лонгов и открытие шорта.

Чтобы воспроизвести поведение советника, ввод `SignalBar` преобразован в параметр `Signal Bar Delay`: он позволяет дождаться заданного числа завершённых свечей перед исполнением сигнала и тем самым исключает работу по ещё формирующемуся бару.

## Торговая сессия и управление позицией
Как и в оригинале, можно ограничить торговлю временным окном. Параметр `Use Time Filter` включает или отключает проверку, а `Start Hour/Minute` и `End Hour/Minute` задают начало и конец сеанса. При выходе из допустимого интервала открытая позиция немедленно закрывается. Даже при отключённом фильтре сигналы на закрытие продолжают обрабатываться.

Стратегия работает в неттинговой логике: при смене направления сначала закрывается текущая позиция, затем выполняется противоположная сделка. Это исключает одновременное удержание разнонаправленных позиций.

## Параметры
- **Allow Buy Entries / Allow Sell Entries** – разрешить или запретить открытие лонгов/шортов по соответствующим сигналам.
- **Allow Long Exits / Allow Short Exits** – определить, можно ли закрывать позицию по встречному сигналу.
- **Use Time Filter** – включить фильтр торгового времени.
- **Start Hour / Start Minute / End Hour / End Minute** – параметры временного окна (начало включительно, конец исключительно), поддерживается переход через полночь.
- **Sensitivity (`nPips`)** – коэффициент, определяющий расстояние трейлинга от цены (например, `0.004` соответствует 0.4%).
- **Signal Bar Delay (`SignalBar`)** – количество завершённых баров до исполнения сигнала (`0` – сразу, `1` – на предыдущей свече, как в исходнике).
- **Candle Type** – тип (таймфрейм) свечей для расчёта.
- **Applied Price** – выбор ценового ряда для индикатора (close, open, median, trend-following, Demark и др.).

## Особенности реализации
- Логика вычисления индикатора перенесена внутрь стратегии и полностью повторяет MQL5-формулу `nPips` без использования внешних буферов.
- Последовательность операций (сначала закрытие, затем открытие) и работа с торговыми сессиями сохранены из оригинала.
- Применяется высокоуровневый API StockSharp: подписка на свечи, очередь задержанных сигналов и рыночные приказы `BuyMarket` / `SellMarket`. Функции управления капиталом из MetaTrader не перенесены, так как в StockSharp объём позиций задаётся напрямую.
