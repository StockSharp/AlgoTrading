# Стратегия Ultra MFI MMRec

## Общее описание
**Ultra MFI MMRec** — перенос эксперта MetaTrader 5 `Exp_UltraMFI_MMRec`. Стратегия использует многоступенчатое сглаживание индикатора Money Flow Index и адаптивный манименеджмент по серии убыточных сделок. Два внутренних счётчика показывают, сколько ступеней сглаживания указывают вверх или вниз. Пересечения этих счётчиков формируют торговые сигналы, а результат последних сделок определяет объём следующей позиции.

## Логика работы
1. **Базовый индикатор.** Рассчитывается Money Flow Index с настраиваемым периодом на выбранном типе свечей.
2. **Лестница сглаживания.** Значение MFI проходит через набор средних, где каждая ступень увеличивает длину на фиксированный шаг. Доступны методы Simple, Exponential, Smoothed, Linear Weighted и Jurik (прочие варианты MT5 недоступны в StockSharp).
3. **Направленные счётчики.** Для каждой свечи сравниваются текущее и предыдущее значение каждой ступени. Если ступень растёт — увеличивается бычий счётчик, иначе медвежий. Затем оба счётчика дополнительно сглаживаются финальной средней.
4. **Смещение сигнала.** Стратегия обрабатывает только закрытые свечи. Параметр `SignalShift` задаёт, сколько завершённых баров учитывать при сравнении счётчиков, повторяя поведение MT5 с `SignalBar=1`.
5. **Сигналы входа и выхода.**
   * Если на предыдущем баре бычий счётчик был выше медвежьего и на последнем баре произошло пересечение вниз (`bulls < bears`), стратегия закрывает короткие позиции и при отсутствии позиции открывает длинную.
   * Если на предыдущем баре преобладали медведи и на последнем баре счётчики пересеклись вверх (`bulls > bears`), закрываются длинные позиции и при пустом портфеле открывается шорт.
   * При необходимости можно задать процентные уровни тейк-профита и стоп-лосса через `StartProtection`.
6. **Манименеджмент.** После закрытия каждой позиции анализируется реализованная прибыль/убыток:
   * Хранятся последние `BuyTotalTrigger` сделок в лонг. Если количество убыточных сделок достигает `BuyLossTrigger`, следующий вход в покупку выполняется объёмом `ReducedVolume`, иначе — `NormalVolume`.
   * Для коротких позиций используется независимый набор параметров `SellTotalTrigger` и `SellLossTrigger`.

## Параметры
- **CandleType** — тип свечей/таймфрейм для расчёта сигналов.
- **MfiPeriod** — период индикатора Money Flow Index.
- **StepSmoothing / FinalSmoothing** — тип средних для ступеней и финальных счётчиков.
- **StartLength / StepSize / StepsTotal** — начальная длина, шаг и количество ступеней сглаживания.
- **FinalSmoothingLength** — длина итогового сглаживания счётчиков.
- **SignalShift** — количество закрытых баров, используемых при сравнении счётчиков.
- **NormalVolume / ReducedVolume** — стандартный и уменьшенный торговый объём.
- **BuyTotalTrigger / BuyLossTrigger** — глубина истории и порог убыточных сделок для снижения объёма в лонг.
- **SellTotalTrigger / SellLossTrigger** — аналогичные настройки для шортов.
- **AllowLongEntries / AllowShortEntries / AllowLongExits / AllowShortExits** — включение/отключение входов и выходов по направлениям.
- **TakeProfitPercent / StopLossPercent** — необязательные процентные уровни тейк-профита и стоп-лосса.

## Практические советы
- Для корректной работы лестницы сглаживания требуется достаточный объём истории. Дождитесь формирования всех индикаторов перед анализом сигналов.
- В StockSharp отсутствуют специфические режимы MT5 (JurX, Parabolic, VIDYA, AMA), поэтому используются ближайшие доступные аналоги. Jurik по умолчанию лучше всего воспроизводит оригинальный индикатор UltraMFI.
- Манименеджмент опирается на реализованный PnL. В тестах необходимо исполнять заявки до конца, чтобы после закрытия позиции фиксировался результат.
- Стратегия открывает новую позицию только после выхода в «ноль». При появлении сигнала разворота сначала закрывается текущая позиция, и только затем на следующем подходящем баре рассматривается вход в противоположную сторону.
