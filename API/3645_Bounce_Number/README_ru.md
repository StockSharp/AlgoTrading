# Стратегия Bounce Number

## Обзор
**Bounce Number Strategy** — это порт MetaTrader-индикатора `BounceNumber_V0.mq4` / `BounceNumber_V1.mq4` на платформу StockSharp. Оригинальный инструмент рисовал на графике таблицу, показывающую, сколько раз цена отскакивала внутри симметричного канала перед тем, как пробить его. В варианте на C# логика пересчёта реализована через высокоуровневый API StockSharp: стратегия подписывается на свечи, отслеживает касания верхней и нижней границ и ведёт распределение количества отскоков по каждому завершённому циклу.

В отличие от визуального индикатора MetaTrader, порт работает как компонент стратегии. Статистика доступна через свойство `BounceDistribution` и дублируется в информационном логе. Это позволяет подключать к стратегии внешние интерфейсы или системы отчётности и использовать собранные данные без привязки к конкретному терминалу.

## Алгоритм работы
1. При старте стратегия проверяет, что у инструмента задан шаг цены (`PriceStep`). Параметр `ChannelPoints` интерпретируется в "пунктах" и требует корректной метаданные инструмента.
2. Подписка `SubscribeCandles` создаётся на тип свечей из параметра `CandleType`. Обработчик получает только полностью сформированные свечи (`CandleStates.Finished`).
3. Первая свеча задаёт центр канала (её цена закрытия). Полуширина канала равна `ChannelPoints * PriceStep` — полностью аналогично оригинальному коду на MQL.
4. Каждая новая свеча увеличивает счётчик бара в текущем цикле и проходит три проверки:
   - **Пробой**: если диапазон свечи достигает уровней `центр ± 2 * полуширина`, цикл завершается и текущий счётчик отскоков записывается в распределение.
   - **Отскок от нижней границы**: если свеча пересекает нижнюю границу и предыдущим событием был не нижний отскок, счётчик увеличивается, а направление последнего касания становится "низ".
   - **Отскок от верхней границы**: зеркальное правило для верхней границы.
5. Если цикл длится дольше, чем `MaxHistoryCandles` (при положительном значении параметра), выполняется принудительный сброс. Это защищает от ситуаций, когда цена долго дрейфует внутри канала и распределение не обновляется.
6. При каждом сбросе стратегия пишет в лог сообщение с количеством отскоков и обновляет словарь `BounceDistribution`, который можно прочитать из пользовательского интерфейса или кода.

Стратегия умышленно не выставляет заявки — её назначение аналитическое. Чтобы повторить внешний вид оригинального индикатора, можно привязать к стратегии пользовательский виджет, читающий распределение и отображающий его в виде таблицы или гистограммы.

## Параметры
| Имя | Тип | Значение по умолчанию | Аналог в MQL | Описание |
| --- | --- | --- | --- | --- |
| `MaxHistoryCandles` | `int` | `10000` | `maxbar` | Максимальное число свечей в одном цикле до принудительного сброса. Значение `0` отключает ограничение. |
| `ChannelPoints` | `int` | `300` | `BPoints` | Полуширина канала в пунктах (множитель `PriceStep`). |
| `CandleType` | `DataType` | таймфрейм M1 | `TF` | Тип свечей, используемый для расчётов. |

## Отличия от версии на MetaTrader
- Вместо текстовых объектов на графике используется словарь `Dictionary<int, int>`, куда записывается гистограмма отскоков. Это упрощает экспорт данных и их последующую визуализацию.
- Параметры, связанные с оформлением (цвета, шрифты, кнопка «Start»), удалены — они не влияли на расчётную часть.
- Ограничение `MaxHistoryCandles` стало опциональным и работает как для исторических данных, так и в реальном времени.
- Все сообщения и комментарии в коде переведены на английский язык в соответствии с требованиями репозитория.

## Рекомендации по использованию
- Перед запуском убедитесь, что у инструмента корректно заданы `PriceStep` и другие биржевые метаданные — без этого стратегия не сможет перевести пункты в денежные величины.
- Используйте меньшие значения `ChannelPoints` для высокочастотных или низковолатильных инструментов и увеличивайте параметр на долгосрочных таймфреймах.
- Чтобы воспроизвести режим пакетного расчёта, как в MQL, включите историю в коннекторе (`HistoryBuildMode`) и дождитесь загрузки нужного диапазона свечей — распределение заполнится автоматически.
- Для визуализации статистики подключите пользовательский интерфейс, который слушает логи стратегии или читает `BounceDistribution` напрямую.
