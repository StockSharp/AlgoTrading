# Stoch Levels 策略

## 概述
**Stoch Levels 策略** 是 MetaTrader 4 EA `Stoch.mq4` 的直接移植版本。原始脚本依赖于日内切换，在每个交易日开始之前利用上一根 K 线的最高价与最低价计算自定义挂单价格。本 C# 版本遵循完全相同的逻辑，并利用 StockSharp 的高级策略 API 来实现。

策略会对上一根 K 线的振幅进行扩展（默认乘数为 `1.1`），然后根据扩展后的区间布置两个限价挂单：

- 在上一根 K 线收盘价之上半个扩展区间处放置 **卖出限价** 挂单。
- 在上一根 K 线收盘价之下半个扩展区间处放置 **买入限价** 挂单。

任一挂单成交后，策略会立即根据设置的价格步长距离提交止损和止盈订单。当新的交易日开始时，所有持仓与挂单都会被取消，这一点与原脚本在 23:59 清理仓位的逻辑一致。

## 交易逻辑
1. 订阅指定的 K 线序列（默认是日线），并等待完整收盘的 K 线。
2. 当检测到新的交易日：
   - 平掉所有当前持仓，并取消所有保护性或进场挂单。
   - 使用上一根 K 线计算扩展区间 `range * RangeMultiplier`。
   - 在 `Close + range / 2` 处放置卖出限价单，在 `Close - range / 2` 处放置买入限价单。
3. 当挂单成交时，根据设定的价格步长距离提交对应方向的止损与止盈订单。
4. 一旦止损或止盈任一被触发，会取消其对应的另一张保护单，并等待下一次日内重置。

## 参数
| 参数 | 说明 | 默认值 | 备注 |
| --- | --- | --- | --- |
| `TakeProfitPoints` | 以价格步长表示的止盈距离。 | `20` | 对应 MQL 脚本中的 `TakeProfit` 输入，设置为 `0` 表示不使用止盈。 |
| `StopLossPoints` | 以价格步长表示的止损距离。 | `40` | 对应 MQL 脚本中的 `StopLoss` 输入，设置为 `0` 表示不使用止损。 |
| `RangeMultiplier` | 作用于上一根 K 线振幅的倍数。 | `1.1` | 与 MQL 代码中固定的 `1.1` 乘数一致。 |
| `OrderVolume` | 每笔挂单的下单量。 | `1` | 对应原脚本中的 `Lots` 参数。 |
| `CandleType` | 用于驱动逻辑的 K 线类型。 | `日线` | 如需在其他周期运行，可修改此参数。 |

所有参数均通过 `Param()` 定义，可直接用于优化或图形界面展示。

## 风险管理
- 多头持仓会附带 **卖出止损** 与 **卖出限价** 保护单；空头持仓则使用 **买入止损** 与 **买入限价** 保护单。
- 保护单与开仓单使用相同的数量，任意一张保护单成交后都会取消另一张，以避免重复平仓。
- 每当新 K 线到来都会执行完全平仓与撤单，确保策略不会隔夜持仓。

## 移植说明
- 原始 MQL 通过全局变量避免重复挂单，C# 版本改为内部记录上一次处理的日期（`_lastProcessedDay`）。
- MQL 中在午夜强制平仓的循环，被封装为 `ResetOrders()` 方法，用于撤销所有挂单并在仍有仓位时发送市价平仓指令。
- MQL 使用 `OrderSend` 参数直接设置止损/止盈，本实现改为显式提交保护性订单。
- 原脚本里出现但未实际使用的参数（如 TrailingStop、MM、Risk 等）在移植中仍保持不启用状态。

## 使用建议
1. 将策略附加到目标品种，并根据需要调整下单量、止盈止损距离以及 K 线周期。
2. 请确认标的提供了正确的 `PriceStep`。如果缺失，策略会使用 `1` 作为默认值并输出日志提示。
3. 建议保持日线驱动，以匹配原策略的“每日一次”逻辑。
4. 通过日志观察每日重置、挂单下发以及保护单设置的流程是否符合预期。

## 文件结构
- `CS/StochLevelsStrategy.cs` – 策略实现。
- `README.md`、`README_cn.md`、`README_ru.md` – 多语言文档。
