# Стратегия Stoch Levels

## Общее описание
**Stoch Levels Strategy** — это перенос советника MetaTrader 4 `Stoch.mq4` в инфраструктуру StockSharp. Исходный скрипт привязан к границам торгового дня: перед началом новой сессии он вычисляет ценовые уровни на основании предыдущей свечи и размещает два отложенных ордера. C# версия полностью повторяет эту идею, используя высокоуровневый API стратегий.

Стратегия расширяет диапазон предыдущей свечи (по умолчанию множитель `1.1`) и размещает:

- **Sell Limit** выше цены закрытия на половину расширенного диапазона.
- **Buy Limit** ниже цены закрытия на половину расширенного диапазона.

При исполнении любого из ордеров создаются зеркальные защитные заявки — стоп-лосс и тейк-профит с фиксированным отступом в шагах цены. В начале каждого нового дня все позиции и отложенные заявки закрываются, что соответствует блоку «23:59» из MQL-версии.

## Логика работы
1. Подписка на выбранный тип свечей (по умолчанию дневные) и ожидание их полного закрытия.
2. При поступлении новой свечи:
   - Закрыть текущую позицию и отменить все активные защитные/входные ордера.
   - Рассчитать расширенный диапазон `range * RangeMultiplier` по предыдущей свече.
   - Выставить новые Sell Limit и Buy Limit на уровнях `Close ± range / 2`.
3. После срабатывания ордера сформировать стоп-лосс и тейк-профит с нужным отступом в шагах цены.
4. Если один из защитных ордеров сработал, второй отменяется, и стратегия ждёт следующего ежедневного пересчёта.

## Параметры
| Параметр | Описание | Значение по умолчанию | Комментарий |
| --- | --- | --- | --- |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены. | `20` | Аналог параметра `TakeProfit` в MQL. Значение `0` отключает тейк-профит. |
| `StopLossPoints` | Дистанция стоп-лосса в шагах цены. | `40` | Аналог `StopLoss` из MQL. Значение `0` отключает стоп-лосс. |
| `RangeMultiplier` | Множитель диапазона предыдущей свечи. | `1.1` | Совпадает с жёстко заданным коэффициентом из исходника. |
| `OrderVolume` | Объём ордера. | `1` | Соответствует параметру `Lots`. |
| `CandleType` | Тип свечей, определяющий торговой период. | `Дневные` | Можно изменить для других таймфреймов. |

Параметры объявлены через `Param()`, что обеспечивает оптимизацию и отображение в интерфейсе.

## Управление рисками
- Для длинных позиций выставляется пара **Sell Stop** + **Sell Limit**; для коротких — зеркальные **Buy Stop** + **Buy Limit**.
- Объём защитных ордеров совпадает с объёмом входа. После исполнения одного защитного ордера второй отменяется.
- Каждый новый день стратегия полностью закрывает позицию и снимает отложенные заявки, исключая перенос позиций через ночь.

## Особенности переноса
- В MQL использовались глобальные переменные для контроля «один раз в день». Теперь это реализовано через поле `_lastProcessedDay`.
- Ночной блок закрытия позиций перенесён в метод `ResetOrders()`, который отменяет все ордера и отправляет команду `ClosePosition()` при необходимости.
- Параметры `StopLoss` и `TakeProfit` реализуются отдельными заявками StockSharp, а не встроенными полями `OrderSend`.
- Параметры `TrailingStop`, `MM`, `Risk`, `LotLimit` из исходника не имели логики — они сохранены как неиспользуемые.

## Рекомендации по использованию
1. Настройте объём, дистанции защитных ордеров и тип свечей в соответствии с торгуемым инструментом.
2. Убедитесь, что у бумаги корректно задан `PriceStep`. Если нет, стратегия будет использовать значение `1` и запишет предупреждение в лог.
3. Сохраните дневной таймфрейм, чтобы поведение соответствовало оригинальному советнику.
4. Отслеживайте журнал сообщений: там отражаются ежедневный сброс, выставление ордеров и постановка защитных заявок.

## Состав пакета
- `CS/StochLevelsStrategy.cs` — реализация стратегии.
- `README.md`, `README_cn.md`, `README_ru.md` — документация на разных языках.
