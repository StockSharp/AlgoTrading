# VIDYA N Bars Borders Martingale

## Обзор
Оригинальный советник MetaTrader использует индикатор «VIDYA N Bars Borders» и модуль мартингейла для наращивания объёма после убыточных сделок. В версии для StockSharp сохраняется базовая идея: покупки выполняются при уходе цены ниже адаптивной нижней границы канала, продажи — при выходе выше верхней. Центральная линия формируется адаптивным скользящим средним (аналогом VIDYA), ширина коридора задаётся индикатором ATR. Блок управления капиталом увеличивает размер следующей позиции после убытка и контролирует лимиты по объёму.

## Логика работы
1. Подписка на свечи выбранного таймфрейма.
2. Расчёт `KaufmanAdaptiveMovingAverage` в качестве замены VIDYA и построение ATR-оболочки вокруг него.
3. Если закрытие завершённой свечи падает ниже нижней границы, стратегия открывает/разворачивает длинную позицию (или короткую, если активирован флаг `Reverse`).
4. Если закрытие поднимается выше верхней границы, открывается/разворачивается короткая позиция (или длинная при `Reverse = true`).
5. Между подряд идущими входами соблюдается минимальная ценовая дистанция, чтобы исключить повторный вход «в ту же точку».
6. При достижении заданной денежной цели по плавающей прибыли позиция полностью закрывается.
7. После закрытия сделки объём следующего ордера либо возвращается к базовому значению (если результат положительный), либо умножается на коэффициент мартингейла. Объём дополнительно выравнивается по шагу инструмента и ограничивается максимальными значениями.

## Параметры
| Имя | Описание |
| --- | --- |
| `Candle Type` | Тип свечей для торговли. |
| `CMO Period` | Окно расчёта коэффициента эффективности для адаптивного среднего. |
| `EMA Period` | Период сглаживания адаптивного среднего. |
| `ATR Period` | Количество баров для половины ширины канала ATR. |
| `Profit Target` | Денежная цель, при достижении которой позиция закрывается. |
| `Increase Ratio` | Множитель объёма после убыточной сделки. |
| `Max Position Volume` | Жёсткий предел объёма одной позиции. |
| `Max Total Volume` | Предел суммарной экспозиции стратегии. |
| `Max Positions` | Максимум одновременных позиций (в порте ведётся одна нетто-позиция). |
| `Minimum Step` | Минимальная дистанция между входами в пунктах. |
| `Base Volume` | Исходный объём ордера до применения мартингейла. |
| `Reverse Signals` | Инверсия сигналов на покупку/продажу. |

## Особенности реализации
- В библиотеке StockSharp отсутствует прямой индикатор VIDYA. Используется `KaufmanAdaptiveMovingAverage` с настраиваемыми окнами эффективности и сглаживания, что позволяет приблизить адаптивное поведение оригинала без стороннего кода.
- Управляется только одна нетто-позиция. В MetaTrader можно было ставить очередь ордеров; в StockSharp каждый сигнал открывает новую позицию или разворачивает текущую. Мартингейл применяется к размеру следующей сделки.
- Минимальный шаг и приведение объёма опираются на свойства инструмента (`PriceStep`, `VolumeStep`, `MinVolume`, `MaxVolume`). Убедитесь, что эти параметры заданы при запуске стратегии.
- Контроль прибыли выполняется по показателю `PnL` стратегии и последнему закрытию свечи. Для реальной торговли требуется подключить стратегию к портфелю, который предоставляет фактическую реализацию PnL.

## Файлы
- `CS/VidyaNBarsBordersMartingaleStrategy.cs` — реализация стратегии на C#.
