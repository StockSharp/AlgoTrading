# Стратегия Candle
[English](README.md) | [中文](README_cn.md)

## Обзор
**Candle Strategy** — это точный порт классического эксперта MT5 «Candle.mq5». Стратегия анализирует цвет каждого завершённого бара на выбранном таймфрейме и синхронизирует позицию с последним закрытием. Бычья свеча приводит к открытию длинной позиции, медвежья — короткой, а плоская свеча оставляет позицию без изменений. Управление рисками реализовано через тейк-профит и трейлинг-стоп в пунктах, которые конвертируются в абсолютные цены с учётом шага цены инструмента.

Обработка происходит только после формирования свечи, чтобы исключить шум внутри бара. Перед началом торговли стратегия проверяет, что в истории имеется минимум `MinBars * 2` завершённых свечей, а между торговыми операциями выдерживается настраиваемая пауза. Это позволяет реализовать логику оригинального MetaTrader-советника средствами высокоуровневого API StockSharp без прямой работы с буферами цен.

## Торговая логика
### Подготовка
- Используются только свечи типа `CandleType`; дополнительные источники данных не требуются.
- До появления не менее `2 * MinBars` завершённых свечей сделки не совершаются.
- Торговля разрешена только при готовности стратегии (`IsFormedAndOnlineAndAllowTrading`).
- Между любыми двумя операциями выдерживается интервал `TradeCooldown` (по умолчанию 10 секунд).

### Правила входа и реверса
1. **Отсутствует позиция:**
   - Открыть длинную позицию (`BuyMarket`), если свеча закрылась выше открытия.
   - Открыть короткую позицию (`SellMarket`), если свеча закрылась ниже открытия.
2. **Уже есть позиция:**
   - При длинной позиции и появлении медвежьей свечи продать объём `|Position| + Volume`, тем самым закрыв лонг и сразу перевернувшись в шорт размером `Volume`.
   - При короткой позиции и появлении бычьей свечи купить объём `|Position| + Volume`, закрыв шорт и тут же открыв лонг размером `Volume`.
3. **Нейтральная свеча:**
   - Если закрытие равно открытию, вручную ничего не делается; выход возможен только по защитным ордерам.

### Управление рисками и выходы
- Метод `StartProtection` устанавливает тейк-профит и трейлинг-стоп, заданные в пунктах. Значение пункта вычисляется как `(PriceStep * 10)`, что повторяет «digits adjust» из оригинального эксперта для инструментов с 3 или 5 знаками после запятой.
- Трейлинг-стоп активен, только если `TrailingStopPips` больше нуля, и автоматически следует за ценой при движении в прибыль.
- Тейк-профит закрывает позицию при достижении заданной дистанции. После исполнения любой защиты противоположный ордер отменяется.
- Ручные реверсы по цвету свечи закрывают предыдущую позицию и сразу открывают новую в противоположную сторону.

## Параметры
- `CandleType` — таймфрейм свечей для анализа (по умолчанию 15 минут).
- `TakeProfitPips` — расстояние до тейк-профита в пунктах (по умолчанию 50).
- `TrailingStopPips` — расстояние трейлинг-стопа в пунктах (по умолчанию 30).
- `MinBars` — минимальное количество баров, необходимое до первой сделки (по умолчанию 26, что означает ожидание 52 завершённых свечей).
- `TradeCooldown` — пауза после каждой торговой операции (по умолчанию 10 секунд).

Задайте свойство `Volume` стратегии равным требуемому объёму сделки. При реверсе стратегия автоматически отправляет достаточный объём, чтобы закрыть текущую позицию и открыть новую.

## Особенности реализации
- Обрабатываются только завершённые свечи (`CandleStates.Finished`), что соответствует работе MQL-советника через функции `CopyOpen/CopyClose`.
- Используется высокоуровневый API StockSharp: подписка через `SubscribeCandles`, обработка в `Bind`, исполнение приказов через `BuyMarket` и `SellMarket`.
- Управление защитными ордерами полностью доверено `StartProtection`, поэтому нет необходимости самостоятельно отслеживать стопы и тейки.
- Расчёт пункта `(PriceStep * 10)` воспроизводит корректировку для трёх- и пятизначных котировок.
- Поскольку входы завязаны на цвет последней свечи, стратегия часто находится в рынке, попеременно сменяя направление при каждом изменении цвета.

Параметры дистанций в пунктах, паузу и таймфрейм следует адаптировать под выбранный инструмент. Значения по умолчанию соответствуют оригинальному эксперту MT5, но могут быть оптимизированы средствами StockSharp.
