# Стратегия iTrade

Стратегия iTrade — это конвертированный из MetaTrader эксперт **iTrade**, предназначенный для ручного сопровождения коротких позиций. Она сохраняет логику оригинальной кнопки на графике: по запросу пользователя открывается новая сделка на продажу по правилам мартингейла, после чего стратегия отслеживает плавающий результат всех шортов и при достижении целевых значений закрывает самую прибыльную и самую убыточную сделки.

## Основная логика

- Сделки открываются только по вызову `QueueSellRequest()`.
- Первая заявка использует параметр **Initial Volume**. После каждого убыточного закрытия объём следующей заявки умножается на **Martingale Multiplier**, при прибыльном закрытии серия сбрасывается к базовому объёму.
- Плавающий результат рассчитывается по лучшей цене продажи. Когда средняя прибыль на позицию достигает **Average Profit Target**, стратегия закрывает две сделки (самую прибыльную и самую убыточную) в пределах первых **Base Trade Count** позиций.
- Если открытых сделок больше, чем **Base Trade Count**, применяется повышенный порог **Extended Profit Target**.
- Расчёт прибыли выполняется с использованием `PriceStep` и `StepPrice`; при их отсутствии стратегия завершит запуск с исключением.

## Параметры

| Имя | Описание |
| --- | -------- |
| `InitialVolume` | Базовый объём для первой сделки мартингейла. |
| `MartingaleMultiplier` | Множитель, применяемый после убыточной сделки. |
| `AverageProfitTarget` | Средняя плавающая прибыль (в валюте счёта) для закрытия сделок в первой группе. |
| `ExtendedAverageProfitTarget` | Средняя плавающая прибыль при количестве сделок больше базового. |
| `BaseTradeCount` | Размер первой группы сделок. |
| `ControlInterval` | Интервал запуска внутреннего таймера. |

## Как использовать

1. Перед запуском укажите `Security`, `Portfolio` и нужные параметры.
2. Вызывайте `QueueSellRequest()` для открытия очередной сделки на продажу. Стратегия вычислит объём и выставит рыночный ордер.
3. Хранится история до 200 закрытых сделок для восстановления мартингейл-последовательности.
4. Закрытие выполняется рыночными заявками на покупку с объёмом целевой сделки.

## Отличия от версии MetaTrader

- Вместо кнопки на графике используется метод `QueueSellRequest()`.
- Все заявки исполняются через механизмы StockSharp, частичные исполнения объединяются автоматически.
- Порог прибыли рассчитывается на основе `StepPrice`, тогда как в MetaTrader использовались встроенные функции прибыли по тикету.

