# Стратегия WOC 0.1.2 (моментум)

## Обзор
Стратегия представляет собой порт MetaTrader-советника «WOC.0.1.2» на высокоуровневый API StockSharp. Логика работает с обновлениями котировок Level 1, отслеживает последовательности быстрого роста или падения цены спроса (Ask) и при выполнении условий открывает позицию в сторону прорыва. Одновременно может быть открыта только одна позиция, что полностью повторяет поведение исходного MQL-робота.

## Данные и исполнение
- **Источники данных**: лучшие цены Bid и Ask (Level 1). Дополнительные индикаторы и свечи не требуются.
- **Исполнение**: рыночные заявки. Стоп-ордеры моделируются внутри стратегии посредством контроля текущих котировок.

## Логика входа
1. Хранится последняя цена Ask и количество подряд идущих новых максимумов (счётчик `up`) и минимумов (счётчик `down`).
2. Если любой счётчик достигает значения `SequenceLength`, проверяется длительность серии — она должна быть не больше `SequenceTimeoutSeconds` секунд.
3. Если `down` больше `up`, открывается короткая позиция, иначе — длинная. Таким образом воспроизводится условие `if (up < down)` из MQL-версии.
4. После каждой попытки входа оба счётчика и исходные цены сбрасываются.

## Управление позицией
- **Начальный стоп**: сразу после открытия сделки рассчитывается уровень стоп-лосса на расстоянии `StopLossTicks` шагов цены от текущего Bid (для лонга) или Ask (для шорта).
- **Трейлинг-стоп**: когда цена проходит в прибыль `TrailingStopTicks` шагов, стоп подтягивается к цене так, чтобы находиться на расстоянии `TrailingStopTicks`, но только если старый стоп был не ближе, чем две такие дистанции. Это повторяет условие `StopLoss < Bid - 2 * TrailingStop` / `StopLoss > Ask + 2 * TrailingStop` оригинала.
- **Выход**: при пересечении сохранённого стоп-уровня текущим Bid/Ask позиция закрывается рыночной заявкой, после чего состояние сбрасывается.

## Размер позиции
Доступны два режима:
- **Фиксированный лот** — используется значение параметра `LotSize`.
- **Автолоты** — при включении `UseAutoLotSizing` объём рассчитывается по ступенчатой шкале в зависимости от стоимости портфеля (`Portfolio.CurrentValue`, либо `Portfolio.BeginValue`).

| Баланс (больше) | Объём |
| --------------- | ----- |
| 0 (по умолчанию) | `LotSize`
| 200             | 0.04
| 300             | 0.05
| 400             | 0.06
| 500             | 0.07
| 600             | 0.08
| 700             | 0.09
| 800             | 0.10
| 900             | 0.20
| 1 000           | 0.30
| 2 000           | 0.40
| 3 000           | 0.50
| 4 000           | 0.60
| 5 000           | 0.70
| 6 000           | 0.80
| 7 000           | 0.90
| 8 000           | 1.00
| 9 000           | 2.00
| 10 000          | 3.00
| 11 000          | 4.00
| 12 000          | 5.00
| 13 000          | 6.00
| 14 000          | 7.00
| 15 000          | 8.00
| 20 000          | 9.00
| 30 000          | 10.00
| 40 000          | 11.00
| 50 000          | 12.00
| 60 000          | 13.00
| 70 000          | 14.00
| 80 000          | 15.00
| 90 000          | 16.00
| 100 000         | 17.00
| 110 000         | 18.00
| 120 000         | 19.00
| 130 000         | 20.00

## Параметры
- `StopLossTicks` — расстояние стоп-лосса в шагах цены.
- `TrailingStopTicks` — расстояние трейлинг-стопа в шагах цены (0 отключает трейлинг).
- `SequenceLength` — требуемое количество последовательных изменений Ask.
- `SequenceTimeoutSeconds` — максимально допустимое время формирования серии (в секундах).
- `LotSize` — объём сделки при выключенной автолотовости.
- `UseAutoLotSizing` — включает таблицу расчёта объёма по балансу.

## Рекомендации
- Подходит для инструментов с высокой частотой обновления стакана; рекомендуется тестирование на тиковых данных.
- Стратегия предполагает хеджинговый тип счёта (нет одновременных разнонаправленных позиций).
- Убедитесь, что у инструмента задан `Security.PriceStep`; иначе расчёт стопов будет использовать шаг «1».
- Для повторения оригинальной логики не изменяйте порядок подписки и не добавляйте собственных индикаторов.
