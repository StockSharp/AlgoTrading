# Стратегия MultiCurrency Template MT5

## Общее описание

**MultiCurrency Template MT5** — это порт стратегии MetaTrader с одноимённым советником. Она ищет комбинацию из двух дневных свечей и позволяет вести корзину позиций сразу по нескольким инструментам. Первичная сделка открывается только тогда, когда предыдущая дневная свеча формирует нужный бычий или медвежий сценарий, после чего управление переносится на более быстрый контрольный таймфрейм. При неблагоприятном движении цены модуль мартингейла дозагружает позиции через заданный шаг в MetaTrader-пунктах, а выход реализует комбинацию фиксированного тейк-профита, усреднённого выхода по безубытку и опционального трейлинг-стопа.

При переносе в StockSharp сохранена мультивалютная логика: пользователь может передать список инструментов через параметр `PairsToTrade`, и для каждого инструмента создаётся независимый контекст с собственной корзиной и расчётами. Если `TradeMultipair` отключён, стратегия торгует только базовым инструментом из свойства `Security`.

## Формирование сигналов

* Подписка на свечи типа `SignalCandleType` (по умолчанию дневные) и хранение двух последних завершённых свечей.
* **Покупка** появляется, если текущий закрытие ниже предыдущего открытия, а предыдущая свеча закрылась выше открытия.
* **Продажа** возникает, если текущее закрытие выше предыдущего открытия, а предыдущая свеча закрылась ниже открытия.
* Одновременно активен только один направленный сценарий; новые сигналы игнорируются до полной ликвидации текущей корзины.

## Открытие и сопровождение позиций

* Входы выполняются рыночными заявками с объёмом `Lots`.
* При включённом `NewBarTrade` стратегия ждёт формирования новой свечи таймфрейма `TradeCandleType`, после чего допускает сделку. Флаг сбрасывается после первой попытки торговать, полностью повторяя поведение MetaTrader «торговать только на новой свече».
* Начальные уровни стоп-лосса и тейк-профита задаются в MetaTrader-пунктах с учётом вычисленного размера пункта.
* Если `EnableMartingale` = true, то при отклонении цены от лучшего входа корзины на `StepPoints` MetaTrader-пунктов добавляется новая усредняющая позиция. Её объём умножается на `NextLotMultiplier` в степени количества уже открытых сделок данного направления.

## Управление сделками

* Режим `EnableTakeProfitAverage` задаёт работу тейк-профита:
  * При выключенном режиме цель остаётся на фиксированной дистанции `TakeProfitPips` от лучшей цены.
  * При включённом режиме и наличии минимум двух ордеров тейк переносится на цену безубыточности плюс `TakeProfitOffsetPoints`.
* Стоп-уровни пересчитываются после каждого исполнения ордера, учитывая самый неблагоприятный вход корзины.
* Трейлинг-стоп активен, если в корзине осталась только одна сделка: сначала перенос в безубыток + `TrailingStopPoints` после прохождения `TrailingStopPoints + TrailingStepPoints`, затем сопровождение с тем же отступом.
* Срабатывание стопа или тейка приводит к закрытию всей корзины одной рыночной заявкой.

## Параметры

| Параметр | Описание |
| --- | --- |
| `Lots` | Базовый объём первой сделки в корзине. |
| `StopLossPips` | Стартовый стоп-лосс в MetaTrader-пунктах. |
| `TakeProfitPips` | Стартовый тейк-профит в MetaTrader-пунктах. |
| `TrailingStopPoints` | Отступ трейлинг-стопа (пункты MetaTrader) при единственной сделке. |
| `TrailingStepPoints` | Дополнительный шаг, после которого трейлинг переносится повторно. |
| `SlippagePoints` | Сохраняется для совместимости, на исполнение в StockSharp не влияет. |
| `NewBarTrade` | Разрешать сделки только после появления новой свечи `TradeCandleType`. |
| `TradeCandleType` | Таймфрейм, отвечающий за новую свечу и сервисные расчёты. |
| `TradeMultipair` | Включает режим одновременной торговли несколькими инструментами. |
| `PairsToTrade` | Список тикеров через запятую, которые будут получены через `GetSecurity`. |
| `Commentary` | Текст комментария к ордерам, перенесённый из оригинала. |
| `EnableMartingale` | Активирует блок усредняющих входов. |
| `NextLotMultiplier` | Множитель объёма для каждого последующего усреднения. |
| `StepPoints` | Шаг в пунктах MetaTrader между усредняющими сделками. |
| `EnableTakeProfitAverage` | Включает переназначение тейка на уровень безубыточности. |
| `TakeProfitOffsetPoints` | Смещение от цены безубыточности при активном усреднённом тейке. |
| `SignalCandleType` | Таймфрейм для анализа двух свечей (по умолчанию день). |

## Примечания

* Все сделки исполняются рыночными ордерами; защитные приказы брокера моделируются внутри стратегии.
* `PairsToTrade` должен содержать идентификаторы, доступные подключённому коннектору. Неизвестные инструменты пропускаются.
* Модули мартингейла и трейлинг-стопа работают независимо для каждого инструмента.
* Параметр `SlippagePoints` оставлен для совместимости и не участвует в расчётах в среде StockSharp.

