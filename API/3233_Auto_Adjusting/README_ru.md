# AutoAdjustingStrategy

AutoAdjustingStrategy переносит советник MetaTrader *Aouto Adjusting1* на высокоуровневый API StockSharp. Порт сохранил исходные фильтры: много таймфреймовый импульс, месячный MACD и тройку EMA, которые определяют откаты по тренду. Стопы и цели рассчитываются от актуальных экстремумов и автоматически обновляются после закрытия каждой свечи.

## Логика работы

1. **Структура тренда** — экспоненциальные средние на рабочем таймфрейме (6, 14, 26) должны быть выстроены по порядку (`EMA6 < EMA14 < EMA26` для покупок и наоборот для продаж). Предыдущая свеча должна коснуться средней EMA, а ещё одна свеча назад сформировать более высокий минимум / более низкий максимум.
2. **Импульсное подтверждение** — индикатор Momentum на старшем таймфрейме (выводится из рабочего, например H1 → D1) должен отклоняться от уровня 100 не менее чем на `MomentumBuyThreshold` / `MomentumSellThreshold` хотя бы на одной из последних трёх закрытых свечей.
3. **Макро фильтр** — месячный MACD(12, 26, 9) задаёт направление сделок (`MACD > Signal` для длинных, `<` для коротких).
4. **Исполнение** — рыночная заявка отправляется, когда все фильтры согласованы и нет открытых позиций в противоположную сторону. Противоположные позиции закрываются перед открытием новой.
5. **Защита** — стоп-лосс устанавливается на заданное количество пунктов ниже/выше минимальной/максимальной цены последних `CandlesBack` свечей. Тейк-профит рассчитывается умножением дистанции стопа на `RewardRatio`. Оба уровня переустанавливаются после закрытия каждой свечи, пока позиция активна.

## Риск и объём

- `RiskPercent` рассчитывает адаптивный объём при наличии данных по стоимости портфеля и шагу цены: допустимая денежная потеря делится на убыток за единицу объёма, определяемый текущей дистанцией стопа.
- Если рассчитать риск невозможно (например, отсутствуют значения портфеля), стратегия использует фиксированный объём `TradeVolume`.

## Параметры

| Название | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | `TimeFrame(H1)` | Рабочий таймфрейм, на котором строится стек EMA. |
| `MomentumCandleType` | `DataType` | Производное от `CandleType` | Старший таймфрейм для индикатора Momentum (H1→D1, H4→W1 и т.д.). |
| `MacroMacdCandleType` | `DataType` | `TimeFrame(30 days)` | Таймфрейм для макро фильтра MACD (по умолчанию месяц). |
| `PadAmount` | `decimal` | `3` | Количество пунктов за экстремумом для размещения стопа. |
| `RiskPercent` | `decimal` | `0.1` | Процент капитала под риском в одной сделке. |
| `RewardRatio` | `decimal` | `2` | Множитель, определяющий дистанцию тейк-профита относительно стопа. |
| `CandlesBack` | `int` | `3` | Число свечей, используемых для поиска максимумов/минимумов. |
| `MomentumBuyThreshold` | `decimal` | `0.3` | Минимальное отклонение Momentum для допуска покупок. |
| `MomentumSellThreshold` | `decimal` | `0.3` | Минимальное отклонение Momentum для допуска продаж. |
| `TradeVolume` | `decimal` | `1` | Резервный объём сделки, когда расчёт по риску невозможен. |

## Визуализация

- Подключите свечи рабочего таймфрейма и отобразите три EMA для оценки откатов.
- В отдельном окне наблюдайте Momentum на старшем таймфрейме и проверяйте достижение порогов.
- Следите за значениями MACD с месячного потока, чтобы подтверждать направление сделок.

## Примечания

- Соответствие таймфреймов идентично оригиналу: M1→M15, M5→M30, M15→H1, M30→H4, H1→D1, H4→W1, D1→MN1. Остальные таймфреймы не изменяются.
- Стратегия не обращается к `GetValue` индикаторов — последние значения хранятся во внутренних переменных и обновляются через `Bind`.
- Повторная установка стопов и тейков реализует логику «подстройки» советника после каждой завершённой свечи.
