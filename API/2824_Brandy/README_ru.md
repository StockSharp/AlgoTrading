# Стратегия Brandy (C#)
[English](README.md) | [中文](README_cn.md)

## Общее описание
Стратегия Brandy представляет собой перенос MetaTrader 5 эксперта *Brandy (barabashkakvn's edition)* на платформу StockSharp. Она использует две независимо настраиваемые скользящие средние и анализирует их значения на закрытых свечах, чтобы определить направление сделки. Дополнительно реализованы параметры стоп-лосса, тейк-профита и трейлинг-стопа в пунктах (pips). Перенос выполнен на высокоуровневом API StockSharp и максимально точно повторяет торговую и защитную логику оригинального советника.

Одна скользящая средняя рассчитывается по ряду открытий ("быстрая"), другая — по ряду закрытий ("медленная"). Для каждой линии доступны настройки периода, метода сглаживания, источника цены, индекса сигнального бара и сдвига. Торговый сигнал формируется, когда значения предыдущего бара находятся по одну сторону от выбранных сигнальных уровней. На каждой свече выполняется проверка тенденции по скользящей средней на открытиях: если условие нарушено, позиция закрывается. Параметры стопов выражаются в пунктах и конвертируются в абсолютные цены с учётом шага цены инструмента и особенностей пятизначных котировок.

## Логика торговли
1. На каждой закрытой свече обновляются обе скользящие средние с учётом выбранного метода сглаживания и источника цен. История значений хранится в ограниченных очередях для эмуляции поведения функции `iMA` с произвольным сдвигом и сигнальным баром.
2. При отсутствии позиции стратегия открывает длинную сделку, если:
   - значение скользящей средней по открытиям (с учётом сдвига) выше сигнального уровня;
   - значение скользящей средней по закрытиям также выше своего сигнального уровня (в оригинальном коде сравнение ведётся с буфером по открытиям — перенос сохраняет эту особенность).
3. Короткая позиция открывается при выполнении зеркальных условий, когда обе средние ниже соответствующих сигналов.
4. Пока позиция открыта, на каждой свече выполняются последовательные проверки:
   - **Разворот тренда.** Если скользящая по открытиям пересекает сигнал в противоположную сторону, сделка закрывается по рынку.
   - **Обновление трейлинг-стопа.** При включённом трейлинге и достижении прибыли, превышающей сумму `TrailingStopPips + TrailingStepPips`, стоп подтягивается на фиксированное расстояние `TrailingStopPips` от текущей цены закрытия.
   - **Тейк-профит.** Если диапазон свечи касается целевого уровня, позиция закрывается.
   - **Стоп-лосс.** Если цена пробивает защитный уровень, фиксируется убыток и позиция закрывается.
5. Объём ордеров фиксирован и задаётся параметром `TradeVolume`. Значение по умолчанию — 0.1 лота, как и в версии для MT5.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Размер ордера в лотах.
| `StopLossPips` | Расстояние стоп-лосса в пунктах (0 — выключено).
| `TakeProfitPips` | Расстояние тейк-профита в пунктах (0 — выключено).
| `TrailingStopPips` | Базовая дистанция трейлинг-стопа в пунктах. Требует положительного `TrailingStepPips`.
| `TrailingStepPips` | Минимальное дополнительное движение цены перед подтяжкой стопа. Должно быть > 0 при активном трейлинге.
| `MaClosePeriod` / `MaOpenPeriod` | Периоды скользящих средних по закрытиям и открытиям соответственно.
| `MaCloseShift` / `MaOpenShift` | Сдвиг буферов (число баров).
| `MaCloseSignalBar` / `MaOpenSignalBar` | Индексы сигнальных баров для сравнений (0 — текущая завершённая свеча, 1 — предыдущая и т.д.).
| `MaCloseMethod` / `MaOpenMethod` | Метод сглаживания: SMA, EMA, SMMA или LWMA.
| `MaCloseAppliedPrice` / `MaOpenAppliedPrice` | Источник цены для расчёта: close, open, high, low, median, typical, weighted.
| `CandleType` | Таймфрейм свечей, по которым работает стратегия.

## Особенности реализации
- Размер пункта вычисляется по `Security.PriceStep`; при трёх- и пятизнаковых котировках шаг умножается на 10, повторяя логику MT5, где пункт отличается от минимального тика.
- Для хранения истории скользящих средних применяются ограниченные очереди, что позволяет воспроизводить запросы `iMA` с произвольными индексами без обращения к запрещённым методам `GetValue()`/`GetCurrentValue()`.
- При проверке сигнала для скользящей средней по закрытиям используется буфер "open", как в исходном коде (`iMAGet(handle_iMAOpen, MaClose_SignalBar)`). Это обеспечивает полную совместимость с существующими настройками оригинального советника.
- Защитные уровни и трейлинг пересчитываются на закрытии свечи, что приблизительно имитирует серверное модифицирование ордеров в MT5 и остаётся в рамках возможностей высокоуровневого API StockSharp.

## Практические рекомендации
- Выбирайте `CandleType` в соответствии с таймфреймом, использовавшимся в MT5, чтобы расчёт индикаторов совпадал с исходными условиями.
- Если трейлинг не нужен, установите `TrailingStopPips = 0`. При включении обязательно задайте положительное `TrailingStepPips`, иначе стратегия завершит работу с исключением.
- В тестах убедитесь, что у инструмента корректно заданы `PriceStep` и `Decimals`; от этого зависит пересчёт пунктов в абсолютные цены и, следовательно, корректность риск-менеджмента.
