# Brandy 策略 (C#)
[English](README.md) | [Русский](README_ru.md)

## 概述
Brandy 策略移植自 MetaTrader 5 的 *Brandy (barabashkakvn's edition)* 智能交易系统。策略利用两条可配置的移动平均线，通过比较上一根收盘蜡烛的均线位置来判断趋势方向，同时提供以点（pip）为单位的止损、止盈以及移动止损控制。本移植版本基于 StockSharp 的高级策略 API 实现，重现了原始 EA 的交易、风控和参数结构。

策略在开盘价序列上计算一条“快线”均线，在收盘价序列上计算一条“慢线”均线，两条均线的周期、平滑方式、价格源、信号引用柱以及位移参数均可独立设置。若上一根已完成蜡烛的快线与慢线同时位于各自信号值的同一侧，则产生做多或做空信号。策略还会在每根蜡烛收盘时利用开盘价均线进行趋势校验，一旦条件被破坏便立即平仓，从而保持原始 EA 的保护逻辑。所有止损、止盈及移动止损距离均使用 pip 表示，并依据品种的最小报价步长及五位报价的特殊调整转换为绝对价格。

## 交易流程
1. 每当生成新的完整蜡烛时，策略使用设定的平滑方法与价格源更新开盘均线与收盘均线，同时保存指定数量的历史值，以模拟 MT5 `iMA` 函数的信号柱和位移行为。
2. 当当前没有持仓时：
   - 若上一柱开盘均线值大于配置的信号值（包含位移），且
   - 上一柱收盘均线值也大于其信号参考值（注意：原 EA 在此处与开盘均线比较，本移植保持该特性以保证兼容），
   则按固定手数开多。
3. 若上述两条均线同时低于各自信号值，则开空。
4. 持仓期间，每根蜡烛收盘后按以下顺序检查离场条件：
   - 趋势反转：若开盘均线跌破信号值（多头）或升破信号值（空头），立即以市价平仓；
   - 移动止损：当浮动利润超过“移动止损距离 + 触发步长”时，将保护价位上调/下调至距离当前收盘价 `TrailingStopPips` 的位置；
   - 止盈：若本根蜡烛的高/低价触及目标价，则以市价平仓；
   - 止损：若蜡烛范围突破保护价位，同样平仓。
5. 交易数量固定，由 `TradeVolume` 参数决定，默认值与 MT5 版本的 0.1 手保持一致。

## 参数说明
| 参数 | 含义 |
|------|------|
| `TradeVolume` | 下单手数（lots）。
| `StopLossPips` | 止损距离（pip，0 表示关闭）。
| `TakeProfitPips` | 止盈距离（pip，0 表示关闭）。
| `TrailingStopPips` | 移动止损基础距离（pip）。需与 `TrailingStepPips` 配合使用。
| `TrailingStepPips` | 更新移动止损前必须额外前进的 pip 数，开启移动止损时必须为正数。
| `MaClosePeriod` / `MaOpenPeriod` | 收盘/开盘均线的周期长度。
| `MaCloseShift` / `MaOpenShift` | 对应均线的位移量（以柱为单位）。
| `MaCloseSignalBar` / `MaOpenSignalBar` | 用于比较的历史柱索引。0 表示最新值，1 表示上一柱，以此类推。
| `MaCloseMethod` / `MaOpenMethod` | 均线平滑方式：SMA、EMA、SMMA、LWMA。
| `MaCloseAppliedPrice` / `MaOpenAppliedPrice` | 均线计算所使用的蜡烛价格源：收盘、开盘、最高、最低、中位、典型、加权。
| `CandleType` | 订阅的蜡烛周期。

## 实现细节
- Pip 大小基于 `Security.PriceStep` 计算。当品种小数位数为 3 或 5 时，将步长乘以 10，以复刻 MT5 点与 pip 的换算。
- 为复现 `iMA` 的信号柱与位移功能，代码使用受限队列缓存均线历史值，避免调用被禁止的 `GetValue()` 等指示器接口。
- 收盘均线的比较对象依旧使用开盘均线缓存，这是源代码中 `iMAGet(handle_iMAOpen, MaClose_SignalBar)` 的原始行为，移植版本保持该特性以兼容已有参数配置。
- 止损、止盈及移动止损在蜡烛收盘时执行，逻辑尽可能贴近 EA 在服务器端修改订单的过程，同时遵守 StockSharp 高级 API 的限制。

## 使用建议
- 请根据原始策略的周期设定 `CandleType`，确保均线计算与回测时间框一致。
- 若不需要移动止损，可将 `TrailingStopPips` 设为 0；如需启用，必须提供正数的 `TrailingStepPips`，否则策略会在启动时抛出异常。
- 在 StockSharp 中测试时，请确认品种的 `PriceStep` 与 `Decimals` 与目标市场匹配，以确保 pip 转换后的价格距离准确。
