# Стратегия Yen Trader 05.1 (C#)

## Общее описание

Стратегия Yen Trader 05.1 переносит одноимённого советника MetaTrader на платформу StockSharp. Логика строится на треугольной связке трёх валютных пар:

- **Торгуемый кросс** — инструмент, к которому привязан экземпляр стратегии (например, GBPJPY).
- **Основная пара** — базовая валюта кросса против доллара США (например, GBPUSD), определяет направление «левого» плеча.
- **USDJPY** — подтверждает «йеновую» составляющую треугольника.

Пробой на основной паре при одновременном подтверждении на USDJPY инициирует сделку на кроссе. Дополнительные фильтры (RSI, CCI, RVI, скользящая средняя) позволяют сузить число входов, а блок управления позицией реализует и пирамидинг, и усреднение. Риск-менеджмент воспроизводит как точечные, так и ATR-зависимые уровни, заложенные в оригинальном EA.

## Логика работы

1. **Определение пробоя**
   - Параметр `LoopBackBars` задаёт глубину анализа. Если значение больше 1, стратегия сравнивает:
     - экстремумы (`PriceReference = HighLow`), либо
     - закрытия бара с отступом `LoopBackBars` (`PriceReference = Close`).
   - `MajorDirection` задаёт взаимное направление движения основной пары и USDJPY. В режиме Left предполагается котировка «основная/йена», в режиме Right — «йена/основная».
2. **Фильтры**
   - `UseRsiFilter` требует, чтобы RSI располагался выше либо ниже 50 в зависимости от ожидаемого тренда.
   - `UseCciFilter` контролирует знак индикатора CCI.
   - `UseRviFilter` ждёт пересечения RVI и его сигнальной линии. Сигнал реализован как простое среднее по четырём последним значениям RVI, что соответствует `MODE_SIGNAL` в MT4.
   - `UseMovingAverageFilter` сравнивает цену закрытия с заданной скользящей средней (`MaMode`, `MaPeriod`).
3. **Тип входов**
   - `EntryMode = Both` допускает любое наращивание позиции.
   - `EntryMode = Pyramiding` разрешает добавление только после «бычьих»/«медвежьих» свечей в сторону позиции.
   - `EntryMode = Averaging` разрешает усреднение только после свечей против текущего направления.
4. **Размер позиции**
   - `FixedLotSize` задаёт фиксированный объём сделок.
   - При нулевая величине используется `BalancePercentLotSize`: объём рассчитывается как доля от текущей стоимости портфеля.
   - `MaxOpenPositions` ограничивает суммарное число добавлений (эквивалент открытых ордеров в EA).
5. **Риск-менеджмент**
   - «Пипсовые» параметры (`StopLossPips`, `TakeProfitPips`, `BreakEvenPips`, `ProfitLockPips`, `TrailingStopPips`, `TrailingStepPips`) переводятся в абсолютное значение через `Security.MinPriceStep`.
   - При активном `EnableAtrLevels` используются расстояния, кратные ATR, рассчитанному по свечам `AtrCandleType` и периоду `AtrPeriod`.
   - Перенос стопа в безубыток, фиксация прибыли и трейлинг обновляются по закрытию свечи, что соответствует тиковой логике оригинального эксперта.
   - `CloseOnOpposite` заставляет стратегию закрывать текущую позицию и при необходимости разворачиваться при противоположном сигнале.
   - `AllowHedging` разрешает добавлять объём, даже если текущая чистая позиция направлена в другую сторону. В StockSharp позиции учётно-неттинговые, поэтому реальное одновременное удержание лонга и шорта недоступно; флаг определяет возможность автоматического переворота.

## Параметры

| Группа | Параметр | Назначение |
|--------|----------|------------|
| Инструменты | `MajorSecurity` | Основная пара для подтверждения. |
| | `UsdJpySecurity` | USDJPY для оценки йенового плеча. |
| Данные | `CandleType` | Таймфрейм, по которому строятся сигнальные свечи. |
| Фильтры | `MajorDirection` | Геометрия треугольника (Left = основная/йена, Right = йена/основная). |
| | `PriceReference` | Тип сравнения: экстремумы или отложенные закрытия. |
| | `LoopBackBars` | Глубина истории для анализа пробоя. |
| | `EntryMode` | Режим добавления (Both, Pyramiding, Averaging). |
| Индикаторы | `UseRsiFilter`, `UseCciFilter`, `UseRviFilter`, `UseMovingAverageFilter` | Включение фильтров. |
| | `MaPeriod`, `MaMode` | Параметры скользящей средней. |
| Риск | `FixedLotSize`, `BalancePercentLotSize` | Управление объёмом. |
| | `MaxOpenPositions` | Максимальное число добавлений. |
| | `StopLossPips` и др. | Настройки пипсовых стопов/тейков/трейлинга. |
| | `EnableAtrLevels` + ATR параметры | Использование уровней на базе ATR. |
| Поведение | `CloseOnOpposite` | Закрытие позиции при противоположном сигнале. |
| | `AllowHedging` | Разрешение на переворот при наличии противоположной позиции. |

## Рекомендации по использованию

- Установите в свойство `Security` торгуемый кросс, затем укажите `MajorSecurity` и `UsdJpySecurity` для вторичных серий данных.
- Для динамического объёма необходим актуальный `Portfolio.CurrentValue` — убедитесь, что портфель подключён к соединению.
- Желательно, чтобы все три инструмента поставляли свечи одного таймфрейма и расписания. При необходимости выполните ресэмплинг.
- ATR рассчитывается по `AtrCandleType` (по умолчанию — дневной, период 21), что соответствует настройкам MT4.
- Управление рисками выполняется после закрытия свечи: стратегия отправляет рыночные заявки, когда цена достигла уровня во время следующей сессии.

## Отличия от версии MT4

- StockSharp использует неттинг — классический хедж в виде одновременного лонга и шорта невозможен. Параметр `AllowHedging` контролирует лишь разрешение на автоматический разворот.
- EA на MT4 модифицировал стопы ордеров по тикам; здесь стоп/тейк реализованы через рыночные выходы после проверки уровней на закрытии свечи.
- Сигнальная линия RVI рассчитывается как четырёхпериодное SMA от значений RVI, что эквивалентно `MODE_SIGNAL` в MetaTrader.

