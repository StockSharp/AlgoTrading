# 4122 Order Guardian

## Обзор
Стратегия представляет собой порт MetaTrader-советника `MQL/9210/OrderGuardian.mq4` на высокоуровневый API StockSharp. Она выступает надстройкой для уже открытых позиций: непрерывно пересчитывает уровни тейк-профита и стоп-лосса и закрывает позицию по рынку при достижении любого из них. Таким образом воспроизводится логика исходного эксперта.

Параметры и их значения по умолчанию максимально совпадают с оригиналом. Вместо поиска пользовательских трендовых линий или каналов на графике используются ручные ценовые параметры, которые можно менять во время работы стратегии. При желании включаются направляющие линии на графике и статусное сообщение, аналогичное `Comment()` в MetaTrader.

## Логика стратегии
1. **Обработка данных** – подписка на выбранный тип свечей и работа только с полностью сформированными барами, что исключает шум внутри свечи.
2. **Расчёт уровней**
   - *Режим Envelope*: значение скользящей средней смещается на указанное число баров и умножается на `(1 + отклонение %)`. Полученный уровень используется и для лонгов, и для шортов.
   - *Ручной режим*: отдельные параметры задают абсолютные цены для лонгового и шортового тейк-профита и стоп-лосса.
   - *Parabolic SAR*: индикатор рассчитывается на каждой завершённой свече, затем значение смещается назад на заданное количество баров и применяется как общий стоп-уровень.
3. **Управление позицией** – для лонга сравниваются максимум и минимум свечи с активными уровнями тейк-профита и стоп-лосса; пробой закрывает всю позицию рыночной заявкой. Для шорта выполняются зеркальные проверки.
4. **Визуальная обратная связь** – при включённой опции рисуются направляющие линии между двумя последними свечами. При изменении уровней выводится сообщение `S/L @ ...   T/P @ ...`, как и в версии для MetaTrader.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей, используемых стратегией. |
| `TakeProfitMethod` | Источник тейк-профита: `Envelope` (отклонение скользящей) или `ManualLine` (ручной уровень). |
| `StopLossMethod` | Источник стоп-лосса: `Envelope`, `ManualLine` или `ParabolicSar`. |
| `TakeProfitPeriod` | Период скользящей средней для расчёта тейк-профита. |
| `StopLossPeriod` | Период скользящей средней для расчёта стоп-лосса. |
| `TakeProfitMaMethod` | Тип скользящей средней для тейк-профита (простая, экспоненциальная, сглаженная, линейно-взвешенная). |
| `StopLossMaMethod` | Тип скользящей средней для стоп-лосса. |
| `TakeProfitPriceType` | Тип цены, подаваемой на скользящую для тейк-профита. |
| `StopLossPriceType` | Тип цены, подаваемой на скользящую для стоп-лосса. |
| `TakeProfitDeviation` | Процент, добавляемый к смещённой скользящей для тейк-профита. |
| `StopLossDeviation` | Процент, добавляемый к смещённой скользящей для стоп-лосса. |
| `TakeProfitShift` | Количество завершённых свечей, на которое сдвигается скользящая для тейк-профита. |
| `StopLossShift` | Количество завершённых свечей, на которое сдвигается скользящая или SAR для стоп-лосса; при `ParabolicSar` автоматически не менее 1. |
| `ManualTakeProfitLong` | Ручной тейк-профит для лонга (0 отключает уровень). |
| `ManualTakeProfitShort` | Ручной тейк-профит для шорта (0 отключает уровень). |
| `ManualStopLossLong` | Ручной стоп-лосс для лонга (0 отключает уровень). |
| `ManualStopLossShort` | Ручной стоп-лосс для шорта (0 отключает уровень). |
| `SarStep` | Шаг ускорения Parabolic SAR. |
| `SarMaximum` | Максимальное ускорение Parabolic SAR. |
| `ShowLines` | Флаг отображения направляющих линий на графике. |

## Рекомендации по использованию
- Стратегия **не открывает** новые позиции. Используйте её совместно с другими торговыми системами или ручными сделками для защиты уже открытых позиций.
- Ручные уровни изменяются «на лету» — достаточно поменять значение параметра, чтобы имитировать перемещение графических объектов.
- В режиме Envelope один и тот же уровень применяется для лонга и шорта. Положительные отклонения создают цели выше скользящей, отрицательные — ниже.
- Режим Parabolic SAR повторяет особенность оригинала: значение берётся минимум на один бар назад, чтобы исключить незавершённые расчёты.
- Свойство `StatusLine` предоставляет последнюю текстовую строку статуса для панелей мониторинга или логирования.

## Отличия от версии MetaTrader
- Поиск графических объектов заменён ручным вводом цен, потому что StockSharp не предоставляет API для чтения метатрейдеровских линий.
- Закрытие выполняется по совокупной позиции стратегии, без перебора тикетов.
- Направляющие линии рисуются средствами StockSharp, но обновляются после каждой завершённой свечи, как и в оригинальном советнике.
