# Стратегия BuySellStopButtons

## Обзор
- Переносит эксперт MetaTrader 4 «Buy Sell Stop Buttons» в инфраструктуру StockSharp.
- Три булевых параметра (`BuyRequest`, `SellRequest`, `CloseRequest`) играют роль исходных кнопок на графике.
- Сохраняет блоки управления капиталом: фиксированный денежный тейк-профит, процентный тейк-профит, трал по прибыли, перевод в безубыток и трейлинг по пунктам.
- Подписка на минутные свечи используется исключительно как таймер — обработка выполняется только на закрытых барах.

## Параметры
| Имя | Описание |
| --- | --- |
| `OrderLots` | Базовый объём сделки при ручном входе, соответствует параметру `Lots` (по умолчанию `0.01`). |
| `NumberOfTrades` | Количество заявок, которое отправлял оригинал. В портированной версии объём агрегируется в одну рыночную заявку. |
| `UseTakeProfitInMoney` / `TakeProfitInMoney` | Включает и настраивает денежный тейк-профит, закрывающий позицию при достижении цели. |
| `UseTakeProfitPercent` / `TakeProfitPercent` | Включает и настраивает тейк-профит в процентах от капитала. Используется `Portfolio.CurrentValue`. |
| `EnableTrailing`, `TrailingProfitMoney`, `TrailingLossMoney` | Трал по прибыли: после достижения порога фиксируется максимум, при откате на `TrailingLossMoney` позиция закрывается. |
| `UseBreakEven`, `BreakEvenTriggerPips`, `BreakEvenOffsetPips` | Переводит стоп в безубыток после заработка указанного количества пунктов с заданным смещением. |
| `StopLossPips`, `TakeProfitPips`, `TrailingStopPips` | Первичный стоп, тейк и трейлинг в пунктах для тикетного блока. |
| `CandleType` | Тип свечей, использующийся как «сердцебиение» (по умолчанию одна минута). |
| `BuyRequest`, `SellRequest`, `CloseRequest` | Ручные команды, повторяющие кнопки BUY/SELL/CLOSE и автоматически сбрасывающие флаг после исполнения. |

## Логика торговли
1. В `OnStarted` стратегия подписывается на выбранные свечи, задаёт базовый `Volume` и активирует `StartProtection()`.
2. На каждой закрытой свече выполняется последовательность:
   - Обрабатываются ручные команды: BUY/SELL отправляют рыночный ордер объёмом `OrderLots * NumberOfTrades`, перекрывая встречные позиции; CLOSE закрывает текущую позицию.
   - Последовательно проверяются денежный тейк-профит, процентный тейк-профит и трал по прибыли.
   - Пересчитываются безубыточный стоп и трейлинг по пунктам на основе средней цены входа.
   - Контролируются базовые стоп- и тейк-профит уровни.
   - При включённом флаге `UseBollingerExit` длинные позиции закрываются у верхней границы полос Боллинджера, короткие — у нижней (период 20, ширина 2).
3. Нереализованная прибыль считается через `Security.PriceStep` и `Security.StepPrice`; при их отсутствии используется разница цен.

## Отличия от версии MQL
- MetaTrader позволял хеджирование, StockSharp ведёт нетто-позицию, поэтому покупка/продажа сначала закрывает встречный объём.
- Функции закрытия по месячному MACD (`Close_BUY`, `Close_SELL`) не перенесены: в исходнике они ни разу не вызывались.
- Автоподстройка объёма через `MaximumRisk` и `DecreaseFactor` заменена явным параметром `OrderLots`, так как доступ к истории счёта отсутствует.
- Управляющие правила запускаются на закрытых свечах вместо потока тиков, что соответствует правилам репозитория.
- Значения индикаторов получаются через `Bind`, без собственных коллекций и ручных выборок истории.

## Рекомендации
- Во время оптимизации держите флаги `BuyRequest`, `SellRequest`, `CloseRequest` выключенными (группа «Manual controls»).
- Для корректного денежного трейлинга и тейк-профита требуется `Security.StepPrice`. При его отсутствии расчёт ведётся в ценовых единицах.
- Размер пункта вычисляется по `MinPriceStep`/`PriceStep` и количеству знаков после запятой.
- Python-версия намеренно не создавалась.

## Тестирование
- Автоматические тесты не изменялись. Проверка логики проводится вручную через параметры стратегии.
