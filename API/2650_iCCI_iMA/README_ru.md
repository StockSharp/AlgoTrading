# Стратегия iCCI iMA
[English](README.md) | [中文](README_cn.md)

Эта стратегия является переносом советника MetaTrader «iCCI iMA». Алгоритм торгует пересечения индикатора Commodity Channel Index (CCI) с экспоненциальной скользящей средней (EMA), рассчитанной непосредственно по значениям CCI. Дополнительный CCI контролирует возвраты от зон перекупленности/перепроданности около уровней ±100. Объём заявок задаётся в лотах, при необходимости масштабируется от баланса счёта, а каждая сделка защищена стоп-лоссом и тейк-профитом, задаваемыми в пунктах.

## Логика работы
* **Источник данных.** Все индикаторы получают значения из настраиваемой серии свечей (по умолчанию — минутные), используя типичную цену `(high + low + close) / 3`.
* **Индикаторы.** Основной CCI с периодом `CciPeriod` измеряет импульс. EMA длиной `MaPeriod`, рассчитанная по потоку CCI, формирует сигнальную линию. Второй CCI с периодом `CciClosePeriod` отслеживает выходы из зон ±100.
* **Вход в позицию.** Длинная позиция открывается, когда текущий CCI находится выше своей EMA, а значение два завершённых бара назад было ниже EMA (вверх пересечение). Короткая позиция открывается при обратном пересечении вниз. Торговля начинается только после формирования всех индикаторов и накопления двух завершённых свечей, что полностью повторяет сдвиги в исходном MQL-коде.
* **Выход из позиции.** Лонг закрывается, если вспомогательный CCI опускается ниже +100 либо основной CCI пересекает EMA сверху вниз при условии, что два бара назад он был выше. Шорт закрывается при подъёме CCIclose выше −100 либо при пересечении CCI и EMA снизу вверх. Дополнительно каждую закрытую свечу проверяются уровни защиты: для лонга позиция закрывается при достижении `entry − stopLossPips * pipSize` и фиксируется прибыль при `entry + takeProfitPips * pipSize`; для шорта используются симметричные уровни. Размер пункта вычисляется по шагу цены инструмента и для инструментов с 3 или 5 знаками умножается на 10, как и в оригинальном советнике.
* **Управление объёмом.** Базовый лот (`LotSize`) проверяется на соответствие `VolumeStep`, `MinVolume` и `MaxVolume` инструмента. При включённой функции money-management объём умножается на целый коэффициент, равный частному от деления баланса на `DepositPerLot`, ограниченному значением 20. Коэффициент пересчитывается на каждом баре и полностью повторяет логику MQL.

## Параметры
- **Candle Type** — тип свечей, используемых в расчётах.
- **CCI Period** — период основного CCI, формирующего сигналы пересечения.
- **CCI Close Period** — период вспомогательного CCI для контроля уровней ±100.
- **CCI EMA Period** — период EMA, сглаживающей поток значений CCI.
- **Lot Size** — базовый торговый объём в лотах.
- **Enable Money Management** — включает масштабирование объёма по балансу.
- **Deposit Per Lot** — прибавка к балансу, необходимая для увеличения коэффициента объёма на единицу (работает только при включённом money-management).
- **Stop Loss (pips)** — расстояние стоп-лосса в пунктах, ноль отключает защиту.
- **Take Profit (pips)** — расстояние тейк-профита в пунктах, ноль отключает цель.

Стратегия начинает торговать только после появления двух завершённых свечей, чтобы условия сравнения сдвига на два бара соответствовали оригиналу. Проверка стоп-лосса и тейк-профита выполняется по максимумам/минимумам закрывшейся свечи, что приближает серверные защитные ордера MetaTrader в рамках высокоуровневого API StockSharp.
