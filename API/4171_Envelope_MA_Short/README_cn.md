# Envelope MA 空头策略

## 概述
**Envelope MA 空头策略** 是将 MetaTrader 专家顾问 `EnvelopeMA.mq4`（编号 9533）移植到 StockSharp 的 C# 实现。策略在 15 分钟蜡烛图上运行，只做空头方向。它使用高价的指数移动平均（EMA）生成包络线，同时计算两条基于低价的 EMA，并通过三组不同参数的抛物线 SAR 进行过滤。当价格回调至包络下半部分时，策略会在包络下轨附近挂出卖出止损单；订单成交后，使用固定的止损/止盈距离和指标条件管理仓位。

## 指标与信号
- **包络基线：** 取蜡烛最高价的 EMA（`EnvelopePeriod`，默认 280），通过 `EnvelopeDeviation`（默认 0.08%）生成上下轨，下轨作为挂单价格。
- **快 EMA：** 针对蜡烛最低价计算的 EMA（`FastMaPeriod`，默认 6），用于判断动能是否允许继续向下突破。
- **慢 EMA（滞后一根）：** 针对蜡烛最低价计算的 EMA（`SlowMaPeriod`，默认 18），并使用前一根柱子的数值来模拟 MetaTrader 中的移位参数，用于进场和出场判断。
- **三条抛物线 SAR：** 分别使用 0.03/0.5、0.015/0.6 和 0.02/0.2 的加速度参数。三条 SAR 同时位于价格上方时，才能触发基于指标的离场。

策略仅在蜡烛收盘时做出决策。当快 EMA、滞后慢 EMA 以及收盘价同时位于包络上下轨之间时，会在包络下轨位置提交卖出止损挂单。如果挂单在大约五根蜡烛的有效期内未成交，则自动撤销。

## 仓位管理
- **保护价格：** 成交后根据预设的 `StopLossPips` 与 `TakeProfitPips` 计算止损和止盈价格，并在每根已完成的蜡烛上使用最高价/最低价近似追踪，模拟原始 EA 的行为。
- **指标离场：** 当快慢 EMA 与收盘价全部低于入场价，三条 SAR 仍在价格上方，同时快 EMA 再次上穿滞后的慢 EMA 时，视为趋势反转，立即平空。
- **止损上移：** 入场至少四根蜡烛后，如果这段时间的最高价比入场价低了至少三个最小价位，且收盘价跌破包络下轨，则将止损价调整到当前包络下轨。

## 风控
- **净值保护：** `LiquidityThreshold`（默认 0.58）表示账户净值与初始余额的下限比例。当净值比例跌破该值时，策略会平掉所有空头仓位并取消挂单。
- **挂单有效期：** 每笔卖出止损单的有效期大约为五根监控蜡烛，超时未成交自动撤单，避免过期信号触发。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 使用的蜡烛类型/周期。 | 15 分钟蜡烛 |
| `EnvelopePeriod` | 包络线使用的 EMA 周期。 | 280 |
| `EnvelopeDeviation` | 包络线宽度（百分比）。 | 0.08 |
| `FastMaPeriod` | 低价快 EMA 周期。 | 6 |
| `SlowMaPeriod` | 低价慢 EMA 周期（向后移一根）。 | 18 |
| `StopLossPips` | 入场价到止损的距离（点数）。 | 25 |
| `TakeProfitPips` | 入场价到止盈的距离（点数）。 | 25 |
| `TradeVolume` | 挂单及市价单的交易量。 | 1 |
| `LiquidityThreshold` | 净值/余额比的最低值，低于该值会清空空头。 | 0.58 |

## 迁移说明
- 原 EA 中基于余额、保证金或 Counter-Pips 的手数算法，改为直接使用 `TradeVolume` 参数，符合 StockSharp 的下单模式。
- MetaTrader 的挂单到期时间在 StockSharp 中通过策略内部记录与检测实现，因为标准订单结构没有相同的字段。
- 止损与止盈触发通过蜡烛的高低价近似模拟盘中触发点，以保持与 MQL 实现对收盘价处理方式一致。
