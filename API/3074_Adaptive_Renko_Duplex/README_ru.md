# Стратегия Adaptive Renko Duplex

## Обзор
**Adaptive Renko Duplex Strategy** — это перенос эксперта `Exp_AdaptiveRenko_Duplex.mq5` на платформу StockSharp. Новая версия сохраняет ключевую идею исходника: **две независимые ветки Adaptive Renko**, одна обслуживает покупки, другая — продажи, и при этом использует высокоуровневый API. Каждая ветка динамически формирует поддерживающие и ограничивающие уровни, масштабируя высоту кирпичей по текущей волатильности. Стратегия отслеживает развороты относительно этих уровней и позволяет задавать асимметричные параметры для длинной и короткой стороны.

В отличие от классических Renko-систем, работающих с синтетическими кирпичами, подход Duplex использует обычные свечи. На закрытии каждой свечи пересчитываются буферы Adaptive Renko, а сигналы возникают только после полной фиксации бара — это исключает перерисовку и соответствует событийной модели StockSharp.

## Рыночные данные и индикаторы
- **Подписки на свечи** — два параметра `DataType` задают серии свечей для длинной и короткой веток. Можно выбрать одинаковые или разные таймфреймы.
- **Пересборка Adaptive Renko** — каждая ветка содержит реализацию исходного индикатора. Минимальная высота кирпича (в пунктах) сравнивается с `K × волатильность`, и большее значение используется для построения. Индикатор хранит верхнюю/нижнюю границы и цветные уровни тренда (поддержка при росте, сопротивление при падении).
- **Источники волатильности** — доступны индикаторы `AverageTrueRange` и `StandardDeviation`, работающие на соответствующей серии свечей и имеющие настраиваемую длину.

## Логика торговли
1. **Длинная сторона**
   - Ветка строит адаптивные кирпичи по заданным параметрам.
   - Когда на свече с задержкой `LongSignalBarOffset` появляется уровень `RenkoTrend.Up`, стратегия выставляет рыночную покупку. Объём рассчитывается как `Volume + |Position|`, что позволяет мгновенно развернуться из шорта в лонг.
   - Если позже фиксируется `RenkoTrend.Down` и флаг `LongExitsEnabled` активен, все длинные позиции закрываются.
2. **Короткая сторона**
   - Логика зеркальная: сигнал `RenkoTrend.Down` открывает шорт, а `RenkoTrend.Up` закрывает его при включенном `ShortExitsEnabled`.
3. **Задержка сигналов** — параметры `SignalBarOffset` повторяют логику MetaTrader, где сигнал используется после закрытия следующей свечи. Значение 0 позволяет реагировать на последнюю завершённую свечу.
4. **Размер позиции** — StockSharp-версия полностью опирается на свойство `Volume`. Убедитесь, что объём установлен перед запуском.

## Управление риском
- **Стоп-лосс и тейк-профит** — расстояния задаются в **пунктах** и умножаются на `Security.PriceStep` (при отсутствии используется `MinStep`), чтобы получить абсолютную цену. Проверка выполняется на закрытии каждой подписанной свечи, выход осуществляется рыночными заявками.
- **Отслеживание входа** — стратегия хранит цену последнего входа в лонг или шорт (по закрытию свечи) для расчёта расстояния до стопов и целей.
- **Дополнительные модули** — при необходимости можно дополнительно вызвать `StartProtection()` и подключить внешние блоки защиты капитала.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `LongCandleType` | 4 часа | Серия свечей для длинной ветки. |
| `ShortCandleType` | 4 часа | Серия свечей для короткой ветки. |
| `LongVolatilityMode` | ATR | Источник волатильности (ATR или StandardDeviation) для длинных кирпичей. |
| `ShortVolatilityMode` | ATR | Источник волатильности для коротких кирпичей. |
| `LongVolatilityPeriod` | 10 | Длина окна индикатора волатильности для лонгов. |
| `ShortVolatilityPeriod` | 10 | Длина окна индикатора волатильности для шортов. |
| `LongSensitivity` | 1.0 | Множитель, применяемый к волатильности перед построением длинных кирпичей. |
| `ShortSensitivity` | 1.0 | Аналогичный множитель для коротких кирпичей. |
| `LongPriceMode` | Close | Тип цены (`HighLow` или `Close`), используемый длинной веткой. |
| `ShortPriceMode` | Close | Тип цены для короткой ветки. |
| `LongMinimumBrickPoints` | 2 | Минимальная высота кирпича (в пунктах) для длинной ветки. |
| `ShortMinimumBrickPoints` | 2 | Минимальная высота кирпича для короткой ветки. |
| `LongSignalBarOffset` | 1 | Количество закрытых свечей, через которое подтверждается длинный сигнал. |
| `ShortSignalBarOffset` | 1 | Задержка подтверждения короткого сигнала. |
| `LongEntriesEnabled` | true | Разрешение на вход в лонг. |
| `LongExitsEnabled` | true | Разрешение на выход из лонга по сигналу Renko. |
| `ShortEntriesEnabled` | true | Разрешение на вход в шорт. |
| `ShortExitsEnabled` | true | Разрешение на выход из шорта по сигналу Renko. |
| `LongStopLossPoints` | 1000 | Расстояние стоп-лосса для длинных позиций (пункты × `PriceStep`). |
| `LongTakeProfitPoints` | 2000 | Расстояние тейк-профита для длинных позиций. |
| `ShortStopLossPoints` | 1000 | Расстояние стоп-лосса для коротких позиций. |
| `ShortTakeProfitPoints` | 2000 | Расстояние тейк-профита для коротких позиций. |

> **Пересчёт пунктов** — в MetaTrader размер пункта зависит от точности котировки. В переносе все расстояния умножаются на `Security.PriceStep` (или `MinStep`). Настройте значения под шаг цены вашего инструмента.

## Рекомендации по использованию
1. **Предварительная настройка** — до запуска укажите `Security`, `Portfolio` и `Volume`, а также убедитесь в наличии данных по всем выбранным таймфреймам.
2. **Раздельная калибровка** — можно оставить симметричные настройки или назначить разные таймфреймы, индикаторы и размеры кирпичей для каждой ветки.
3. **Контроль журналов** — при каждом входе и выходе стратегия пишет `LogInfo` с уровнем Renko, вызвавшим действие. Это помогает сверить сигналы.
4. **Комбинация с внешними фильтрами** — высокоуровневый API позволяет накладывать дополнительные условия (сессионные фильтры, ограничения по волатильности, управление портфелем).
5. **Советы по тестированию** — в истории используйте билдер свечей, умеющий восстанавливать необходимые таймфреймы, чтобы сохранить корректную работу Adaptive Renko.

## Отличия от оригинального эксперта
- Исключены специфичные для MetaTrader функции: magic number, режимы ММ, обработка отклонений, уведомления. Размер позиции задаёт свойство `Volume`.
- В оригинале стопы и цели отправлялись на сервер как отложенные заявки. Здесь расстояния проверяются на закрытии свечи, выход выполняется рыночной заявкой.
- Сигналы обрабатываются только на завершённых свечах, что эквивалентно проверке `IsNewBar` в MQL и предотвращает перерисовку.
- Алгоритм Adaptive Renko реализован на C# без вспомогательных коллекций индикаторов, что соответствует рекомендациям по использованию высокоуровневого API.

## Рекомендуемые доработки
- Добавьте фильтры торговых сессий или ограничители волатильности, чтобы избегать периодов низкой ликвидности.
- Подключите модули защитных стопов или контроль просадки через `StartProtection()` для управления риском на уровне счёта.
- Визуализируйте построенные уровни поддержки/сопротивления на графике или в логе для ручного анализа стратегии.
