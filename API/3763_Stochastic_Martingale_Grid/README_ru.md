# Стратегия Stochastic Martingale Grid

## Общее описание
Стратегия является портом советника MetaTrader `rmkp_9yj4qp1gn8fucubyqnvb` на платформу StockSharp. Алгоритм сочетает фильтр входа на основе стохастического осциллятора с мартингейловой сеткой усреднений. Анализируются только завершённые свечи: когда линия сигнала стохастика выходит из зоны перепроданности или перекупленности, открывается позиция на разворот. При движении цены против позиции стратегия добавляет усредняющие ордера с удвоенным объёмом через фиксированное число пунктов. Каждый ордер имеет собственный тейк‑профит и управляется индивидуальным трейлинг‑стопом, что позволяет частично фиксировать прибыль по мере восстановления цены.

## Логика работы
- **Определение сигнала:**
  - Рассчитываются линии %K и %D стохастика с настраиваемыми периодами.
  - Сигнал на покупку возникает, если на предыдущей свече %K был выше %D, а сама линия %D находилась ниже порога `ZoneBuy`.
  - Сигнал на продажу возникает, если %K был ниже %D, а %D располагалась выше порога `ZoneSell`.
- **Первичный вход:**
  - При появлении сигнала и отсутствии открытых позиций отправляется рыночный ордер объёмом `BaseVolume`.
  - Цена входа запоминается для дальнейшего управления усреднениями и трейлинг‑стопом.
- **Мартингейловое усреднение:**
  - Пока позиция открыта, стратегия отслеживает неблагоприятное движение величиной `StepPips` относительно последнего ордера.
  - Новый ордер размещается только если текущее количество усреднений меньше `MaxOrders` и торговля разрешена, при этом объём удваивается относительно предыдущего.
- **Выход из позиции:**
  - Для каждого ордера устанавливается индивидуальный тейк‑профит на расстоянии `TakeProfitPips` от цены входа.
  - Трейлинг‑стоп активируется после достижения прибыли в `TrailingStopPips`; по мере роста прибыли уровень стопа подтягивается.
  - Если цена возвращается к уровню трейлинга или достигает тейк‑профита, соответствующий ордер закрывается, а остальные продолжают сопровождение.
  - Когда все ордера закрыты, состояние стратегии сбрасывается и начинается ожидание следующего сигнала стохастика.

## Управление рисками
- Количество усреднений ограничено параметром `MaxOrders`, а объёмы дополнительно нормируются по ограничениям инструмента.
- Учёт `VolumeStep`, `VolumeMin` и `VolumeMax` позволяет избегать некорректных заявок по размеру.
- Трейлинг‑стоп помогает фиксировать плавающую прибыль и снижает риск полного отката.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип свечей для расчёта индикаторов. | Таймфрейм 15 минут |
| `BaseVolume` | Начальный объём первого ордера. | `0.1` |
| `TakeProfitPips` | Расстояние до тейк‑профита в пунктах для каждого ордера. | `50` |
| `TrailingStopPips` | Расстояние трейлинг‑стопа в пунктах. | `20` |
| `MaxOrders` | Максимальное число одновременно открытых усредняющих ордеров. | `7` |
| `StepPips` | Минимальное неблагоприятное движение (в пунктах) перед добавлением нового ордера. | `7` |
| `KPeriod` | Период расчёта линии %K. | `5` |
| `DPeriod` | Период сглаживания линии %D. | `3` |
| `Slowing` | Дополнительное сглаживание %K. | `3` |
| `ZoneBuy` | Верхняя граница для допуска сигналов на покупку. | `30` |
| `ZoneSell` | Нижняя граница для допуска сигналов на продажу. | `70` |

## Дополнительные замечания
- Стратегия использует высокоуровневый API StockSharp с подпиской на свечи и привязкой индикаторов, что упрощает визуализацию и контроль рисков.
- Усредняющие ордера удваивают объём, поэтому необходимо убедиться, что ограничения инструмента позволяют реализовать всю лестницу мартингейла.
- Как и для любых мартингейловых подходов, рекомендуется дополнительно контролировать капитал и лимиты потерь перед использованием на реальном счёте.
