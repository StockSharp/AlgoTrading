# 随机指标马丁格尔网格策略

## 概述
本策略将 MetaTrader 顾问 `rmkp_9yj4qp1gn8fucubyqnvb` 移植到 StockSharp 平台。算法结合随机震荡指标的反转信号与马丁格尔式的网格加仓。当上一根已完成的 K 线显示随机指标的信号线脱离超买或超卖区域时，策略立即开仓。若价格朝不利方向运行，则按照固定点差添加加仓单，每次加仓的手数都会翻倍。每一腿都有独立的止盈和跟踪止损，因此当价格回撤时可以逐步锁定收益。

## 交易逻辑
- **信号判定：**
  - 使用可配置周期的随机指标，计算 %K 与 %D 两条线。
  - 当上一根 K 线中 %K 高于 %D 且 %D 低于 `ZoneBuy` 时视为看多信号。
  - 当上一根 K 线中 %K 低于 %D 且 %D 高于 `ZoneSell` 时视为看空信号。
- **首单开仓：**
  - 在出现有效信号且账户当前无持仓时，以 `BaseVolume` 的手数市价开仓。
  - 记录入场价格，供后续加仓与跟踪止损使用。
- **马丁格尔加仓：**
  - 只要仓位存在，策略会监控价格是否相对最新仓位逆向移动 `StepPips` 点。
  - 若条件满足并且当前开仓数量少于 `MaxOrders`，则按照前一单手数的两倍下达新的市价单。
- **出场管理：**
  - 每个仓位的止盈距离均为 `TakeProfitPips` 点。
  - 当浮盈达到 `TrailingStopPips` 点时启用跟踪止损，并在盈利扩大时不断上移（或下移）止损位置。
  - 一旦价格回撤至跟踪止损或触及止盈，该仓位将被单独平仓，其他仓位继续运行。
  - 当所有仓位都被平掉后，策略重置内部状态，重新等待新的随机指标信号。

## 风险控制
- `MaxOrders` 限制了网格中的最大仓位数量，所有下单量都会遵循交易品种的最小、最大手数及步长限制。
- 跟踪止损可在行情反向时保护已经获得的浮盈。
- 由于马丁格尔会快速增加仓位规模，实盘前务必评估保证金占用、滑点以及风控规则。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 用于指标计算的 K 线数据类型。 | 15 分钟周期 |
| `BaseVolume` | 初次开仓的手数。 | `0.1` |
| `TakeProfitPips` | 每个仓位距离入场价的止盈点数。 | `50` |
| `TrailingStopPips` | 启动并跟踪止损所需的点数。 | `20` |
| `MaxOrders` | 网格中允许的最大仓位数量。 | `7` |
| `StepPips` | 每次加仓所需的逆向波动点数。 | `7` |
| `KPeriod` | 随机指标 %K 的回溯周期。 | `5` |
| `DPeriod` | 随机指标 %D 的平滑周期。 | `3` |
| `Slowing` | 对 %K 额外应用的平滑长度。 | `3` |
| `ZoneBuy` | 允许做多信号的最高 %D 阈值。 | `30` |
| `ZoneSell` | 允许做空信号的最低 %D 阈值。 | `70` |

## 其他说明
- 策略基于 StockSharp 的高层 API，实现了蜡烛图订阅、指标绑定以及交易图形展示，逻辑与原始 MT4 版本保持一致。
- 请确保交易品种的最大可下单量能够覆盖整个马丁格尔阶梯，并根据资金规模调整参数。
- 建议在真实交易前通过回测与模拟盘验证策略表现，并配合额外的风控机制。
