# Стратегия Doji Arrows

## Концепция
Стратегия Doji Arrows представляет собой адаптацию одноимённого советника MetaTrader под высокоуровневый API StockSharp. Алгоритм ожидает формирования классической свечи «доджи» и затем торгует пробой её диапазона. Доджи свидетельствует о балансе сил; закрытие следующей свечи выше максимума доджи трактуется как захват инициативы покупателями, а закрытие ниже минимума — как сигнал к продажам.

1. Обрабатываются только завершённые свечи выбранного таймфрейма `CandleType`.
2. Предыдущая свеча проверяется на соответствие критериям доджи. Она считается доджи, если модуль разницы между ценой открытия и закрытия не превышает `DojiBodyPoints`, умноженные на шаг цены инструмента. При значении параметра `0` используется один шаг цены, что воспроизводит строгую проверку на равенство из версии MQL5.
3. При закрытии следующей свечи выше максимума доджи отправляется рыночная заявка на покупку. При закрытии ниже минимума — рыночная заявка на продажу. Если открыта противоположная позиция, объём рыночного ордера автоматически её закрывает и разворачивает при необходимости.

Такое поведение повторяет логику исходного советника, который принимал решения один раз на старте нового бара.

## Управление рисками
Перенос включает защитные механизмы оригинала:

- **Стоп-лосс**. Параметр `StopLossPoints` задаёт расстояние начального стопа в шагах цены от точки входа. Значение `0` отключает фиксированный стоп.
- **Тейк-профит**. Параметр `TakeProfitPoints` определяет расстояние до цели по прибыли в шагах цены. Значение `0` убирает тейк-профит.
- **Трейлинг-стоп**. Пара `TrailingStopPoints` и `TrailingStepPoints` воспроизводит алгоритм подтягивания стопа. После того как прибыль превысит сумму `TrailingStopPoints + TrailingStepPoints`, стоп переносится на расстояние `TrailingStopPoints` от последней цены закрытия (для длинной позиции — от максимума, для короткой — от минимума). Трейлинг активируется только при положительном `TrailingStopPoints`.

На каждой завершённой свече проверяется, были ли достигнуты стоп или цель. При пробое уровня по максимуму/минимуму свечи позиция закрывается рыночным ордером, после чего защитные параметры сбрасываются.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `StopLossPoints` | `30` | Расстояние начального стоп-лосса в шагах цены. |
| `TakeProfitPoints` | `90` | Расстояние тейк-профита в шагах цены. |
| `TrailingStopPoints` | `15` | Шаг трейлинг-стопа в шагах цены. |
| `TrailingStepPoints` | `5` | Дополнительная прибыль, необходимая перед срабатыванием трейлинга, в шагах цены. |
| `DojiBodyPoints` | `1` | Максимальный размер тела предыдущей свечи в шагах цены, допускающий признание её доджи. Значение `0` использует один шаг цены в качестве допуска. |
| `CandleType` | `1 час` | Таймфрейм свечей, применяемый для сигналов. |

## Особенности реализации
- Подписка на свечи осуществляется через `SubscribeCandles(CandleType).Bind(ProcessCandle)`, в памяти хранится только последняя завершённая свеча.
- Шаг цены берётся из `Security?.PriceStep`. Если брокер или источник данных его не предоставляет, используется запасное значение `1`, что позволяет стратегии работать и на синтетических инструментах.
- Защитные уровни пересчитываются после каждого входа; трейлинг-стоп способен выставить стоп даже при отключённом фиксированном стоп-лоссе, как и в MQL-версии.
- Все операции выполняются рыночными ордерами, что соответствует исходному советнику с немедленным исполнением.

## Рекомендации по применению
1. Перед запуском укажите `Security`, `Portfolio` и `Volume` стратегии.
2. Подберите значения параметров в шагах цены под конкретный инструмент, особенно если он торгуется с дробными пунктами.
3. При необходимости расширенного мани-менеджмента добавьте модули риск-контроля StockSharp — конвертация сохраняет фиксированный объём сделок из оригинала.
