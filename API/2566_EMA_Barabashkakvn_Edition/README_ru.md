# Стратегия EMA (редакция barabashkakvn)
[English](README.md) | [中文](README_cn.md)

Конверсия экспертного советника MetaTrader 5 "EMA (barabashkakvn's edition)". Система торгует пересечение двух экспоненциальных средних, рассчитанных по медианной цене, и использует виртуальные уровни take-profit/stop-loss в пунктах. Сделка открывается только после подтверждённого пересечения и небольшого отката к экстремуму предыдущей свечи.

## Суть подхода

1. Отслеживаются EMA с периодами 5 и 10 (по медианной цене) на выбранном таймфрейме.
2. При пересечении быстрой и медленной EMA формируется флаг сигнала вместо немедленного входа.
3. Цена должна откатить на `MoveBackPips` пунктов от экстремума предыдущей свечи, при этом разница между EMA превышает `2 * pipSize`.
4. После выполнения условий открывается позиция в сторону пересечения.
5. Управление позицией осуществляется виртуальными целями и стопами, измеряемыми в пунктах от цены входа.

Такое поведение полностью повторяет оригинал на MQL: советник ждал установки флага `check`, а затем требовал достаточного спреда EMA и отката цены относительно предыдущей свечи. Закрытие также идёт по "виртуальным" уровням, проверяя, достигли ли Bid/Ask заданных расстояний.

## Индикаторы и данные

- EMA(5) по медианной цене `(High + Low) / 2`.
- EMA(10) по медианной цене.
- Высота/минимум предыдущей завершённой свечи для расчёта отката.
- Обработка ведётся по завершённым свечам источника `CandleType`.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `OrderVolume` | `0.1` | Объём сделки в лотах/контрактах. |
| `VirtualProfitPips` | `5` | Расстояние (в пунктах) от входа до виртуального take-profit. |
| `MoveBackPips` | `3` | Откат после пересечения, измеряется от экстремума предыдущей свечи. |
| `StopLossPips` | `20` | Расстояние (в пунктах) от входа до виртуального stop-loss. |
| `PipSize` | `0.0001` | Размер пункта в ценовых единицах. Нужно менять для инструментов с другой котировкой. |
| `FastLength` | `5` | Период быстрой EMA. |
| `SlowLength` | `10` | Период медленной EMA. |
| `CandleType` | `TimeFrame(1m)` | Тип свечей, используемых в расчётах. |

Пипсовые параметры переводятся в ценовые расстояния через `pipValue = PipSize`. Если указать ноль или отрицательное значение, стратегия использует `Security.PriceStep`, если биржа предоставляет шаг цены.

## Логика торговли

### Вход

- **Формирование сигнала**: при любом пересечении EMA сохраняется флаг, но сделка ещё не открывается.
- **Шорт** возможен при выполнении условий:
  - Флаг сигнала установлен.
  - `SlowEMA - FastEMA > 2 * pipSize`.
  - Максимум текущей свечи ≥ минимум предыдущей свечи + `MoveBackPips * pipSize` (цена откатила вверх от прежнего минимума).
- **Лонг** возможен при выполнении условий:
  - Флаг сигнала установлен.
  - `FastEMA - SlowEMA > 2 * pipSize`.
  - Минимум текущей свечи ≤ максимум предыдущей свечи - `MoveBackPips * pipSize` (цена откатила вниз от прежнего максимума).

После открытия позиции флаг сбрасывается, чтобы исключить повторные входы.

### Выход

Виртуальные уровни повторяют механику MQL и сравнивают экстремумы свечи с нужными дистанциями:

- **Длинная позиция**:
  - Закрыть, если максимум свечи ≥ цена входа + `VirtualProfitPips * pipSize`.
  - Закрыть, если минимум свечи ≤ цена входа - `StopLossPips * pipSize`.
- **Короткая позиция**:
  - Закрыть, если минимум свечи ≤ цена входа - `VirtualProfitPips * pipSize`.
  - Закрыть, если максимум свечи ≥ цена входа + `StopLossPips * pipSize`.

После выхода виртуальные уровни сбрасываются, стратегия ждёт нового пересечения.

## Особенности реализации

- Используется высокоуровневое подписывание на свечи (`SubscribeCandles`) и отрисовка EMA и сделок на необязательном графике.
- Медианная цена вычисляется из High/Low, что полностью соответствует `PRICE_MEDIAN` в MetaTrader.
- Флаг `_hasCrossSignal` воспроизводит переменную `check`, гарантируя торговлю только после пересечения и отката.
- `StartProtection()` вызывается в `OnStarted`, что активирует встроенный мониторинг рисков даже при ручном закрытии сделок.
- Все комментарии в коде написаны на английском, исходные буферы индикаторов напрямую не используются.

## Советы по применению

- Обязательно адаптируйте `PipSize` для инструментов с иной точкой котировки (JPY-пары, индексы, криптовалюты и т.д.).
- Поскольку выходы ориентируются на экстремумы свечи, короткие таймфреймы (1–5 минут) лучше воспроизводят поведение оригинального тикового советника.
- Параметры легко оптимизируются: периоды EMA, величины виртуальных уровней и отката.
- Стратегия ведёт только одну позицию; внешние сделки по тому же инструменту могут нарушить расчёт виртуальных уровней.

## Риски

- Работа по закрытию свечей может не зафиксировать внутридневные касания виртуальных уровней; для точности используйте более мелкие интервалы.
- Виртуальные стопы не выставляют реальные защитные заявки, поэтому при сбоях связи или проскальзывании убыток может превысить ожидаемый.
- Как и любая стратегия на пересечениях EMA, система чувствительна к боковым участкам рынка; при необходимости добавляйте фильтры.
