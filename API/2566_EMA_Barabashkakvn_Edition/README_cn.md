# EMA（barabashkakvn 版本）策略
[English](README.md) | [Русский](README_ru.md)

本策略由 MetaTrader 5 专家顾问 "EMA (barabashkakvn's edition)" 转换而来。系统监控两条以中位价计算的指数移动平均线，在确认均线交叉且价格对上一根 K 线极值出现小幅回撤后才开仓。止盈与止损均为“虚拟”距离，以点数（pip）形式表示。

## 核心思路

1. 在指定周期上计算以 `(High + Low) / 2` 为基础的 5 与 10 周期 EMA。
2. 当快线与慢线交叉时，仅记录信号标志，并不立即下单。
3. 等待价格从上一根 K 线的高点或低点回撤 `MoveBackPips` 点，同时要求两条 EMA 的差值大于 `2 * pipSize`。
4. 满足条件后，按照交叉方向开仓。
5. 开仓后根据点数距离维护虚拟止盈和止损，一旦价格触及便立即平仓。

这种流程完全复现了原 MQL 程序：原始 EA 使用变量 `check` 来标记交叉，然后检查 EMA 差值与回撤条件，最后通过虚拟报价判断是否触及止盈/止损。

## 指标与数据

- 以中位价计算的 EMA(5)。
- 以中位价计算的 EMA(10)。
- 前一根已完成 K 线的最高价与最低价，用于判断回撤。
- 所有计算均基于配置的 `CandleType` 订阅并仅处理收盘完毕的 K 线。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `OrderVolume` | `0.1` | 每次开仓的合约/手数。 |
| `VirtualProfitPips` | `5` | 入场价到虚拟止盈的点数距离。 |
| `MoveBackPips` | `3` | 交叉后所需的回撤点数，从上一根 K 线极值开始计算。 |
| `StopLossPips` | `20` | 入场价到虚拟止损的点数距离。 |
| `PipSize` | `0.0001` | 单个点对应的价格变动，需要根据交易品种调整。 |
| `FastLength` | `5` | 快速 EMA 的周期。 |
| `SlowLength` | `10` | 慢速 EMA 的周期。 |
| `CandleType` | `TimeFrame(1m)` | 用于计算的 K 线类型。 |

所有与点数相关的参数都会乘以 `PipSize` 转换成价格差。如果该值为 0 或负数，策略会尝试使用 `Security.PriceStep`（若交易所提供）。

## 交易逻辑

### 入场规则

- **信号记录**：每次 EMA 发生交叉都会设置内部标志，但此时不下单。
- **做空条件**：
  - 信号标志已设置；
  - `SlowEMA - FastEMA > 2 * pipSize`；
  - 当前 K 线最高价 ≥ 上一根 K 线最低价 + `MoveBackPips * pipSize`（价格自前低向上回撤）。
- **做多条件**：
  - 信号标志已设置；
  - `FastEMA - SlowEMA > 2 * pipSize`；
  - 当前 K 线最低价 ≤ 上一根 K 线最高价 - `MoveBackPips * pipSize`（价格自前高向下回撤）。

开仓后会清除信号标志，避免重复进场。

### 离场规则

策略通过比较 K 线极值与虚拟距离来模拟原 EA 的 Bid/Ask 判断：

- **多单**：
  - 若最高价 ≥ 入场价 + `VirtualProfitPips * pipSize` 则止盈；
  - 若最低价 ≤ 入场价 - `StopLossPips * pipSize` 则止损。
- **空单**：
  - 若最低价 ≤ 入场价 - `VirtualProfitPips * pipSize` 则止盈；
  - 若最高价 ≥ 入场价 + `StopLossPips * pipSize` 则止损。

平仓后虚拟目标会被重置，等待下一次交叉。

## 实现细节

- 采用高层 API 的蜡烛订阅 (`SubscribeCandles`)，并可在图表上绘制 EMA 与成交点。
- 中位价直接由高低价计算，完全对齐 MetaTrader 的 `PRICE_MEDIAN` 设定。
- `_hasCrossSignal` 与原脚本中的 `check` 作用一致，确保只有交叉+回撤同时满足才会下单。
- 在 `OnStarted` 中调用 `StartProtection()`，即使退出逻辑为手动也可启用平台的风控机制。
- 代码注释全部为英文，并且未直接访问任何指标缓冲区。

## 使用建议

- 根据交易品种调整 `PipSize`（如日元货币对、指数、加密货币等报价制式差异）。
- 由于平仓判断依赖 K 线的最高/最低价，使用 1~5 分钟等较短周期更接近原 EA 的逐笔行为。
- 可通过优化器调整 EMA 周期、回撤点数和虚拟止盈止损距离以适配不同市场。
- 策略一次只持有一个方向的仓位，外部手动交易可能干扰虚拟止盈止损的跟踪。

## 风险提示

- 基于 K 线的极值判断可能遗漏盘中瞬间触价，必要时请使用更高分辨率的数据。
- 虚拟止损不会发送真实保护性委托，断线或滑点可能导致亏损超出预期。
- 均线交叉策略在震荡行情表现不佳，可根据需要叠加趋势或波动率过滤条件。
