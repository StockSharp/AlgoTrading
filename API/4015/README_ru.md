# Стратегия «Corrected Average Channel»

## Общее описание
**Corrected Average Channel** — порт MetaTrader-советника `e-CA-5`, переписанный на C# для платформы StockSharp. Стратегия пересчитывает индикатор «Corrected Average» (CA) после закрытия каждой свечи и открывает сделку, когда цена пересекает скорректированную среднюю на заданное число пунктов (сигму). В новой реализации используются высокоуровневые свечи StockSharp, рыночные заявки и встроенное управление риском (стоп-лосс, тейк-профит и трейлинг-стоп), что сохраняет торговую логику оригинального советника.

## Индикатор Corrected Average
CA сочетает сглаживание и волатильность. В MetaTrader задаются три параметра: период MA, тип MA и применяемая цена. Перенос в StockSharp реализован следующим образом:

1. Тип MA выбирается через `MaTypeOption` (SMA, EMA, SMMA, LWMA), период — `MaPeriod`.
2. Параллельно рассчитывается `StandardDeviation` с тем же периодом, чтобы измерить текущую волатильность.
3. Для каждой завершённой свечи corrected average вычисляется рекуррентно:
   - Пусть `M_t` — значение MA на текущей свече, `CA_{t-1}` — скорректированная средняя на предыдущей свече.
   - `v1 = StdDev_t^2`, `v2 = (CA_{t-1} - M_t)^2`.
   - Если `v2 <= 0` или `v2 < v1`, коэффициент коррекции `k = 0`, иначе `k = 1 - v1 / v2`.
   - Новое значение `CA_t = CA_{t-1} + k * (M_t - CA_{t-1})`.
   - На первой свече corrected average совпадает с MA.

Такой механизм подавляет шум в спокойные периоды и ускоряет реакцию индикатора, когда цена резко отходит от средней.

## Логика торговли
1. Стратегия подписывается на свечи типа `CandleType` и ждёт формирования MA и StdDev.
2. После закрытия свечи вычисляется новый corrected average и сравнивается предыдущий close с предыдущим CA.
3. Смещения `SigmaBuyPoints` и `SigmaSellPoints` переводятся в цены через `Security.PriceStep`.
4. Сигналы формируются по двум условиям:
   - **Покупка** — если предыдущая свеча закрылась ниже `CA + sigma_buy`, а текущая закрывается выше этого уровня.
   - **Продажа** — если предыдущая свеча закрылась выше `CA - sigma_sell`, а текущая закрывается ниже этого уровня.
5. В рынке допускается только одна позиция. Новая заявка отправляется, когда текущая позиция равна нулю.

Работа по закрытым свечам делает результаты воспроизводимыми и упрощает тестирование.

## Управление рисками
Перенос сохраняет все защитные механизмы EA:

- **Фиксированный стоп-лосс** (`StopLossPoints`): расстояние от цены входа до стопа задаётся в шагах цены и реализуется рыночным закрытием при достижении уровня.
- **Фиксированный тейк-профит** (`TakeProfitPoints`): аналогично задаётся в пунктах и закрывает позицию по рынку при достижении цели.
- **Трейлинг-стоп** (`TrailingPoints` и `TrailingStepPoints`): когда прибыль превышает заданное расстояние, стратегия фиксирует новый уровень стопа за текущей ценой. Стоп двигается только в сторону профита и увеличивается не менее чем на `TrailingStepPoints`. Уровни приводятся к допустимым значениям через `Security.ShrinkPrice`.

После любого защитного выхода внутренние переменные сбрасываются. Новая сделка получает свежие значения стопов и трейлинга, что соответствует логике изменения ордеров в MetaTrader.

## Параметры
| Параметр | Описание |
| --- | --- |
| `OrderVolume` | Объём рыночных заявок. |
| `TakeProfitPoints` | Дистанция до тейк-профита в шагах цены (0 — отключить). |
| `StopLossPoints` | Дистанция до стоп-лосса в шагах цены (0 — отключить). |
| `TrailingPoints` | Прибыль в шагах цены, необходимая для активации трейлинг-стопа. |
| `TrailingStepPoints` | Минимальное дополнительное смещение трейлинг-стопа. |
| `MaPeriod` | Период MA и StdDev. |
| `MaTypeOption` | Тип MA: SMA, EMA, SMMA, LWMA. |
| `SigmaBuyPoints` | Смещение выше corrected average для входа в лонг. |
| `SigmaSellPoints` | Смещение ниже corrected average для входа в шорт. |
| `CandleType` | Тип свечей, используемых для расчётов и сигналов. |

Каждый числовой параметр помечен `SetCanOptimize(true)`, что облегчает оптимизацию в StockSharp.

## Рекомендации по применению
- По умолчанию используется часовой таймфрейм. При необходимости выберите другой интервал, соответствующий настройкам исходного советника.
- Все параметры в «пунктах» автоматически переводятся в цены через `PriceStep`. Если тик не задан, принимается значение `1`.
- Стратегия принимает решения только на закрытии свечей. Для внутридневного анализа используйте более короткие интервалы.
- Трейлинг реализован через рыночные заявки при пробитии уровня, что повторяет модификацию стопов в MetaTrader и не требует дополнительных отложенных ордеров.
- Согласно заданию, Python-реализация не создавалась.

## Отличия от оригинала
- В StockSharp стратегия работает со свечами, а не с тиковой лентой, поэтому сигналы возникают один раз на свечу.
- Позиции ведутся в неттинговом режиме без встречных сделок, как и в MQL-версии.
- Стопы и тейк-профиты закрываются по рынку вместо изменения параметров существующих ордеров — такой подход удобен в инфраструктуре StockSharp и даёт эквивалентный результат на неттинговых счетах.

Эти изменения сохраняют идею `e-CA-5`, одновременно адаптируя стратегию под архитектуру StockSharp и рекомендации репозитория.
