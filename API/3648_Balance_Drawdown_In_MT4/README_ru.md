# Стратегия Balance Drawdown In MT4

Стратегия переносит советник MetaTrader 4 **BalanceDrawdownInMT4** на высокоуровневый API StockSharp. После запуска она сразу открывает одну длинную позицию и постоянно измеряет просадку счёта относительно максимального достигнутого баланса.

## Логика работы

1. В методе `OnStarted` вызывается `StartProtection`, чтобы активировать управляемые стоп-лосс и тейк-профит, заданные в пунктах.
2. На первой завершённой свече выбранного таймфрейма (по умолчанию 1 минута) стратегия проверяет наличие позиции. Если позиция отсутствует, отправляется рыночная заявка на покупку объёмом `Volume`.
3. После каждой завершённой свечи пересчитывается величина просадки:
   - Максимальный баланс фиксируется как `StartBalance +` накопленная реализованная прибыль (`PnL`).
   - Текущий капитал равен `StartBalance + реализованный PnL + нереализованный PnL`, где нереализованная прибыль берётся из последней цены закрытия свечи, средней цены входа и параметров инструмента `PriceStep`/`StepPrice`.
   - Просадка выражается в процентах падения от максимального баланса до текущего капитала. Значение выводится в журнал через `AddInfoLog`.

Стратегия больше не открывает дополнительных сделок и не переворачивается. Позиция остаётся открытой до срабатывания стопа, тейк-профита или ручного вмешательства.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `StartBalance` | `1000` | Исходный баланс, относительно которого рассчитываются пик и просадка. |
| `Volume` | `0.01` | Объём первой рыночной покупки (в торговых единицах инструмента). |
| `StopLossPoints` | `300` | Дистанция от цены входа до защитного стопа в пунктах. `0` отключает стоп. |
| `TakeProfitPoints` | `400` | Дистанция до тейк-профита в пунктах. `0` отключает цель. |
| `CandleType` | Таймфрейм 1 минута | Тип свечей, по завершению которых обновляется просадка и выполняется проверка позиции. |

## Особенности реализации

- Расчёт просадки повторяет МТ4-логику: накопленный баланс берётся из `StartBalance` и реализованного PnL, а текущий капитал дополняется плавающей прибылью, посчитанной через шаг цены и стоимость шага.
- Если для инструмента отсутствуют `PriceStep` или `StepPrice`, функция возвращает ноль, чтобы избежать деления на ноль.
- Перед открытием стартовой сделки проверяется, что `Volume` положителен; иначе выводится предупреждение, и стратегия остаётся без позиции.
- Свойство `DrawdownPercent` предоставляет текущее значение просадки для внешних модулей мониторинга риска.

## Рекомендации по использованию

- Установите `StartBalance` равным фактическому балансу счёта (или балансу на начало торговой сессии), чтобы получить корректные проценты просадки.
- Сохраняйте минутный таймфрейм для регулярных обновлений или выберите более быстрый синтетический тип свечей, если требуется больший объём данных.
- Стратегия держит только длинную позицию, поэтому для повторного входа после закрытия подключите внешние алгоритмы или управляйте вручную.
- Перед боевым запуском протестируйте алгоритм в симуляторе и убедитесь, что брокер передаёт `PriceStep` и `StepPrice` — от этого зависит корректность расчёта нереализованного PnL.
