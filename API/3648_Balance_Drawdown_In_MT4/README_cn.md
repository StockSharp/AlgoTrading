# Balance Drawdown In MT4 策略

该策略将 MetaTrader 4 的 **BalanceDrawdownInMT4** 专家顾问迁移到 StockSharp 高级 API。启动后立刻买入一手多单，并持续监控账户权益相对历史峰值的回撤。

## 交易逻辑

1. `OnStarted` 中调用 `StartProtection`，根据输入的点数设置托管止损与止盈。
2. 在所选时间框架的第一根收盘 K 线（默认 1 分钟）上检查是否已经持仓。如果账户为空仓，则按 `Volume` 参数提交市价买单。
3. 每根收盘 K 线都会刷新回撤指标：
   - 峰值余额记录为 `StartBalance +` 已实现盈亏 (`PnL`)。
   - 当前权益 = `StartBalance + 已实现 PnL + 未实现 PnL`。未实现盈亏通过最新收盘价、平均成交价以及 `PriceStep` / `StepPrice` 计算得到。
   - 回撤 = 峰值余额与当前权益之间的百分比跌幅。结果会通过 `AddInfoLog` 写入日志。

策略不会加仓或反向开仓。初始头寸将一直持有，直到触发止损、止盈或手动平仓。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `StartBalance` | `1000` | 计算回撤时使用的起始余额。 |
| `Volume` | `0.01` | 初始市价买单的交易数量。 |
| `StopLossPoints` | `300` | 止损距离（点）。`0` 表示不开启止损。 |
| `TakeProfitPoints` | `400` | 止盈距离（点）。`0` 表示不开启止盈。 |
| `CandleType` | 1 分钟 | 触发回撤计算与持仓检查的蜡烛类型。 |

## 实现细节

- 回撤算法复刻原版 EA：峰值余额来自 `StartBalance` 加上已实现收益，当前权益再加上使用价格步长折算的浮动盈亏。
- 若品种未提供 `PriceStep` 或 `StepPrice`，未实现盈亏计算会返回 `0`，以避免除零错误。
- 当 `Volume` 小于等于零时，会记录警告并保持空仓，防止生成无效订单。
- 公开属性 `DrawdownPercent`，便于监控模块或风险控制逻辑读取当前回撤。

## 使用建议

- 将 `StartBalance` 设置为真实账户余额或当日开盘余额，以获得准确的回撤百分比。
- 默认的 1 分钟 K 线能够提供稳定的更新频率，如需更快响应可选择更短周期或自定义蜡烛类型。
- 策略仅持有单向多头，可结合外部策略或手动控制实现重复入场。
- 建议在仿真环境中充分测试，确认行情源会提供 `PriceStep` 与 `StepPrice`，否则浮动盈亏可能偏差。
