# Стратегия CCI and Martin

## Общее описание
Стратегия CCI and Martin ищет резкий разворот после короткой серии однонаправленных свечей и подтверждает сигнал индикатором Commodity Channel Index. Логика повторяет оригинальный советник MetaTrader 5, но использует высокоуровневый API StockSharp. Алгоритм работает только с закрытыми свечами и может применяться к любым инструментам, для которых доступны CCI и шаг цены.

## Правила входа
- **Покупка**
  - Свечи `-2` и `-1` должны быть медвежьими (цена открытия выше цены закрытия).
  - Свеча `0` должна закрыться выше своей цены открытия и выше цены открытия свечи `-1`.
  - CCI на свече `-1` должен быть ниже `+5`, ниже значения свечи `-2`, а CCI на свечах `-2` и `-3` должен последовательно снижаться. Текущее значение CCI (свеча `0`) должно развернуться вверх и превысить предыдущий уровень.
  - Если все условия выполняются и позиция отсутствует, открывается длинная позиция.
- **Продажа**
  - Свечи `-2` и `-1` должны быть бычьими (цена открытия ниже цены закрытия).
  - Свеча `0` должна закрыться ниже своей цены открытия и ниже цены открытия свечи `-1`.
  - CCI на свече `-1` должен быть выше `-5`, выше значения свечи `-2`, а CCI на свечах `-2` и `-3` должен последовательно расти. Текущее значение CCI (свеча `0`) должно развернуться вниз и опуститься ниже предыдущего уровня.
  - Если все условия выполняются и позиция отсутствует, открывается короткая позиция.

Изначально советник ждал 40 секунд после начала новой минуты, чтобы исключить «сырые» значения. В реализации на StockSharp анализируются только завершённые свечи, поэтому дополнительная задержка не требуется.

## Управление рисками
- **Стоп-лосс** и **тейк-профит** задаются в пунктах. При расчёте они переводятся в абсолютное смещение по цене: шаг цены умножается на десять для инструментов с трёх- и пятизначной котировкой, что соответствует оригинальной логике расчёта пункта.
- **Трейлинг-стоп** активируется, когда цена проходит расстояние, равное сумме трейлинг-стопа и шага. После активации стоп переносится вслед за ценой на величину трейлинг-стопа и обновляется только при движении больше заданного шага.
- Нулевые значения стоп-лосса или тейк-профита отключают соответствующие выходы. Для работы трейлинга необходимо указать положительные значения и дистанции, и шага.

## Управление объёмом
Доступны два независимых механизма изменения объёма позиции.
- **Мартингейл** умножает текущий объём на заданный коэффициент, когда количество последовательных убыточных сделок достигает порога. Увеличение объёма ограничено максимальным числом шагов. Любая прибыльная сделка возвращает объём к исходному значению.
- **Пошаговое увеличение** прибавляет фиксированное значение к объёму либо после убыточной сделки, либо после прибыльной (режим задаётся параметром). Прирост нормализуется по шагу объёма инструмента и ограничивается максимальным объёмом. При превышении лимита или отсутствии сигнала объём возвращается к стартовому уровню.

Как и в оригинальном советнике, одновременное включение мартингейла и пошагового увеличения запрещено и контролируется кодом.

## Параметры
- `CandleType` – тип свечей для анализа.
- `CciPeriod` – период сглаживания индикатора CCI.
- `InitialVolume` – базовый объём сделки.
- `StopLossPips` – стоп-лосс в пунктах.
- `TakeProfitPips` – тейк-профит в пунктах.
- `TrailingStopPips` – дистанция трейлинг-стопа в пунктах (0 отключает трейлинг).
- `TrailingStepPips` – минимальное улучшение цены для переноса трейлинг-стопа.
- `EnableMartingale` – включить мартингейл после убыточных сделок.
- `MartingaleCoefficient` – коэффициент умножения объёма при мартингейле.
- `MartingaleTriggerLosses` – сколько подряд убыточных сделок требуется для активации.
- `MartingaleMaxSteps` – максимальное количество шагов мартингейла.
- `EnableStepAdjustments` – включить пошаговое изменение объёма.
- `StepVolumeIncrement` – величина прибавки к объёму при срабатывании правила.
- `StepVolumeMax` – верхний предел объёма для пошагового режима.
- `StepAdjustmentMode` – режим срабатывания (после убытка или после прибыли).

## Примечания
- Предполагается, что рыночные заявки исполняются близко к указанной цене. Для имитации тикового трейлинга из оригинального советника стопы пересчитываются на каждой завершённой свече.
- Если шаг цены инструмента отличается от стандартных валютных котировок, пересчёт пунктов всё равно выполняется, но денежная оценка пунктов может отличаться.
