# CCI and Martin 策略

## 概述
CCI and Martin 策略在短期的单向行情后寻找快速反转信号，并使用商品通道指数（CCI）进行确认。该实现完全复刻原始 MetaTrader 5 专家顾问的交易逻辑，同时基于 StockSharp 的高级 API，仅处理已经完成的 K 线，可用于任意提供 CCI 与价格步长信息的交易品种。

## 交易规则
- **做多条件**
  - `-2` 和 `-1` 两根 K 线必须为阴线（开盘价高于收盘价）。
  - 当前 K 线 `0` 必须收在开盘价之上，并且高于前一根 K 线 `-1` 的开盘价。
  - CCI 在 K 线 `-1` 上需要低于 `+5`，低于 `-2` 的数值，并且 `-2` 与 `-3` 的 CCI 必须形成下降序列；当前 CCI（K 线 `0`）需要向上拐头并高于 `-1` 的值。
  - 满足以上条件且没有持仓时，开多单。
- **做空条件**
  - `-2` 和 `-1` 两根 K 线必须为阳线（开盘价低于收盘价）。
  - 当前 K 线 `0` 必须收在开盘价之下，并且低于前一根 K 线 `-1` 的开盘价。
  - CCI 在 K 线 `-1` 上需要高于 `-5`，高于 `-2` 的数值，并且 `-2` 与 `-3` 的 CCI 必须形成上升序列；当前 CCI（K 线 `0`）需要向下拐头并低于 `-1` 的值。
  - 满足以上条件且没有持仓时，开空单。

原版 EA 会在新一分钟开始后等待 40 秒以避免未完成的 K 线；本实现只处理收盘后的 K 线，因此无需额外延迟。

## 风险控制
- **止损** 和 **止盈** 以“点”表示。程序会根据合约的价格步长自动换算为价格偏移量：对于 3 位或 5 位报价的品种，点值等于价格步长乘以 10，与原始策略一致。
- **移动止损** 在价格运行超过“移动止损距离 + 移动步长”后启动，随后按照移动止损距离跟踪价格，仅当价格进一步改善超过移动步长时才会继续上移（或下移）。
- 当止损或止盈为零时，对应的保护措施会被禁用。要启用移动止损，距离和步长都必须为正值。

## 仓位管理
策略提供两个可选的仓位调整机制。
- **马丁格尔**：当连续亏损次数达到阈值时，将当前交易量乘以马丁系数。放大次数不会超过预设的最大步数，任意一次盈利都会把交易量重置为初始值。
- **阶梯加仓**：根据设定模式在亏损后或盈利后增加固定数量的交易量。增加的数量会按合约的最小交易单位归一化，并受最大交易量限制；超过上限或条件不满足时，交易量回到初始值。

与原策略一致，马丁格尔与阶梯加仓无法同时启用，代码会抛出异常提醒。

## 参数
- `CandleType` – 使用的 K 线类型。
- `CciPeriod` – CCI 指标的计算周期。
- `InitialVolume` – 初始下单数量。
- `StopLossPips` – 止损距离（点）。
- `TakeProfitPips` – 止盈距离（点）。
- `TrailingStopPips` – 移动止损距离（点，0 表示关闭）。
- `TrailingStepPips` – 移动止损的最小触发步长。
- `EnableMartingale` – 是否启用马丁格尔放大。
- `MartingaleCoefficient` – 马丁格尔放大系数。
- `MartingaleTriggerLosses` – 触发马丁格尔所需的连续亏损次数。
- `MartingaleMaxSteps` – 马丁格尔最多执行的步数。
- `EnableStepAdjustments` – 是否启用阶梯加仓。
- `StepVolumeIncrement` – 阶梯加仓的增量。
- `StepVolumeMax` – 阶梯加仓允许的最大交易量。
- `StepAdjustmentMode` – 阶梯加仓触发模式（亏损后或盈利后）。

## 注意事项
- 策略假设市价单能够以接近请求的价格成交。为了模拟原版的逐笔移动止损，止损价会在每根完成的 K 线上重新计算。
- 如果品种的价格步长与常见外汇报价不同，点值换算仍然有效，但每一点对应的金额可能有所差异。
