# 布林带多头/空头分层策略

## 概述

该策略是 MetaTrader 专家顾问 **Bollinger Bands N positions** 的 StockSharp 移植版本。策略监控收盘价与布林带上下轨之间的关系，只要行情在完成的 K 线收盘价位于通道之外，就会触发入场信号。为了重现原始专家顾问的仓位管理逻辑，策略会限制总敞口、设置固定止损/止盈，并在盈利达到指定幅度后启动移动止损。

## 交易逻辑

1. 订阅设定的蜡烛类型，并按配置的周期和标准差倍数计算布林带。
2. 每根完整 K 线到来时，策略首先检查当前持仓是否需要离场：
   - 多头仓位在触及固定止损、固定止盈或跌破移动止损时退出。
   - 空头仓位使用对称的判断逻辑。
3. 如果本根 K 线没有触发离场，并且策略允许交易，则评估入场信号：
   - 当收盘价高于上轨时，策略会平掉任何现有的空头敞口，并在未超过仓位上限的前提下按配置的手数建立新的多头仓位。
   - 当收盘价低于下轨时，策略会平掉任何现有的多头敞口，并按相同方式开立新的空头仓位。
4. 一旦盈利超过“移动止损距离 + 移动步长”，移动止损开始生效。止损价保持在价格后方“移动止损距离”处，并且只有当盈利进一步增加至少一个“移动步长”时才会继续向盈利方向推进。

## 仓位管理

- **Max Positions** 参数以 `MaxPositions × Volume` 的形式定义允许的最大净仓。由于 StockSharp 采用净持仓模式，策略在任何时刻只能持有一个净方向的仓位，因此该参数实际上用于防止净仓位超过指定阈值后继续加仓。
- 止损与止盈距离以点（pip）为单位，通过交易品种的 `PriceStep` 转换为价格偏移。如果交易品种使用小数点后一位的点值，需要相应调整参数数值。
- 启用移动止损时必须同时设置正的移动距离与移动步长；将移动距离设为 0 会关闭移动止损模块。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|-------|
| `Volume` | 每次进场使用的手数。 | `0.1` |
| `MaxPositions` | 允许的最大净仓量，按 `Volume` 的倍数表示。 | `9` |
| `BollingerPeriod` | 布林带移动平均的周期。 | `20` |
| `BollingerWidth` | 布林带标准差倍数。 | `2` |
| `StopLossPips` | 固定止损距离（点）。 | `50` |
| `TakeProfitPips` | 固定止盈距离（点）。 | `50` |
| `TrailingStopPips` | 移动止损距离（点），为 `0` 时禁用移动止损。 | `5` |
| `TrailingStepPips` | 移动止损每次推进所需的最小盈利增量（点）。 | `5` |
| `CandleType` | 用于计算布林带的蜡烛类型或时间框架。 | `1 分钟时间框架` |

## 与 MQL5 原版的差异

- 原版专家顾问运行在 MetaTrader 的锁仓模式，可以同时持有多头和空头仓位。本移植版在 StockSharp 的净持仓模式下运行，因此在入场之前会先平掉相反方向的敞口；`MaxPositions` 参数也随之变为对净仓位绝对值的限制。
- 止损与止盈（包括移动止损）在策略内部模拟，而非以附加委托的形式发送到服务器。这种做法符合原版 EA 的移动止损逻辑，但意味着平仓会在下一根完成的 K 线上执行。
- 启用移动止损且步长为零时，策略在启动阶段会抛出异常，复现原始 EA 在初始化时的参数校验。

## 使用提示

1. 根据品种合约规模和点值调整 `Volume`、`MaxPositions` 以及风险参数。
2. 确认交易品种提供有效的 `PriceStep`。如果返回值为 0，策略会退化为使用 `1`，这可能不适用于所有市场。
3. 建议等待布林带周期完成（即指标充分预热）后再允许策略进场，以避免基于不完整的数据做出决策。
4. 修改移动止损配置时留意日志中的提示信息，确保步长与距离的组合有效。
