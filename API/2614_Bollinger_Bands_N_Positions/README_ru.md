# Стратегия Bollinger Bands N Positions

## Обзор

Эта стратегия представляет собой перенос эксперта MetaTrader **Bollinger Bands N positions** на платформу StockSharp. Алгоритм анализирует закрытие свечей относительно полос Боллинджера и открывает сделки, когда цена завершает бар за пределами канала. Для повторения поведения оригинального эксперта реализованы ограничение суммарной позиции, фиксированные стоп-лосс и тейк-профит, а также ступенчатое сопровождение прибыли при помощи трейлинг-стопа.

## Логика работы

1. Подписаться на выбранный тип свечей и рассчитать полосы Боллинджера с заданными периодом и коэффициентом ширины.
2. На каждой завершённой свече в первую очередь выполняется проверка открытой позиции:
   - Лонг закрывается при срабатывании фиксированного стоп-лосса, тейк-профита или при пробое текущего уровня трейлинг-стопа.
   - Шорт обрабатывается зеркально.
3. Если выход по текущему бару не произошёл и торговля разрешена, оцениваются сигналы на вход:
   - При закрытии выше верхней полосы стратегия закрывает противоположные (шортовые) позиции и при соблюдении лимита по размеру открывает новый лонг требуемым объёмом.
   - При закрытии ниже нижней полосы аналогичным образом закрываются лонги и открывается шорт.
4. Трейлинг-стоп активируется, когда прибыль превышает сумму «дистанция трейлинга + шаг». Уровень стопа удерживается на расстоянии, равном дистанции трейлинга, и смещается только при росте прибыли минимум на один шаг.

## Управление позицией

- Параметр **Max Positions** задаёт максимальную величину чистой позиции в величинах `MaxPositions × Volume`. StockSharp работает в режиме неттинга, поэтому одновременно возможно держать только одну совокупную позицию. Ограничение предотвращает открытие новой сделки, если текущая абсолютная позиция уже достигла допустимого порога.
- Стоп-лосс и тейк-профит задаются в пунктах (pip) и переводятся в цену через `PriceStep` инструмента. При торговле инструментами с дробным пунктом следует скорректировать значения.
- Для включения трейлинг-стопа необходимо, чтобы и дистанция, и шаг были больше нуля. Значение `0` отключает модуль сопровождения прибыли.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `Volume` | Объём заявки в лотах. | `0.1` |
| `MaxPositions` | Максимально допустимый чистый объём позиции в кратных `Volume`. | `9` |
| `BollingerPeriod` | Период скользящей средней полос Боллинджера. | `20` |
| `BollingerWidth` | Множитель стандартного отклонения. | `2` |
| `StopLossPips` | Дистанция стоп-лосса в пунктах. | `50` |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | `50` |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах (0 — отключить). | `5` |
| `TrailingStepPips` | Минимальное увеличение прибыли для переноса трейлинг-стопа. | `5` |
| `CandleType` | Тип свечей для расчёта индикаторов. | `таймфрейм 1 минута` |

## Отличия от версии MQL5

- В MetaTrader эксперт работает в режиме хеджирования и может держать встречные позиции. В переносе на StockSharp используются неттинговые позиции, поэтому перед открытием новой сделки противоположное плечо закрывается, а `MaxPositions` ограничивает абсолютную величину нетто-позиции.
- Стоп-заявки реализованы внутри стратегии, а не выставляются на сервер. Это соответствует оригинальному трейлинг-стопу, но закрытие произойдёт на следующей завершённой свече.
- При включенном трейлинг-стопе и нулевом шаге стратегия остановится на этапе запуска с сообщением об ошибке, что повторяет проверку параметров в исходном эксперте.

## Рекомендации по использованию

1. Настройте `Volume`, `MaxPositions` и рисковые параметры в соответствии с лотностью и стоимостью шага цены выбранного инструмента.
2. Убедитесь, что у инструмента задан корректный `PriceStep`. Если значение равно нулю, стратегия использует единицу, что подходит не для всех рынков.
3. Позвольте индикатору прогреться (по крайней мере на длину периода Боллинджера) перед запуском торговли, чтобы исключить сигналы на неполных данных.
4. После изменения настроек трейлинг-стопа проверяйте журнал сообщений: стратегия предупредит о некорректных сочетаниях дистанции и шага.
