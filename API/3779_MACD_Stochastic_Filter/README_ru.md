# Стратегия MACD + стохастический фильтр тренда
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет работу советника из папки `MQL/7604`. В оригинале использовался пользовательский индикатор с «зелёной» и «красной» линиями. Набор параметров `(15, 3, 3)` полностью совпадает с классическим стохастическим осциллятором, поэтому в версии для StockSharp применяется стандартный `Stochastic`, а подтверждение направления дополнительно контролируется MACD и экспоненциальной скользящей средней.

Алгоритм торгует в обе стороны. Для входа требуется пересечение %K и %D в сторону сделки, бычий или медвежий разворот гистограммы MACD с минимальным удалением от нулевой линии, а также подтверждение тренда по EMA. Управление рисками аналогично MQL-варианту: фиксированный стоп-лосс, тейк-профит и трейлинг-стоп в пунктах, который подтягивает защитный уровень при движении позиции в прибыль.

## Индикаторы

- **MovingAverageConvergenceDivergenceSignal** (`fast = 12`, `slow = 26`, `signal = 9`). Гистограмма должна пересечь сигнальную линию, оставаясь ниже нуля для покупок и выше нуля для продаж. Параметры `MacdOpenLevel` и `MacdCloseLevel` задают минимальное абсолютное значение гистограммы.
- **Stochastic** (`Length = 15`, `KPeriod = 3`, `DPeriod = 3`). Линия %K соответствует «зелёному» буферу и должна быть выше %D для покупок (ниже для продаж). То же условие используется для выхода.
- **ExponentialMovingAverage** с периодом `26`. EMA служит трендовым фильтром: для длинной позиции текущая EMA должна быть выше предыдущей, для короткой — ниже.

## Правила входа

1. **Покупка**
   - На закрытой свече %K > %D.
   - MACD < 0 и выше сигнальной линии на текущем баре.
   - На предыдущем баре MACD < сигнальной линии (пересечение вверх происходит сейчас).
   - `|MACD| > MacdOpenLevel * шаг_цены`.
   - EMA растёт (текущее значение больше предыдущего).
2. **Продажа**
   - На закрытой свече %K < %D.
   - MACD > 0 и ниже сигнальной линии на текущем баре.
   - На предыдущем баре MACD > сигнальной линии (пересечение вниз происходит сейчас).
   - `MACD > MacdOpenLevel * шаг_цены`.
   - EMA падает (текущее значение меньше предыдущего).

Если позиция уже открыта, новые заявки не выставляются до её закрытия.

## Правила выхода

При активной позиции постоянно контролируются следующие условия:

- **Индикаторный выход**
  - Для длинной позиции: `%K < %D`, MACD > 0, MACD < сигнала, а на предыдущем баре MACD был выше сигнальной линии; дополнительно `|MACD| > MacdCloseLevel * шаг_цены`.
  - Для короткой позиции: `%K > %D`, MACD < 0, MACD > сигнала, на предыдущем баре MACD был ниже сигнальной линии; `|MACD| > MacdCloseLevel * шаг_цены`.
- **Стоп-лосс** по параметру `StopLossPoints` (переводится в цену через `PriceStep`).
- **Тейк-профит** по параметру `TakeProfitPoints`.
- **Трейлинг-стоп**: после движения в прибыль на `TrailingStopPoints * PriceStep` стоп подтягивается к цене, фиксируя минимум указанного результата.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TradeVolume` | Объём сделки в лотах | `0.1` |
| `TakeProfitPoints` | Тейк-профит в пунктах | `10` |
| `StopLossPoints` | Стоп-лосс в пунктах | `50` |
| `TrailingStopPoints` | Дистанция трейлинг-стопа | `5` |
| `MacdOpenLevel` | Минимальная гистограмма MACD для входа | `3` |
| `MacdCloseLevel` | Минимальная гистограмма MACD для выхода | `2` |
| `MacdFastPeriod` | Быстрая EMA в MACD | `12` |
| `MacdSlowPeriod` | Медленная EMA в MACD | `26` |
| `MacdSignalPeriod` | EMA сигнальной линии | `9` |
| `EmaPeriod` | Период EMA-фильтра | `26` |
| `StochasticLength` | Окно стохастика | `15` |
| `StochasticKPeriod` | Сглаживание %K | `3` |
| `StochasticDPeriod` | Сглаживание %D | `3` |
| `CandleType` | Таймфрейм расчёта | `15m` |

## Особенности

- Расчёты выполняются только на завершённых свечах, что соответствует циклу `start()` в MQL.
- Один пункт определяется свойством `PriceStep` инструмента; при отсутствии шага цена считается равной `1`.
- Используется исключительно высокоуровневый API StockSharp: индикаторы подключаются через `BindEx`, исторические массивы вручную не создаются, заявки отправляются методами `BuyMarket` и `SellMarket`.
