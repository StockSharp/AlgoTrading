# Williams Percent Directional Index 策略

## 概述
**Williams Percent Directional Index 策略** 在 StockSharp 高级 API 中重现了 MetaTrader 5 专家顾问“Mt5 Williams % Directional Index EA”。策略以 Williams %R 动量曲线与平均方向指数（ADX）交叉为入场触发点，并使用资金流量指数（MFI）与随机指标确认离场。程序只处理已经收盘的K线，并通过指标绑定获取最新的计算结果。

## 交易逻辑
1. **趋势确认**
   - 多头：比较之前两根已收盘K线的 Williams %R 数值，如果出现上升斜率（较早的数值大于较新的数值），视为看涨动能。
   - 空头：同样比较两根K线，如果斜率向下（较早的数值小于较新的数值），视为看跌动能。
   - ADX 的方向性差值（`+DI - -DI`）必须在上一根K线上穿或下穿零轴。负值到正值的过渡支持做多，正值到负值的过渡支持做空。
2. **开仓规则**
   - 当 Williams %R 与 ADX 同时给出多头信号，并且当前没有多单时，立即以市价买入。
   - 当两个指标同时给出空头信号，并且当前没有空单时，立即以市价卖出。
   - 如果两个方向同时满足（极少出现），策略会跳过该信号以避免互相矛盾的指令。
3. **平仓规则**
   - 多单在以下任一条件满足时离场：两根K线前的 MFI 数值高于超买阈值，或随机指标 %K 出现局部底部形态（`K[-2] > K[-1] < K[0]`）。
   - 空单在以下任一条件满足时离场：两根K线前的 MFI 数值低于对称的超卖水平（`100 - 阈值`），或随机指标 %K 出现局部顶部形态（`K[-2] < K[-1] > K[0]`）。
4. **风险控制**
   - 本转换保留了原策略的信号逻辑，但未实现 MQL 版本中的止损、拖尾或交易会话管理。可根据需要在 StockSharp 中添加 `StartProtection` 或其他风险模块。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `Candle Type` | 所有指标使用的K线周期。 | 15 分钟 |
| `Williams %R Period` | Williams %R 的回溯周期。 | 42 |
| `Directional Period` | ADX（含 +DI/-DI）使用的周期长度。 | 20 |
| `MFI Period` | 资金流量指数的周期长度。 | 19 |
| `MFI Level` | 触发平仓的超买阈值，对应超卖阈值为 `100 - 该值`。 | 79 |
| `Stochastic %K` | 随机指标 %K 的周期。 | 22 |
| `Stochastic %D` | 随机指标 %D 的周期。 | 16 |
| `Stochastic Smoothing` | 随机指标的平滑（减速）周期。 | 21 |

全部参数均通过 `StrategyParam` 暴露，可在 UI 中直接调整或用于优化。

## 使用说明
- 启动前需绑定交易品种并设置合适的下单手数（Volume）。
- 仅处理 `CandleStates.Finished` 的K线，确保全部指标数值已经最终确定。
- 若系统支持图表，策略会同时绘制价格、Williams %R、ADX、MFI、随机指标以及成交记录。
- 若需完全复制 MT5 EA 的风控特性，请自行在 StockSharp 中增加保护措施或自定义管理逻辑。

## 与原始 MQL 版本的差异
- 通过高层 `BindEx` 接口直接获取指标数值，不再使用缓冲区复制，但核心的零轴穿越与多K线形态判断完全遵循原策略。
- 会话过滤、下单重试和拖尾止损等管理代码未迁移，重点放在信号转换部分，方便后续根据需要添加。
