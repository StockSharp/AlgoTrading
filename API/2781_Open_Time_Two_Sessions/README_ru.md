# Стратегия Open Time Two

## Обзор
**Open Time Two Strategy** автоматизирует торговлю по расписанию и позволяет вести два независимых торговых интервала в течение дня. Для каждого интервала задаются направление, параметры риск-менеджмента и необязательное окно принудительного закрытия. Реализация повторяет исходный советник MetaTrader, но использует высокоуровневые API StockSharp, свечные данные и систему `StrategyParam`.

## Логика работы
1. **Окна закрытия.** Для каждого интервала можно активировать собственное окно закрытия. Когда время свечи попадает в окно (старт + глобальная продолжительность), стратегия закрывает позиции этого интервала и сбрасывает состояние.
2. **Сопровождение трейлинг-стопа.** Если заданы положительные величины трейлинг-стопа и шага, стратегия на каждой закрытой свече проверяет, прошла ли цена минимум `TrailingStop + TrailingStep` в прибыльную сторону. Тогда стоп переносится вперёд на расстояние `TrailingStop`, при этом шаг гарантирует отсутствие лишних обновлений.
3. **Контроль стоп-лосса и тейк-профита.** Для каждого интервала определены собственные расстояния в пунктах. На каждой свече максимум/минимум сравниваются с уровнями; при пробитии позиция интервала закрывается.
4. **Фильтр по дням недели.** Торговля ведётся только в разрешённые дни. Если текущая свеча относится к запрещённому дню, новые сделки не открываются.
5. **Окна открытия.** У каждого интервала есть своё начало и конец открытия. Глобальный параметр продолжительности расширяет окно за пределы времени окончания. Пока окно активно и интервал свободен, стратегия открывает рыночный ордер в заданном направлении.
6. **Синхронизация позиции.** Активные интервалы формируют целевую суммарную позицию. Стратегия вызывает `BuyMarket` или `SellMarket`, чтобы реальная позиция совпадала с суммой позиций интервалов. Каждый интервал хранит цену входа, уровни стоп/тейк и состояние трейлинг-стопа.

## Описание параметров
- **Close Window #1 / Close Window #2** – включение окон принудительного закрытия для каждого интервала.
- **Close Start #1 / Close Start #2** – локальное время начала соответствующих окон закрытия.
- **Trailing Stop / Trailing Step** – расстояние трейлинг-стопа и шаг в пунктах. Оба параметра должны быть больше нуля для активации сопровождения.
- **Trade Monday … Trade Friday** – фильтры по дням недели, требуется оставить хотя бы один включённый день.
- **Open Start #1 / Open End #1 / Open Start #2 / Open End #2** – границы окон открытия. Конец окна продлевается на время, указанное в Duration.
- **Window Duration** – дополнительная длительность, прибавляемая к окончаниям окон открытия и закрытия.
- **Direction #1 / Direction #2** – направление торговли (`true` – покупка, `false` – продажа) по каждому интервалу.
- **Trade Volume** – объём ордеров для каждого интервала, совпадает для обеих сессий как в оригинальном советнике.
- **Stop Loss #1 / Take Profit #1 / Stop Loss #2 / Take Profit #2** – расстояния до стоп-лосса и тейк-профита в пунктах. Ноль отключает уровень.
- **Candle Type** – тип свечей, по которым принимаются решения. Все проверки выполняются после закрытия свечи.

## Особенности риск-менеджмента
- Пункты переводятся в цену через минимальный шаг цены. Для инструментов с тремя или пятью знаками шаг умножается на десять, что повторяет определение пункта в MetaTrader.
- Логика трейлинг-стопа общая для двух интервалов, а уровни стоп/тейк работают независимо.
- При срабатывании стопа или трейлинга интервал сбрасывается, что позволяет снова открыться внутри того же окна.

## Ограничения и примечания
- StockSharp использует неттинговую модель. Если направления интервалов противоположны, итоговая позиция будет обнуляться, и удерживать хедж одновременно не получится. Для полноценного хеджирования нужен портфель с поддержкой хедж-режима.
- Решения принимаются на основе выбранного таймфрейма свечей, поэтому чем больше период, тем медленнее реакция по сравнению с тиковым исполнением MetaTrader.
- Сравнения времени выполняются в локальной временной зоне. Необходимо следить за синхронизацией времени терминала и биржи.

## Рекомендации по использованию
- Подбирайте тип свечей в соответствии с требуемой точностью расписания (например, минутные свечи для минутных окон).
- Сочетайте фильтр по дням недели и окна закрытия, чтобы избегать переноса позиций через нежелательные сессии.
- Используйте встроенные параметры `StrategyParam` для оптимизации – ключевые поля уже помечены `SetCanOptimize`.
