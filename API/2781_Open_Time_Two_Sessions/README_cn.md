# 开盘时间双时段策略

## 概述
**开盘时间双时段策略** 通过预设的时间计划自动交易，可在同一交易日内管理两个独立的交易时段。每个时段都可以单独设置方向、风控参数以及可选的强制平仓窗口。该实现基于原始 MetaTrader 策略，使用 StockSharp 的高级 API、蜡烛数据和参数系统来完成配置与优化。

## 交易逻辑
1. **时段平仓窗口。** 每个时段都可以启用一个单独的平仓窗口。当蜡烛时间落入窗口（开始时间加上全局持续时间）时，对应时段的仓位会被强制关闭，同时重置内部状态。
2. **移动止损维护。** 当启用移动止损和步长后，策略会在每根收盘蜡烛上检查价格是否至少向有利方向移动了 `TrailingStop + TrailingStep`。满足条件时止损价向前推进 `TrailingStop`，并要求推进距离至少达到步长以避免频繁更新。
3. **止损/止盈监控。** 每个时段拥有独立的止损和止盈距离（以点为单位）。每根收盘蜡烛都会用最高价/最低价与这些水平比较，一旦被触发立即关闭该时段。
4. **按星期过滤。** 只有在被允许的工作日内策略才会开仓；若当前蜡烛属于未启用的工作日，则不会产生新的交易。
5. **开仓时间窗口。** 每个时段有自己的开仓开始与结束时间，全局持续时间会延长窗口的结束边界。在窗口内且该时段尚未持仓时，会按配置的方向市价开仓。
6. **仓位同步。** 活动时段会贡献一个目标净仓位，策略调用 `BuyMarket` 或 `SellMarket` 使实际净仓位与各时段的头寸之和一致。每个时段会保存各自的入场价、止损/止盈以及移动止损状态。

## 参数说明
- **Close Window #1 / Close Window #2** – 是否启用每个时段的强制平仓窗口。
- **Close Start #1 / Close Start #2** – 对应平仓窗口的起始时间（本地时区）。
- **Trailing Stop / Trailing Step** – 移动止损距离与步长（点）。只有两者均大于零时才会启用移动止损。
- **Trade Monday … Trade Friday** – 星期过滤开关，至少需要保留一个开启的交易日。
- **Open Start #1 / Open End #1 / Open Start #2 / Open End #2** – 每个时段的开仓时间窗口，结束时间会加上全局持续时间。
- **Window Duration** – 添加到开仓与平仓窗口结束边界的额外时间。
- **Direction #1 / Direction #2** – 每个时段的交易方向（`true` 为做多，`false` 为做空）。
- **Trade Volume** – 每个时段的下单数量，默认与原策略相同，两段使用一致的手数。
- **Stop Loss #1 / Take Profit #1 / Stop Loss #2 / Take Profit #2** – 各时段的止损与止盈距离（点），为零表示禁用该水平。
- **Candle Type** – 驱动策略的蜡烛类型，所有时间判断与风控检查都在蜡烛收盘时执行。

## 风控细节
- 点值通过证券的最小价格步长转换；若品种有三位或五位小数，则将步长乘以十以复现 MetaTrader 的点定义。
- 移动止损逻辑在两个时段之间共享，而止损/止盈值相互独立。
- 当止损、止盈或移动止损被触发后，该时段会立即重置，可在同一窗口内再次开仓。

## 限制与注意事项
- StockSharp 采用净头寸模式。如果两个时段设置为相反方向，净头寸会相互抵消，而无法同时保持对冲仓位。若需要真正的对冲，请使用支持对冲的投资组合。
- 策略基于所选蜡烛频率做出决策，较大的时间周期会比原始的逐笔实现响应更慢。
- 时间判断依赖终端的本地时间，请确保交易所时间与终端时间保持同步。

## 使用建议
- 选择与交易计划粒度匹配的蜡烛类型，例如一分钟蜡烛可以实现精细的时间控制。
- 结合星期过滤和平仓窗口可以避免在不希望的时段持仓过夜。
- 通过 `StrategyParam` 参数执行优化，主要参数已启用 `SetCanOptimize`，方便批量测试。
