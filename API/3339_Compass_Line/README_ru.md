# Compass Line Strategy
[English](README.md) | [中文](README_cn.md)

Стратегия воспроизводит советник CompassLine, объединяя два фильтра:

* **Follow Line** — трейлинг на основе пробоя полос Боллинджера с опциональным смещением ATR. При выходе цены за пределы полос линия продолжает расти (или снижаться) и не откатывается, пока сохраняется тренд.
* **Compass** — логистическое преобразование медианной цены относительно максимума и минимума за период скользящей средней. Сырый сигнал дважды сглаживается треугольным окном для получения устойчивого состояния «бык/медведь».

Сделка открывается только при совпадении направления обоих фильтров. Дополнительно доступны временной фильтр и защитные стопы, как в оригинальной реализации.

## Детали

- **Вход**:
  - Follow Line должен указывать вверх (закрытие выше верхней полосы) для покупок или вниз (закрытие ниже нижней полосы) для продаж. Смещение ATR включается параметром `UseAtrFilter`.
  - Состояние Compass (период задаётся `CompassPeriod`) должно быть положительным для покупок и отрицательным для продаж после двойного сглаживания.
  - Торговля выполняется только в рамках сессии, заданной `UseTimeFilter` и строкой `Session` (формат HHmm-HHmm).
- **Длинные/Короткие**: Оба направления поддерживаются.
- **Выход**:
  - `CloseMode = None` удерживает позицию до появления противоположного сигнала или срабатывания стопов.
  - `CloseMode = BothIndicators` закрывает позицию, когда Follow Line и Compass одновременно меняют направление.
  - `CloseMode = FollowLineOnly` закрывает позицию при смене направления Follow Line.
  - `CloseMode = CompassOnly` закрывает позицию при смене полярности Compass.
- **Стопы**: `TakeProfit` и `StopLoss` (в шагах цены) устанавливаются после каждого входа, если заданы больше нуля.
- **Значения по умолчанию**:
  - `FollowBbPeriod` = 21
  - `FollowBbDeviation` = 1
  - `FollowAtrPeriod` = 5
  - `UseAtrFilter` = false
  - `CompassPeriod` = 30 (длина сглаживания = round(CompassPeriod / 3))
  - `CloseMode` = None
  - `UseTimeFilter` = false
  - `Session` = "0000-2400"
  - `TakeProfit` = 0
  - `StopLoss` = 0
  - `CandleType` = TimeSpan.FromMinutes(15)
- **Фильтры**:
  - Категория: Trend
  - Направление: Both
  - Индикаторы: Bollinger Bands, ATR, Triangular moving average
  - Стопы: Опционально
  - Сложность: Intermediate
  - Таймфрейм: Intraday
  - Сезонность: Нет
  - Нейросети: Нет
  - Дивергенции: Нет
  - Уровень риска: Medium

## Дополнительно

- Длина сглаживания Compass равна round(`CompassPeriod` / 3), что повторяет оригинальный индикатор.
- Строки сессии вроде `0930-1600` ограничивают торговлю указанным окном, при этом индикаторы продолжают обновляться за его пределами.
- Защитные заявки используют высокоуровневые методы StockSharp и совместимы с управлением рисками портфеля.
