# Стратегия Three Breaky

**Three Breaky** — это точная конверсия советника MetaTrader 4 `ThreeBreaky_v1.mq4` на платформу StockSharp. Стратегия сохраняет три независимых модуля пробоя, переносит расчёты по свечам на высокоуровневый API и добавляет явный учёт позиций для каждого блока. Все сигналы формируются на одном настраиваемом таймфрейме, а каждый модуль можно включать или отключать отдельно.

## Торговые модули

1. **System 1 – Прорыв через расширение ATR**
   - Анализирует только предыдущую свечу.
   - Покупает, если свеча бычья и её диапазон (High–Low) больше четырёх средних истинных диапазонов за 72 периода.
   - Продаёт, если свеча медвежья и выполнено то же условие по диапазону.

2. **System 2 – Переворот облака Ichimoku**
   - Использует границы облака (Senkou Span A и B) с периодами 9/26/52.
   - Сигнал на покупку появляется, когда свеча два бара назад закрылась ниже обеих границ, а последняя свеча закрылась выше обеих.
   - Сигнал на продажу возникает, когда две свечи назад закрытие было выше облака, а последняя свеча закрылась ниже облака.

3. **System 3 – Исключительная свеча с большим телом**
   - Хранит размеры тел предыдущих 20 завершённых свечей.
   - Покупает, если последняя свеча бычья и её тело более чем втрое превышает максимальное тело из сохранённого набора.
   - Продаёт по зеркальному условию для медвежьей свечи.

Каждый модуль ведёт «свою» виртуальную позицию. Метки времени сделок сохраняются, чтобы повторно не открывать ордера в пределах одной свечи, как это делали переменные `buyTag` и `sellTag` в исходном коде.

## Правила выхода

- **Пересечение Parabolic SAR**. Все позиции делят один Parabolic SAR (0.005/0.2). Если цена пересекает SAR между двумя последними свечами, позиция закрывается.
- **Риск-менеджмент**. Опциональные стоп-лосс и тейк-профит (в пунктах) проверяются на каждой завершённой свече. При достижении уровней позиция закрывается.

## Используемые индикаторы

- Average True Range (72) — база для оценки волатильности.
- Ichimoku Kinko Hyo (9, 26, 52) — фильтр переворота облака.
- Parabolic SAR (0.005, 0.2) — единый выход и трейлинг.
- Кольцевой буфер тел свечей (20 элементов) — для сравнения с максимальным телом, как в MQL.

## Параметры

| Параметр | Описание |
|----------|----------|
| `UseSystem1` | Включает модуль ATR-прорыва. |
| `UseSystem2` | Включает модуль переворота облака Ichimoku. |
| `UseSystem3` | Включает модуль «большого тела». |
| `OrderVolume` | Объём для каждого рыночного ордера любого модуля. |
| `StopLossPips` | Размер стоп-лосса в пунктах. Ноль отключает стоп. |
| `TakeProfitPips` | Размер тейк-профита в пунктах. Ноль отключает цель. |
| `CandleType` | Таймфрейм рабочих свечей (по умолчанию 1 час). |

## Последовательность работы

1. Подписаться на выбранный поток свечей и обрабатывать только завершённые свечи.
2. Обновить ATR, Ichimoku, Parabolic SAR и буфер тел свечей.
3. Закрыть позиции, которые попали под стоп, тейк или разворот SAR.
4. Если торговля разрешена, оценить условия каждого модуля и отправить рыночные ордера при выполнении критериев.
5. Сохранить последние значения индикаторов, чтобы следующий бар получил те же исторические данные, что и в исходном советнике.

## Дополнительно

- Размер пункта определяется шагом цены инструмента; для пяти- и трёхзначных котировок выполняется нормализация до четырёх и двух знаков после запятой.
- Модули могут работать одновременно. Для каждого ведётся своя позиция, направление и время последнего сигнала, что соответствует разным `MagicNumber` в оригинале.
- Логика «не более одного входа на бар» реализована через сравнение времени открытия свечи с последней сделкой.
