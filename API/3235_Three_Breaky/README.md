# Three Breaky Strategy

The **Three Breaky Strategy** is a full conversion of the MetaTrader 4 expert advisor `ThreeBreaky_v1.mq4`. The StockSharp version keeps the original trio of breakout subsystems, translates their candle-based logic to the high-level API, and adds clear position bookkeeping for each module. The strategy works on a single configurable timeframe and can enable or disable any subsystem without affecting the others.

## Trading Modules

1. **System 1 – ATR Expansion Breakout**
   - Uses the previous candle only.
   - Goes long when the previous candle is bullish and its high–low range exceeds four times the 72-period average true range.
   - Goes short when the previous candle is bearish and the same range condition is satisfied.

2. **System 2 – Ichimoku Cloud Flip**
   - Observes the cloud boundaries (Senkou Span A and Senkou Span B) with default periods 9/26/52.
   - A long signal triggers when two candles ago closed below both spans and the latest closed above both spans (a bullish flip through the cloud).
   - A short signal triggers when two candles ago closed above both spans and the latest closed below both spans.

3. **System 3 – Exceptional Body Breakout**
   - Tracks the body size of the previous 20 completed candles.
   - A long setup requires the previous candle to be bullish and its body to be more than three times the maximum body observed in that 20-candle history.
   - A short setup mirrors the condition for bearish bodies.

Every subsystem trades a dedicated virtual position. Order timestamps are stored to ensure a module can open at most one trade per candle, just like the original `buyTag` and `sellTag` logic.

## Exit Logic

- **Parabolic SAR Reversal**: All open positions share a Parabolic SAR (0.005/0.2) exit. When price crosses the SAR between the previous two candles, the affected position is closed.
- **Risk Management**: Optional stop-loss and take-profit distances (in pips) are evaluated on each completed candle. If the configured thresholds are breached, the relevant position is closed immediately.

## Indicators Used

- Average True Range (period 72) for the average volatility baseline.
- Ichimoku Kinko Hyo (9, 26, 52) for the cloud flip filter.
- Parabolic SAR (0.005 acceleration, 0.2 maximum) for exits and trailing logic.
- Rolling body-size buffer (20 candles) to reproduce the MQL maximum body comparison.

## Parameters

| Parameter | Description |
|-----------|-------------|
| `UseSystem1` | Enables the ATR expansion breakout module. |
| `UseSystem2` | Enables the Ichimoku cloud flip module. |
| `UseSystem3` | Enables the large body breakout module. |
| `OrderVolume` | Volume used for every market order generated by any module. |
| `StopLossPips` | Protective stop distance in pips. Set to zero to disable. |
| `TakeProfitPips` | Take-profit distance in pips. Set to zero to disable. |
| `CandleType` | Timeframe for the working candles (defaults to 1 hour). |

## Workflow Summary

1. Subscribe to the configured candle series and process only finished candles.
2. Update the ATR, Ichimoku, and Parabolic SAR indicators together with the rolling body history.
3. Close positions that hit stops, targets, or Parabolic SAR reversals.
4. If trading is allowed, evaluate every subsystem independently and issue market orders when all the respective conditions are met.
5. Store the latest indicator outputs so that the next candle can access the same historical values as in the original MQL implementation.

## Notes

- The strategy assumes a pip value based on the security price step; five-digit and three-digit FX quotes are normalized to four and two decimal pip sizes respectively.
- Subsystems can run simultaneously. Each keeps its own entry price, position direction, and last signal timestamps to mirror the `MagicNumber+N` separation from the source EA.
- The StockSharp implementation retains the "once per bar" execution pattern by using candle open times to block duplicate orders within a single bar.
