# Стратегия Tipu EA с мультифреймовым анализом

## Общее описание
Стратегия переносит идею советника Tipu в среду StockSharp. Поскольку оригинальные индикаторы Tipu Trend и Tipu Stops недоступны, их функции воспроизводятся с помощью экспоненциальных скользящих средних (EMA), индекса направленного движения (ADX) и среднего истинного диапазона (ATR). Высокий таймфрейм (по умолчанию 1 час) задаёт торговый контекст и фильтрует флэт, а рабочий таймфрейм (по умолчанию 15 минут) формирует точки входа. Управление позицией включает перенос стопа в безубыток с пирамидингом, трейлинг-стоп и опциональный фиксированный тейк-профит.

Стратегия рассчитана на инструменты с хорошей ликвидностью и выраженными трендовыми фазами. Совпадение трендов на двух таймфреймах уменьшает количество ложных сигналов, а блок управления рисками повторяет логику оригинального советника.

## Подписка на данные
- Свечи старшего таймфрейма (1 час) для расчёта EMA и фильтра ADX.
- Свечи рабочего таймфрейма (15 минут) для сигналов входа, расчёта ATR и последующего сопровождения позиции.

## Логика работы
1. **Контекст старшего таймфрейма**
   - Отслеживаются пересечения быстрой и медленной EMA. Пересечение вверх задаёт бычий контекст, пересечение вниз — медвежий.
   - ADX используется для оценки силы тренда. Если значение ниже порога, новые сделки запрещены как во флэте.
   - Запоминается время последнего сигнала со старшего таймфрейма. Сигнал действителен ограниченное число минут.
2. **Входы на рабочем таймфрейме**
   - Необходима синхронизация: пересечение EMA на рабочем таймфрейме и свежий сигнал старшего таймфрейма в том же направлении при отсутствии режима «флэт».
   - Перед открытием сделки стратегия может закрыть противоположную позицию (опция `CloseOnReverseSignal`) и учитывает флаг `AllowHedging`.
   - Стоп-лосс выставляется на расстоянии `ATR * AtrMultiplier`, но не больше `MaxRiskPips`. Если риск превышает лимит, вход пропускается.
3. **Управление риском**
   - **Тейк-профит**: фиксированная цель на расстоянии `TakeProfitPips` (если включено).
   - **Трейлинг-стоп**: при достижении прибыли `TrailingStartPips` стоп подтягивается с отступом `TrailingCushionPips`.
   - **Безубыточный пирамидинг**: при росте прибыли на `RiskFreeStepPips` стоп переносится в безубыток, после чего позиция наращивается шагами `PyramidIncrementVolume` до потолка `PyramidMaxVolume`. Каждое добавление сопровождается подтяжкой стопа.
   - При включённой опции `CloseOnReverseSignal` позиция немедленно закрывается по противоположному сигналу.

## Параметры
- `AllowHedging` – разрешать ли держать разнонаправленные позиции.
- `CloseOnReverseSignal` – закрывать ли позицию при появлении обратного сигнала.
- `EnableTakeProfit`, `TakeProfitPips` – включение и величина фиксированного тейк-профита (в пунктах).
- `MaxRiskPips` – максимальная допустимая дистанция до стопа при входе.
- `TradeVolume` – базовый объём первой сделки.
- `EnableRiskFreePyramiding`, `RiskFreeStepPips`, `PyramidIncrementVolume`, `PyramidMaxVolume` – настройки блока безубыточного пирамидинга.
- `EnableTrailingStop`, `TrailingStartPips`, `TrailingCushionPips` – параметры трейлинг-стопа.
- `HigherFastLength`, `HigherSlowLength`, `LowerFastLength`, `LowerSlowLength` – периоды EMA на обоих таймфреймах.
- `AdxLength`, `AdxThreshold` – параметры ADX для фильтрации флэта.
- `AtrLength`, `AtrMultiplier` – параметры ATR, применяемого для первоначального стопа.
- `HigherSignalWindowMinutes` – время жизни сигнала старшего таймфрейма (в минутах).
- `HigherCandleType`, `LowerCandleType` – используемые таймфреймы свечей.

## Особенности реализации
- Средняя цена входа пересчитывается после каждого увеличения позиции, поэтому трейлинг и перенос в безубыток опираются на фактическую себестоимость.
- Обработка сигналов ведётся только по закрытым свечам, что исключает шум от незавершённых баров.
- Стратегия работает исключительно рыночными ордерами `BuyMarket`/`SellMarket`; управление стопами и пирамидинг выполняются внутри алгоритма.
- Из-за отсутствия оригинальных индикаторов применяется приближённая схема EMA + ADX + ATR, сохраняя ключевые принципы Tipu EA (разворот по сигналу, перенос стопа в безубыток и ступенчатое наращивание позиции).

## Рекомендации по использованию
- Настройте периоды EMA, множитель ATR и порог ADX под конкретный инструмент; стандартные значения подходят для стартового тестирования валютных пар.
- Значение `HigherSignalWindowMinutes` выбирайте вблизи длительности старшего таймфрейма для строгой синхронизации либо увеличивайте, если допустима задержка между сигналами.
- Даже без пирамидинга блок безубытка перемещает стоп на цену входа после достижения `RiskFreeStepPips`, обеспечивая базовую защиту капитала.
- При желании удерживать позицию до срабатывания стопа отключите `CloseOnReverseSignal`, оставив управление выходом трейлинг-стопу.
