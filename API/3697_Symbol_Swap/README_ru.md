# Стратегия Symbol Swap

**Symbol Swap Strategy** — это порт утилиты MetaTrader 5 «Symbol Swap». Оригинальный MQL5-скрипт открывает панель, где трейдер вводит тикер, мгновенно переключает график на выбранный инструмент и получает компактное окно данных с текущим временем, ценами OHLC, тиковым объёмом и спредом. Переписанная на C# версия сохраняет те же обязанности и использует только высокоуровневый API StockSharp.

## Логика работы

1. При запуске стратегия определяет инструмент для наблюдения. Сначала используется `WatchedSecurityId`, а если поле пустое — берётся `Strategy.Security`, настроенный в терминале.
2. Свечные данные выбранного `CandleType` поступают через `SubscribeCandles(...)`. После закрытия бара методу передаются значения Open, High, Low, Close и тиковый объём, которыми заполняется панель.
3. Котировки best bid/ask обновляются в реальном времени через `SubscribeLevel1(...)`. На каждом изменении рассчитывается спред, полностью повторяя поведение окна данных MetaTrader.
4. Сформированный блок выводится либо в лог стратегии (`OutputMode = Log`), либо на график (`OutputMode = Chart`) посредством `DrawText(...)`, что визуально воспроизводит плавающую панель из MQL.
5. Вызов `SwapSecurity("TICKER")` во время работы находит новый инструмент через `SecurityProvider.LookupById` и без паузы пересоздаёт свечную и Level 1 подписки под выбранный символ.

Стратегия носит информационный характер и не выставляет ордера. Её можно использовать как самостоятельную панель мониторинга или запускать вместе с другими роботами.

## Параметры

| Имя | Описание | Значение по умолчанию |
|-----|----------|-----------------------|
| `CandleType` | Таймфрейм свечей, которые формируют значения OHLC и тиковый объём. | `TimeFrame(1 minute)` |
| `WatchedSecurityId` | Необязательный идентификатор инструмента. Оставьте пустым, чтобы использовать `Strategy.Security`. | _пусто_ |
| `OutputMode` | Куда выводится информационный блок: `Chart` (над графиком) или `Log` (в лог стратегии). | `Chart` |

## Публичные методы

| Метод | Назначение |
|-------|-----------|
| `SwapSecurity(string securityId)` | Ищет тикер через активный `SecurityProvider` и сразу переключает панель на новый инструмент. При каждом вызове прежние подписки удаляются и создаются заново для нового символа. |

## Практические рекомендации

- Убедитесь, что коннектор предоставляет указанный идентификатор. Иначе `SecurityProvider.LookupById` выбросит исключение.
- При `OutputMode = Chart` стратегия автоматически создаёт область графика, рисует свечи выбранного таймфрейма и накладывает текстовый блок. В режиме `Log` обновления выводятся только текстом.
- Тиковый объём соответствует полю `TotalVolume` свечи — именно так MetaTrader считает количество тиков в баре.
- Спред отображается только при наличии обоих значений best bid и best ask, иначе выводится `n/a`.

## Особенности конверсии

- Таймер из MQL заменён на подписки StockSharp. Свечи дают события по закрытии бара, а Level 1 — при каждом изменении котировки.
- Девять MQL-ярлыков собраны в один многострочный текст с исходным порядком: Time, Period, Symbol, Close, Open, High, Low, Tick Volume, Spread.
- Больше не требуется вручную добавлять тикер в Market Watch — стратегия использует `SecurityProvider` для поиска инструментов.
- Применяются только высокоуровневые вызовы (`SubscribeCandles`, `SubscribeLevel1`, `DrawText`, `AddInfo`), что полностью удовлетворяет правилам репозитория.

