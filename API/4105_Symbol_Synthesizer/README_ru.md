# Стратегия Symbol Synthesizer

## Описание

**Symbol Synthesizer Strategy** — это перенос советника MetaTrader 5 *SymbolSynthesizer.mq5* на C#. Первоначальный скрипт отображал панель с 13 заранее заданными валютными комбинациями, рассчитывал виртуальные котировки кросса и по нажатию кнопок выставлял две хеджирующие заявки. Реализация на StockSharp сохраняет ключевой функционал:

* Подписка на Level1 для двух ног и непрерывный пересчёт синтетического бид/аск.
* Полный набор из 13 комбинаций, идентичных массиву `Sym` в MQL5.
* Синхронная отправка двух заявок при ручном запросе на покупку или продажу синтетического инструмента.
* Пересчёт объёма второй ноги по исходной формуле MetaTrader, чтобы суммарная номинальная позиция оставалась согласованной.

Стратегия специально оставлена ручной. Она ждёт обновлений цен и реагирует только тогда, когда параметр `TradeAction` принимает значения `Buy` или `Sell`, что соответствует кнопкам оригинальной панели.

## Предустановленные комбинации

Таблица ниже копирует содержимое массива `Sym`. Индекс `0` соответствует символу графика в MQL5 и используется по умолчанию в параметре `CombinationIndex`.

| Индекс | Синтетический символ | Первая нога | Вторая нога | Тип построения |
|--------|----------------------|-------------|-------------|----------------|
| 0 | EURUSD | EURGBP | GBPUSD | Произведение (обе заявки в одну сторону) |
| 1 | GBPUSD | EURGBP | EURUSD | Частное (первая нога в противоположную сторону) |
| 2 | USDCHF | EURUSD | EURCHF | Частное |
| 3 | USDJPY | EURUSD | EURJPY | Частное |
| 4 | USDCAD | EURUSD | EURCAD | Частное |
| 5 | AUDUSD | EURAUD | EURUSD | Частное |
| 6 | EURGBP | GBPUSD | EURUSD | Частное |
| 7 | EURAUD | AUDUSD | EURUSD | Частное |
| 8 | EURCHF | EURUSD | USDCHF | Произведение |
| 9 | EURJPY | EURUSD | USDJPY | Произведение |
| 10 | GBPJPY | GBPUSD | USDJPY | Произведение |
| 11 | AUDJPY | AUDUSD | USDJPY | Произведение |
| 12 | GBPCHF | GBPUSD | USDCHF | Произведение |

Для комбинаций «произведение» обе ноги торгуются в одинаковом направлении. Для комбинаций «частное» первая нога выставляется противоположно второй.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CombinationIndex` | Индекс предустановленной комбинации (0–12). Выбор фиксируется на этапе запуска; для смены комбинации требуется перезапуск. |
| `OrderVolume` | Исходный объём первой ноги. Значение нормализуется с учётом шага объёма и минимального объёма инструмента. |
| `Slippage` | Допустимое отклонение в шагах цены. Лимитные заявки смещаются на `Slippage × PriceStep`, что имитирует параметр отклонения в MetaTrader. |
| `TradeAction` | Ручной триггер (`None`, `Buy`, `Sell`). Установите `Buy` или `Sell`, чтобы сгенерировать пару заявок; после выполнения или ошибки значение автоматически возвращается к `None`. |

## Получение данных

Стратегия подписывается на Level1 по каждой ноге из выбранной комбинации и рассчитывает виртуальные цены по формулам:

* Произведение: `vBid = bid1 × bid2`, `vAsk = ask1 × ask2`.
* Частное: `vBid = bid2 / bid1`, `vAsk = ask2 / ask1`.

Каждое обновление синтетических котировок записывается в журнал, чтобы оператор видел актуальную цену виртуального инструмента.

## Логика выставления заявок

1. Объём первой ноги равен нормализованному значению `OrderVolume`.
2. Объём второй ноги рассчитывается по формуле из MQL5:
   
   `vol2 = vol1 × syntheticPrice ÷ tickValue1 ÷ tickValue2 × (point2 ÷ point1)`,
   
   где `tickValue` — это `Security.StepPrice`, а `point` — `Security.PriceStep`.
3. Направления повторяют логику оригинала:
   * **Произведение:** обе заявки выставляются в сторону, запрошенную параметром.
   * **Частное:** первая нога идёт против направления, вторая — по направлению.
4. Цены берутся из последнего бида/аска соответствующей ноги. Перед отправкой лимитные заявки сдвигаются на величину `Slippage` и проходят нормализацию через `Security.ShrinkPrice`.

При отсутствии необходимых метаданных инструмента (шаг цены, стоимость шага, шаг объёма) стратегия записывает ошибку и не выставляет заявки, что соответствует защитному поведению MetaTrader-версии.

## Рекомендации по использованию

* Перед запуском укажите основную `Security` и `Portfolio`. Дополнительные бумаги для ног подбираются автоматически через поиск символов StockSharp.
* Провайдер данных должен возвращать корректные `PriceStep`, `StepPrice` и `VolumeStep`, иначе пересчёт объёмов будет невозможен.
* Стратегия предназначена для ручной работы, поэтому дополнительная автоматическая логика не добавлялась.
* Чтобы перейти к другой комбинации, остановите стратегию, измените `CombinationIndex` и запустите снова.
