# Trade Protector

## Обзор
Trade Protector — порт советника MetaTrader 4 `trade_protector-1_2` для StockSharp. Стратегия не открывает сделки самостоятельно: она круглосуточно наблюдает за текущей позицией и динамически перестраивает защитные уровни. Для новых позиций задаётся начальный стоп‑лосс, затем включается фиксированный трейлинг, а при достижении заданной прибыли стоп переходит в пропорциональный режим и удерживает часть плавающего дохода. Дополнительный модуль «эвакуации» способен выставить тейк‑профит после глубокой просадки, чтобы закрыть сделку на следующем откате.

Реализация использует поток Level-1 (лучшая цена покупки/продажи), что позволяет воспроизвести тиковую логику оригинального советника. Защитные заявки моделируются локально: когда достигается стоп или эвакуационный тейк‑профит, стратегия закрывает позицию рыночным ордером.

## Логика стратегии
### Базовое сопровождение
* **Начальный стоп** — при переходе из нулевой позиции в лонг или шорт выставляется стоп на заданное количество пунктов. Если стоп уже присутствует, он берётся как исходный уровень.
* **Трейлинг до активации** — пока плавающая прибыль не достигла порога, стоп сопровождает цену на фиксированном расстоянии `TrailingStopPips` и никогда не отходит назад.

### Пропорциональный трейлинг
* После превышения `ProportionalActivationPips` стоп удерживает долю прибыли, заданную `ProportionalRatio`. Например, значение `0.35` фиксирует 35% текущего заработка, позволяя остальной части колебаться.
* Из расчёта вычитается (для лонгов) или прибавляется (для шортов) текущий спред между лучшим бидом и аском, чтобы избежать завышенных ожиданий.

### Модуль эвакуации
* При включении отслеживается глубина неблагоприятного движения относительно цены входа.
* Для лонга, если бид опускается ниже `EntryPrice - EscapeTriggerPips - 5 минимальных шагов`, активируется тейк‑профит `EntryPrice + EscapeTakeProfitPips`. Для шорта правило зеркальное.
* Тейк‑профит может находиться как выше, так и ниже цены входа; отрицательные значения позволяют закрывать позицию с контролируемым убытком.
* После срабатывания цель сбрасывается, а при возвращении позиции к нулю модуль автоматически разоружается.

### Исполнение выходов
* Лонговый стоп срабатывает, когда лучший бид достигает сохранённого уровня; шортовый — когда лучший аск поднимается до целевого значения.
* Эвакуационные цели для лонгов контролируют бид, для шортов — аск.
* Каждый выход отправляет рыночный ордер объёмом, равным модулю текущей позиции. Флаг `_exitInProgress` защищает от повторных заявок, пока предыдущий ордер ещё не исполнен.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `EnableLogging` | `bool` | `true` | Включает информативные лог‑сообщения при изменении стопов и эвакуационных уровней. |
| `InitialStopPips` | `decimal` | `15` | Начальное расстояние до стопа в пунктах. Значение `0` оставляет существующий стоп без изменений. |
| `TrailingStopPips` | `decimal` | `35` | Фиксированная дистанция трейлинга до включения пропорционального режима. |
| `ProportionalActivationPips` | `decimal` | `12` | Пороговая прибыль (в пунктах), после которой активируется пропорциональный стоп. `0` — немедленная активация. |
| `ProportionalRatio` | `decimal` | `0.35` | Доля прибыли, сохраняемая пропорциональным стопом (0…1 повторяет алгоритм оригинала). |
| `UseEscapeMode` | `bool` | `false` | Включает модуль эвакуации, который выставляет тейк‑профит после глубокой просадки. |
| `EscapeTriggerPips` | `decimal` | `0` | Величина неблагоприятного движения (в пунктах), необходимая для активации эвакуации. |
| `EscapeTakeProfitPips` | `decimal` | `35` | Расстояние эвакуационного тейк‑профита от цены входа; отрицательные значения допускают контролируемый убыток. |

## Особенности реализации
* Размер пункта вычисляется из шага цены инструмента. Для инструментов с тремя или пятью знаками после запятой один «пункт» равен десяти минимальным шагам, как в MetaTrader.
* Стратегия сохраняет последние цены исполнения для каждой стороны и обновляет среднюю цену входа при появлении `PositionPrice`, что корректно обрабатывает частичные закрытия.
* Для работы требуется поток Level-1; без обновлений bid/ask трейлинг и эвакуация не запустятся.
* Доступна только версия на C#. Python-реализация отсутствует и отдельная папка не создаётся.

## Отличия от оригинального советника
* Защитные уровни реализованы локально: вместо модификации серверных стопов стратегия отправляет рыночные заявки при достижении ценовых барьеров.
* Информация о спреде берётся из текущих котировок Level-1; если площадка публикует только сделки, пропорциональный стоп использует сохранённый бид без поправки на спред.
* Модуль эвакуации автоматически сбрасывается после закрытия позиции и не требует глобальных переменных, применявшихся в MQL-версии.
* Логирование выполняется средствами StockSharp и отображается в журналах стратегии, а не в файлах CSV.
