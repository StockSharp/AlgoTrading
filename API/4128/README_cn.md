# Trade Protector

## 概述
Trade Protector 是 MetaTrader 4 智能交易系统 `trade_protector-1_2` 的 StockSharp 版本。策略本身不会开仓，而是实时监控当前持仓并动态调整保护性价位：为新仓设置初始止损、在盈利扩大后启用固定距离的拖尾止损、当利润达到阈值时再切换到按利润比例锁定的止损。同时，逃逸模块可在深度回撤后挂出预设的止盈，帮助仓位在价格反弹时平仓。

实现依赖 Level-1 行情（最优买价/卖价），以模拟原始 EA 的逐笔行为。保护性订单在策略内部模拟：当止损或逃逸止盈被触发时，策略会用市价单立即关闭剩余仓位。

## 策略逻辑
### 基础止损管理
* **初始止损**——持仓从空仓变为多头或空头时，按照参数化的点数距离设置初始止损。如果原本已经有止损，则以现有价位为起点继续处理。
* **激活前的拖尾**——在浮动利润低于比例阈值期间，止损按 `TrailingStopPips` 指定的固定距离跟随价格，且永不回撤。

### 比例拖尾
* 当浮动利润超过 `ProportionalActivationPips`（点）后，止损按 `ProportionalRatio` 保留一定比例的盈利。例如比率 `0.35` 表示锁定 35% 的利润，其余 65% 继续随价格波动。
* 为避免过度乐观，计算比例止损时会将买卖价差在多头仓位中扣除、在空头仓位中加上。

### 逃逸模块
* 启用后，策略会跟踪相对于开仓价的最大不利波动。
* 多头仓位在买价跌破 `开仓价 - EscapeTriggerPips - 5 个最小跳动` 时会挂出逃逸止盈 `开仓价 + EscapeTakeProfitPips`；空头仓位对称处理。
* 逃逸止盈可以在开仓价上方或下方，参数允许使用负值来实现可控亏损退出。
* 一旦逃逸目标被触发，仓位立即平仓；当仓位回到空仓状态时，逃逸目标会自动重置。

### 离场执行
* 多头止损在最优买价触及目标价位时触发；空头止损在最优卖价达到目标时触发。
* 多头逃逸止盈观察最优买价，空头逃逸止盈观察最优卖价。
* 每次离场都会按仓位绝对值发送市价单，并使用保护标志在前一笔离场尚未完成时阻止重复下单。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `EnableLogging` | `bool` | `true` | 当止损或逃逸价位变化时输出详细日志。 |
| `InitialStopPips` | `decimal` | `15` | 新仓位的初始止损距离（点）。设为 `0` 可保持现有止损不变。 |
| `TrailingStopPips` | `decimal` | `35` | 启用比例止损前使用的固定拖尾距离。 |
| `ProportionalActivationPips` | `decimal` | `12` | 激活比例拖尾所需的盈利点数；设为 `0` 则立即启用比例模式。 |
| `ProportionalRatio` | `decimal` | `0.35` | 比例拖尾启用后需要保留的利润百分比，0~1 范围复现原策略行为。 |
| `UseEscapeMode` | `bool` | `false` | 是否启用逃逸模块，在深度回撤后挂出逃逸止盈。 |
| `EscapeTriggerPips` | `decimal` | `0` | 触发逃逸止盈所需的不利波动幅度（点）。 |
| `EscapeTakeProfitPips` | `decimal` | `35` | 逃逸止盈相对开仓价的距离，可为负值以接受可控亏损。 |

## 实现细节
* 点值根据品种的最小报价单位推导而来。对于三位或五位小数的外汇品种，每个“点”相当于 10 个最小跳动，与 MetaTrader 定义保持一致。
* 策略记录最近一次多头/空头成交价，并在 `PositionPrice` 可用时更新平均持仓价，以便正确处理部分成交。
* 需要订阅 Level-1 行情；若缺少最优买卖价更新，拖尾逻辑将无法运行。
* 仅提供 C# 版本，本策略没有 Python 代码或对应文件夹。

## 与原版 EA 的差异
* 保护性价位在本地模拟：策略不修改服务器上的止损/止盈，而是在价位被触及时发送市价平仓。
* 点差来自实时 Level-1 行情；若交易所只广播成交价，比例止损会回退为仅基于买价的计算。
* 仓位回到空仓后逃逸逻辑会自动复位，无需像原 EA 那样依赖全局变量。
* 日志通过 StockSharp 框架输出，可在策略日志窗口查看，而不再写入磁盘 CSV 文件。
