# NTK 07 区间交易策略

NTK 07 区间交易策略移植自 MetaTrader 的 “NTK 07” 专家顾问。该算法围绕当前价格同时挂出对称的买入和卖出止损单，并使用可配置的追踪和止盈逻辑管理持仓，目的是在短期区间的边缘或中心附近捕捉突破，同时保持严格的风险控制。

## 核心思想

- **入场触发**：在空仓状态下，策略会评估配置的历史区间。当价格位于区间边缘或接近区间中点（取决于所选交易模式）时，会按照设定的价格步长偏移同时挂出买入止损和卖出止损订单。
- **区间感知**：最近 *N* 根已完成 K 线的最高价与最低价定义交易区间。若长度为 `0`，则关闭过滤器，允许立即挂单。
- **自适应风险**：每次入场使用基础手数，若启用手数乘数，则在已有头寸的方向上追加新的止损订单。全局手数上限可防止总仓位超过限制。
- **离场管理**：一旦有订单成交，另一侧的止损挂单会被撤销。随后策略根据设置的偏移注册保护性止损和可选的止盈订单。追踪止损可以跟随前一根 K 线的高/低点、移动均线或固定距离。
- **交易时段**：仅在设定的开始和结束小时之间交易，并在周末自动停止。

## 参数

| 参数 | 说明 |
|------|------|
| **Entry Volume** | 每笔入场订单的基础手数。 |
| **Total Volume Limit** | 累计持仓上限，`0` 表示无限制。 |
| **Net Step** | 市价与入场止损单之间的价格步数。 |
| **Stop Loss** | 相对入场价的初始止损步数。 |
| **Take Profit** | 止盈距离，`0` 表示禁用止盈。 |
| **Trailing Stop** | 追踪止损所用的步数距离。 |
| **Lot Multiplier** | 持仓后加仓止损的手数乘数。 |
| **Trail High/Low** | 启用后使用上一根 K 线极值追踪止损。 |
| **Trail Moving Average** | 启用后使用移动均线追踪止损；两种追踪方式不可同时启用。 |
| **Trading Start/End Hour** | 交易时间窗口的起止小时。 |
| **Range Bars** | 计算区间的已完成 K 线数量，`0` 表示不使用区间过滤。 |
| **Trade Mode** | `EdgesOfRange` 要求价格触及区间边界；`CenterOfRange` 要求价格接近区间中点。 |
| **MA Period** | 追踪用移动均线的周期。 |
| **Candle Type** | 用于计算的 K 线聚合类型。 |

## 工作流程

1. **数据订阅**：订阅配置的 K 线，并计算移动均线以及指定区间长度内的最高价和最低价。
2. **空仓阶段**：若满足区间条件，则按设定偏移挂出买入和卖出止损单，同时检查总体手数上限。
3. **持仓管理**：当任一方向成交后，另一侧挂单会被撤销，并立即放置保护性止损与可选止盈订单。每根新 K 线都会更新追踪止损。
4. **加仓**：当手数乘数大于 `1` 且未超过总手数限制时，会在现有头寸方向上追加新的止损挂单。
5. **离场**：止损或止盈触发后会平掉头寸并撤销所有保护性订单，然后重新进入等待模式。

## 说明

- 所有距离都以价格步长计算，可适用于不同最小变动价位的品种。
- 周六和周日自动停止交易，以匹配原始 MQL 策略的行为。
- 若同时启用两种追踪方式，策略会在启动时抛出配置错误。
