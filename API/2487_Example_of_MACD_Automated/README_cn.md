# MACD 自动化策略示例

## 概述

该策略使用 StockSharp 高级 API 复刻 MetaTrader 4 的“Example of MACD Automated”专家顾问。系统同时监控两个周期上的 MACD 主线，当趋势过滤器一致时才开仓。止损和止盈以价格最小变动单位表示，仓位大小遵循原始 EA 的 AdvancedMM 资金管理，会累加最近亏损交易的手数。

## 交易逻辑

1. **高周期过滤** – 在高周期（默认：日线）计算的 MACD(12, 26, 9) 主线为正值时允许做多，为负值时允许做空。
2. **入场周期确认** – 入场周期（默认：15 分钟）上使用相同参数的 MACD 需要与高周期方向一致。
3. **单笔持仓** – 任意时刻只有一笔仓位，只有在止损或止盈平仓之后才会寻找新的入场机会。
4. **保护性订单** – 止损与止盈以价格步长的倍数表示，对应 MT4 中的 `StopLoss` 和 `TakeProfit` 输入，填 `0` 表示关闭。
5. **高级资金管理** – 资金管理模块在连续亏损时将亏损单的手数累加用于下一笔交易，在盈利之后恢复到基础手数，完全模拟 `AdvancedMM()` 函数。

## 参数

| 名称 | 说明 | 默认值 |
| ---- | ---- | ------ |
| `BaseVolume` | AdvancedMM 逻辑使用的基础下单手数。 | `0.01` |
| `StopLossPoints` | 以价格步长表示的止损距离，`0` 表示不设置。 | `50` |
| `TakeProfitPoints` | 以价格步长表示的止盈距离，`0` 表示不设置。 | `30` |
| `MacdFastLength` | 两个周期 MACD 的快线 EMA 周期。 | `12` |
| `MacdSlowLength` | MACD 的慢线 EMA 周期。 | `26` |
| `MacdSignalLength` | MACD 信号线周期。 | `9` |
| `EntryCandleType` | 入场所用的 K 线周期。 | `15 分钟` |
| `FilterCandleType` | 趋势过滤所用的高周期。 | `1 天` |

## 仓位管理

- 每次建仓都会根据标的的 `PriceStep` 重新计算止损和止盈价位。
- 当单根 K 线触及任一保护价位时，策略假设订单在该价格成交，并记录实际盈亏。
- 每次平仓后 AdvancedMM 会调整下一笔交易的手数：
  - 历史交易少于两笔 → 使用基础手数；
  - 最近一笔为亏损 → 复用该笔交易的手数；
  - 在最近一次盈利之前存在连续亏损 → 将这些亏损单的手数累加；
  - 其他情况 → 回到基础手数。

## 说明

- 转换版本保持了原策略的风格，仅依靠止损和止盈退出，不会因为 MACD 反向而强制平仓。
- 请确保标的证券提供有效的 `PriceStep` 信息，以便正确换算点差距离。
- 策略只处理已完成的 K 线，需在提供完整 K 线数据的环境中使用。
