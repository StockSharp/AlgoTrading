# Пример автоматизированной стратегии MACD

## Обзор

Стратегия переносит советник MetaTrader 4 «Example of MACD Automated» на StockSharp с использованием высокоуровневого API. MACD с параметрами 12, 26, 9 рассчитывается сразу на двух таймфреймах, и сделка открывается только тогда, когда оба фильтра указывают в одну сторону. Стоп‑лосс и тейк‑профит задаются в шагах цены, а размер позиции определяется модулем AdvancedMM, который суммирует объёмы последних убыточных сделок.

## Торговая логика

1. **Фильтр старшего таймфрейма** – MACD на старшем графике (по умолчанию дневные свечи) должен иметь положительную главную линию для покупок или отрицательную для продаж.
2. **Подтверждение рабочего таймфрейма** – MACD на рабочем таймфрейме (по умолчанию 15 минут) должен совпадать по знаку с фильтром.
3. **Одна позиция** – одновременно удерживается только одна позиция, новые входы рассматриваются после срабатывания защитных уровней.
4. **Защитные уровни** – дистанции стопа и цели измеряются в шагах цены инструмента и полностью повторяют параметры `StopLoss` и `TakeProfit` из исходного советника. Значение `0` отключает уровень.
5. **Расширенное управление капиталом** – функция AdvancedMM увеличивает объём следующей сделки после серии убытков, суммируя объёмы убыточных сделок, и возвращает базовый объём после прибыльных сделок.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `BaseVolume` | Базовый объём сделки, с которого стартует алгоритм AdvancedMM. | `0.01` |
| `StopLossPoints` | Дистанция стоп‑лосса в шагах цены, `0` — без стопа. | `50` |
| `TakeProfitPoints` | Дистанция тейк‑профита в шагах цены, `0` — без цели. | `30` |
| `MacdFastLength` | Период быстрой EMA MACD для обоих таймфреймов. | `12` |
| `MacdSlowLength` | Период медленной EMA MACD. | `26` |
| `MacdSignalLength` | Период сигнальной EMA MACD. | `9` |
| `EntryCandleType` | Таймфрейм для входа. | `15 минут` |
| `FilterCandleType` | Старший таймфрейм фильтра тренда. | `1 день` |

## Управление позицией

- После открытия позиции стоп и цель пересчитываются исходя из `PriceStep` инструмента.
- При касании цены защитного уровня внутри свечи предполагается исполнение по этому уровню, и результат фиксируется в истории сделок.
- AdvancedMM после каждой закрытой сделки обновляет объём:
  - Истории меньше двух сделок → используется базовый объём;
  - Последняя сделка убыточная → берётся её объём;
  - Перед последней прибылью были последовательные убытки → их объёмы суммируются;
  - В остальных случаях → возврат к базовому объёму.

## Примечания

- Конверсия сохраняет оригинальное поведение: позиция удерживается до срабатывания стопа или цели, без выходов при смене знака MACD.
- Важно, чтобы у инструмента был заполнен `PriceStep`, иначе расстояния защитных уровней будут рассчитаны неверно.
- Стратегия работает с завершёнными свечами и требует источника данных, предоставляющего финализированные баровые сообщения.
