# Стратегия DeMarker Gaining Position Volume

## Обзор
Эта стратегия представляет собой перенос советника MetaTrader *«DeMarker gaining position volume»* на платформу StockSharp. Она использует осциллятор DeMarker для выявления зон перекупленности и перепроданности и постепенно наращивает позицию, когда рынок удерживается в экстремальной области. Алгоритм работает только с завершёнными свечами и обрабатывает не более одного сигнала на бар.

Версия на C# сохранила ключевую торговую логику оригинального скрипта и использует высокоуровневый API StockSharp. Параметры стратегии позволяют управлять объёмом заявок, логикой переворота и режимом аккумулирования, что облегчает адаптацию под различные инструменты и таймфреймы.

## Параметры
- **DeMarker Period** – число свечей в расчёте индикатора DeMarker.
- **Upper Level** – порог осциллятора, при превышении которого открываются или наращиваются короткие позиции (по умолчанию `0.7`).
- **Lower Level** – порог осциллятора, при падении ниже которого открываются или наращиваются длинные позиции (по умолчанию `0.3`).
- **Trade Volume** – объём рыночной заявки, отправляемой при каждом сигнале.
- **Only One Position** – при включении стратегия перед открытием новой сделки закрывает текущую, чтобы не смешивать длинные и короткие позиции.
- **Reverse Signals** – меняет местами условия входа, превращая стратегию в обратную или трендовую версию.
- **Candle Type** – тип свечей (таймфрейм), на которых рассчитываются индикатор и сигналы.

## Логика торговли
1. Создаётся подписка на свечи выбранного таймфрейма и подключается индикатор DeMarker.
2. После закрытия очередной свечи текущие значения индикатора сравниваются с заданными уровнями.
3. В обычном режиме:
   - Если DeMarker ниже нижнего уровня, стратегия пытается открыть или увеличить длинную позицию.
   - Если DeMarker выше верхнего уровня, стратегия пытается открыть или увеличить короткую позицию.
4. При активном обратном режиме роли уровней меняются местами: низкие значения инициируют продажи, высокие — покупки.
5. Время бара последнего выполненного сигнала запоминается, чтобы исключить повторные входы в рамках одной свечи.

## Управление позицией
- Перед сменой направления стратегия оценивает нереализованную прибыль существующей позиции. Переворот выполняется только если текущее закрытие даёт положительный результат, что повторяет защитную логику оригинального советника.
- Внутри стратегии отслеживаются средние цены длинной и короткой позиции. При добавлении объёма средняя цена пересчитывается, чтобы корректно оценивать прибыльность выхода.
- Параметр *Only One Position* помогает при работе в режиме чистой позиции, принудительно возвращая стратегию к нулевому балансу перед новым входом.
- Метод `StartProtection()` вызывается при запуске, обеспечивая возможность аварийного закрытия позиций, если стратегия остановится при ненулевом остатке.

## Примечания
- Перенос выполнен на высокоуровневом API StockSharp: не используются собственные коллекции и прямое опросное получение значений индикаторов.
- Системы управления капиталом из MetaTrader (фиксированный лот, расчёт по риску и т.д.) заменены простым параметром `Trade Volume`. Для динамического риск-менеджмента используйте внешние инструменты.
- Рыночные заявки исполняются по цене закрытия свечи; перед запуском на реальном счёте проверьте настройки с учётом фактического исполнения и возможного проскальзывания.
