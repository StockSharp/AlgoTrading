# DeMarker 增量仓位策略

## 概述
本策略是 MetaTrader 专家顾问 *“DeMarker gaining position volume”* 的 StockSharp 版本。策略利用 DeMarker 振荡指标识别超买与超卖极值，在行情保持极端状态时逐步增加头寸。实现基于已完成的 K 线运行，每根 K 线只响应一次信号。

C# 版本保留了原始脚本的核心交易思路，并结合了 StockSharp 的高级 API。通过参数可以控制下单量、加仓方式以及是否反向交易，使策略能够适配不同市场与周期。

## 参数
- **DeMarker Period** —— DeMarker 指标的计算周期。
- **Upper Level** —— 触发做空仓位的阈值（默认 `0.7`）。
- **Lower Level** —— 触发做多仓位的阈值（默认 `0.3`）。
- **Trade Volume** —— 每次信号下达的市价单数量。
- **Only One Position** —— 启用后，在开新仓前会先平掉当前持仓，确保不会同时持有多头和空头。
- **Reverse Signals** —— 互换买卖条件，可将策略调整为顺势或逆势版本。
- **Candle Type** —— 指标与信号计算所使用的 K 线周期。

## 交易逻辑
1. 根据选定的周期订阅 K 线，并将数据绑定到 DeMarker 指标。
2. 当最新完成的 K 线收盘时，读取当前 DeMarker 数值并与设定阈值比较。
3. 正常模式下：
   - DeMarker 低于下阈值时尝试建立或加仓多头。
   - DeMarker 高于上阈值时尝试建立或加仓空头。
4. 开启反向模式后，阈值含义互换（极低值触发做空，极高值触发做多）。
5. 策略会记录最近一笔成交所属 K 线，避免同一根 K 线重复入场。

## 仓位管理
- 在反向开仓前，会根据当前 K 线价格计算既有头寸的浮动盈亏。只有当离场能够获得正收益时才会平掉旧仓，以模拟原始 EA 的保护机制。
- 策略内部跟踪多头与空头的平均成本价。追加仓位时会重新计算平均价格，以便准确判断盈利情况。
- 可选的 *Only One Position* 参数适用于净头寸模式，确保每次入场前都回到空仓状态。
- 启动时调用 `StartProtection()`，在策略被停止但仍有持仓时提供紧急平仓能力。

## 注意事项
- 本移植版本完全基于 StockSharp 高级 API，不使用自定义数据集合，也不会直接轮询指标值。
- MetaTrader 版本中的资金管理（固定保证金、按百分比风控等）被简化为恒定的 `Trade Volume` 参数。若需要动态风控，请在策略外部处理。
- 市价单默认按 K 线收盘价模拟成交，实际运行时应根据经纪商执行质量和滑点情况进行验证与调整。
