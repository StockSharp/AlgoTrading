# USD/CHF CCI 通道挂单策略

## 策略简介

**USD/CHF CCI 通道挂单策略** 将 MetaTrader 4 智能交易系统 `UsdChf_new` 迁移到 StockSharp 的高层策略框架。策略在 H4 周期的收盘价上计算商品通道指数（CCI），当指标突破设定的通道边界时，自动在价格上方或下方挂出买入/卖出止损单。成交后会按照原版 EA 的点值风险管理规则执行固定止损、挂单失效撤销、保本移动以及追踪止损。

整套逻辑完全使用 StockSharp 的高层 API：烛线订阅、指标绑定以及 `BuyStop` / `SellStop` / `BuyMarket` / `SellMarket` 等委托方法，同时保留以“点”为单位的配置方式，便于外汇交易者上手。

## 交易流程

1. **指标与信号**
   - 在每根已完成的 H4 蜡烛上计算 CCI 值。
   - 监控 `+CCI 通道` 与 `-CCI 通道` 两条阈值线。
   - 当前值相对前一根蜡烛发生穿越时触发信号：
     - 向上穿越 `-CCI 通道` → 在价格上方挂出买入止损单。
     - 向下穿越 `+CCI 通道` → 在价格下方挂出卖出止损单。
2. **挂单管理**
   - 止损单价格在蜡烛收盘价基础上偏移 `Entry Indent (pips)` 点，并按照合约最小报价单位取整。
   - 同一时间只允许一个方向的挂单，新挂单会自动撤销另一方向。
   - 市场价格反向移动超过 `Cancel Distance (pips)` 时撤销挂单，防止追价。
3. **持仓管理**
   - 成交后按原始点差设置初始止损。
   - 盈利达到 `Break Even (pips)` 时将保护止损移动到开仓价。
   - 盈利超过 `Trailing Stop (pips)` 时启用追踪止损，保持固定点差跟随价格。
   - 当 CCI 穿越相反方向的阈值时，直接市价平仓并重新挂出反向止损单。

## 参数说明

| 参数 | 说明 | 默认值 | 可优化 |
|------|------|--------|--------|
| `CandleType` | 指标与信号使用的蜡烛类型（默认 H4）。 | 4 小时时间框 | 否 |
| `CciPeriod` | CCI 平滑周期。 | 73 | 是 |
| `CciChannel` | CCI 通道的绝对阈值。 | 120 | 是 |
| `EntryIndentPips` | 挂单相对市场价格的点值偏移。 | 30 | 是 |
| `StopLossPips` | 初始止损点差。 | 95 | 是 |
| `CancelDistancePips` | 市场偏离多少点后撤销挂单。 | 30 | 是 |
| `TrailingStopPips` | 追踪止损距离。 | 110 | 是 |
| `BreakEvenPips` | 保本触发所需盈利。 | 60 | 是 |

点值通过合约的 `PriceStep` 和 `Decimals` 自动换算为真实价格：若品种保留 3/5 位小数，则 1 个点等于 10 个最小价位；否则等于 1 个最小价位。

## 使用建议

1. 选择 USD/CHF 或其他支持点值管理的外汇品种。
2. 通过基础属性 `Strategy.Volume` 设置交易手数。
3. 根据经纪商合约规格调整各项点值参数。
4. 在 Designer/Tester 中回测验证后再投入真实或仿真交易。

## 转换细节

- 原版 EA 循环遍历 MetaTrader 的全部订单队列，StockSharp 版本改为存储当前挂单引用并按需取消。
- 止损、保本与追踪通过直接市价平仓实现，避免在高层 API 中修改经纪商持有的保护单。
- 代码注释统一改写为英文，并补充 StockSharp 特定的实现说明。
