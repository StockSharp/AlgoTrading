# Стратегия USD/CHF CCI Channel Stop

## Общее описание

**USD/CHF CCI Channel Stop** — перенос советника MetaTrader 4 `UsdChf_new` на высокоуровневый API StockSharp. Стратегия анализирует готовые H4-свечи, вычисляет показатель Commodity Channel Index (CCI) и при пробое каналов `±CCI Channel` выставляет отложенные стоп-ордера над/под ценой. После активации позиция сопровождается теми же правилами управления риском, что и в оригинале: фиксированный стоп-лосс, удаление устаревших заявок, перевод в безубыток и трал.

Вся логика реализована через высокоуровневые механизмы StockSharp — подписку на свечи, привязку индикаторов и вспомогательные методы регистрации ордеров (`BuyStop`, `SellStop`, `BuyMarket`, `SellMarket`). Настройки по-прежнему задаются в пунктах, что удобно для форекс-трейдеров.

## Логика торговли

1. **Сигналы по CCI**
   - На каждой завершённой H4-свече рассчитывается CCI с заданным периодом.
   - Хранится предыдущее значение, что позволяет отслеживать факт пересечения уровней.
   - Пересечение снизу вверх уровня `-CCI Channel` → подготовка buy stop выше цены.
   - Пересечение сверху вниз уровня `+CCI Channel` → подготовка sell stop ниже цены.
2. **Управление отложенными ордерами**
   - Цена размещения сдвигается на `Entry Indent (pips)` и округляется по шагу цены инструмента.
   - Одновременно может быть активен только один стоп-ордер — новый сигнал отменяет противоположный.
   - Если рынок ушёл дальше чем на `Cancel Distance (pips)`, заявка отменяется, чтобы не догонять цену.
3. **Сопровождение позиции**
   - После исполнения стоп-ордера фиксируется стартовый стоп-лосс.
   - При прибыли больше `Break Even (pips)` защитный стоп переносится на цену входа.
   - Как только прибыль превысит `Trailing Stop (pips)`, стоп подтягивается вслед за ценой, сохраняя указанную дистанцию.
   - Обратное пересечение CCI закрывает позицию по рынку и ставит новую отложенную заявку в противоположном направлении.

## Параметры

| Параметр | Назначение | Значение по умолчанию | Оптимизация |
|----------|------------|-----------------------|-------------|
| `CandleType` | Тип свечей для сигналов (по умолчанию H4). | 4 часа | Нет |
| `CciPeriod` | Период усреднения CCI. | 73 | Да |
| `CciChannel` | Абсолютная граница канала CCI. | 120 | Да |
| `EntryIndentPips` | Смещение стоп-ордера от рынка в пунктах. | 30 | Да |
| `StopLossPips` | Размер первоначального стоп-лосса. | 95 | Да |
| `CancelDistancePips` | Допустимое удаление цены до отмены заявки. | 30 | Да |
| `TrailingStopPips` | Дистанция трейлинг-стопа. | 110 | Да |
| `BreakEvenPips` | Прибыль для перевода в безубыток. | 60 | Да |

Пересчёт пунктов в цену выполняется автоматически: для инструментов с 3/5 знаками после запятой 1 пункт = 10 шагам цены, иначе 1 пункт = 1 шагу.

## Рекомендации по применению

1. Подключите стратегию к инструменту USD/CHF или другому форекс-активу с пунктовой котировкой.
2. Настройте объём через стандартное свойство `Strategy.Volume`.
3. Скорректируйте пунктовые параметры под спецификацию брокера.
4. Перед реальной торговлей выполните бэктест в Designer/Tester для проверки поведения.

## Особенности конверсии

- В MT4 советник перебирал все ордера через `OrdersTotal`. В StockSharp используются ссылки на конкретные pending-заявки и методы отмены.
- Стоп-лосс, безубыток и трал реализованы через рыночные выходы, так как высокоуровневый API не модифицирует брокерские ордера напрямую.
- Все комментарии переписаны на английский и дополнены пояснениями по работе со StockSharp.
