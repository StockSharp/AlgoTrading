# Стратегия MACD Divergence RSI

## Обзор
- Порт советника MetaTrader **«Macd diver rsi mt4»** на высокоуровневый API StockSharp.
- Использует фильтры RSI и поиск дивергенций MACD для работы с разворотами на одном инструменте.
- В рынке может находиться только одна позиция; новые сигналы рассматриваются только при нулевой позиции.

## Логика сигналов
1. Каждая закрывшаяся свеча выбранного таймфрейма обновляет четыре связанных индикатора:
   - Два независимых `RelativeStrengthIndex` для зон перепроданности и перекупленности, значения берутся с предыдущей свечи.
   - Два `MovingAverageConvergenceDivergence` с настраиваемыми периодами EMA и сигнальной линии.
2. **Условия для покупки**
   - RSI предыдущей свечи должен быть ниже заданного порога перепроданности.
   - Последовательность значений MACD должна сформировать локальную впадину ниже динамического порога (эквивалент трёх пунктов
     для текущего инструмента).
   - История MACD и цен просматривается в поисках предыдущей впадины и соответствующего ценового минимума. Дивергенция
     подтверждается, когда MACD растёт, а цена обновляет минимум (обычная дивергенция), либо MACD снижается, а цена формирует
     более высокий минимум (скрытая дивергенция), что полностью повторяет алгоритм MQL.
   - При выполнении условий и отсутствии открытой позиции отправляется рыночная покупка с отдельными параметрами объёма и
     риск-менеджмента для лонга.
3. **Условия для продажи** зеркальны: используется порог перекупленности RSI и поиск пиков MACD, сравниваются предыдущие и
   текущий ценовые максимумы.
4. После входа расстояния стоп-лосса и тейк-профита, заданные в пунктах, переводятся в абсолютную цену (с учётом правил point
   format) и передаются в `SetStopLoss` / `SetTakeProfit`.

## Параметры
- `LowerRsiPeriod`, `LowerRsiThreshold` → `inp1_Lo_RSIperiod` / `inp1_Ro_Value`.
- `BullishFastEma`, `BullishSlowEma`, `BullishSignalSma` → `inp2_fastEMA` / `inp2_slowEMA` / `inp2_signalSMA`.
- `BullishVolume`, `BullishStopLossPips`, `BullishTakeProfitPips` → `inp3_VolumeSize` / `inp3_StopLossPips` / `inp3_TakeProfitPips`.
- `UpperRsiPeriod`, `UpperRsiThreshold` → `inp4_Lo_RSIperiod` / `inp4_Ro_Value`.
- `BearishFastEma`, `BearishSlowEma`, `BearishSignalSma` → `inp5_fastEMA` / `inp5_slowEMA` / `inp5_signalSMA`.
- `BearishVolume`, `BearishStopLossPips`, `BearishTakeProfitPips` → `inp6_VolumeSize` / `inp6_StopLossPips` / `inp6_TakeProfitPips`.
- `CandleType` – таймфрейм, на основе которого выполняются все расчёты.

## Особенности реализации
- Порог дивергенции MACD рассчитывается по текущему шагу цены и равен трём пунктам, что соответствует значению 0.0003 в исходном
  MQL.
- История свечей, MACD и цен хранится в списках ограниченной длины (до 600 элементов), что позволяет повторить окна поиска
  дивергенций без лишних выделений памяти.
- Подписка `SubscribeCandles(...).Bind(...)` обновляет все индикаторы в одном обработчике, стратегия работает только с
  завершёнными свечами — аналогично блоку Once per bar в оригинале.
- Расстояния стоп-лосса и тейк-профита переводятся из пунктов в цену перед вызовами `SetStopLoss` и `SetTakeProfit`, тем самым
  соблюдаются правила форматирования шага цены из исходного кода MQL.
