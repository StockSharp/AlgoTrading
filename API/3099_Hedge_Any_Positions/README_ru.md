# Стратегия Hedge Any Positions

## Обзор
**Hedge Any Positions Strategy** — это портированная на StockSharp версия советника *Hedge any positions (barabashkakvn's edition)* для MQL5. Логика осталась прежней: каждая открытая позицийная «нога», созданная стратегией, контролируется, и при неблагоприятном движении цены на заданное число пунктов автоматически открывается противоположная сделка увеличенного объёма. Реализация целиком опирается на высокоуровневый API StockSharp, поэтому для хеджирования используются рыночные ордера, а состояние позиций хранится во внутренних структурах без дополнительного инфраструктурного кода.

Стратегия может по желанию открыть стартовую сделку сразу после запуска. Далее она реагирует только на рост плавающего убытка и выстраивает цепочку хеджирующих сделок, помечая каждую «ногу» как захеджированную, чтобы она не инициировала несколько противоположных входов подряд.

## Алгоритм хеджирования
1. **Ленточные данные** — стратегию ведёт выбранный тип свечей `CandleType`. Обрабатываются только полностью сформированные свечи.
2. **Расчёт убытка** — на закрытии каждой свечи проверяется, превысило ли снижение (или рост для короткой позиции) цену входа хотя бы на `LosingPips`, умноженные на рассчитанный размер пункта.
3. **Открытие хеджа** — если обнаружена убыточная нога, отправляется рыночный ордер в противоположном направлении. Объём ордера равен объёму исходной ноги, умноженному на `LotCoefficient`, округляется по шагу объёма инструмента и ограничивается допустимыми минимумом и максимумом.
4. **Обновление состояния** — после отправки противоположного ордера исходная нога помечается как захеджированная, а новая сделка добавляется в список и может быть застрахована позднее, если рынок вновь развернётся.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `CandleType` | Таймфрейм, по которому оценивается движение цены и срабатывает хеджирование. | Свечи 1 минуты |
| `LosingPips` | Количество пунктов против позиции, после которого открывается хедж. | 5 |
| `LotCoefficient` | Множитель объёма исходной ноги при отправке хеджирующего ордера. | 2.0 |
| `AutoPlaceInitialTrade` | При включении автоматически создаёт первую сделку при старте стратегии. | Выключено |
| `InitialVolume` | Объём первоначального ордера при автоматическом старте (округляется по шагу объёма). | 0.10 |
| `InitialDirection` | Направление (покупка или продажа) для стартовой сделки. | Покупка |

> **Важно:** установите свойство `Strategy.Volume` в значение базового объёма. Остальные параметры управляют только логикой хеджирования.

## Рекомендации по использованию
1. Перед запуском назначьте стратегии `Security`, `Portfolio` и нужный базовый `Volume`.
2. Подберите `LosingPips` и `LotCoefficient` под волатильность выбранного инструмента и ваш риск-профиль.
3. Включите `AutoPlaceInitialTrade`, если нужно, чтобы первая позиция открывалась автоматически; иначе откройте её вручную или другой стратегией.
4. Поскольку высокоуровневый API StockSharp работает с нетто-позициями, внутренняя структура стратегии эмулирует отдельные «ноги». При торговле на неттинговых счетах контролируйте совокупное плечо и маржу.
5. Отслеживайте отчёты об исполнении — каждое хеджирование выполняется рыночным ордером (`BuyMarket` или `SellMarket`).

## Отличия от оригинального советника
- Проверки маржи, контроль проскальзывания и подробный вывод результатов убраны: StockSharp сам сообщает об ошибках через события стратегии.
- Вместо тиковых данных используется логика на закрытии свечей. При необходимости быстрого реагирования выберите меньший таймфрейм.
- Округление объёма основано на `Security.VolumeStep`, `Security.MinVolume` и `Security.MaxVolume`, что обеспечивает соответствие биржевым требованиям.
- Уведомления и случайный стартовый трейд, применявшиеся в тестере MQL5, исключены. Им на смену пришёл настраиваемый параметр автоматического входа.

## Возможные доработки
- Скомбинировать модуль хеджирования с отдельной стратегией, отвечающей за начальное открытие позиции.
- Добавить ограничения по капиталу или максимальной глубине цепочки, чтобы избежать бесконтрольного накопления сделок.
- Подключить мониторинг портфеля для контроля маржинальных требований при торговле сразу несколькими инструментами.
