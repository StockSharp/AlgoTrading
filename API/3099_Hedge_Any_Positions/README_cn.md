# Hedge Any Positions 策略

## 概述
**Hedge Any Positions Strategy** 是对原始 *Hedge any positions (barabashkakvn's edition)* MQL5 智能交易系统的 StockSharp 版本。核心思想保持不变：策略会跟踪其创建的每一条持仓腿，当价格朝不利方向移动达到指定的点数时，立即以放大的手数开立反向仓位对冲。实现完全依赖 StockSharp 的高级 API，因此对冲通过市价单完成，仓位状态使用内部列表维护，无需额外的底层交易代码。

策略可选在启动时自动建立第一笔交易。之后它只会响应浮动亏损的扩大，逐步构建对冲链条，并将已经对冲的腿标记为“已处理”，防止同一笔持仓重复触发多个反向订单。

## 对冲流程
1. **数据驱动**：可配置的 `CandleType` 作为时间框架，只处理收盘完成的 K 线。
2. **亏损判断**：在每根 K 线收盘时，检查收盘价相对于各持仓腿的入场价是否出现至少 `LosingPips` × 点值的反向波动。
3. **执行对冲**：若发现满足条件的亏损腿，则按照相反方向发送市价单。新订单的数量等于原始腿的数量乘以 `LotCoefficient`，并根据交易品种的数量步长、最小和最大允许数量进行调整。
4. **状态更新**：对冲指令发出后，将原腿标记为已对冲，并把新开仓记录为新的腿；若价格再次反向，新腿也可以继续触发下一次对冲。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 用于评估价格波动并触发对冲的时间框架。 | 1 分钟 K 线 |
| `LosingPips` | 价格逆向移动的点数阈值，超过后触发对冲。 | 5 |
| `LotCoefficient` | 计算对冲单数量时使用的乘数。 | 2.0 |
| `AutoPlaceInitialTrade` | 启用后，在策略启动时自动发送首笔交易。 | 关闭 |
| `InitialVolume` | 自动首笔交易使用的数量（会按数量步长取整）。 | 0.10 |
| `InitialDirection` | 自动首笔交易的方向（买入或卖出）。 | 买入 |

> **提示：** 请在启动前设置 `Strategy.Volume` 属性，指定基础下单数量。上述参数仅影响对冲逻辑。

## 使用建议
1. 启动前为策略指定 `Security`、`Portfolio` 以及基础交易数量 `Volume`。
2. 根据品种波动性和风险承受能力调整 `LosingPips` 与 `LotCoefficient`。
3. 如果希望策略自行建立第一笔仓位，可启用 `AutoPlaceInitialTrade`；否则请通过手动或其他模块提供初始持仓。
4. 由于 StockSharp 高级 API 采用净持仓模型，策略内部的腿列表用于模拟锁仓结构。在净额账户上运行时需留意总体敞口与保证金占用。
5. 注意查看成交报告：所有对冲操作均通过 `BuyMarket` 或 `SellMarket` 市价单完成。

## 与原始版本的差异
- 移除了保证金检查、滑点控制及详细的结果日志，相关信息可通过 StockSharp 的事件回调获取。
- 转换版本基于收盘 K 线而非逐笔行情，如需更快响应可选择更小的时间框架。
- 数量取整依赖 `Security.VolumeStep`、`Security.MinVolume` 与 `Security.MaxVolume`，从而符合品种的交易规则。
- 原策略中的通知功能和仅用于测试的随机首笔交易被省略，改为可配置的自动建仓参数。

## 建议的扩展方向
- 将该对冲模块与独立的入场策略结合，明确何时建立初始仓位。
- 增加基于权益的停止条件或链条深度限制，避免无限制地累积对冲。
- 加入组合层面的风险监控，以确保保证金和资金占用处于可控范围。
