# Стратегия Fuzzy Logic

## Общее описание

Стратегия Fuzzy Logic переносит эксперт **Fuzzy logic (редакция barabashkakvn)** с MT5 на высокоуровневый API StockSharp. Алгоритм измеряет силу тренда и признаки истощения при помощи индикаторов Билла Вильямса и классических осцилляторов, переводит эти данные в степени принадлежности и собирает их в единый показатель решения от 0 до 1.

Торговые действия выполняются при пересечении установленных границ:

- **Decision &gt; 0.75** – открыть короткую позицию (выраженное истощение, перекупленность).
- **Decision &lt; 0.25** – открыть длинную позицию (сильный сигнал разворота вверх).

Сделки сопровождаются фиксированными уровнями тейк-профита и стоп-лосса (в шагах цены). При задании величины трейлинг-стопа обычный стоп автоматически переводится в режим сопровождения.

## Набор индикаторов

| Компонент | Назначение |
| --- | --- |
| **Гатор** (на основе линий Аллигатора) | Сумма разрывов между челюстью, зубами и губами отражает расширение или сжатие тренда. |
| **Williams %R (14)** | Отслеживает зоны перекупленности и перепроданности. |
| **Acceleration/Deceleration Oscillator** | Считает количество последовательных сдвигов импульса, оценивая ускорение тренда. |
| **DeMarker (14)** | Подтверждает истощение через сравнение экстремумов. Реализован вручную в коде стратегии. |
| **RSI (14)** | Классический осциллятор импульса. |

Линии Аллигатора рассчитываются сглаженными средними и сдвигаются вперед (8/5/3 бара) аналогично оригинальному советнику, чтобы получить идентичный Гатор. Значения AC формируются из индикатора Awesome Oscillator (SMA 5 и 34) и его 5-периодной средней, что полностью совпадает с функцией `iAC` в MT5.

## Логика торговли

1. Значения каждого индикатора преобразуются в пять уровней принадлежности (от сильно медвежьего до сильно бычьего). Используются те же линейные участки, что и в исходном коде MT5.
2. Пять групп взвешиваются коэффициентами 0.133, 0.133, 0.133, 0.268, 0.333 и суммируются в четыре агрегированные корзины.
3. Итоговый показатель решения вычисляется по формуле `Σ summary[x] * (0.2 * (x + 1) - 0.1)` и лежит в диапазоне `[0, 1]`.
4. Сигналы оцениваются только на закрытых свечах. Новая позиция открывается, только если стратегия находится вне рынка.
5. Объём ордера задаётся свойством `Volume` (по умолчанию 1). Защита позиций управляется через `StartProtection`.

## Управление рисками

- **StopLossPoints** – дистанция стоп-лосса в шагах цены. Используется, если `TrailingStopPoints` = 0.
- **TrailingStopPoints** – при значении &gt; 0 стоп-лосс принимает эту дистанцию и переходит в режим трейлинг-стопа.
- **TakeProfitPoints** – дистанция тейк-профита в шагах цены.

## Параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Тип / таймфрейм свечей для расчётов. |
| `BuyThreshold` | Порог, ниже которого открывается длинная позиция. Значение по умолчанию 0.25. |
| `SellThreshold` | Порог, выше которого открывается короткая позиция. Значение по умолчанию 0.75. |
| `StopLossPoints` | Дистанция стоп-лосса в шагах цены. Значение по умолчанию 60. |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены. Значение по умолчанию 20. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа в шагах цены. Значение по умолчанию 0 (выключено). |
| `WilliamsPeriod` | Период индикатора Williams %R. Значение по умолчанию 14. |
| `RsiPeriod` | Период RSI. Значение по умолчанию 14. |
| `DeMarkerPeriod` | Период расчёта встроенного DeMarker. Значение по умолчанию 14. |

## Особенности реализации

- Индикатор DeMarker реализован вручную: изменения максимумов и минимумов накапливаются в очередях, что повторяет логику MT5.
- Для AC сохраняются последние пять значений, поэтому условия последовательного ускорения полностью соответствуют вызовам `iAC(..., shift)`.
- Сдвиги линий Аллигатора (8/5/3 баров) воспроизведены через внутренние буферы, благодаря чему величина Гатора совпадает с оригиналом.
- Стратегия открывает новую позицию только при `Position == 0`, тем самым повторяя поведение исходного советника, который работал с единственной позицией.

## Как использовать

1. Присоедините стратегию к портфелю и инструменту в Designer или Backtester.
2. Задайте нужный тип свечей через параметр `CandleType`.
3. При необходимости скорректируйте пороги решений и уровни стопов.
4. Запустите стратегию – сделки будут появляться автоматически при пересечении заданных уровней fuzzy-оценки.
