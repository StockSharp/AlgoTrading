# Стратегия Get Last Nth Open Trade

## Обзор
**Get Last Nth Open Trade Strategy** повторяет работу оригинального эксперта MetaTrader: стратегия периодически сканирует портфель и публикует сведения о N-й с конца открытой позиции. Это вспомогательный инструмент, который никогда не выставляет и не снимает заявки. Он лишь просматривает открытые позиции у брокера и выводит аккуратно оформленный отчёт в журнал стратегии, чтобы трейдер мог мгновенно увидеть тикет, направление, объём, цену и прибыль прямо в Designer.

## Основные особенности
- Периодический таймер, обновляющий снимок с заданным интервалом. Первый отчёт формируется сразу после запуска стратегии.
- Фильтры, аналогичные MQL-версии: можно ограничить поиск позициями по инструменту стратегии или позициями с заданным идентификатором стратегии (аналог «magic number»).
- Позиции сортируются по времени последнего изменения по убыванию, поэтому индекс `0` всегда соответствует самой свежей сделке и полностью повторяет логику «последняя с конца».
- Подробный отчёт с тикетом позиции, инструментом, направлением, объёмом, средней ценой, прибылью, временем последнего изменения и, при наличии, идентификатором стратегии-источника.
- Потокобезопасная обработка таймера: повторный запуск не начнётся, пока предыдущий снимок ещё строится.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `EnableMagicNumber` | При включении выводятся только позиции, у которых идентификатор стратегии совпадает с `MagicNumber`. | `false` |
| `EnableSymbolFilter` | При включении анализируются только позиции, связанные с `Strategy.Security`. | `false` |
| `MagicNumber` | Строковый идентификатор стратегии (аналог magic number), которому должны соответствовать позиции при активном фильтре. | `"1234"` |
| `TradeIndex` | Номер позиции (счёт от нуля) в отсортированном списке. `0` — самая новая позиция. | `0` |
| `RefreshInterval` | Интервал между последовательными снимками. Первый снимок выполняется немедленно при старте. | `1` секунда |

## Как это работает
1. В `OnStarted` стратегия проверяет, что к ней привязан портфель, и убеждается, что `RefreshInterval` больше нуля.
2. Создаётся `System.Threading.Timer` с нулевой задержкой, благодаря чему первый снимок формируется мгновенно. Далее таймер срабатывает по заданному интервалу.
3. На каждом тике таймера происходит обход `Portfolio.Positions`: позиции с нулевым объёмом отбрасываются, затем применяются фильтры по инструменту и идентификатору стратегии.
4. Оставшиеся позиции сортируются по `LastChangeTime` в порядке убывания. Если `TradeIndex` выходит за допустимые границы, стратегия фиксирует это в журнале и ждёт следующего тика.
5. Если подходящая позиция найдена, формируется текстовый блок с тикетом, инструментом, направлением, объёмом, средней ценой, прибылью, временем изменения и, при наличии, идентификатором стратегии. Блок записывается через `LogInfo`.
6. Обработка защищена безблокировочным флагом на базе `Interlocked.Exchange`, поэтому медленные операции записи не приводят к параллельному выполнению нескольких снимков.

## Рекомендации по использованию
- Перед запуском назначьте коннектор и укажите нужный `Portfolio`. Для фильтра по инструменту также задайте `Strategy.Security`.
- Если требуется повторить MQL-фильтр по magic number, впишите в `MagicNumber` точное значение `StrategyId`, которым помечаются позиции других стратегий.
- Отчёт выводится в журнал стратегии (Designer, Runner и т. д.). При необходимости отображения в UI подключите соответствующий обработчик логов.
- `TradeIndex` начинается с нуля: `0` — последняя сделка, `1` — предпоследняя и т. д.

## Отличия от версии MQL
- В MetaTrader доступны поля stop-loss, take-profit и комментарий позиции. В StockSharp эти данные напрямую не предоставляются, поэтому отчёт содержит идентификатор, направление, объём, цены и показатели прибыли.
- Вместо обновления комментария на графике стратегия использует систему логирования StockSharp через `LogInfo`.
- Для сортировки применяется `LastChangeTime`, отражающий последнее обновление позиции со стороны коннектора. В MQL сортировка выполнялась по номеру тикета. Оба подхода гарантируют, что индекс `0` соответствует самой свежей сделке.
- Фильтр по magic number использует строковый `StrategyId`, записанный в позициях. Если такие метаданные отсутствуют, оставьте `EnableMagicNumber` выключенным.
