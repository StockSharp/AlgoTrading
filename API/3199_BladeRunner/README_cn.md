# BladeRunner 策略

## 概述
BladeRunner 策略源自 MetaTrader 智能交易系统，结合了威廉姆斯分形突破、趋势判定以及多周期动量过滤。StockSharp 版本保留了原脚本的多时间框架结构：主周期负责产生信号，高一级周期用于动量过滤，慢速周期提供 MACD 趋势确认。策略以市价单入场，可按配置进行加仓，并自动按照价格步长设置止损与止盈。

## 交易逻辑
1. **分形突破过滤**：算法在完成的 K 线中寻找威廉姆斯分形。若两根之前的 K 线创出新高，且确认 K 线开盘价低于分形价位和 20 周期 LWMA（典型价），则产生看多分形；看空分形则要求对应的开盘价高于分形价位与 LWMA。
2. **趋势过滤**：在主周期上计算快慢两条线性加权移动平均线（LWMA）。只有当快线高于慢线时才允许做多，反之则允许做空。
3. **动量过滤**：在高一级周期计算动量指标，只要最近三个读数中有任意一个与 100 的偏差超过阈值，就认为动量充足。
4. **MACD 过滤**：在慢速周期上计算 MACD，要求主线位于信号线之上（做多）或之下（做空）。
5. **突破确认**：最新主周期 K 线的收盘价必须突破存储的分形价位，才会真正发出交易。

当以上所有条件同时满足时，策略按设定手数开仓；如果存在反向仓位，会先行平掉再反手。只要未达到最大加仓次数，就可以继续分批入场。

## 实现细节
- 使用高级 API 创建三条蜡烛订阅，并直接与各自的指标绑定，无需加入全局指标列表。
- 所有 LWMA 均以典型价 (H+L+C)/3 为输入，MACD 同样采用该价格类型，以保持与 MQL 版本一致。
- 分形检测保存一个滑动窗口的历史 K 线及其过滤值，仅记录最后一个通过验证的分形方向，防止在同一结构上重复触发。
- 动量历史使用固定长度数组维护，既重现了原策略查看最近三个值的逻辑，又避免多余的内存分配。
- 下单前会按交易所的最小步长、最小/最大手数调整成交量。
- 调用 `StartProtection` 后，所有仓位都会自动附加以价格步长表示的止损和止盈。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 主周期蜡烛，用于生成信号。 | 15 分钟 |
| `MomentumCandleType` | 动量过滤所用的高一级周期。 | 1 小时 |
| `MacdCandleType` | MACD 过滤所用的慢速周期。 | 日线 |
| `FastMaPeriod` | 快速 LWMA 周期。 | 6 |
| `SlowMaPeriod` | 慢速 LWMA 周期。 | 85 |
| `FilterMaPeriod` | 分形验证所用的 LWMA 周期。 | 20 |
| `MomentumPeriod` | 动量指标的计算周期。 | 14 |
| `MomentumThreshold` | 动量偏离 100 的最小阈值。 | 0.3 |
| `FractalLookback` | 分形检测的历史窗口长度。 | 200 |
| `MaxTrades` | 单方向允许的最大加仓次数。 | 3 |
| `OrderVolume` | 每次市价单的基础手数。 | 1 合约 |
| `TakeProfitSteps` | 以价格步长表示的止盈距离。 | 50 |
| `StopLossSteps` | 以价格步长表示的止损距离。 | 20 |

## 风险控制
- `StartProtection` 会为每个仓位自动挂上止损和止盈。
- 在开新仓之前会先平掉反向持仓，避免形成对锁。
- `MaxTrades` 限制了单向总加仓次数，同时成交量会按照交易所约束进行调整。

## 与原版 EA 的差异
- 未移植基于权益的强制平仓、资金追踪止损和保本功能，如有需要可通过 StockSharp 其他组件实现。
- 原代码中的资金追踪止盈和推送通知被省略，可改用平台的通知系统。
- 默认情况下 MACD 使用日线数据。若数据源支持月线，可将 `MacdCandleType` 改为月线以贴近原策略。
- 分形验证基于滑动窗口中的最新确认蜡烛，避免反复遍历 200 根历史数据但行为效果一致。

## 使用建议
1. 根据实际数据源配置三个蜡烛周期，确保能够同时获取主周期、动量周期和 MACD 周期。
2. 将 `OrderVolume`、`TakeProfitSteps` 与 `StopLossSteps` 调整为符合品种最小价位变动和合约乘数的值。
3. 在历史测试或滚动验证中优化动量阈值及 LWMA 周期，以适配不同市场环境。
4. 如需人工确认，可开启图表绘制功能观察三条 LWMA 以及分形突破的配合情况。
