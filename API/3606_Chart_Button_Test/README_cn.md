# 图表按钮测试策略（StockSharp 版本）

## 概述
**Chart Button Test Strategy** 是 MetaTrader 指标 `Chartbuttontest.mq4`（44020）的 StockSharp 版本。原始 MQL 程序通过一个可拖动的按钮展示如何在图表上交互式显示价格。本策略在 StockSharp 中通过绘制矩形和文本标签来模拟相同的效果，并在按钮位置变化时写入日志。示例仅用于界面演示，不会发送任何交易指令。

## 主要思路
* 使用高层 `Strategy` API，只订阅蜡烛数据。
* 通过四条线段勾勒出矩形，模拟按钮的边框。
* 显示实时价格文本，重现 MQL 按钮上的说明文字。
* 提供参数控制水平锚点、垂直高度以及显示文本。
* 不创建自定义集合，也不直接访问指标历史，状态全部保存在策略字段中。

## 运行流程
1. **初始化阶段**
   * 第一个收盘蜡烛决定初始锚点时间和矩形底部价格，优先使用最优卖价，其次是最新价，最后退回到蜡烛收盘价。
   * 创建独立的图表区域，并在其中同时绘制原始蜡烛与模拟按钮。
   * 通过 `AddInfoLog` 输出创建时的时间与价格。
2. **实时更新**
   * 每根收盘蜡烛都会把开盘时间压入队列，队列长度超过 `LookbackCandles` 时会丢弃最旧的数据。
   * 当未锁定水平移动时，矩形左侧沿着队列最早的时间滑动；锁定后仅在垂直方向拉伸。
   * 矩形底部使用当前蜡烛的收盘价，顶部始终比底部高出 `PriceHeight`。
   * 更新图形后写入一条日志，模仿 MQL 中的 `EVENT_END_DRAG` 事件。
3. **无交易逻辑**
   * 策略不会发送买卖单，仅用于迁移图形对象的示例和可视化辅助。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| **Candle Type** | 使用的蜡烛数据类型。 | 1 分钟周期 |
| **Lookback Candles** | 影响左侧锚点的蜡烛数量。 | 100 |
| **Button Height** | 矩形上下边之间的价格距离。 | 0.001 |
| **Button Text** | 按钮旁的文本。 | `Button price:` |
| **Lock Horizontal Movement** | `true` 表示固定左侧时间，`false` 表示跟随队列滑动。 | `false` |

## 日志
策略会输出两类提示：
* `Button created at <price> (time <timestamp>).`
* `Button moved to <price> at <timestamp>.`
这些日志可以帮助观察每一次“拖拽”位置的变化。

## 使用建议
* 启动前确认 `PriceHeight` 与品种最小跳动相匹配，可根据需要调整。
* 设置 `Lock Horizontal Movement` 为 `true` 可以模拟只能上下拖动的按钮。
* 可把矩形和其他指标信号结合，作为人工交易时的图形辅助。

## 与 MQL 版本的差异
* 不支持鼠标拖动，改为在新蜡烛到来时自动移动锚点。
* 矩形高度恒定，只能通过参数调整。
* 没有交易功能，定位为可视化示例。
