# Тестовая стратегия кнопки на графике (StockSharp)

## Описание
**Chart Button Test Strategy** — это порт оригинального скрипта MetaTrader `Chartbuttontest.mq4` (44020) на платформу StockSharp. В MQL пример демонстрировал, как отобразить на графике перетаскиваемую кнопку с подписью текущей цены. В новой версии поведение имитируется при помощи прямоугольника и текстовой метки, которые обновляются по мере появления новых свечей. Стратегия служит визуальным помощником и не выполняет торговых операций.

## Основные идеи
* Использование высокоуровневого API `Strategy` с подпиской только на свечи.
* Отрисовка четырёх линий, формирующих «корпус» кнопки.
* Вывод текста с актуальной ценой, аналогичный надписи в MQL.
* Гибкие параметры, позволяющие управлять горизонтальным якорем, высотой и подписью.
* Отказ от ручных коллекций и прямого доступа к данным индикаторов — вся логика хранится во внутренних полях стратегии.

## Поведение во время работы
1. **Старт**
   * Первая завершённая свеча задаёт начальную цену и время для нижней границы прямоугольника. Стратегия по возможности использует лучшую цену Ask, затем последнюю цену сделки и только после этого закрытие свечи.
   * Создаётся отдельная область графика, в которой отображаются исходные свечи и прямоугольник «кнопки».
   * В лог отправляется сообщение о координатах создания.
2. **Обновление**
   * Каждая завершённая свеча помещает время открытия в очередь. Когда количество элементов превышает параметр `LookbackCandles`, самые старые значения удаляются.
   * Если горизонтальное движение не заблокировано, левая граница прямоугольника следует за самым старым временем в очереди. При блокировке меняется только вертикальное положение.
   * Нижняя граница принимает цену закрытия текущей свечи, верхняя расположена на расстоянии `PriceHeight` выше.
   * После перерисовки форма сопровождается лог-сообщением, повторяющим смысл события `EVENT_END_DRAG` из MQL.
3. **Отсутствие сделок**
   * Стратегия не вызывает `BuyMarket`, `SellMarket` и другие торговые методы. Это образец миграции графических инструментов.

## Параметры
| Имя | Назначение | Значение по умолчанию |
| --- | --- | --- |
| **Candle Type** | Тип свечей, на которые подписывается стратегия. | Таймфрейм 1 минута |
| **Lookback Candles** | Количество свечей, влияющее на левый якорь. | 100 |
| **Button Height** | Расстояние между нижней и верхней границей прямоугольника. | 0.001 |
| **Button Text** | Подпись, выводимая рядом с прямоугольником. | `Button price:` |
| **Lock Horizontal Movement** | При значении `true` левая граница фиксируется. При `false` двигается вместе с очередью. | `false` |

## Журнал сообщений
Используются два информационных сообщения:
* `Button created at <price> (time <timestamp>).`
* `Button moved to <price> at <timestamp>.`
Они позволяют отслеживать каждое автоматическое перемещение «кнопки».

## Рекомендации
* Подбирайте `PriceHeight` под шаг цены выбранного инструмента.
* Включайте `Lock Horizontal Movement`, если нужна имитация кнопки, которую можно двигать только по вертикали.
* Объединяйте прямоугольник с другими графическими элементами, чтобы собрать наглядную панель для ручной торговли.

## Отличия от исходного MQL-скрипта
* Нет интерактивного перетаскивания мышью — положение меняется автоматически при появлении новых свечей.
* Высота прямоугольника постоянна и регулируется параметром.
* В стратегии отсутствует торговая логика, она предназначена исключительно для визуализации.
