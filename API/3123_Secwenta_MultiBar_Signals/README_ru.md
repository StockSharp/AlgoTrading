# Стратегия Secwenta по последовательностям свечей

## Обзор
Стратегия повторяет логику советника MetaTrader "Secwenta" (MQL ID 22977) в среде StockSharp. Алгоритм анализирует завершённые свечи выбранного таймфрейма, считает количество бычьих (close > open) и медвежьих (close < open) баров в коротком скользящем окне и, в зависимости от настроек, открывает или закрывает позиции. Поддерживаются три режима работы: только покупки, только продажи и двусторонние реверсы. Объём заявок соответствует исходному параметру Lots.

## Оценка сигналов
- Используются только полностью сформированные свечи (`CandleType`), поступающие через высокоуровневую подписку StockSharp.
- Для каждой свечи фиксируется направление: бычья, медвежья или нейтральная. Внутренний буфер хранит последние *N* направлений, где *N* равно максимальному из `BullishBarCount` и `BearishBarCount` для включённых направлений торговли.
- Счётчики увеличиваются при закрытии свечи выше или ниже открытия; нейтральные бары счётчики не меняют.
- Сигнал появляется, когда соответствующий счётчик достигает порога внутри окна, что полностью воспроизводит оригинальный перебор массивов `CopyRates`.

## Правила торговли
1. **Режим только покупок (`UseBuySignals = true`, `UseSellSignals = false`):**
   - При достижении `BearishBarCount` медвежьих свечей текущая длинная позиция закрывается рыночной продажей.
   - При достижении `BullishBarCount` бычьих свечей и нулевой позиции открывается новая длинная позиция объёмом `OrderVolume`.
2. **Режим только продаж (`UseBuySignals = false`, `UseSellSignals = true`):**
   - При достижении `BullishBarCount` бычьих свечей текущая короткая позиция закрывается рыночной покупкой.
   - При достижении `BearishBarCount` медвежьих свечей и отсутствии позиций открывается новая короткая позиция объёмом `OrderVolume`.
3. **Реверсивный режим (`UseBuySignals = true` и `UseSellSignals = true`):**
   - Бычий сигнал закрывает шорт и, если нет длинной позиции, открывает лонг объёмом `OrderVolume` плюс модуль закрываемой позиции.
   - Медвежий сигнал закрывает лонг и, если нет короткой позиции, открывает шорт объёмом `OrderVolume` плюс модуль закрываемой позиции.

Все операции выполняются через `BuyMarket`/`SellMarket`, дополнительно вызывается `StartProtection()` для совместимости с защитными модулями StockSharp.

## Параметры
| Параметр | Описание | Значение по умолчанию | Примечание |
|----------|----------|-----------------------|------------|
| `CandleType` | Тип свечей, по которым ведётся подсчёт. | Таймфрейм 1 час | Можно выбрать любой поддерживаемый тип данных. |
| `OrderVolume` | Базовый объём рыночной заявки. | 1 | Добавляется к объёму закрытия при реверсе позиции. |
| `UseBuySignals` | Обработка бычьих сигналов. | `true` | При отключении новые покупки не открываются. |
| `BullishBarCount` | Количество бычьих свечей для сигнала. | 2 | В режиме только покупок определяет длину окна. |
| `UseSellSignals` | Обработка медвежьих сигналов. | `false` | При отключении новые продажи не открываются. |
| `BearishBarCount` | Количество медвежьих свечей для сигнала. | 1 | Используется для открытия шортов и выхода из лонгов. |

## Особенности реализации
- Очередь направлений синхронизирована с текущим размером окна и пересчитывается при изменении параметров.
- Обрабатываются только завершённые свечи, как и в оригинале, который реагировал на появление нового бара.
- Нейтральные свечи не влияют на счётчики, сохраняя поведение MQL-версии.
- Реверсы выполняются одной рыночной заявкой, объединяющей объём закрытия и открытия.
- Размер окна равен крупнейшему активному порогу; если одна из сторон отключена, учитывается только порог активной стороны, что соответствует логике исходного кода.

## Файлы
- `CS/SecwentaMultiBarSignalsStrategy.cs` – реализация стратегии на C# с использованием высокоуровневого API StockSharp.

> **Примечание:** Для данной стратегии предоставлена только C#-версия, Python-реализация отсутствует.
