# Стратегия ZigZag EvgeTrofi 1

[English](README.md) | [中文](README_zh.md)

## Обзор
ZigZag EvgeTrofi 1 воспроизводит работу оригинального советника MetaTrader, который реагирует на последний разворот ZigZag. Стратегия анализирует каждую завершённую свечу, определяет самый свежий пивот ZigZag по классическим параметрам глубины, отклонения и шага блокировки и входит в рынок, пока пивот остаётся актуальным. Максимум ZigZag инициирует длинную позицию, минимум ZigZag — короткую позицию, полностью повторяя логику исходного эксперта.

## Логика торговли
- Подписка на выбранный тип свечей и передача данных в индикаторы Highest/Lowest с длиной, равной параметру глубины. Эта пара индикаторов имитирует работу родного ZigZag без использования пользовательских буферов.
- После закрытия свечи проверяется, касается ли максимум отслеживаемого значения или минимум достигает текущего минимума. Переключение на новый пивот допускается только при соблюдении требуемого отклонения в шагах цены и выдержке минимального количества баров между противоположными пивотами (параметр Backstep).
- После фиксации пивота ведётся счётчик прошедших баров. Параметр Urgency определяет, сколько баров после пивота сигнал остаётся рабочим. Сигналы старше заданного порога игнорируются, что исключает поздние входы.
- Пивот на максимуме готовит длинный сигнал, пивот на минимуме — короткий. Если позиция в нужном направлении уже открыта, сигнал помечается как обработанный и новые заявки не отправляются.
- При наличии позиции в противоположном направлении стратегия сначала отправляет рыночную заявку для закрытия позиции, после чего немедленно выставляет новую рыночную заявку с указанным объёмом, открывая позицию в нужную сторону.
- Каждое действие выполняется только при полностью сформированных индикаторах, закрытой свече и положительном объёме. Дополнительно вызывается `IsFormedAndOnlineAndAllowTrading()`, чтобы убедиться в готовности подключения и торговых прав.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `Depth` | Глубина ZigZag, задающая окно поиска разворотов. | 17 |
| `Deviation` | Минимальное отклонение в пунктах для подтверждения пивота того же типа. Внутри переводится в шаги цены инструмента. | 7 |
| `Backstep` | Минимальное число баров, которое должно пройти перед сменой направления. | 5 |
| `Urgency` | Максимальное количество баров после пивота, когда вход ещё разрешён. | 2 |
| `Candle Type` | Тип свечей (таймфрейм или другая агрегация), используемый в расчётах. | Таймфрейм 5 минут |
| `Volume` | Объём рыночной заявки при каждом входе. | 0.1 |

## Особенности реализации
- Индикаторы Highest/Lowest подключены через высокоуровневый метод `SubscribeCandles().Bind()`, поэтому расчёты ведутся только по закрытым свечам без ручного накопления данных.
- Параметр отклонения преобразуется в абсолютное изменение цены через шаг цены инструмента. Если у инструмента не задан шаг, используется значение 1, что обеспечивает единообразную работу на разных площадках.
- Логика содержит флаг, блокирующий повторные сделки по одному пивоту, что совпадает с поведением советника MetaTrader, который реагирует на разворот один раз.
- При наличии графика стратегия автоматически отображает свечи и совершённые сделки, что упрощает визуальную проверку точек входа.
- Управление позицией симметрично: противоположная позиция закрывается рыночной заявкой равного объёма перед открытием новой, поддерживая однонаправленную экспозицию, как в оригинальном советнике.
