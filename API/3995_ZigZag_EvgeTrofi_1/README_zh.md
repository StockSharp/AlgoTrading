# ZigZag EvgeTrofi 1 策略

[English](README.md) | [Русский](README_ru.md)

## 概述
ZigZag EvgeTrofi 1 复刻了最初的 MetaTrader 智能交易系统，该系统会根据最新的 ZigZag 转折点开仓。策略逐根处理已经收盘的 K 线，利用经典的深度、偏离和回撤参数确定最新的 ZigZag 枢轴，并在信号仍然新鲜时入场。形成的 ZigZag 高点触发做多，形成的 ZigZag 低点触发做空，与原始 EA 的方向完全一致。

## 交易逻辑
- 订阅设定的蜡烛类型，并将数据送入长度等于 ZigZag 深度的 Highest/Lowest 指标组合。这组指标无需自定义缓冲即可模拟原生 ZigZag 的转折识别。
- 每当蜡烛收盘时，检测其最高价是否触及跟踪的最高值或最低价是否触及跟踪的最低值。只有在满足所需的价格偏离并且遵守最小反转间隔（Backstep 参数）时才允许切换到新的枢轴。
- 记录枢轴后会统计已经过去的 K 线数量。Urgency 参数定义枢轴在多少根 K 线之内仍被视为有效，超过该限制的信号会被忽略，从而避免迟到的入场。
- 当枢轴位于高点时准备做多，位于低点时准备做空。如果当前已有同方向仓位，信号会被标记为已处理，不会重复下单。
- 如果账户持有反向仓位，策略会先发出等量的市价单平掉该仓位，然后立即以下单量执行新的市价单，建立目标方向的仓位。
- 所有操作都要求指标已形成、蜡烛已收盘且交易量为正。策略在下单前调用 `IsFormedAndOnlineAndAllowTrading()` 检查连接和交易许可，确保只有在交易环境健康时才会发送订单。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `Depth` | ZigZag 深度，决定转折点的搜索窗口。 | 17 |
| `Deviation` | 确认同方向枢轴所需的最小价格偏移（以点为单位），内部会换算成合约最小变动。 | 7 |
| `Backstep` | 切换到相反枢轴前必须经过的最小 K 线数量。 | 5 |
| `Urgency` | 枢轴形成后仍允许开仓的最大 K 线数量。 | 2 |
| `Candle Type` | 用于计算的蜡烛类型（时间周期或其它聚合方式）。 | 5 分钟周期 |
| `Volume` | 每次入场时提交的市价单手数。 | 0.1 |

## 实现要点
- 通过高层 `SubscribeCandles().Bind()` API 连接 Highest/Lowest 指标，因此策略只在完整蜡烛上运算，并且无需手工缓存数据。
- 偏离参数会利用合约的最小价格跳动转换成绝对价格差。如果标的没有提供价格步长，则退回到 1，保证跨市场的一致性。
- 使用布尔标志阻止同一个枢轴重复下单，完全符合原始 MetaTrader 智能交易系统只对每个波动执行一次的行为。
- 当绘图功能可用时，策略会自动展示蜡烛和成交，方便复核枢轴位置和进出场情况。
- 仓位管理保持对称：在开新仓前会用相同数量的市价单平掉反向仓位，从而像原版 EA 一样始终保持单向敞口。
