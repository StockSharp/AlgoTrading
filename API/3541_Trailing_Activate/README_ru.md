# Стратегия Trailing Activate

## Общее описание
- **Источник**: советник MetaTrader 5 «Trailing Activate.mq5».
- **Назначение**: сопровождение уже открытых позиций с помощью ступенчатого трейлинг-стопа, полностью повторяющего оригинальный алгоритм.
- **Тип стратегии**: вспомогательный модуль. Новые сделки не открываются, стратегия только двигает виртуальный стоп и при необходимости закрывает позицию рыночной заявкой.

## Как работает перенос
1. Стратегия отслеживает текущий объём длинной или короткой позиции. Как только позиция обнуляется, внутреннее состояние трейлинга очищается.
2. Активация происходит лишь после накопления требуемой прибыли. Цена должна пройти `TrailingStopPoints + TrailingStepPoints`, а рассчитанный уровень стопа обязан находиться минимум на `TrailingActivatePoints` выше/ниже цены входа — точь‑в‑точь как в MQL5.
3. Сдвиг стопа выполняется дискретно. Новое значение принимается только при улучшении не менее чем на `TrailingStepPoints` (в абсолютной цене учитывается `Security.PriceStep`).
4. При пробое защитного уровня позиция закрывается командой `BuyMarket`/`SellMarket`. В MT5 вызывался `PositionModify`, который изменял брокерский стоп-лосс. В StockSharp прямого аналога нет, поэтому закрытие реализовано через рыночный выход.
5. Доступны два режима работы:
   - **EveryTick** — привязка к обновлениям лучшего бид/аск из Level1. Аналог режима `bar_0` в оригинале, когда трейлинг реагирует на каждый тик.
   - **NewBar** — пересчёт только на закрытии свечи заданного таймфрейма. Соответствует `bar_1` и подходит для более «спокойного» сопровождения.

## Параметры
| Имя | Назначение | Значение по умолчанию |
| --- | ---------- | --------------------- |
| `TrailingMode` | Переключение между покадровым и посвечным сопровождением. | `NewBar` |
| `CandleType` | Таймфрейм для подписки на свечи при режиме `NewBar`. | Свечи на 15 минут |
| `TrailingActivatePoints` | Прибыль (в пунктах), необходимая для старта трейлинга. | `70` |
| `TrailingStopPoints` | Расстояние (в пунктах) между ценой и трейлинг-стопом. | `250` |
| `TrailingStepPoints` | Минимальный дополнительный ход (в пунктах) для очередного сдвига стопа. | `50` |

Все параметры в пунктах переводятся в абсолютную цену через `Security.PriceStep`. Если шаг цены отсутствует или равен нулю, используется значение `1` — так же, как это делает торговый движок MT5.

## Особенности реализации
- Подписка выполняется и на свечи, и на Level1. Однако в работу включается только поток, соответствующий выбранному `TrailingMode`, что позволяет сохранить оригинальную логику и при этом опираться на высокоуровневый API StockSharp.
- Ограничения брокера (`SYMBOL_TRADE_STOPS_LEVEL`, `SYMBOL_TRADE_FREEZE_LEVEL`) в StockSharp недоступны. Поэтому проверяются только пользовательские расстояния, а отличие фиксируется в документации.
- В качестве цены входа используется `Position.AveragePrice`. Если стратегия запускается поверх уже открытой позиции без известной средней цены, временно берётся текущая котировка до поступления новой сделки.
- Трейлинг-стоп является виртуальным. При касании уровня стратегия самостоятельно закрывает позицию. При необходимости можно дополнительно выставить биржевой стоп вручную.

## Инструкция по использованию
1. Запустите стратегию на инструменте, позицию по которому нужно сопровождать.
2. Убедитесь, что позиция уже открыта (вручную или другой стратегией). После достижения пороговых значений прибыли трейлинг активируется автоматически.
3. Настройте параметры в пунктах с учётом шага цены инструмента и желаемой динамики переноса.
4. Выберите режим `EveryTick` для активных рынков либо `NewBar` для переносов строго по закрытию свечей.
