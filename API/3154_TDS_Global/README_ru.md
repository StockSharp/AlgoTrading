# Стратегия TDSGlobal (C#)

## Обзор

Данная стратегия переносит советник MetaTrader 5 **TDSGlobal** из файла `MQL/23255/TDSGlobal.mq5` на высокоуровневый API StockSharp. Алгоритм анализирует четырёхчасовые свечи, вычисляя линию MACD, гистограмму MACD (OsMA) и Force Index. При появлении сигнала на разворот выставляются отложенные лимитные заявки возле экстремумов предыдущей свечи, а позиция сопровождается стоп-лоссом, тейк-профитом и опциональным трейлинг-стопом.

## Логика торговли

1. **Индикаторы**: `MACD(12, 26, 9)` даёт линию и гистограмму, `ForceIndex(24)` оценивает силу прошлой свечи.
2. **Фильтрация**: для открытия сделки необходимы две завершённые свечи, чтобы определить направление наклона MACD/OsMA.
   - Для продажи OsMA должна расти, а значение Force Index предыдущей свечи быть отрицательным.
   - Для покупки OsMA должна снижаться, а Force Index быть положительным.
3. **Выставление заявок**: лимитные ордера размещаются на небольшом расстоянии от максимума/минимума предыдущей свечи. Если расстояние до текущих котировок мало, применяется буфер `EntryOffsetPips` (по умолчанию 16 пунктов).
4. **Риск-менеджмент**: стоп-лосс и тейк-профит рассчитываются от цены ордера. Трейлинг-стоп активируется после прохождения дистанции `TrailingStopPips` и сдвигается шагами `TrailingStepPips`. При достижении защитного уровня внутри свечи позиция закрывается рыночной заявкой.
5. **Поддержка заявок**: если наклон OsMA изменился на противоположный, отложенные ордера снимаются; при исполнении одной стороны противоположный ордер также отменяется.

## Управление капиталом

- **Фиксированный объём** — используется значение `OrderVolume`.
- **Процент от капитала** — при включённом `UseRiskSizing` объём рассчитывается из `RiskPercent`, текущей стоимости портфеля и дистанции стоп-лосса. Итоговый объём округляется до шага объёма инструмента.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `OrderVolume` | Фиксированный объём позиции. | 1 |
| `UseRiskSizing` | Использовать расчёт объёма по риску. | true |
| `RiskPercent` | Процент капитала на сделку. | 3 |
| `MacdFastPeriod` | Период быстрой EMA MACD. | 12 |
| `MacdSlowPeriod` | Период медленной EMA MACD. | 26 |
| `MacdSignalPeriod` | Период сигнальной EMA MACD. | 9 |
| `ForceLength` | Период усреднения Force Index. | 24 |
| `StopLossPips` | Размер стоп-лосса в пунктах (0 — отключить). | 50 |
| `TakeProfitPips` | Размер тейк-профита в пунктах (0 — отключить). | 50 |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах. | 5 |
| `TrailingStepPips` | Минимальный шаг обновления трейлинг-стопа. | 5 |
| `EntryOffsetPips` | Буфер к экстремумам для лимитных ордеров. | 16 |
| `MinDistancePips` | Минимальная дистанция до защитных уровней. | 3 |
| `PipSize` | Размер одного пункта в цене. | 0.0001 |
| `CandleType` | Тип свечей для расчётов. | 4 часа |

## Практические советы

1. Добавьте `CS/TdsGlobalStrategy.cs` в ваш проект StockSharp или загрузите стратегию в модуле Backtester.
2. До запуска укажите инструмент и портфель. При активном `UseRiskSizing` портфель должен предоставлять актуальную оценку стоимости.
3. После старта дождитесь минимум двух завершённых свечей для инициализации индикаторов.
4. Отслеживайте журнал сообщений: стратегия выводит действия с заявками и обновления стопов, что облегчает сравнение с версией на MQL5.

## Отличия от MT5-версии

- В StockSharp исполнение лимитных заявок обрабатывается методом `OnOwnTradeReceived`, а не синхронным результатом `OrderSend`.
- Ограничения «freeze level» и «stops level» из MT5 заменены приближённым расчётом на основе параметра `MinDistancePips` и текущего спреда.
- При пробое защитных уровней позиция закрывается рыночным ордером, что соответствует ручному изменению стопов в оригинальном коде.

Эти адаптации позволяют сохранить логику TDSGlobal и при этом бесшовно работать в экосистеме StockSharp.
