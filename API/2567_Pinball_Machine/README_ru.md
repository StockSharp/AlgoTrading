# Стратегия Pinball Machine

## Общее описание
**Pinball Machine** — это перенос экспертной системы MetaTrader 5 «Pinball machine (barabashkakvn's edition)» на платформу StockSharp. Вместо анализа рынка стратегия имитирует игровой автомат: каждое закрытие свечи запускает серию случайных розыгрышей, и если значения совпадают, открывается позиция. Переписанная версия сохраняет дух оригинала, но использует высокоуровневый API StockSharp для управления капиталом и исполнением сделок.

## Логика работы
1. **Триггер** – стратегия обрабатывает данные в формате, заданном параметром `Candle Type`. После завершения свечи запускается один цикл генерации случайных чисел.
2. **Случайные розыгрыши** – формируется четыре числа от 0 до 100. Совпадение первой пары даёт сигнал на покупку, совпадение второй – на продажу. Пары независимы, поэтому теоретически можно получить оба сигнала в пределах одной свечи.
3. **Условия открытия** – новая сделка отправляется только при отсутствии открытой позиции. Это ограничивает стратегию одним нетто-положением и отличает от хеджирующего поведения оригинального советника.
4. **Дистанции стопов и целей** – для выбранного направления генерируются ещё два числа в диапазоне `Min Offset Points` – `Max Offset Points`. Они переводятся в величину шага цены и задают смещения для стоп-лосса и тейк-профита относительно цены входа.
5. **Размер позиции** – параметр `Risk Percent` ограничивает величину капитала под риском. Стратегия оценивает стоимость портфеля (в порядке приоритета `CurrentValue`, `CurrentBalance`, затем `BeginValue`) и делит допустимый риск на расстояние до стопа. Если расчёт невозможен, используется значение `Volume` (по умолчанию 1 контракт/лот).
6. **Исполнение** – сделки отправляются рыночными ордерами `BuyMarket` и `SellMarket`. Цена закрытия свечи выступает прокси для входа, так как в свечном подписке нет непосредственных котировок Bid/Ask.
7. **Сопровождение позиции** – на каждой завершённой свече проверяется достижение стоп-лосса или тейк-профита. При пробое уровня позиция закрывается рыночным ордером, что повторяет поведение защитных ордеров в версии MT5.

## Параметры
- **Risk Percent** – доля стоимости портфеля, которой стратегия готова рискнуть в одной сделке. Значения больше нуля включают расчёт позиции от риска.
- **Min Offset Points / Max Offset Points** – минимальное и максимальное (включительно) смещение в шагах цены для случайного выбора стопа и цели. Оба параметра должны быть положительными; при перепутанном порядке значения меняются местами автоматически.
- **Candle Type** – тип данных, который инициирует «лотерею». По умолчанию используется минутная свеча, но допустим любой `DataType`, поддерживаемый `SubscribeCandles`.

## Отличия от версии MetaTrader
- **Источник событий** – оригинальный советник работает по каждому тиковому обновлению. Вариант на StockSharp выполняет логику по закрытию свечи согласно рекомендациям по высокоуровневому API.
- **Хеджирование** – в MT5 возможно накапливать разнонаправленные позиции. Перенос ограничен одним нетто-положением (лонг, шорт или вне рынка), что типично для стратегий StockSharp.
- **Управление капиталом** – вместо компонента `CMoneyFixedMargin` используется вычисление объёма через стоимость портфеля и процент риска.
- **Исполнение заявок** – убраны циклы повторных запросов котировок и установка проскальзывания. Ордера отправляются сразу после проверки `IsFormedAndOnlineAndAllowTrading`.

## Рекомендации по использованию
- Убедитесь, что инструмент имеет корректный `PriceStep`. При отсутствии шага стратегия применит значение 1, чтобы продолжить моделирование.
- Из-за случайной природы результат тестирования будет сильно варьироваться. Стратегия подходит для изучения инфраструктуры, риск-менеджмента и экспериментов в стиле Монте-Карло.
- Меняя период свечи, можно управлять частотой розыгрышей: короткие интервалы дают больше потенциальных сделок.
- При наличии графической панели стратегия выводит свечи и собственные сделки, что облегчает оценку частоты совпадений.

## Примечания по конверсии
- Исходный файл: `MQL/17744/Pinball machine.mq5`.
- Все входные настройки (процент риска, диапазоны стопа и цели) вынесены в параметры StockSharp и пригодны для оптимизации.
- Генератор случайных чисел использует стандартный `Random()` .NET, что соответствует инициализации `MathSrand(GetTickCount())` в MetaTrader.
