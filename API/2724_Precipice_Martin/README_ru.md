# Стратегия Precipice Martin (C#)

## Обзор

Precipice Martin — это механическая сеточная стратегия, которая на закрытии каждого обработанного бара открывает рыночную сделку. В оригинальном советнике MetaTrader 5 при появлении новой свечи одновременно создавались длинная и короткая позиции с фиксированными стоп-лоссом и тейк-профитом, выраженными в пунктах. После убыточных выходов лот умножалcя на коэффициент мартингейла, после прибыльных — возвращался к минимальному значению.

Порт на C# сохраняет ту же логику и использует высокоуровневый API StockSharp. Для каждой завершённой свечи стратегия:

1. Проверяет активные позиции и закрывает их, если диапазон свечи пробил заданные уровни стоп-лосса или тейк-профита.
2. В состоянии "без позиции" поочерёдно открывает длинную или короткую сделку (если обе стороны включены), что позволяет воспроизвести поведение исходного робота и при этом не конфликтовать с неттинговым учётом позиций в StockSharp.
3. Применяет опциональный мартингейл для увеличения объёма после серий убыточных сделок.
4. Переводит пользовательские значения стопа и профита из пунктов в абсолютные ценовые отступы на основе шага цены инструмента.

## Особенности конвертации

* В MT5 одновременно открывались buy и sell. В StockSharp мы чередуем направления при каждом новом входе, чтобы избежать мгновенного закрытия нетто-позиции и всё же обеспечить торговлю в обе стороны.
* Стоп-лосс и тейк-профит контролируются внутри стратегии. Как только минимум или максимум свечи достигает уровня, позиция закрывается рыночным ордером, а результат фиксируется для блока мартингейла.
* Проверка объёма повторяет функцию `LotCheck`: рассчитанный лот округляется к шагу объёма, при необходимости обрезается по минимуму и максимуму, и если после округления он становится нулём, новая сделка пропускается.
* Расчёт множителя мартингейла соответствует функции `CalculateLot`: любая неприбыльная сделка умножает текущий множитель на `MartingaleCoefficient`, прибыльная — сбрасывает его на единицу.

## Параметры

| Параметр | Описание |
|----------|----------|
| **Use Buy** | Разрешение на открытие длинных позиций. |
| **Buy SL/TP (pips)** | Расстояние в пунктах до стоп-лосса и тейк-профита длинных сделок. Значение 0 отключает выходы для лонга. |
| **Use Sell** | Разрешение на открытие коротких позиций. |
| **Sell SL/TP (pips)** | Расстояние в пунктах до стоп-лосса и тейк-профита коротких сделок. |
| **Use Martingale** | Включает мартингейл. При отключении используется минимальный лот. |
| **Martingale Coefficient** | Множитель, которым умножается лот после убыточной сделки. |
| **Candle Type** | Тип свечей (таймфрейм), обрабатываемых стратегией. По умолчанию — минутные бары, но можно выбрать любой доступный интервал. |

## Логика торговли

1. **Размер пункта** — рассчитывается из шага цены инструмента. Для пятизнаков пункт равен десяти тикам, как и в оригинальном советнике.
2. **Выбор направления** — при включённых `Use Buy` и `Use Sell` стратегия после закрытия позиции чередует лонг и шорт. Если активна только одна сторона, сделки выполняются только в этом направлении.
3. **Установка целей** — при открытии позиции фиксируются абсолютные уровни стоп-лосса и тейк-профита, вычисленные из заданного расстояния в пунктах. Нулевое значение отключает защитные уровни для соответствующей стороны.
4. **Выход** — на каждом закрытом баре проверяется, пересёк ли минимум/максимум свечи соответствующий уровень. При срабатывании позиция закрывается маркет-ордером с объёмом последнего входа.
5. **Мартингейл** — следующий объём равен минимальному лоту инструмента, умноженному на текущий множитель. Убыточный результат (включая нулевой) умножает множитель на `MartingaleCoefficient`, прибыльный сбрасывает его на 1. Перед отправкой объём округляется по шагу.
6. **Контроль ограничений** — если после округления объём стал меньше минимального лота, новый ордер не отправляется, что предотвращает ошибки "недостаточно средств".

## Рекомендации по использованию

1. Настройте таймфрейм параметром **Candle Type** в соответствии с периодом графика, использовавшимся в MT5.
2. Подберите расстояния стопа и профита под волатильность инструмента. Помните, что отступы задаются в абсолютной цене.
3. Используйте мартингейл только при чётком понимании рисков. Рост объёма после каждой потери может быстро увеличить нагрузку на депозит.
4. Запускайте стратегию на инструменте с поступающими свечами. Алгоритм работает только по завершённым барам.
5. Следите за маржинальными требованиями: в этой реализации всегда открыта только одна нетто-позиция, но при больших множителях объём может сильно увеличиваться.

## Отличия от версии MT5

* **Неттинг** — чередование направлений заменяет одновременное открытие buy и sell. Для истинного хеджирования можно запустить две копии стратегии с разными настройками направления.
* **Защитные ордера** — стопы и тейки не выставляются в стакан, а контролируются внутренней логикой и закрываются рынком.
* **История сделок** — вместо сканирования всей истории при каждом тике множитель мартингейла обновляется инкрементно после каждой сделки, что снижает нагрузку.

## Предупреждение о рисках

Мартингейл способен очень быстро наращивать объём позиции в серии убыточных сделок. Перед запуском на реальном счёте протестируйте стратегию на истории и убедитесь, что выбранный коэффициент и расстояния стопов соответствуют волатильности инструмента и размеру капитала.
