# Стратегия Candle Patterns Test

## Обзор

**Candle Patterns Test Strategy** — это конвертация оригинального советника MetaTrader 5 *CandlePatternsTest EA* на высокоуровневый API StockSharp. Стратегия анализирует завершённые свечи и ищет набор классических свечных комбинаций. При появлении бычьих или медвежьих структур она открывает позицию и сопровождает её с помощью встроенных средств риск-менеджмента StockSharp.

## Логика торговли

1. **Подписка на свечи.** Стратегия подписывается на указанный тип свечей и обрабатывает только полностью сформированные бары.
2. **Среднее тело свечи.** Простая скользящая средняя по величине тела используется как адаптивный фильтр — в расчёт берутся только свечи, превышающие среднее значение (аналог функции `AvgBody` в MQ5).
3. **Распознавание паттернов.** Проверяются комбинации:
   - Три белых солдата / Три чёрные вороны
   - Проникающая линия / Завеса из тёмных облаков
   - Утренняя звезда-доджи / Вечерняя звезда-доджи
   - Бычье и медвежье поглощение
   - Бычья и медвежья харами
   - Линии встречи
4. **Открытие позиции.** Бычий паттерн вызывает покупку по рынку, медвежий — продажу по рынку. Противоположный сигнал приводит к закрытию текущей позиции и реверсу.
5. **Закрытие позиции.** Уровни стоп-лосса и тейк-профита вычисляются как произведение среднего тела на соответствующие множители и контролируются на каждой закрывшейся свече.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей для подписки (по умолчанию — часовые). |
| `AverageBodyPeriod` | Количество свечей для расчёта среднего тела. |
| `EnableBullishPatterns` | Разрешение на открытие длинных позиций. |
| `EnableBearishPatterns` | Разрешение на открытие коротких позиций. |
| `StopLossFactor` | Множитель среднего тела для стоп-лосса. |
| `TakeProfitFactor` | Множитель среднего тела для тейк-профита. |

Все параметры реализованы через `StrategyParam<T>`, что позволяет настраивать их в UI и запускать оптимизацию.

## Визуализация

При наличии области графика стратегия отображает:

- Свечи выбранного таймфрейма
- Скользящую среднюю по ценам закрытия
- Сделки стратегии

## Отличия от оригинального советника

- Исключены новостные фильтры, расписание торговли, дополнительные ордера хеджирования и сложные траллинговые блоки — оставлена только свечная логика.
- Управление рисками упрощено до симметричной модели стоп/профит на основе средней величины тела.
- Для операций используется встроенный API StockSharp (`BuyMarket`, `SellMarket`, `ClosePosition`), а не прямые заявки как в MQ5.

## Рекомендации

- Подбирайте `CandleType` в соответствии с выбранным рынком и торговым горизонтом.
- Изменяйте `AverageBodyPeriod`, чтобы фильтр адекватно реагировал на текущее изменение волатильности.
- Множители `StopLossFactor` и `TakeProfitFactor` удобно оптимизировать на исторических данных.

## Требования

- Установленная среда StockSharp с источником данных, поддерживающим нужный тип свечей.
- Источник должен предоставлять последовательные, не перекрывающиеся свечи.
