# Стратегия Dual Stoploss

Стратегия повторяет логику советника MetaTrader **Dual StopLoss.mq4**. Она выступает как слой управления рисками: отслеживает защитные стоп-заявки у уже открытых позиций и принудительно закрывает их за несколько пунктов до срабатывания стопа. Такой ранний выход помогает уменьшить проскальзывание на резких движениях, но при этом сохраняет исходную логику постановки стоп-лосса.

## Как работает

1. Подписывается на данные Level1, чтобы получать лучшие цены Bid/Ask и дистанцию `StopLevel` (или аналогичное поле) от брокера.
2. При каждом обновлении цены, изменении заявок или собственных сделок ищет ближайшую активную стоп-заявку по управляемому инструменту.
3. Сравнивает расстояние от текущей цены до защитного стопа с порогом:
   - Порог = `WhenToClosePoints × pointValue + stopLevelDistance`.
   - `pointValue` соответствует значению MetaTrader `Point` (0.0001 для большинства валютных пар) и вычисляется автоматически из настроек инструмента.
   - `stopLevelDistance` берётся из Level1 полей (`StopLevel`, `MinStopPrice`, `StopPrice`, `StopDistance`), если они доступны. В противном случае принимается равным нулю.
4. Когда расстояние становится меньше или равно порогу, стратегия закрывает позицию рыночной заявкой до того, как брокер исполнит стоп.

Логика покрывает как длинные, так и короткие позиции. Для лонга сравнивается Bid с ценой sell stop, для шорта — Ask с ценой buy stop. Учитываются только активные стоп- и стоп-лимит заявки.

## Параметры

| Параметр | Описание |
|----------|----------|
| **WhenToClosePoints** | Дистанция (в пунктах MetaTrader) от уровня стоп-лосса, при которой нужно закрыть позицию заранее. Значение по умолчанию: 10. При нуле учитывается только минимальная дистанция брокера. |

## Примечания и ограничения

- Стратегия **не** открывает позиции самостоятельно — она управляет только теми позициями, у которых уже стоят защитные стопы.
- Для учёта минимальной дистанции брокера необходимо, чтобы коннектор передавал поле StopLevel (или эквивалент) через Level1. Если данных нет, алгоритм использует только заданное значение `WhenToClosePoints`.
- Вызов `StartProtection()` активирует встроенную защиту StockSharp, чтобы экстренные выходы оставались доступными после запуска.
- Поиск стопов ведётся по коллекции `Orders` стратегии, поэтому защитные стопы должны регистрироваться в рамках той же стратегии.
- Если установлено несколько стопов в одном направлении, используется ближайший к рынку.

## Рекомендации по применению

1. Подключите стратегию к портфелю и инструменту, где позиции открываются вручную или другими алгоритмами, но защитные стопы регистрируются через эту же стратегию.
2. Настройте `WhenToClosePoints` в соответствии с тем, сколько «подушки» нужно перед стопом. Параметр интерпретируется так же, как в MetaTrader (в пунктах, а не в денежных единицах).
3. Запустите стратегию и следите за логом. При приближении цены к стопу будет отправлена рыночная заявка на закрытие позиции.
4. Комбинируйте модуль с другими стратегиями входа или управления объёмом, чтобы построить полный торговый процесс.
