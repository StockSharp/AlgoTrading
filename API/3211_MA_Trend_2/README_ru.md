# Стратегия MA Trend 2

## Краткое описание
- Конвертация эксперта MetaTrader 5 `MA Trend 2.mq5` на платформу StockSharp.
- Сигналы строятся на сравнении цены с настроенной скользящей средней, сдвинутой на указанное число баров.
- Поддерживаются стоп-лосс, тейк-профит, ступенчатый трейлинг и два режима расчёта объёма.

## Логика работы
1. Стратегия подписывается на выбранные свечи и рассчитывает скользящую среднюю с заданными периодом, методом сглаживания, сдвигом и источником цены.
2. После закрытия свечи последнее значение средней сохраняется во внутреннем буфере, что позволяет получить значение предыдущего бара с учётом `MaShift`.
3. Если цена закрытия выше опорной средней и разрешены покупки — формируется сигнал на покупку. При закрытии ниже опорного значения и разрешённых продажах отправляется заявка на продажу. Флаг `ReverseSignals` меняет условия местами.
4. Перед отправкой заявки проверяются ограничения `OnlyOnePosition` и `CloseOppositePositions`: можно либо дождаться, пока позиция станет нулевой, либо закрыть противоположный объём одной сделкой и развернуться.
5. Объём рассчитывается как фиксированное значение либо как доля от капитала. В режиме риска величина стоп-лосса (в пунктах) переводится в цену с использованием параметров инструмента, далее объём округляется вверх до `VolumeStep`.
6. Трейлинг-стоп повторяет логику оригинального советника: он активируется, когда прибыль превышает `TrailingStopPips + TrailingStepPips`, после чего стоп подтягивается ступенями и никогда не ослабляется. При пробое трейлинга позиция закрывается рыночной заявкой.
7. Для стоп-лосса и тейк-профита используется `StartProtection`, что позволяет обработчику заявок закрывать позицию между событиями свечей.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `StopLossPips` | Расстояние стоп-лосса в пунктах (0 — выключено). | `50` |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах (0 — выключено). | `140` |
| `TrailingStopPips` | Базовое расстояние трейлинг-стопа в пунктах. | `15` |
| `TrailingStepPips` | Минимальное дополнительное движение цены для подтягивания трейлинга. | `5` |
| `LotMode` | `FixedVolume` — использовать `LotOrRiskValue` как объём, `RiskPercent` — как процент риска. | `RiskPercent` |
| `LotOrRiskValue` | Фиксированный объём или доля риска (в зависимости от `LotMode`). | `3` |
| `MaPeriod` | Период скользящей средней. | `12` |
| `MaShift` | Количество завершённых свечей между текущим баром и используемым значением средней. | `3` |
| `MaMethod` | Метод усреднения (простая, экспоненциальная, сглаженная, линейно-взвешенная). | `LinearWeighted` |
| `MaPrice` | Тип цены для расчёта средней. | `Weighted` |
| `CandleType` | Тип свечей, на которых работает стратегия. | `1 минута` |
| `Direction` | Допустимое направление (`BuyOnly`, `SellOnly`, `Both`). | `Both` |
| `OnlyOnePosition` | Ограничение на наличие только одной позиции. | `false` |
| `ReverseSignals` | Инвертировать торговые условия. | `false` |
| `CloseOppositePositions` | Закрывать противоположную позицию перед входом. | `false` |

## Управление капиталом
- В режиме процента риска используются поля `PriceStep` и `StepPrice` инструмента для перевода пунктов в абсолютную цену.
- Величина капитала берётся из `Portfolio.CurrentValue`, при отсутствии — из `Portfolio.BeginValue`.
- Рассчитанный объём округляется вверх до ближайшего шага объёма `VolumeStep`.

## Трейлинг-стоп
- Дистанции задаются в пунктах и автоматически переводятся в цену с учётом точности инструмента.
- Для длинных позиций стоп подтягивается, когда прибыль превышает порог, и размещается на уровне `Close - TrailingStopPips`. Стоп никогда не отдаляется от цены.
- Для коротких позиций логика симметрична: стоп опускается ниже цены при достаточном снижении и закрывает сделку при пробое вверх.

## Особенности конверсии
- Используется высокоуровневый API (`BuyMarket`, `SellMarket`, `StartProtection`), что соответствует методологии репозитория.
- Буфер значений средней ограничен (сдвиг + небольшой запас), поэтому дополнительных коллекций не создаётся.
- Все комментарии в коде написаны на английском языке, как и требуется инструкцией.
