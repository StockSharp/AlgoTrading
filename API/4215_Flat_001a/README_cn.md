# Flat 001a 区间策略

## 概述
Flat 001a 是一套针对 EURUSD 小时图的剥头皮系统。策略读取最近三根完成的 K 线，计算最高点与最低点之间的距离。当该范围处于设定的点数区间内时，系统假设行情维持横盘状态，并尝试在区间边缘进行逆势交易。只要收盘价落在区间的上四分之一或下四分之一区域，并且没有持仓，策略就会进场并立即设置保护性订单。

原始的 MQL4 智能交易系统仅允许在 EURUSD、H1 周期上运行，如果符号或周期不符合要求便拒绝交易。移植到 StockSharp 的版本延续了这些默认设置（EURUSD、60 分钟 K 线），并完整复刻了入场、止损、止盈以及追踪止损的计算方法。

## 数据与指标
- 使用周期为 3 的 `Highest` 与 `Lowest` 指标，持续更新最近三根 K 线的最高价和最低价。
- 蜡烛类型参数默认设为 60 分钟，保持与原策略一致。
- 不依赖额外振荡指标，交易决策完全基于价格极值。

## 入场逻辑
1. 仅在订阅蜡烛收盘后处理数据，忽略未完成的 K 线。
2. 检查当前标的代码是否与参数 `SecurityCode` 一致（默认 `EURUSD`）。若不一致，策略保持观望。
3. 应用可选的交易时段过滤。默认允许在午夜开始的两个小时内（0 点与 1 点）入场，可通过参数关闭。
4. 计算三根 K 线的区间 `range = highest - lowest`，并借助合约的 `PriceStep` 转换为点数。
5. 只有当点数位于 `DiffMinPoints` 与 `DiffMaxPoints` 之间时才继续。
6. 当收盘价落入区间下四分之一且当前无持仓时，开多单。
7. 当收盘价落入区间上四分之一且当前无持仓时，开空单。

## 仓位管理
- **初始止损**
  - 多单：`lowest - range / 3`。
  - 空单：`highest + range / 3`。
- **止盈**
  - 多单：入场价 + `TakeProfitPoints * PriceStep`。
  - 空单：入场价 − `TakeProfitPoints * PriceStep`。
- **追踪止损**
  - 当未实现收益超过 `TrailingStopPoints * PriceStep` 时，按照每根收盘价更新止损。
  - 多单把止损提高到 `closePrice - TrailingDistance`（若高于当前止损）。
  - 空单把止损降低到 `closePrice + TrailingDistance`（若低于当前止损）。
- 所有出场均使用市价单执行。一旦新蜡烛触及止损或止盈，整笔仓位立即平仓。

## 参数
| 分组 | 名称 | 说明 | 默认值 |
| --- | --- | --- | --- |
| 通用 | `CandleType` | 计算所用的蜡烛类型，建议保持为 60 分钟。 | `TimeFrame(60m)` |
| 通用 | `SecurityCode` | 期望的品种代码。留空则不做限制。 | `EURUSD` |
| 区间过滤 | `DiffMinPoints` | 允许交易的最小三蜡烛区间（点）。 | `18` |
| 区间过滤 | `DiffMaxPoints` | 允许交易的最大三蜡烛区间（点）。 | `28` |
| 交易时段 | `EnableTimeFilter` | 是否启用时间过滤。 | `true` |
| 交易时段 | `OpenHour` | 交易窗口的起始小时（0–23）。策略同样允许紧随其后的一个小时。 | `0` |
| 风控 | `TakeProfitPoints` | 止盈距离（点），为 0 时表示不开启。 | `8` |
| 风控 | `TrailingStopPoints` | 追踪止损距离（点），为 0 时表示不追踪。 | `6` |

## 使用建议
- 下单手数由 `Strategy.Volume` 控制，请根据账户合约规模调整。
- 请确保标的提供有效的 `PriceStep`。若为空，策略会回退到 1 并记录警告。
- 原版 EA 支持基于余额的简易资金管理，示例代码采用固定手数。如果需要，可自行扩展下单量逻辑。
- 建议先在模拟环境中验证策略。追踪止损假设当蜡烛极值穿越价格时能够成交，极端行情可能导致额外滑点。
