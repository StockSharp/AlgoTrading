# Flat 001a — стратегия торговли во флэте

## Общее описание
Flat 001a — скальперская система для часового графика EURUSD. Она анализирует три последние завершённые свечи и измеряет расстояние между максимальным максимумом и минимальным минимумом. Если диапазон укладывается в заданное количество пунктов, стратегия предполагает, что рынок остаётся во флэте, и ищет сделки против крайних движений внутри этого канала. Входы происходят, когда цена закрытия оказывается в верхней или нижней четверти диапазона, после чего сразу выставляются защитные уровни.

Исходный советник MQL4 работал только с EURUSD на таймфрейме H1 и отказывался торговать при несоответствии символа или периода. В портированной версии сохранены эти настройки по умолчанию (EURUSD, 60-минутные свечи), а логика входов, стоп-лоссов, тейк-профитов и трейлинг-стопов полностью воспроизведена на StockSharp.

## Данные и индикаторы
- Индикаторы `Highest` и `Lowest` с периодом 3 отслеживают верхнюю и нижнюю границы трёх последних свечей.
- Параметр типа свечей по умолчанию задаёт 60-минутные бары, что повторяет требование исходного эксперта.
- Дополнительные индикаторы не используются: стратегия опирается только на экстремумы цены.

## Логика входа
1. Стратегия обрабатывает только завершённые свечи подписки.
2. Проверяется соответствие кода инструмента параметру `SecurityCode` (по умолчанию `EURUSD`). При несовпадении стратегия остаётся в режиме ожидания.
3. Применяется опциональный фильтр торговых часов. По умолчанию входы разрешены в двухчасовом окне, начиная с полуночи (часы 0 и 1). Фильтр можно отключить.
4. Рассчитывается диапазон трёх свечей `range = highest - lowest` и переводится в пункты с помощью `PriceStep` инструмента.
5. Продолжение возможно только при условии, что диапазон находится между `DiffMinPoints` и `DiffMaxPoints`.
6. Если цена закрытия попадает в нижнюю четверть диапазона и позиций нет, открывается длинная позиция.
7. Если цена закрытия попадает в верхнюю четверть диапазона и позиций нет, открывается короткая позиция.

## Управление позицией
- **Начальный стоп-лосс**
  - Для покупок: `lowest - range / 3`.
  - Для продаж: `highest + range / 3`.
- **Тейк-профит**
  - Для покупок: цена входа + `TakeProfitPoints * PriceStep`.
  - Для продаж: цена входа − `TakeProfitPoints * PriceStep`.
- **Трейлинг-стоп**
  - Как только нереализованная прибыль превышает `TrailingStopPoints * PriceStep`, стоп-лосс подтягивается по закрытиям свечей.
  - Для покупок стоп переносится на `closePrice - TrailingDistance`, если новое значение выше текущего.
  - Для продаж стоп переносится на `closePrice + TrailingDistance`, если новое значение ниже текущего.
- Выходы выполняются рыночными ордерами. Как только очередная свеча пробивает стоп или тейк, позиция закрывается полностью.

## Параметры
| Группа | Имя | Описание | Значение по умолчанию |
| --- | --- | --- | --- |
| Общие | `CandleType` | Тип свечей для расчётов. Для повторения оригинала используйте 60-минутные бары. | `TimeFrame(60m)` |
| Общие | `SecurityCode` | Ожидаемый код инструмента. Оставьте пустым, чтобы торговать любым инструментом. | `EURUSD` |
| Фильтр диапазона | `DiffMinPoints` | Минимальный диапазон трёх свечей в пунктах, допускающий торговлю. | `18` |
| Фильтр диапазона | `DiffMaxPoints` | Максимальный диапазон трёх свечей в пунктах, при превышении которого сделки запрещены. | `28` |
| Торговое окно | `EnableTimeFilter` | Включение/отключение фильтра по часам. | `true` |
| Торговое окно | `OpenHour` | Начальный час (0–23) торгового окна. Стратегия также допускает следующий час. | `0` |
| Риск-менеджмент | `TakeProfitPoints` | Дистанция тейк-профита в пунктах. Ноль отключает тейк. | `8` |
| Риск-менеджмент | `TrailingStopPoints` | Дистанция трейлинг-стопа в пунктах. Ноль отключает подтягивание. | `6` |

## Практические рекомендации
- Объём сделок задаётся свойством `Strategy.Volume`. Убедитесь, что он соответствует контракту брокера.
- Инструмент должен предоставлять корректный `PriceStep`. При его отсутствии стратегия использует значение `1` и записывает предупреждение в лог.
- В оригинале присутствовал простой мани-менеджмент, рассчитывающий лоты от свободной маржи. В версии для StockSharp объём фиксированный; при необходимости добавьте собственную логику.
- Перед запуском на реальном счёте протестируйте стратегию в симуляторе. При резких движениях возможен проскальзывание относительно рассчитанных уровней защиты.
