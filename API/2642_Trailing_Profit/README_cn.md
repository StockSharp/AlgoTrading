# Trailing Profit 策略
[English](README.md) | [Русский](README_ru.md)

该 StockSharp 策略复刻了 MetaTrader 专家顾问“Trailing_Profit”。策略跟踪由自身开立的所有仓位的浮动利润，一旦利润自峰值回撤到设定比例，就会锁定收益。

## 策略逻辑

1. 策略订阅逐笔成交数据，并按照设定的时间间隔（默认 3 秒）检查一次利润，避免重复计算。
2. 组合权益被视为可用资金与未平仓头寸市值之和。在没有头寸时会记录当前权益，之后以当前权益减去该基准来衡量浮动利润。
3. 当浮动利润超过激活阈值时启用拖尾逻辑。策略记录利润峰值，并计算拖尾阈值 `峰值 × (1 - 百分比 / 100)`。
4. 每当创出新的权益高点时都会重新上调拖尾阈值，与原始 EA 的行为一致。
5. 如果利润跌至拖尾阈值或更低，策略会关闭所有受管控的仓位并输出锁定的收益；在全部平仓后内部状态重置。

这与原始脚本一致：`minimum_profit` 参数用于开启拖尾模式，`percent_of_profit` 指定允许回吐的利润比例。

## 参数

| 参数 | 默认值 | 说明 |
| --- | --- | --- |
| `PercentOfProfit` | 33 | 允许在峰值利润基础上回撤的百分比，超过时触发清仓。 |
| `MinimumProfit` | 1000 | 启动拖尾模式所需的浮动利润。 |
| `CheckInterval` | 00:00:03 | 连续利润检查之间的最短时间间隔。 |

所有参数都可在 StockSharp Designer/Runner 中优化，以适配不同品种与风险偏好。

## 实现说明

- 利润通过 `Portfolio.CurrentValue` 计算，从而在不同券商或多次分批成交的情形下仍可得到统一的浮动收益估计。
- 使用 `SubscribeTrades()` 获取类似 MetaTrader `OnTick` 的逐笔事件，并在处理函数中强制执行最小检查间隔。
- 通过 `ClosePosition()` 关闭主标的仓位，同时遍历 `Positions` 集合关闭其它关联仓位，以模拟“全部平仓”的行为。
- 启动时调用 `StartProtection()`，确保 StockSharp 的安全防护机制在利润管理期间保持生效。

## 使用方式

将该策略与负责入场的模块搭配使用。当浮动利润达到设定阈值后，拖尾机制会自动保护收益；在所有仓位平仓后，权益基准会复位，策略即可进入下一轮交易。
