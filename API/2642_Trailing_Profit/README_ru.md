# Стратегия Trailing Profit
[English](README.md) | [中文](README_cn.md)

Реализация StockSharp повторяет советник MetaTrader «Trailing_Profit». Стратегия отслеживает плавающую прибыль всех позиций, открытых самой стратегией, и фиксирует её, когда прибыль снижается на заданный процент от максимума.

## Логика стратегии

1. Стратегия подписывается на тиковые данные и проверяет прибыль не чаще одного раза за заданный интервал (по умолчанию 3 секунды), чтобы не выполнять лишние вычисления.
2. Капитал портфеля рассматривается как сумма свободных средств и стоимости открытых позиций. При отсутствии позиций стратегия запоминает текущее значение капитала и далее измеряет плавающую прибыль как разницу между текущим капиталом и этой базой.
3. Когда плавающая прибыль превышает порог активации, включается «хвостовое» сопровождение. Стратегия запоминает максимальную прибыль и вычисляет уровень отсечки `максимум × (1 - процент/100)`.
4. При каждом новом максимуме капитала уровень отсечки пересчитывается вверх, как и в исходном советнике.
5. Если прибыль снижается до уровня отсечки или ниже, стратегия закрывает все открытые позиции по отслеживаемым инструментам, фиксирует результат и после полного выхода обнуляет внутреннее состояние.

Так воспроизводится логика оригинала: параметр `minimum_profit` включает сопровождение, а `percent_of_profit` задаёт допустимую просадку от пика прибыли.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `PercentOfProfit` | 33 | Допустимая доля просадки от пикового значения плавающей прибыли перед закрытием позиций. |
| `MinimumProfit` | 1000 | Плавающая прибыль, необходимая для включения режима сопровождения. |
| `CheckInterval` | 00:00:03 | Минимальная пауза между проверками прибыли для ограничения нагрузки. |

Все параметры можно оптимизировать в StockSharp Designer/Runner под конкретный инструмент и профиль риска.

## Особенности реализации

- Прибыль берётся из `Portfolio.CurrentValue`, что даёт брокер-независимый способ оценить нереализованные результаты даже при частичных входах.
- Подписка `SubscribeTrades()` обеспечивает обработку тиков, аналогичную `OnTick` в MetaTrader. Обработчик соблюдает заданный интервал, поэтому проверка запускается не чаще указанного периода.
- Для базового инструмента вызывается `ClosePosition()`, а дополнительные позиции закрываются через коллекцию `Positions`, что повторяет поведение «закрыть все» в исходном советнике.
- При запуске активируется `StartProtection()`, чтобы стандартные защитные механизмы StockSharp оставались задействованы во время сопровождения прибыли.

## Использование

Запускайте стратегию вместе с любым модулем входа, который открывает позиции по выбранному инструменту. Когда плавающая прибыль достигнет порога активации, сопровождение автоматически защитит прибыль. После закрытия всех позиций базовый уровень капитала сбрасывается, и стратегия готова к новому циклу.
