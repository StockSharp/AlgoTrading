# Стратегия BullsBearsEyes EA

## Обзор
Данная стратегия представляет собой портирование советника **BullsBearsEyes EA** с платформы MetaTrader 5 на StockSharp. Для построения сигнала используются индикаторы Bulls Power и Bears Power, которые проходят через ту же четырёхступенчатую фильтрацию IIR, что и в оригинале. Полученное отношение принимает значения от 0 до 1 и отражает перевес продавцов или покупателей. Значение **0** трактуется как истощение продавцов и повод открыть длинную позицию, значение **1** — как ослабление покупателей и повод открыть короткую позицию. Расчёты выполняются только по закрывшимся свечам, полностью повторяя логику MQL-версии, которая анализировала `custom[1]` при появлении нового бара.

## Логика торговли
1. Подписка на выбранный тип свечей и привязка индикаторов Bulls Power и Bears Power.
2. После закрытия каждой свечи значения индикаторов пропускаются через каскад фильтров `L0`–`L3`.
3. Вычисляется отношение `CU / (CU + CD)`: если последовательность чисто медвежья, `CU` становится нулём; при чисто бычьей последовательности обнуляется `CD`.
4. Для генерации сигналов используется значение предыдущей свечи:
   - Предыдущее значение **0** ⇒ закрыть шорты и открыть лонг.
   - Предыдущее значение **1** ⇒ закрыть лонги и открыть шорт.
   - Промежуточные значения игнорируются, чтобы сохранить поведение оригинального советника.
5. Сделки отправляются с текущим объёмом `Volume`, при необходимости автоматические заявки закрывают противоположную позицию.

## Управление рисками
- **Stop Loss / Take Profit** — задаются в пунктах, далее переводятся в цены с учётом шага цены инструмента (поддерживаются 5- и 3-знаковые котировки).
- **Trailing Stop / Trailing Step** — полная копия логики EA: как только цена проходит `TrailingStop + TrailingStep`, стоп подтягивается, сохраняя расстояние `TrailingStop` от текущей цены.
- Защитные уровни пересчитываются при каждом изменении позиции, чтобы опираться на актуальную среднюю цену входа.
- Если максимум или минимум текущей свечи достигает защитного уровня, позиция закрывается целиком.

## Фильтр торговой сессии
- `Use Time Control` — включает/отключает фильтр по времени.
- `Start Hour` — начало разрешённой сессии (включительно, 0–23).
- `End Hour` — окончание сессии (исключительно, 0–23). Если `End Hour` меньше `Start Hour`, считается, что сессия продолжается через полночь.
Вне торгового окна стратегия не открывает новые позиции, но продолжает сопровождать текущие ордера и стопы.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `Period` | Период расчёта Bulls/Bears Power. | 13 |
| `Gamma` | Коэффициент сглаживания каскада фильтров (0–1). | 0.6 |
| `StopLossPips` | Размер стоп-лосса в пунктах. | 150 |
| `TakeProfitPips` | Размер тейк-профита в пунктах. | 150 |
| `TrailingStopPips` | Расстояние трейлинг-стопа (0 — отключено). | 25 |
| `TrailingStepPips` | Минимальное продвижение цены для подтягивания стопа. | 5 |
| `UseTimeControl` | Использовать фильтр торговой сессии. | true |
| `StartHour` | Час начала торговли. | 10 |
| `EndHour` | Час окончания торговли. | 16 |
| `CandleType` | Тип/таймфрейм свечей для анализа. | 1 час |

## Дополнительная информация
- Используется высокоуровневый API `SubscribeCandles().Bind(...)`, что избавляет от ручной обработки данных.
- Сигналы обрабатываются только для свечей в состоянии `CandleStates.Finished`.
- Если шаг цены инструмента неизвестен, размер пункта принимается равным 1, что позволяет запускать стратегию в тестовых окружениях.
- В исходном коде на C# присутствуют подробные комментарии на английском языке для упрощения сопоставления с MQL-версией и дальнейшей поддержки.
