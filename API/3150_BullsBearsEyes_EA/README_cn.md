# BullsBearsEyes EA 策略

## 概述
本策略是 MetaTrader 5 **BullsBearsEyes EA** 的 StockSharp 移植版本。它重新组合 Bulls Power 和 Bears Power 指标，并使用与原始 EA 相同的四级 IIR 平滑流程来获得 0 到 1 之间的比值，用于衡量多空力量。当比值跌至 **0** 时，意味着空头力量耗尽，策略准备做多；当比值升至 **1** 时，视为多头动能衰竭，策略准备做空。所有计算都基于已经收盘的 K 线，与 MQL 代码在新柱生成时读取 `custom[1]` 的行为一致。

## 交易逻辑
1. 订阅配置的 K 线数据，并绑定 Bulls Power 与 Bears Power 指标。
2. 对每根收盘 K 线执行与 EA 相同的四级平滑流程（`L0` 至 `L3`）。
3. 计算比值 `CU / (CU + CD)`，纯粹的空头序列会让 `CU` 变为 0，纯粹的多头序列会让 `CD` 变为 0。
4. 保存上一根 K 线的比值并据此生成信号：
   - 上一根比值等于 **0** ⇒ 先平仓空单，再开多单。
   - 上一根比值等于 **1** ⇒ 先平仓多单，再开空单。
   - 其他介于 0 与 1 之间的数值会被忽略，以保持与原始逻辑一致。
5. 使用当前 `Volume` 下单，并在进场前自动对冲掉反向持仓。

## 风险管理
- **止损 / 止盈**：以“点”为单位输入，通过检测合约最小变动单位自动换算为实际价格，兼容 5 位和 3 位报价的品种。
- **跟踪止损 / 止损步长**：完全复刻 EA 逻辑，当价格推进超过 `TrailingStop + TrailingStep` 时，将止损上移（或下移）以保持固定距离。
- 每当净持仓变化时都会重新计算保护价位，始终以最新的平均持仓价格为基准。
- 当前 K 线的最高/最低价触及保护价位时立即平仓全部仓位。

## 交易时段过滤
- `Use Time Control` – 是否启用交易时段过滤。
- `Start Hour` – 允许交易的起始小时（包含，0–23）。
- `End Hour` – 允许交易的结束小时（不包含，0–23）。若结束小时小于起始小时，则表示跨越午夜。
在禁入时间段内不会开新仓，但仍会维护已有仓位的止损和跟踪止损。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `Period` | Bulls/Bears Power 的计算周期。 | 13 |
| `Gamma` | 四级平滑滤波的系数 (0–1)。 | 0.6 |
| `StopLossPips` | 止损距离（点）。 | 150 |
| `TakeProfitPips` | 止盈距离（点）。 | 150 |
| `TrailingStopPips` | 跟踪止损距离（点，0 表示禁用）。 | 25 |
| `TrailingStepPips` | 启动跟踪止损所需的最小推进幅度。 | 5 |
| `UseTimeControl` | 是否启用交易时段过滤。 | true |
| `StartHour` | 允许交易的起始小时。 | 10 |
| `EndHour` | 允许交易的结束小时。 | 16 |
| `CandleType` | 用于分析的 K 线类型/周期。 | 1 小时 |

## 其他说明
- 使用高层 `SubscribeCandles().Bind(...)` API，无需手动管理历史数据。
- 仅在 `CandleStates.Finished`（K 线收盘）后处理信号，避免提前下单。
- 若证券最小报价步长未知，点值回退为 1，方便在模拟环境中运行。
- C# 代码内提供英文注释，帮助对照原始 MQL 逻辑并方便维护。
