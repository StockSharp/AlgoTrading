# Стратегия Rsi Test

## Обзор
`RsiTestStrategy` — порт адаптера MetaTrader 4 **RSI_Test** на высокоуровневый API StockSharp. Стратегия совмещает динамику RSI с подтверждением от свечных разрывов и управлением риском при расчёте объёма. Торговля ведётся только по завершённым свечам, что полностью повторяет логику исходного эксперта.

## Правила торговли
1. Рассчитывается индикатор RSI с периодом `RsiPeriod`.
2. Открывается покупка, когда RSI растёт из перепроданной зоны (`BuyLevel`) и текущая свеча открылась выше предыдущей.
3. Открывается продажа, когда RSI падает из перекупленной зоны (`SellLevel`) и текущая свеча открылась ниже предыдущей.
4. Соблюдается ограничение `MaxOpenPositions`. Значение `0` отключает лимит, в остальных случаях суммарный объём не превышает `MaxOpenPositions * Volume`.
5. Выход осуществляется лестничным трейлинг-стопом: как только цена проходит `TrailingDistanceSteps` шагов от средней цены входа, стоп переносится на тот же размер.
6. Тейк-профит не используется. Сделка закрывается по стопу либо после остановки стратегии.

## Управление объёмом и рисками
* Базовый объём вычисляется из `RiskPercentage` от текущей стоимости портфеля. Если у инструмента заполнены поля `Security.MarginBuy`/`Security.MarginSell`, используется фактическая маржа на лот; иначе применяется деление на цену закрытия.
* Объёмы округляются к `Security.VolumeStep` (или до двух знаков после запятой, если шаг неизвестен) и ограничиваются диапазоном `Security.MinVolume` — `Security.MaxVolume`.
* Чтобы отключить динамический расчёт объёма, установите `RiskPercentage` в `0`. В этом случае используется параметр `Volume`.

## Поведение трейлинг-стопа
* `TrailingDistanceSteps` задаётся в шагах цены (`Security.PriceStep`). Если шаг не определён, значение трактуется как абсолютное смещение.
* После достижения уровня активации (`вход + расстояние` для длинных, `вход − расстояние` для коротких) стоп фиксируется на одном-единственном «ступеньке» и далее не передвигается — как и в оригинальном коде.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `RsiPeriod` | Период расчёта RSI. | `14` |
| `BuyLevel` | Уровень перепроданности для поиска покупок. | `12` |
| `SellLevel` | Уровень перекупленности для поиска продаж. | `88` |
| `RiskPercentage` | Доля портфеля для расчёта объёма. `0` — отключить. | `10` |
| `TrailingDistanceSteps` | Расстояние в шагах цены до активации трейлинг-стопа. | `50` |
| `MaxOpenPositions` | Максимальное число одновременно открытых позиций (`0` — без ограничения). | `1` |
| `CandleType` | Таймфрейм используемых свечей. | `15` минут |
| `Volume` | Резервный объём при отключённом риск-менеджменте. | `1` |

## Рекомендации по использованию
1. Выбирайте инструмент с корректными `PriceStep`, `VolumeStep` и параметрами маржи, чтобы расчёт полностью совпадал с MT4.
2. Стратегия анализирует только закрытые свечи (`CandleStates.Finished`), поэтому тесты и реальная торговля должны использовать одинаковый таймфрейм.
3. Метод `StartProtection()` включён в `OnStarted`, что позволяет базовому механизму StockSharp контролировать остатки позиций.
4. Автоматический запуск оптимизации через глобальные переменные MetaTrader намеренно удалён. Все параметры настраиваются напрямую в StockSharp.
5. Для корректного риск-менеджмента необходим портфель с актуальным значением `Portfolio.CurrentValue`. При его отсутствии используется статический `Volume`.
