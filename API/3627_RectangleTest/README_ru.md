# Стратегия Rectangle Test

## Общее описание
Стратегия Rectangle Test переносит эксперта MetaTrader «RectangleTest» на высокоуровневый API StockSharp. Она выявляет консолидации в виде прямоугольника на выбранном таймфрейме, проверяет, что две скользящие средние и текущая цена остаются внутри диапазона, и открывает сделки при выходе из боковика по направлению быстрой EMA. Вся логика рассчитывается на закрытых свечах из настраиваемого источника.

## Логика работы
1. Подписка на основной поток свечей (по умолчанию часовые) и передача их в индикаторы:
   - **ExponentialMovingAverage (EMA)** с периодом `EmaPeriod`.
   - **SimpleMovingAverage (SMA)** с периодом `SmaPeriod`.
   - **Highest** и **Lowest** длиной `RangeCandles`, настроенные на чтение максимумов и минимумов свечей. Они формируют верхнюю и нижнюю границы прямоугольника и повторяют массивные расчёты из MQL.
2. После формирования индикаторов вычисляется высота прямоугольника в процентах относительно верхней границы. Только случаи, когда высота меньше `RectangleSizePercent`, считаются допустимыми консолидациями.
3. Дополнительно требуется, чтобы EMA, SMA и цена закрытия находились внутри диапазона — это реализует фильтр «бокового рынка» из оригинального эксперта.
4. **Условия для продажи**:
   - EMA располагается выше SMA.
   - Цена закрытия выше EMA (аналог условия `Ask > EMA` в MetaTrader).
   - Если открыта длинная позиция, она закрывается перед открытием шорта.
5. **Условия для покупки**:
   - EMA ниже SMA.
   - Цена закрытия ниже EMA (`Bid < EMA` в исходном коде).
   - Перед открытием лонга закрываются активные короткие позиции.
6. При каждом входе запоминаются ожидаемая цена и объём. Когда позиция возвращается к нулю, стратегия сравнивает цену выхода с ценой входа; убыточные сделки увеличивают дневной счётчик и блокируют новые сигналы после достижения `MaxLosingTradesPerDay`, что повторяет функцию `Loss()` из MQL.

## Управление рисками и объёмом
- Доступны два режима:
  - **Риск-менеджмент** (`UseRiskMoneyManagement = true`): объём рассчитывается по балансу портфеля, параметру `RiskPercent` и величине стоп-лосса `StopLossPoints`. Используются свойства инструмента `PriceStep`, `StepPrice` и `VolumeStep`, что повторяет лот-менеджмент MetaTrader.
  - **Фиксированный объём** (`UseRiskMoneyManagement = false`): заявки отправляются объёмом `FixedVolume`.
- После перехода из нулевой позиции в открытую вызываются `SetStopLoss` и `SetTakeProfit`, которые выставляют защитные ордера на расстоянии `StopLossPoints` и `TakeProfitPoints` (в шагах цены), аналогично передаче SL/TP в `m_trade.Sell/Buy`.
- Параметр `MaxLosingTradesPerDay` запрещает новые входы после заданного числа убыточных сделок в текущей дате.

## Временные фильтры
- Торговля разрешена только в интервале `TradeStartTime`–`TradeEndTime`. Помощник корректно обрабатывает как дневные интервалы, так и окна через полночь.
- Если `EnableTimeClose = true`, все позиции закрываются после наступления `TimeClose`, что соответствует входным параметрам `TimeCloseTrue` и `TimeClose` в MetaTrader.

## Отличия от версии MetaTrader
- Исходный советник рисовал прямоугольники на графике. В StockSharp расчёт диапазона выполняется индикаторами Highest/Lowest без создания графических объектов.
- Учёт убыточных сделок выполняется по ценам закрытия свечей, что передаёт смысл функции `Loss()` (количество убыточных сделок в день), оставаясь в рамках высокоуровневого API.
- Настройки типов исполнения ордеров (FOK/IOC) предоставляет инфраструктура StockSharp, поэтому дополнительной логики не требуется.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| -------- | --------------------- | -------- |
| `EmaPeriod` | 45 | Период быстрой EMA. |
| `SmaPeriod` | 200 | Период медленной SMA. |
| `RangeCandles` | 10 | Количество свечей в прямоугольнике. |
| `RectangleSizePercent` | 0.5 | Максимальная высота прямоугольника (в процентах). |
| `StopLossPoints` | 250 | Стоп-лосс в шагах цены. |
| `TakeProfitPoints` | 750 | Тейк-профит в шагах цены. |
| `UseRiskMoneyManagement` | true | Переключение между риск- и фиксированным объёмом. |
| `RiskPercent` | 1 | Процент капитала в риске на сделку. |
| `FixedVolume` | 1 | Объём сделок в фиксированном режиме. |
| `MaxLosingTradesPerDay` | 1 | Максимум убыточных сделок в день. |
| `TradeStartTime` | 03:00 | Время начала торговли. |
| `TradeEndTime` | 22:50 | Время окончания генерации новых сигналов. |
| `EnableTimeClose` | false | Включение закрытия по времени. |
| `TimeClose` | 23:00 | Время принудительного закрытия позиций. |
| `CandleType` | часовые свечи | Основной источник свечей. |

## Визуализация
При наличии области графика стратегия отображает цену, быструю и медленную средние и собственные сделки, что помогает отследить моменты пробоя диапазона.
