# 2692 MACD Stochastic Strategy

## Обзор
Эта стратегия представляет собой перенос советника MetaTrader 5 «MACD Stochastic» на платформу StockSharp. Логика сочетает пересечение линий MACD с дополнительной проверкой стохастика и допускает сделки только внутри трёх задаваемых внутридневных торговых окон. Для каждой позиции используются стоп-лосс и тейк-профит, выраженные в пунктах, а также опциональное трейлинг-сопровождение, которое переводит стоп в безубыток после достижения заданной прибыли.

## Индикаторы
- **MACD** – основная система сигналов, фиксирующая пересечения быстрой и медленной экспоненциальных средних с их сигнальной линией.
- **Стохастический осциллятор** – необязательный фильтр, который подтверждает сигналы MACD, требуя свежего пересечения линий %K и %D в сторону предполагаемой сделки.

## Торговая логика
### Условия для длинной позиции
1. Главная линия MACD пересекает сигнальную снизу вверх, и обе линии находятся ниже нулевой отметки.
2. На текущем баре ещё не открывалась позиция (стратегия открывает не более одной сделки на свечу).
3. Локальное время инструмента находится внутри любого из разрешённых торговых интервалов.
4. При включённом фильтре стохастика текущая %K выше %D, а значение *StochasticBarsToCheck* баров назад демонстрировало обратную ситуацию, что подтверждает новое бычье пересечение.

### Условия для короткой позиции
1. Линия MACD пересекает сигнальную сверху вниз, при этом обе находятся выше нуля.
2. Позиция отсутствует и текущая свеча ещё не использовалась для входа.
3. Время попадает в одну из активных сессий.
4. При активном фильтре стохастика текущая %K ниже %D, а значения несколько баров назад показывали противоположное соотношение.

### Сопровождение позиции
- **Стоп-лосс / тейк-профит** – рассчитываются в пунктах с учётом шага цены инструмента. Для трёх- и пятизначных котировок шаг увеличивается в десять раз, чтобы приблизиться к стандартному пункту.
- **Трейлинг-стоп** – начинает работать после достижения прибыли не менее *WhenSetNoLossStopPips* пунктов:
  - Для длинных позиций требуется исходный стоп-лосс. Стоп повышается на *TrailingStopPips*, если он остаётся минимум на *TrailingStepPips + TrailingStopPips* пунктов ниже текущей цены закрытия и выше уровня безубытка (*NoLossStopPips*).
  - Для коротких позиций стоп смещается вниз при аналогичных ограничениях. Если исходный стоп отсутствует, алгоритм может выставить безубыточный уровень на расстоянии *NoLossStopPips* после достаточного движения цены.
- **Фиксация прибыли или убытка** – при достижении свечой уровней стопа или тейка позиция закрывается рыночным ордером, внутренние переменные сбрасываются.

## Параметры
- **MacdFastPeriod, MacdSlowPeriod, MacdSignalPeriod** – настройки MACD.
- **UseStochastic** – включает фильтр стохастика.
- **StochasticBarsToCheck, StochasticLength, StochasticKPeriod, StochasticDPeriod** – параметры осциллятора.
- **Volume** – объём сделки в лотах.
- **StopLossPips, TakeProfitPips** – начальные расстояния стопа и тейка.
- **TrailingStopPips, TrailingStepPips** – параметры трейлинг-стопа.
- **NoLossStopPips, WhenSetNoLossStopPips** – смещение уровня безубытка и порог активации трейлинга.
- **MaxPositions** – сохранён для совместимости; в StockSharp стратегия оперирует одной нетто-позицией.
- **Session1/2/3 Start-End** – временные окна, в пределах которых разрешена торговля. Чтобы отключить окно, установите начало и конец в `00:00`.
- **CandleType** – тип свечей, используемых для генерации сигналов.

## Дополнительные замечания
- Все решения принимаются по завершённым свечам, вход возможен только один раз на бар.
- Точность расчёта пунктов зависит от корректного шага цены (`PriceStep`) в данных по инструменту.
- Хранение истории стохастика реализовано через небольшую очередь, что позволяет работать на высокоуровневом API без прямого доступа к буферам индикатора.
