# Percentage Crossover 策略
[English](README.md) | [Русский](README_ru.md)

该策略复刻了 MetaTrader 专家 `Exp_PercentageCrossover` 的行为。它基于 Percentage Crossover 指标的方向进行交易。该指标绘制一条跟随价格的轨迹线，这条线只能在当前收盘价上下固定百分比的通道内移动，线条的斜率用来判断市场状态并生成信号。

## 思路

1. 在每根完成的 K 线收盘时，指标都会保留上一根线的数值。
2. 当收盘价把轨迹线向上推高超过此前数值，并且幅度不少于 `percent` 所设定的百分比时，线条被视为向上更新。
3. 当收盘价把轨迹线向下拉低超过此前数值，同样达到设定百分比时，线条被视为向下更新。
4. 如果收盘价保持在百分比通道内部，线条保持水平并延续上一次的颜色。

线条颜色与 MetaTrader 中的解释一致：

- **颜色索引 0（紫色）** —— 轨迹线上升，表示多头环境。
- **颜色索引 1（橙色）** —— 轨迹线下降，表示空头环境。

## 交易规则

### 多头入场
- 仅在 `BuyPosOpen = true` 时启用。
- 按照 `SignalBar` 参数指定的那根已完成 K 线进行判断（1 表示最近一根收盘 K 线）。
- 当该 K 线由颜色 1 切换为颜色 0 时开多。

### 空头入场
- 仅在 `SellPosOpen = true` 时启用。
- 使用同一根 `SignalBar` K 线。
- 当该 K 线由颜色 0 切换为颜色 1 时开空。

### 持仓管理
- 若 `BuyPosClose = true`，只要当前监测的 K 线颜色为 1，所有多头仓位都会被立即平掉。
- 若 `SellPosClose = true`，只要监测的 K 线颜色为 0，所有空头仓位都会被立即平掉。
- 当 `UseTimeFilter = true` 且当前时间不在设定的交易窗口内时，策略会立刻平仓并忽略新信号，直到重新进入允许的时间范围。
- 策略通过 `BuyMarket()` 与 `SellMarket()` 下单，实际数量由策略的 `Volume` 属性决定。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `Percent` | 轨迹线与价格之间的百分比通道，数值越大，线条越迟钝。 | `1` |
| `SignalBar` | 参与判断的已收盘 K 线编号（1 = 最近一根）。必须大于 0。 | `1` |
| `BuyPosOpen` / `SellPosOpen` | 是否允许开多或开空。 | `true` |
| `BuyPosClose` / `SellPosClose` | 是否启用多头或空头的平仓逻辑。 | `true` |
| `UseTimeFilter` | 启用交易时间过滤。 | `true` |
| `StartHour` / `StartMinute` | 交易窗口开始的小时与分钟。 | `0` / `0` |
| `EndHour` / `EndMinute` | 交易窗口结束的小时与分钟。 | `23` / `59` |
| `CandleType` | 用于计算指标与信号的 K 线周期。 | `4h` |

## 说明

- 时间过滤严格遵循原始 EA 的实现。当 `StartHour > EndHour` 时会形成跨日的交易窗口，但仍需要当前分钟数大于等于 `StartMinute` 才会生效。
- `SignalBar` 只针对已经收盘的 K 线进行运算。把该值设为 `1` 可以完全对应 MetaTrader 的默认设置。
- 策略没有内置的止损或止盈。请通过外部风控或调整百分比与时间窗口来控制风险。
