# Two Pending Orders 2

## Обзор
Эта стратегия представляет собой портирование эксперта MetaTrader **«Two pending orders 2»** на платформу StockSharp. Алгоритм постоянно поддерживает две симметричные отложенные заявки вокруг текущей цены и управляет позицией первой сработавшей стороны с помощью настраиваемых стоп-лосса, тейк-профита и трейлинг-стопа. Конверсия выполнена на высокоуровневом API StockSharp и сохраняет ключевую логику оригинала, предоставляя все параметры в виде настраиваемых свойств стратегии.

## Логика торговли
1. Стратегия подписывается на выбранную серию свечей (по умолчанию дневные). Завершение свечи является моментом принятия нового торгового решения.
2. Перед установкой свежих уровней отменяются истекшие и активные отложенные заявки, поэтому на рынке остаются только актуальные ордера.
3. Если текущий спред не превышает допустимый максимум и число позиций/ордеров ниже заданного лимита, размещаются две симметричные заявки:
   - В режиме **Stop** (по умолчанию) выставляются buy stop выше рынка и sell stop ниже рынка.
   - В режиме **Limit** выставляются buy limit ниже рынка и sell limit выше рынка.
   - Флаг *Reverse Levels* меняет направления местами, что соответствует переключателю reverse в оригинальном советнике.
4. Цены заявок смещаются относительно текущих bid/ask на величину параметра *Pending Indent*. Если новый уровень находится ближе к существующим позициям, чем значение *Min Step*, ордер не ставится.
5. Для отложенных ордеров можно задать срок действия. По его истечении заявки автоматически отменяются.

## Управление позициями
- После срабатывания ордера стратегия отслеживает среднюю цену входа и объем по соответствующей стороне. Сделки противоположного направления сначала сокращают или закрывают текущую позицию и лишь затем открывают новую.
- Длинные позиции закрываются при выполнении любого из условий:
  - Цена достигает уровня стоп-лосса ниже средней цены входа.
  - Цена достигает уровня тейк-профита выше средней цены входа.
  - Прибыль превышает порог активации трейлинг-стопа и последующее откатное движение касается перенесенного стопа (движение происходит ступенчато).
- Короткие позиции используют зеркальные проверки с инвертированными сравнениями цен.
- Если включен параметр *Only One Position*, стратегия ждет полного закрытия текущей позиции перед постановкой новых заявок.

## Параметры
| Имя | Описание |
| --- | --- |
| `StopLossPoints` | Расстояние до защитного стоп-лосса в пунктах (0 — без стопа). |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах (0 — без тейка). |
| `MaxPositions` | Максимальное количество одновременно активных позиций и ордеров. |
| `MinStepPoints` | Минимальный допуск между текущими позициями и ценами новых ордеров. |
| `TrailingActivatePoints` | Порог прибыли для активации трейлинг-стопа (0 — отключен). |
| `TrailingStopPoints` | Расстояние трейлинг-стопа после активации. |
| `TrailingStepPoints` | Минимальный шаг, на который переносится трейлинг-стоп. |
| `TradeMode` | Разрешенное направление торговли: `Buy`, `Sell` или `BuySell`. |
| `PendingType` | Тип отложенных заявок: `Stop` или `Limit`. |
| `PendingExpirationMinutes` | Срок действия ордеров в минутах (`0` — без ограничения). |
| `PendingIndentPoints` | Отступ от текущего рынка при расчете цен отложенных ордеров. |
| `PendingMaxSpreadPoints` | Максимально допустимый спред для постановки ордеров (`0` — без фильтра). |
| `OnlyOnePosition` | При значении `true` не позволяет держать более одной позиции одновременно. |
| `ReverseLevels` | Меняет местами направления ордеров, реализуя обратный режим оригинала. |
| `CandleType` | Таймфрейм, по закрытию свечи которого оцениваются сигналы (по умолчанию день). |

## Примечания
- Все дистанции задаются в пунктах и автоматически переводятся в цену через размер шага котировки инструмента.
- Для постановки и отмены заявок используются высокоуровневые методы StockSharp (`BuyStop`, `SellStop`, `BuyLimit`, `SellLimit`, `CancelActiveOrders`).
- Логика трейлинг-стопа проверяется по завершенным свечам. Для более быстрого реагирования выберите меньший `CandleType`.
