# Стратегия RAVIiAO (StockSharp)

## Обзор
**Стратегия RAVIiAO** переносит советник MetaTrader 4 «RAVIiAO» на высокоуровневый API StockSharp. Система ждёт закрытия новой
свечи, оценивает наклон осциллятора RAVI и одновременно анализирует осциллятор Acceleration/Deceleration (AC) Билла Уильямса.
Если оба индикатора подтверждают однонаправленный тренд, позиция открывается по рынку без задержек. Параметры оригинала — периоды
средних, порог, дистанции стопов и объём заявки — сохранены, поэтому поведение стратегии полностью соответствует MQL-версии.

## Последовательность работы
1. **Подписка на свечи** — стратегия подписывается на настраиваемый таймфрейм (по умолчанию 30-минутные свечи).
2. **Расчёт индикаторов** — после закрытия свечи обновляются две скользящие средние для построения RAVI, а те же данные
   подаются в связку «Awesome Oscillator + SMA(5)», что даёт значение AC.
3. **Буферизация значений** — последняя завершённая свеча сохраняется как «бар 1», предыдущая — как «бар 2», что напрямую
   соответствует вызовам `iCustom(...,1)` и `iCustom(...,2)` в MetaTrader.
4. **Решение об открытии** — длинная позиция появляется при выполнении условий `AC[1] > AC[2] > 0` и `RAVI[1] > RAVI[2] > Threshold`.
   Для короткой позиции условия зеркальные.
5. **Риск-контроль** — сразу после входа фиксируются уровни стоп-лосса и тейк-профита в пунктах (`StopLossPoints * PriceStep`).
   Каждый бар проверяется по минимуму/максимуму на предмет пробоя защитных уровней.
6. **Сброс состояния** — при срабатывании защитных уровней позиция закрывается рыночной заявкой, внутренние буферы очищаются и
   стратегия готова к следующему сигналу.

## Торговые правила
- **Покупка**
  - Значение AC на предыдущем баре выше, чем на более раннем баре, и оба значения положительные.
  - Значение RAVI на предыдущем баре выше порога и выше, чем на баре №2.
  - На момент сигнала позиция отсутствует.
- **Продажа**
  - Значение AC на предыдущем баре ниже, чем на баре №2, и оба значения отрицательные.
  - Значение RAVI на предыдущем баре ниже отрицательного порога и ниже значения на баре №2.
  - В момент появления сигнала позиция отсутствует.
- **Выход**
  - Стоп-лосс и тейк-профит задаются в пунктах и пересчитываются в цены через `PriceStep`.
  - Пробои определяются по экстремумам свечи (минимум для стопа в лонге, максимум для стопа в шорте и т. д.), после чего позиция
    закрывается рыночной заявкой, что имитирует MT4-логику SL/TP.

## Параметры
| Имя | Описание |
| --- | --- |
| `CandleType` | Таймфрейм свечей для расчётов (по умолчанию 30 минут). |
| `FastLength` | Период быстрой средней в осцилляторе RAVI. |
| `SlowLength` | Период медленной средней в осцилляторе RAVI. |
| `Threshold` | Минимальная абсолютная величина RAVI для подтверждения тренда. |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах (умножается на `PriceStep`). |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах. |
| `TradeVolume` | Объём рыночной заявки при каждом входе. |

## Особенности переноса
- Внутренние буферы хранят значения двух последних баров, поэтому решение на свече *n* использует метрики предыдущего бара,
  аналогично `AC[1]` и `RAVI[1]` в MetaTrader.
- Индикатор AC построен как разница между Awesome Oscillator и его 5-периодной SMA, что повторяет расчёт из MT4.
- Вместо регистрации стоп-заявок используется контроль экстремумов свечей, что сохраняет поведение SL/TP и лучше вписывается в
  архитектуру StockSharp.

## Рекомендации по применению
- Убедитесь, что у инструмента корректно задан шаг цены (`PriceStep`), иначе дистанции защитных уровней будут отличаться от MT4.
- Для адаптации к другим рынкам оптимизируйте `Threshold`, `FastLength` и `SlowLength`.
- Дополните стратегию риск-параметрами уровня портфеля или коннектора, чтобы повысить устойчивость в реальной торговле.
