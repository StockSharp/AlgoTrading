# Стратегия Multi Arbitration 1.1xx

## Обзор
Стратегия переносит логику советника MetaTrader «Multi Arbitration 1.1xx» в экосистему StockSharp. Она одновременно работает с основным инструментом (`Security`) и вторым настраиваемым инструментом, сравнивает текущую цену закрытия с лучшими ценами открытых покупок и продаж и добавляет позиции при появлении новых экстремумов.

## Параметры
- **Signal Candles (`CandleType`)** – таймфрейм свечей, по которым формируются сигналы для обоих инструментов (по умолчанию 15 минут). Фактический таймфрейм графика может отличаться, поскольку стратегия использует собственную подписку на свечи.
- **Second Security (`SecondSecurity`)** – второй инструмент, торгуемый вместе с основным. Обязательно укажите его перед запуском.
- **Profit Target (`ProfitTarget`)** – целевая прибыль портфеля (текущее значение портфеля минус стартовое), при достижении которой все позиции закрываются.
- **Max Open Units (`MaxOpenUnits`)** – ограничение на суммарную абсолютную величину позиций по обоим инструментам. Если лимит превышен и портфель находится в плюсе, стратегия принудительно фиксирует результат.
- **Second Volume (`SecondVolume`)** – объём заявки для второго инструмента. Основной инструмент использует стандартное свойство `Volume` стратегии.

## Логика торговли
1. Стратегия подписывается на свечи выбранного таймфрейма для обоих инструментов и обрабатывает только завершённые свечи с одинаковым временем открытия.
2. Для каждого инструмента сохраняются минимальная цена покупки и максимальная цена продажи. При пробое вниз фиксированной цены покупки открывается новая длинная позиция (или инициируется первая), при пробое вверх фиксированной цены продажи открывается короткая позиция.
3. Работа ведётся в режиме неттинга. Если по инструменту нет позиции, следующая обработка по умолчанию откроет длинную сделку, чтобы активировать сетку.
4. Перед размещением заявок оценивается совокупное плечо (`|pos1| + |pos2|`). Если оно превышает `MaxOpenUnits`, а портфель прибыльный, позиции закрываются для снижения риска.
5. Когда накопленная прибыль превосходит `ProfitTarget`, стратегия закрывает позиции по обоим инструментам и сбрасывает внутренние уровни.

## Отличия от оригинального советника
- В StockSharp используются неттинговые счета, поэтому хеджевые позиции «покупка + продажа» (и закрытие через `PositionCloseBy`) заменены управлением суммарным нетто-положением.
- Проверка минимального лота и повторные попытки выставления заявок из MQL упрощены: для обоих инструментов используются постоянные объёмы, а проверку исполнения берёт на себя платформа.
- Проверки торговых разрешений и режимов исполнения выполняются инфраструктурой StockSharp и не дублируются в коде.

## Рекомендации по использованию
- Перед стартом заполните параметр `SecondSecurity` и убедитесь, что коннектор отдаёт котировки по обоим инструментам.
- Подберите значения `Volume` и `SecondVolume` под требования конкретных площадок.
- Желательно использовать источник данных с синхронными временными метками по инструментам, поскольку стратегия ждёт совпадения времени открытия свечей.
