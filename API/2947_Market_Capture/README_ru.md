# Стратегия Market Capture

## Обзор
Стратегия Market Capture повторяет логику оригинального советника для MetaTrader 5. Алгоритм строит динамическую сетку вокруг перемещающегося ценового центра и открывает «зеркальные» позиции, когда цена колеблется около него. Сделки распределяются выше и ниже центра с фиксированными целями по прибыли, а контрольные точки по величине капитала определяют, когда необходимо закрыть наиболее убыточные позиции.

## Правила торговли
- **Центральный уровень** – внутренняя переменная задаётся по закрытию первой свечи. Если цена уходит дальше настроенного шага сетки, центр последовательно сдвигается за ценой.
- **Стартовый шорт** – для соответствия MQL-версии можно сразу после запуска открыть начальную короткую позицию.
- **Входы в лонг** – разрешены, когда текущий закрытие выше центра, а предыдущая свеча опускалась ниже него. Дополнительная проверка гарантирует отсутствие другой длинной позиции рядом с тем же уровнем.
- **Входы в шорт** – разрешены, когда закрытие ниже центра, а предыдущая свеча поднималась выше него. Аналогичный фильтр не даёт открывать повторные короткие сделки.
- **Фиксация прибыли** – для каждой сделки сохраняется целевой уровень, отстоящий от цены входа на заданное число шагов цены. Достижение цели (high для лонга или low для шорта) приводит к закрытию рыночным ордером.
- **Управление капиталом** – отслеживается стоимость портфеля. При росте капитала на заданный процент закрывается несколько наиболее убыточных позиций, что фиксирует прибыль. При падении на другой процент выполняется аналогичное сокращение риска. После каждого срабатывания границы база для расчёта обновляется.

## Параметры
- `Enable Long` / `Enable Short` – включение сделок в каждом направлении.
- `Grid Steps` – шаг сетки в единицах ценового шага инструмента.
- `Take Profit Steps` – расстояние до цели в шагах цены.
- `Open Initial Short` – открыть стартовую короткую позицию после запуска.
- `Use Equity Target` – правило закрытия убыточных сделок после прироста капитала.
- `Track Drawdown` – правило закрытия убыточных сделок при просадке.
- `Equity Gain %` / `Equity Loss %` – процент изменения капитала для срабатывания каждого правила.
- `Loss Trades Up` / `Loss Trades Down` – максимально закрываемое число убыточных позиций при срабатывании правил.
- `Candle Type` – таймфрейм или тип свечей, на которых выполняется расчёт.
- `Volume` (свойство стратегии) – объём каждой рыночной заявки.

## Примечания
- Стратегия ведёт собственный учёт открытых сделок, чтобы приблизить поведение к хеджевому подходу оригинального советника в условиях неттинговой модели StockSharp.
- Параметры дистанций умножаются на ценовой шаг инструмента; убедитесь, что для инструмента задано корректное значение `PriceStep`.
- Логика работает только по завершённым свечам. Выберите тип свечей, соответствующий требуемому горизонту торговли: от внутридневных до более широких сеток.
