# Стратегия Multi Arbitration

## Общее описание
**Multi Arbitration Strategy** — это порт экспертного советника MetaTrader "Multi_arbitration 1.000" на платформу StockSharp. Оригинальный советник постоянно анализирует уже открытые длинные и короткие позиции, добавляет сделки в сторону с меньшей плавающей прибылью и закрывает все позиции, когда совокупный результат достигает целевого значения. Версия на C# сохраняет эту идею и адаптирует её к неттинговой модели позиций и высокоуровневому API StockSharp.

Ключевые особенности:
- Первая завершённая свеча после запуска приводит к открытию длинной позиции с заданным объёмом.
- На каждой свече стратегия сравнивает плавающий результат текущего направления с потенциальным результатом противоположного направления.
- При достижении целевой прибыли или при превышении лимита по количеству позиций стратегия полностью закрывает портфель.
- Используются только рыночные заявки (`BuyMarket` / `SellMarket`), что упрощает логику и ускоряет исполнение.

## Логика торговли
1. **Начальная сделка.** Как только поступает первая завершённая свеча, стратегия отправляет рыночную заявку на покупку с заданным объёмом — так воспроизводится поведение MQL5-советника.
2. **Сравнение прибыли.** Для каждой завершённой свечи рассчитываются плавающие результаты:
   - Длинная позиция: `(Close - Entry) * Volume`
   - Короткая позиция: `(Entry - Close) * Volume`
3. **Выбор направления.** Если альтернативное направление выглядит выгоднее текущего, стратегия разворачивает позицию — заявка выставляется таким объёмом, чтобы закрыть текущую позицию и открыть новую в обратную сторону. При отсутствии открытых позиций алгоритм по умолчанию открывает длинную сделку.
4. **Ограничение по позициям.** Параметр `MaxOpenPositions` имитирует проверку `LimitOrders()` в MetaTrader. Если суммарное количество длинных и коротких позиций достигает этого порога и стратегия находится в плюсе, портфель закрывается.
5. **Выход по прибыли.** Когда прибыль по счёту (реализованная и плавающая) превышает `ProfitForClose`, стратегия закрывает все позиции — аналог условия `Equity - Balance > ProfitFoClose` в исходном коде.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| -------- | -------- | --------------------- |
| `TradeVolume` | Объём каждой рыночной заявки. Аналог минимального лота в исходном советнике. | `1` |
| `ProfitForClose` | Порог прибыли, при превышении которого портфель закрывается полностью. | `300` |
| `MaxOpenPositions` | Максимально допустимое количество одновременно открытых позиций. После достижения лимита стратегия закрывается. | `15` |
| `CandleType` | Тип свечей, используемый для синхронизации решений. По умолчанию — минутные свечи. | `1 minute candles` |

## Особенности реализации
- В StockSharp используется неттинговая система, поэтому в любой момент времени может существовать только одна чистая позиция. Разворот реализован через отправку заявки достаточного объёма, чтобы закрыть текущую позицию и открыть новую в противоположном направлении.
- Вызов `StartProtection()` подключает встроенные механизмы защиты (например, автоматическое закрытие позиции при остановке стратегии).
- Переменные `_entryPrice`, `_currentSide` и `_initialOrderPlaced` сбрасываются в `OnReseted`, что позволяет повторно запускать стратегию без артефактов.
- Обработка ведётся только по завершённым свечам (`CandleStates.Finished`), чтобы избежать двойного учёта прибыли.

## Рекомендации по использованию
- Настройте `TradeVolume` в соответствии с минимальным шагом объёма/лотностью инструмента.
- Порог `ProfitForClose` должен измеряться в валюте счёта, чтобы совпадать с расчётом PnL.
- Уменьшение `MaxOpenPositions` делает стратегию более консервативной, увеличение — позволяет дольше удерживать позицию до принудительного закрытия.
- Стратегия всегда начинает с покупки, поэтому запускайте её в тех условиях рынка, когда такая сделка допустима.

## Отличия от версии MetaTrader
- В MetaTrader разрешены одновременные длинные и короткие позиции (режим хеджирования). В StockSharp стратегия работает в неттинговом режиме и удерживает только одно чистое направление, но продолжает сравнивать потенциальную прибыль обеих сторон.
- Проверки терминала (разрешение алгоритмической торговли, типы исполнения, magic number) заменены на механизмы StockSharp: подписка на свечи и защиту через `StartProtection()`.
- Текстовые комментарии и вывод `Comment()` из оригинала не перенесены. Для мониторинга используйте систему логирования StockSharp.
