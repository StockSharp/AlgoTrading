# Стратегия ColorJFatl Digit NN3 MMRec (конверсия StockSharp)

Данная стратегия — адаптация советника MetaTrader 5 *Exp_ColorJFatl_Digit_NN3_MMRec* под высокоуровневый API StockSharp. В оригинале использовался пользовательский индикатор ColorJFatl_Digit и сложные алгоритмы манименеджмента. Версия на StockSharp переносит логику сигналов и организует её в три независимых модуля, работающих на разных таймфреймах.

Каждый модуль применяет скользящую Jurik (JMA) к выбранной цене свечи и отслеживает знак наклона индикатора. Положительный наклон воспринимается как бычий режим: модуль закрывает шорт и, при разрешении, открывает новую длинную позицию. Отрицательный наклон приводит к зеркальным действиям для коротких сделок. Все модули используют общий торговый счёт стратегии, поэтому всегда работает суммарная позиция.

## Логика торговли

1. Подписаться на свечи трёх таймфреймов (по умолчанию: 1 день, 8 часов, 3 часа).
2. Для каждой завершённой свечи:
   - Преобразовать цену свечи в выбранный тип (Close, Open, Typical, DeMark и т. д.).
   - Пропустить значение через Jurik MA для сглаживания.
   - Сравнить текущее значение JMA с предыдущим и определить направление наклона. Положительный наклон даёт состояние «up», отрицательный — «down», при нулевом наклоне состояние сохраняется.
   - Сохранить последовательность состояний с учётом задержки *SignalBar*, чтобы можно было реагировать на сигналы прошлых баров (как в оригинале).
3. При смене состояния:
   - **Переход вверх** — по необходимости закрыть шорт и открыть лонг указанным объёмом.
   - **Переход вниз** — закрыть лонг и открыть шорт.
4. Сигналы других модулей могут перевернуть или закрыть позицию в зависимости от разрешающих флагов.

Жёсткие стопы и тейки не задаются; вместо этого стратегия полагается на противоположные сигналы и защиту `StartProtection()`.

## Параметры

Параметры сгруппированы по модулям (A, B, C), что повторяет MT5-шаблон. В каждой группе доступны:

- **CandleType** — таймфрейм свечей.
- **JmaLength** — период Jurik MA.
- **JmaPhase** — хранится для документации; JMA в StockSharp не поддерживает фазу.
- **SignalBar** — число закрытых баров, через которое исполняется сигнал (0 — без задержки).
- **AppliedPrice** — способ расчёта цены (Close, Open, Median, Typical, Weighted, Simple, Quarter, TrendFollow, DeMark).
- **AllowBuyOpen / AllowSellOpen** — разрешение открывать сделки соответствующего направления.
- **AllowBuyClose / AllowSellClose** — разрешение закрывать позицию при обратном сигнале.
- **Volume** — объём ордера при открытии новой сделки.

Так как все модули работают с общей позицией, одновременно может существовать только один чистый лонг или шорт. Если модуль пытается открыть позицию в ту же сторону, где уже есть экспозиция, операция пропускается; при противоположной позиции она сначала закрывается (при включённых флагах), затем открывается новая.

## Рекомендации по использованию

- Метод `GetWorkingSecurities()` добавляет все используемые таймфреймы, чтобы торговая среда получила нужные серии свечей.
- Обработка выполняется только по завершённым свечам, что исключает перерисовку.
- Перечисление *AppliedPrice* повторяет варианты исходного индикатора, включая два трендовых режима и цену DeMark.
- Логика восстановления объёма из MQL-версии не переносилась; управление рисками можно реализовать через `StartProtection()` или настройку объёмов.
- Комментарии внутри кода на английском языке описывают этапы конверсии и упрощают дальнейшее сопровождение или портирование.

## Расширение

- Для подключения стопов или тейков замените вызов `StartProtection()` на нужную конфигурацию.
- При необходимости можно добавить новые модули, скопировав шаблон `SignalModule`.
- Для отслеживания позиций каждого модуля отдельно можно использовать дочерние стратегии или виртуальные портфели StockSharp.
