# Стратегия At Random Full
[English](README.md) | [中文](README_cn.md)

## Обзор
**At Random Full** — это аккуратный перенос советника MetaTrader 5 «At random Full». В конверсии сохранены случайный выбор 
направления, ограничения по количеству усреднений, временные фильтры и логика минимального шага между позициями. В StockSharp 
стратегия построена на высокоуровневом API: вся обработка происходит в подписке на свечи, а стоп-лосс и тейк-профит оформляются 
через `StartProtection`.

## Логика торговли
1. После закрытия каждой свечи проверяется, разрешена ли торговля: учитывается фильтр торговой сессии, состояние портфеля и 
   флаг «Только одна позиция».
2. Генератор псевдослучайных чисел выбирает направление сделки. Параметр `ReverseSignals` позволяет инвертировать результат и 
   тем самым повторить поведение режима Reverse в оригинале.
3. Параметр `Mode` блокирует сигналы в запрещённом направлении. Чтобы не открывать несколько сделок на одном баре, стратегия 
   запоминает время открытия последней свечи для покупок и продаж.
4. Управление сеткой полностью совпадает с MQL-версией:
   - `MaxPositions` ограничивает количество усреднений в одну сторону.
   - `MinStepPoints` требует минимального ценового шага между позициями; расстояние переводится в цену через шаг котировки.
   - `CloseOpposite` закрывает встречную позицию перед открытием новой.
5. Рыночные заявки отправляются методами `BuyMarket` и `SellMarket` с нормализованным объёмом `OrderVolume`.

## Управление позицией и рисками
- `StartProtection` выставляет стоп-лосс и тейк-профит в соответствии с входными параметрами. Если `TrailingStopPoints` больше 
  нуля, активируется встроенный трейлинг StockSharp. Значения `TrailingActivatePoints` и `TrailingStepPoints` переводятся в 
  денежное выражение и выводятся в журнал, а дальнейшее сопровождение позиции выполняет платформа.
- Нормализация объёмов учитывает `VolumeStep`, `MinVolume` и `MaxVolume`, как и функции из MQL-советника.
- Временной фильтр повторяет блок `InpTimeControl`: при активном параметре сделки разрешены только в пределах 
  `[SessionStart, SessionEnd]`. Поддерживаются интервалы, переходящие через полночь.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип свечей, по которым выполняется логика. | Таймфрейм 15 минут |
| `OrderVolume` | Базовый объём рыночной заявки в лотах. | `0.1` |
| `MaxPositions` | Максимум усреднений в одном направлении (0 — без лимита). | `5` |
| `MinStepPoints` | Минимальный шаг между сделками в пунктах MetaTrader. | `150` |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах. | `150` |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах. | `460` |
| `TrailingActivatePoints` | Порог прибыли для запуска трейлинга; значение фиксируется в логе. | `70` |
| `TrailingStopPoints` | Дистанция трейлинг-стопа, передаваемая в `StartProtection`. | `250` |
| `TrailingStepPoints` | Минимальный шаг смещения трейлинга (журналируется). | `50` |
| `OnlyOnePosition` | Запрет на открытие новых сделок при ненулевой позиции. | `false` |
| `CloseOpposite` | Закрывать встречную позицию перед входом. | `false` |
| `ReverseSignals` | Инвертировать случайный сигнал. | `false` |
| `UseTimeControl` | Активировать фильтр по времени. | `false` |
| `SessionStart` | Начало торговой сессии (включительно). | `10:01` |
| `SessionEnd` | Конец торговой сессии (включительно). | `15:02` |
| `Mode` | Разрешённое направление (`Both`, `BuyOnly`, `SellOnly`). | `Both` |
| `RandomSeed` | Фиксированное значение seed для повторяемых тестов (0 — брать `Environment.TickCount`). | `0` |

## Особенности реализации
- Комментарии в коде написаны на английском, отступы выполнены табуляцией согласно правилам репозитория.
- Подписка `SubscribeCandles().Bind(...)` гарантирует, что обработка происходит только после закрытия свечи, как и в MQL.
- Для контроля шага между входами запоминаются последние цены покупок и продаж, что позволяет корректно обрабатывать усреднения.
- При запуске стратегия пишет в журнал рассчитанные дистанции стоп-лосса, тейк-профита и трейлинга, что облегчает анализ.

## Рекомендации по использованию
- Стратегия изначально случайна, поэтому её удобно применять для тестирования инфраструктуры, демонстрации риск-менеджмента или 
  отладки платформы.
- Подбирайте параметры `OrderVolume`, `StopLossPoints` и `TakeProfitPoints` с учётом шага цены и волатильности инструмента.
- Включайте `UseTimeControl`, если торговля должна вестись только в определённые часы (например, во время европейской сессии).
- Параметр `RandomSeed` полезен при оптимизации: он фиксирует последовательность псевдослучайных чисел и делает результаты 
  повторяемыми.
