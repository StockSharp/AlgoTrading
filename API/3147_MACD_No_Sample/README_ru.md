# MACD No Sample

## Обзор
MACD No Sample — порт эксперта MetaTrader 5 `MACD No Sample` под платформу StockSharp. Стратегия объединяет проверку наклона скользящей средней с пересечениями MACD и её сигнальной линии, дополнительно требуя минимальную амплитуду MACD в пунктах. При подтверждённом сигнале в лонг сначала закрываются открытые шорты и только затем открывается длинная позиция; для шортов действует зеркальная логика. Управление риском повторяет оригинал: стоп-лосс, тейк-профит и трейлинг-стоп задаются в пунктах, также доступен режим расчёта объёма от процента риска.

## Логика стратегии
### Подготовка индикаторов
* **Фильтр скользящей средней** — настраиваемая скользящая средняя (SMA, EMA, SMMA или LWMA), применяемая к выбранной цене свечи (close, open, high, low, median, typical или weighted). Сравнение значения текущей свечи с предыдущей (`MA[0] > MA[1]` либо `<`) определяет направление тренда.
* **Сигнал MACD** — индикатор MACD рассчитывается по заданным периодам быстрой/медленной EMA и сигнальной линии с учётом выбранного типа цены. Анализируются свежие пересечения MACD и сигнальной линии, а абсолютное значение MACD сравнивается с порогом в пунктах.

### Правила входа
* **Лонг**
  * Скользящая средняя растёт на последней закрытой свече.
  * MACD находится ниже нуля, но только что пересёк сигнальную линию снизу вверх (текущий MACD > текущего сигнала при условии, что на предыдущей свече MACD < сигнала).
  * Абсолютное значение MACD превышает заданный порог (пункты переводятся в цену через вычисленный размер пункта).
  * Перед открытием лонга закрываются все короткие позиции.
* **Шорт**
  * Скользящая средняя снижается.
  * MACD выше нуля и только что пересёк сигнальную линию сверху вниз.
  * Абсолютное значение MACD превышает порог в пунктах.
  * Перед открытием шорта закрываются все длинные позиции.

### Управление позицией
* **Фиксированный стоп/профит** — точки задаются в пунктах и переводятся в ценовые отступы от цены входа. Значение `0` отключает уровень.
* **Трейлинг-стоп** — активируется при положительном значении параметра. Стратегия отслеживает лучшую цену после входа и переносит стоп только при улучшении не менее чем на заданный шаг, при этом никогда не расширяет стоп.
* **Риск-процент (опционально)** — объём сделки рассчитывается из стоимости портфеля, расстояния до стопа и заданного процента риска. Значение выравнивается по `VolumeStep` инструмента и ограничивается `MinVolume`/`MaxVolume`, если они доступны.

## Особенности реализации
* Используется высокоуровневый API: `SubscribeCandles()` с обработкой логики в колбэке `ProcessCandle`, без вызовов `GetValue` у индикаторов.
* Тип цены для индикаторов полностью соответствует выбранным настройкам; применяются стандартные индикаторы StockSharp.
* Размер пункта определяется аналогично оригиналу: для трёх- и пятизнаковых инструментов ценовой шаг умножается на 10.
* Стопы и трейлинг реализованы закрытием позиции рыночными ордерами при достижении уровней; отдельные стоп-заявки не выставляются.
* Реализована только C# версия, Python-реализация отсутствует.

## Параметры
* **Volume** – фиксированный объём сделки.
* **Stop Loss (pips)** – расстояние до стоп-лосса; `0` отключает уровень.
* **Take Profit (pips)** – расстояние до тейк-профита; `0` отключает уровень.
* **Trailing Stop (pips)** – расстояние для трейлинг-стопа; `0` отключает трейлинг.
* **Trailing Step (pips)** – минимальное улучшение цены (в пунктах) для переноса трейлинг-стопа.
* **Position Sizing** – выбор между фиксированным объёмом и расчётом по риску.
* **Risk Percent** – процент портфеля, используемый в режиме расчёта по риску.
* **MA Period / Method / Price** – настройки фильтра скользящей средней.
* **MACD Fast / Slow / Signal** – периоды EMA и сигнальной линии MACD.
* **MACD Price** – тип цены для расчёта MACD.
* **MACD Level (pips)** – минимальная амплитуда MACD в пунктах для допуска сделки.
* **Candle Type** – таймфрейм, по которому строятся свечи и индикаторы.
