# Стратегия OzFx Accelerator Stochastic

## Общее описание
- Конвертация советника MetaTrader *OzFx (редакция barabashkakvn)* на высокоуровневый API StockSharp.
- Использует осциллятор Acceleration/Deceleration и порог стохастика для послойного входа в трендовые движения.
- Предназначена для форекс-торговли, где объём задаётся в лотах, а защитные уровни выражаются в пунктах.

## Логика торговли
1. Рассчитывается осциллятор AC как разница между Awesome Oscillator и его 5-периодной SMA.
2. Подписка на стохастик с настраиваемыми периодами `%K`, `%D` и финальным сглаживанием.
3. После закрытия свечи анализируются два последних значения AC вместе с текущим значением стохастика:
   - **Покупка** — `%K` пробивает вверх заданный уровень, текущее значение AC положительно и растёт, а предыдущее было отрицательным.
   - **Продажа** — `%K` пробивает вниз уровень, текущее AC отрицательно и снижается, а предыдущее было положительным.
4. При выполнении условий стратегия открывает до пяти рыночных ордеров одинакового объёма. Первый слой, как и в оригинальном советнике, стартует без стопа и тейк-профита, остальные получают общий стоп и каскадные цели.
5. Управление выходами повторяет механику флага `modok` из MQL:
   - При отключённом трейлинг-стопе стоп подтягивается к безубытку только после того, как предыдущая сделка закрылась по тейку, и все слои закрываются при обратном сигнале AC+Стохастик.
   - При включённом трейлинг-стопе защитный уровень переносится за ценой после преодоления расстояния *TrailingStop + TrailingStep*, и при развороте осцилляторов вся пачка закрывается.

## Масштабирование позиции и цели
- Длинные позиции добавляют ещё четыре слоя с тейк-профитами на уровнях `entry + TakeProfit * i`, где `i = 1..4`. Короткие позиции зеркальны.
- Стопы (если заданы) прикрепляются ко всем слоям кроме первого — полностью повторяя логику MT5.
- Частичное закрытие по тейку переводит внутренний флаг в состояние "modok = true", благодаря чему следующая серия сделок сразу получает защиту по безубытку для первого слоя.

## Управление рисками
- Параметры `StopLossPips` и `TakeProfitPips` задаются в пунктах. Стратегия пересчитывает их в цену с учётом шага тика и количества знаков (5- и 3-знаковые пары учитывают дробные пункты).
- Значение `TrailingStopPips = 0` отключает трейлинг и оставляет только подтягивание к безубытку после тейк-профита. Любое положительное значение активирует блок трейлинга.
- Выходы исполняются рыночными заявками при пересечении диапазоном свечи сохранённых уровней стопа или тейка, что соответствует поведению советника, где защитные ордера находились на стороне брокера.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `OrderVolume` | Объём каждого слоя в лотах. | `0.1` |
| `StopLossPips` | Расстояние до защитного стопа (в пунктах). | `100` |
| `TakeProfitPips` | Базовый шаг между тейк-профитами (в пунктах). | `50` |
| `TrailingStopPips` | Дистанция трейлинг-стопа (0 — отключено). | `50` |
| `TrailingStepPips` | Дополнительный сдвиг перед переносом трейлинга. | `5` |
| `KPeriod` | Период расчёта `%K`. | `5` |
| `DPeriod` | Период сглаживания `%D`. | `3` |
| `SmoothingPeriod` | Финальное сглаживание `%K`. | `3` |
| `StochasticLevel` | Порог между бычьей и медвежьей зонами. | `50` |
| `CandleType` | Тип свечей для расчётов. | `4 часа` |

## Особенности реализации
- Все сигналы и защитные действия выполняются по закрытию свечи, что повторяет логику советника, реагирующего на открытие нового бара.
- Осциллятор AC собирается из Awesome Oscillator и его SMA без прямого обращения к буферам индикаторов.
- Пересчёт пунктов автоматически адаптируется под 4/5-значные котировки и использует запасной шаг при отсутствии данных о тиках.
- Ведётся внутренний список слоёв позиции, чтобы частичные тейки и перенос стопов точно соответствовали помодельной логике MT5.
- В StockSharp закрытия осуществляются рыночными заявками: позиция закрывается, как только диапазон свечи достигает сохранённого уровня стопа или тейка.
