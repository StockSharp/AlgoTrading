# OzFx Accelerator Stochastic 策略

## 概述
- 将 MetaTrader 顾问 *OzFx (barabashkakvn 版本)* 移植到 StockSharp 的高级策略 API。
- 通过加速/减速指标（AC）与随机指标阈值的组合，在趋势启动时分批加仓。
- 适用于以手数下单、以点数设置止损止盈的外汇交易场景。

## 交易逻辑
1. 计算 AC 指标：Awesome Oscillator 减去其 5 周期简单均线。
2. 订阅带有可调 `%K`、`%D` 以及减速参数的随机指标。
3. 每根 K 线收盘后联合评估最近两个 AC 值与当前随机值：
   - **做多**：`%K` 上穿阈值，当前 AC 为正且大于上一值，而上一值为负。
   - **做空**：`%K` 下穿阈值，当前 AC 为负且小于上一值，而上一值为正。
4. 条件成立时最多开出 5 笔等量市价单。第一笔保持与原 EA 一致，不设置初始止损/止盈；其余四笔继承统一的止损，并按照倍数递增的止盈目标挂出。
5. 持仓管理复刻 MQL 中的 `modok` 逻辑：
   - 当 `TrailingStopPips` 为 0 时，只在前一次仓位盈利离场后才将第一层止损提到开仓价，若 AC+随机组合翻转则一次性平掉全部层级。
   - 当设置了正的 `TrailingStopPips` 时，价格超过 *TrailingStop + TrailingStep* 后持续上移止损，同样的动量反转也会触发全部平仓。

## 分批与目标
- 多头额外四层的止盈价分别为 `entry + TakeProfit * i (i = 1..4)`，空头对称设置在下方。
- 除首层外，每层都会带上初始止损，与 MT5 版本完全一致。
- 任意一层触发止盈都会把内部 `modok` 标志设为 true，从而下一轮信号立即获得首层的保本保护。

## 风险控制
- `StopLossPips` 与 `TakeProfitPips` 以点数配置，策略依据交易品种的最小报价步长和小数位自动换算为价格距离（对 5 位、3 位报价自动处理“迷你点”）。
- `TrailingStopPips = 0` 表示只启用保本移动；设为正值则使用完整的跟踪止损算法。
- 由于 StockSharp 使用市价指令平仓，当 K 线的高/低触及存储的止损或止盈水平时，会立即发出反向市价单，与原顾问在服务器端触发保护单的效果一致。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `OrderVolume` | 每一层的下单手数。 | `0.1` |
| `StopLossPips` | 止损距离（点）。 | `100` |
| `TakeProfitPips` | 相邻止盈之间的基础间距（点）。 | `50` |
| `TrailingStopPips` | 跟踪止损距离（点，0 表示关闭）。 | `50` |
| `TrailingStepPips` | 更新跟踪止损前所需的额外移动幅度。 | `5` |
| `KPeriod` | 随机指标 `%K` 周期。 | `5` |
| `DPeriod` | `%D` 平滑周期。 | `3` |
| `SmoothingPeriod` | `%K` 终极平滑周期。 | `3` |
| `StochasticLevel` | 多空分界阈值。 | `50` |
| `CandleType` | 计算所用的 K 线类型。 | `4 小时` |

## 实现细节
- 所有信号、跟踪和保护动作均基于收盘价执行，保持与原 EA 在新 Bar 开启时决策的节奏一致。
- AC 指标由 Awesome Oscillator 与其 5 周期 SMA 动态组合，无需直接访问指标缓冲区。
- 点值换算自动适配 4/5 位外汇品种，在缺失交易所数据时会采用合理的保底步长。
- 策略内部维护每一层的建仓信息，从而精确复现分批止盈、止损迁移以及 `modok` 状态切换。
- 采用市场化平仓方式：当 K 线的高低价突破记录的止损/止盈水平时立即执行平仓，避免与服务器端挂单状态不一致。
