# Стратегия Constituents EA
[English](README.md) | [中文](README_cn.md)

Эта стратегия переносит советника **Constituents EA** из `MQL/22595` в высокоуровневый API StockSharp. Логика построена так,
чтобы в заданный час размещать пару отложенных заявок вокруг последнего ценового диапазона и при этом использовать стандартные
возможности StockSharp по управлению рисками и заявками.

## Как устроена логика

1. **Проверка времени**. В конце каждой свечи стратегия оценивает, начнётся ли следующая свеча в час `StartHour`. Только в этот
   момент формируется новая пара отложенных заявок. Тем самым повторяется поведение MQL-версии, которая реагировала на рождение
   бара с нужным временем открытия.
2. **Определение диапазона**. Индикаторы `Highest` и `Lowest` отслеживают максимум и минимум среди `SearchDepth` последних
   завершённых свечей. Эти значения используются как уровни для лимитных либо стоповых заявок.
3. **Контроль расстояния**. Из книги заявок берутся лучшие бид/аск. Заявка отправляется только если расстояние между котировкой и
   расчётной ценой не меньше `MinOrderDistancePips`, преобразованного в абсолютное значение через `PointValue`. Это аналог
   проверки freeze level в исходном коде.
4. **Тип отложенных заявок**. Параметр `PendingOrderMode` выбирает, какие заявки выставлять: `Limit` — возврат к диапазону (buy
   limit на минимуме, sell limit на максимуме), `Stop` — пробой диапазона (buy stop выше максимума, sell stop ниже минимума).
5. **Защита позиции**. Встроенная функция `StartProtection` подключает стоп-лосс и тейк-профит в абсолютных шагах цены. Перед
   выставлением проверяется, что значения `StopLossPips` и `TakeProfitPips` удовлетворяют ограничению `MinStopDistancePips`, что
   соответствует проверке `StopsLevel` в MetaTrader.
6. **Управление ордерами**. При исполнении одной заявки противоположная немедленно отменяется. Пока активны отложенные заявки,
   новые заявки не формируются — поведение полностью совпадает с оригинальным советником.

## Параметры

| Параметр | Описание |
| --- | --- |
| `StartHour` | Час (0-23), в который создаётся новая пара отложенных заявок. |
| `SearchDepth` | Количество завершённых свечей для расчёта максимума и минимума. |
| `PendingOrderMode` | `Limit` — лимитные заявки, `Stop` — стоп-заявки. |
| `StopLossPips` | Размер стоп-лосса в пунктах. Значение 0 отключает защиту. |
| `TakeProfitPips` | Размер тейк-профита в пунктах. Значение 0 отключает цель. |
| `PointValue` | Стоимость пункта в единицах цены. При 0 определяется автоматически из `PriceStep`/`MinStep`. |
| `MinOrderDistancePips` | Минимальное расстояние между текущей ценой и отложенной заявкой (аналог freeze level). |
| `MinStopDistancePips` | Минимальное расстояние для стоп-лосса/тейк-профита (аналог StopsLevel). |
| `CandleType` | Таймфрейм, на котором выполняются все вычисления. |

Размер позиции задаётся свойством `Strategy.Volume`. Оно должно быть положительным, иначе методы `BuyLimit`, `SellLimit`,
`BuyStop` и `SellStop` не смогут отправить заявки.

## Рекомендации по использованию

1. Подключите стратегию к нужному инструменту и установите `CandleType` в требуемый таймфрейм.
2. Настройте `StartHour` и `SearchDepth` в соответствии с параметрами исходного советника MetaTrader.
3. При необходимости скорректируйте `PointValue`, если шаг цены инструмента не определяется автоматически (например, на
   синтетических инструментах или CFD).
4. Установите `StopLossPips`, `TakeProfitPips`, `MinOrderDistancePips` и `MinStopDistancePips` согласно требованиям брокера.
5. Задайте объём в `Volume` и запустите стратегию. Она подпишется на свечи и стакан, выставит две отложенные заявки в нужный
   момент и отменит противоположную после срабатывания одной из них.

## Отличия от оригинальной реализации

- Денежное управление `MoneyFixedMargin` (расчёт объёма в процентах от депозита) не перенесено. В StockSharp следует напрямую
  управлять `Volume` или подключить внешний модуль риск-менеджмента.
- Проверки freeze level и стоп-уровня вынесены в параметры `MinOrderDistancePips` и `MinStopDistancePips`, потому что не все
  брокеры передают эти значения через API.
- Срабатывание условий происходит на закрытии предыдущей свечи, если следующая начинается в `StartHour`. Это полностью
  соответствует моменту выставления заявок в MQL-версии.
- В коде и документации используются комментарии на английском языке, а описания доступны на трёх языках.

Подбирайте значения параметров под конкретный инструмент. Для инструментов с широким спредом, как правило, требуется увеличить
`MinOrderDistancePips` и расстояние стопов, чтобы избежать отклонения заявок брокером.
