# Стратегия Allanmaug Trade Copier

## Обзор

Изначальный советник MQL5 `allanmaug_TRADECOPIER` копирует позиции между счётами, сохраняя снимки открытых позиций мастера в
общий бинарный файл. Версия для StockSharp сохраняет эту концепцию, но адаптирует её к портфельной архитектуре платформы.
Стратегия поддерживает до двух пар «мастер → слейв» и синхронизирует совокупную позицию по каждому инструменту.

В режиме **Master** стратегия периодически измеряет текущую суммарную позицию по указанным мастер-инструментам и записывает
объём и среднюю цену в общий файл. В режиме **Slave** стратегия читает этот файл, сравнивает требуемую позицию с фактической
экспозицией по соответствующему инструменту на счёте слейва и отправляет рыночные ордера, чтобы устранить расхождение. Благодаря
этому слейв постоянно догоняет мастер, реагируя даже на ручные вмешательства на мастер-счёте.

Главное отличие от версии MQL заключается в том, что StockSharp-реализация работает с чистой позицией по инструменту, а не с
отдельными тикетами сделок. В большинстве клиринговых моделей StockSharp это естественный способ хранения экспозиции. Когда
мастер закрывает позицию, файл содержит нулевой объём, и слейв сразу закрывает свою позицию.

## Параметры

| Параметр | Описание |
|----------|----------|
| `Mode` | Режим работы: `Master` записывает снимки, `Slave` их читает и повторяет. |
| `MasterSymbol1` / `SlaveSymbol1` | Первая связка инструментов «мастер → слейв». Оставьте пустой, чтобы отключить пару. |
| `MasterSymbol2` / `SlaveSymbol2` | Вторая связка инструментов с аналогичной логикой. |
| `FileName` | Имя бинарного файла, используемого обеими стратегиями. Файл создаётся в рабочей директории. |
| `Interval` | Период опроса/записи файла. По умолчанию 200 мс. |
| `VolumeTolerance` | Минимальное отличие по объёму, при превышении которого отправляется корректирующий ордер. Позволяет фильтровать шум. |

## Работа в режиме Master

1. По таймеру стратегия перебирает заданные мастер-инструменты.
2. Для каждого инструмента суммируется позиция портфеля и позиции самой стратегии.
3. Полученные данные (мастер-символ, слейв-символ, знаковый объём, средняя цена) записываются в общий бинарный файл.
4. Файл перезаписывается при каждом цикле, чтобы слейв видел актуальное состояние.

## Работа в режиме Slave

1. По таймеру стратегия читает бинарный файл. Если файл ещё не создан, чтение пропускается без ошибок.
2. Для каждой записи ищется соответствующий инструмент слейва через `SecurityProvider` стратегии (или через коннектор, если провайдер не задан).
3. Расчётная позиция сравнивается с текущим объёмом по инструменту слейва.
4. Если абсолютное отличие превышает `VolumeTolerance`, отправляется рыночный ордер: положительная разница приводит к покупке, отрицательная — к продаже.
5. В журнал добавляются пояснения о корректировках.

## Формат файла

1. 32-битное целое — количество записей.
2. Для каждой записи:
   - Строка UTF-8 — идентификатор мастер-символа.
   - Строка UTF-8 — идентификатор слейв-символа.
   - Decimal — знаковый объём (положительный для лонга, отрицательный для шорта).
   - Decimal — средняя цена позиции мастера.

Средняя цена сохраняется для совместимости с исходным алгоритмом; слейв её не использует напрямую, но значение может пригодиться
для внешней отчётности.

## Рекомендации по использованию

- Запускайте по одной стратегии в режиме Master и Slave. Обе должны ссылаться на один и тот же файл (например, оставьте значение
  по умолчанию и запускайте стратегии из общей папки).
- Убедитесь, что на слейв-счёте доступны соответствующие инструменты и лоты сопоставимы с мастер-счётом.
- При необходимости увеличьте `VolumeTolerance`, если слейв отправляет слишком много микросделок из-за плавающих дробных объёмов.
- Предполагается мгновенное исполнение рыночных ордеров. В реальной торговле добавьте страхующие механизмы на случай отклонений
  или частичных исполнений.
