# Allanmaug 交易复制策略

## 概述

原始的 MQL5 专家顾问 `allanmaug_TRADECOPIER` 通过把主账户的持仓快照写入一个共享的二进制文件，让从账户读取
该文件后复制交易。本次移植到 StockSharp 保留了这一工作流，同时适配平台的多资产、投资组合模型。策略支持
两组「主账户 → 从账户」品种映射，并复制每个品种的净头寸。

当策略处于 **Master** 模式时，会定期统计每个主账户品种的总仓位，并将数量及均价写入共享文件。处于 **Slave**
模式时，策略读取同一文件，对比映射的从账户品种当前仓位与目标仓位之间的差异，并通过市价单平衡差额。这样
从账户就会紧跟主账户，即便主账户有手动干预也能被捕捉。

与 MQL 版本逐单跟踪不同，StockSharp 版本以净头寸为核心。这与大多数支持的清算模型更加契合：多个订单汇总
为一个按品种划分的仓位。当主账户平仓后，文件记录的数量变为 0，从账户立即清仓。

## 参数

| 参数 | 说明 |
|------|------|
| `Mode` | 选择运行模式：`Master` 写入快照，`Slave` 读取快照并执行。 |
| `MasterSymbol1` / `SlaveSymbol1` | 第一组品种映射。若任一字段为空，则忽略该组。 |
| `MasterSymbol2` / `SlaveSymbol2` | 第二组品种映射，逻辑同上。 |
| `FileName` | 共享的二进制文件名称，默认在当前工作目录生成。 |
| `Interval` | 轮询文件的时间间隔，默认 200 毫秒。 |
| `VolumeTolerance` | 允许的头寸差异阈值，只有超过该阈值才会发出调整订单，避免因为微小波动频繁下单。 |

## Master 模式流程

1. 每次定时器触发时遍历配置的主账户品种。
2. 计算对应品种在投资组合和策略内部的总净头寸。
3. 将主品种、从品种、带符号的数量和均价写入共享文件。
4. 每个周期都会覆盖写入，保证从账户看到的都是最新状态。

## Slave 模式流程

1. 定时读取共享文件；若文件尚未生成，则跳过等待下一次轮询。
2. 针对每条记录，通过策略的 `SecurityProvider`（或连接器）查找从账户品种。
3. 对比目标头寸与当前头寸，计算差额。
4. 若差额绝对值超过 `VolumeTolerance`，则提交市价单调整仓位：差额为正下买单，为负下卖单。
5. 日志会记录每次调整的品种和数量，方便监控。

## 文件格式

1. 32 位整数：记录数量。
2. 每条记录包含：
   - UTF-8 字符串：主账户品种标识。
   - UTF-8 字符串：从账户品种标识。
   - Decimal：带符号的数量，正值代表多头，负值代表空头。
   - Decimal：主账户仓位的均价。

均价字段主要用于与原始脚本保持一致，从模式不会直接使用，但可用于审计或外部分析。

## 使用建议

- 同时运行一个 Master 实例和一个 Slave 实例，并确保两者指向同一个文件（可以保持默认文件名并在同一目录运行）。
- 确认从账户可以交易映射的品种，且合约乘数或手数与主账户一致。
- 如果因为小数精度导致频繁下单，可以适当提高 `VolumeTolerance`。
- 策略假定市价单能够立即成交，真实环境下建议增加风控，例如处理拒单或部分成交的情况。
