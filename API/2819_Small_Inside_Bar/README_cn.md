# Small Inside Bar 策略

## 概述
Small Inside Bar Strategy 通过识别压缩后的内部柱形态，跟随随后的方向转换进行交易。原始的 MetaTrader 5 专家顾问已迁移到 StockSharp 高级 API，实现只在完成的 K 线上运作，非常适合喜欢等待波动收缩后突破信号的交易者。

## 形态定义
策略会检查最近两根已完成 K 线：

1. **内部柱条件** – 最新收盘的 K 线必须完全位于上一根 K 线的最高价与最低价之间。
2. **区间比率过滤** – “母柱”（倒数第二根 K 线）的区间必须至少是内部柱区间的指定倍数，默认值为 2:1。
3. **方向过滤** –
   - 多头信号：内部柱收阳线，且位于母柱下半部分，同时母柱收阴线。
   - 空头信号：内部柱收阴线，且位于母柱上半部分，同时母柱收阳线。
4. 可选的反向交易会交换多空解释，几何条件保持不变。

## 仓位管理
`OpenMode` 参数再现原始 EA 的开仓模式：

- **AnySignal** – 每个信号都发送新的市价单。在存在反向仓位时，由于 StockSharp 采用净额制，订单会部分对冲原有仓位。
- **SwingWithRefill** – 进场前先平掉反向持仓，然后允许在同方向上多次加仓。
- **SingleSwing** – 市场中最多持有一个方向的仓位；当已有同向仓位时忽略新的信号。

多头和空头可独立启用，反向模式只是将触发方向调换。

## 参数
| 名称 | 默认值 | 说明 |
|------|--------|------|
| `CandleType` | 1 小时周期 | 用于识别形态的 K 线类型。 |
| `RangeRatioThreshold` | 2.0 | 母柱区间与内部柱区间的最小比率。 |
| `EnableLong` | true | 是否允许做多。 |
| `EnableShort` | true | 是否允许做空。 |
| `ReverseSignals` | false | 是否交换多空信号。 |
| `OpenMode` | SwingWithRefill | 新信号出现时如何处理已有仓位。 |

## 交易流程
1. 订阅所选 K 线并等待其收盘。
2. 维护最近两根完成的 K 线以评估形态。
3. 当满足区间比率与方向过滤后生成交易信号，可选择应用反向模式。
4. 通过 `IsFormedAndOnlineAndAllowTrading` 确认交易环境，并检查相应方向是否被允许。
5. 根据 `OpenMode` 计算下单数量，并按照策略基础手数发送市价单。
6. 更新内部历史记录，使最新 K 线参与下一轮判断。

## 实现细节
- 调用 `StartProtection()` 启用内置风险控制（无预设止损或止盈，可按需扩展）。
- 仅保存最近两根 K 线，不创建额外数据集合，符合高阶 API 的最佳实践。
- 所有计算都基于收盘数据，避免在未完成的 K 线上产生信号。
