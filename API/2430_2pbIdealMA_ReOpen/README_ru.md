# Стратегия 2pb Ideal MA с повторным входом

## Обзор
- Перенос советника MQL "Exp_2pbIdealMA_ReOpen" на высокоуровневый API StockSharp.
- Торговля на контртрендовых пересечениях между одиночной и тройной идеальной скользящей средней.
- Добавление к прибыльным позициям при дальнейшем движении цены на заданное число тиков и опциональное закрытие позиций при обратном сигнале.

## Индикаторы
- **2pb Ideal 1 MA** – одиночная идеальная скользящая средняя с двумя весовыми периодами. Отвечает за краткосрочную динамику.
- **2pb Ideal 3 MA** – каскад из трех таких же фильтров (этапы X, Y, Z). Формирует более медленный фоновый тренд.

## Логика торговли
1. Подписка на выбранный таймфрейм свечей (по умолчанию H4) и анализ только закрытых свечей.
2. Хранение значений фильтров на `SignalBarShift` баров назад (по умолчанию 1) и использование пары сдвигов `SignalBarShift` и `SignalBarShift + 1` для определения пересечений.
3. **Открытие лонга** – если два бара назад быстрая линия была выше медленной, а один бар назад опустилась ниже (медвежий кросс), открыть покупку при разрешенных лонгах и отсутствии позиции.
4. **Открытие шорта** – если два бара назад быстрая линия была ниже медленной, а один бар назад поднялась выше (бычий кросс), открыть продажу при разрешенных шортах и отсутствии позиции.
5. **Доливки** – при прибыльной позиции добавлять один ордер объемом `PositionVolume`, когда цена проходит `PriceStepTicks * Security.PriceStep` в сторону позиции. Максимальное число доливок задается параметром `MaxReEntries`.
6. **Выходы** – при появлении противоположного пересечения и включенном флаге закрытия сначала фиксировать текущую позицию, затем оценивать новый вход.
7. При необходимости использовать стоп-лосс и тейк-профит с заданными расстояниями в тиках.

## Параметры
- `CandleType` – тип/период свечей для расчета.
- `PositionVolume` – базовый объем для первичного входа и доливок, также присваивается свойству `Strategy.Volume`.
- `StopLossTicks` / `TakeProfitTicks` – расстояние до стопа/тейка в тиках, преобразуется в цену через `Security.PriceStep`.
- `PriceStepTicks` – минимальное число тиков между последовательными доливками.
- `MaxReEntries` – максимальное количество дополнительных заявок в каждом направлении.
- `EnableBuyEntries` / `EnableSellEntries` – разрешение на открытие длинных или коротких позиций.
- `EnableBuyExits` / `EnableSellExits` – закрывать ли текущие позиции при обратном сигнале.
- `SignalBarShift` – количество баров для оценки пересечения (аналог MQL-параметра `SignalBar`).
- `Period1`, `Period2` – веса одиночной идеальной скользящей средней.
- `PeriodX1`, `PeriodX2`, `PeriodY1`, `PeriodY2`, `PeriodZ1`, `PeriodZ2` – веса трех стадий идеальной скользящей средней.

## Управление рисками
- При положительных значениях стопа или тейка вызывается `StartProtection`, что активирует защитные приказы.
- Стратегия не открывает новую позицию, пока активна противоположная, что повторяет логику оригинального советника.

## Примечания
- Подходит для любых инструментов, у которых задан `Security.PriceStep`; стандартная конфигурация рассчитана на свечи H4.
- Python-реализация отсутствует в соответствии с требованиями.
