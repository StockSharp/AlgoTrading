# Стратегия EMA Cross Contest Hedged

## Общее описание
- Перенос оригинальной MetaTrader-стратегии «EMA Cross Contest Hedged» на высокоуровневый API StockSharp.
- Работает с парой экспоненциальных скользящих средних и при необходимости подтверждает сигналы основной линией MACD.
- После входа строит «лесенку» отложенных стоп-ордеров, позволяя наращивать позицию на сильных трендовых движениях.
- Управляет рисками через фиксированные стоп-лосс/тейк-профит значения в пунктах и через трейлинг-стоп, активируемый после достижения минимальной прибыли.
- Позволяет выбрать, использовать ли для сигналов текущую завершённую свечу или предыдущую закрытую свечу.

## Индикаторы и данные
- Короткая EMA с настраиваемым периодом (по умолчанию 4).
- Длинная EMA с настраиваемым периодом (по умолчанию 24); короткий период обязан быть меньше длинного.
- MACD (4, 24, 12) — основная линия используется как опциональный фильтр.
- Работает на любом таймфрейме, задаваемом параметром `CandleType` (по умолчанию 15-минутные свечи).

## Логика входа
1. Дождаться завершения свечи заданного таймфрейма.
2. Рассчитать значения быстрой и медленной EMA. В зависимости от `TradeBar` определять пересечение, используя:
   - Последнюю и предыдущую завершённые свечи (`Current`).
   - Предыдущую свечу и ещё более раннюю (`Previous`, значение по умолчанию).
3. Сформировать сигнал на покупку, когда быстрая EMA пересекает медленную снизу вверх. Если `UseMacdFilter` включён, значение MACD для той же свечи должно быть неотрицательным.
4. Сформировать сигнал на продажу, когда быстрая EMA пересекает медленную сверху вниз. При активированном фильтре MACD значение должно быть неположительным.
5. Открывать новую позицию только при отсутствии текущего выставленного объёма.
6. Исполнить рыночный ордер объёмом `OrderVolume`. После входа стратегия:
   - Запоминает уровни стоп-лосса и тейк-профита на расстоянии `StopLossPips` и `TakeProfitPips` от цены входа.
   - Сбрасывает состояние трейлинг-стопа.
   - Создаёт четыре хеджирующих стоп-ордера через `HedgeLevelPips` пунктов в сторону сделки. Каждый ордер наследует те же стоп/профит уровни и действует `PendingExpirationSeconds` секунд, если цена не достигла его раньше.

## Управление выходом
- **Стоп-лосс / тейк-профит.** Мониторится максимум и минимум свечи; касание любого уровня закрывает всю позицию.
- **Трейлинг-стоп.** Когда плавающая прибыль превышает `TrailingStopPips + TrailingStepPips`, стоп подтягивается на расстояние `TrailingStopPips` от текущей цены закрытия. Для лонга стоп движется вверх, для шорта — вниз.
- **Обратное пересечение.** Если `CloseOppositePositions` включён, позиция закрывается при появлении обратного сигнала EMA.
- **Хедж-лесенка.** Каждый отложенный ордер превращается в дополнительный рыночный ордер при достижении своего уровня ценой. Новые сделки пересчитывают среднюю цену входа и подтягивают защитные уровни.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `OrderVolume` | 0.1 | Объём всех рыночных и отложенных ордеров. |
| `StopLossPips` | 140 | Дистанция стоп-лосса в пунктах (0 — без стопа). |
| `TakeProfitPips` | 120 | Дистанция тейк-профита в пунктах (0 — без тейка). |
| `TrailingStopPips` | 30 | Дистанция трейлинг-стопа в пунктах (0 — отключить трейлинг). |
| `TrailingStepPips` | 1 | Минимальный дополнительный профит (в пунктах) перед очередным подтягиванием стопа. |
| `HedgeLevelPips` | 6 | Шаг между хеджирующими стоп-ордерами. |
| `CloseOppositePositions` | false | Закрывать позицию при обратном пересечении EMA. |
| `UseMacdFilter` | false | Требовать подтверждение MACD (>= 0 для лонга, <= 0 для шорта). |
| `PendingExpirationSeconds` | 65535 | Срок жизни каждого хедж-ордера в секундах. |
| `ShortMaPeriod` | 4 | Период короткой EMA (меньше `LongMaPeriod`). |
| `LongMaPeriod` | 24 | Период длинной EMA. |
| `TradeBar` | Previous | Какая пара свечей используется для поиска пересечения. |
| `CandleType` | 15 минут | Таймфрейм данных. |

## Дополнительные замечания
- Пересчёт пунктов выполняется как `PriceStep` * количество пунктов с автоматическим множителем 10 для инструментов с 3 или 5 знаками после запятой, что соответствует логике MetaTrader.
- Отложенные хеджирующие ордера моделируются внутри стратегии и исполняются, как только диапазон свечи достигает соответствующего уровня.
- Используется `StartProtection()` для активации встроенной защиты позиций StockSharp.
- Отдельные состояния трейлинг-стопа ведутся для лонгов и шортов, чтобы повторить оригинальную логику хеджирования.
