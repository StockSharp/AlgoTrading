# 统计重复行为策略
[English](README.md) | [Русский](README_ru.md)

这是一套日内策略，用来观察最近若干个交易日中相同时间开盘的 K 线是偏多还是偏空。每当新 K 线开始时，策略会统计历史上相同小时和分钟的蜡烛实体（以点数计），分别计算多头与空头的累计力度。如果多头总和更大，则在当前柱的开盘做多；若空头总和更大，则做空。仓位在下一根 K 线关闭，此外还有固定点差的止损，模拟原始 MetaTrader 专家的处理方式。仓位大小在亏损后按黄金分割比例放大，盈利后回到初始值。

## 交易流程

1. 新 K 线开始时先平掉上一根柱子留下的仓位。
2. 搜索过去 `HistoryDays` 个交易日中，与当前柱同一时间（小时+分钟）开盘的所有蜡烛。
3. 统计这些蜡烛的实体长度（点数），大于 `MinimumBodyPoints` 的正值累加到多头，总负值（绝对值）累加到空头。
4. 如果多头总和大于空头总和，则按当前可交易量开多。
5. 如果空头总和大于多头总和，则按当前可交易量开空。
6. 为持仓设置 `StopLossPips` 对应的止损距离，止损触发通过完成柱的最高价/最低价来判断。
7. 平仓时：
   - 若本次交易盈利，则将交易量重置为 `InitialVolume`。
   - 若亏损，则将交易量乘以 `MartingaleFactor`，同时按交易品种的最小/最大手数及步长限制进行修正。

## 参数说明

- **HistoryDays**（默认 10）— 统计历史数据的天数。
- **MinimumBodyPoints**（默认 10）— 小于此点数的蜡烛实体会被忽略。
- **StopLossPips**（默认 15）— 止损距离，以点数表示。
- **InitialVolume**（默认 0.1）— 初始下单量，作为盈亏调整的基准。
- **MartingaleFactor**（默认 1.618）— 亏损后放大的倍数。
- **CandleType**（默认 1 小时）— 使用的 K 线周期。

## 策略特性

- **方向**：可同时进行多头或空头，取决于统计结果。
- **周期**：可配置（默认 1 小时），统计严格匹配开盘的小时和分钟。
- **仓位管理**：同一时间仅持有一个仓位，在下一根柱或触发止损时平仓。
- **风险特点**：使用固定点数止损，并在连续亏损时通过黄金分割比例放大仓位。
- **适用市场**：要求交易品种提供有效的 `MinPriceStep`、最小/最大手数以及手数步长。

## 实现细节

- 每一分钟都维护一个队列保存最近 `HistoryDays` 根对应蜡烛的实体点数。
- 下单量会根据交易品种的 `VolumeStep` 调整，并限制在 `MinVolume` 与 `MaxVolume` 之间。
- 止损检查基于完成柱的最高价和最低价，用来模拟原始 MQL5 策略的盘中执行方式。
- 代码中的注释均为英文，以符合项目规范。
