# Стратегия «Статистика повторяющегося поведения»
[English](README.md) | [中文](README_cn.md)

Внутридневная стратегия, анализирующая, как свечи вели себя в ту же минуту суток на протяжении последних торговых дней. При появлении нового бара она сравнивает суммарные размеры бычьих и медвежьих тел из предыдущих дней. Если перевес на стороне быков — открывается длинная позиция, если преобладают медведи — короткая. Сделка закрывается на следующей свече, а фиксированный стоп-лосс в пунктах повторяет логику оригинального советника MetaTrader. Размер позиции увеличивается по принципу «золотого сечения» после убыточных сделок и возвращается к исходному объёму после прибыльных.

## Логика работы

1. В начале каждого нового бара закрыть позицию, открытую на предыдущей свече.
2. Найти свечи за последние `HistoryDays` дней, начавшиеся в то же время (по часам и минутам).
3. Просуммировать тела свечей (в пунктах) отдельно для бычьих и медвежьих закрытий, игнорируя тела меньше `MinimumBodyPoints`.
4. Если сумма бычьих тел больше медвежьих — открыть длинную позицию текущим объёмом.
5. Если медвежьи тела больше бычьих — открыть короткую позицию.
6. Установить стоп-лосс на расстоянии `StopLossPips`, преобразованном через минимальный шаг цены инструмента. Пробитие стопа контролируется по максимуму/минимуму завершившейся свечи.
7. После закрытия позиции:
   - При прибыли объём возвращается к `InitialVolume`.
   - При убытке объём умножается на `MartingaleFactor` с учётом шагов объёма и лимитов инструмента.

## Параметры

- **HistoryDays** *(по умолчанию: 10)* — число предыдущих дней для расчёта статистики.
- **MinimumBodyPoints** *(по умолчанию: 10)* — порог минимального тела свечи (в пунктах), меньшие значения игнорируются.
- **StopLossPips** *(по умолчанию: 15)* — расстояние стоп-лосса в пунктах.
- **InitialVolume** *(по умолчанию: 0.1)* — начальный объём ордера до применения мартингейла.
- **MartingaleFactor** *(по умолчанию: 1.618)* — множитель объёма после убыточной сделки.
- **CandleType** *(по умолчанию: 1 час)* — таймфрейм анализируемых свечей.

## Особенности торговли

- **Направление**: открываются как длинные, так и короткие позиции — в зависимости от статистики.
- **Таймфрейм**: задаётся пользователем (по умолчанию часовой), сравнение ведётся по точному времени открытия свечи.
- **Управление позицией**: одновременно поддерживается только одна позиция, закрытие происходит на следующем баре либо при срабатывании стопа.
- **Риск**: фиксированный стоп-лосс и мартингейл после убытков, что увеличивает объём при серии потерь.
- **Инструменты**: требуется наличие корректного `MinPriceStep` и ограничений по объёму у инструмента.

## Технические детали

- Тела свечей сохраняются в очередях по минуте суток, длина очереди ограничена `HistoryDays`.
- Объёмы нормализуются по шагу объёма инструмента и ограничиваются минимальными/максимальными значениями.
- Проверка стоп-лосса выполняется по значениям High/Low завершившегося бара, что эмулирует внутридневное исполнение оригинальной стратегии.
- В коде используются комментарии на английском языке в соответствии с требованиями репозитория.
