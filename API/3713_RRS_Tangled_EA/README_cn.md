# RRS Tangled EA 策略

## 概述
**RRS Tangled EA 策略** 是 MetaTrader 4 专家顾问的 StockSharp 移植版本。原始程序会随机选择交易方向与品种，并限制同时持有的订单数量，同时通过移动止损和资金风险控制来保护浮动收益。移植版在当前选定的品种上复现这一行为，利用 StockSharp 的高级 API 完成随机进场、跟踪止损和资金管理。

## 运行流程
1. 订阅设定的 K 线类型，仅处理收盘完成的 K 线。
2. 每根 K 线到来时：
   - 根据最新的买卖价更新多头、空头持仓的跟踪止损位置。
   - 通过当根最高价/最低价检查止损和止盈是否被触发。
   - 计算所有持仓的浮动盈亏，当亏损超过可承受金额时立即清仓。
   - 在允许交易、点差符合要求且持仓数量未达到上限的情况下，生成 `[0, 3]` 的随机整数；值为 `1` 时开多，值为 `2` 时开空，手数从设定区间内随机选择。
3. 当价格走出激活距离后，跟踪止损会贴着买价或卖价推进，一旦价格回撤超出设定间距即锁定利润。
4. 风险控制支持固定金额或按账户余额百分比两种模式，只要浮亏超过阈值就平掉全部仓位。

## 参数说明
| 名称 | 说明 |
|------|------|
| `MinVolume` | 随机手数的下限。 |
| `MaxVolume` | 随机手数的上限。 |
| `TakeProfitPips` | 相对平均持仓价的止盈距离（点）。 |
| `StopLossPips` | 相对平均持仓价的止损距离（点）。 |
| `TrailingStartPips` | 启动跟踪止损所需的盈利距离。 |
| `TrailingGapPips` | 跟踪止损与最佳买/卖价之间保持的间隔。 |
| `MaxSpreadPips` | 开仓前允许的最大点差。 |
| `MaxOpenTrades` | 同时持有的最大随机订单数。 |
| `RiskManagementMode` | 固定金额或余额百分比风险模式。 |
| `RiskAmount` | 监控浮亏的金额或百分比阈值。 |
| `TradeComment` | 可选的订单备注，与原 EA 保持一致。 |
| `Notes` | 显示在策略状态字符串中的备注信息。 |
| `CandleType` | 用于分析的 K 线类型。 |

## 与 MQL 版本的差异
- 由于 StockSharp 策略通常针对单一品种，移植版不再随机切换交易品种，而是使用策略绑定的证券。
- 持仓按照多头和空头篮子聚合管理，对应原 EA 使用不同 magic number 的做法。
- 点差限制使用最新的买卖价计算，替代 MetaTrader 的 `MarketInfo` 查询。

## 使用提示
- 连接的撮合或仿真环境应提供买价和卖价，以保证点差和跟踪止损计算准确。
- 请确保 `MinVolume` 与 `MaxVolume` 位于交易品种允许的手数范围内，策略会自动按照最小变动手数对齐。
- 一旦触发风险控制，策略会立即清空所有持仓，并在下一根 K 线前不再开仓。
