# Стратегия RRS Tangled EA

## Обзор
**RRS Tangled EA** — порт MetaTrader 4 советника на платформу StockSharp. Оригинальная версия случайным образом выбирала направление и торговый инструмент, ограничивала количество одновременно открытых сделок и защищала плавающий результат при помощи трейлинг-стопа и управления риском. Перенос использует текущий инструмент стратегии и полностью реализует случайные входы, трейлинг и контроль капитала через высокоуровневый API StockSharp.

## Алгоритм работы
1. Стратегия подписывается на выбранную серию свечей и обрабатывает только закрытые бары.
2. Для каждой свечи выполняются шаги:
   - Обновление уровней трейлинг-стопа для действующих длинных и коротких корзин.
   - Проверка условия срабатывания стоп-лосса и тейк-профита по максимуму и минимуму свечи.
   - Расчет текущего плавающего результата; если убыток превышает допустимое значение, все позиции закрываются.
   - При разрешенной торговле, допустимом спреде и свободном лимите сделок генерируется случайное число `[0, 3]`.
   - Значение `1` инициирует покупку, `2` — продажу. Объем выбирается случайно в заданных границах и корректируется под шаг объема инструмента.
3. Когда цена проходит активационную дистанцию, трейлинг-стоп подтягивается к лучшему бид/аск и фиксирует прибыль при откате на величину зазора.
4. Управление риском работает либо в режиме фиксированной суммы, либо как процент от текущего баланса. После превышения лимита убытка стратегия немедленно закрывает все позиции.

## Параметры
| Имя | Описание |
|-----|----------|
| `MinVolume` | Нижняя граница случайного объема сделки. |
| `MaxVolume` | Верхняя граница случайного объема. |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах относительно средней цены корзины. |
| `StopLossPips` | Расстояние стоп-лосса в пунктах от средней цены входа. |
| `TrailingStartPips` | Прибыль, после которой активируется трейлинг-стоп. |
| `TrailingGapPips` | Отступ между трейлинг-стопом и лучшим бид/аск. |
| `MaxSpreadPips` | Максимальный допустимый спред для открытия новой сделки. |
| `MaxOpenTrades` | Лимит одновременно открытых случайных ордеров. |
| `RiskManagementMode` | Режим управления риском: фиксированная сумма или процент от баланса. |
| `RiskAmount` | Допустимый уровень плавающего убытка (в деньгах или процентах). |
| `TradeComment` | Комментарий к сделкам, оставлен для совместимости с оригиналом. |
| `Notes` | Произвольная заметка, отображается в статусе стратегии. |
| `CandleType` | Тип свечей, используемых для расчетов. |

## Отличия от версии MQL
- Торговля ведется по инструменту, назначенному стратегии, без случайного выбора тикера из Market Watch.
- Управление ордерами ведется корзинами покупок и продаж, что соответствует раздельным magic number в MetaTrader.
- Контроль спреда использует последние котировки bid/ask вместо вызовов `MarketInfo`.

## Рекомендации по использованию
- Необходим источник данных с котировками bid и ask, чтобы корректно рассчитывать спред и трейлинг.
- Подбирайте `MinVolume` и `MaxVolume` в пределах допустимого диапазона инструмента — стратегия сама подгонит объем под шаг.
- При срабатывании риск-менеджмента все позиции закрываются и новые сделки не открываются до следующей свечи.
