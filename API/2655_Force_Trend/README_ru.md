# Стратегия Force Trend

## Общее описание
- Конвертация советника MetaTrader 5 **Exp_ForceTrend.mq5** из каталога `MQL/18817`.
- Использует осциллятор ForceTrend для определения смены доминирующего направления.
- Логика реализована через высокоуровневый API StockSharp: подписка на свечи, встроенные индикаторы и обработчик `Bind` вместо прямого доступа к буферам.

## Индикатор ForceTrend
- Рассматривает `Length` последних свечей и вычисляет диапазон между наибольшим максимумом и наименьшим минимумом.
- Средняя цена текущей свечи нормализуется внутри диапазона и дважды сглаживается:
  - На первом этапе вычисляется промежуточное значение `force` с коэффициентами `0.66` и `0.67`.
  - На втором этапе применяется логарифмическое преобразование и полураспадное сглаживание, что воспроизводит буфер `Ind` оригинального индикатора.
- Значения выше нуля трактуются как бычьи (в МТ5 подсвечены синим), значения ниже нуля — как медвежьи (подсветка магентой).

## Параметры
- `Length` — длина окна ForceTrend; должна быть строго положительной.
- `SignalBar` — сколько закрытых свечей пропустить перед генерацией сигнала. `0` реагирует на последнюю закрытую свечу, `1` повторяет дефолт МТ5 (ожидание одной дополнительной свечи), большие значения сильнее задерживают реакцию.
- `EnableLongEntry` — разрешает открытие длинных позиций при переходе индикатора в бычье состояние.
- `EnableShortEntry` — разрешает открытие коротких позиций при переходе в медвежье состояние.
- `EnableLongExit` — разрешает закрывать длинные позиции при медвежьих сигналах.
- `EnableShortExit` — разрешает закрывать короткие позиции при бычьих сигналах.
- `CandleType` — таймфрейм свечей, на которых рассчитывается ForceTrend.

## Правила торговли
1. Значение ForceTrend преобразуется в дискретное направление (`+1`, `0`, `-1`).
2. История направлений хранится в массиве фиксированной длины, чтобы сравнивать свечу на смещении `SignalBar` с предыдущей.
3. Бычий сигнал (`direction > 0`) вызывает:
   - Закрытие коротких позиций при включённом `EnableShortExit` (объёмом `|Position|`).
   - Открытие или разворот в лонг (рыночный ордер объёмом `Volume + |Position|`), если предыдущая свеча не была бычьей и `EnableLongEntry = true`.
4. Медвежий сигнал (`direction < 0`) выполняет симметричные действия для длинных позиций в зависимости от `EnableLongExit` и `EnableShortEntry`.
5. Нейтральные значения индикатора наследуют последнее известное направление, чтобы избежать дребезга сигналов.
6. Приказы отправляются только после полной инициализации стратегии и разрешения торговли (`IsFormedAndOnlineAndAllowTrading`).

## Особенности реализации
- Используются подписки на свечи через `SubscribeCandles(CandleType)` и обработчик `ProcessCandle`.
- Экстремумы вычисляются индикаторами `Highest` и `Lowest`, что исключает создание собственных коллекций и ручную обработку серий.
- Для хранения направлений создан массив фиксированного размера (минимум две ячейки), чтобы повторить механику MT5 без динамических очередей на каждом тике.
- Развороты позиций выполняются одним рыночным ордером, объём которого складывается из требуемого объёма и абсолютного текущего положения, аналогично функциям `BuyPositionOpen`/`SellPositionOpen` из MQL-версии.
- Параметры управления капиталом советника (MM, стоп-лосс/тейк-профит в пунктах, допуски) не переносятся: в StockSharp размер задаётся через `Volume`, а защиту можно подключить отдельными компонентами.
- Булевы флаги полностью соответствуют входным параметрам MT5 (`BuyPosOpen`, `SellPosOpen`, `BuyPosClose`, `SellPosClose`).

## Рекомендации по использованию
- Перед запуском задайте свойство `Volume`, определяющее торговый объём.
- Подберите таймфрейм `CandleType`, соответствующий тестам в MT5 (по умолчанию — четырёхчасовые свечи).
- Для стоп-лоссов и тейк-профитов подключайте механизмы защиты StockSharp (`StartProtection` или внешние модули).

## Файлы
- Реализация стратегии: `CS/ForceTrendStrategy.cs`
- Оригинальные файлы MQL: `MQL/18817/mql5/Experts/Exp_ForceTrend.mq5`, `MQL/18817/mql5/Indicators/ForceTrend.mq5`
