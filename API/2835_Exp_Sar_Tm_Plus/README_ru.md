# Exp Sar Tm Plus Strategy

Высокоуровневый порт эксперта **Exp_Sar_Tm_Plus** на платформу StockSharp. Стратегия отслеживает развороты Parabolic SAR на настраиваемом таймфрейме и повторяет оригинальные механизмы управления позицией и тайм-аутами, сохраняя совместимость с высокоуровневым API StockSharp.

## Логика торговли

- Свечи подписываются согласно параметру `CandleType` (по умолчанию таймфрейм 4 часа). Индикатор Parabolic SAR рассчитывается с коэффициентами `SarStep` и `SarMaximum`.
- После закрытия каждой свечи стратегия сохраняет закрытия и значения SAR. Параметр `SignalBar` определяет, какая закрытая свеча анализируется (по умолчанию последняя закрывшаяся), а также сравнивается с предыдущей свечой для фиксации смены направления SAR.
- **Длинная** позиция открывается, когда цена пересекает SAR снизу вверх (предыдущая свеча ниже SAR, выбранная свеча выше SAR) и разрешены входы в лонг. При наличии короткой позиции она закрывается перед разворотом.
- **Короткая** позиция открывается, когда цена пересекает SAR сверху вниз (предыдущая свеча выше SAR, выбранная свеча ниже SAR) и разрешены входы в шорт. Активная длинная позиция закрывается автоматически.
- Позиции закрываются, когда SAR разворачивается против них (`AllowLongExit` / `AllowShortExit`), когда достигаются опциональные уровни стоп-лосса или тейк-профита, либо по тайм-ауту (`UseTimeExit` + `HoldingMinutes`).
- Стоп-лосс и тейк-профит пересчитываются при каждом входе с использованием шага цены инструмента (`PriceStep`). Если значение равно нулю, уровень не устанавливается.

## Параметры

- `MoneyManagement` – доля базового объёма `Volume`, торгуемая при каждом входе. Значения ≤ 0 возвращают использование чистого `Volume`. Объём нормализуется к шагу объёма инструмента (`VolumeStep`).
- `ManagementMode` – перечисление, сохранённое из исходного эксперта. В текущем порте все режимы работают как `Lot` (фиксированный объём).
- `StopLossPoints` / `TakeProfitPoints` – расстояние в шагах цены для установки защитных уровней относительно цены входа. Ноль отключает уровень.
- `DeviationPoints` – исходная настройка допуска проскальзывания. Параметр сохранён для совместимости, но высокоуровневый API исполняет рыночные заявки без его использования.
- `AllowLongEntry`, `AllowShortEntry` – флаги разрешения открывать длинные/короткие позиции.
- `AllowLongExit`, `AllowShortExit` – флаги закрытия позиций при пересечении SAR в противоположную сторону.
- `UseTimeExit` – включает принудительное закрытие позиции после `HoldingMinutes` минут в рынке.
- `HoldingMinutes` – длительность тайм-аута в минутах.
- `CandleType` – тип свечей, по которым рассчитывается SAR.
- `SarStep`, `SarMaximum` – параметры Parabolic SAR.
- `SignalBar` – количество закрытых свечей, на которое смещается сигнал (0 – текущая закрытая свеча, 1 – предыдущая и т.д.).

## Управление риском и особенности

- При старте вызывается `StartProtection()`, что активирует встроенные механизмы защиты StockSharp.
- Тайм-ауты рассчитываются по `CloseTime` свечи (при его отсутствии используется `OpenTime`), чтобы точно измерять время удержания позиции.
- В стратегии поддерживается только одна суммарная позиция. При развороте противоположное направление закрывается автоматически.
- Набор параметров соответствует MQL5-версии. Часть опций (например, режимы money-management, отличные от `Lot`, или `DeviationPoints`) служит заглушками из-за особенностей высокоуровневого API.
