# Стратегия Straddle Trail

## Описание

Стратегия **Straddle Trail** повторяет логику советника MetaTrader 5 "Straddle&Trail". Алгоритм выставляет пару стоп-заявок (стреддл) перед новостным событием либо сразу после запуска, а затем сопровождает открытую позицию переводом в безубыток, трейлинг-стопом и по команде может закрыть позиции или отменить отложенные заявки.

Реализация построена на высокоуровневом API StockSharp. Вся работа ведётся через стандартные методы `Strategy` без низкоуровневой обработки сообщений.

## Торговая логика

1. **Постановка стреддла**
   * Buy Stop и Sell Stop размещаются при наступлении временного окна события или мгновенно, если включён параметр `PlaceStraddleImmediately`.
   * Цены заявок отстоят от текущих Bid/Ask на `DistanceFromPrice` (в пипсах). Значение пересчитывается в абсолютную цену через шаг цены инструмента.
   * В течение одного торгового дня новая пара заявок не создаётся повторно, пока текущие ордера не будут отменены или скорректированы.

2. **Настройка перед событием**
   * При активном `AdjustPendingOrders` обе заявки раз в минуту удаляются и выставляются заново, чтобы оставаться симметричными относительно рынка.
   * Корректировка прекращается за `StopAdjustMinutes` минут до события, чтобы избежать гонки за ценой в момент роста волатильности.
   * Параметр `RemoveOppositeOrder` удаляет противоположную стоп-заявку после срабатывания первой половины стреддла.

3. **Сопровождение позиции**
   * Первичные стоп-лосс и тейк-профит рассчитываются по `StopLossPips` и `TakeProfitPips` и отслеживаются внутри стратегии.
   * При достижении прибыли `BreakevenTriggerPips` стоп переносится в безубыток с фиксацией `BreakevenLockPips`.
   * Трейлинг-стоп (`TrailPips`) может стартовать сразу или только после безубытка (`TrailAfterBreakeven`). Выходы выполняются рыночными заявками.

4. **Режим остановки**
   * Флаг `ShutdownNow` инициирует процедуру остановки, тип которой задаётся параметром `ShutdownMode` (закрыть лонги, шорты, отменить отложенные заявки или всё сразу).

## Параметры

| Параметр | Назначение |
|----------|------------|
| `ShutdownNow` | Флаг запуска процедуры остановки на ближайшей свече. После выполнения автоматически сбрасывается. |
| `ShutdownMode` | Что следует закрыть/отменить: `All`, `LongPositions`, `ShortPositions`, `PendingLong`, `PendingShort`. |
| `DistanceFromPrice` | Расстояние от рынка до каждой стоп-заявки в пипсах. |
| `StopLossPips` | Начальный стоп-лосс. `0` отключает стоп. |
| `TakeProfitPips` | Начальный тейк-профит. `0` отключает тейк. |
| `TrailPips` | Ширина трейлинг-стопа. `0` отключает трейлинг. |
| `TrailAfterBreakeven` | Запуск трейлинга только после переноса в безубыток. |
| `BreakevenLockPips` | Количество пипсов, фиксируемое после безубытка. |
| `BreakevenTriggerPips` | Порог прибыли для активации безубытка. |
| `EventHour` / `EventMinute` | Время новостного события по серверу. Обнуление обоих параметров отключает расписание. |
| `PreEventEntryMinutes` | За сколько минут до события ставить стреддл. Игнорируется при мгновенной постановке. |
| `StopAdjustMinutes` | За сколько минут до события прекратить корректировку заявок. |
| `RemoveOppositeOrder` | Удалять оставшийся стоп после открытия позиции. |
| `AdjustPendingOrders` | Поддерживать симметрию отложенных заявок. |
| `PlaceStraddleImmediately` | Ставить стреддл сразу после старта стратегии. |
| `CandleType` | Тип свечей, используемых для расчётов (по умолчанию 1 минута). |

> **Объём.** Размер позиции задаётся свойством `Volume` стратегии (по умолчанию 1 контракт/лот).

## Подписки на данные

* Свечи выбранного таймфрейма для оценки времени, трейлинга и обработки команд.
* Книга заявок для получения актуальных Bid/Ask и корректной расстановки стоп-заявок.

## Особенности

* Стопы и тейки исполняются рыночными ордерами, что упрощает портирование и повторяет оригинальный советник.
* Для расчёта пипса используется `PriceStep`. Для инструментов с нестандартным шагом подберите параметры вручную.
* Команда остановки проверяется только при приходе новой свечи. Для мгновенной реакции сократите таймфрейм.
* Поддержка ручных сделок (магик `0` в MQL) не реализована — стратегия управляет только собственными позициями.
* Версия на Python по требованию не создавалась.

## Примечания по конверсии

* Логика перевода в безубыток и трейлинг-стоп полностью повторяет исходный код MQL, но реализована через внутренние переменные и рыночные выходы.
* Система магических номеров заменена внутренним учётом заявок StockSharp, что избавляет от необходимости генерировать уникальные идентификаторы.

