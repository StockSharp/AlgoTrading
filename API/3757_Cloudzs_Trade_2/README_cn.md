# Cloudzs Trade 2 策略

## 概述
**Cloudzs Trade 2** 策略是 MetaTrader 4 专家顾问 `cloudzs_trade_2` 在 StockSharp 平台上的移植版本。原始策略通过组合两套条件——**站在极值区的随机指标反转**与**连续两个同向分形**——来决定进出场，同时使用主动的追踪止损机制保护浮动利润。本 C# 实现保持了原有的交易逻辑，并使用 `StrategyParam` 暴露所有参数，方便在 Designer 中优化或通过界面调整。

策略仅跟踪一组蜡烛数据（时间框架可配置），并独立计算以下两个信号来源：

1. **随机指标反转**：%D 线位于极值区（>=80 表示超买，<=20 表示超卖）并与上一根蜡烛的 %K 线交叉，从而触发做空或做多信号。
2. **双分形确认**：当市场连续出现两个向上分形（做空）或两个向下分形（做多）时触发信号。

当任意条件产生买入或卖出信号时，如果当前没有持仓且上一笔交易在不同日期平仓，则策略按该方向开仓。若已持仓并启用 `CloseOnOpposite`，当出现反向信号时也会提前平仓。

## 参数
| 参数 | 说明 | 默认值 |
| ---- | ---- | ------ |
| `LotSplitter` | 根据账户价值估算下单量的系数。 | `0.1` |
| `MaxVolume` | 下单量上限，0 表示不限制。 | `0` |
| `TakeProfitOffset` | 以价格单位表示的固定止盈距离。 | `0` |
| `TrailingStopOffset` | 追踪止损距离。 | `0.01` |
| `StopLossOffset` | 固定止损距离。 | `0.05` |
| `MinProfitOffset` | 当已实现的最大盈利达到 `ProfitPointsOffset` 后，回撤到该水平即平仓。 | `0` |
| `ProfitPointsOffset` | 触发最小利润保护前所需的最小盈利。 | `0` |
| `%K Period / %D Period / Slowing` | 随机指标周期设置。 | `8 / 8 / 4` |
| `Method` | 来自 MT4 的平滑方法编号（仅用于记录，StockSharp 中不起作用）。 | `3` |
| `PriceMode` | MT4 的价格模式编号（仅用于记录）。 | `1` |
| `UseStochasticCondition` | 是否启用随机指标条件。 | `true` |
| `UseFractalCondition` | 是否启用分形条件。 | `true` |
| `CloseOnOpposite` | 是否在出现反向信号时平仓。 | `true` |
| `CandleType` | 计算所使用的蜡烛类型与时间框架。 | `15 分钟` |

## 交易规则
### 多头信号
- %D 线低于或等于 20，并在上一根蜡烛上向下穿越 %K 线；
- **或** 连续出现两个向下分形；
- 当前无持仓，上一笔交易的平仓日期不同于当前蜡烛日期。

### 空头信号
- %D 线高于或等于 80，并在上一根蜡烛上向上穿越 %K 线；
- **或** 连续出现两个向上分形；
- 当前无持仓，上一笔交易在不同日期结束。

### 离场规则
- 触发固定止损或止盈；
- 价格触及追踪止损；
- 在获得 `ProfitPointsOffset` 的盈利后，如价格回撤至 `MinProfitOffset`，立即平仓；
- 启用 `CloseOnOpposite` 时，反向信号会关闭现有仓位。

## 风险控制
- 止损与止盈距离按照原始 EA 的“点差”概念实现，即直接使用价格差。
- 追踪止损始终沿盈利方向移动，并基于收盘价更新。
- 交易量根据账户市值估算；若无法获取账户信息，则使用 `LotSplitter` 默认值。

## 注意事项
- StockSharp 提供的随机指标只有一种平滑方式，因此 `Method` 与 `PriceMode` 仅用于保留原策略信息，不会改变计算结果。
- 原策略按 tick 数据运行，为了符合 StockSharp 的最佳实践，移植版仅处理收盘后的蜡烛。

## 使用步骤
1. 将策略加入 StockSharp 项目，并指定交易标的。
2. 设置蜡烛时间框架以及随机指标、风险管理等参数。
3. 根据交易品种的最小价格波动单位调整止损/止盈距离。
4. 在 Designer、Runner 或 API 环境中启动策略，并关注日志了解信号和订单执行情况。
