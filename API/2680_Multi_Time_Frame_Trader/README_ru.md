# Стратегия Multi Time Frame Trader
[English](README.md) | [中文](README_cn.md)

Стратегия воспроизводит оригинальную MQL-реализацию «Multi Time Frame Trader» на базе высокоуровневого API StockSharp. Она
использует три полиномиальных регрессионных канала (M1, M5 и H1) и открывает сделки только тогда, когда младшие таймфреймы
касаются границ канала в сторону, заданную наклоном часового канала.

Для каждого таймфрейма на закрытии свечи заново рассчитываются верхняя, средняя и нижняя границы канала. Если верхняя граница на
H1 снижается, стратегия работает в сторону продаж; если растет — в сторону покупок. Точки входа формируются, когда свечи M5 и
M1 достигают соответствующих границ, а фильтр по часовому наклону подтверждает направление.

## Основные этапы работы

- **Подписки**: стратегия одновременно подписывается на минутные, пятиминутные и часовые свечи.
- **Регрессионный канал**: на каждом потоке строится полиномиальная регрессия степени `Degree` по `Bars` точкам и смещается на
  `StdMultiplier` стандартных отклонений для получения уровней сопротивления и поддержки.
- **Оценка наклона**: наклон определяется разницей между текущей верхней границей и значением этой границы `Bars` свечей назад —
  так же, как в индикаторе `i-Regr`.
- **Фильтр направления**: наклон H1 задает, разрешены ли только продажи (наклон отрицательный) или только покупки (наклон
  положительный).

## Правила входа

### Короткие позиции

1. Наклон часового канала отрицательный.
2. Максимум последней свечи M5 касается или пробивает верхнюю границу пятиминутного канала.
3. Максимум последней свечи M1 касается или пробивает верхнюю границу минутного канала.
4. Открытых коротких позиций нет (`Position >= 0`).
5. Регистрируется рыночная продажа, стоп-лосс ставится на половину ширины канала выше цены входа, тейк-профит равен средней линии M5.

### Длинные позиции

1. Наклон часового канала положительный.
2. Минимум последней свечи M5 касается или пробивает нижнюю границу пятиминутного канала.
3. Минимум последней свечи M1 касается или пробивает нижнюю границу минутного канала.
4. Открытых длинных позиций нет (`Position <= 0`).
5. Регистрируется рыночная покупка, стоп-лосс ставится на половину ширины канала ниже цены входа, тейк-профит равен средней линии M5.

## Правила выхода

- Стоп-лоссы и тейк-профиты хранятся внутри стратегии и проверяются на каждой закрытой свече M1. Если диапазон свечи пересекает
  стоп-уровень, позиция немедленно закрывается.
- Если раньше достигается тейк-профит, позиция также закрывается.
- После выхода все уровни обнуляются, чтобы следующий сигнал обработался без задержки.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Degree` | 1 | Степень полинома регрессионного канала (1 — линейная, 2 — параболическая, 3 — кубическая). |
| `StdMultiplier` | 2.0 | Множитель стандартного отклонения, определяющий ширину канала. |
| `Bars` | 250 | Количество свечей для расчета регрессии и сравнения наклона. |
| `Shift` | 0 | Горизонтальный сдвиг точки оценки регрессии (ограничен диапазоном 0…`Bars - 1`). |
| `UseTrading` | true | При значении `false` заявки не выставляются, но каналы продолжают обновляться. |

## Дополнительная информация

- Стоп- и целевые уровни управляются вручную, так как рыночные заявки StockSharp не прикрепляют SL/TP автоматически.
- Стратегия применима к любым инструментам с минутными и часовыми свечами; исходная версия ориентировалась на валютные пары.
- Параметр `Bars` стоит адаптировать под волатильность инструмента: меньшие значения дают более быстрые реакции, большие — более
  сглаженные каналы.
- Значение `Degree = 1` соответствует классическому линейному каналу, а более высокие степени повторяют полиномиальные режимы
  оригинального индикатора.
