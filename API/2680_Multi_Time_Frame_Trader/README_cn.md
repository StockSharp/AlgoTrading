# Multi Time Frame Trader 策略
[English](README.md) | [Русский](README_ru.md)

该策略基于 StockSharp 高级 API 复刻了原始 MQL 版本的「Multi Time Frame Trader」。策略同时使用 1 分钟、5 分钟
和 1 小时三条多项式回归通道，只有在短周期触及通道边界且方向与小时通道斜率一致时才会开仓。

每根完成的 K 线都会重新计算对应时间框架的通道上轨、中轨和下轨。如果小时级上轨下降，系统偏空；上轨
上升则偏多。当 M5 和 M1 的价格触及对应边界且方向筛选满足条件时，触发入场。

## 运行流程

- **订阅**：同时订阅 1 分钟、5 分钟和 1 小时的蜡烛数据。
- **回归通道**：每个订阅都使用 `Bars` 根历史数据拟合 `Degree` 阶多项式回归，并按照 `StdMultiplier` 个标准
  差向上/向下平移，得到阻力和支撑带。
- **斜率估计**：通道斜率由当前上轨与 `Bars` 根之前的上轨差值计算，完全对齐 `i-Regr` 指标的做法。
- **方向过滤**：小时图斜率决定是否只允许做空（斜率为负）或只允许做多（斜率为正）。

## 入场条件

### 做空

1. 小时通道斜率为负。
2. 最新一根 M5 K 线的最高价触及或突破 M5 回归上轨。
3. 最新一根 M1 K 线的最高价触及或突破 M1 回归上轨。
4. 当前没有持有空头仓位（`Position >= 0`）。
5. 发送市价卖出，止损放在入场价上方半个通道宽度，止盈设为 M5 中轨。

### 做多

1. 小时通道斜率为正。
2. 最新一根 M5 K 线的最低价触及或跌破 M5 回归下轨。
3. 最新一根 M1 K 线的最低价触及或跌破 M1 回归下轨。
4. 当前没有持有多头仓位（`Position <= 0`）。
5. 发送市价买入，止损放在入场价下方半个通道宽度，止盈设为 M5 中轨。

## 平仓规则

- 止损和止盈在策略内部保存，并在每根完成的 M1 K 线上进行检查。一旦 K 线区间触及止损，立即平仓。
- 如果先到达止盈，也会立刻平仓。
- 平仓后会清空保存的止损/止盈，以便下一次信号无需等待。

## 参数说明

| 参数 | 默认值 | 描述 |
|------|--------|------|
| `Degree` | 1 | 回归通道的多项式阶数（1=线性，2=二次，3=三次）。 |
| `StdMultiplier` | 2.0 | 用于通道宽度的标准差倍数。 |
| `Bars` | 250 | 用于回归拟合和斜率比较的历史 K 线数量。 |
| `Shift` | 0 | 回归评估点的水平偏移（限制在 0 至 `Bars - 1`）。 |
| `UseTrading` | true | 为 `false` 时仅计算指标，不发送任何委托。 |

## 其他提示

- 因为 StockSharp 的市价单不会自动附带止损/止盈，策略会自行跟踪并在满足条件时手动平仓。
- 适用于提供分钟和小时数据的任何品种，原始版本主要针对外汇货币对。
- `Bars` 可按交易品种的波动性调整：较小值响应更快，较大值生成更平滑的通道。
- 当 `Degree = 1` 时等同于经典线性回归通道，更高阶数可以模拟原指标的多项式模式。
