# Macd Pattern Trader Trigger Strategy

## Обзор
Macd Pattern Trader Trigger Strategy — порт советника MetaTrader 4 `MacdPatternTraderv05cb` на высокоуровневый API StockSharp. Стратегия торгует чистые паттерны гистограммы MACD: двойная вершина ниже нулевой линии открывает короткие позиции, зеркальное двойное дно выше нуля — длинные. Управление сделками полностью повторяет исходного советника: входы по рынку с фиксированным стоп-лоссом и тейк-профитом, задаваемыми в пунктах инструмента.

## Логика стратегии
### Поток данных
* Используется одна подписка на свечи (по умолчанию 15-минутные). Каждая завершённая свеча обрабатывается индикатором `MovingAverageConvergenceDivergence` с оригинальными параметрами MT4 `(fast = 13, slow = 5, signal = 1)`.
* Стратегия применяет только основную линию MACD. Последние три завершённые значения буферизуются, что эмулирует вызовы `iMACD(..., MODE_MAIN, shift=1..3)` из MetaTrader.

### Условия для покупок
1. **Взвод** — линия MACD должна подняться выше `Bullish Trigger` (по умолчанию `0.0015`). Любое падение ниже нуля полностью сбрасывает состояние.
2. **Окно отката** — после взвода MACD должен опуститься ниже `Bullish Reset` (по умолчанию `0.0005`). В этом диапазоне ищется разворотный рисунок.
3. **Подтверждение** — при активном окне три буферных значения должны выполняться:
   * `macd_curr > macd_last` — импульс разворачивается вверх;
   * `macd_last < macd_last3` — предыдущая свеча сформировала локальный минимум;
   * `macd_curr > Bullish Reset` и `macd_last < Bullish Reset` — возврат из неглубокой зоны отката.
4. **Исполнение** — покупка по рынку. Если есть короткая позиция, объём заявки автоматически включает её закрытие и формирует чистый лонг заданного размера.

### Условия для продаж
1. **Взвод** — линия MACD должна упасть ниже `-Bearish Trigger` (по умолчанию `-0.0015`). Подъём выше нуля обнуляет состояние.
2. **Окно отката** — после взвода MACD должен подняться выше `-Bearish Reset` (по умолчанию `-0.0005`).
3. **Подтверждение** — при активном окне выполняются условия:
   * `macd_curr < macd_last`;
   * `macd_last > macd_last3`;
   * `macd_curr < -Bearish Reset` и `macd_last > -Bearish Reset`.
4. **Исполнение** — продажа по рынку. Если открыта длинная позиция, её объём включается в заявку и итоговое сальдо становится шортом с нужным размером.

### Управление риском
* **Фиксированный стоп/профит** — расстояния задаются в пунктах (шага цены). Стратегия умножает их на `PriceStep` инструмента и вызывает `StartProtection`, полностью копируя логику SL/TP из MT4. Ноль отключает соответствующий уровень.
* **Один сигнал на окно** — после открытия сделки флаги взвода и окна сбрасываются, предотвращая повторные входы от одного и того же паттерна MACD.

## Параметры
* **Trade Volume** — объём рыночных заявок. При смене направления противоположная позиция закрывается автоматически.
* **Fast EMA / Slow EMA / Signal EMA** — периоды MACD. Значения по умолчанию соответствуют оригинальному советнику и могут оптимизироваться.
* **Bullish Trigger / Reset** — положительные пороги MACD (в единицах индикатора), определяющие взвод и зону отката для покупок.
* **Bearish Trigger / Reset** — абсолютные пороги MACD для продаж. Триггер применяется со знаком минус в ходе расчётов.
* **Stop Loss / Take Profit** — расстояния в пунктах. Значение `0` отключает защиту.
* **Candle Type** — таймфрейм, по которому строятся индикаторы и принимаются решения.

## Особенности реализации
* Используется только высокоуровневый API StockSharp: `SubscribeCandles` подаёт данные на индикатор, а `StartProtection` воспроизводит постановку стопов и целей.
* Буфер MACD гарантирует работу с тремя предыдущими завершёнными барами, полностью соответствуя вызовам `shift=1..3` в MetaTrader.
* В пакете отсутствует Python-версия, доступна только реализация на C#.
