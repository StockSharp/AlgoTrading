# Стратегия Frank Ud (минимальная версия)

Пример демонстрирует портирование классического советника **Frank Ud** из MetaTrader в StockSharp на основе высокоуровневого API. Оригинальный MQL-скрипт ведёт две хеджирующие сетки (лонгов и шортов), наращивая позицию при движении цены против последнего входа. Как только самый свежий (и самый крупный) ордер приносит фиксированное число пунктов, все сделки данного направления закрываются единовременно.

## Основные идеи

1. **Симметричное хеджирование.** Стратегия параллельно ведёт «лестницы» длинных и коротких позиций, поэтому может держать лонги и шорты одновременно, как и в режиме хеджирования MetaTrader.
2. **Мартингейл.** Первый ордер на каждой стороне использует `InitialVolume` (по умолчанию 0.1 лота). Каждый следующий вход удваивает наибольший уже открытый объём. При расчёте учитываются биржевые ограничения `MinVolume`, `MaxVolume`, `VolumeStep`.
3. **Шаг сетки.** Добавление нового ордера допускается только после смещения цены минимум на `ReEntryPips` (41 пункт) относительно лучшей цены текущей лестницы. Для лонгов требуется падение ask ниже `минимальная_цена_покупки - ReEntryPips`, для шортов — рост bid выше `максимальная_цена_продажи + ReEntryPips`.
4. **Фиксация прибыли.** Ордер с наибольшим объёмом играет роль «триггера». Когда его прибыль превышает `TakeProfitPips` (65 пунктов) либо цена достигает скрытого уровня `(TakeProfitPips + 25)` из оригинала, весь соответствующий блок позиций закрывается одной рыночной заявкой.
5. **Контроль маржи.** Перед отправкой нового ордера проверяется, что свободная маржа (`CurrentValue - BlockedValue`) выше порога `Balance × MinimumFreeMarginRatio` (по умолчанию 0.5). Если коннектор не предоставляет эти значения, стратегия работает с фиксированными объёмами, как и исходный советник.

## Параметры

| Параметр | Описание |
|----------|----------|
| `TakeProfitPips` | Порог прибыли в пунктах для самого крупного ордера. При превышении закрываются все позиции данного направления. |
| `ReEntryPips` | Минимальное расстояние в пунктах между лучшей ценой входа и текущей ценой, необходимое для следующего усреднения. |
| `InitialVolume` | Базовый объём первой заявки в каждой сетке; последующие ордера удваивают максимальный активный объём. |
| `MinimumFreeMarginRatio` | Минимально допустимое отношение свободной маржи к балансу. При значении 0 проверка отключается. |

## Особенности реализации

- Стратегия использует только Level1-котировки: обновления bid управляют шортами, ask — лонгами.
- Для отслеживания назначения ордеров используется словарь, чтобы `OnNewMyTrade` понимал, было ли исполнение открытием или закрытием. Это аналог массивов ордеров в MQL.
- Каждое исполнение сохраняется в списке (цена + объём), что позволяет точно вычислять максимальный лот и его цену входа, как в оригинальном коде.
- Дополнительный буфер в 25 пунктов к уровню тейк-профита, присутствующий в MQL-версии, сохранён как альтернативное условие выхода.

> **Важно:** по требованию Python-версия не создавалась — каталог содержит только C#-код и документацию на трёх языках.
