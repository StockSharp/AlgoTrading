# Стратегия Macd Secrets

## Общее описание
**Macd Secrets** — это порт оригинального советника "Macd Secrets I" на платформу StockSharp. Перенос выполнен на высокоуровневом API и строится на сочетании трёх временных горизонтов MACD, фильтрации через линейно-взвешенные скользящие средние (LWMA) и проверки отклонения осциллятора Momentum. В отличие от исходного советника, версия для StockSharp ведёт только одну суммарную позицию, что упрощает контроль над рисками и делает поведение стратегии прозрачнее.

## Правила входа
### Лонг
1. На рабочем таймфрейме быстрая LWMA располагается ниже медленной LWMA, что сигнализирует о нахождении цены в нижней части трендового канала (тот же фильтр присутствует в MQL-версии).
2. Линия MACD выше сигнальной на всех трёх таймфреймах: рабочем, подтверждающем и долгосрочном (месячном).
3. На подтверждающем таймфрейме хотя бы одно из трёх последних значений Momentum отклоняется от уровня 100 минимум на заданный порог (по умолчанию 0.3), как и в исходном коде (`MathAbs(100 - Momentum)`).
4. Открытых позиций нет.

При выполнении условий отправляется рыночная заявка на покупку с заданным объёмом.

### Шорт
1. Линия MACD ниже сигнальной на рабочем, подтверждающем и месячном таймфреймах.
2. В одной из трёх последних свечей подтверждающего таймфрейма зафиксировано отклонение Momentum от 100, превышающее порог для коротких сделок.
3. Текущая позиция отсутствует (стратегия не хеджирует и не наращивает пирамиду).

При выполнении всех пунктов размещается рыночная заявка на продажу.

### Управление сделкой
- В начале работы стратегия может включить защиту через `StartProtection`, переводя заданные дистанции стоп-лосса и тейк-профита из пунктов в цену с помощью шага цены инструмента.
- Перенос не включает исходные механизмы трейлинг-стопа, перевода в безубыток, монетарных ограничений по прибыли/убытку или глобального контроля по капиталу.
- Сигналы анализируются только после закрытия свечей, чтобы исключить шум внутри бара.

## Временные горизонты
- **Основной таймфрейм** (по умолчанию 15 минут) — рассчитываются MACD и пара LWMA.
- **Подтверждающий таймфрейм** (по умолчанию 1 час) — здесь работают MACD и Momentum, а также собираются три последних отклонения Momentum.
- **Месячный таймфрейм** (по умолчанию 30 дней) — обеспечивает долгосрочное подтверждение направления MACD.

Переопределение `GetWorkingSecurities` гарантирует запрос всех трёх подписок у коннектора до запуска расчётов.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `OrderVolume` | Объём сделки в лотах. | `0.1` |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах (0 — отключить). | `50` |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах (0 — отключить). | `20` |
| `FastMaPeriod` | Период быстрой LWMA на рабочем таймфрейме. | `6` |
| `SlowMaPeriod` | Период медленной LWMA на рабочем таймфрейме. | `85` |
| `MacdFastPeriod` | Период быстрой EMA в MACD. | `12` |
| `MacdSlowPeriod` | Период медленной EMA в MACD. | `26` |
| `MacdSignalPeriod` | Период сигнальной EMA в MACD. | `9` |
| `MomentumPeriod` | Длина окна Momentum на подтверждающем таймфрейме. | `14` |
| `MomentumBuyThreshold` | Минимальное отклонение Momentum для лонгов. | `0.3` |
| `MomentumSellThreshold` | Минимальное отклонение Momentum для шортов. | `0.3` |
| `PrimaryCandleType` | Таймфрейм исполнения (по умолчанию 15 минут). | `15m` |
| `TrendCandleType` | Таймфрейм подтверждения (по умолчанию 1 час). | `1h` |
| `MonthlyCandleType` | Долгосрочный таймфрейм (по умолчанию 30 дней). | `30d` |

## Практические рекомендации
- Фильтр LWMA намеренно асимметричен: он применяется только к лонгам, что соответствует поведению исходного советника.
- В портированной версии отсутствует функция `LotsOptimized`; объём сделок постоянен. Для реализации ступенчатого набора позиций потребуется собственный учёт уже исполненного объёма.
- Перед запуском убедитесь, что провайдер данных поддерживает все используемые таймфреймы, иначе индикаторы не смогут сформироваться.
- Если месячные свечи недоступны, укажите альтернативный `DataType` с нужной периодичностью.
- Стратегия работает только с завершёнными свечами и не обращается к индикаторам напрямую через буферы, что соответствует рекомендациям StockSharp.

## Отличия от оригинала
- Нет трейлинг-стопа, перевода в безубыток, денежных лимитов и уведомлений (e-mail, push и т.д.).
- Нет пирамидинга и мартингейла — стратегия всегда открывает одну позицию фиксированного объёма.

## Предупреждение
Торговля на финансовых рынках связана с повышенным риском. Перед использованием стратегии на реальном счёте протестируйте её на исторических данных и в демо-режиме.
