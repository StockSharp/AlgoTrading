# Стратегия Tops Bottoms Trend RSI

## Общее описание
Стратегия представляет собой порт MetaTrader-советника «Tops bottoms trend and rsi ea» на платформу StockSharp. Алгоритм анализирует закрытые свечи выбранного таймфрейма, ищет формирование локальных максимумов и минимумов в заданном окне истории и подтверждает сигналы фильтром Relative Strength Index (RSI). При выполнении условий стратегия открывает единственную рыночную позицию и сразу рассчитывает защитные стоп-лосс и тейк-профит на основе пипсовых расстояний.

## Логика торговли
- **Источник данных.** Подписка оформляется на указанный тип свечей, в расчёт берутся только завершённые бары, чтобы исключить неполные данные.
- **Поиск дна (лонг).** Закрытие текущей свечи должно находиться минимум на `BuyTrendPips` пипсов ниже максимума свечи сдвига `BuyTrendCandles`. Все промежуточные минимумы обязаны оставаться выше текущего закрытия, а фильтр качества (`BuyTrendQuality`) не допускает сильного расхождения недавних максимумов от опорного уровня. Дополнительно требуется, чтобы значение RSI на предыдущей свече было ниже `BuyRsiThreshold`. При выполнении условий открывается длинная позиция объёмом `BuyVolume`.
- **Поиск вершины (шорт).** Закрытие текущей свечи должно быть минимум на `SellTrendPips` пипсов выше минимума свечи сдвига `SellTrendCandles`. Промежуточные максимумы не могут превышать текущее закрытие, а фильтр качества (`SellTrendQuality`) контролирует близость недавних минимумов к опорному уровню. Если при этом значение RSI на предыдущей свече превышает `SellRsiThreshold`, открывается короткая позиция объёмом `SellVolume`.
- **Управление рисками.** После входа стратегия запоминает цену исполнения и вычисляет защитные уровни в пипсах. Стоп-лосс задаётся параметрами `BuyStopLossPips` или `SellStopLossPips`. Тейк-профит рассчитывается как процент от стопа (`BuyTakeProfitPercentOfStop`, `SellTakeProfitPercentOfStop`). Для длинных позиций при нулевом проценте используется фиксированное значение `BuyTakeProfitPips`. При достижении ценой соответствующих уровней позиция закрывается рыночным ордером.
- **Контроль позиции.** В работе допускается только одна открытая позиция, новые сигналы игнорируются до её закрытия. RSI всегда оценивается по предыдущей свече (сдвиг 1), что повторяет логику оригинального эксперта.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `BuyVolume` | Объём заявки при открытии длинных позиций. | `0.01` |
| `BuyStopLossPips` | Размер стоп-лосса для лонгов в пипсах. | `20` |
| `BuyTakeProfitPips` | Фиксированный тейк-профит в пипсах для лонгов (используется при отключённом проценте). | `5` |
| `BuyTakeProfitPercentOfStop` | Тейк-профит как процент от расстояния стоп-лосса для лонгов. | `100` |
| `SellVolume` | Объём заявки при открытии коротких позиций. | `0.01` |
| `SellStopLossPips` | Размер стоп-лосса для шортов в пипсах. | `20` |
| `SellTakeProfitPercentOfStop` | Тейк-профит как процент от расстояния стоп-лосса для шортов. | `100` |
| `SellTrendCandles` | Количество свечей в окне поиска вершины. | `10` |
| `SellTrendPips` | Минимальный подъём над опорным минимумом для открытия шорта (в пипсах). | `20` |
| `SellTrendQuality` | Фильтр качества тренда для шортов (ограничение 1–9). | `5` |
| `BuyTrendCandles` | Количество свечей в окне поиска дна. | `10` |
| `BuyTrendPips` | Минимальное падение ниже опорного максимума для открытия лонга (в пипсах). | `20` |
| `BuyTrendQuality` | Фильтр качества тренда для лонгов (ограничение 1–9). | `5` |
| `BuyRsiPeriod` | Период RSI для подтверждения длинных сделок. | `14` |
| `BuyRsiThreshold` | Порог RSI, определяющий перепроданность для лонгов. | `40` |
| `SellRsiPeriod` | Период RSI для подтверждения коротких сделок. | `14` |
| `SellRsiThreshold` | Порог RSI, определяющий перекупленность для шортов. | `60` |
| `CandleType` | Таймфрейм анализируемых свечей. | `30 минут` |

## Примечания
- Перевод пипсов в цену выполняется через `PriceStep` инструмента. Для пятизначных котировок и дробных пипсов применяется нормализация к классическому размеру пипса, как в оригинальном советнике.
- Из-за использования значения RSI предыдущей свечи стратегия пропускает первые несколько баров до формирования индикатора и затем поддерживает сдвиг в одну свечу.
- При полном закрытии позиции защитные уровни сбрасываются, чтобы следующий вход стартовал с чистыми настройками риска.
