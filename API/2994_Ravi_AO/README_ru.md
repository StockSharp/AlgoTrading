# Стратегия RAVI + Awesome Oscillator

## Общее описание
- Порт советника MetaTrader 5 "Ravi AO (barabashkakvn's edition)" на высокоуровневый API StockSharp.
- Использует связку индикаторов RAVI (Range Action Verification Index) и Awesome Oscillator для поиска синхронных смен импульса.
- Подходит для любого таймфрейма и инструмента, все расстояния задаются в пунктах как в оригинальном советнике.

## Индикаторы
- **RAVI** – рассчитывается по формуле `100 * (FastMA - SlowMA) / SlowMA` для выбранного ценового ряда. Доступен выбор метода сглаживания (простое, экспоненциальное, сглаженное, взвешенное среднее), длин и типа цены (close, open, high, low, median, typical, weighted, simple, quarter, trend-follow, Demark).
- **Awesome Oscillator** – моментум на основе медианной цены с настраиваемыми коротким и длинным периодами (по умолчанию 5 и 34, как в MT5).

## Параметры
| Параметр | Описание |
| --- | --- |
| `CandleType` | Тип свечей/данных, на которые подписывается стратегия. |
| `StopLossPips` | Размер стоп-лосса в пунктах. Значение `0` отключает стоп. |
| `TakeProfitPips` | Размер тейк-профита в пунктах. Значение `0` отключает тейк. |
| `TrailingStopPips` | Базовая дистанция трейлинг-стопа в пунктах. `0` — трейлинг выключен. |
| `TrailingStepPips` | Минимальное дополнительное движение цены (в пунктах), после которого трейлинг подтягивает стоп. При включенном трейлинге должно быть > 0. |
| `FastMethod` / `FastLength` | Метод сглаживания и длина быстрого среднего RAVI. |
| `SlowMethod` / `SlowLength` | Метод сглаживания и длина медленного среднего RAVI. |
| `AppliedPrices` | Формула расчёта цены для обоих средних (close, open, high, low, median, typical, weighted, simple, quarter, trend-follow #1/#2, Demark). |
| `AoShortPeriod` / `AoLongPeriod` | Короткий и длинный периоды Awesome Oscillator. |

## Правила входа
1. Расчёт индикаторов выполняется по завершённым свечам (`CandleStates.Finished`).
2. **Лонг** открывается, когда:
   - AO два бара назад `< 0`, а один бар назад `> 0`, и
   - RAVI два бара назад `< 0`, а один бар назад `> 0`.
3. **Шорт** открывается, когда:
   - AO два бара назад `> 0`, а один бар назад `< 0`, и
   - RAVI два бара назад `> 0`, а один бар назад `< 0`.
4. Одновременно поддерживается только одна позиция; новые сигналы игнорируются, пока позиция открыта.

## Управление выходом
- **Стоп-лосс**: вычисляется по `StopLossPips` с учётом `Security.PriceStep`. Для инструментов с 5 и 3 знаками после запятой шаг умножается на 10, как в MT5. Срабатывает, если минимум/максимум свечи достигает стоп-уровня.
- **Тейк-профит**: опциональный уровень, рассчитывается аналогично. Отключается значением `0`.
- **Трейлинг-стоп**: при включении подтягивает стоп, когда плавающая прибыль превышает `TrailingStopPips + TrailingStepPips`. Для лонга стоп переносится на `ClosePrice - TrailingStopPips`, для шорта – на `ClosePrice + TrailingStopPips`.
- Все выходы закрывают позицию полностью рыночной заявкой.

## Особенности реализации
- Сделки совершаются по цене закрытия сигнальной свечи. В MT5 версия входила на открытии следующего бара, поэтому возможны расхождения.
- Используются только стандартные скользящие средние StockSharp, экзотические алгоритмы сглаживания MT5 (JJMA, Jurik, T3 и т. п.) недоступны.
- Визуальный параметр `Shift` исходного индикатора влияет только на отображение и в стратегию не включён.
- Формулы `AppliedPrices` повторяют определения MetaTrader, включая варианты TrendFollow и Demark.

## Рекомендации
- Стратегия трендовая, рекомендуется комбинировать её с фильтрами старшего таймфрейма или фильтрами волатильности.
- Подбирайте длины средних и дистанции стопов под каждый инструмент: размер пункта вычисляется через `Security.PriceStep`.
- При необходимости брокерских стопов используйте `Strategy.StartProtection` или внешнее сопровождение позиций.
