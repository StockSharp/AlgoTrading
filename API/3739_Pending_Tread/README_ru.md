# Стратегия Pending Tread

Перевод советника MetaTrader **Pending_tread** на платформу StockSharp. Стратегия постоянно поддерживает два набора отложенных ордеров: сетку выше рынка и сетку ниже. Для каждой сетки можно выбрать направление (покупка/продажа), а также задать стоп-лосс и тейк-профит в «мт-шных» пипсах. Дополнительно реализована защита по эквити, повторяющая аварийное закрытие из оригинального эксперта.

## Принцип работы

1. Подписка на поток Level 1 фиксирует лучшие цены bid/ask. Каждые пять секунд (или после паузы, если данные отсутствовали) стратегия проверяет необходимость выставления новых ордеров.
2. Для каждой включённой сетки (выше или ниже рынка) считается количество активных ордеров, созданных стратегией. Если их меньше 10, выставляются дополнительные заявки на кратных расстояниях `PipStep` от текущего bid/ask.
3. Пересчёт пипсов в абсолютную цену выполняется через `PriceStep` инструмента. Для инструментов с 3 или 5 знаками после запятой автоматически применяется множитель ×10, как в MetaTrader.
4. Стоп-лосс и тейк-профит добавляются непосредственно к отложенной заявке, если указаны положительные расстояния. При отключённом стопе заявки остаются без защиты – поведение соответствует оригиналу.
5. Эквити-гард запоминает стартовую стоимость портфеля. Когда текущее эквити опускается ниже `MaxLossPercent` от начального значения, все позиции закрываются рыночными ордерами, а связанные отложенные заявки отменяются.

## Параметры

| Параметр | Описание |
|----------|----------|
| `PipStep` | Расстояние между соседними отложенными ордерами в пипсах MetaTrader. |
| `TakeProfitPips` | Дистанция до тейк-профита (в пипсах). Ноль — отключить. |
| `StopLossPips` | Дистанция до стоп-лосса (в пипсах). Ноль или отключённый флаг — без стопа. |
| `OrderVolume` | Объём каждого отложенного ордера. Нормализуется под шаг объёма инструмента. |
| `Slippage` | Параметр-«заглушка» для совместимости с оригиналом. В StockSharp лимит/стоп цены работают без него. |
| `EnableBuyGrid` / `EnableSellGrid` | Включение сеток выше и ниже рынка. При отключении соответствующие ордера отменяются. |
| `AboveMarketTradeDirection` / `BelowMarketTradeDirection` | Направление (buy/sell) для сетки выше и ниже рынка. |
| `EnableStopLoss` | Добавлять ли стоп-лосс к отложенным ордерам. |
| `MinimumEquity` | Минимальное эквити портфеля. Пока значение ниже порога, новые заявки не выставляются. |
| `EnableEquityLossProtection` | Включает защиту по эквити: при превышении порога все позиции закрываются, заявки удаляются. |
| `MaxLossPercent` | Допустимая просадка от стартового эквити (в процентах), после которой срабатывает защита. |

### Фиксированное поведение

- Каждая сетка содержит максимум **10** заявок — это портирование константы `totalOrdersPerSide` из MQL5.
- Новые заявки отправляются не чаще одного раза в пять секунд, что повторяет задержку `lastOrderTime`.
- Комментарии к ордерам содержат префикс стратегии, поэтому при смене направления старые заявки автоматически отменяются.

## Рекомендации

1. Убедитесь, что у инструмента задан корректный `PriceStep`, иначе пересчёт пипсов будет некорректным.
2. Запускайте стратегию с подключённым портфелем — это необходимо для фиксации стартового эквити в защите.
3. Отключение сетки приводит к отмене всех её заявок. Повторное включение создаёт новую лестницу из 10 слоёв от текущей цены.
4. Так как стоп/тейк прикреплены к самой отложенной заявке, дополнительных защитных ордеров после исполнения не требуется.

## Файлы

- `CS/PendingTreadStrategy.cs` — реализация стратегии на C# с использованием высокоуровневого API StockSharp.
