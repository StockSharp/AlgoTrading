# Pending Tread 策略

将 MetaTrader 专家顾问 **Pending_tread** 移植到 StockSharp。策略会同时维护两组挂单网格：一组位于市场价格之上，另一组位于市场价格之下。每组网格都可以在买入/卖出模式之间切换，并可以为挂单设置以 MetaTrader 点值表示的止损与止盈。同时还实现了与原版相同的权益防护机制。

## 工作流程

1. 订阅 Level 1 数据以获取最新买价和卖价。策略每 5 秒（或在暂停后恢复数据时）检查是否需要补充新的挂单。
2. 对于每个启用的网格（上方或下方），统计策略自己创建的有效挂单数量。如果少于 10 单，就按照 `PipStep` 的倍数在当前买价/卖价附近继续补单。
3. 工具会根据证券的 `PriceStep` 自动把 MetaTrader 点值转换为绝对价格。报价保留 3 位或 5 位小数的品种会自动应用 ×10 的点值系数。
4. 当止损或止盈距离大于零时，会直接把对应价格附加到挂单上。如果禁用止损，则挂单不会携带保护，同原始 EA 完全一致。
5. 权益防护会记录启动时的投资组合价值。一旦当前权益相对于初始值的回撤超过 `MaxLossPercent`，策略会平掉所有持仓并取消所有网格挂单。

## 参数

| 名称 | 说明 |
|------|------|
| `PipStep` | 相邻挂单之间的距离（MetaTrader 点）。 |
| `TakeProfitPips` | 止盈距离（点）。设为 0 可关闭。 |
| `StopLossPips` | 止损距离（点）。设为 0 或关闭开关即可不附加止损。 |
| `OrderVolume` | 每个挂单的下单量，会根据合约的成交量步长自动归一化。 |
| `Slippage` | 为了与原版保持一致而保留的占位参数。StockSharp 的限价/止损委托不使用该值。 |
| `EnableBuyGrid` / `EnableSellGrid` | 控制上方/下方网格是否启用。关闭某一网格会同时取消其挂单。 |
| `AboveMarketTradeDirection` / `BelowMarketTradeDirection` | 选择对应网格使用买单还是卖单。 |
| `EnableStopLoss` | 是否为挂单附加止损。 |
| `MinimumEquity` | 最低权益阈值。当组合权益低于该值时，策略暂停创建新挂单。 |
| `EnableEquityLossProtection` | 启用权益防护：触发后立即平仓并撤销所有挂单。 |
| `MaxLossPercent` | 相对于初始权益允许的最大亏损百分比，超过即触发防护。 |

### 固定行为

- 每个网格最多同时保留 **10** 张挂单，完全对应 MQL5 里的 `totalOrdersPerSide` 常量。
- 下单节奏限制为每 5 秒一次，模拟原始代码中的 `lastOrderTime` 延迟。
- 所有挂单都带有统一的备注前缀，便于在切换网格方向时自动撤销旧挂单。

## 使用提示

1. 请确保证券提供有效的 `PriceStep`，否则点值换算会不正确。
2. 启动策略时需要连接有效的投资组合，以便记录初始权益供防护机制使用。
3. 关闭某个网格会立即撤销其挂单；重新启用后会按照当前市价重新构建 10 层挂单梯队。
4. 由于止盈/止损已经直接附加在挂单上，成交后无需额外的保护委托。

## 文件

- `CS/PendingTreadStrategy.cs` —— 基于 StockSharp 高级策略 API 的 C# 实现。
