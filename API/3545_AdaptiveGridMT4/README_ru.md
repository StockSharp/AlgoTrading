# Adaptive Grid MT4 (порт для StockSharp)

## Обзор

Стратегия повторяет советник "Adaptive Grid Mt4" на высокоуровневом API StockSharp. Она размещает симметричную сетку из
отложенных Buy Stop и Sell Stop вокруг цены закрытия текущей свечи. Расстояния между уровнями вычисляются через показатель
Average True Range (ATR), поэтому сетка автоматически подстраивается под волатильность рынка. Каждая заявка имеет ограниченный
срок жизни в свечах, что предотвращает захламление книги заявок во флэте.

При исполнении входящей заявки стратегия сразу выставляет соответствующие тейк-профит и стоп-лосс, используя значения ATR в
момент генерации сетки. Защитные приказы жёстко привязаны к исходной сделке и остаются активными до исполнения или ручной
отмены.

## Параметры

| Параметр | Описание |
|----------|----------|
| `GridLevels` | Количество уровней выше и ниже рынка (`nGrid`). |
| `TimerBars` | Максимальное число завершённых свечей до отмены отложенной заявки (`nBars`). |
| `PriceOffsetMultiplier` | Множитель ATR для стартового смещения от цены (`Poffset`). |
| `GridStepMultiplier` | Множитель ATR для шага между уровнями (`Pstep`). |
| `StopLossMultiplier` | Множитель ATR для вычисления стоп-лосса (`StopLoss`). |
| `TakeProfitMultiplier` | Множитель ATR для вычисления тейк-профита (`TakeProfit`). |
| `AtrPeriod` | Период усреднения ATR (аналог фиксированного значения 14 в оригинале). |
| `OrderVolume` | Объём каждой заявки (`Lot`). |
| `CandleType` | Таймфрейм свечей, по которым пересчитывается сетка (`Wtf`). |

## Логика торговли

1. Подписка на свечи выбранного `CandleType` и расчёт ATR(14).
2. На каждой завершённой свече:
   - Увеличить счётчик баров и отменить сеточные заявки, превысившие ограничение `TimerBars`.
   - Пропустить дальнейшую обработку, если ATR ещё не сформирован, есть активные заявки сетки или открыта позиция.
   - Рассчитать смещение, шаг сетки, стоп-лосс и тейк-профит как `ATR * множитель`.
   - Выставить по `GridLevels` пар Buy Stop и Sell Stop вокруг цены закрытия, нормализуя уровни через `Security.ShrinkPrice`.
3. При исполнении заявки удалить её из списка сетки и поставить соответствующие защитные приказы:
   - Для длинных позиций — `SellStop` и `SellLimit`.
   - Для коротких — `BuyStop` и `BuyLimit`.
4. Метод `OnOrderChanged` отслеживает завершённые защитные ордера и очищает списки.

## Дополнительно

- Новая сетка строится только после полного отсутствия позиций и активных отложенных заявок, что повторяет поведение функции
  `What()` в MQL.
- В качестве базовой цены используется закрытие свечи вместо последних Bid/Ask тиков, что позволяет оставаться в событийной
  модели по свечам и всё равно получать симметричную сетку.
- ATR фиксируется на момент генерации сетки и применятся к защитным приказам, повторяя прикреплённые стопы и тейки в MetaTrader.
- Python-версия не создавалась по требованию.
