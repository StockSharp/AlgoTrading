# Стратегия Exp Skyscraper Fix + ColorAML + X2MA Candle MMRec

## Обзор
- Перенос эксперта MetaTrader **Exp_Skyscraper_Fix_ColorAML_X2MACandle_MMRec** на C# и платформу StockSharp.
- Стратегия объединяет три независимых цветовых фильтра: канал Skyscraper Fix, адаптивный уровень ColorAML и двойное сглаживание свечей X2MA.
- Каждый блок может открывать и закрывать позиции самостоятельно, работая по одному инструменту и сочетая трендовое сопровождение с быстрыми разворотами.
- Модуль управления капиталом уменьшает объём сделки до `SmallMM`, когда серия последних сделок по направлению оказалась убыточной.

## Логика стратегии
### Блок Skyscraper Fix
1. Формирует канал Skyscraper Fix на основе диапазона ATR и выбранного источника цены (High/Low либо Close).
2. При смене цвета на бычий:
   - закрывает текущие короткие позиции, если это разрешено параметрами;
   - после выдержки, заданной `Signal Bar`, может открыть новую длинную позицию.
3. При медвежьей окраске выполняется зеркальная логика для шортов.
4. Параметры `Kv` и процентный сдвиг воспроизводят оригинальный индикатор.

### Блок ColorAML
1. Вычисляет Adaptive Market Level (AML), измеряя диапазон двух последовательных фрактальных окон и сглаживая комбинированную цену.
2. Индикатор возвращает три цвета: `2` — бычий, `0` — медвежий, `1` — нейтральный. Нейтральные свечи не дают сигналов.
3. Бычий цвет закрывает шорты (если разрешено) и может открыть лонг, если на предыдущей проверяемой свече цвет был другим.
4. Медвежий цвет выполняет симметричные действия для коротких позиций.

### Блок X2MA Candle
1. Дважды сглаживает каждую компоненту OHLC выбранными скользящими средними, создавая синтетическую свечу.
2. Цвет определяется телом сглаженной свечи: Close > Open — бычий, Close < Open — медвежий, равенство — нейтральный оттенок.
3. Порог `Gap` (в шагах цены) сглаживает очень маленькие тела, предотвращая дрожание цвета.
4. Бычий цвет закрывает шорты и допускает открытие лонга, медвежий — наоборот.

### Управление капиталом
1. Каждый блок ведёт собственную историю результатов по лонгам и шортам.
2. После закрытия позиции фиксируется, была ли сделка убыточной.
3. Если последние `Loss Trigger` сделок в данном направлении завершились с убытком, следующий ордер отправляется уменьшенным объёмом (`SmallMM`).
4. После прибыльной или безубыточной сделки объём автоматически возвращается к базовому (`MM`).

## Параметры
| Блок | Параметр | Описание | Значение по умолчанию |
| --- | --- | --- | --- |
| Skyscraper | `Skyscraper Candle` | Таймфрейм свечей для индикатора Skyscraper Fix. | 4 часа |
| Skyscraper | `Skyscraper Length` | Длина окна ATR. | 10 |
| Skyscraper | `Skyscraper Kv` | Множитель чувствительности шага ATR. | 0.9 |
| Skyscraper | `Skyscraper Percentage` | Процентное смещение средней линии. | 0 |
| Skyscraper | `Skyscraper Mode` | Источник цены (High/Low или Close). | High/Low |
| Skyscraper | `Skyscraper Signal Bar` | Количество закрытых свечей, которое нужно подождать перед действием. | 1 |
| Skyscraper | `Skyscraper Buy` / `Skyscraper Sell` | Разрешить открытие лонгов / шортов блоком Skyscraper. | true |
| Skyscraper | `Skyscraper Close Long` / `Skyscraper Close Short` | Разрешить закрытие лонгов / шортов. | true |
| Skyscraper | `Skyscraper Normal Volume` | Базовый объём (аналог `MM`). | 0.1 |
| Skyscraper | `Skyscraper Reduced Volume` | Уменьшенный объём при серии убытков (`SmallMM`). | 0.01 |
| Skyscraper | `Skyscraper Buy Loss Trigger` / `Skyscraper Sell Loss Trigger` | Число подряд убыточных сделок, переводящее на уменьшенный объём. | 2 |
| ColorAML | `ColorAML Candle` | Таймфрейм для индикатора ColorAML. | 4 часа |
| ColorAML | `ColorAML Fractal` | Размер фрактального окна для расчёта диапазона. | 6 |
| ColorAML | `ColorAML Lag` | Параметр запаздывания, задающий адаптивное сглаживание. | 7 |
| ColorAML | `ColorAML Signal Bar` | Смещение по закрытым свечам при анализе цвета. | 1 |
| ColorAML | `ColorAML Buy` / `ColorAML Sell` | Разрешить открытия лонгов / шортов блоком ColorAML. | true |
| ColorAML | `ColorAML Close Long` / `ColorAML Close Short` | Разрешить закрытие лонгов / шортов. | true |
| ColorAML | `ColorAML Normal Volume` / `ColorAML Reduced Volume` | Базовый и уменьшенный объём сделок блока. | 0.1 / 0.01 |
| ColorAML | `ColorAML Buy Loss Trigger` / `ColorAML Sell Loss Trigger` | Порог убыточных сделок для переключения объёма. | 2 |
| X2MA | `X2MA Candle` | Таймфрейм для реконструкции свечей X2MA. | 4 часа |
| X2MA | `First Method` / `Second Method` | Типы сглаживания первой и второй скользящей средней. | SMA / JJMA |
| X2MA | `First Length` / `Second Length` | Периоды обеих стадий сглаживания. | 12 / 5 |
| X2MA | `First Phase` / `Second Phase` | Параметр фазы для Jurik MA. | 15 |
| X2MA | `Gap Points` | Порог (в шагах цены) для сглаживания маленьких тел свечей. | 10 |
| X2MA | `X2MA Signal Bar` | Смещение по закрытым свечам при чтении цвета. | 1 |
| X2MA | `X2MA Buy` / `X2MA Sell` | Разрешить открытия лонгов / шортов блоком X2MA. | true |
| X2MA | `X2MA Close Long` / `X2MA Close Short` | Разрешить закрытие лонгов / шортов. | true |
| X2MA | `X2MA Normal Volume` / `X2MA Reduced Volume` | Базовый и уменьшенный объём сделок блока. | 0.1 / 0.01 |
| X2MA | `X2MA Buy Loss Trigger` / `X2MA Sell Loss Trigger` | Число подряд убыточных сделок, активирующее уменьшенный объём. | 2 |

## Рекомендации по использованию
1. Подбирайте таймфреймы модулей под волатильность инструмента (для внутридневной торговли подойдут 1–2 часа, для свинга — 4 часа и выше).
2. Любой блок можно отключить, остальные будут продолжать работу независимо.
3. Порог `Loss Trigger` выбран консервативным. Если инструмент движется трендово, увеличьте значение, чтобы дольше сохранять базовый объём.
4. Стратегия реагирует только на закрытые свечи, поэтому подавайте в неё свечные данные, соответствующие выбранным таймфреймам.
