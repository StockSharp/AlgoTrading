# Стратегия Butterfly Pattern

## Общее описание

**Butterfly Pattern Strategy** переносит логику MetaTrader-советника «Cypher EA» в высокоуровневый API StockSharp. Стратегия анализирует выбранный таймфрейм на наличие бычьих и медвежьих паттернов «бабочка», проверяет гармонические соотношения и открывает рыночные позиции с тремя целями по прибыли. Дополнительно реализованы привычные механизмы управления позицией: перевод в безубыток и трейлинг-стоп после частичных фиксаций.

## Как работает стратегия

1. Свечи накапливаются до тех пор, пока не появится подтверждённый пивот в окне `PivotLeft` / `PivotRight`.
2. После получения пяти последовательных пивотов проверяются необходимые для паттерна «бабочка» уровни Фибоначчи.
3. Найденный сетап оценивается по метрике качества `MinPatternQuality` и при необходимости повторно валидируется ценой.
4. На закрытии свечи при подтверждении сигнала:
   - Регистрируется рыночный ордер (с фиксированным объёмом или рассчитанный по риску).
   - Объём разбивается на три целевых уровня `TP1/TP2/TP3`.
   - Стоп-лосс вычисляется исходя из геометрии паттерна.
5. Во время сопровождения сделки стратегия отслеживает исполнение частичных выходов, переводит стоп в безубыток и подтягивает его согласно заданным условиям.

> **Совет.** В оригинальном советнике анализируется несколько таймфреймов одновременно. В StockSharp аналогичный эффект достигается запуском нескольких экземпляров стратегии с разными значениями `CandleType`.

## Основные параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Таймфрейм свечей, используемый для поиска пивотов и паттернов. |
| `PivotLeft` / `PivotRight` | Количество свечей слева/справа для подтверждения локального экстремума. |
| `Tolerance` | Допустимое отклонение гармонических коэффициентов от идеальных значений. |
| `AllowTrading` | Разрешение на выставление заявок после подтверждения сигнала. |
| `UseFixedVolume` / `FixedVolume` | Использовать фиксированный объём. При выключении применяется расчёт от `RiskPercent`. |
| `RiskPercent` | Процент капитала, которым рискуем в сделке (используется при динамическом объёме). |
| `AdjustLotsForTakeProfits` | Нормализует доли объёма так, чтобы сумма совпадала с общим входом. |
| `Tp1Percent` / `Tp2Percent` / `Tp3Percent` | Распределение объёма между тремя целями по прибыли. |
| `MinPatternQuality` | Минимально допустимая оценка качества паттерна (0–1). |
| `UseSessionFilter`, `SessionStartHour`, `SessionEndHour` | Ограничение торговли торговой сессией. |
| `RevalidatePattern` | Повторная проверка сетапа перед входом, чтобы исключить «сломанный» паттерн. |
| `UseBreakEven`, `BreakEvenAfterTp`, `BreakEvenTrigger`, `BreakEvenProfit` | Настройки перевода в безубыток после достижения соответствующего `TP`. |
| `UseTrailingStop`, `TrailAfterTp`, `TrailStart`, `TrailStep` | Управление трейлинг-стопом после достижения заданной цели и минимального хода в прибыль. |

## Управление рисками

- Стоп-лосс, безубыток и трейлинг реализованы внутри стратегии: дополнительные заявки не выставляются, выходы выполняются по рынку, как в оригинальном советнике.
- При выключенном `UseFixedVolume` объём рассчитывается исходя из дистанции до стопа, шага цены и параметра `RiskPercent`.

## Практические рекомендации

- Убедитесь, что выбранный инструмент поддерживает нужный шаг цены и таймфрейм, иначе проверка минимальных дистанций может отклонять сигналы.
- Перевод в безубыток и трейлинг становятся доступны только после исполнения указанного take-profit (`BreakEvenAfterTp`, `TrailAfterTp`).
- Для одновременного мониторинга нескольких таймфреймов запустите несколько экземпляров стратегии с разными параметрами `CandleType`.
