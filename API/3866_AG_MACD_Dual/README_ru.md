# Стратегия AG Dual MACD

## Обзор
Данная стратегия представляет собой порт MetaTrader 4 эксперта **AG.mq4** на платформу StockSharp. Алгоритм использует две пары индикаторов MACD с различными параметрами: основная пара формирует торговые сигналы, а вторичная (масштабированная) фильтрует входы и управляет выходами. Обработка ведётся только по закрытым свечам, что полностью повторяет оригинальное поведение советника.

## Логика торговли
- **Индикаторы**
  - Основной MACD: быстрая EMA = `FastEmaLength`, медленная EMA = `SlowEmaLength`, сигнальная SMA = `SignalSmaLength`.
  - Второй MACD: быстрая EMA = `SlowEmaLength * 2`, медленная EMA = `FastEmaLength * 2`, сигнальная SMA = `SignalSmaLength * 2`.
- **Условия для покупки**
  - Главная линия основного MACD находится выше сигнальной.
  - Сигнальная линия основного MACD меньше нуля.
  - Главная линия вторичного MACD выше сигнальной.
  - Сигнальная линия вторичного MACD меньше нуля.
- **Условия для продажи**
  - Главная линия основного MACD ниже сигнальной.
  - Сигнальная линия основного MACD больше нуля.
  - Главная линия вторичного MACD ниже сигнальной.
  - Сигнальная линия вторичного MACD больше нуля.
- **Выходы**
  - Длинные позиции закрываются, когда вторичный MACD переходит в медвежий режим, а сигнальная линия основного MACD остаётся выше нуля.
  - Короткие позиции закрываются, когда вторичный MACD становится бычьим, а сигнальная линия основного MACD остаётся ниже нуля.
- Стратегия игнорирует незавершённые свечи, чтобы избежать перерисовки.

## Управление позицией
- Все сделки выполняются рыночными ордерами объёмом `OrderVolume`.
- Параметр `MaxOpenOrders` соответствует входному `ORDER` в MQL4 и ограничивает суммарное количество активных ордеров и позиций (значение `0` снимает ограничение).
- В методе `OnStarted` вызывается `StartProtection()`, чтобы задействовать модуль защиты StockSharp.

## Параметры
| Имя | Описание |
| --- | --- |
| `OrderVolume` | Базовый объём для новых сделок. |
| `FastEmaLength` | Период быстрой EMA основного MACD. |
| `SlowEmaLength` | Период медленной EMA основного MACD. |
| `SignalSmaLength` | Период сигнальной SMA для обеих пар MACD. |
| `MaxOpenOrders` | Максимальное число активных ордеров и открытых позиций, `0` — без ограничений. |
| `CandleType` | Тип или таймфрейм свечей, используемых для расчётов. |

## Примечания
- Во второй паре MACD сохранён оригинальный порядок «быстрая/медленная» EMA, даже если быстрая становится длиннее медленной, чтобы поведение совпадало с MQL-версией.
- Стратегия не использует отложенные ордера — вход и выход выполняются по рынку при появлении сигнала.
- Дополнительные стоп-лоссы и тейк-профиты не устанавливаются, поскольку исходный советник полагался на разворот сигналов.
