# EA E-mail 策略

## 概述
该策略复现了 MetaTrader 专家顾问 *EA_E-mail* 的行为。原始脚本每隔固定分钟向邮箱发送账户概览，并不会分析行情。
StockSharp 版本保留同样目标：启动后立即记录一次账户快照，然后按 `TimeIntervalMinutes` 参数设置的分钟数循环输出报
告。由于缺少 MetaTrader 的 `SendMail` 函数，移植版本把同样的主题和正文写入策略日志，便于宿主程序转发至真实的通
知渠道。

## 迁移要点
- 使用高层级的蜡烛订阅来模拟计时器。创建一个与所需分钟数相同周期的蜡烛序列，每根蜡烛收盘时触发回调，对应
  MQL 中的 `Sleep` 循环。
- 余额、权益以及未完成订单数量分别从 `Strategy.Portfolio` 和内部的活动订单集合读取，使邮件正文内容与原策略一致。
- 当连接的适配器公开了保证金或杠杆等附加字段时，策略通过反射读取；若无法获取则输出 `N/A`，以提醒操作者该数值
  不可用。
- 邮件主题与正文格式保持不变，方便既有的告警管道继续复用。

## 参数
| 参数 | 类型 | 说明 |
| --- | --- | --- |
| `TimeIntervalMinutes` | `int` | 两次账户汇总之间的分钟数，必须为正数。 |

## 报告字段
日志正文包含以下信息：
- `Date and Time` – 报告的 ISO 8601 时间戳，优先使用策略的 `CurrentTime`。
- `Balance` – 账户初始或当前净值（先取 `Portfolio.BeginValue`，否则使用 `Portfolio.CurrentValue`）。
- `Used Margin` – 如果适配器暴露 `BlockedValue` 或 `Margin` 属性，则显示该值；否则显示 `N/A`。
- `Free Margin` – 在已知占用保证金的情况下，计算余额与占用保证金之差。
- `Equity` – 当前账户权益 (`Portfolio.CurrentValue`)。
- `Open Orders` – 处于 `None`、`Pending` 或 `Active` 状态的订单数量，由内部集合维护。
- `Broker` – 通过反射获取的连接器名称或标识符。
- `Leverage` – 适配器暴露的杠杆信息；若不存在则显示 `N/A`。

## 执行流程
1. `OnStarted` 中立即写入首条报告，保持与原 EA 一致。
2. 订阅以 `TimeIntervalMinutes` 为周期的蜡烛序列，用作周期性调度而无需自建线程。
3. 每根蜡烛收盘时生成新的账户摘要，拼装正文并写入日志。
4. `OnOrderChanged` 维护活动订单集合，确保“Open Orders”字段实时准确。

## 使用步骤
1. 为策略指定证券与组合（蜡烛订阅需要证券信息）。
2. 设置 `TimeIntervalMinutes` 为期望的汇报间隔。
3. 启动策略，在日志中查找以 `[Email] Subject:` 和 `[Email] Body:` 开头的条目。
4. 如需真实邮件或推送，可由宿主程序将这些日志转发到 SMTP、推送服务或监控面板。

## 限制与说明
- 如果未指定证券，周期性计时器无法启动，此时只会写入首条报告，并输出警告信息。
- 保证金和杠杆值依赖于连接器提供的字段，缺失时会显示 `N/A`，避免产生“数值为零”的误解。
- 策略不提交也不取消任何订单，作用仅限信息通知，可与其他交易逻辑组合使用。
