# Стратегия EA E-mail

## Обзор
Стратегия повторяет работу эксперта MetaTrader *EA_E-mail*. Оригинальный советник с заданным интервалом отправлял на почту
отчет об аккаунте и не анализировал рынок. Порт на StockSharp делает то же самое: сразу после запуска формируется мгновенный
снимок портфеля, далее отчеты публикуются каждые `TimeIntervalMinutes` минут. Вместо функции `SendMail` из MetaTrader
используются информационные записи в журнале стратегии, которые при необходимости можно перенаправить во внешнюю систему
уведомлений.

## Особенности переноса
- В роли таймера выступает подписка на свечи: создается серия с таймфреймом, равным указанному интервалу. Обработчик вызывается
  при закрытии свечи и полностью повторяет цикл `while + Sleep` из MQL.
- Баланс, эквити и количество активных заявок считываются из `Strategy.Portfolio` и внутреннего набора активных ордеров, чтобы
  текст отчета совпадал с исходным письмом.
- Дополнительные показатели (использованная маржа, плечо) извлекаются через рефлексию, если адаптер соединения их предоставляет;
  если данных нет, в отчете выводится `N/A`.
- Сохранены тема и формат тела письма, поэтому существующие каналы уведомлений можно использовать без изменений.

## Параметры
| Параметр | Тип | Описание |
| --- | --- | --- |
| `TimeIntervalMinutes` | `int` | Количество минут между отчетами. Значение должно быть больше нуля. |

## Поля отчета
Каждая запись содержит строки:
- `Date and Time` – временная метка отчета в формате ISO 8601, по возможности используется `CurrentTime` стратегии.
- `Balance` – начальная или текущая стоимость портфеля (`Portfolio.BeginValue`, иначе `Portfolio.CurrentValue`).
- `Used Margin` – значение свойств `BlockedValue` или `Margin`, если они доступны; иначе `N/A`.
- `Free Margin` – рассчитывается как разница между балансом и использованной маржой (если последняя известна).
- `Equity` – текущая стоимость портфеля (`Portfolio.CurrentValue`).
- `Open Orders` – число заявок в состояниях `None`, `Pending` или `Active`, отслеживаемое внутренней коллекцией.
- `Broker` – название или идентификатор коннектора, найденный через рефлексию.
- `Leverage` – значение плеча, предоставленное адаптером; при отсутствии выводится `N/A`.

## Последовательность работы
1. В `OnStarted` сразу формируется первый отчет, как и в оригинальном советнике.
2. Настраивается подписка на свечи с таймфреймом `TimeIntervalMinutes`, что позволяет обойтись без самостоятельных таймеров.
3. Каждая закрывшаяся свеча приводит к генерации нового отчета и записи его в лог.
4. Обработчик `OnOrderChanged` поддерживает список активных заявок в актуальном состоянии для корректного поля `Open Orders`.

## Порядок использования
1. Назначьте стратегии инструмент и портфель (подписка на свечи требует выбранного инструмента).
2. Установите параметр `TimeIntervalMinutes` в желаемый интервал между отчетами.
3. Запустите стратегию и отслеживайте в журнале строки вида `[Email] Subject:` и `[Email] Body:`.
4. При необходимости перенаправьте эти сообщения на SMTP-сервер, сервис пуш-уведомлений или мониторинговую панель.

## Ограничения и примечания
- Без назначенного инструмента периодический таймер не запускается. В этом случае создается только первый отчет и выводится
  предупреждение.
- Поля, связанные с маржой и плечом, зависят от возможностей подключенного адаптера. При их отсутствии выводится `N/A`, что
  исключает ложное ощущение нулевых значений.
- Стратегия не выставляет и не снимает заявки, служит исключительно информационным модулем и может использоваться совместно с
  любыми торговыми алгоритмами.
