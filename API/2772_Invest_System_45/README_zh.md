# Invest System 4.5 策略 (C#)

## 概述
Invest System 4.5 原本是一个 MetaTrader 5 智能交易系统，此处将其迁移到 StockSharp 高层策略 API。策略在 EUR/USD 上运行，根据上一根已经收盘的 4 小时蜡烛的方向进行交易。每个新的 4 小时时段只允许开一笔单，仓位规模会根据实际盈亏以及账户权益的增长自动调整。

实现完全依赖高层 API：策略自动订阅 4 小时蜡烛用于判断趋势，同时订阅分钟级别蜡烛用于监控进场窗口；`StartProtection` 方法用来一次性设置以点数表示的止损和止盈。

## 交易流程
1. **方向判断**：每当 4 小时蜡烛收盘时记录其涨跌方向。收阳意味着下一根 4 小时期间只寻找多头入场，收阴则只考虑空头。如果开收价相同则沿用上一根蜡烛的方向。
2. **进场窗口**：新 4 小时蜡烛开启后，打开一个固定时长（默认 15 分钟）的进场窗口。在窗口有效期内，策略观察更低周期（默认 1 分钟）的收盘数据，只要条件满足就会在窗口内发送一张市价单，随后立即关闭窗口。
3. **单次持仓**：策略不加仓、不做网格，任何时候最多只持有一笔仓位。如果仍有持仓，将忽略新的信号直到下一根 4 小时蜡烛开始。
4. **盈亏记录**：当仓位完全平仓后，记录本次交易的实际盈亏，用于触发下面的分级加仓规则。

## 仓位管理
策略复刻了原 EA 的两层资金管理机制：
- **权益阶梯**：首次运行时保存初始余额。当账户权益达到初始余额的 2 倍、3 倍直至 6 倍时，基础手数按比例提升。一级使用 `BaseLot`，二级翻倍，三级为三倍，以此类推。额外手数 (`Lot2`、`Lot3`、`Lot4`) 根据原始比例（×2、×7、×14）自动计算。
- **Plan B 模式**：在交易之间维护一个当前手数。
  - 基础手数亏损后，将手数提高到 `Lot3`。
  - 如果在 `Lot3` 上继续亏损，则启动 Plan B：重新映射手数，使基础手数变为 `Lot2`，激进手数变为 `Lot4`。当前手数不会立即改变，但下次亏损会使用新的激进手数。达到新的权益高点时 Plan B 自动退出。
  - 盈利交易会把手数恢复到当前阶梯的基础手数。
借助上述规则，可以在 StockSharp 中完整复现 MT5 中的阶梯式加仓行为。

## 风险控制
- 使用 `StartProtection` 以点值设置固定止损与止盈。这两个保护订单在策略启动时一次性配置，效果等同于原 EA 在每笔订单上附加相同的价差。
- 仅使用市价单。策略不执行分批减仓或对冲，平仓动作由保护单自动完成。

## 参数
| 参数 | 说明 | 默认值 | 优化范围 |
|------|------|--------|----------|
| `StopLossPips` | 止损点数，设为 `0` 可关闭止损。 | 240 | 120 – 360，步长 20 |
| `TakeProfitPips` | 止盈点数，设为 `0` 可关闭止盈。 | 40 | 20 – 80，步长 10 |
| `EntryWindowMinutes` | 新的 4 小时蜡烛开始后允许进场的分钟数。 | 15 | 5 – 30，步长 5 |
| `SignalCandleType` | 监控进场窗口所用的低周期蜡烛类型（默认 1 分钟）。 | 1 分钟蜡烛 | – |
| `TrendCandleType` | 判断方向所用的高周期蜡烛类型（默认 4 小时）。 | 4 小时蜡烛 | – |
| `BaseLot` | 初始基础手数，其它手数会按照既定比例推导。 | 0.1 | 0.05 – 0.3，步长 0.05 |

## 目录结构
```
2772_Invest_System_45/
├── CS/
│   └── InvestSystem45Strategy.cs
├── README.md
├── README_ru.md
└── README_zh.md
```

## 使用说明
- 需要确保所选证券同时提供 4 小时和分钟级蜡烛数据，`OnStarted` 会自动创建对应订阅。
- 点值通过 `Security.PriceStep` 计算，并在遇到三位或五位小数报价时乘以 10，以匹配 MetaTrader 的点数定义。
- 阶梯逻辑依赖 `Portfolio.CurrentValue` 的实时更新。在仿真或回测时，请确认投资组合模型会及时刷新该数值，否则手数调整会失真。
- 根据需求，本版本仅提供 C# 实现，不包含 Python 代码。
