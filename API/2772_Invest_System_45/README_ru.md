# Стратегия Invest System 4.5 (C#)

## Общее описание
Invest System 4.5 — это советник MetaTrader 5, перенесённый на высокоуровневый API StockSharp. Стратегия торгует парой EUR/USD, следуя направлению предыдущей завершённой 4-часовой свечи. В каждый новый 4-часовой период допускается максимум одна сделка, причём размер позиции изменяется в зависимости от полученной прибыли/убытка и роста капитала.

В реализации используется только высокоуровневый API: стратегия оформляет подписки на 4-часовые и минутные свечи, а метод `StartProtection` обеспечивает выставление фиксированных стопов и тейк-профитов в пунктах.

## Логика торговли
1. **Определение тренда** — по закрытию каждой 4-часовой свечи фиксируется её направление. Если свеча закрылась выше открытия, следующая сделка будет только на покупку, если ниже — только на продажу. При равных цене открытия и закрытия сохраняется предыдущее направление.
2. **Окно входа** — с началом новой 4-часовой свечи открывается окно для входа. Оно действует заданное количество минут (по умолчанию 15). В течение окна стратегия анализирует более быстрые свечи (1 минута по умолчанию) и может отправить ровно одну рыночную заявку при выполнении всех условий.
3. **Одна позиция** — усреднение и пирамидинг не используются. Если позиция уже открыта, новые сигналы игнорируются до следующего 4-часового периода. После отправки ордера окно входа закрывается, что повторяет поведение оригинального советника.
4. **Учёт прибыли** — при полном закрытии позиции фиксируется реализованный финансовый результат. Он используется для изменения лотов в блоке адаптивного управления капиталом.

## Управление размером позиции
Стратегия повторяет двухуровневую схему управления капиталом из MetaTrader:
- **Пороговые значения по капиталу.** На первой итерации сохраняется исходный баланс. При превышении 2×, 3× … 6× исходного баланса увеличивается базовый лот. На первой ступени используется `BaseLot`, на второй — удвоенный, на третьей — утроенный и т.д. Дополнительные лоты (`Lot2`, `Lot3`, `Lot4`) рассчитываются с исходными коэффициентами (×2, ×7 и ×14).
- **Эскалация «План B».** Между сделками сохраняется единое значение объёма.
  - После убыточной сделки с базовым лотом объём увеличивается до лота `Lot3`.
  - Если ещё одна потеря случилась с лотом `Lot3`, активируется режим «План B». Базовый лот становится `Lot2`, а агрессивный — `Lot4`. Текущий объём не меняется мгновенно, но следующая убыточная сделка переведёт стратегию на агрессивный лот. План B автоматически отключается при достижении нового максимума капитала.
  - Прибыльная сделка всегда возвращает объём на базовый уровень для текущей ступени.
Таким образом, каскадное увеличение объёмов полностью повторяет оригинальную логику без ручной обработки коллекций.

## Управление рисками
- Метод `StartProtection` выставляет стоп-лосс и тейк-профит в абсолютных ценовых значениях, рассчитанных через размер пункта. Защита настраивается один раз при запуске стратегии, аналогично тому, как советник присваивает значения каждой сделке.
- Используются только рыночные ордера. Частичные выходы и хеджирование отсутствуют — закрытие позиции выполняется за счёт защитных заявок.

## Параметры стратегии
| Параметр | Описание | Значение по умолчанию | Диапазон оптимизации |
|----------|----------|------------------------|-----------------------|
| `StopLossPips` | Дистанция стоп-лосса в пунктах. Значение `0` отключает стоп. | 240 | 120 – 360, шаг 20 |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. Значение `0` отключает цель. | 40 | 20 – 80, шаг 10 |
| `EntryWindowMinutes` | Длительность окна входа после открытия новой 4-часовой свечи. | 15 | 5 – 30, шаг 5 |
| `SignalCandleType` | Тип свечей для контроля окна входа (по умолчанию 1 минута). | Минутные свечи | – |
| `TrendCandleType` | Таймфрейм для определения направления (по умолчанию 4 часа). | 4-часовые свечи | – |
| `BaseLot` | Базовый лот первой ступени. Остальные рассчитываются автоматически. | 0.1 | 0.05 – 0.3, шаг 0.05 |

## Структура файлов
```
2772_Invest_System_45/
├── CS/
│   └── InvestSystem45Strategy.cs
├── README.md
├── README_ru.md
└── README_zh.md
```

## Примечания
- Для корректной работы необходимо, чтобы инструмент предоставлял обе серии свечей (4-часовую и минутную). Подписки формируются автоматически в методе `OnStarted`.
- Размер пункта вычисляется через `Security.PriceStep` с поправкой на трёх- и пятизнаковые котировки, чтобы соответствовать MT5.
- Пороговая логика опирается на значение `Portfolio.CurrentValue`, которое обновляется на каждой минутной свече. При моделировании убедитесь, что модель портфеля пересчитывает текущую стоимость.
- Python-версия сознательно не создавалась по требованию задания.
