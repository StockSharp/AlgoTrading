# Стратегия NUp1Down

## Обзор
**NUp1Down** — это прямой порт советника MetaTrader 5 «N bars up, then one bar down» (файл `NUp1Down.mq5`).
Стратегия анализирует завершённые свечи, предоставляемые StockSharp, и открывает короткую позицию, когда после серии
бычьих свечей, постоянно обновляющих максимум закрытия, появляется медвежья свеча. Решение подходит трейдерам, которые хотят
автоматизировать классический разворотный паттерн в StockSharp Designer, Shell или Runner.

## Логика торговли
1. Работает только с закрытыми свечами типа, указанного в параметре `CandleType`.
2. Хранит последние `BarsCount + 1` свечей. Новая свеча должна закрыться ниже открытия — это сигнальная медвежья свеча.
3. Предыдущие `BarsCount` свечей обязаны закрываться выше открытия. Каждая из них (кроме самой старой) должна закрыться выше
   закрытия предыдущей, формируя «лестницу» роста.
4. Когда условия выполняются и нет активной короткой позиции, стратегия отправляет рыночный ордер на продажу.
5. Размер позиции рассчитывается по параметру `RiskPercent`: оценивается, сколько контрактов можно открыть, чтобы денежный риск
   (расстояние до стоп-лосса в пересчёте на валюту счёта) не превышал заданный процент от портфеля. Базовое значение `Volume`
   служит минимальным объёмом, а риск-модель может только увеличить сделку.

## Управление позицией
- После входа рассчитываются защитные уровни стоп-лосса и тейк-профита. Расстояния задаются в пунктах и переводятся в цены
  через `PriceStep`. Для инструментов с 3 или 5 знаками после запятой размер пункта автоматически приводится к терминологии
  MetaTrader.
- На каждой завершённой свече пересчитывается трейлинг-стоп. Расстояние между ценой и стопом равно `TrailingStopPips`, а перенос
  выполняется только после движения в прибыль не меньше `TrailingStepPips`. Алгоритм повторяет логику оригинального советника:
  для коротких позиций стоп следует за ценой спроса, длинные позиции стратегия не открывает.
- Перед поиском нового входа стратегия проверяет условия выхода. Позиция закрывается при достижении стоп-лосса, тейк-профита
  или после подтягивания трейлинг-стопа выше текущей цены спроса.

## Параметры
| Имя | Описание |
| --- | -------- |
| `BarsCount` | Количество бычьих свечей перед сигнальной медвежьей свечой (по умолчанию 3). |
| `TakeProfitPips` | Расстояние до тейк-профита в пунктах (по умолчанию 50). |
| `StopLossPips` | Расстояние до стоп-лосса в пунктах (по умолчанию 50). |
| `TrailingStopPips` | Дистанция между ценой и трейлинг-стопом (по умолчанию 10). |
| `TrailingStepPips` | Минимальное движение цены в прибыль перед переносом трейлинг-стопа (по умолчанию 5). |
| `RiskPercent` | Процент капитала, который допускается рисковать в сделке (по умолчанию 5). |
| `CandleType` | Тип/таймфрейм свечей для анализа (по умолчанию 1 час). |

## Рекомендации по использованию
- Установите `Volume` в минимальный разрешённый брокером объём. Алгоритм управления риском может увеличить позицию, но не
  уменьшит её ниже указанного значения.
- Стратегия поддерживает только одну агрегированную короткую позицию. При наличии длинной позиции она будет закрыта перед
  открытием шорта.
- Работа ведётся по свечам. Срабатывание стопа или тейк-профита внутри свечи определяется по её максимуму/минимуму, поэтому
  фактическое исполнение может отличаться от тикового варианта.
- В данной поставке отсутствует версия на Python. Доступна только реализация C# в файле `API/2574/CS/NUp1DownStrategy.cs`.
