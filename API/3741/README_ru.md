# Стратегия TradingLab Best MACD

**TradingLab Best MACD** переносит одноимённого советника Mueller Peter из MetaTrader в высокоуровневый API StockSharp. Стратегия сочетает трендовый фильтр EMA(200), импульс MACD и сигналы структуры от последних касаний поддержки/сопротивления. Все решения принимаются только по закрытым свечам, а для каждой сделки рассчитываются динамические стоп и тейк по формуле из оригинального MQL.

## Основная логика

1. **Набор индикаторов**
   - EMA с периодом 200 по выбранному `CandleType` задаёт направление торговли.
   - Стандартный MACD (12/26 и сигнал 9) фиксирует бычьи и медвежьи пересечения.
   - Два канальных индикатора отслеживают структуру: `Highest` длиной 20 играет роль сопротивления, `Lowest` длиной 10 — поддержки.
2. **Счётчики валидности сигналов**
   - Если максимум предыдущей свечи пробивает сопротивление, счётчик `ResistanceTouch` сбрасывается к значению `SignalValidity` и уменьшается на каждой новой свече.
   - Аналогично минимум ниже поддержки перезапускает счётчик `SupportTouch`.
   - Пересечения MACD ниже нуля (для лонга) и выше нуля (для шорта) обновляют отдельные счётчики MACD, удерживая импульс несколько свечей подряд.
3. **Условия входа**
   - **Лонг**: закрытие выше EMA, оба счётчика (MACD up + касание поддержки) активны, причём хотя бы один из них получен на текущей свече. Объём заявки равен `OrderVolume` плюс объём для разворота из шорта.
   - **Шорт**: закрытие ниже EMA, активны счётчики MACD down и касания сопротивления, как минимум один из них свежий.
4. **Выход из позиции**
   - При входе рассчитывается стоп на расстоянии `StopDistancePoints` от EMA (перевод через `PriceStep`) и тейк по формуле из MQL: расстояние между входом и EMA плюс стоп, умноженное на 1.5.
   - На каждой закрытой свече проверяется, достигли ли экстремумы этих уровней, после чего позиция закрывается.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `SignalValidity` | Количество закрытых свечей, в течение которых структура или MACD сигнал остаётся активным. | 7 |
| `OrderVolume` | Объём рыночной заявки при входе. | 1 |
| `StopDistancePoints` | Отступ стоп-лосса от EMA в пунктах инструмента. | 50 |
| `CandleType` | Основной тип свечей (по умолчанию 5-минутные). | `TimeSpan.FromMinutes(5).TimeFrame()` |

Все параметры объявлены через `StrategyParam`, поэтому доступны для оптимизации в Designer.

## Алгоритм работы

1. Подписываемся на выбранные свечи и привязываем индикаторы EMA, MACD, Highest и Lowest.
2. Храним значения предыдущей свечи, чтобы воспроизвести обращение `CopyBuffer` из MQL.
3. На каждой закрытой свече обновляем четыре счётчика сигналов.
4. Перед сделкой проверяем `IsFormedAndOnlineAndAllowTrading()`.
5. Отправляем рыночные заявки, фиксируем уровни стоп/тейк и далее контролируем их при обработке свечей.

## Примечания

- По запросу добавлена только C# версия, папка `PY/` не создавалась.
- Используются только высокоуровневые вызовы (`SubscribeCandles`, `BindEx`, `BuyMarket`, `SellMarket`), никаких ручных буферов индикаторов.
- При наличии области графика автоматически выводятся свечи, EMA и MACD для визуальной проверки сигналов.
