# 3569 CSV 导出器

## 概述
该策略是 MetaTrader 专家顾问 `MQL/41254/CSV Exporter.mq5` 的 StockSharp 高级移植版本。原始脚本会定期导出最近的 K 线收盘价，以便在外部工具中继续分析。StockSharp 版本通过订阅已完成的 K 线、缓存其收盘价并按照设定的时间表重写 CSV 文件，完整保留了这种行为。

策略不会发出或管理订单，唯一的职责是生成一个持续更新的价格文件，供其他系统消费。

## 策略逻辑
1. **订阅 K 线** – 启动后订阅配置的 K 线类型（默认 5 分钟），只处理状态为 `Finished` 的完整 K 线，避免未完成数据。
2. **环形缓冲区** – 将收盘价存入与 `CandleCount` 相同长度的环形缓冲区，缓冲区始终包含最近的完整 K 线。
3. **定时导出** – 在初始 1 秒延迟后，每经过 `UpdateInterval` 就执行一次导出操作，将缓冲区内容按时间顺序写入 CSV 文件并覆盖旧文件。
4. **文件命名** – 输出文件名由标的证券标识符和 K 线周期自动组合（例如 `AAPL@NASDAQ_TF_300s.csv`），所有非法文件名字符都会被替换为下划线。
5. **状态提示** – 每次导出后都会记录并公开一条状态文本，说明写入记录的数量以及文件路径。

## 参数
| 参数 | 说明 |
|------|------|
| `CandleType` | 策略处理的 K 线类型，默认是 5 分钟 K 线。 |
| `CandleCount` | 导出到 CSV 文件的完整 K 线数量。 |
| `UpdateInterval` | 连续两次导出之间的时间间隔。 |
| `ExportDirectory` | 保存 CSV 文件的目录路径。 |

## 使用说明
- 在启动前必须指定有效的 `Security`，其标识符会用于构建输出文件名。
- 运行策略的账户需要对 `ExportDirectory` 具有写入权限，如目录不存在会自动创建。
- 可通过调整 `CandleCount` 与 `UpdateInterval` 控制导出的历史长度与刷新频率。
- 每次导出都会覆盖原有 CSV 文件，以匹配 MetaTrader 脚本的行为。
- 最新的导出信息可以通过 `LastExportStatus` 属性获取，方便整合到日志或监控界面。

## 与 MetaTrader 版本的差异
- MetaTrader 使用 `CopyRates` 随需拉取历史数据，而 StockSharp 通过实时 K 线订阅维护一个环形缓冲区。
- 文件操作改为使用 .NET 的 `StreamWriter`（UTF-8 编码），替代了 MetaTrader 的 `FileOpen` 接口。
- 导出计时依赖 K 线时间戳而不是 `OnTick` 定时器，更符合 StockSharp 策略的编写习惯。
- 启动前的证券与目录校验更加明确，可以在前置条件缺失时提供清晰的错误信息。
