# 3569 CSV Exporter

## Обзор
Стратегия представляет собой высокоуровневый порт MetaTrader-советника `MQL/41254/CSV Exporter.mq5` на платформу StockSharp. Оригинальный скрипт периодически выгружал последние значения закрытия свечей в CSV-файл для дальнейшей обработки. Версия на StockSharp полностью сохраняет эту логику: стратегия подписывается на завершённые свечи, накапливает их цены закрытия и по расписанию перезаписывает CSV-файл.

Стратегия не создаёт и не сопровождает сделки — её единственная задача состоит в формировании постоянно обновляемого файла цен для внешних сервисов.

## Логика стратегии
1. **Подписка на свечи** – при запуске стратегия подписывается на выбранный тип свечей (по умолчанию пятиминутные) и обрабатывает только завершённые бары.
2. **Кольцевой буфер** – цены закрытия хранятся в кольцевом буфере фиксированного размера, равного параметру `CandleCount`, что гарантирует наличие последних завершённых свечей.
3. **Периодический экспорт** – после стартовой задержки в одну секунду стратегия выполняет экспорт каждые `UpdateInterval`, полностью перезаписывая CSV-файл значениями из буфера в хронологическом порядке.
4. **Именование файла** – имя файла формируется автоматически на основе идентификатора инструмента и таймфрейма (например, `AAPL@NASDAQ_TF_300s.csv`). Недопустимые символы заменяются на подчёркивания.
5. **Статусные сообщения** – после каждой выгрузки стратегия формирует текстовое сообщение о количестве записанных строк и расположении файла и публикует его через лог и свойство `LastExportStatus`.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей, обрабатываемых стратегией (по умолчанию 5-минутные). |
| `CandleCount` | Количество завершённых свечей, записываемых в CSV-файл. |
| `UpdateInterval` | Временной интервал между последовательными экспортами. |
| `ExportDirectory` | Каталог, в котором сохраняется CSV-файл. |

## Рекомендации по использованию
- Перед запуском необходимо назначить свойство `Security`; идентификатор инструмента используется при формировании имени файла.
- Учётная запись, под которой работает стратегия, должна иметь права записи в каталог `ExportDirectory`. При необходимости каталог создаётся автоматически.
- Настраивайте `CandleCount` и `UpdateInterval`, чтобы контролировать глубину истории и частоту обновления выгрузки.
- Каждый экспорт перезаписывает файл, что соответствует поведению оригинального MetaTrader-скрипта.
- Последнюю строку статуса можно получить через свойство `LastExportStatus` и использовать в панелях мониторинга или журналах.

## Отличия от версии MetaTrader
- В MetaTrader данные извлекались через функцию `CopyRates`; StockSharp поддерживает живой кольцевой буфер, обновляемый подпиской на свечи.
- Для записи используется `StreamWriter` из .NET с кодировкой UTF-8 вместо функции `FileOpen` из MQL5.
- Таймер экспорта основан на времени свечей, а не на обработчике `OnTick`, что естественно для стратегий StockSharp.
- Добавлена явная проверка настроек инструмента и каталога, позволяющая быстрее выявлять ошибки конфигурации.
