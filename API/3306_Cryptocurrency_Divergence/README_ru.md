# Стратегия Cryptocurrency Divergence

## Обзор
**Cryptocurrency Divergence Strategy** выявляет классические дивергенции между ценой и индексом относительной силы (RSI), одновременно подтверждая направление тренда с помощью скользящих средних и MACD. Оригинальный советник MetaTrader использовал многопериодный анализ импульса, сложное сопровождение позиций и денежные фильтры. Порт на StockSharp сохраняет задумку:

- Определяет бычью дивергенцию, когда цена формирует более низкий минимум, а RSI — более высокий минимум.
- Определяет медвежью дивергенцию, когда цена обновляет максимум, но RSI показывает более низкий максимум.
- Проверяет сигнал фильтром из быстрой/медленной SMA и сравнением линии MACD с сигнальной линией.
- Управляет позицией через настраиваемые стоп-лосс, тейк-профит, перевод в безубыток и трейлинг, выраженные в шагах цены.

Стратегия ориентирована на криптовалютные рынки, однако подходит для любого волатильного инструмента с четко выраженными свингами.

## Индикаторы
- **Простая скользящая средняя (SMA)**: быстрая и медленная средние формируют фильтр тренда.
- **RSI**: фиксирует значения импульса на экстремумах для оценки дивергенции.
- **MACD**: подтверждает, что импульс поддерживает найденную дивергенцию.

Все индикаторы подключаются через высокоуровневый API, поэтому буферы и ручные расчеты не требуются.

## Логика торговли
1. Подписываемся на выбранный тип свечей и на каждой закрытой свече рассчитываем SMA, RSI и MACD.
2. Отслеживаем последние экстремумы цены и соответствующие им значения RSI. Данные обновляются только при формировании новых максимумов или минимумов.
3. **Бычья дивергенция** появляется, когда минимум цены обновляется, RSI растет, быстрая SMA находится выше медленной, MACD выше сигнальной линии, а RSI остается ниже бычьего порога (по умолчанию 45).
4. **Медвежья дивергенция** требует нового максимума цены, падения RSI на экстремуме, расположения быстрой SMA ниже медленной, линии MACD ниже сигнальной и значения RSI выше медвежьего порога (по умолчанию 55).
5. В рынке одновременно может находиться только одна чистая позиция. При смене сигнала стратегия закрывает текущую позицию и сразу переходит в противоположную.

## Управление рисками
- **Объем сделки**: задается пользователем и применяется ко всем рыночным ордерам.
- **Стоп-лосс и тейк-профит**: рассчитываются в шагах цены и выставляются после фактического исполнения.
- **Перевод в безубыток**: при достижении заданной прибыли стоп переносится к цене входа с заданным отступом.
- **Трейлинг-стоп**: следует за ценой на фиксированном расстоянии и имеет приоритет над исходным стопом после активации.

Все защитные механизмы проверяются на закрытии свечи, что обеспечивает соответствие между тестами и реальной торговлей.

## Параметры
| Имя | Описание |
| --- | --- |
| `CandleType` | Тип свечей для анализа (по умолчанию 15 минут). |
| `TradeVolume` | Объем входа в позицию. |
| `FastMaLength` / `SlowMaLength` | Периоды быстрой и медленной SMA. |
| `RsiLength` | Период RSI. |
| `RsiBullishLevel` / `RsiBearishLevel` | Пороговые значения RSI для подтверждения бычьей и медвежьей дивергенции. |
| `MacdShortLength` / `MacdLongLength` / `MacdSignalLength` | Настройки MACD. |
| `StopLossPoints` / `TakeProfitPoints` | Расстояние до стопа и цели в шагах цены. |
| `EnableBreakEven`, `BreakEvenTrigger`, `BreakEvenOffset` | Управление переводом в безубыток. |
| `EnableTrailing`, `TrailDistance` | Управление трейлинг-стопом. |

Параметры объявлены через `StrategyParam<T>`, что позволяет оптимизировать стратегию в дизайнере StockSharp.

## Рекомендации по использованию
1. Подключите стратегию к выбранному инструменту и убедитесь, что для него заданы `PriceStep` и `Board`, иначе расчет защитных уровней невозможен.
2. Подберите таймфрейм свечей в соответствии с торгуемым рынком (15 минут, час и т.д.), так как распознавание дивергенций зависит от масштаба.
3. Настройте расстояния стопов и целей под среднюю волатильность инструмента. Для пар с пятью знаками после запятой потребуются увеличенные значения.
4. Активируйте перевод в безубыток и трейлинг только после проверки на истории, чтобы избежать преждевременного выхода из прибыльных сделок.
5. Используйте дизайнер StockSharp для визуального контроля индикаторов и исполнения ордеров.

## Отличия от версии MQL
- Денежные тралы и останов по капиталу заменены на универсальное управление стопами по шагам цены.
- Многопериодные проверки импульса заменены на подтверждение по MACD в одном таймфрейме для повышения прозрачности.
- Удалены уведомления по почте/пушу, которые могут быть реализованы сторонними сервисами StockSharp.

Несмотря на упрощения, стратегия сохраняет основную идею поиска дивергенций и защиту позиций исходного советника.
