# Стратегия Early Open Trend

## Обзор
- Порт MetaTrader 4-советника `earlyOpenTrend.mq4` из каталога `MQL/9826`.
- Открывает не более одной сделки в каждом направлении за торговый день, оценивая текущую цену относительно дневного открытия и длины сформированной тени.
- Сохраняет логику торговых окон оригинала, включая поправку на летнее время (переменная `ZD` сдвигает сессию на 1 или 2 часа).
- Реализована на высокоуровневом API StockSharp: подписка на свечи, автоматическое управление защитой позиции и контроль сессии.

## Рыночная логика
1. Формируется внутридневной ряд свечей (по умолчанию 15 минут), из которого восстанавливаются текущие дневные значения открытия, максимума и минимума.
2. Активный сдвиг по часовому поясу определяется параметрами `SummerTimeStartDay` и `WinterTimeStartDay`: между этими датами из времени сессии вычитаются 2 часа, в остальной период — 1 час. Это повторяет расчёт `ZD` в MQL.
3. Сигналы анализируются только в интервале `[StartHour, EndHour)` после учёта сдвига и только при отсутствии позиции.
4. Условия для покупки:
   - Свеча закрылась выше дневного открытия;
   - Расстояние между дневным открытием и текущим минимумом превышает `RangeFilterPips` (после перевода в абсолютную цену);
   - В этот день ещё не открывалась длинная позиция.
5. Условия для продажи:
   - Свеча закрылась ниже дневного открытия;
   - Расстояние между текущим максимумом и дневным открытием превышает `RangeFilterPips`;
   - В этот день ещё не открывалась короткая позиция.
6. При выполнении условий отправляется рыночный ордер объёмом `OrderVolume`, а время входа сохраняется для контроля лимита удержания.

## Сессионные и выходные правила
- `EndHour` запрещает новые входы после указанного времени (с учётом сдвига).
- `ClosingHour` закрывает позицию, как только серверное время достигает заданного часа.
- `HoldingHours` ограничивает максимально допустимое время удержания позиции; превышение лимита приводит к немедленному выходу.
- Для каждого направления используется не более одной сделки в день. Флаги сбрасываются при обнаружении новой торговой даты.

## Управление рисками
- Параметры `StopLossPips` и `TakeProfitPips` автоматически преобразуются в абсолютное значение цены на основе `Security.PriceStep` (для пятизначных инструментов шаг умножается на 10, чтобы получить стандартный pip).
- Если хотя бы одно из расстояний больше нуля, включается `StartProtection` с рыночным исполнением, что соответствует оригинальным вызовам `OrderModify`.
- Дополнительных алгоритмов сопровождения позиции, кроме временных ограничений, не используется.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `OrderVolume` | 0.1 | Объём каждой рыночной заявки. |
| `OrderType` | 0 | Фильтр направлений: `0` = оба, `1` = только покупки, `2` = только продажи. |
| `RangeFilterPips` | 1 | Минимальная длина тени от дневного открытия до противоположного экстремума. |
| `TakeProfitPips` | 100 | Дистанция до тейк-профита в пунктах (0 отключает). |
| `StopLossPips` | 1000 | Дистанция до стоп-лосса в пунктах (0 отключает). |
| `StartHour` | 7 | Час начала торговой сессии (до учёта сдвига). |
| `EndHour` | 18 | Час окончания сессии (до учёта сдвига). |
| `ClosingHour` | 20 | Час принудительного закрытия позиции. |
| `HoldingHours` | 0 | Максимальное время удержания в часах (0 = без ограничения). |
| `SummerTimeStartDay` | 87 | Номер дня года, с которого применяется двухчасовой сдвиг. |
| `WinterTimeStartDay` | 297 | Номер дня года, когда сдвиг возвращается к одному часу. |
| `CandleType` | 15-минутные свечи | Тип свечей для расчётов. |

## Рекомендации по использованию
1. Привяжите стратегию к нужному инструменту и убедитесь, что таймфрейм свечей соответствует вашему источнику данных.
2. Настройте часы сессии под время сервера брокера и скорректируйте даты перехода на летнее/зимнее время при необходимости.
3. Подберите значения стопов и тейков в пунктах под спецификацию инструмента — стратегия автоматически переведёт их в цену.
4. Запустите стратегию: она будет обновлять дневной профиль на каждой завершённой свече, проверять условия входа и обеспечивать ограничение «одна сделка на направление в день».

## Отличия от оригинального MQL-советника
- Используются закрытые свечи вместо мгновенных значений `Bid`/`Ask`, что немного задерживает вход, но делает поведение детерминированным в рамках StockSharp.
- Защитные ордера настраиваются через `StartProtection`, а не через прямые вызовы `OrderModify`.
- Удалены графические объекты и текстовые комментарии из терминала MetaTrader.
- Принудительное закрытие в конце сессии выполняется рыночным ордером, без перевода тейка в уровень безубыточности при убыточной позиции.

## Рекомендации по тестированию
- Используйте исторические данные, охватывающие весь торговый день, чтобы дневные максимумы и минимумы соответствовали реальной торговле.
- Протестируйте стратегию на периодах до и после смены летнего времени, чтобы проверить корректность сдвига.
- Экспериментируйте с величиной фильтра по тени и часами сессии, адаптируя стратегию к волатильности конкретного инструмента.
