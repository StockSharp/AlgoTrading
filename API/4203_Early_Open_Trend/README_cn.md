# Early Open Trend 策略

## 概述
- 基于 `MQL/9826` 中的 MetaTrader 4 专家顾问 `earlyOpenTrend.mq4` 改写。
- 每个交易日每个方向最多入场一次，利用当前价格相对当日开盘价的位置以及影线长度进行确认。
- 保留原始程序的交易时段逻辑，包括依赖夏令时偏移（`ZD`）的 1 小时 / 2 小时服务器时间调整。
- 使用 StockSharp 高阶 API：自动订阅 K 线、管理持仓保护，并在框架内实现会话控制。

## 市场逻辑
1. 构建日内 K 线序列（默认 15 分钟），实时重建当日的开盘价、最高价和最低价。
2. 依据 `SummerTimeStartDay` 与 `WinterTimeStartDay` 判断夏令时：介于这两个日期之间时，所有时段参数减去 2 小时，否则减去 1 小时，对应原始脚本中的 `ZD`。
3. 仅在更正后的 `[StartHour, EndHour)` 时段内且当前无持仓时评估信号。
4. 多头条件：
   - 最新收盘价高于当日开盘价；
   - 当日开盘价与最低价之间的距离大于 `RangeFilterPips`（按品种点值换算成价格）；
   - 当天尚未开过多单。
5. 空头条件：
   - 最新收盘价低于当日开盘价；
   - 当日最高价与开盘价之间的距离大于 `RangeFilterPips`；
   - 当天尚未开过空单。
6. 触发信号后按 `OrderVolume` 下市价单，并记录入场时间用于持仓时长限制。

## 会话与离场规则
- `EndHour` 限制新仓的产生，超过该时间（经夏令时校正）将不再开仓。
- `ClosingHour` 在到达指定小时后强制平仓。
- `HoldingHours` 为最大持仓时长，超过设定值即便仍在交易时段也会平仓。
- 每个方向每天仅执行一次，日切换时自动重置标记。

## 风险管理
- `StopLossPips` 与 `TakeProfitPips` 会依据 `Security.PriceStep` 自动换算为绝对价格；若为五位报价，系统会自动乘以 10 以获得标准点值。
- 任意一个参数大于零即启用 `StartProtection`，等效于原始程序在建仓后调用 `OrderModify` 设置止盈止损。
- 除了时间/持仓限制外，不包含额外的移动止损或跟踪逻辑。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `OrderVolume` | 0.1 | 每次下单的数量。 |
| `OrderType` | 0 | 方向过滤：`0`=双向，`1`=仅多头，`2`=仅空头。 |
| `RangeFilterPips` | 1 | 当日开盘价与反方向极值之间的最小影线长度。 |
| `TakeProfitPips` | 100 | 止盈距离（点），0 表示关闭。 |
| `StopLossPips` | 1000 | 止损距离（点），0 表示关闭。 |
| `StartHour` | 7 | 交易开始小时（夏令时修正前）。 |
| `EndHour` | 18 | 交易结束小时（夏令时修正前）。 |
| `ClosingHour` | 20 | 强制平仓的小时。 |
| `HoldingHours` | 0 | 最大持仓时长（小时），0 表示无限制。 |
| `SummerTimeStartDay` | 87 | 触发 2 小时时差的起始日（一年中的第几天）。 |
| `WinterTimeStartDay` | 297 | 恢复 1 小时时差的日期。 |
| `CandleType` | 15 分钟 | 计算所用的 K 线类型。 |

## 使用建议
1. 将策略附加到目标品种，确保 K 线类型与行情源一致。
2. 根据经纪商服务器时间调整会话参数，并在必要时修改夏令时起止日期以匹配当地制度。
3. 按交易品种调整止损/止盈点数；策略会自动根据 `PriceStep` 换算到价格单位。
4. 启动策略后，它会在每根已完成 K 线上刷新当日档案、评估入场条件，并保证每个方向每日仅交易一次。

## 与原版 MQL 的差异
- 使用已收盘的 K 线代替实时 `Bid`/`Ask`，信号可能略微延后，但逻辑在 StockSharp 中更可复现。
- 通过 `StartProtection` 设置保护单，取代原脚本中的手动 `OrderModify` 调用。
- 去除了 MetaTrader 图表上的矩形、文本及点差显示等图形元素。
- 会话结束时直接市价平仓，而不是在亏损状态下改写为保本止盈。

## 测试建议
- 使用覆盖完整交易时段的日内历史数据进行回测，以确保当日高低点与真实环境一致。
- 跨越夏令时与冬令时区间进行模拟，确认时差设置正确。
- 结合不同的影线阈值与会话时间测试，以适配经纪商的波动特征。
