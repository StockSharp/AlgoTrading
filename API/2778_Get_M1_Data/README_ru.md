[English](README.md) | [中文](README_cn.md)

# Стратегия экспорта минутных данных

Эта стратегия повторяет вспомогательный скрипт MetaTrader, который сохранял минутные бары во время тестирования.
Она подписывается на завершённые свечи, накапливает их значения и записывает их в файлы при остановке стратегии.
Экспортёр работает как в тестере, так и в режиме реальной торговли, что позволяет получать аккуратные исторические
срезы без привязки к формату `.hst`.

## Как работает алгоритм

1. При запуске стратегия подписывается на указанный тип свечей (по умолчанию минутные).
2. Каждая закрывшаяся свеча сохраняется вместе с ценами открытия, максимума, минимума, закрытия и объёмом.
3. При остановке накопленные данные выгружаются на диск в один или два формата в зависимости от параметров.
4. После сохранения файлов буфер очищается, чтобы стратегию можно было перезапустить без артефактов.

В реализации используется высокоуровневый API StockSharp. Свечи приходят через `SubscribeCandles` и обрабатываются
в методе `ProcessCandle`, а операции с файлами переносятся в `OnStopped`, чтобы не блокировать поток котировок.

## Параметры

- **File Name** – базовый путь, по которому создаются файлы. Расширения `.csv` и/или `.bin` добавляются автоматически.
  Относительные пути интерпретируются относительно текущего каталога, при необходимости директории создаются.
- **Candle Type** – тип свечей, запрашиваемый у коннектора. По умолчанию используется таймфрейм 1 минута, но можно
  выбрать другой для экспорта данных другой частоты.
- **Write CSV** – включает текстовый экспорт с заголовком и значениями, разделёнными запятыми. Подходит для Excel,
  Python-аналитики или ручного разбора.
- **Write Binary** – создаёт компактный бинарный снимок. Каждая запись содержит время свечи (UTC `DateTime` в бинарном
  виде), цены и объём. Перед данными записывается простой заголовок `(version = 1, count = N)`.

## Структура файлов

### CSV-файл

Файл сохраняется в UTF-8 без BOM и содержит следующие колонки:

| Колонка | Описание |
| --- | --- |
| Time | Время открытия свечи в формате `yyyy-MM-dd HH:mm:ss` с учётом часового пояса. |
| Open | Цена открытия в инвариантной культуре. |
| High | Максимальная цена в инвариантной культуре. |
| Low | Минимальная цена в инвариантной культуре. |
| Close | Цена закрытия в инвариантной культуре. |
| Volume | Совокупный или торговый объём за интервал. |

### Бинарный файл

Структура бинарного файла:

1. `int` – номер версии формата (1).
2. `int` – количество записей.
3. Для каждой свечи последовательность значений:
   - `long` – результат `DateTime.UtcDateTime.ToBinary()` для времени открытия.
   - `decimal` – цена открытия.
   - `decimal` – максимум.
   - `decimal` – минимум.
   - `decimal` – цена закрытия.
   - `decimal` – объём (берётся `TotalVolume`, при его отсутствии используется `Volume`).

Формат специально сделан простым, чтобы его можно было разобрать во внешних инструментах без зависимостей.

## Практические рекомендации

- Запустите стратегию с нужным инструментом и диапазоном дат, затем остановите её для инициирования экспорта.
- Если флаги `WriteCsv` и `WriteBinary` выключены, логика выведет информационное сообщение и пропустит запись файлов.
- Когда в `TotalVolume` нет данных, код использует поле `Volume`, что повторяет поведение оригинального MQL-скрипта
  с экспортом тикового объёма.
- Чтобы получить несколько файлов, запускайте стратегию с разными значениями `FileName`.
- Стратегия не совершает сделок, поэтому её можно использовать параллельно с аналитическими алгоритмами.

