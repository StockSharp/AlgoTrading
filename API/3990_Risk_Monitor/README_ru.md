# Стратегия Risk Monitor

## Обзор
Risk Monitor — порт MetaTrader 4 советника `risk.mq4`. Оригинальный скрипт не открывал сделок, а рассчитывал доступный объём
в зависимости от баланса счёта и заданного процента риска. Версия для StockSharp сохраняет тот же подход: постоянно диагностирует
состояние счёта, вычисляет рекомендуемые размеры позиций, отслеживает плавающую и реализованную прибыль и публикует результаты
непосредственно в поле комментария стратегии.

В отличие от типичных торговых систем Risk Monitor не выставляет заявки самостоятельно. Он служит монитором: показывает текущую
нагрузку по позиции, оставшуюся мощность в рамках выбранного риска и результат закрытых сделок. При любом изменении позиции, PnL
или собственных сделок комментарий обновляется, поэтому данные всегда актуальны.

## Логика расчётов
В комментарии выводятся три группы показателей:

1. **Базовый объём** — `баланс / 1000`, приведённый к минимальному шагу объёма инструмента. Это повторяет логику MT4, где на каждые
   1000 денежных единиц приходится один лот.
2. **Рисковый объём** — базовый объём, умноженный на `Risk % / 100` и также округлённый по шагу объёма. Значение показывает, сколько
   лотов можно открыть, не превышая допустимую долю риска.
3. **Открытый объём и разница** — сравнение абсолютной нетто-позиции с рисковым объёмом. Если фактическая позиция ниже лимита,
   разница показывает, сколько лотов ещё доступно. Незначительные отрицательные остатки (меньше шага объёма) обнуляются, чтобы не
   создавать визуальный шум.

Отдельно ведётся учёт прибыли:

* **Плавающий PnL** — берётся из свойства `PnL` стратегии, дополнительно переводится в проценты от текущей стоимости портфеля.
* **Реализованная прибыль** — накапливается по собственным сделкам. Для каждой закрывающей сделки вычисляется результат, учитывается
  комиссия, прибыль и убыток суммируются раздельно, затем складываются и конвертируются в долю от капитала.

## Параметры
* **Risk %** — доля баланса, которую разрешено задействовать в новых позициях. Значение по умолчанию — `10`. Параметр доступен для
  оптимизации, что позволяет быстро протестировать разные уровни риска.

## Формат комментария
Стратегия формирует три строки:

1. `Base lots`, `Risk lots`, `Open lots`, `Lots to adjust` — показатели позиционирования.
2. `Risk`, `Floating PnL` — установленный риск и текущая плавающая прибыль (в валюте и процентах).
3. `Realized profit` — совокупный результат закрытых сделок и его доля от капитала.

Все значения округляются аналогично оригинальному скрипту: учитывается шаг объёма инструмента, денежные величины отображаются с двумя
знаками после запятой. Поскольку информация находится в комментарии, её видно прямо на графике или в таблице стратегий без открытия
дополнительных окон.

## Рекомендации по использованию
* Назначайте стратегию на тот инструмент, по которому нужно контролировать нагрузку. StockSharp работает в режиме неттинга, поэтому
  хеджевые позиции MT4 не поддерживаются.
* Стратегия корректно реагирует на ручные операции — как только приходит подтверждение собственной сделки, статистика обновляется.
* При остановке или сбросе стратегия автоматически очищает комментарий, чтобы не оставлять устаревшие данные между сессиями.
* В пакете API доступна только реализация на C#; Python-версии нет.
