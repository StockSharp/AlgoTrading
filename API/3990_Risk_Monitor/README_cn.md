# 风险监控策略

## 概述
风险监控策略移植自 MetaTrader 4 专家顾问 `risk.mq4`。原始脚本并不会自动下单，而是根据账户余额和用户定义的风险百分比
计算可以安全使用的手数。本版本延续这一思路：持续分析账户状态、计算建议仓位规模、跟踪浮动及已实现收益，并将结果实时
写入策略注释，方便交易者快速查看。

与常规策略不同，风险监控策略不会自动发单。它承担的是监管职责：提供当前敞口、在选定风险预算下仍可使用的仓位额度，以及
已平仓交易的盈亏情况。每当持仓、收益或成交发生变化时，注释都会更新，确保信息始终反映最新的投资组合状态。

## 计算方法
策略在注释中展示的数值主要来自三类计算：

1. **基础手数** – 按 `账户余额 / 1000` 计算，并根据标的的交易量步长进行对齐。该规则与 MT4 版本一致，即每 1000 账户货币
   对应 1 标准手。
2. **风险手数** – 将基础手数乘以 `风险百分比 / 100`，并对齐到交易量步长，得到在当前风险预算下可使用的仓位。
3. **当前手数与差值** – 将净持仓绝对值与风险手数比较。如果尚未触及上限，差值表示在风险范围内仍可增加的手数。若差值为
   很小的负值且小于交易量步长，则会被四舍五入为 0，避免显示噪声。

收益方面区分浮动收益和已实现收益：

* **浮动收益** – 直接读取策略的 `PnL` 属性，同时给出货币数值和占当前资产的百分比。
* **已实现收益** – 通过监听自身成交累加。组件会将每笔平仓成交拆分为盈利与亏损部分，扣除成交报告中的佣金，并持续累加。
  最终结果也会折算成权益百分比，与 MT4 中的表现保持一致。

## 参数
* **风险百分比** – 允许用于开新仓的账户余额比例，默认值 `10`。该参数支持优化，可快速回测不同风险预算。

## 注释格式
策略注释分三行显示：

1. `Base lots`、`Risk lots`、`Open lots`、`Lots to adjust` – 手数和剩余容量概览。
2. `Risk`、`Floating PnL` – 风险设置、浮动盈亏（货币）以及相对于余额的百分比。
3. `Realized profit` – 累计平仓盈亏及其百分比。

所有数值都遵循原脚本的舍入方式，会参考标的的交易量步长，并对货币数值保留两位小数。信息直接显示在注释中，无需额外面板
即可在图表或策略列表中查看。

## 使用提示
* 将策略附加到需要监控的标的上；它与 StockSharp 一样使用净仓位模式（不支持 MT4 风格的对冲持仓）。
* 策略支持人工交易：只要收到自己的成交回报，就会立即更新统计数据。
* 当策略停止或重置时会自动清空注释，避免旧数据在会话之间残留。
* 目前仅提供 C# 版本，API 包中没有 Python 实现。
