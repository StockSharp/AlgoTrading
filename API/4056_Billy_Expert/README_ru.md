# Стратегия Billy Expert

## Общее описание
- Конвертация советника MetaTrader 4 "Billy_expert.mq4" в StockSharp.
- Работает только на покупку: ищет серию из четырёх свечей с последовательно падающими максимумами и ценами открытия.
- Подтверждение выполняют две стохастические кривые: быстрая на рабочем таймфрейме и медленная на старшем таймфрейме.
- Предназначена для валютных пар, но может применяться к любым инструментам с минутными свечами.

## Логика сигналов
### Фильтр по цене
1. Анализируются только закрытые свечи рабочего таймфрейма.
2. Требуется, чтобы максимумы и цены открытия четырёх подряд идущих свечей строго уменьшались (`High[0] < High[1] < High[2] < High[3]` и `Open[0] < Open[1] < Open[2] < Open[3]`).
3. Паттерн интерпретируется как иссякающее нисходящее движение и готовит вход на разворот.

### Подтверждение стохастикой
1. Стохастик на рабочем таймфрейме и стохастик на старшем таймфрейме рассчитываются с одинаковыми параметрами (5/3/3).
2. Для каждого индикатора проверяется условие `%K(0) > %D(0)` и `%K(1) > %D(1)`, то есть %K располагается выше %D как на текущей, так и на предыдущей свече.
3. Сделка открывается только при одновременном выполнении условий для обоих стохастиков.

## Управление позицией
- Входы: рыночная покупка объёмом `Volume` (если открыта короткая позиция, она перекрывается и переворачивается).
- Стоп-лосс: фиксированное смещение вниз от цены входа (`Stop Loss (pts)`), значение `0` отключает уровень.
- Тейк-профит: фиксированное смещение вверх от цены входа (`Take Profit (pts)`), значение `0` отключает цель.
- Ограничение позиций: параметр `Max Orders` задаёт максимально допустимое число одновременных покупок. StockSharp ведёт суммарную позицию, поэтому стратегия оценивает количество открытых "лот-блоков" через отношение текущего объёма к `Volume`.
- Трейлинг-стоп: в исходном советнике параметр присутствовал, но логика не реализована. В портированной версии trailing также отсутствует для соответствия оригиналу.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `Trading Candle` | Рабочий таймфрейм для паттерна и быстрого стохастика. | 1 минута |
| `Slow Stochastic Candle` | Таймфрейм для медленного подтверждающего стохастика. | 5 минут |
| `Stochastic Length` | Глубина расчёта %K. | 5 |
| `%K Smoothing` | Сглаживание линии %K. | 3 |
| `%D Period` | Сглаживание линии %D. | 3 |
| `Slowing` | Дополнительное сглаживание %K. | 3 |
| `Stop Loss (pts)` | Размер стоп-лосса в шагах цены. | 0 |
| `Take Profit (pts)` | Размер тейк-профита в шагах цены. | 12 |
| `Max Orders` | Максимальное число одновременных покупок. | 1 |

## Рекомендации по использованию
- Перед запуском обязательно задайте свойство `Volume`, иначе заявки не будут отправляться.
- Шаг цены берётся из `Security.PriceStep` (при отсутствии — из `Security.Step`, либо используется значение `1`). Убедитесь, что инструмент имеет корректно заполненные параметры.
- Если таймфреймы различаются, стратегия до появления новой медленной свечи использует последнюю доступную величину стохастика — так же, как исходный советник.
- Выход из позиции осуществляется рыночными заявками при достижении уровней стопа или тейка, что эквивалентно серверному исполнению в MT4.
- Для корректной работы ограничения `Max Orders > 1` желательно, чтобы каждый вход использовал одинаковый объём `Volume`.

## Отличия от версии MT4
- Добавлена проверка наличия шага цены с предупреждением в журнале.
- Дополнительные проверки на готовность данных (история свечей и значения стохастика), чтобы избежать преждевременных сделок.
- В StockSharp вычисления выполняются только по закрытым свечам, что исключает повторную обработку одного и того же бара и делает поведение детерминированным.
