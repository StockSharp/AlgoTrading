# Стратегия ChannelEA2

## Обзор
Стратегия ChannelEA2 переносит советника MetaTrader «ChannelEA2» в экосистему StockSharp. В течение торговой сессии между заданными часами начала и окончания она строит внутридневной ценовой канал. Когда окно сессии закрывается, стратегия выставляет стоп-заявки: покупку выше максимума канала и продажу ниже минимума. Для каждой заявки задаётся защитный стоп-лосс по противоположной границе канала, что позволяет ловить импульсные выходы из консолидации.

## Логика работы
- При первой завершённой свече, время открытия которой пересекает `BeginHour`, начинается новая сессия:
  - Все открытые позиции закрываются рыночными заявками.
  - Отменяются все активные ордера, включая ранее выставленные стопы на вход и защитные стопы.
  - Максимум и минимум канала инициализируются значениями первой свечи новой сессии.
- В период между `BeginHour` и `EndHour` каждая завершённая свеча обновляет границы канала.
- На первой свече, открывшейся после `EndHour`, стратегия рассчитывает:
  - Стоп-заявку на покупку на уровне максимума сессии плюс необязательный буфер в шагах цены.
  - Стоп-заявку на продажу на уровне минимума сессии минус тот же буфер.
  - Стоп-лосс для покупки равен минимуму сессии, для продажи — максимуму.
- После открытия позиции противоположная стоп-заявка отменяется, а в рынок отправляется защитный стоп по заранее сохранённому уровню.
- Заявки остаются активными до следующего запуска сессии, когда весь портфель очищается и канал строится заново.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `BeginHour` | Час (0-23), когда начинается новая сессия и начинается сбор данных. | `1` |
| `EndHour` | Час (0-23), когда планируется выставление стоп-заявок. Поддерживаются ночные сессии при `BeginHour > EndHour`. | `10` |
| `TradeVolume` | Объём каждой входящей сделки. | `1` |
| `CandleType` | Тип свечей, на которых строится канал (по умолчанию — часовые). | `1 час` |
| `StopBufferMultiplier` | Множитель шага цены, добавляемый к ценам входа и стоп-лоссам в качестве безопасного зазора. | `2` |

## Управление рисками
- Вызывается `StartProtection()`, чтобы StockSharp контролировал появление неожиданных позиций.
- Защитные стоп-заявки регистрируются сразу после появления позиции и отменяются при возврате позиции к нулю.
- Уровни стопов сдвигаются на `StopBufferMultiplier * PriceStep`, чтобы не нарушать минимальные дистанции, требуемые биржей.

## Дополнительные замечания
- После расчёта стоп-заявок границы канала фиксируются до начала следующей сессии.
- Если у инструмента отсутствует параметр `PriceStep`, буфер не применяется, и ордера выставляются точно по уровню канала.
- Параметр `TradeVolume` поддерживает дробные значения, что удобно при торговле лотами или контрактами неполного размера.
- На графике автоматически отображаются свечи и совершённые сделки, что облегчает визуальный контроль стратегии.
