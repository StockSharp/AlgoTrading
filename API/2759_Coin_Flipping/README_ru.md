# Стратегия Coin Flipping
[English](README.md) | [中文](README_cn.md)

## Обзор
Coin Flipping — это буквальная адаптация классического советника MetaTrader, который решает, покупать или продавать, подбрасывая «монетку». Каждый завершённый бар запускает новое решение, если стратегия не держит позицию, поэтому сделки образуют непрерывную последовательность независимых попыток. В версии для StockSharp поведение намеренно сохраняется простым: одновременно открыта только одна позиция, а каждой сделке сразу назначаются симметричные уровни стоп-лосса и тейк-профита в пунктах.

Несмотря на предельно наивную идею, пример демонстрирует, как переносить даже небольшие Expert Advisor в высокоуровневый API StockSharp. Стратегия подходит в качестве учебного пособия для настройки подписок на данные, блоков управления капиталом и защитных ордеров.

## Логика торговли
1. При запуске стратегии генератор псевдослучайных чисел инициализируется текущим системным тиком, что повторяет вызов `MathSrand(GetTickCount())` в MQL.
2. Для каждого завершённого бара (по умолчанию используется таймфрейм 1 минута, но можно выбрать любой тип свечей) проверяется возможность торговли и отсутствие открытой позиции.
3. Если позиция отсутствует, генератор выдаёт 0 или 1. Значение 0 приводит к рыночной покупке, значение 1 — к рыночной продаже. Объём рассчитывается динамически по заданному проценту риска и расстоянию до стоп-лосса.
4. Метод `StartProtection` прикрепляет к каждой позиции стоп-лосс и тейк-профит, благодаря чему сопровождение сделок выполняется автоматически.

Дополнительные фильтры не используются: как только позиция закрывается, следующая свеча немедленно инициирует новую сделку.

## Расчёт объёма
Формула объёма адаптирована под работу с портфелями StockSharp. Сначала вычисляется риск в деньгах: `Portfolio.CurrentValue * RiskPercent / 100`. Затем сумма делится на цену риска одного контракта (расстояние до стоп-лосса, переведённое из пунктов в денежные единицы с учётом шага цены). Полученный размер приводится к допустимой ступени объёма и ограничивается параметрами `MinVolume` и `MaxVolume` инструмента.

Таким образом сохраняется дух исходного кода — фиксированный процент капитала на сделку — при этом отправляемые заявки соответствуют спецификации инструмента в StockSharp.

## Параметры
| Параметр | Описание | Значение по умолчанию | Комментарии |
| --- | --- | --- | --- |
| `RiskPercent` | Процент капитала, которым стратегия рискует в каждой сделке. | `2` | Увеличение значения повышает объём, уменьшение — снижает его. |
| `TakeProfitPips` | Расстояние от цены входа до тейк-профита в пунктах. | `20` | Переводится в абсолютную цену через шаг цены и передаётся в `StartProtection`. |
| `StopLossPips` | Расстояние от цены входа до стоп-лосса в пунктах. | `10` | Используется и при установке стопа, и при расчёте объёма. |
| `CandleType` | Тип свечей, по которым выполняется «подбрасывание монетки». | `таймфрейм 1 минута` | Можно выбрать любой тип свечей StockSharp; большие интервалы уменьшают частоту сделок. |

## Управление рисками
`StartProtection` вызывается один раз в `OnStarted` с вычисленными дистанциями стоп-лосса и тейк-профита. Далее StockSharp самостоятельно сопровождает защитные ордера, повторяя логику аргументов `OrderSend` из MQL-версии. Поскольку стратегия торгует только при `Position == 0`, нет необходимости вручную отменять или переставлять заявки — при закрытии позиции платформа сама снимает защитные ордера.

## Особенности реализации
- Для обработки свечей используется высокоуровневый паттерн `SubscribeCandles().Bind(...)`, что делает код компактным и понятным.
- Сообщения журнала фиксируют выбранное направление и объём, поэтому в отчётах легко проследить поведение псевдослучайного генератора.
- Нормализация объёма учитывает `VolumeStep`, `MinVolume` и `MaxVolume`, благодаря чему размеры заявок соответствуют биржевым ограничениям.
- Все комментарии оставлены на английском языке в соответствии с требованиями репозитория.

## Рекомендации по применению
- Из-за случайного выбора направления стратегия не рассчитана на стабильную прибыль. Используйте её в учебных целях или для тестирования инфраструктуры.
- Убедитесь, что портфель, к которому привязана стратегия, имеет положительное значение `CurrentValue`, иначе расчёт риска вернёт ноль и сделки не будут открываться.
- Меняйте тип свечей, если требуется реже (например, часовые свечи) или чаще (например, тиковые данные) запускать «монетку».
- Во время оптимизации можно экспериментировать с расстояниями стоп-лосса и тейк-профита или снижать процент риска, чтобы контролировать просадки.
