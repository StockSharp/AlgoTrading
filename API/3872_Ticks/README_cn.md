# Ticks 策略

## 概述

**Ticks 策略** 是 MetaTrader 4 专家顾问 *Ticks.mq4* 的 C# 移植版本。原始脚本会把固定数量的买价 tick 聚合成一条
虚拟的 OHLC 记录并写入 CSV 文件。该 StockSharp 策略通过订阅当前标的的最佳买价，按可配置的批次大小收集数
据，并在每次聚合完成后输出一行逗号分隔的文本，从而完整复现原始逻辑。

与 MQL 实现相比，本策略提供了若干改进：

* 自动创建输出目录，并允许自定义文件名。
* 在停止或重置时安全释放文件句柄与订阅，避免资源泄漏。
* 代码内包含英文注释，便于维护者理解数据处理流程。

## 数据流程

1. 启动时先检查是否已指定 `Security`，随后根据参数确定文件名并以 UTF-8 编码打开 CSV。默认命名遵循
   `<symbol> volume <ticks>.csv` 模式。
2. 策略订阅 Level1 数据，并对包含 `BestBidPrice` 变动的每条更新视为一个新的 tick 进行处理。
3. 批次内的第一条 tick 决定开盘价与时间戳，随后的 tick 持续更新最高价和最低价。当累计的 tick 数达到设定
   的阈值时，最后一个买价作为收盘价，并以 `date,time,open,high,low,close,count` 的格式写入文件，全部数值都
   使用不变文化格式化。
4. 写入完成后计数器归零，等待下一条 tick 开始新的批次。

因此生成的 CSV 文件与 MetaTrader 输出完全一致，每行都代表 `TicksPerBatch` 个买价更新的聚合结果。

## 参数

| 名称 | 说明 |
|------|------|
| `TicksPerBatch` | 触发一次写入所需的 tick 数，默认值 100，与 MQL 的 `volume` 输入相同。 |
| `OutputDirectory` | 可选的输出目录，留空时使用当前工作目录。 |
| `CustomFileName` | 可选的自定义文件名（不含路径）。为空时继续使用 MetaTrader 的默认命名规则。 |

所有参数均通过 `StrategyParam<T>` 定义，可在界面中修改或参与优化。

## 输出格式

每条记录包含七个字段，使用英文逗号分隔：

```
YYYY.MM.DD,HH:MM,open,high,low,close,count
```

* `YYYY.MM.DD` 与 `HH:MM` 来自批次第一条 tick 的时间戳。
* `open`、`high`、`low`、`close` 是该批次内追踪到的买价。
* `count` 等于批次大小，用来确认聚合的 tick 数量。

## 使用说明

* 启动前需同时设置 `Portfolio` 和 `Security`。策略只使用主标的，不会自动解析额外的品种。
* 若输出目录不存在会自动创建；同名文件会被覆盖，这与原脚本启动时删除旧 CSV 的行为一致。
* 在停止或重置时会释放 Level1 订阅并关闭文件写入器，即使多次启动也不会遗留句柄。
* 策略完全依赖最佳买价更新。如果数据源不提供买价，CSV 文件将保持为空，正如原脚本必须接收到新的 tick 才
  能产出结果。

## 与 MQL4 版本的差异

* 采用强类型的参数对象，而非简单的 `extern` 输入。
* 使用 `StreamWriter` 并显式指定 UTF-8 编码；MQL 版本依赖终端默认编码。
* 新增的异常消息与保护性检查使环境配置错误时更容易定位问题。
