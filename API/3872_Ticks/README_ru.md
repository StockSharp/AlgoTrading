# Стратегия Ticks

## Обзор

**Стратегия Ticks** — это порт MetaTrader 4 эксперта *Ticks.mq4* на C#. Исходный скрипт объединял фиксированное количество
тикoв по цене Bid в искусственные OHLC-записи и сохранял их в CSV-файл. Версия для StockSharp выполняет те же действия: слушает
обновления лучшей цены покупателя по текущему инструменту, накапливает их в батчи заданного размера и по завершении каждого
батча добавляет строку с данными в текстовый файл.

По сравнению с оригиналом стратегия получила несколько улучшений:

* Автоматическое создание каталога назначения и возможность задать имя файла.
* Корректное освобождение файлового потока и рыночной подписки при остановке или сбросе стратегии.
* Англоязычные комментарии в коде, описывающие логику обработки данных.

## Логика работы

1. При запуске проверяется, что выбран `Security`, затем определяется имя файла и открывается CSV-писатель в кодировке UTF-8.
   По умолчанию используется шаблон `<symbol> volume <ticks>.csv`, как и в MQL-версии.
2. Стратегия подписывается на Level1-данные и обрабатывает каждое обновление, содержащее поле `BestBidPrice`, рассматривая его как
   очередной тик.
3. Первый тик в батче задаёт цену открытия и временную метку, последующие обновляют максимум и минимум. Когда количество тикoв
   достигает параметра `TicksPerBatch`, последняя цена Bid фиксируется как закрытие и строка `date,time,open,high,low,close,count`
   записывается в файл с использованием инвариантной культуры.
4. После записи счётчик обнуляется, и следующая поступившая цена начинает новый батч.

Итоговый CSV полностью повторяет вывод MetaTrader: каждая строка соответствует точно `TicksPerBatch` обновлениям Bid.

## Параметры

| Имя | Описание |
|-----|----------|
| `TicksPerBatch` | Количество тиков, необходимое для записи строки. Значение по умолчанию — 100 (как параметр `volume` в MQL). |
| `OutputDirectory` | Необязательный каталог для сохранения файла. Пустая строка — использовать текущую директорию. |
| `CustomFileName` | Необязательное имя файла без пути. Если не задано, применяется шаблон MetaTrader. |

Все параметры объявлены через `StrategyParam<T>`, поэтому их можно менять из интерфейса и использовать в оптимизации.

## Формат выхода

Каждая строка состоит из семи полей, разделённых запятыми:

```
YYYY.MM.DD,HH:MM,open,high,low,close,count
```

* `YYYY.MM.DD` и `HH:MM` берутся из времени первого тика в батче.
* `open`, `high`, `low`, `close` — цены Bid, накопленные в течение батча.
* `count` равен размеру батча и подтверждает количество учтённых обновлений.

## Рекомендации по использованию

* Перед запуском обязательно назначьте `Portfolio` и `Security`. Стратегия работает только с одним инструментом и не ищет
  дополнительные активы.
* Если указанный каталог отсутствует, он будет создан автоматически. Файл с тем же именем перезаписывается, что соответствует
  поведению MQL-скрипта, удалявшего старый CSV при старте.
* Подписка Level1 и файловый поток закрываются при остановке или сбросе, поэтому ресурсы не утекут при многократном запуске.
* Для генерации строк необходимы обновления Bid. Если поставщик данных их не передаёт, файл останется пустым, как и в оригинальном
  эксперте.

## Отличия от версии MQL4

* Вместо `extern` используются типизированные параметры `StrategyParam<T>`.
* Файл записывается через `StreamWriter` с явным указанием UTF-8, тогда как MetaTrader использовал настройки терминала.
* Добавлены диагностические сообщения и проверки, позволяющие быстрее обнаруживать проблемы с окружением.
