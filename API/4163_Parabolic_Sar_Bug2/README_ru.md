# Стратегия Parabolic SAR Bug 2

## Обзор
**Parabolic SAR Bug 2** — это порт MetaTrader-советника `pSAR_bug2` из каталога `MQL/9503` на высокоуровневый API StockSharp. Исходный эксперт реагирует на первый же разворот точек Parabolic SAR: если новая точка оказывается ниже цены закрытия, робот закрывает продажи и сразу открывает покупку; если точка перемещается выше закрытия, выполняется зеркальное действие. Расстояния стоп-лосса и тейк-профита задаются в «поинтах» и в MetaTrader умножаются на величину `Point`; в переносе используется тот же принцип через шаг цены инструмента.

StockSharp-версия сохраняет торговую идеологию, но опирается на удобный высокоуровневый API. Стратегия подписывается на завершённые свечи, привязывает индикатор Parabolic SAR с настраиваемыми параметрами ускорения, отслеживает моменты смены расположения точек и отправляет рыночные приказы, которые одновременно закрывают прежнюю позицию и открывают новую в противоположном направлении.

## Торговая логика
1. **Подготовка данных**. Подписка на заданный тип свечей (по умолчанию тайм-фрейм 15 минут) и привязка индикатора Parabolic SAR с параметрами `SarStep` и `SarMaximum`.
2. **Отслеживание состояния**. На первой завершённой свече запоминается, находится ли SAR выше или ниже цены закрытия. На каждой следующей свече новая позиция индикатора сравнивается с предыдущей.
3. **Правила входа**.
   - **Покупка**: когда SAR переходит из области выше закрытия в область ниже. Объём приказа вычисляется как `TradeVolume + |Position|`, что позволяет в одной рыночной сделке закрыть короткую позицию и открыть длинную. После входа сохраняются уровни стоп-лосса и тейк-профита относительно цены закрытия свечи.
   - **Продажа**: когда SAR перемещается из области ниже закрытия в область выше. По тому же принципу закрывается длинная позиция и открывается новая короткая.
4. **Защитные выходы**. На каждой завершённой свече максимум и минимум сравниваются с сохранёнными уровнями стоп-лосса и тейк-профита. При пробое уровня отправляется рыночный приказ на закрытие позиции, после чего стопы и тейки сбрасываются.

## Управление рисками
- Расстояния стоп-лосса и тейк-профита умножаются на шаг цены инструмента. Если шаг недоступен, используется резервное значение `0.0001`.
- Перед отправкой заявок вызывается `IsFormedAndOnlineAndAllowTrading()`, чтобы убедиться в наличии данных и разрешении на торговлю.
- Вход по развороту всегда включает модуль текущей позиции, поэтому новый приказ полностью закрывает прежнее направление и открывает противоположное.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `TradeVolume` | `0.1` | Базовый торговый объём в лотах. Значение также записывается в свойство `Strategy.Volume`. |
| `StopLossPoints` | `90` | Расстояние до стоп-лосса в поинтах, умножается на шаг цены инструмента. |
| `TakeProfitPoints` | `20` | Расстояние до тейк-профита в поинтах, переводится через шаг цены. |
| `SarStep` | `0.001` | Начальный коэффициент ускорения индикатора Parabolic SAR. |
| `SarMaximum` | `0.2` | Максимальный коэффициент ускорения индикатора Parabolic SAR. |
| `CandleType` | `15 минут` | Тип свечей, используемых для расчётов и генерации сигналов. |

## Особенности конвертации
- Биржевые стоп-ордера MetaTrader моделируются проверкой экстремумов свечи и отправкой рыночных приказов при пробое уровней.
- В оригинале позиция закрывалась через `OrdersTotal()` и `OrderClose()`. В версии для StockSharp то же самое достигается одним рыночным приказом объёмом `TradeVolume + |Position|`, который обнуляет старую позицию и открывает новую.
- По требованию задачи Python-вариант не создавался — в каталоге присутствует только C#-реализация стратегии.
