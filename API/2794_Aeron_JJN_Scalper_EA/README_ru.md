# Стратегия Aeron JJN Scalper EA

## Обзор
Стратегия представляет собой порт экспертного советника **Aeron JJN Scalper** на высокоуровневый API StockSharp. Алгоритм анализирует только завершённые свечи, ищет двухсвечные разворотные комбинации и запоминает цену открытия последней сильной свечи в противоположную сторону. Этот уровень рассматривается как отложенный стоп-ордер: при его достижении отправляется рыночная заявка, устанавливаются ATR-ориентиры по стоп-лоссу и тейк-профиту, а дальнейшее сопровождение ведётся с помощью трейлинг-стопа в пунктах.

Ключевые идеи:

* Направление сделки определяется двухсвечным разворотом (бычья/медвежья комбинация).
* Точка входа — открытие последней «сильной» свечи противоположного цвета.
* Значение ATR(8), рассчитанное на свечке сигнала, задаёт расстояние до стоп-лосса и тейк-профита.
* Трейлинг-стоп срабатывает, когда цена проходит заданное количество пунктов в прибыльную сторону.
* Отложенные уровни автоматически отменяются по истечении заданного времени.

## Правила торговли
### Поиск сигнала
1. Используются только закрытые свечи выбранного таймфрейма (по умолчанию 1 минута).
2. Размер пункта вычисляется из шага цены инструмента; для трёх- и пятизнаковых котировок дополнительно применяется коэффициент 10, как в MetaTrader.
3. В памяти хранится до 120 последних свечей для поиска подходящих исторических баров.
4. **Сигнал на покупку** появляется, если:
   * текущая свеча закрылась выше открытия;
   * предыдущая свеча — медвежья, и её тело больше `DojiDiff1Pips`;
   * при поиске назад находится ближайшая медвежья свеча с телом больше `DojiDiff2Pips`, её открытие — уровень стоп-покупки.
5. **Сигнал на продажу** формируется зеркально: текущая свеча медвежья, предыдущая — сильная бычья, уровень берётся по открытию последней бычьей свечи с телом больше `DojiDiff2Pips`.
6. Новые сигналы игнорируются, если уже есть уровень в ту же сторону или ATR ещё не посчитан.

### Управление отложенными уровнями
* Сохранённый уровень рассматривается как отложенный ордер и удаляется, если цена не достигает его до истечения `ResetMinutes` минут.
* Если в последующих свечах максимум ≥ уровня покупки (или минимум ≤ уровня продажи), стратегия отправляет рыночную заявку нужного объёма: позиция переворачивается и добавляется `Volume` лотов.
* После открытия позиции противоположный уровень сбрасывается.

### Стоп-лосс, тейк-профит и трейлинг
* При входе фиксируется значение ATR(8) свечи сигнала:
  * Для лонга: стоп-лосс = `entry - ATR`, тейк-профит = `entry + ATR`.
  * Для шорта: стоп-лосс = `entry + ATR`, тейк-профит = `entry - ATR`.
* На каждой завершённой свече выполняются проверки:
  * если цена достигла стоп-уровня или цели, позиция закрывается рыночной заявкой;
  * когда прибыль превышает `TrailingStopPips + TrailingStepPips` пунктов, трейлинг-стоп переносится на расстояние `TrailingStopPips` от текущего закрытия и никогда не отступает назад.
* При ручном закрытии позиции внутренние переменные очищаются автоматически.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Volume` | 0.1 | Размер чистой позиции при входе; при развороте добавляется абсолютная величина текущей позиции. |
| `TrailingStopPips` | 5 | Базовое расстояние трейлинг-стопа в пунктах (переводится в цену). |
| `TrailingStepPips` | 5 | Дополнительное движение в пунктах до очередного переноса трейлинга. |
| `ResetMinutes` | 10 | Время жизни отложенного уровня (минуты). |
| `DojiDiff1Pips` | 10 | Минимальное тело предыдущей свечи для подтверждения разворота. |
| `DojiDiff2Pips` | 4 | Минимальное тело свечи, используемой как уровень входа. |
| `CandleType` | 1 минута | Тип свечей для расчётов. |

## Особенности реализации
* Стратегия работает на уровне завершённых свечей и не выставляет реальные стоп-заявки: при пробое уровня выполняется рыночная сделка, что повторяет логику исходного советника в рамках высокоуровневого API.
* ATR(8) рассчитывается индикатором `AverageTrueRange`, чтобы стопы и цели оставались постоянными для каждой сделки.
* Преобразование пунктов повторяет метатрейдеровский подход к трёх- и пятизнаковым котировкам; при отсутствии `PriceStep` используется значение 1.
* В памяти поддерживается до 120 свечей, что немного превышает исходный вызов `CopyRates` на 100 баров.
* Python-версия стратегии не создавалась.

## Использование
1. Подключите стратегию к нужному инструменту и портфелю.
2. Настройте таймфрейм свечей, параметры точек и ATR под особенности инструмента.
3. Запустите стратегию — она будет отслеживать сигналы, входить при достижении уровней и сопровождать позиции автоматически.
