# Стратегия MartingaleEA-5 Levels (StockSharp)

**MartingaleEA-5 Levels** — перенос советника MetaTrader 5 «MartingaleEA-5 Levels» на высокоуровневый API StockSharp. Стратегия следит за уже открытой позицией и при движении цены против неё строит мартингейл-сетку из максимум пяти усредняющих ордеров. Все вычисления выполняются на закрытии свечей, поэтому результаты совпадают в тестах и на реальном рынке.

## Логика работы

1. **Контроль текущих позиций.** Стратегия предполагает наличие стартовой длинной или короткой позиции. Её можно открыть вручную либо сторонним алгоритмом.
2. **Оценка неблагоприятного движения.** После закрытия каждой свечи измеряется расстояние от текущей цены до худшей цены входа в активной группе (для лонгов — максимальная, для шортов — минимальная).
3. **Мартингейл-добавления.** Если суммарный плавающий результат по направлению отрицательный и цена ушла дальше заданного порогового расстояния, выставляется новая рыночная заявка. Объём каждой следующей заявки равен предыдущему, умноженному на `VolumeMultiplier`. Конфигурация содержит до пяти уровней, фактическое количество ограничивается `MaxAdditions`.
4. **Фиксация прибыли/убытка.** Пока группа открыта, стратегия суммирует нереализованный результат. При достижении `TakeProfitCurrency` или падении ниже `StopLossCurrency` все ордера данного направления закрываются рыночной заявкой, а счётчики мартингейла обнуляются.
5. **Нормализация объёмов.** Объёмы всех заявок приводятся к шагу `VolumeStep` и находятся в пределах `MinVolume`/`MaxVolume`, чтобы исключить отклонённые заявки.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `EnableMartingale` | Включает или выключает усреднение и групповое закрытие. | `true` |
| `VolumeMultiplier` | Множитель объёма для каждого нового уровня. | `2.0` |
| `MaxAdditions` | Максимальное число добавлений по одному направлению (до пяти). | `4` |
| `Level1DistancePips` | Неблагоприятное смещение (в пунктах) для открытия второго ордера. | `300` |
| `Level2DistancePips` | Дополнительное смещение до третьего ордера. | `400` |
| `Level3DistancePips` | Дополнительное смещение до четвёртого ордера. | `500` |
| `Level4DistancePips` | Дополнительное смещение до пятого ордера. | `600` |
| `Level5DistancePips` | Дополнительное смещение до шестого ордера (при разрешённом лимите). | `700` |
| `TakeProfitCurrency` | Плавающая прибыль (в валюте счёта), при которой закрывается вся группа. | `200` |
| `StopLossCurrency` | Плавающий убыток (в валюте счёта), при котором происходит аварийное закрытие. | `-500` |
| `CandleType` | Тип свечей для расчётов (по умолчанию 1-минутные). | `TimeFrame(1m)` |

> **Пересчёт пунктов.** Указанные расстояния умножаются на шаг цены инструмента (`PriceStep` либо `MinPriceStep`). Для инструментов с дробным пунктом скорректируйте значения.

## Рекомендации

- Логика повторяет оригинального советника и предполагает один активный корзинный набор на направление. Если одновременно держать лонг и шорт, стратегия будет вести отдельный учёт по каждому.
- Поскольку решения принимаются на закрытии свечей, подбирайте таймфрейм в зависимости от требуемой скорости реакции. Чем меньше интервал, тем ближе поведение к тиковому.
- Мартингейл значительно повышает риски. Перед запуском на реальном счёте выполните детальные прогоны с учётом комиссии и проскальзывания, а также задайте консервативные уровни защитных остановок.
- По запросу добавлена только C#-реализация; Python-версия и каталог пока не создавались.
