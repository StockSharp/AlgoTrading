# Стратегия Swaper (API 3751)

## Обзор

**Swaper Strategy** — это перенос советника MetaTrader "Swaper 1.1" на высокий уровень API StockSharp. Оригинальная система
зарабатывает на свапах, постоянно перестраивая синтетический портфель между длинными и короткими позициями. Конверсия
воссоздаёт денежный поток советника: вычисляет справедливую стоимость базового инструмента и подстраивает открытую позицию под
полученное значение.

## Основная логика

1. **Реконструкция синтетического капитала.** Переменная `money` из MQL воспроизводится через стартовый баланс
   (`BaseUnits * BeginPrice`), реализованную прибыль по сделкам и нереализованный результат текущей позиции, умноженный на
   `ContractMultiplier`.
2. **Знаменатель справедливой цены.** Переменная `com` из оригинала зависит от величины активных позиций. Здесь она рассчитывается
   как `BaseUnits + ContractMultiplier * Position`, что повторяет изменение знаменателя при росте или сокращении объёма.
3. **Расчёт целевого объёма.** Берётся максимум из двух последних максимумов свечей (с поправкой на спред) и минимум из двух
   последних минимумов. Коэффициент `Experts / (Experts + 1)` задаёт скорость подстройки к справедливой цене.
4. **Коррекция позиции.** В зависимости от `dt` стратегия:
   - закрывает позицию, если требуемая корректировка меньше одной десятой лота;
   - наращивает продажи, когда `dt < 0`;
   - наращивает покупки, когда `dt >= 0`.
5. **Учёт маржи.** Метод `GetTradableVolume` аппроксимирует `AccountFreeMargin()`, сравнивая параметр `MarginPerLot` со
   стоимостью портфеля. Если доступной маржи не хватает, объём округляется вниз до ближайшей десятой доли лота.

Весь цикл исполняется по завершённым свечам, что заменяет тиковый `start()` и при этом сохраняет экономическую идею.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Experts` | `1` | Вес, с которым стратегия приближает позицию к справедливой цене. |
| `BeginPrice` | `1.8014` | Стартовая цена для восстановления виртуального баланса. |
| `MagicNumber` | `777` | Сохранённый идентификатор из версии MetaTrader (можно использовать в комментариях к заявкам). |
| `BaseUnits` | `1000` | Базовые единицы капитала в знаменателе справедливой цены. |
| `ContractMultiplier` | `10` | Множитель, переводящий ценовые изменения в валюту счёта. |
| `MarginPerLot` | `1000` | Приближённая потребность в капитале для удержания одного лота. |
| `FallbackSpreadSteps` | `1` | Спред в шагах цены, когда данные стакана недоступны. |
| `CandleType` | `1 час` | Таймфрейм, на котором выполняется перебалансировка. |

## Последовательность работы

1. Подписаться на выбранные свечи и поток Level 1, чтобы фиксировать спред.
2. При отсутствии котировок использовать значение `FallbackSpreadSteps * PriceStep`.
3. На каждой завершённой свече пересчитывать синтетический капитал и знаменатель `com`.
4. Сначала анализировать верхнюю ветку (`dt` по максимумам). Если `dt < 0`, переходить к ветке минимумов, повторяя защиту из
   оригинала.
5. Вызывать `AdjustShort` или `AdjustLong` для уменьшения/увеличения позиции. Если требуемый объём меньше 0.1 лота — закрывать
   позицию полностью, как это делает `closeby` в MetaTrader.
6. В `OnOwnTradeReceived` обновлять реализованную прибыль, чтобы следующие итерации использовали актуальный баланс.

## Отличия от версии MQL4

- Тиковый цикл `start()` заменён обработкой свечей. Это исключает пустой опрос и оставляет стратегию идейно неизменной.
- История ордеров и активные сделки анализируются через собственные сделки стратегии, поскольку в StockSharp нет прямых
  аналогов `OrdersHistoryTotal()` и `OrdersTotal()`.
- Проверка маржи основана на `Portfolio.CurrentValue` и настраиваемом `MarginPerLot`, так как брокерские функции `MarketInfo`
  недоступны.
- Закрытие встречных ордеров (`OrderCloseBy`) имитируется принудительным выравниванием нетто-позиции, что соответствует модели
  неттинга в большинстве коннекторов StockSharp.

## Рекомендации по использованию

- Подберите `MarginPerLot` под спецификацию брокера, чтобы стратегия не пыталась открыть недоступный объём.
- Используйте таймфрейм, близкий к исходному, чтобы экстремумы свечей совпадали с данными MetaTrader.
- Убедитесь, что подписки на свечи и Level 1 активны одновременно: так спред будет рассчитываться корректно, а реакция стратегии
  останется синхронной с оригиналом.
