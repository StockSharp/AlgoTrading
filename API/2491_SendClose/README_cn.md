# SendClose 策略

## 概述
SendClose 是一套基于分形支撑/阻力的突破系统，来源于 MT5 平台的同名专家顾问。策略通过连接交替出现的上/下分形来构建动态趋势线，一旦价格重新触及这些投射出来的水平，就会执行开仓或平仓操作。此移植版完全基于 StockSharp 的高级 API，实现了与原版相同的交易规则：
- 使用最近的分形节点绘制卖出线与买入线；
- 价格触线后采用市价单入场；
- 通过在趋势线上下方平移固定点数生成 Close1/Close2 退出线，用于强制平仓。

## 分形识别流程
1. **五根K线窗口**：策略维护最近五根已完成的K线缓冲区，当数据充足时，总是检查位于中间的那根K线。
2. **上分形条件**：若中间K线的最高价高于其两根更早K线，并且不低于两根更晚K线的最高价，则确认一个上分形，与 MT5 的 `iFractals` 指标保持一致。
3. **下分形条件**：若中间K线的最低价低于其两根更早K线，并且不高于两根更晚K线的最低价，则确认一个下分形。
4. **分形队列**：每次确认新的分形后，都会压入一个最多六个元素的队列中，按时间从新到旧排列，供趋势线构建逻辑检索。

## 趋势线构建
- **卖出线**：寻找最近一次“上分形 → 下分形 → 上分形”的组合，并将两端的上分形连接成直线，对应阻力线。
- **买入线**：寻找最近一次“下分形 → 上分形 → 下分形”的组合，并连接两端的下分形，形成支撑线。
- **价格投射**：保存分形点的时间与价格后，可在任何未来时刻对直线进行插值或外推，得到当前蜡烛收盘时间的理论价格。
- **退出线**：在卖出线上方、买入线下方分别平移 `LineOffsetSteps × PriceStep`，生成 Close1 与 Close2，用于复制原策略的强制平仓机制。

## 交易逻辑
### 入场
- **卖出**：当价格触及卖出线，且当前不存在多头头寸时，发送卖出市价单。若已经持有空头仓位，可在不超过 `MaxPositions` 限额的前提下加仓。
- **买入**：当价格触及买入线，且当前不存在空头头寸时，发送买入市价单。同样允许在限额内逐步加仓。

### 离场
- **Close1/Close2**：价格触碰任一退出线时，立即平掉全部持仓，与 MT5 版本保持一致。
- **净额处理**：由于 StockSharp 采用净头寸模型，策略会在信号触发时先尝试平掉反向仓位，再决定是否开立新方向的头寸。

### 触线判定
原版在报价触及直线时即时反应，此实现使用蜡烛的高低价区间来近似。如果需要更高精度，可改用逐笔数据订阅。

## 参数说明
| 参数 | 说明 |
|------|------|
| `EnableSellLine` | 是否根据上方分形线执行卖出入场。 |
| `EnableBuyLine` | 是否根据下方分形线执行买入入场。 |
| `EnableCloseSellLine` | 是否启用 Close1（卖出线向上平移后的平仓线）。 |
| `EnableCloseBuyLine` | 是否启用 Close2（买入线向下平移后的平仓线）。 |
| `MaxPositions` | 允许同时持有的最大净头寸（以下单手数为单位）。 |
| `OrderVolume` | 每次市价单的下单数量。 |
| `LineOffsetSteps` | Close1/Close2 与基础趋势线之间的价格步长偏移，默认 15，对应 MT5 中的 `15*Point()`。 |
| `CandleType` | 用于计算的K线类型（时间框架）。 |

## 实现细节
- 仅处理已完成的K线，避免在未确认的蜡烛上产生虚假分形。
- 退出逻辑优先于入场逻辑，保证触发平仓时不会同时再开仓。
- `MaxPositions` 基于净仓计算，因此在净额账户中可直接限制加仓数量；若需要完全复制 MT5 的对冲模式，可将该值设置为更大并在交易所层面允许对冲。
- 偏移量依赖 `Security.PriceStep`。若交易品种未提供价格步长，请手动设置或在外部补充。

## 使用建议
1. 在 StockSharp 终端中选定交易品种，确认其最小价格变动（PriceStep）与合约规模信息完整。
2. 将 `CandleType` 设置为与图表一致的时间框架，如 M15 或 H1，以获得与原策略相近的信号节奏。
3. 根据资金管理需求调整 `OrderVolume` 与 `MaxPositions`，控制最大敞口。
4. 如果市场波动较大，可适当提高 `LineOffsetSteps`，以减少噪音触发的平仓。
5. 建议结合账户级风控（如日内止损、交易时段过滤）一起使用，防止无保护的市价单造成过度亏损。

## 与 MT5 版本的差异
- 新版本不自动绘制图形对象，如需可视化，可在图表模块中自行绘制趋势线。
- 使用蜡烛高低价替代买卖价判断触线，信号可能比 MT5 的逐笔触发略有延迟。
- 多空互转时会优先平仓再入场，避免在净额账户里出现双向持仓。

## 风险提示
该策略未内置止损或资金管理规则，仅依赖分形线触发。实盘前务必在目标品种上进行充分回测与前向验证，并辅以账户级风险控制措施。
