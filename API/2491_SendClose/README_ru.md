# Стратегия SendClose

## Общая идея
SendClose — портированная на StockSharp версия одноимённого советника MT5. Алгоритм отслеживает последовательности фракталов Билла Вильямса, соединяет их в динамические трендовые линии и реагирует, когда текущая цена достигает рассчитанных уровней. Подход сохраняет три ключевые части оригинала:
- построение линий продаж и покупок по цепочке фракталов «верхний → нижний → верхний» и «нижний → верхний → нижний»;
- генерация рыночных ордеров при касании этих линий;
- формирование двух дополнительных линий Close1/Close2, смещённых на фиксированное число пунктов, чтобы принудительно закрывать позицию.

## Как выявляются фракталы
1. **Скользящее окно из пяти свечей.** Стратегия всегда держит в памяти пять последних завершённых свечей и оценивает среднюю из них.
2. **Верхний фрактал.** Средняя свеча признаётся верхним фракталом, если её максимум не ниже максимумов двух более новых свечей и строго выше максимумов двух более старых свечей.
3. **Нижний фрактал.** Аналогично, минимум средней свечи должен быть не выше минимумов двух более новых и строго ниже минимумов двух более старых свечей.
4. **Очередь фракталов.** Каждый подтверждённый фрактал помещается в очередь (до шести элементов) от нового к старому. Очередь затем используется для поиска нужных комбинаций.

## Построение линий
- **Линия продаж.** Берётся последняя комбинация «верхний фрактал → нижний фрактал → верхний фрактал». Полученные верхние фракталы формируют отрезок, который служит сопротивлением.
- **Линия покупок.** По цепочке «нижний → верхний → нижний» строится поддержка.
- **Проекция по времени.** Запоминаются время и цена обеих точек. Это позволяет получить значение линии в любой момент позже за счёт линейной интерполяции/экстраполяции.
- **Линии закрытия.** Close1 располагается выше линии продаж на `LineOffsetSteps × PriceStep`, Close2 — ниже линии покупок на ту же величину. При касании любой из них позиция закрывается.

## Логика торговли
### Входы
- **Продажа.** Если цена попала на линию продаж, стратегия закрывает длинную позицию (если была) и, при условии что лимит `MaxPositions` ещё не исчерпан, открывает или добавляет короткую позицию объёмом `OrderVolume`.
- **Покупка.** При касании линии покупок закрывается короткая позиция и, при наличии свободного лимита, открывается/добавляется длинная.

### Выходы
- **Close1/Close2.** Любое касание смещённых линий вызывает немедленное закрытие позиции, что повторяет поведение MT5-версии.
- **Приоритет выхода.** Проверка на закрытие выполняется раньше проверки входа, поэтому конфликтных сигналов не возникает.

### Как определяется «касание»
В MT5 советник использовал тики Bid/Ask. Здесь применяется проверка: значение линии должно находиться внутри диапазона High–Low завершённой свечи. Для большей точности можно подключить источники тиковых данных.

## Параметры
| Параметр | Назначение |
|----------|------------|
| `EnableSellLine` | Включает/выключает сделки от верхней линии. |
| `EnableBuyLine` | Включает/выключает сделки от нижней линии. |
| `EnableCloseSellLine` | Управляет использованием линии Close1 (закрытие по линии продаж + смещение). |
| `EnableCloseBuyLine` | Управляет использованием линии Close2 (закрытие по линии покупок – смещение). |
| `MaxPositions` | Максимальное количество лотов в одном направлении. |
| `OrderVolume` | Объём каждого рыночного ордера. |
| `LineOffsetSteps` | Смещение для линий закрытия в шагах цены. Значение 15 соответствует `15*Point()` в оригинале. |
| `CandleType` | Тип/таймфрейм свечей, по которым выполняются расчёты. |

## Особенности реализации
- Обработка ведётся только по закрытым свечам, чтобы не строить фракталы на незавершённых данных.
- Первая очередь — закрыть позицию по Close1/Close2, затем уже проверять новые входы.
- Ограничение `MaxPositions` рассчитывается из чистой позиции (netting). Если брокер поддерживает хеджирование, можно разрешить большее количество лотов и управлять ими внешне.
- Смещение линий использует `Security.PriceStep`. Убедитесь, что инструмент предоставляет корректный шаг цены.

## Рекомендации по использованию
1. Настройте подписку на нужный инструмент и убедитесь, что указаны шаг цены и размер контракта.
2. Подберите таймфрейм в `CandleType`, соответствующий вашему торговому плану (например, M15 или H1).
3. Подберите `OrderVolume` и `MaxPositions` исходя из допустимого риска.
4. При высокой волатильности имеет смысл увеличить `LineOffsetSteps`, чтобы уменьшить число ложных выходов.
5. Обязательно дополните стратегию внешними мерами контроля риска: дневные лимиты, фильтры по времени, стоп-заявки.

## Отличия от MT5-советника
- Графические объекты не создаются автоматически; при необходимости визуализацию можно добавить вручную через модуль графиков.
- Проверка касания выполняется по диапазону свечи, поэтому возможны расхождения по времени с тиковыми сигналами MT5.
- При смене направления стратегия сначала закрывает противоположную позицию и только потом открывает новую, что соответствует netting-модели StockSharp.

## Управление рисками
Стратегия использует рыночные ордера без встроенных стоп-лоссов. Перед применением на реальном счёте выполните детальный бэктест и обеспечьте внешний контроль капитала (например, через менеджер позиций или ограничения по счёту).
