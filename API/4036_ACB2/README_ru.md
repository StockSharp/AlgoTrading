# Стратегия ACB2

## Обзор
Стратегия воспроизводит эксперта MetaTrader **ACB2**, который служит диагностическим инструментом и не открывает сделки. Она отслеживает активность тиков внутри выбранного таймфрейма свечей (по умолчанию M1) и выводит подробные сводки о количестве тиков, посчитанных локально, и о тиковой волатильности, которую сообщает поставщик данных. Порт на StockSharp сохраняет исходное поведение с `Alert`, передавая сообщения через `AddInfoLog`, поэтому уведомления легко направить в любой журнал или систему оповещений.

## Параметры
- **Candle Type** – таймфрейм, который определяет контролируемый интервал. По умолчанию используется M1. Допустимы любые таймфреймы на основе `TimeFrameCandleMessage`.

## Логика мониторинга
1. При старте стратегия оформляет подписки:
   - на свечи выбранного таймфрейма, чтобы получить время открытия и тик-объём текущего и предыдущего интервала;
   - на поток тиков, чтобы реагировать на каждое новое торговое сообщение.
2. Первый срез по свечам синхронизирует внутренние счётчики с уже накопленным тик-объёмом. Сообщение `"Start"` записывается ровно один раз, полностью повторяя вызов `Alert("Start")` в оригинале.
3. Для каждого последующего тика выполняются действия:
   - Определяется, относится ли тик к текущему интервалу, или начинает новый, путём выравнивания серверного времени по выбранному таймфрейму.
   - Увеличивается локальный счётчик тиков для активного интервала. Если начинается новая свеча, значения предыдущего интервала переносятся в слот `Frame 1`, счётчик текущего интервала сбрасывается на единицу, а в журнал отправляется уведомление "Frame 0 closed" с временем открытия прошлого интервала, локально подсчитанным числом тиков и тик-объёмом из свечной подписки.
   - Обновляется кэш провайдерских объёмов на основе свежего сообщения свечи, чтобы диагностический вывод отражал возможные расхождения между локальным подсчётом и внешним источником.
4. После обработки тика формируется итоговая строка. Формат полностью повторяет оригинальную программу и включает:
   - идентификатор инструмента и короткое обозначение таймфрейма;
   - время открытия текущего интервала, число секунд с начала, локальный счётчик и тик-объём поставщика;
   - время открытия, локальный счётчик и тик-объём для предыдущего интервала.

## Формат логов
Стратегия создаёт три вида сообщений:
- `Start` – подтверждает синхронизацию со свечным потоком.
- `Frame 0 closed: ...` – появляется на первом тике новой свечи и подводит итог предыдущего интервала.
- `<symbol> <timeframe>: Frame 0 ...` – печатается на каждом тике и показывает актуальные значения для текущего и предыдущего интервалов.

Все строки выводятся через `AddInfoLog`, благодаря чему видны как в интерфейсе StockSharp, так и в любых подключённых слушателях.

## Особенности реализации
- Стратегия собирает только диагностические данные и не взаимодействует с портфелем и заявками.
- Тиковый объём берётся из `ICandleMessage.TotalTicks` с резервом на `TotalVolume` и `Volume`, если поставщик не присылает число тиков напрямую.
- В памяти хранятся только два интервала, дополнительные коллекции не создаются, что соответствует требованиям конвертации.
- Пока поставщик не передал очередной объём, временно используется локальный счётчик, чтобы журналы оставались последовательными.
- Вспомогательный метод `DescribeDataType` преобразует таймфрейм в компактную метку (M1, H1 и т.д.), упрощая чтение диагностических сообщений.
