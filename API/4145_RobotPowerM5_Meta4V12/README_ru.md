# Стратегия RobotPowerM5 Meta4 V12

## Обзор
RobotPowerM5 Meta4 V12 — это порт на C# советника MetaTrader 4 `RobotPowerM5_meta4V12.mq4`. Изначально робот работал на
пятиминутных графиках и сопоставлял показатели индикаторов Bulls Power и Bears Power, чтобы определить, стоит ли открывать
лонг или шорт. Реализация на StockSharp сохраняет режим «одна позиция», повторяет настройку стоп-лосса и тейк-профита в
"поинтах" MetaTrader, а также восстанавливает логику трейлинг-стопа, который фиксирует прибыль при движении цены в нужную сторону.

## Торговая логика
1. **Индикаторы**
   - По умолчанию подключаются пятиминутные свечи (тип можно изменить параметром `CandleType`).
   - Два индикатора StockSharp — `BullsPower` и `BearsPower` — обновляются на каждой завершённой свече с заданным периодом.
   - Сумма `BullsPower + BearsPower` сохраняется с задержкой в одну свечу, чтобы воспроизвести вызовы `shift=1` из MQL, где
     используется только полностью закрытый бар.
2. **Правила входа**
   - Когда позиция отсутствует и отложенная сумма Bulls/Bears Power **положительна**, отправляется рыночная покупка.
   - Когда позиция отсутствует и сумма **отрицательна**, отправляется рыночная продажа.
   - Пока позиция открыта, новые сигналы игнорируются — управление осуществляется только защитными выходами.
3. **Объём**
   - Параметр `Volume` задаёт запрашиваемый лот. Значение напрямую передаётся в `BuyMarket` / `SellMarket`, брокерский коннектор
     округлит объём с учётом шага лота.

## Управление рисками
- **Стоп-лосс** — первоначальный стоп отстоит от цены входа на `StopLossPoints` поинтов MetaTrader. Уровень контролируется
  минимумом свечи (для лонга) или максимумом (для шорта); при касании стратегия закрывает позицию по рынку.
- **Тейк-профит** — цель располагается на расстоянии `TakeProfitPoints` поинтов. Срабатывание проверяется по экстремумам свечи,
  что соответствует поведению MT4 при исполнении тейка внутри бара.
- **Трейлинг-стоп** — после прохождения ценой более `TrailingStopPoints` поинтов в прибыльную сторону активируется трейлинг.
  Для покупок стоп переносится на `referencePrice - trailingDistance`, где `referencePrice` — максимум между закрытием и максимумом
  свечи. Для продаж применяется формула `referencePrice + trailingDistance` с минимумом между закрытием и минимумом свечи.
  Таким образом воссоздаётся логика `OrderModify` из исходного советника.

## Параметры
| Название | Описание | Значение по умолчанию | Примечания |
| --- | --- | --- | --- |
| `BullBearPeriod` | Период усреднения индикаторов Bulls/Bears Power. | `5` | Увеличение сглаживает моментум-фильтр. |
| `Volume` | Запрашиваемый объём сделки. | `1` | Фактический объём определяется шагом и лимитами инструмента. |
| `StopLossPoints` | Дистанция начального стоп-лосса в поинтах. | `45` | `0` отключает защитный стоп. |
| `TakeProfitPoints` | Дистанция тейк-профита в поинтах. | `150` | `0` — торговля без фиксированного тейка. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа. | `15` | `0` отключает трейлинг. |
| `CandleType` | Тип свечей для расчётов. | `таймфрейм 5 минут` | Можно выбрать любой другой `DataType`. |

## Особенности реализации
- Все уровни управления позицией (стоп, тейк, трейлинг) хранятся внутри стратегии. Закрытие выполняется рыночными заявками,
  когда свечи подтверждают пробой уровня — аналогично поведению MT4.
- Подписка на индикаторы оформлена через `Subscription.Bind`, поэтому оба индикатора обрабатываются в одном колбэке.
- Размер поинта вычисляется из `Security.PriceStep`, что делает параметры совместимыми с инструментами, котирующимися в тиках,
  пунктах или копейках.
- Для исключения ложных входов стратегия использует только значения индикаторов с предыдущей свечи.

## Отличия от версии MQL
- Вместо модификации стоп-заявок используются явные рыночные выходы — это надёжнее для разных коннекторов StockSharp при
  сохранении логики результата.
- Параметры проверяются через `StrategyParam`, что предотвращает ввод некорректных значений (например, отрицательных расстояний).
- Для визуализации и подписок используются средства высокоуровневого API StockSharp, нет ручного перебора тиков.
- Строка-идентификатор советника, применявшаяся в MT4, здесь не нужна и опущена.
