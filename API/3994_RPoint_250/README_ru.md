# Стратегия RPoint 250 Reversal
[English](README.md) | [中文](README_cn.md)

**RPoint 250 Reversal** — портирование эксперта MetaTrader 4 `e_RPoint_250` на платформу StockSharp. В оригинале советник
использует пользовательский индикатор *RPoint*, который отмечает последние экстремумы цены. В StockSharp такого индикатора нет,
поэтому стратегия имитирует его работу связкой стандартных индикаторов `Highest` и `Lowest`. Как только появляется новый максимум
или минимум, система моментально переворачивает позицию и заново выставляет стоп-лосс, тейк-профит и трейлинг, как в версии MQL.

## Логика работы

1. Подписываемся на свечи с типом `CandleType` (по умолчанию пятиминутные).
2. Рассчитываем скользящий максимум и минимум за последние `ReversePoint` баров — это аналог уровней RPoint.
3. Если формируется новый максимум, закрываем все покупки и открываем продажу объёмом `OrderVolume`.
4. Если формируется новый минимум, закрываем все продажи и открываем покупку объёмом `OrderVolume`.
5. Защита позиции выполняется через `StartProtection`: расстояния `StopLossPoints` и `TakeProfitPoints` задаются в пунктах цены.
6. При ненулевом `TrailingStopPoints` прибыль фиксируется трейлингом — позиция закрывается, когда цена откатывает на указанное
   число пунктов от лучшего значения после входа.
7. Запоминаем время свечи с последним входом и не открываем новые сделки в ту же свечу. Это полностью повторяет защиту `TimeN`
   в исходном коде.

Стратегия поддерживает только одну позицию: перед входом в противоположную сторону текущая сделка всегда закрывается.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `OrderVolume` | `decimal` | `0.1` | Объём рыночных заявок, аналог параметра `Lots` в MetaTrader. |
| `TakeProfitPoints` | `decimal` | `15` | Размер тейк-профита в пунктах. Ноль отключает фиксацию прибыли. |
| `StopLossPoints` | `decimal` | `999` | Размер стоп-лосса в пунктах. Ноль позволяет торговать без фиксированного стопа. |
| `TrailingStopPoints` | `decimal` | `0` | Ширина трейлинга в пунктах. При нуле трейлинг не используется. |
| `ReversePoint` | `int` | `250` | Количество свечей для поиска последнего экстремума. Большие значения уменьшают шум. |
| `CandleType` | `DataType` | `TimeSpan.FromMinutes(5).TimeFrame()` | Тип свечей для анализа. Подберите под таймфрейм в MetaTrader. |

## Особенности реализации

- `Highest` и `Lowest` подключены через высокоуровневый метод `Bind`, поэтому дополнительные буферы не нужны.
- `StartProtection` переводит параметры стопа и тейка в абсолютные цены, и StockSharp сам сопровождает позицию.
- Трейлинг реализован на закрытых свечах: если цена откатывает на заданное количество пунктов от максимальной прибыли, позиция
  закрывается маркет-ордером.
- Переменные `_executedHighLevel` и `_executedLowLevel` хранят уровень последнего срабатывания, чтобы не дублировать сделки.
  Это прямой аналог `Reverse_High` и `Reverse_Low` из MQL.
- Поле `_lastSignalTime` повторяет переменную `TimeN` и блокирует повторный вход в пределах одной свечи.

## Рекомендации по использованию

1. Запустите стратегию в портфеле, где доступен нужный инструмент и тип свечей.
2. Настройте `OrderVolume` под торговые ограничения брокера и собственное управление капиталом.
3. Подберите `ReversePoint` под волатильность инструмента: большой горизонт сглаживает шум, но реагирует медленнее.
4. Убедитесь, что значения `StopLossPoints`, `TakeProfitPoints` и `TrailingStopPoints` совместимы с `PriceStep` инструмента.
5. Перед реальной торговлей выполните тест в StockSharp Designer или Backtester и убедитесь, что поведение соответствует ожиданиям.
6. Контролируйте журналы стратегии — они помогут отследить перевороты и сравнить их с оригинальным экспертом.

Поскольку индикатор RPoint заменён стандартными компонентами, возможны незначительные расхождения с MetaTrader при разных
источниках данных или правилах округления. Всегда проверяйте стратегию на собственных котировках до запуска в продакшне.
