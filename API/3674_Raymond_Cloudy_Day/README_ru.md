# Стратегия Raymond Cloudy Day

## Общее описание
Raymond Cloudy Day — стратегия пробойного возобновления, полностью повторяющая логику исходного эксперта **"Raymond Cloudy Day for EA"** на MQL5. Алгоритм получает набор опорных уровней с более старшего таймфрейма и использует их для поиска импульсных входов на рабочем таймфрейме. Перенос на StockSharp сохраняет оригинальные правила и одновременно делает каждый компонент настраиваемым через параметры стратегии.

## Источники данных
- **Свечи сигналов** — таймфрейм, на котором исполняются сделки. Подписка на этот поток используется для генерации входов и сопровождения позиции.
- **Свечи расчёта уровней** — более старший таймфрейм, из которого вычисляются уровни Raymond. По умолчанию это дневная свеча, аналог параметра `RayMondTimeframe` в MQL5.

Обе подписки регистрируются автоматически в `GetWorkingSecurities`, поэтому необходимые серии данных запрашиваются сразу после запуска стратегии.

## Вычисление уровней Raymond
Для каждой закрытой свечи старшего таймфрейма стратегия пересчитывает четыре ключевых уровня:

\[
\begin{aligned}
TradeSS &= \frac{High + Low + Open + Close}{4} \\
PivotRange &= High - Low \\
ETB &= TradeSS + 0.382 \times PivotRange \\
ETS &= TradeSS - 0.382 \times PivotRange \\
TPB1 &= TradeSS + 0.618 \times PivotRange \\
TPS1 &= TradeSS - 0.618 \times PivotRange \\
TPB2 &= TradeSS + PivotRange \\
TPS2 &= TradeSS - PivotRange
\end{aligned}
\]

Актуальные значения сохраняются в полях стратегии и выводятся в лог после каждого обновления, что позволяет отслеживать динамику уровней во времени.

## Логика входа
После получения уровней стратегия анализирует каждую закрытую свечу рабочего таймфрейма:

1. **Покупка** — если минимум свечи опускается ниже `TPS1`, а закрытие возвращается выше уровня, открывается длинная позиция. Это прямое соответствие условию EA `Low[1] < TPS1 && Close[1] > TPS1`, фиксирующему отскок вверх.
2. **Продажа** — если свеча остаётся полностью выше `TPS1`, но закрывается ниже уровня, открывается короткая позиция (асимметричное правило, присутствующее в оригинале).

Перед выставлением нового ордера стратегия отменяет активные заявки и, при необходимости, закрывает позицию противоположного направления, чтобы в рынке находилась только одна сделка.

## Управление риском
Raymond Cloudy Day использует симметричные защитные смещения, измеряемые в тиках:

- **Стоп-лосс** — отстоит от цены входа на `ProtectiveOffsetTicks` ниже для лонга и выше для шорта.
- **Тейк-профит** — располагается на таком же расстоянии, но в прибыльную сторону.

Смещение умножается на `PriceStep` инструмента для преобразования тиков в абсолютное изменение цены. Каждая завершённая свеча сигналов проверяет достижение защитных уровней и закрывает позицию при срабатывании стопа или тейка. При отсутствии позиции внутренние переменные защиты сбрасываются, исключая использование устаревших значений.

## Параметры
| Параметр | Описание | Значение по умолчанию | Примечания |
|----------|----------|------------------------|------------|
| `TradeVolume` | Объём ордера для каждого входа. | `1` | При запуске копируется в свойство `Volume`. |
| `ProtectiveOffsetTicks` | Расстояние в тиках для стоп-лосса и тейк-профита. | `500` | Конвертируется в цену через `PriceStep`. |
| `SignalCandleType` | Таймфрейм, формирующий торговые сигналы. | Свеча 1 часа | Можно выбрать любой тип свечей (`DataType`). |
| `PivotCandleType` | Старший таймфрейм для расчёта уровней. | Свеча 1 дня | Соответствует параметру `RayMondTimeframe` в MQL EA. |

Все параметры снабжены диапазонами оптимизации и описаниями для конструктора StockSharp.

## Дополнительные замечания
- Для корректной работы необходим заданный `PriceStep`. При его отсутствии стратегия пропускает вход и записывает предупреждение в лог.
- На график выводятся свечи рабочего таймфрейма и совершённые сделки. При желании можно добавить собственную визуализацию уровней.
- Реализация обрабатывает только закрытые свечи и не опрашивает индикаторы напрямую, что соответствует требованиям `AGENTS.md`.

## Что сохранено из оригинального эксперта
- Формулы уровней Raymond и коэффициенты (`0.382`, `0.618`, `1.0`).
- Условия входа вокруг первого тейк-профита на продажу (`TPS1`).
- Симметричные стоп-лосс и тейк-профит в 500 пунктов, перенесённые в тиковый формат StockSharp.

Таким образом, стратегия в StockSharp повторяет поведение исходного робота и одновременно предоставляет расширенные возможности конфигурации и журналирования для дальнейшего исследования.

