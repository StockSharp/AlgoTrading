# Стратегия Multi Strategy Combo

## Общее описание
**Multi Strategy Combo Strategy** — порт на C# оригинального советника MetaTrader 4 «Multi-Strategy iFSF». Стратегия объединяет сигналы индикаторов MA, RSI, MACD, Stochastic и Parabolic SAR, а также дополняет их фильтрами тренда, диапазона по Боллинджеру и шумовым фильтром. В StockSharp логика реализована через высокоуровневые подписки `SubscribeCandles().Bind(...)`, что исключает ручную работу с буферами индикаторов. Сделки совершаются только тогда, когда все задействованные индикаторы единогласно подают сигнал BUY или SELL, после чего применяются дополнительные фильтры-комбинации.

## Основная логика
* **Консенсус индикаторов** — каждый включённый модуль (MA, RSI, MACD, Stochastic, SAR) отдаёт дискретный сигнал. Совпадение всех сигналов вверх/вниз формирует общий тренд.
* **Фактор комбинации (1–3)** — соответствует параметру `Combo_Trader_Factor` из EA и определяет, как совмещаются консенсус, ADX и фильтр Боллинджера:
  * *Фактор 1* ориентирован на тренд. В фазе боковика при включённом фильтре используются развороты от полос Боллинджера.
  * *Фактор 2* предъявляет жёсткие требования — тренд и диапазонный фильтр должны подтверждать консенсус.
  * *Фактор 3* — самый строгий вариант, требующий одновременного совпадения всех активных модулей.
* **Трендовый фильтр** — ADX на выбранном таймфрейме определяет состояния «тренд вверх/вниз» или «диапазон вверх/вниз».
* **Фильтр Боллинджера** — две полосы (2σ и 3σ). Покупка требует отскока от нижней полосы и подтверждения RSI перепроданностью. Продажа зеркальна.
* **Шумовой фильтр** — ATR-аналог Damiani Volatmeter. Если волатильность ниже порога, новые сделки блокируются.
* **Автозакрытие** — при включении позиция закрывается сразу, как только консенсус изменился на противоположный.

## Сигналы индикаторов
* **Скользящие средние** — три скользящие (настроенные тип и период). Режимы 1–5 повторяют оригинальные варианты пересечений.
* **RSI** — четыре режима: перекупленность/перепроданность, направленность, комбинированный и «зональный» режим.
* **MACD** — четыре режима: оценка наклона, пересечение гистограммы ниже/выше нуля, комбинированная логика и пересечение сигнальной линии через ноль.
* **Стохастик** — обычное пересечение %K и %D либо пересечение с проверкой порогов High/Low.
* **Parabolic SAR** — дополнительный голос, поддерживающий «запоминание» последнего сигнала, чтобы избежать повторных входов в одном тренде.

## Управление рисками
* Параметры `StopLossOffset` и `TakeProfitOffset` задают абсолютное расстояние для стопа и цели.
* Метод `StartProtection` обеспечивает трейлинг-стоп (при включённом `UseTrailingStop`).
* Управление объёмом и повторная отправка заявок полностью переданы инфраструктуре StockSharp.

## Основные параметры
* **Общие** — `ComboFactor`, `CandleType`.
* **MA** — `UseMa`, `MaMode`, длины/типы трёх скользящих, таймфрейм, флаг «запоминать сигнал».
* **RSI** — `UseRsi`, `RsiMode`, `RsiPeriod`, уровни перекупленности/перепроданности, границы зоны, флаг «запоминать».
* **MACD** — `UseMacd`, `MacdMode`, длины быстрых/медленных EMA и сигнальной линии, таймфрейм, флаг «запоминать».
* **Стохастик** — `UseStochastic`, длины сглаживания, пороги, таймфрейм.
* **Parabolic SAR** — `UseSar`, `SarStep`, `SarMax`, таймфрейм.
* **Фильтр тренда** — `UseTrendDetection`, `AdxPeriod`, `AdxLevel`, таймфрейм.
* **Фильтр Боллинджера** — `UseBollingerFilter`, `BollingerPeriod`, отклонения 2σ/3σ, глубина истории RSI.
* **Шумовой фильтр** — `UseNoiseFilter`, `NoiseAtrLength`, `NoiseThreshold`, таймфрейм.
* **Автозакрытие и риск** — `UseAutoClose`, `AllowOppositeAfterClose`, `StopLossOffset`, `TakeProfitOffset`, `UseTrailingStop`.

Каждый параметр оформлен через `StrategyParam<T>`, что упрощает оптимизацию и валидацию.

## Отличия от MT4-версии
* Используются только стандартные индикаторы StockSharp. Выбор между ZeroLag MACD и классическим вариантом заменён на встроенную реализацию MACD.
* Скользящие и осцилляторы работают по цене закрытия свечи. MT4-параметры выбора цены и сдвигов (`FastMa_Price`, `FastMa_Shift` и т.п.) не поддерживаются.
* Damiani Volatmeter заменён на фильтр ATR с регулируемым порогом `NoiseThreshold`.
* Ручное управление ордерами отсутствует: заявки отправляются методами `BuyMarket`/`SellMarket`, а защита реализована через `StartProtection`.
* Панель комментариев и графические объекты MT4 не переносятся. Для диагностики используйте `LogInfo`.

## Как использовать
1. Добавьте класс `MultiStrategyComboStrategy` в свой проект StockSharp и соберите решение.
2. Настройте `Security`, `Portfolio`, `Volume` и при необходимости таймфреймы для отдельных индикаторов.
3. Подкорректируйте пороги стопа/тейка и включите трейлинг при необходимости.
4. Запустите стратегию. Сделки будут открываться по закрытию свечей, когда все включённые модули согласятся между собой согласно выбранному фактору комбинации.

## Заметки по конверсии
* Логика построена только на высокоуровневых подписках — никаких ручных буферов и прямых вызовов `GetValue()`.
* В коде используются табы, как требует репозиторий.
* Встроенные комментарии на английском языке помогают сопоставить элементы MT4 и StockSharp.
