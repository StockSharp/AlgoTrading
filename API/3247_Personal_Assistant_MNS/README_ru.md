# Стратегия Personal Assistant MNS
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советника MetaTrader `personal_assistant_codeBase_MNS` в экосистему StockSharp. Она предназначена как «персональный помощник»: не генерирует автоматические сигналы, а предоставляет методы для ручного управления сделками (открытие/закрытие позиций, изменение объёма, фиксация прибыли). Кроме того, на каждой завершённой свече в лог выводится расширенная статистика по инструменту и активным ордерам.

## Логика работы

1. Подписываемся на свечи типа `CandleType` (по умолчанию 1 минута).
2. При закрытии каждой свечи выводим в лог: позицию, текущую плавающую прибыль/убыток, число активных стоп- и тейк-ордеров, спред, стоимость тика и настроенный magic number.
3. Методы `PressBuy()` и `PressSell()` отправляют рыночные заявки с актуальным объёмом. Если заданы `TakeProfitPips` и/или `StopLossPips`, уровни пересчитываются из пунктов в абсолютные цены и сохраняются во внутренних переменных.
4. Защитные уровни эмулируются на основе свечных максимумов/минимумов: при достижении цены стратегия закрывает позицию рыночной заявкой.
5. При включённом флаге `UseTrailingStop` реализуется логика перевода в безубыток из оригинальной функции `MOVETOBREAKEVEN()`: после достижения прибыли в `BreakEvenTriggerPips` стоп переносится к цене входа плюс `BreakEvenOffsetPips`.

## Возможности

- Полное покрытие «клавиш» 1–8 оригинального помощника через методы:
  - `PressBuy()` / `PressSell()` — открытие длинной/короткой позиции с опциональными защитными уровнями.
  - `PressCloseAll()` — закрытие всех позиций.
  - `IncreaseVolume()` / `DecreaseVolume()` — шаговое изменение объёма на 0.01 лота.
  - `CloseLongPositions()` / `CloseShortPositions()` — закрытие только длинной или только короткой стороны.
  - `CloseProfitablePositions()` — закрытие при положительной плавающей прибыли.
- При включённом `DisplayLegend` печатается подробная памятка по доступным действиям.
- Пересчёт пунктов в цены с учётом `PriceStep`, `StepPrice` и `Decimals` инструмента.
- Поддержка перевода позиции в безубыток для обеих сторон рынка.
- Независимое хранение стоп/тейк уровней для длинных и коротких сделок: смена направления автоматически очищает устаревшие значения.

## Параметры

| Параметр | Описание |
|----------|----------|
| `MagicNumber` | Информационный идентификатор, аналог входного параметра `MagicNo`. |
| `DisplayLegend` | Выводить ли памятку и расширенные логи при закрытии свечи. |
| `OrderVolume` | Базовый торговый объём, используемый всеми ручными действиями. |
| `Slippage` | Допустимое проскальзывание в тиках (для информации). |
| `TakeProfitPips` | Расстояние до тейк-профита в пунктах (0 — отключить). |
| `StopLossPips` | Расстояние до стоп-лосса в пунктах (0 — отключить). |
| `UseTrailingStop` | Включить перевод в безубыток. |
| `BreakEvenTriggerPips` | Прибыль в пунктах, необходимая для активации безубытка. |
| `BreakEvenOffsetPips` | Смещение стопа от цены входа после активации безубытка. |
| `CandleType` | Тип свечей для мониторинга и эмуляции защитных уровней. |

## Практические рекомендации

- Используйте методы помощника в Designer, пользовательских скриптах или UI-кнопках, чтобы имитировать горячие клавиши MetaTrader.
- Для корректной работы защитных уровней инструмент должен предоставлять `PriceStep`, `StepPrice` и точность (`Decimals`). Если данных нет, уменьшите параметры в пунктах или отключите защиту, установив значения в `0`.
- Поскольку стопы и тейки эмулируются по свечам, короткие внутридневные всплески могут остаться незамеченными. При необходимости увеличьте частоту свечей.
- Метод `CloseProfitablePositions()` реализует логику кнопки 8: позиция закрывается только при строго положительном `PnL`.

## Отличия от версии для MetaTrader

- Вместо объектов на графике используются записи в журнале, поскольку стратегии StockSharp не поддерживают аналогичное рисование.
- Стоп- и тейк-уровни исполняются рыночными заявками при срабатывании условий, а не выставляются как отложенные ордера.
- Перенос в безубыток осуществляется через рыночные заявки, существующие защитные ордера не модифицируются.
- Параметр `Slippage` носит справочный характер: фактическое исполнение контролируется коннектором StockSharp.
