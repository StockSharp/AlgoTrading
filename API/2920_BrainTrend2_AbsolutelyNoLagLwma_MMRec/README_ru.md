# Стратегия BrainTrend2 + AbsolutelyNoLagLWMA MMRec

## Обзор
Стратегия воспроизводит советник MetaTrader `Exp_BrainTrend2_AbsolutelyNoLagLwma_MMRec`, объединяя два блока сигналов: трендовый блок BrainTrend2 и адаптивный фильтр AbsolutelyNoLagLWMA. Каждый блок может открывать и закрывать позиции в соответствии со своими разрешениями, как в MMRec-шаблоне оригинала. Заявки исполняются рыночными ордерами через высокоуровневый API StockSharp с настраиваемым объёмом.

## Логика торговли
### Блок BrainTrend2
* Формирует плавающий уровень на основе взвешенного истинного диапазона (ATR).
* Направление («river») меняется, когда свеча пробивает буфер более чем на `0.7 * ATR`.
* Бычья свеча внутри восходящего режима открывает лонг (если разрешено) и закрывает шорт.
* Медвежья свеча внутри нисходящего режима открывает шорт (если разрешено) и закрывает лонг.
* Параметр `Brain Signal Shift` позволяет сдвигать анализируемую свечу назад на несколько баров.

### Блок AbsolutelyNoLagLWMA
* Применяет два последовательных линейно взвешенных скользящих средних к выбранному источнику цены.
* Цвет линии становится **2** при росте двойной LWMA, **0** при снижении и **1** при нейтральном состоянии.
* Переход к цвету 2 даёт сигнал на покупку и (опционально) закрытие шортов; переход к цвету 0 даёт сигнал на продажу и (опционально) закрытие лонгов.
* Сдвиг сигналов регулируется параметром `Abs Signal Shift`.

### Управление позицией
* Стратегия ведёт одну нетто-позицию. Если оба блока подают сигнал одновременно, команды на закрытие исполняются до новых входов.
* Если блок пытается открыть позицию, а противоположная уже активна и её закрытие запрещено, вход пропускается (аналогично невозможности хеджирования при единой нетто-позиции).

## Параметры
| Группа | Название | Описание |
| --- | --- | --- |
| BrainTrend2 | Brain Candle | Тип свечей для расчёта BrainTrend2. |
| BrainTrend2 | Brain ATR | Период ATR для внутренней логики BrainTrend2. |
| BrainTrend2 | Brain Signal Shift | Сдвиг сигналов BrainTrend2 по истории. |
| BrainTrend2 | Brain Buy / Sell | Разрешение на открытие лонгов/шортов блоком BrainTrend2. |
| BrainTrend2 | Brain Close Buys / Close Sells | Разрешение блоку BrainTrend2 закрывать существующие позиции. |
| AbsolutelyNoLag | Abs Candle | Тип свечей для фильтра LWMA. |
| AbsolutelyNoLag | Abs Length | Период LWMA. |
| AbsolutelyNoLag | Abs Price | Источник цены (аналог перечисления `Applied_price_` в MQL). |
| AbsolutelyNoLag | Abs Signal Shift | Сдвиг сигналов LWMA по истории. |
| AbsolutelyNoLag | Abs Buy / Sell | Разрешение на открытие лонгов/шортов блоком LWMA. |
| AbsolutelyNoLag | Abs Close Buys / Close Sells | Разрешение LWMA закрывать позиции. |
| AbsolutelyNoLag | Abs Shift | Постоянный сдвиг значения LWMA. |
| General | Order Volume | Базовый объём рыночных ордеров. |

## Примечания
* Формулы ATR и LWMA перенесены из MQL-версии, включая треугольное взвешивание и полный список источников цены.
* В свечах StockSharp нет данных о спреде, поэтому истинный диапазон рассчитывается только по ценам, что эквивалентно нулевому спреду.
* Одновременные позиции с разными magic-номерами сведены к одной нетто-позиции, что соответствует модели портфеля в StockSharp.
