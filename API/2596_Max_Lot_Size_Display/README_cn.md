# 最大可开仓量显示策略

## 概述
该策略是 MetaTrader 5 指标 **EXP_MAX_LOT** 的 StockSharp 版本。原始脚本用于展示在当前可用保证金下可以开出的最大仓位规模。移植后的策略保持相同目标：持续估算在指定方向上、在不超出可用资金的情况下能够提交的最大订单量。

与传统交易系统不同，本策略不会发送订单，而是作为风险管理辅助工具。在所选周期的每根收盘 K 线上更新结果。计算值写入日志，并同步到 `Volume` 属性，方便其他自动化模块使用。

## 参数
- **Trade Direction**：需要评估最大仓位的方向（`Buy` 或 `Sell`），对应原始脚本中的 `PosType` 输入。
- **Risk Fraction**：在计算前作用于自由资金的倍数，等价于 MQL 版本的 `Money_Management` 参数。`1.0` 表示使用全部可用保证金，较小数值用于预留资金。
- **Label Prefix**：添加到日志信息前的文本前缀，延续指标标签的命名风格（`MAX_LOT_Label_`）。
- **Candle Type**：触发重新计算的 K 线数据源。原脚本在每个 tick 更新，这里按照高层 API 规范，在所选类型的 K 线收盘后刷新。

## 计算流程
1. 订阅 **Candle Type** 指定的 K 线并等待其收盘。
2. 每次更新时：
   - 获取组合的权益（优先使用当前价值，缺失时退回到初始价值）。
   - 将权益乘以 **Risk Fraction** 得到可分配资金。
   - 计算选定方向的单位保证金。如果交易所提供了 `MarginBuy`/`MarginSell` 数据则直接使用，否则根据最新收盘价与证券的 `VolumeStep` 进行估算。
   - 将原始结果调整为交易所允许的成交量：对齐 `VolumeStep`，并遵守 `MinVolume`/`MaxVolume` 限制。
3. 将最终数值写入 `Volume`，同时输出日志；若资金不足，则记录警告信息。

该逻辑对应 `.mq5` 源码中的 `LotCount`、`LotCorrect`、`LotFreeMarginCorrect` 与 `GetLotForOpeningPos` 函数，只是改为使用 StockSharp 提供的实体属性。

## 实现说明
- 仅处理收盘 K 线，符合高层策略接口的约定。
- 代码缩进使用制表符，注释保持英文，与仓库规则一致。
- 当既没有保证金数据也没有价格时，返回零并发出警告。
- 在启动阶段调用一次 `StartProtection()`，沿用示例项目中的保护性模板。

## 使用方式
将策略附加到目标合约，按照自身风险偏好设置参数。日志中会出现类似下述信息：

```
MAX_LOT_Label_: Maximum volume for Buy = 2.5
```

该值也可以通过策略的 `Volume` 属性读取，用于其他模块的自动化仓位控制。
