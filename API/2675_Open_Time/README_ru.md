# Стратегия Open Time

## Общее описание
Стратегия Open Time — это порт советника MetaTrader 5 *OpenTime*, построенного на временном расписании. Она отслеживает биржевое время по завершённым свечам и открывает сделки только внутри заданного окна. Дополнительно предусмотрено отдельное окно принудительного закрытия, опциональный трейлинг-стоп и базовые уровни стоп-лосса/тейк-профита, задаваемые в пунктах.

В StockSharp стратегия работает с нетто-позицией. Поэтому если новый сигнал противоречит текущему направлению, сначала закрывается противоположная позиция, а затем открывается новая сделка с указанным объёмом.

## Логика работы
1. **Окно закрытия** — при включённом параметре *Use Close Window* любая активная позиция закрывается, если текущее время попадает внутрь окна закрытия. До окончания окна новые сделки не инициируются.
2. **Обновление трейлинг-стопа** — когда движение цены в сторону позиции превышает `TrailingStop + TrailingStep` пунктов, стоп подтягивается на расстояние `TrailingStop`. Это повторяет оригинальный алгоритм MT5, где стоп переносится только после минимального дополнительного смещения.
3. **Проверка рисков** — на каждой закрытой свече проверяются уровни стоп-лосса и тейк-профита. При срабатывании любого из уровней позиция закрывается, внутренние переменные очищаются.
4. **Окно открытия** — если текущий момент попадает в окно открытия, стратегия анализирует доступные направления:
   - При разрешённых покупках и отсутствии длинной позиции (или наличии короткой) отправляется рыночная покупка на заданный объём. Если ранее была открыта короткая позиция, дополнительно покупается объём для её покрытия.
   - При разрешённых продажах и отсутствии короткой позиции (или наличии длинной) отправляется рыночная продажа на заданный объём с учётом закрытия текущей длинной позиции.

В момент входа запоминаются цена сделки, а также уровни стопа и цели (если заданы). Эти значения используются трейлингом и блоком управления рисками.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| Candle Type | Свечи 1 минута | Тип данных, по которым определяется время; логика выполняется только на закрытых свечах. |
| Use Close Window | true | Включает окно принудительного закрытия. |
| Close Hour / Close Minute | 20:50 | Начало окна закрытия. Час может принимать значения 0–24 (24 соответствует полуночи следующего дня). |
| Enable Trailing | false | Активирует логику трейлинг-стопа. |
| Trailing Stop | 30 пунктов | Расстояние между ценой и трейлинг-стопом. Пересчитывается в цену исходя из минимального шага котировки. |
| Trailing Step | 3 пункта | Минимальное дополнительное движение, после которого трейлинг переносится. |
| Trade Hour / Trade Minute | 18:50 | Начало окна для открытия позиций. |
| Duration | 300 секунд | Длительность окна открытия и закрытия. |
| Enable Sell / Enable Buy | Sell = true, Buy = false | Разрешённые направления торговли. |
| Volume | 0.1 | Объём заявки. При развороте добавляется объём для закрытия противоположной позиции. |
| Stop Loss | 0 пунктов | Начальный стоп-лосс. Нуль отключает фиксированный стоп и оставляет управление выходом трейлингу или окну закрытия. |
| Take Profit | 0 пунктов | Начальный тейк-профит. Нуль отключает фиксированную цель. |

## Реализация
- Пересчёт пунктов выполняется через `Security.PriceStep`. Для инструментов с тремя или пятью знаками после запятой шаг умножается на десять, что соответствует логике MT5.
- Для проверки стопов и целей используются экстремумы свечи (`HighPrice` и `LowPrice`), что позволяет приблизить реакцию к тиковому режиму, оставаясь на высокоуровневом API.
- После закрытия позиции внутреннее состояние очищается, чтобы последующие сделки получали актуальные параметры.
- Из-за неттингового режима StockSharp одновременные длинные и короткие позиции недоступны. При смене направления стратегия сначала закрывает текущую позицию и лишь затем открывает новую.

## Рекомендации
- Выбирайте таймфрейм свечей, соответствующий требуемой точности по времени. Для большинства сценариев достаточно 1-минутных свечей.
- Окна открытия и закрытия используют общую длительность. Чтобы отключить одно из окон, установите длительность в ноль или выключите параметр *Use Close Window*.
- Трейлинг-стоп активируется только после того, как цена пройдёт минимум `Trailing Stop + Trailing Step` пунктов от цены входа, полностью повторяя алгоритм оригинальной версии.
