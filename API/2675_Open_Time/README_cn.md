# 开盘时间策略

## 概述
开盘时间策略是基于时间计划的交易系统，移植自 MetaTrader 5 专家顾问 *OpenTime*。策略在每根完成的K线后检查市场时间，只在可配置的开仓时间窗口内下单。它可以在单独的平仓时间窗口中关闭已有仓位，支持可选的移动止损，并按照点数执行初始止损和止盈。

与原始 MT5 对冲版本不同，本移植在净持仓账户上运行：如果新的信号与当前持仓方向相反，策略会先平掉相反方向，再用设定的手数开入目标方向。

## 交易流程
1. **平仓窗口** – 勾选“使用平仓窗口”后，只要当前时间落在平仓窗口内，策略立即关闭所有持仓，在该时间段内不会产生新的交易。
2. **移动止损更新** – 如果启用移动止损且价格相对于持仓方向至少前进了 `TrailingStop + TrailingStep` 个点，则将止损价向价格靠近 `TrailingStop` 个点，复现 MT5 中仅在达到最小步长后才移动止损的逻辑。
3. **风险检查** – 在每根收盘K线上检查是否触及止损或止盈阈值。一旦触发，对应方向的仓位立即平掉，并清空内部状态。
4. **开仓窗口** – 当前时间位于开仓窗口内时评估入场条件：
   - 若允许做多且当前净头寸为空或为空头，买入设定的手数，并补齐所有空头以实现反手。
   - 若允许做空且当前净头寸为空或为多头，卖出设定手数，并补齐所有多头以实现反手。

每次入场都会记录成交价以及止损、止盈距离（当它们非零时），这些值随后用于移动止损和风险管理判定。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| Candle Type | 1 分钟K线 | 用于时间追踪的数据类型，仅在K线收盘时执行逻辑。|
| Use Close Window | true | 是否启用自动平仓窗口。|
| Close Hour / Close Minute | 20:50 | 平仓窗口起始时间，小时支持 0–24，24 表示次日 0 点。|
| Enable Trailing | false | 是否启用移动止损。|
| Trailing Stop | 30 点 | 移动止损与价格之间的距离，会根据合约最小报价单位转换为价格。|
| Trailing Step | 3 点 | 再次移动止损前价格需要额外运行的点数。|
| Trade Hour / Trade Minute | 18:50 | 允许开仓的时间窗口起始。|
| Duration | 300 秒 | 开仓和平仓窗口共用的持续时间。|
| Enable Sell / Enable Buy | Sell = true, Buy = false | 允许交易的方向。|
| Volume | 0.1 | 每次新开仓的手数。反手时会自动加上对冲原仓位所需的数量。|
| Stop Loss | 0 点 | 初始止损距离，0 表示禁用固定止损，只依赖移动止损或时间窗口。|
| Take Profit | 0 点 | 初始止盈距离，0 表示禁用固定止盈。|

## 实现细节
- 根据 `Security.PriceStep` 计算点值，对于三位或五位小数报价的品种会额外乘以 10，以复现 MT5 中的“点”换算。
- 移动止损与固定止损/止盈均使用 K 线最高价与最低价判断，借此在高阶API中模拟逐笔触发效果。
- 每次平仓后都会重置内部记录，避免在下一笔交易中沿用旧的止损、止盈或入场价格。
- StockSharp 默认采用净持仓模型，因此无法同时持有多空仓。反手时会先平掉相反头寸，再开入目标方向，以模拟 MT5 的对冲效果。

## 使用提示
- 选择与时间控制粒度匹配的K线类型，1分钟K线能提供更精确的时间判定。
- 开仓和平仓窗口共用同一个持续时间参数。如需关闭其中某个窗口，可将持续时间设为0或关闭“使用平仓窗口”。
- 移动止损只有在价格相对于入场价至少走出 `Trailing Stop + Trailing Step` 点后才会开始移动，与原策略的逻辑保持一致。
