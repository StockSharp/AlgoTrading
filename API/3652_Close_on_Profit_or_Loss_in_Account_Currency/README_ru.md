# Закрытие по прибыли или убытку в валюте счёта

Стратегия повторяет советник MetaTrader *Close_on_PROFIT_or_LOSS_inAccont_Currency*. Она отслеживает текущую стоимость подключённого портфеля и, как только equity достигает заданной цели по прибыли или опускается до ограничителя по просадке, отменяет все отложенные заявки и полностью закрывает позиции. Для реализации используется высокоуровневый API StockSharp: подписка на свечи служит «пульсом», `CancelActiveOrders()` удаляет активные заявки, а `ClosePosition()` отправляет рыночные ордера на закрытие.

## Алгоритм работы

1. После закрытия каждой контрольной свечи считывается значение `Portfolio.CurrentValue`.
2. Если equity больше либо равно параметру **Positive Closure**, выполняется процедура полного выхода.
3. Если equity меньше либо равно **Negative Closure**, запускается та же процедура для ограничения убытков.
4. При закрытии стратегия отменяет отложенные заявки, выставляет рыночные ордера противоположного направления и завершает работу (аналог `ExpertRemove()` в оригинале).

> **Важно:** пороговые значения задаются в валюте счёта. Чтобы избежать мгновенного срабатывания при запуске, установите **Positive Closure** выше текущего equity, а **Negative Closure** — ниже.

## Параметры

| Имя | Описание | Значение по умолчанию |
|-----|----------|-----------------------|
| `PositiveClosureInAccountCurrency` | Уровень equity, при превышении которого закрываются все позиции. | `0` |
| `NegativeClosureInAccountCurrency` | Нижний предел equity, при достижении которого позиции ликвидируются. | `0` |
| `CandleType` | Таймфрейм «сердцебиения», на закрытии которого проверяется equity. Для более быстрой реакции выберите меньший интервал. | `1 минута` |

## Примечания

- При запуске вызывается `StartProtection()`, повторяя защитный механизм оригинала.
- Стратегия работает только с позициями и заявками, которые ведёт сама. Подключайте её к тому портфелю, который нужно защищать.
- Отдельный параметр спрэда/проскальзывания не требуется: рыночные заявки StockSharp учитывают специфику коннектора.
