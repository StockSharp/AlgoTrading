# Стратегия GreenTrade

## Обзор
GreenTrade — это конвертация оригинального советника MQL5. Стратегия ищет среднесрочные тренды, совмещая фильтр наклона сглаженной скользящей средней (SMMA) и подтверждение импульса через индекс относительной силы (RSI). Сигналы рассчитываются только на закрытых свечах выбранного таймфрейма. Стратегия умеет наращивать позицию ступенями до заданного лимита и использует фиксированные уровни риска вместе со ступенчатым трейлинг-стопом.

## Логика торговли
1. **Подготовка индикаторов**
   - SMMA вычисляется по медианной цене `((High + Low) / 2)` с периодом `MaPeriod`.
   - RSI строится по цене закрытия с окном `RsiPeriod`.
2. **Фильтр формы тренда**
   - Анализируются четыре значения SMMA в прошлом, определяемые параметрами сдвигов (`ShiftBar`, `ShiftBar1`, `ShiftBar2`, `ShiftBar3`).
   - Для восходящего тренда требуется выполнение цепочки `SMMA(shift0) > SMMA(shift1) > SMMA(shift2) > SMMA(shift3)`.
   - Для нисходящего тренда — обратное неравенство.
3. **Подтверждение импульса**
   - Для покупок RSI должен быть выше `RsiBuyLevel`, для продаж — ниже `RsiSellLevel`. Значение RSI берётся на `ShiftBar` свечей назад, повторяя логику MQL5, где текущая формирующаяся свеча игнорируется.
4. **Исполнение сделок**
   - При наличии сигнала и свободного лимита стратегия отправляет рыночную заявку объёмом `TradeVolume`.
   - Если открыта позиция противоположного направления, сначала происходит её закрытие и только затем разворот.
   - Если открыта позиция в ту же сторону, к совокупному объёму добавляется очередной блок до достижения лимита `MaxPositions * TradeVolume`.

## Управление рисками
- **Начальный стоп и тейк**. Для каждой сделки рассчитываются уровни по `StopLossPips` и `TakeProfitPips`. Пункты переводятся в цену через `PriceStep` инструмента. Для инструментов с дробным шагом (5 знаков после запятой и т.п.) применяется дополнительный множитель 10 — как и в исходном эксперте.
- **Трейлинг-стоп**. Когда плавающая прибыль превышает сумму `TrailingStopPips + TrailingStepPips`, стоп подтягивается, сохраняя дистанцию `TrailingStopPips`. Следующие смещения требуют очередного прироста на `TrailingStepPips`, что полностью воспроизводит ступенчатую механику оригинала.
- **Ограничение позиций**. Параметр `MaxPositions` задаёт максимальное число объёмных блоков. Сигналы, ведущие к превышению лимита, игнорируются.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `MaPeriod` | Период сглаженной скользящей средней по медианной цене. | 67 |
| `ShiftBar`, `ShiftBar1`, `ShiftBar2`, `ShiftBar3` | Сдвиги (в барах) для выборки значений SMMA при проверке формы тренда. | 1, 1, 2, 3 |
| `RsiPeriod` | Окно расчёта RSI. | 57 |
| `RsiBuyLevel` | Порог RSI для подтверждения покупок. | 60 |
| `RsiSellLevel` | Порог RSI для подтверждения продаж. | 36 |
| `TradeVolume` | Объём одной сделки или донаращивания. | 0.1 |
| `StopLossPips` | Размер первоначального стоп-лосса в пунктах (0 отключает). | 300 |
| `TakeProfitPips` | Размер первоначального тейк-профита в пунктах (0 отключает). | 300 |
| `TrailingStopPips` | Дистанция трейлинг-стопа от цены после активации (0 отключает). | 12 |
| `TrailingStepPips` | Минимальный дополнительный ход цены перед очередным смещением трейлинг-стопа. | 5 |
| `MaxPositions` | Максимальное число объёмных блоков (`TradeVolume`), которые могут быть одновременно открыты. | 7 |
| `CandleType` | Тип свечей, используемых для расчётов. | Таймфрейм 1 час |

## Примечания
- Все вычисления выполняются только на закрытых свечах, что уменьшает шум и повторяет поведение оригинального алгоритма.
- Состояние позиции отслеживается внутри стратегии, поэтому стопы и тейки исполняются через рыночные заявки, даже если защитные ордера не выставлены на биржу.
- Конвертация сохраняет оригинальную схему перевода пунктов в цену и алгоритм ступенчатого трейлинг-стопа, но использует высокоуровневый API StockSharp для подписки на данные и выставления сделок.
