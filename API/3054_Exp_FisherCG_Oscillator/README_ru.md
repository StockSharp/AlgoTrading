# Стратегия Exp Fisher CG Oscillator
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник **Exp_FisherCGOscillator** из MetaTrader 5 в высокоуровневый API StockSharp. Она восстанавливает вычисления осциллятора Fisher Center of Gravity, оценивает сигналы на настраиваемой исторической свече и повторяет механику стопов/тейков исходного робота с помощью ордеров StockSharp.

## Логика работы

1. **Цепочка индикатора** – каждая завершённая свеча передаётся в осциллятор Fisher CG: медианные цены участвуют в расчёте центра тяжести, значения нормализуются по окну `Length`, затем применяется преобразование Фишера. Линия `Trigger` – это сдвинутое на один бар значение самого осциллятора.
2. **Извлечение сигналов** – стратегия анализирует два исторических значения, задаваемых `SignalBar`. Лонг открывается, когда более старое значение (`SignalBar + 1`) расположено выше своей линии триггера, а более новое (`SignalBar`) пересекает триггер снизу вверх. Шорты формируются по зеркальному условию.
3. **Выходы** – выход из лонга происходит сразу, как только старое значение опускается ниже триггера; выход из шорта – когда оно поднимается выше. Это повторяет флаги `BUY_Close` и `SELL_Close` оригинального кода. При противоположном сигнале текущая позиция закрывается прежде, чем выполняется разворот.
4. **Обработка по закрытым свечам** – расчёты выполняются только на завершённых свечах `CandleType`, что даёт детерминированные результаты и соответствует проверке "нового бара" в советнике.

## Риск-менеджмент и размер позиции

- **Стоп/тейк** – параметры `StopLossPoints` и `TakeProfitPoints` задаются в шагах цены и пересчитываются в абсолютные расстояния через `Security.PriceStep`.
- **Управление объёмом** – при `SizingMode = FixedVolume` используется постоянный объём `FixedVolume`. Режим `PortfolioShare` конвертирует долю капитала `DepositShare` в количество контрактов, используя последнюю цену закрытия и `VolumeStep` инструмента.
- **Одна позиция** – стратегия всегда закрывает текущую сделку перед открытием противоположной, избегая хеджирующих позиций.

## Параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Таймфрейм, по которому запрашиваются свечи и рассчитывается индикатор. |
| `Length` | Период осциллятора Fisher CG и окно нормализации. |
| `SignalBar` | Количество закрытых свечей для считывания сигналов (`1` соответствует настройке EA). |
| `AllowLongEntry` / `AllowShortEntry` | Разрешение на открытие лонгов/шортов. |
| `AllowLongExit` / `AllowShortExit` | Разрешение на автоматическое закрытие позиций при обратном сигнале. |
| `StopLossPoints` / `TakeProfitPoints` | Расстояние стопа и тейка в шагах цены. Значение `0` отключает уровень. |
| `FixedVolume` | Объём сделки в режиме фиксированного лота. |
| `DepositShare` | Доля капитала для расчёта объёма в режиме `PortfolioShare`. |
| `SizingMode` | Выбор между фиксированным объёмом и расчётом от капитала. |

## Рекомендации по использованию

- Подберите `CandleType` и `SignalBar` под исходные настройки индикатора (по умолчанию H8 и смещение 1).
- Дайте индикатору время на прогрев – пока нет достаточного количества баров, стратегия не торгует.
- Стопы и тейки контролируются по цене закрытия свечи, поэтому корректируйте значения в шагах цены под волатильность инструмента.
- При использовании `PortfolioShare` убедитесь, что стратегия получает актуальную оценку портфеля, иначе будет задействован фиксированный объём.

## Отличия от оригинального советника

- Используются рыночные ордера без параметра `Deviation_`; проскальзывание обрабатывается средствами StockSharp.
- Система управления капиталом упрощена до двух режимов (`FixedVolume` и `PortfolioShare`). Опции распределения убытков (`LOSSBALANCE`, `LOSSFREEMARGIN`) не реализованы.
- Метки времени сигналов (`UpSignalTime`/`DnSignalTime`) не применяются – вход выполняется на той же свече после завершения расчётов.
