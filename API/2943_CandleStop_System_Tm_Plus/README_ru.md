# CandleStop System Tm Plus
[English](README.md) | [中文](README_cn.md)

Стратегия прорыва, основанная на пользовательском индикаторе CandleStop. Система постоянно рассчитывает задержанные каналы из максимума и минимума, отслеживает закрытие завершённой свечи за пределами канала и реагирует на следующей свече. Дополнительно можно ограничить время удержания позиции и задать защитные стопы в шагах цены.

## Детали
- **Условия входа**: Предыдущая завершённая свеча закрывается выше задержанного верхнего канала (для лонга) или ниже задержанного нижнего канала (для шорта), при этом текущая свеча возвращается внутрь диапазона, чтобы избежать повторного сигнала.
- **Лонг/шорт**: Симметричная логика для покупок и продаж с отдельными переключателями разрешения.
- **Условия выхода**: Прорыв CandleStop противоположного цвета закрывает открытые позиции; дополнительно включаемый таймер закрывает сделки по истечении заданного количества минут.
- **Стопы**: Используются стоп-лосс и тейк-профит в шагах цены через `StartProtection`.
- **Значения по умолчанию**:
  - `OrderVolume` = 1
  - `UpTrailPeriods` = 5, `UpTrailShift` = 5
  - `DownTrailPeriods` = 5, `DownTrailShift` = 5
  - `SignalBar` = 1
  - `StopLossPoints` = 1000, `TakeProfitPoints` = 2000
  - `MaxPositionMinutes` = 1920
  - `CandleType` = таймфрейм 8 часов
- **Фильтры**:
  - Категория: Прорывы
  - Направление: Оба
  - Индикаторы: задержанные каналы CandleStop
  - Стопы: Да
  - Сложность: Средняя
  - Таймфрейм: Многочасовой
  - Сезонность: Нет
  - Нейросети: Нет
  - Дивергенция: Нет
  - Уровень риска: Средний

## Параметры
- `OrderVolume`: Объём рыночной заявки при открытии новой позиции.
- `EnableLongEntry` / `EnableShortEntry`: Включение или отключение новых лонгов и шортов по отдельности.
- `CloseLongOnBearishBreak` / `CloseShortOnBullishBreak`: Закрывать ли текущую позицию при появлении противоположного прорыва CandleStop.
- `EnableTimeExit`: Активирует фильтр максимального времени удержания.
- `MaxPositionMinutes`: Количество минут до принудительного закрытия позиции; ноль отключает таймер даже при включенном `EnableTimeExit`.
- `UpTrailPeriods` и `UpTrailShift`: Длина и сдвиг окна для верхнего канала CandleStop. Сдвиг задерживает дончиановскую границу на несколько баров, как в оригинальном индикаторе.
- `DownTrailPeriods` и `DownTrailShift`: Аналогичные настройки для нижнего канала.
- `SignalBar`: Индекс свечи, по которой оценивается цвет прорыва (1 = предыдущая завершённая). Следующая по давности свеча используется для подтверждения, как в MQL-версии.
- `StopLossPoints` / `TakeProfitPoints`: Дистанция защитных ордеров в шагах цены, передаётся в `StartProtection` для автоматического сопровождения.
- `CandleType`: Основной временной интервал стратегии. По умолчанию 8 часов, как в исходном скрипте.

## Особенности реализации
- Каналы формируются индикаторами `Highest` и `Lowest` в сочетании с `Shift`, что воспроизводит задержанные уровни оригинального CandleStop.
- Цветовые сигналы сохраняются в кольцевом буфере, имитируя `CopyBuffer` из MQL и предотвращая повторные входы подряд.
- Перед отправкой заявок стратегия сначала проверяет таймер, закрывает противоположные позиции при необходимости и только затем выставляет рыночные ордера с заданным объёмом.
