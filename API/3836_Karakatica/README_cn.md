# Karakatica 策略

## 概述
Karakatica 策略源自 MetaTrader 4 智能交易系统 “Exp_karakatica”。默认在 **EUR/USD 的 M15 周期** 上运行，通过基于简单移动平均线（SMA）的交叉模型来模拟原始 “iKarakatica” 指标的行为。信号周期在每根新K线上重新计算，使策略能够动态跟随近期最具盈利潜力的市场状态。

策略只在没有持仓时使用市价单入场，并通过 StockSharp 的保护系统自动挂载止损和止盈。

## 交易逻辑
1. **信号生成** – 计算收盘价的简单移动平均线。当上一根K线收盘价在 SMA 下方（或等于）且最新完成的K线收盘价上穿 SMA 时，触发做多信号；当上一根K线在 SMA 上方（或等于）且最新K线下穿 SMA 时，触发做空信号。信号始终基于上一根完成的K线，以模拟 MT4 中 `iKarakatica` 指标 shift=1 的用法。
2. **持仓管理** –
   - 若持有头寸且出现反向信号，则立即以市价单平仓。
   - 只有在没有持仓且优化器未禁止对应方向时才允许开仓。策略在出现相反信号之前不会连续在同一方向加仓。
3. **仓位大小** – `Risk` 参数决定目标下单量。算法根据当前账户权益计算出目标量，并按照品种的最小交易量和步长进行对齐，复现原 EA 的手数计算方式。
4. **交易保护** – 止损和止盈以点数设置，随后乘以合约的价格步长得到绝对价格。

## 自适应优化
策略持续优化信号周期，以适应市场变化：

1. 每隔 `ReoptimizeEvery` 根K线启动一次历史回测，覆盖最近 `OptimizationDepth` 根K线。
2. 对于区间 `[OptimizationStart, OptimizationEnd]` 内、步长为 `OptimizationStep` 的每个候选周期，回测模块模拟 SMA 交叉策略：
   - 当收到信号时虚拟持仓开仓，出现反向信号时平仓，并累计收益。
   - 分别记录多头收益、空头收益以及总收益。
3. 扫描全部候选周期后应用如下规则：
   - 若多头和空头收益均为负，则在下一次优化前禁止所有交易方向。
   - 若多头和空头的最佳结果相等，则启用综合收益最高的周期，同时保留双向交易。
   - 否则只允许收益更高的方向，并启用对应的最佳周期。

优化需要至少 `OptimizationDepth + OptimizationEnd + 2` 根完成的K线。历史数据不足时，策略会推迟交易。

## 参数
| 名称 | 说明 | 默认值 | 可优化 |
| ---- | ---- | ------ | ------ |
| `Risk` | 以每 1000 单位权益为基准的风险百分比，用于计算下单量。 | 0.5 | 是 |
| `StopLossPoints` | 止损点数。 | 50 | 是 |
| `TakeProfitPoints` | 止盈点数。 | 150 | 是 |
| `Period` | 当前用于生成信号的 SMA 周期，由优化器自动调整。 | 70 | 是 |
| `OptimizationDepth` | 回测所使用的历史K线数量。 | 250 | 否 |
| `ReoptimizeEvery` | 启动优化的间隔（以K线数量计）。 | 50 | 否 |
| `OptimizationStart` | 优化搜索区间的起始周期。 | 10 | 否 |
| `OptimizationStep` | 周期搜索步长。 | 5 | 否 |
| `OptimizationEnd` | 优化搜索区间的结束周期。 | 150 | 否 |
| `CandleType` | 蜡烛类型（默认 15 分钟 K 线）。 | M15 蜡烛 | 否 |

## 使用建议
- 策略设计用于 EUR/USD 的 M15 周期。移植到其他品种时，请重新评估点值、交易量步长以及点差假设。
- 建议行情源提供买卖价（Bid/Ask），以便在优化过程中估计点差。如无可用报价，策略会退化为使用单个价格步长作为点差估计。
- 优化模块需要几百根历史K线。在实盘前请确保数据已充分加载。

## 文件列表
- `CS/KarakaticaStrategy.cs` – StockSharp 策略实现。
- `README.md` – 英文说明。
- `README_ru.md` – 俄文说明。
- `README_cn.md` – 中文说明（本文）。
