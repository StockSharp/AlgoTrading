# Стратегия XWAMI Multi-Layer MMRec

Стратегия переносит эксперт **Exp_XWAMI_NN3_MMRec.mq5** в StockSharp. Три независимых слоя (A/B/C) запускают индикатор XWAMI на разных таймфреймах и объединяют сигналы в одну неттинговую позицию. Каждый слой повторяет собственный MagicNumber оригинала, включая алгоритм перерасчёта лота (MMRec) и уровни защиты.

## Логика торговли

* Для каждого слоя строится ряд импульса `цена - цена[iPeriod]` по выбранному типу цены. Разность проходит через четыре последовательных сглаживания (настраиваемые методы и длины), формируя линии `up` и `down` индикатора XWAMI.
* Сигналы оцениваются на сдвиге `SignalBar`. Если на предыдущем баре `up > down`, слой закрывает продажи и разрешает покупку, когда на последнем баре `up <= down`. Если на предыдущем баре `up < down`, закрываются покупки и разрешается продажа при условии `up >= down`.
* Перед открытием позиции в новом направлении стратегия закрывает противоположные позиции других слоёв, чтобы соблюдать неттинговую модель StockSharp. Это соответствует закрытию встречного ордера с другим MagicNumber в MQL.
* Стоп-лосс и тейк-профит (в пунктах цены) проверяются на каждом завершённом баре по максимуму/минимуму свечи и при срабатывании немедленно закрывают позицию слоя.

## Перерасчёт лота (MMRec)

Каждый слой ведёт скользящее окно последних сделок. Если число убыточных сделок в окне достигает порога *LossTrigger*, объём снижается с нормального (`NormalVolume`) до уменьшенного (`SmallVolume`). При меньшем количестве проигрышей объём возвращается к нормальному. Для покупок и продаж счётчики ведутся раздельно, как в исходном модуле MMRec.

## Параметры

* `Layer?CandleType` — таймфрейм слоя (по умолчанию: A=8h, B=4h, C=1h).
* `Layer?Period` — сдвиг для расчёта импульса.
* `Layer?Method1..4`, `Layer?Length1..4`, `Layer?Phase1..4` — настройки четырёх ступеней сглаживания XWAMI.
* `Layer?AppliedPrice` — тип цены (close, open, weighted, Demark и т.д.).
* `Layer?SignalBar` — сдвиг бара для оценки сигнала.
* `Layer?AllowBuy/SellOpen`, `Layer?AllowBuy/SellClose` — разрешения на открытия и закрытия.
* `Layer?NormalVolume`, `Layer?SmallVolume` — объём сделки в нормальном и уменьшенном режимах.
* `Layer?BuyTotalTrigger`, `Layer?BuyLossTrigger`, `Layer?SellTotalTrigger`, `Layer?SellLossTrigger` — параметры MMRec для смены объёма.
* `Layer?StopLossPoints`, `Layer?TakeProfitPoints` — стоп-лосс и тейк-профит в пунктах (0 отключает уровень).

## Особенности

* В StockSharp используется единая неттинговая позиция, поэтому при конфликте сигналов противоположные позиции закрываются прежде чем открывать новую.
* Этап Tillson T3 реализован вручную на C#, остальные методы сглаживания используют стандартные индикаторы StockSharp (SMA, EMA, SMMA/RMA, LWMA, Jurik).
* История сделок отслеживается внутри стратегии, поэтому поведение MMRec сохраняет пороги оригинального эксперта без обращения к истории терминала.
