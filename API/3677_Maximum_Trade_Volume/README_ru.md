# Стратегия Maximum Trade Volume

## Обзор
Стратегия является портом скрипта MetaTrader 5 **Maximum Trade Volume**. Изначально индикатор выводил панель с максимальным доступным лотом для рыночных и отложенных заявок в обе стороны. Версия на StockSharp повторяет те же расчёты управления рисками в рамках высокоуровневого API. Вместо интерфейса она обновляет четыре открытых свойства и публикует сообщения в журнале при каждом изменении значений.

Стратегия не отправляет заявки. Её задача — отслеживать свободные средства портфеля и переводить их в допустимый объём для рыночной покупки, рыночной продажи, отложенной покупки и отложенной продажи. Полученные величины можно использовать в других автоматических модулях при формировании реальных ордеров.

## Параметры
- **Candle Type** – источник данных, инициирующий пересчёт. В MQL-версии использовался таймер, здесь обновление происходит после закрытия каждой свечи выбранного типа.

## Логика
1. Подписаться на свечи указанного типа и ждать их завершения.
2. Для каждого обновления:
   - Собрать информацию о портфеле (текущий баланс, текущую стоимость или стартовую стоимость) чтобы оценить свободную маржу.
   - Определить требование по марже для покупки и продажи. Если биржа передаёт `MarginBuy`/`MarginSell`, используются эти значения, иначе расчёт выполняется по `StepPrice`, `PriceStep` и цене закрытия.
   - Преобразовать доступные средства в объём, привести результат к сетке `VolumeStep` и учесть ограничения `VolumeMin`/`VolumeMax`.
3. Сохранить нормализованный объём для рыночной покупки, рыночной продажи, отложенной покупки и отложенной продажи. При изменении выводить информационное сообщение, при нулевом значении — предупреждение.

## Особенности реализации
- Обрабатываются только завершённые свечи, что соответствует требованиям высокоуровневого API.
- В методе запуска вызывается `StartProtection()`, как в большинстве примеров репозитория.
- Весь код написан с табуляцией и английскими комментариями в соответствии с инструкцией `AGENTS.md`.
- В исходном скрипте отложенные заявки резервируют ту же маржу, что и рыночные, поэтому оба расчёта используют общую вспомогательную функцию.

## Использование
Привяжите стратегию к нужному инструменту и портфелю. После получения данных в журнале появятся записи вида:

```
Max lot for buy: 1.25
Max lot for pending sell: insufficient free funds
```

Актуальные значения также доступны в свойствах `MaxMarketBuyVolume`, `MaxMarketSellVolume`, `MaxPendingBuyVolume` и `MaxPendingSellVolume`. Их можно применить в логике управления объёмом или отобразить в пользовательском интерфейсе.
