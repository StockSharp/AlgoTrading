# 最大可交易仓位策略

## 概述
该策略是 MetaTrader 5 脚本 **Maximum Trade Volume** 的 StockSharp 版本。原脚本通过图形面板同时显示市场单和挂单在多空两个方向上可开出的最大手数。移植后的策略在高层 API 中复现相同的风控计算，不再绘制界面，而是维护四个公开属性并在结果发生变化时输出日志。

策略本身不会发单。它只负责监控组合的可用资金，并将其转换成市场买入、市场卖出、挂单买入和挂单卖出所允许的有效成交量。其他自动化模块可以复用这些数据来决定真正下单时的手数。

## 参数
- **Candle Type** – 触发重新计算的数据源。MQL 版本依靠定时器更新，本策略改为在所选类型的每根收盘 K 线之后刷新结果。

## 逻辑
1. 订阅配置好的 K 线序列并等待其收盘。
2. 每次更新时：
   - 读取组合信息（优先使用当前余额，其次是当前权益或初始价值）来近似可用保证金。
   - 获取买入或卖出的单位保证金需求。如果交易所提供了 `MarginBuy`/`MarginSell`，则直接使用；否则根据 `StepPrice`、`PriceStep` 和最新收盘价估算。
   - 将可用资金转换为成交量，并按照 `VolumeStep` 对齐，同时应用 `VolumeMin`/`VolumeMax` 限制。
3. 保存市场买、市场卖、挂单买、挂单卖的规范化手数，并在数值变化时打印信息日志；若结果为零，则输出警告。

## 实现说明
- 仅处理收盘 K 线，符合高层策略 API 的约定。
- 在启动阶段调用一次 `StartProtection()`，遵循仓库中常见的防护模式。
- 缩进全部使用制表符，且代码注释为英文，符合 `AGENTS.md` 的通用规则。
- 在原脚本中挂单与市价单占用的保证金相同，因此这里复用了同一套计算函数。

## 使用方式
将策略绑定到目标证券和组合。当开始接收数据后，日志中会出现类似的消息：

```
Max lot for buy: 1.25
Max lot for pending sell: insufficient free funds
```

同时可以通过 `MaxMarketBuyVolume`、`MaxMarketSellVolume`、`MaxPendingBuyVolume` 和 `MaxPendingSellVolume` 属性读取最新结果，用于自定义界面显示或自动化仓位控制。
