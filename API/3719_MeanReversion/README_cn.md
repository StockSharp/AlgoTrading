# 均值回归策略

## 概述
该策略移植自 MetaTrader 专家顾问 `MeanReversion.mq5`。当价格在设定的回溯窗口内创出新的低点时，策略会开立多头仓位并将最近区间的中点作为回归目标；当价格刷新新高时，则按照相同思路开立空头仓位。头寸规模根据风险百分比和止损距离计算，尽可能还原原始 EA 的手数算法。

## 交易逻辑
1. 使用所选 K 线类型和回溯周期构建唐奇安通道。上轨表示窗口内的最高价，下轨表示最低价，中线 `(upper + lower) / 2` 作为均值回归目标。
2. 若当前收盘完成的 K 线创出新低（`Low <= LowerBand`）且无持仓，则按市价买入。止损价通过入场价对称反射，使中线成为止盈目标，对应原始 EA 的计算 `sl = 2 * Ask - tp`。
3. 若 K 线创出新高（`High >= UpperBand`）且无持仓，则按市价卖出，止损放置在入场价上方，中线仍为止盈价位。
4. 每根完成的 K 线都会检查止损与止盈。价格突破止损时立即平仓，触及中线则在目标位置离场。仓位回到空仓状态后内部状态会自动重置。

## 仓位管理
* 单笔风险为 `Portfolio.CurrentValue * (RiskPercent / 100)`。若账户权益不可用，策略会退而使用最小可交易手数。
* 合约风险按 `|EntryPrice - StopPrice|` 计算，原始手数为 `RiskAmount / perUnitRisk`，随后按照合约最小变动量归一化。当归一化结果小于最小可交易数量时，会自动采用最小手数，同时满足交易所的最大/最小限制。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 用于构建唐奇安通道的 K 线类型和周期。 | 15 分钟 |
| `LookbackPeriod` | 计算最高价与最低价所用的 K 线数量。 | 200 |
| `RiskPercent` | 每笔交易占用的账户权益百分比。 | 1% |

全部参数均支持优化。

## 其他说明
* 策略一次只持有一个方向的仓位，对应原版代码中的 `PositionsTotal()>0` 限制。
* 止损和止盈在策略内部维护，而不是通过附加委托下达，以便保持与原 EA 一致并兼容高级 API。
* 当无法获取账户权益或合约手数信息时，策略仍会使用最小手数交易，以确保行为确定。
