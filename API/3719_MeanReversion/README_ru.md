# Стратегия Mean Reversion

## Обзор
Стратегия является портом MetaTrader-советника `MeanReversion.mq5`. При появлении нового минимума в пределах заданного окна она открывает длинную позицию и нацеливается на середину диапазона; при обновлении максимума выполняет зеркальное короткое вход. Размер позиции рассчитывается по проценту риска и расстоянию до стоп-уровня, что максимально приближено к алгоритму подбора лота в оригинальном советнике.

## Логика торговли
1. По выбранному типу свечей и периоду строится канал Дончиана. Верхняя граница отражает максимумы, нижняя — минимумы, а средняя линия `(upper + lower) / 2` используется как цель возврата к среднему.
2. Если завершившаяся свеча формирует новый минимум (`Low <= LowerBand`) и позиций нет, выполняется покупка по рынку. Стоп ставится симметрично относительно цены входа так, чтобы целевой уровень совпадал со средней линией. Это повторяет формулу из MQL `sl = 2 * Ask - tp`.
3. Если свеча формирует новый максимум (`High >= UpperBand`) при отсутствии позиции, выполняется продажа по рынку со стоп-уровнем над ценой входа, а цель снова равна середине канала.
4. На каждой завершённой свече проверяются условия выхода. Пробой стопа закрывает позицию сразу, достижение средней линии фиксирует прибыль. После возврата к нулевой позиции внутреннее состояние автоматически сбрасывается.

## Управление объёмом
* Риск на сделку рассчитывается как `Portfolio.CurrentValue * (RiskPercent / 100)`. При отсутствии данных по счёту используется минимально допустимый объём.
* Риск на единицу инструмента равен `|EntryPrice - StopPrice|`. Исходный объём — это `RiskAmount / perUnitRisk`, после чего он нормализуется под шаг объёма инструмента с учётом ограничений по минимуму и максимуму. Если нормализованное значение меньше минимально допустимого, используется именно минимальный объём.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип и таймфрейм свечей для построения канала Дончиана. | 15 минут |
| `LookbackPeriod` | Количество свечей в окне поиска максимумов и минимумов. | 200 |
| `RiskPercent` | Процент капитала, которым рискнут в одной сделке. | 1% |

Все параметры доступны для оптимизации.

## Дополнительные замечания
* В каждый момент времени стратегия держит только одну позицию, что соответствует проверке `PositionsTotal()>0` в исходнике MQL.
* Стоп и тейк-профит поддерживаются внутренней логикой без выставления дополнительных заявок, что делает поведение ближе к оригиналу и совместимым с High Level API.
* Если отсутствуют данные о капитале или шагах объёма, стратегия всё равно торгует минимально возможным объёмом, обеспечивая предсказуемость работы.
