# Up3x1 Premium 2vM 策略

## 概述

该策略是 MetaTrader 4 智能交易程序 *up3x1_Premium_2vM* 的等价移植版本。它只交易单一品种，并且任何时刻最多持有一个仓位。入场条件结合了平滑移动平均线、强势 K 线区间以及日线级别的午夜突破过滤器。风控方面使用以“价格点”为单位的固定止盈与止损距离，可选的移动止损会在行情向持仓方向运行后持续收紧，完全复刻原始 EA 的行为。

## 工作原理

1. 主时间框可配置，默认对应原始 EA 的图表周期。策略在主时间框上绑定两个典型价的平滑移动平均线（SMMA），周期分别为 12 和 26。
2. 额外订阅一份日线数据流，重建 MQL 代码中使用的 PERIOD_D1 数据，并驱动 10 周期的日线简单移动平均线。
3. 在空仓时评估最近两根已完成 K 线及缓存的 SMMA 数值：
   - **做多条件**：快线向上穿越慢线且两根 K 线的开盘价逐步抬高；或者最近一根 K 线满足多头区间/实体阈值；或者上一根日线实体上涨且振幅大于阈值。原 EA 还比较了日线均线与买价，该判断在 MQL 中始终为真，因此为了兼容性仍予保留。
   - **做空条件**：与多头逻辑对称，使用空头区间和均线向下交叉判断。
   - 只要任一多头条件满足就市价买入，否则若满足任一空头条件则市价卖出。下单前会根据交易所的成交量步长对手数进行归一化处理。
4. 持仓期间持续监控上一根 K 线的快/慢 SMMA 值。当两者的绝对差小于 `ConvergenceTolerance` 时立即平仓，对应原 EA 中“均线相等即平仓”的规则。
5. 移动止损模块跟踪平均持仓价。一旦价格突破设定的距离就上调/下调止损，使其始终与行情保持固定间距；当行情触及该价位时立即离场，等效于 MQL 中反复 `OrderModify` 的行为。

## 参数

| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `CandleType` | `TimeFrame(1h)` | 主时间框。 |
| `FastMaPeriod` | `12` | 快速 SMMA 的周期（典型价）。 |
| `SlowMaPeriod` | `26` | 慢速 SMMA 的周期（典型价）。 |
| `RangeThreshold` | `0.0060` | 区间过滤器要求的最小高低点差。 |
| `BodyThreshold` | `0.0050` | 区间过滤器要求的最小实体长度。 |
| `DailyRangeThreshold` | `0.0060` | 最新日线的最小开收盘距离，用于午夜突破过滤。 |
| `TakeProfitPoints` | `150` | 以价格点表示的止盈距离，设为 `0` 以关闭。 |
| `StopLossPoints` | `100` | 以价格点表示的止损距离，设为 `0` 以关闭。 |
| `TrailingStopPoints` | `10` | 移动止损与价格之间的距离，设为 `0` 禁用移动止损。 |
| `TradeVolume` | `0.05` | 市价单的基础手数，下单前会做步长归一化。 |
| `ConvergenceTolerance` | `0.00001` | 触发平仓时允许的快慢均线最大差值。 |

## 备注

- 保留了原 EA 中“日线均线与买价比较永远为真”的特性，以确保回测结果一致。
- 止盈/止损通过 `StartProtection` 注册，可自动适配券商的价格步长。
- 移动止损只有在 `TrailingStopPoints` 为正且 `Security.PriceStep` 有效时才会生效；缺少任一信息都会禁用该功能。
- 手数归一化遵循交易所限制（`VolumeStep`、`VolumeMin`、`VolumeMax`）。若需要百分比仓位，可在此基础上扩展自定义逻辑并传入负值。 
