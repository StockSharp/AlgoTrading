# Стратегия Up3x1 Premium 2vM

## Обзор

Стратегия представляет собой прямую конверсию советника MetaTrader 4 *up3x1_Premium_2vM*. Она работает с одним инструментом и никогда не удерживает более одной позиции одновременно. Для входа используются сглаженные скользящие средние, мощные свечные диапазоны и фильтр пробоя дневного бара в полночь. Управление рисками выполняется фиксированными уровнями тейк-профита и стоп-лосса в ценовых пунктах, а опциональный трейлинг-стоп повторяет оригинальный алгоритм, который подтягивает защитный уровень по мере движения цены в прибыль.

## Логика работы

1. Основной таймфрейм настраивается пользователем; по умолчанию он соответствует таймфрейму графика в MT4. На этой серии свечей рассчитываются две сглаженные скользящие (SMMA) с периодами 12 и 26 и ценой `Typical`.
2. Дополнительная подписка на дневные свечи воссоздаёт поток PERIOD_D1, использовавшийся в MQL, и питает 10-периодную дневную SMA.
3. При отсутствии позиции анализируются две последние завершённые свечи и сохранённые значения SMMA:
   - **Длинный сигнал**: быстарая SMMA пересекает медленную снизу вверх при растущих ценах открытия; либо последняя свеча удовлетворяет порогам диапазона и тела; либо предыдущий дневной бар бычий и имеет достаточный размах. Оригинальный код также сравнивал дневную SMA с ценой Ask. Условие всегда истинно, поэтому для совместимости оно сохранено.
   - **Короткий сигнал**: зеркальные условия для шорта, основанные на пересечении вниз и медвежьем диапазоне.
   - Если выполняется хоть одно длинное условие, отправляется рыночная покупка. Иначе, при выполнении любого короткого условия отправляется рыночная продажа. Перед отправкой объём приводится к шагу объёма инструмента.
4. При открытой позиции стратегия отслеживает предыдущие значения SMMA. Когда их разница становится меньше `ConvergenceTolerance`, позиция закрывается, что повторяет сравнение на равенство в советнике.
5. Модуль трейлинг-стопа отслеживает среднюю цену входа. После прохождения ценой дистанции трейлинга стоп переносится, сохраняя заданный отступ. При касании уровня позиция закрывается сразу, имитируя повторные вызовы `OrderModify` в MQL.

## Параметры

| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | `TimeFrame(1h)` | Основной таймфрейм. |
| `FastMaPeriod` | `12` | Период быстрой SMMA по типичной цене. |
| `SlowMaPeriod` | `26` | Период медленной SMMA по типичной цене. |
| `RangeThreshold` | `0.0060` | Минимальный диапазон свечи для фильтра импульса. |
| `BodyThreshold` | `0.0050` | Минимальный размер тела свечи в фильтре диапазона. |
| `DailyRangeThreshold` | `0.0060` | Минимальная разница между открытием и закрытием последнего дневного бара. |
| `TakeProfitPoints` | `150` | Дистанция тейк-профита в ценовых пунктах. Ноль отключает. |
| `StopLossPoints` | `100` | Дистанция стоп-лосса в ценовых пунктах. Ноль отключает. |
| `TrailingStopPoints` | `10` | Отступ трейлинг-стопа. Ноль отключает сопровождение. |
| `TradeVolume` | `0.05` | Базовый объём рыночных заявок до нормализации. |
| `ConvergenceTolerance` | `0.00001` | Допустимая разница между SMMA для принудительного выхода. |

## Примечания

- Сохранена особенность оригинального советника: условие сравнения дневной SMA с ценой Ask всегда истинно, что обеспечивает идентичность поведения.
- Уровни стоп-лосса и тейк-профита создаются через `StartProtection`, поэтому автоматически учитывают шаг цены инструмента.
- Трейлинг-стоп активируется только при положительном значении `TrailingStopPoints` и наличии `Security.PriceStep`. При отсутствии данных об отступе сопровождение отключается.
- Нормализация объёма подчиняется биржевым ограничениям (`VolumeStep`, `VolumeMin`, `VolumeMax`). При необходимости процентного мани-менеджмента можно расширить логику и использовать отрицательные значения параметра.
