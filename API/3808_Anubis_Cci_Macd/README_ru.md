# 3808 Anubis

## Краткое описание
- Перенос советника MetaTrader 4 "Anubis" на высокоуровневый API StockSharp.
- Использует фильтр CCI на 4-часовых свечах в сочетании с пересечениями MACD на 15-минутных данных.
- Реализует адаптивный объём, виртуальный стоп-лосс, перевод в безубыток, выходы по ATR и по стандартному отклонению.

## Логика стратегии
1. **Данные**
   - Основной таймфрейм: 15 минут (`SignalCandleType`) для MACD и ATR.
   - Старший таймфрейм: 4 часа (`TrendCandleType`) для CCI и стандартного отклонения.
2. **Индикаторы**
   - `CommodityChannelIndex` с настраиваемым периодом на 4H свечах.
   - `StandardDeviation` длиной 30 на 4H закрытиях для расчёта дистанции тейк-профита.
   - `MovingAverageConvergenceDivergenceSignal` на 15M свечах с настраиваемыми периодами EMA.
   - `AverageTrueRange` длиной 12 на 15M свечах для волатильностных выходов.
3. **Входы**
   - **Short**: CCI выше `CciThreshold`, MACD за предыдущие две свечи формирует мёртвый крест (переход MACD ниже сигнальной линии) при положительном значении, нет открытых лонгов, и цена отошла от последнего входа не менее чем на `PriceFilterPoints` пунктов.
   - **Long**: зеркальное условие с CCI ниже `-CciThreshold`, бычьим пересечением MACD в отрицательной зоне, отсутствием шортов и соблюдением фильтра по дистанции.
4. **Управление рисками**
   - Базовый объём задаётся `VolumeValue`, масштабируется по величине капитала (×2 выше 14k, ×3.2 выше 22k) и умножается на `LossFactor` после убыточной сделки.
   - Максимальное число одновременных сделок в каждом направлении ограничено `MaxLongTrades` и `MaxShortTrades`.
   - Жёсткий стоп контролируется виртуально на расстоянии `StopLossPoints * PriceStep` от средней цены входа.
   - Безубыток активируется после прибыли в `BreakevenPoints` пунктов и закрывает позицию при возврате цены к входу.
5. **Выходы**
   - Тейк-профит по стандартному отклонению закрывает позицию при движении `StdDevMultiplier * StdDev` в нужную сторону.
   - Агрессивный выход срабатывает, если предыдущая свеча превышает `CloseAtrMultiplier * ATR`.
   - Выход по замедлению MACD требует и достаточной прибыли (`ProfitThresholdPoints`), и разворота наклона MACD (сравнение значений одной и двух свечей назад).
   - Дополнительно позиция закрывается при срабатывании виртуального стопа или возврате к цене входа после активации безубытка.

## Параметры
| Имя | Описание |
| --- | -------- |
| `VolumeValue` | Базовый объём заявки. |
| `CciThreshold` | Абсолютный порог фильтра CCI на 4H. |
| `CciPeriod` | Период индикатора CCI на 4H. |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах. |
| `BreakevenPoints` | Прибыль в пунктах для перевода в безубыток. |
| `MacdFastPeriod` | Быстрая EMA MACD. |
| `MacdSlowPeriod` | Медленная EMA MACD. |
| `MacdSignalPeriod` | Сигнальная EMA MACD. |
| `LossFactor` | Множитель объёма после убыточной сделки. |
| `MaxShortTrades` | Максимум одновременных коротких позиций. |
| `MaxLongTrades` | Максимум одновременных длинных позиций. |
| `CloseAtrMultiplier` | Множитель ATR для агрессивного выхода. |
| `ProfitThresholdPoints` | Дополнительная прибыль в пунктах для выхода по MACD. |
| `StdDevMultiplier` | Множитель стандартного отклонения для тейк-профита. |
| `PriceFilterPoints` | Минимальная дистанция между повторными входами. |
| `SignalCandleType` | Основной таймфрейм для MACD и ATR. |
| `TrendCandleType` | Старший таймфрейм для CCI и стандартного отклонения. |

## Примечания
- Требуется корректно заполненный `Security.PriceStep`, иначе пунктовые параметры нельзя перевести в цену.
- Стратегия использует виртуальные стопы и тейки, не размещая реальные отложенные заявки, что соответствует оригинальному советнику.
- Версия на Python намеренно опущена по условиям задачи.
