# 慢速随机指标多模式策略
[English](README.md) | [Русский](README_ru.md)

**Slow Stochastic Mode Strategy** 将 MetaTrader 专家顾问 `Exp_Slow-Stoch.mq5` 移植到 StockSharp 高层 API。策略仅在蜡烛完全收盘后计算，并使用经过额外平滑的随机振荡器来识别趋势状态的变化。交易者可以在三种信号模式之间切换，以响应阈值突破、动量拐点或线条交叉。

## 核心思路

策略跟踪慢速随机指标的 %K 与 %D 两条曲线，并通过 `Slowing` 参数进一步平滑 %K。根据所选的 `Mode`，算法会回看由 `SignalBar` 指定的历史蜡烛，在满足条件时开仓或平仓对向持仓。所有委托均通过市价单完成。

## 信号模式

- **Breakdown**：监控 %K 穿越 50 水平线。自下向上突破 50 时开多并平掉空头；自上向下跌破时开空并平掉多头。
- **Twist**：检测 %K 的方向变化。如果两根之前的 %K 仍在下降，而当前观测到的 %K 已向上拐头，则建立或反转为多头，反之亦然。
- **CloudTwist**：观察 %K 与 %D 的交叉（信号云颜色切换）。%K 上穿 %D 触发多头并清理空头；%K 下穿 %D 触发空头并清理多头。

四个权限开关（多/空开仓、多/空平仓）可以独立控制，从而实现只做管理或只在单边建仓的模式。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CandleType` | H4 时间框架 | 指标计算所用蜡烛类型。|
| `KPeriod` | 5 | %K 线的计算周期。|
| `DPeriod` | 3 | %D 线的平滑周期。|
| `Slowing` | 3 | 对 %K 进行的额外平滑长度。|
| `SignalBar` | 1 | 回看多少根已收蜡烛来评估信号。|
| `StopLossPoints` | 1000 | 止损距离（单位：最小价格步长，0 表示关闭）。|
| `TakeProfitPoints` | 2000 | 止盈距离（单位：最小价格步长，0 表示关闭）。|
| `EnableLongEntries` | true | 允许开多头仓位。|
| `EnableShortEntries` | true | 允许开空头仓位。|
| `EnableLongExits` | true | 允许根据信号平掉多头。|
| `EnableShortExits` | true | 允许根据信号平掉空头。|
| `Mode` | Twist | 当前启用的信号模式。|

策略使用 StockSharp 自带的 `StochasticOscillator` 指标。通过调整 `SignalBar` 参数，可以复刻 MetaTrader 中默认检查上一根蜡烛（=1）的行为，或在设为 0 时直接对最新收盘蜡烛做出反应。

## 交易管理

- 下单函数使用 `BuyMarket` 与 `SellMarket`。在反向操作时，订单数量会自动加上当前仓位的绝对值，以实现先平仓再反向开仓。
- `StartProtection` 用于启用可选的止损与止盈。给定的点数会按合约最小价位自动换算成绝对价格距离。
- 策略不附带跟踪止损，保护位保持不变直至成交或手动平仓。

## 离场逻辑

- **Breakdown** 模式：触发开仓的同一阈值也负责关闭对向仓位。
- **Twist** 模式：侦测到动量拐点时，会先平掉当前仓位，再在反方向建立新仓。
- **CloudTwist** 模式：%K 与 %D 的交叉既触发展开仓，也同步清空对向仓位。

如果关闭了对应的开仓权限，策略将只执行剩余的退出规则，可用于管理已有敞口。

## 实现细节

- 为了读取指定的历史偏移，策略在内存中维护了小型缓冲区，存储最近的 %K 与 %D 值。
- 仅在 `candle.State == Finished` 时才执行信号判定，确保所有数据基于已完成的蜡烛。
- 如果图表服务可用，策略会绘制蜡烛图、随机指标以及自身成交点。

该实现忠实保留了原始 MQL5 系统的交易思路，同时借助 StockSharp 的指标绑定、参数元数据与内置风控机制提升了可维护性。
