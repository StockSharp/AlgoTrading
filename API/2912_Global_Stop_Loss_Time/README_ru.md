# Стратегия глобального стоп-лосса и торгового окна

## Общее описание
Стратегия повторяет логику MetaTrader-советника **Exp_GStopLoss_Tm** и служит защитным слоем над любыми торговыми системами. Она не
создаёт собственных сигналов входа, а лишь отслеживает суммарный результат открытых позиций. При превышении заданного уровня
просадки или при выходе рынка за пределы разрешённого торгового окна стратегия закрывает позиции и блокирует дальнейшую торговлю
до полного обнуления позиции.

## Логика работы
1. При запуске фиксируется текущий реализованный PnL, который используется как базовая отметка для расчёта плавающей прибыли.
2. Каждая сформированная свеча выбранного таймфрейма инициирует проверку риска. По умолчанию используется минутный интервал, что
   позволяет максимально оперативно отслеживать состояние позиций.
3. Фактический убыток определяется как разница между текущим PnL стратегии и базовым значением. Положительная прибыль игнорируется,
   пока время находится внутри разрешённого окна.
4. В режиме **Percent** модуль сравнивает относительную просадку с текущей стоимостью портфеля (`Portfolio.CurrentValue`). В режиме
   **Currency** сравнение ведётся в абсолютных денежных единицах счёта.
5. После превышения порога стоп-лосса активируется флаг остановки. На следующей итерации стратегия отправляет рыночный ордер навстречу
   существующей позиции. Флаг сбрасывается только после полного закрытия позиций и обновления базового PnL.
6. При включённом временном фильтре дополнительно проверяется, входит ли время закрытия свечи в заданный интервал. Окно может
   пересекать полночь, как и в оригинальном скрипте.
7. Когда стоп-flag активен или время выходит за пределы окна, модуль мгновенно закрывает позицию и фиксирует причину в журнале.

## Параметры
| Параметр | Описание |
| -------- | -------- |
| `LossMode` | Режим расчёта стоп-лосса: процент от текущей стоимости портфеля или абсолютная сумма. |
| `StopLoss` | Значение глобального стоп-лосса. В процентном режиме указывается величина в процентах, в денежном — сумма в валюте счёта. |
| `UseTimeFilter` | Включает ограничение по торговому времени. При выключении временной фильтр не используется. |
| `StartTime` | Начало торгового окна (UTC), задаётся вместе с `EndTime`. |
| `EndTime` | Конец торгового окна (UTC, не включая конечную точку). Если конец раньше начала, окно считается ночным. |
| `CandleType` | Тип свечей, по которым выполняются проверки. По умолчанию — 1 минута. |

## Особенности реализации
- Базовый PnL пересчитывается каждый раз после обнуления позиции, чтобы последующие сделки оценивались от нуля.
- В процентном режиме используется текущее значение портфеля, поэтому учитываются как реализованные, так и плавающие изменения.
- Все комментарии в коде написаны на английском языке, что соответствует требованиям репозитория.
- При наличии графика стратегия выводит свечи и собственные сделки, что облегчает анализ результатов.

## Рекомендации по использованию
1. Запустите стратегию на инструменте, который требуется контролировать. Другие торговые алгоритмы могут продолжать открывать сделки —
   данный модуль лишь управляет риском и закрывает позиции при необходимости.
2. Настройте режим и величину стоп-лосса в соответствии с допустимым риском. Например, `LossMode = Percent` и `StopLoss = 5`
   приведут к закрытию позиции после 5% плавающей просадки.
3. Установите параметры `StartTime` и `EndTime`, чтобы ограничить торговлю нужным интервалом. Для ночных сессий задайте начало позже
   конца, например 20:00–06:00.
4. Выполните тестирование или запустите стратегию в реальном времени. После закрытия всех позиций защита автоматически сбрасывается и
   продолжает контролировать следующие сделки.
