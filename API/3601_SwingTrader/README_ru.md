# Стратегия SwingTrader

## Обзор
**SwingTrader** — порт советника MetaTrader 4 `SwingTrader.mq4` на платформу StockSharp. Оригинальный эксперт ищет отскоки от
границ полос Боллинджера: если цена касается внешней границы и следующая свеча пересекает среднюю линию, советник открывает
позицию и строит мартингейловую сетку усреднений. Переведённая стратегия использует свечи StockSharp, индикатор Bollinger Bands
из `StockSharp.Algo.Indicators` и рыночные заявки `BuyMarket` / `SellMarket`, сохраняя логику МТ4 и одновременно учитывая биржевые
ограничения из свойств `Security`.

## Логика торговли
1. Подписаться на таймфрейм, указанный в параметре `CandleType`, и рассчитать Bollinger Bands длиной `BollingerPeriod` со стандартным
   отклонением, равным 2.
2. Обрабатывать только завершённые свечи — обработчик игнорирует частично сформированные бары, полностью повторяя проверку
   `IsNewCandle()` из МТ4.
3. Отслеживать, касалась ли предыдущая свеча верхней или нижней полосы. Булевы флаги `_upTouch` и `_downTouch` реализуют оригинальную
   схему взаимного исключения: активен только один флаг, пока не произойдёт противоположное касание.
4. При отсутствии открытой сетки:
   - открыть длинную позицию, если последняя завершённая свеча пересекла среднюю линию снизу вверх после касания нижней полосы;
   - открыть короткую позицию, если свеча пересекла среднюю линию сверху вниз после касания верхней полосы.
   Объём первой сделки равен `InitialVolume` (после округления по биржевым шагам), а ширина сетки задаётся текущей дистанцией между
   верхней и нижней полосами.
5. При наличии сетки следить за движением против позиции относительно цены первой сделки:
   - для лонгов: если минимум свечи находится не выше чем на ширину полосы ниже опорной цены, купить дополнительный объём,
     умноженный на `Multiplier`;
   - для шортов: если максимум свечи находится на ширину полосы выше опорной цены, продать дополнительный объём с тем же множителем.
6. Продолжать усреднение, пока не сработает целевой профит или лимит убытка.

## Управление капиталом и выходы
- Метод `CalculateUnrealizedProfit` переводит ценовые изменения в тики с помощью `Security.PriceStep` и `Security.StepPrice`,
  воспроизводя расчёт плавающей прибыли из МТ4.
- Оценка вложенного капитала повторяет формулу `Lots * Price / TickSize * TickValue / 30`: под `Lots` понимается суммарный объём
  сетки, а параметры тика берутся из `Security`.
- Полное закрытие сетки происходит, когда плавающая прибыль превышает `TakeProfitFactor * вложенный капитал`.
- Аварийное закрытие происходит при плавающем убытке `10 * TakeProfitFactor * вложенный капитал`, что соответствует допуску
  исходного советника.
- Закрытия выполняются обратными рыночными заявками; после выхода состояние сетки сбрасывается и стратегия ждёт нового касания полос.

## Параметры
| Название | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `TakeProfitFactor` | `decimal` | `0.05` | Коэффициент прибыли, умножаемый на вложенный капитал для определения цели. |
| `Multiplier` | `decimal` | `1.5` | Множитель объёма для каждой новой сделки сетки. |
| `BollingerPeriod` | `int` | `20` | Количество свечей в расчёте полос Боллинджера. |
| `InitialVolume` | `decimal` | `1` | Объём первой сделки в новой сетке (с учётом биржевых ограничений). |
| `CandleType` | `DataType` | таймфрейм 15 минут | Тип свечей, используемый для сигналов. |

## Отличия от оригинального советника
- StockSharp работает в модели неттинга; стратегия хранит явный список сделок сетки, чтобы имитировать учёт сделок по тикетам в МТ4.
- Биржевые ограничения по объёму (`Security.MinVolume`, `Security.VolumeStep`, `Security.MaxVolume`) применяются автоматически вместо
  ручного вызова `CheckVolumeValue`.
- Сигналы рассчитываются на закрытии свечи; внутренняя логика MT4 по тиковым событиям аппроксимируется использованием максимумов и
  минимумов свечи при добавлении усреднений.
- Заявки всегда отправляются как рыночные, тогда как в MT4 использовался `OrderSend` с явным указанием Bid/Ask.

## Практические рекомендации
- Заполните в коннекторе корректные сведения об инструменте (`PriceStep`, `StepPrice`, `MinVolume`, `VolumeStep`, `MaxVolume`),
  чтобы расчёт прибыли, убытка и объёмов совпадал с MT4.
- Мартингейловые сетки несут повышенный риск. Перед запуском на реальном счёте протестируйте стратегию на исторических данных и
  оцените требования по марже.
- Ширина сетки равна текущей ширине полос Боллинджера; изменение `BollingerPeriod` одновременно влияет на частоту входов и расстояние
  между уровнями. Проведите оптимизацию, чтобы понять чувствительность.
