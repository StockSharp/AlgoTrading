# Стратегия DeMarker Pending

## Обзор
Стратегия переносит эксперта MetaTrader "DeMarker Pending 2.5" на платформу StockSharp. Робот рассчитывает индикатор DeMarker на выбранном таймфрейме и при пересечении заданных уровней формирует отложенный ордер в сторону пробоя. Ордер выставляется на фиксированном отступе в пунктах и может быть как стоповым, так и лимитным. Для контроля торгов доступны фильтр торгового окна и автоматическое истечение ожидания ордеров.

## Логика торговли
- Подписаться на свечи выбранного типа и рассчитывать DeMarker с периодом `DemarkerPeriod`.
- Сравнивать значения текущей и предыдущей завершённой свечи с уровнями `DemarkerLowerLevel` и `DemarkerUpperLevel`.
- При пробое нижнего уровня вверх подготовить длинный сетап; при пробое верхнего уровня вниз — короткий сетап.
- Сформировать цену отложенного ордера как `Close ± PendingIndentPoints * PriceStep`, используя стоп-ордера для пробоя либо лимит-ордера для отката (в зависимости от `Mode`).
- Добавить к отложенному ордеру уровни стоп-лосса и тейк-профита, смещённые на `StopLossPoints` и `TakeProfitPoints` пунктов от цены активации.
- Перед размещением нового сигнала отменить или сохранить существующие отложенные ордера согласно параметрам `ReplacePreviousPending` и `SinglePendingOnly`.
- Автоматически снимать ордера, у которых истёк срок жизни `PendingExpirationMinutes`.
- При включённом `UseTimeWindow` пропускать сигналы вне торгового окна; один бар даёт не более одного нового ордера на направление.

## Управление ордерами
- Все входы выполняются отложенными ордерами (`BuyStop`, `SellStop`, `BuyLimit`, `SellLimit`).
- К каждому ордеру сразу добавляются уровни защиты, чтобы позиция была защищена моментально после активации.
- Ордера снимаются при истечении срока, при замене новым сигналом или при изменении состояния на неактивное (исполнено, отменено, отклонено).

## Параметры
| Параметр | Описание |
|----------|----------|
| `Volume` | Объём сделки в лотах. |
| `StopLossPoints` | Расстояние от цены входа до стоп-лосса в пунктах. |
| `TakeProfitPoints` | Расстояние от цены входа до тейк-профита в пунктах. |
| `PendingIndentPoints` | Отступ между рыночной ценой и отложенным ордером. |
| `PendingExpirationMinutes` | Время жизни отложенного ордера в минутах (0 — без ограничения). |
| `Mode` | Тип отложенного ордера (стоп или лимит). |
| `SinglePendingOnly` | Запрет на одновременное наличие более одного активного отложенного ордера. |
| `ReplacePreviousPending` | Автоматическая отмена существующих ордеров перед постановкой нового. |
| `DemarkerPeriod` | Период расчёта индикатора DeMarker. |
| `DemarkerUpperLevel` | Уровень DeMarker для сигналов на продажу. |
| `DemarkerLowerLevel` | Уровень DeMarker для сигналов на покупку. |
| `CandleType` | Таймфрейм свечей для анализа. |
| `UseTimeWindow` | Включает фильтрацию по торговому окну. |
| `StartTime` | Начало внутридневного торгового окна. |
| `EndTime` | Конец внутридневного торгового окна. |

## Примечания
- В оригинальном эксперте реализованы сложные модули управления капиталом и трейлинг-стоп. В порте сохранены сигнал и отложенные ордера, а размер позиции задаётся фиксированным параметром `Volume`.
- StockSharp прикрепляет уровни стоп-лосса и тейк-профита к ордеру при регистрации. Убедитесь, что брокер поддерживает такие параметры для стоповых и лимитных заявок.
- Перед запуском проверьте, что значения в пунктах совместимы с минимальным шагом цены инструмента (`PriceStep`), и соответствуют требованиям площадки по минимальным дистанциям для защитных приказов.
