# Пересечение ADX и MA

## Общее описание
Стратегия повторяет советник «ADX & MA», сочетая сглаженную скользящую среднюю и индикатор направленного движения ADX. Анализ ведётся по двум последним завершённым свечам выбранного таймфрейма, расчёты начинаются только после того, как и средняя, и ADX выдают подтверждённые значения. Реализация ориентирована на хеджинговый стиль оригинала, но работает в модели неттинга и автоматически разворачивает позицию при появлении противоположного сигнала.

Скользящая средняя рассчитывается по медианной цене `(High + Low) / 2`, что соответствует версии MetaTrader с индикатором SMMA. Порог по ADX отсекает периоды слабого тренда и снижает количество ложных пересечений.

## Логика входа
- Дождаться формирования окончательных значений сглаженной SMA и ADX.
- Оценить закрытие предыдущей свечи (`n-1`) относительно значения SMA для той же свечи.
- Открыть длинную позицию, если:
  - Закрытие свечи `n-1` выше SMA;
  - Закрытие свечи `n-2` было ниже той же SMA (бычье пересечение);
  - Значение ADX на свече `n-1` не ниже `AdxThreshold`.
- Открыть короткую позицию при зеркальных условиях (медвежье пересечение и подтверждение ADX).
- Объём ордера равен `Volume` стратегии плюс абсолютное значение противоположной позиции, что обеспечивает разворот при смене сигнала.

## Логика выхода
Длинные позиции закрываются при первом из условий:
- Последнее подтверждённое закрытие (`n-1`) опускается ниже SMA (обратное пересечение);
- Цена достигает рассчитанного тейк-профита для покупок;
- Цена падает до рассчитанного стоп-лосса для покупок;
- Трейлинг-стоп для длинной позиции активируется, когда прибыль превышает `TrailingStopBuy` пунктов, и сдвигает стоп вслед за ценой.

Короткие позиции используют аналогичные правила с собственными параметрами и зеркальными условиями. При появлении противоположного сигнала отправляется рыночный ордер, который закрывает текущую позицию и открывает новую в обратном направлении.

## Управление рисками
- Дистанции тейк-профита, стоп-лосса и трейлинг-стопа задаются в **пунктах**. Размер пункта вычисляется из `Security.PriceStep`; для инструментов с 3 или 5 знаками после запятой используется поправка `PriceStep × 10`, как и в оригинальном коде MetaTrader.
- Методы `InitializeLongTargets` и `InitializeShortTargets` сразу после отправки ордера пересчитывают абсолютные уровни стопов и целей, используя последнее подтверждённое закрытие как приблизительную цену входа.
- При включённом трейлинг-стопе уровни стоп-лоссов сдвигаются по мере роста прибыли, что фиксирует часть нереализованной доходности.
- После закрытия позиции уровни сбрасываются, чтобы исключить повторное использование устаревших значений.

## Параметры
- `MaPeriod` – период сглаженной скользящей средней (по умолчанию 15).
- `AdxPeriod` – период сглаживания ADX (по умолчанию 12).
- `AdxThreshold` – минимальное значение ADX для подтверждения тренда (по умолчанию 16).
- `TakeProfitBuy` / `StopLossBuy` / `TrailingStopBuy` – дистанции для длинных сделок в пунктах.
- `TakeProfitSell` / `StopLossSell` / `TrailingStopSell` – дистанции для коротких сделок в пунктах.
- `CandleType` – таймфрейм входных свечей, по умолчанию 1 минута.

Базовый объём ордеров задаётся свойством `Volume`. В отличие от оригинального скрипта, короткие сделки используют собственные настройки рисков, но при необходимости можно задать одинаковые значения.
