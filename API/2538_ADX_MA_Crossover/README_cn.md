# ADX MA Crossover

## 概述
本策略复刻 MetaTrader 中的“ADX & MA”专家顾问，结合平滑移动平均线（SMMA）与平均趋向指数（ADX）过滤信号。策略仅在所选周期的最近两根已完成K线都给出最终指标值后才会评估入场，从而避免在指标尚未形成时提前交易。实现基于净头寸模型，会在出现反向信号时自动翻转仓位，模拟原始对冲版本的行为。

移动平均线以每根K线的中位价 `(High + Low) / 2` 计算，与原脚本使用的 SMMA 完全一致。ADX 阈值用于确认趋势强度，帮助过滤掉短暂的虚假突破。

## 入场逻辑
- 等待平滑移动平均线与 ADX 同时输出最终值。
- 使用上一根已完成K线 (`n-1`) 的收盘价与该K线对应的 SMMA 值进行比较。
- 当满足以下条件时做多：
  - `n-1` 的收盘价高于其对应的 SMMA；
  - `n-2` 的收盘价低于同一 SMMA（形成向上交叉）；
  - `n-1` 的 ADX 值大于或等于 `AdxThreshold`。
- 当条件反向时做空（收盘价从上向下穿越 SMMA，并且 ADX 达到阈值）。
- 订单数量为策略 `Volume` 加上当前反向仓位的绝对值，确保出现反向信号时能够直接翻转仓位。

## 离场逻辑
多头持仓将在以下任一情况出现时平仓：
- 最近确认的收盘价 (`n-1`) 再次跌破 SMMA（反向交叉）；
- 价格上涨到长仓的止盈距离；
- 价格回落到长仓的止损距离；
- 启用了长仓追踪止损并且价格较入场价盈利超过 `TrailingStopBuy` 点时，追踪止损开始跟随价格锁定利润。

空头仓位使用同样的规则，只是方向相反，并拥有独立的止盈、止损和追踪距离设置。每次出现反向信号时，策略都会发送足够大的市价单来平掉原仓并开立新仓。

## 风险与资金管理
- 止盈、止损和追踪距离都以**点（pip）**为单位。策略根据 `Security.PriceStep` 计算点值，当品种报价保留 3 或 5 位小数时，会使用 `PriceStep × 10` 的修正，与原始 MQL 逻辑一致。
- `InitializeLongTargets` 与 `InitializeShortTargets` 在下单后立刻根据最新确认收盘价估算入场价，并计算对应的绝对止盈/止损价位。
- 当启用追踪止损且浮动盈利超过设定距离时，止损价位会沿趋势方向移动以锁定盈利。
- 每次仓位被关闭后，所有目标和止损数值都会重置，避免复用过期信息。

## 参数
- `MaPeriod` – 平滑移动平均线的周期（默认 15）。
- `AdxPeriod` – ADX 的平滑周期（默认 12）。
- `AdxThreshold` – 触发交易所需的最小 ADX 值（默认 16）。
- `TakeProfitBuy` / `StopLossBuy` / `TrailingStopBuy` – 多头的止盈、止损与追踪距离（点）。
- `TakeProfitSell` / `StopLossSell` / `TrailingStopSell` – 空头的止盈、止损与追踪距离（点）。
- `CandleType` – 使用的K线周期，默认 1 分钟。

请通过策略的 `Volume` 属性设置基础下单手数。如需复现原脚本的行为，可将多空方向的风险参数设置为相同数值。
