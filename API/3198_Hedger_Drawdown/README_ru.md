# Стратегия Hedger Drawdown

Портирование на StockSharp советника MetaTrader 5 **hedger.mq5** (MQL №23511). Исходная система открывает защитный хедж в противоположную сторону, когда текущая позиция уходит в просадку на заданное количество пунктов. После частичного отката цена уменьшает убыток хеджа, и при достижении меньшего порога позиция закрывается даже с убытком, чтобы дать основному ордеру восстановиться. Конвертация воспроизводит этот цикл с использованием высокоуровневого API StockSharp и адаптирует механику к неттинговой модели платформы.

## Логика торговли

1. Стратегия отслеживает закрытие каждой свечи выбранного таймфрейма.
2. Для каждой не-хеджевой длинной позиции вычисляется расстояние между ценой входа и текущим закрытием. Если оно больше или равно **DrawdownOpenPips** и активного короткого хеджа нет, открывается короткий ордер тем же объёмом.
3. Для коротких позиций выполняется зеркальное правило — длинный хедж появляется, когда убыток достигает порога открытия.
4. Активные хеджи закрываются, когда их плавающий убыток достигает значения **DrawdownClosePips**, что повторяет логику MetaTrader по снятию защиты после частичного восстановления.
5. Если счёт в нуле и включён параметр **StartWithLong**, стратегия открывает стартовую длинную позицию, чтобы запустить цикл.

Поскольку StockSharp ведёт неттинговые позиции, стратегия хранит внутренние журналы длинных и коротких ордеров (с признаком хеджа). Каждый рыночный ордер обновляет эти журналы, позволяя управлять хеджами независимо от того, что брокер агрегирует позиции.

## Параметры

| Параметр | Описание |
| --- | --- |
| `DrawdownOpenPips` | Просадка в пунктах, при которой открывается противоположный хедж. |
| `DrawdownClosePips` | Просадка в пунктах, при которой хедж принудительно закрывается. |
| `InitialVolume` | Объём стартовой сделки при запуске цикла. |
| `StartWithLong` | При включении автоматически открывает первую длинную позицию, когда нет позиций. |
| `EnableVerboseLogging` | Записывает действия по управлению хеджами в журнал стратегии. |
| `CandleType` | Ряд свечей, по которому измеряется просадка. |

## Отличия от версии MetaTrader

- В оригинале признак хеджа задавался комментариями тикетов (`hedge_buy` / `hedge_sell`). В портированной версии состояние хранится в памяти из-за неттинговой модели StockSharp.
- Проверки маржи и настройка проскальзывания опущены: размещение заявок выполняется через `BuyMarket` / `SellMarket`.
- Пороговые значения и объём имеют заданные диапазоны оптимизации для использования стандартных оптимизаторов StockSharp.

## Рекомендации по использованию

1. Подключите стратегию к нужному инструменту и портфелю.
2. Подберите пороги в пунктах с учётом волатильности инструмента.
3. Включайте подробный лог на этапе тестирования — он фиксирует каждое открытие и закрытие хеджа с указанием количества пунктов.
4. Запускайте на таймфреймах с информативными закрытиями свечей (например, M15–H1), чтобы избежать избыточной торговли.
