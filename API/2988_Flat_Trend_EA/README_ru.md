# Стратегия Flat Trend EA

## Общее описание
Стратегия Flat Trend EA — это порт эксперта MQL5 «Flat Trend EA» на платформу StockSharp. Алгоритм объединяет индикатор Parabolic SAR и средний направленный индекс (ADX), чтобы определить четыре состояния рынка: восходящий тренд, нисходящий тренд, завершение покупок и завершение продаж. Стратегия работает только по завершённым свечам выбранного таймфрейма и в точности повторяет оригинальную логику закрытия встречных позиций перед открытием новой сделки.

## Логика входа и выхода
- **Сигнал на покупку**: точка Parabolic SAR находится ниже цены закрытия, а линия +DI индикатора ADX выше -DI. Любые короткие позиции закрываются немедленно; если позиции нет, открывается лонг.
- **Сигнал на продажу**: Parabolic SAR располагается выше цены закрытия, а +DI меньше или равен -DI. Все длинные позиции закрываются, после чего открывается шорт.
- **Фильтры завершения тренда**: когда SAR выше цены и +DI больше -DI, фиксируется окончание нисходящего движения; когда SAR ниже цены и +DI меньше либо равен -DI, фиксируется окончание восходящего тренда. В обоих случаях существующие позиции закрываются без открытия новой сделки.
- **Торговая сессия**: при включённом фильтре новые входы разрешены только в интервале `[StartHour, EndHour)`. Сигналы вне сессии всё равно закрывают активные позиции, но новые сделки не открываются.

## Управление рисками
- **Стоп-лосс и тейк-профит** задаются в пунктах. Для инструментов с тремя и пятью знаками pip автоматически масштабируется. Цены приводятся к шагу инструмента.
- **Трейлинг-стоп** активируется, когда прибыль превышает `TrailingStopPips + TrailingStepPips`. Для лонга стоп подтягивается под цену, для шорта — над ценой. При нулевом значении трейлинг отключён.
- **Защитные выходы**: на каждой завершённой свече минимум и максимум сравниваются с уровнями стоп-лосса, тейк-профита и трейлинга. Пробой любого уровня приводит к закрытию позиции и сбросу расчётов риска.

## Параметры
- `StopLossPips` — расстояние до защитного стопа в пунктах.
- `TakeProfitPips` — расстояние до цели в пунктах.
- `TrailingStopPips` — расстояние трейлинг-стопа (0 отключает трейлинг).
- `TrailingStepPips` — дополнительный прогресс цены для сдвига трейлинг-стопа; должен быть больше нуля при включённом трейлинге.
- `UseTradingHours` — включение фильтра торговой сессии.
- `StartHour` / `EndHour` — начальный час (включительно) и конечный час (исключительно) входов по времени площадки.
- `AdxPeriod` — период сглаживания ADX, определяющий чувствительность +DI и -DI.
- `SarStart`, `SarIncrement`, `SarMaximum` — настройки ускорения Parabolic SAR, соответствующие исходному индикатору (по умолчанию 0.02 / 0.02 / 0.2).
- `CandleType` — таймфрейм свечей и расчёта индикаторов.
- `Volume` — базовое свойство `Strategy`, задающее объём заявок при новых входах.

## Используемые индикаторы
- **Average Directional Index (ADX)** предоставляет компоненты +DI и -DI для определения направления тренда.
- **Parabolic SAR** определяет, находится ли рынок в бычьей или медвежьей фазе, и формирует уровень для трейлинг-стопа.

## Дополнительные замечания
- Размер пункта рассчитывается на основе настроек инструмента: для трёх- и пятизнакных котировок шаг цены умножается на десять, что соответствует определению pip в MQL.
- Перед рассмотрением нового входа стратегия всегда закрывает активные позиции при появлении противоположного или завершающего сигнала — так же, как исходный эксперт.
- Реализована только версия на C#; папка и версия на Python специально не создавались по требованию.
