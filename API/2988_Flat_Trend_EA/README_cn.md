# Flat Trend EA策略

## 概览
Flat Trend EA策略是将MQL5专家顾问“Flat Trend EA”移植到StockSharp平台的版本。策略结合Parabolic SAR与平均趋向指数（ADX），划分出四种市场状态：多头趋势、空头趋势、多头结束以及空头结束。算法仅在指定周期的收盘K线上计算，并严格遵循原始EA的流程——在开新仓之前先平掉所有反向仓位。

## 交易逻辑
- **做多信号**：Parabolic SAR点位于收盘价下方，同时ADX的+DI高于-DI。策略会先平掉已有空单，然后在没有持仓时开多。
- **做空信号**：Parabolic SAR点位于收盘价上方，同时+DI小于或等于-DI。所有多单会被先行平仓，再开新的空单。
- **趋势结束过滤**：当SAR在价格上方且+DI> -DI时认为空头趋势结束；当SAR在价格下方且+DI≤ -DI时认为多头结束。这两个事件都会强制平掉现有仓位，但不会立即反向开仓。
- **交易时段**：可选的时段过滤器将入场限制在`[StartHour, EndHour)`区间。时段之外的信号仍然可以平仓，但不会建立新仓位。

## 风险控制
- **止损与止盈**以点（pip）为单位设置。系统会根据交易品种的精度自动换算三位和五位报价的pip值，并将价格对齐到最小报价步长。
- **跟踪止损**在浮盈超过`TrailingStopPips + TrailingStepPips`后启动。多单的跟踪止损跟随价格上移，空单则跟随价格下移；当该参数为0时，跟踪功能关闭。
- **保护性出场**：每根收盘K线都会检查最高价和最低价是否触及止损、止盈或跟踪止损。一旦满足条件即刻平仓并重置风险状态。

## 参数
- `StopLossPips` —— 止损距离（点）。
- `TakeProfitPips` —— 止盈距离（点）。
- `TrailingStopPips` —— 跟踪止损距离（点，0表示关闭）。
- `TrailingStepPips` —— 跟踪止损移动所需的附加浮盈，启用跟踪时必须为正数。
- `UseTradingHours` —— 是否启用交易时段过滤。
- `StartHour` / `EndHour` —— 入场的起始与结束小时（结束为开区间），基于交易所时间。
- `AdxPeriod` —— ADX平滑周期，控制+DI和-DI的灵敏度。
- `SarStart`、`SarIncrement`、`SarMaximum` —— Parabolic SAR的加速度参数，默认值与原指标保持一致（0.02 / 0.02 / 0.2）。
- `CandleType` —— 用于订阅数据和计算指标的K线周期。
- `Volume` —— 继承自`Strategy`的下单手数，决定新仓位的交易量。

## 指标说明
- **Average Directional Index (ADX)** 提供+DI与-DI分量，用于判断趋势方向。
- **Parabolic SAR** 判定价格位于趋势上方或下方，并提供跟踪止损的参考点。

## 补充说明
- Pip大小依据品种设置计算：若报价保留三位或五位小数，则将价格步长乘以10以匹配MQL的pip定义。
- 策略在评估新入场前，总会先根据反向或结束信号平掉现有仓位，完整复现原EA的执行顺序。
- 仅提供C#实现；根据要求未创建Python版本及其目录。
