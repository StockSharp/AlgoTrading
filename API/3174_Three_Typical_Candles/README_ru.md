# Стратегия «Три типичные свечи»

## Обзор
Стратегия **«Три типичные свечи»** переносит одноимённого эксперта MetaTrader в инфраструктуру StockSharp. Алгоритм анализирует типичную цену (среднее арифметическое High, Low и Close) трёх последних завершённых свечей и реагирует на строго монотонные последовательности. Если типичные цены трёх свечей подряд возрастают, стратегия открывает длинную позицию, а при последовательном снижении — короткую.

Основные особенности портированной версии:
- Сигналы оцениваются только в момент закрытия свечи, что полностью совпадает с логикой исходного MQL5-советника.
- Гибкий фильтр торговых часов позволяет ограничить работу алгоритма заданным диапазоном и принудительно закрывает позиции вне разрешённого окна.
- Перед открытием новой сделки закрывается позиция противоположного направления, поэтому одновременно удерживается только один сценарий.
- Объём заявки задаётся фиксированным значением, но автоматически корректируется с учётом шага объёма и ограничений инструмента (минимум/максимум), как и в оригинальном советнике.

## Правила торговли
1. **Формирование сигнала**
   - Для каждой завершённой свечи вычисляется типичная цена `Tp = (High + Low + Close) / 3`.
   - Хранятся два предыдущих значения. Когда доступны три точки, проверяется наличие строго возрастающей или убывающей последовательности.
2. **Вход в длинную позицию**
   - Если выполнено условие `Tp[-2] < Tp[-1] < Tp[0]` и открытых лонгов нет, стратегия закрывает шорт (если он есть) и отправляет рыночную заявку на покупку.
3. **Вход в короткую позицию**
   - При условии `Tp[-2] > Tp[-1] > Tp[0]` закрывается лонг (если присутствует) и выставляется рыночная заявка на продажу.
4. **Контроль времени**
   - При включённом фильтре времени (`UseTimeControl`) проверяется час открытия свечи. Если свеча сформировалась вне допустимого диапазона `[StartHour; EndHour)`, позиция немедленно закрывается и новые заявки не подаются. Когда `StartHour > EndHour`, временное окно «перетекает» через полночь.
5. **Управление позицией**
   - Штатные уровни стоп-лосс и тейк-профит не используются. Управление рисками следует реализовать дополнительными защитными механизмами.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
|-----|-----|-----------------------|----------|
| `Volume` | decimal | `1` | Фиксированный торговый объём. Значение автоматически нормализуется по шагу объёма инструмента и ограничивается допустимыми минимальными/максимальными границами. |
| `UseTimeControl` | bool | `true` | Включает фильтр торговых часов. При отключении стратегия работает круглосуточно. |
| `StartHour` | int | `11` | Начало торгового окна (включительно, 0-23). |
| `EndHour` | int | `17` | Конец торгового окна (не включается в диапазон, 0-23). Если меньше `StartHour`, окно охватывает вечер и утро следующего дня. |
| `CandleType` | `DataType` | `TimeFrame(1h)` | Тип (таймфрейм) свечей, используемых для анализа. |

## Особенности реализации
- Подписка на свечи организована через высокоуровневый метод `SubscribeCandles`, обработчик `ProcessCandle` получает уже завершённые свечи.
- При смене направления алгоритм сначала закрывает текущую позицию вызовом `BuyMarket` или `SellMarket`, а затем открывает новую в противоположную сторону.
- В `OnStarted` вызывается `StartProtection()`, что позволяет подключать стандартные защитные стратегии StockSharp (глобальный стоп, трейлинг и т.п.).
- Метод `GetTradeVolume` повторяет нормализацию лота MetaTrader: учитывается шаг объёма, а также минимальные и максимальные ограничения инструмента.
- Для принятия решения достаточно хранить всего два предыдущих значения типичной цены, что делает реализацию компактной и производительной.

## Рекомендации по использованию
- Стратегия хорошо подходит для ликвидных инструментов, где свечи формируются без существенных разрывов. Помимо форекса можно использовать фьючерсы, акции или криптовалюты.
- Настройка таймфрейма через `CandleType` позволяет адаптировать стратегию к разным торговым стилям. Часовые свечи повторяют оригинальный алгоритм, но можно протестировать и другие интервалы.
- Рекомендуется дополнительно ограничивать риски на уровне портфеля (максимальная просадка, лимиты по количеству сделок и т.д.).
- Перед запуском на реальных счетах следует провести многостороннее тестирование: разные инструменты, исторические периоды и параметры временного фильтра.
