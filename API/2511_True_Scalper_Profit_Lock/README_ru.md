# Стратегия True Scalper Profit Lock

## Обзор
**True Scalper Profit Lock** — порт стратегии MetaTrader 5 «True Scalper Profit Lock» на платформу StockSharp. Стратегия ориентирована на ультракороткие сделки: используются быстрые экспоненциальные скользящие средние, RSI с периодом 2 и блок защиты прибыли, переводящий стоп-заявку в безубыток. Дополнительный модуль «abandon» закрывает позиции, которые слишком долго не достигают цели.

Реализация подписывается только на один поток свечей и анализирует исключительно завершённые бары. Базовый режим рассчитан на скальпинг внутри дня, однако каждый параметр можно настроить для работы с другими инструментами и таймфреймами.

## Индикаторы и данные
- **EMA (быстрая)** — период 3 по умолчанию, служит триггером для входа вверх.
- **EMA (медленная)** — период 7, определяет краткосрочное направление тренда.
- **RSI** — период 2, поддерживает два метода оценки:
  - *Method A* (по умолчанию выключен): реагирует только на пересечение порога между двумя барами.
  - *Method B* (включён по умолчанию): определяет полярность в зависимости от того, находится ли RSI выше или ниже порога.
- **Свечи** — стандартный таймфрейм 1 минута, изменяется параметром `CandleType`.

## Правила входа
1. Рассчитать значения быстрых и медленных EMA, а также RSI на последней завершённой свече.
2. Определить полярность RSI согласно выбранным методам:
   - Method A фиксирует смену полярности только при пересечении порога.
   - Method B мгновенно переключает состояние при выходе за пределы порога.
3. **Покупка** — когда быстрая EMA минимум на один ценовой шаг выше медленной и RSI показывает «негативную» полярность. Если модуль abandon потребовал разворота в лонг, позиция открывается независимо от текущих сигналов.
4. **Продажа** — когда быстрая EMA минимум на один ценовой шаг ниже медленной и RSI демонстрирует «положительную» полярность, либо если abandon форсирует разворот в шорт.
5. Развороты выполняются одной рыночной заявкой, которая закрывает текущую позицию и открывает обратную.

## Правила выхода
- **Стоп-лосс / тейк-профит** — задаются параметрами `StopLossPoints` и `TakeProfitPoints` (в шагах цены) и активируются сразу после входа.
- **Profit Lock** — при достижении прибыли в `BreakEvenTriggerPoints` шагов стоп переносится к цене входа с добавлением `BreakEvenPoints` шагов (для шорта стоп перемещается ниже входа). Механизм срабатывает только один раз на сделку.
- **Abandon** — отслеживает количество закрывшихся свечей после входа:
  - *Method A* закрывает сделку по истечении `AbandonBars` и устанавливает флаг на обязательный вход в противоположном направлении при первой возможности.
  - *Method B* просто фиксирует позицию по истечении тайм-аута, оставляя выбор направления индикаторам.
  - При одновременном включении методов приоритет имеет Method A.
- Закрытие выполняется через `ClosePosition`, после чего внутреннее состояние сбрасывается.

## Управление капиталом
- При включённом `UseMoneyManagement` объём рассчитывается по формуле оригинального советника: `Ceiling(Balance * RiskPercent / 10000) / 10`.
- Результат ограничивается так же, как и в MT5: минимум — возврат к `InitialVolume`, объём свыше 1 лота округляется вверх, для мини-счетов применяется множитель 10, верхний предел — 100 лотов.
- Если модуль отключён, используется фиксированный объём `InitialVolume`.

## Параметры
- `InitialVolume` — базовый объём сделки при выключенном мани-менеджменте.
- `TakeProfitPoints` / `StopLossPoints` — расстояние до тейк-профита и стоп-лосса в единицах `Security.PriceStep`.
- `FastPeriod`, `SlowPeriod`, `RsiLength`, `RsiThreshold` — настройки индикаторов.
- `UseRsiMethodA`, `UseRsiMethodB` — выбор логики работы RSI.
- `UseAbandonMethodA`, `UseAbandonMethodB`, `AbandonBars` — параметры блока принудительного выхода.
- `UseMoneyManagement`, `RiskPercent`, `LiveTrading`, `IsMiniAccount` — опции управления капиталом, соответствующие оригинальному советнику.
- `UseProfitLock`, `BreakEvenTriggerPoints`, `BreakEvenPoints` — параметры перевода стопа в безубыток.
- `MaxPositions` — сохранён для совместимости с MQL-версией; порт StockSharp управляет одной чистой позицией на инструмент.
- `CandleType` — используемый таймфрейм или тип свечей.

## Рекомендации по использованию
- Подключайте стратегию к одному инструменту; метод `GetWorkingSecurities` автоматически оформит подписку на выбранный тип свечей.
- Модули profit lock и abandon опираются на завершённые свечи, поэтому внутрисвечные проколы, не закрепившиеся к закрытию бара, не учитываются.
- Параметр `Slippage` из оригинального MT5-кода не применялся, поэтому в портированной версии отсутствует.
- Убедитесь, что величина шага цены инструмента соответствует ожидаемым значениям параметров.

## Отличия переноса
- StockSharp использует чистые позиции, поэтому даже при `MaxPositions > 1` стратегия не открывает несколько независимых сделок, что соответствует поведению исходного эксперта при `maxTradesPerPair = 1`.
- Управление заявками выполняется через высокоуровневые методы `BuyMarket`, `SellMarket`, `ClosePosition`.
- Индикаторные данные поступают через механизм `Bind`, исключая прямой доступ к буферам.

## Рекомендации по тестированию
- Протестируйте стратегию на исторических данных с тем же таймфреймом, что использовался в MT5 (рекомендуется 1-минутные свечи).
- Оптимизируйте параметры `TakeProfitPoints`, `StopLossPoints` и `BreakEvenTriggerPoints` под конкретный инструмент, поскольку базовые значения рассчитаны на валютные пары.
