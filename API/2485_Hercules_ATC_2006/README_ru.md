# Стратегия Hercules A.T.C. 2006

## Описание

Hercules A.T.C. 2006 — порт легендарного советника MetaTrader, ориентированного на
среднесрочный тренд. Стратегия отслеживает закрытые свечи базового таймфрейма,
выявляет пересечение EMA(1) и SMA(72) за последние два бара и открывает позиции
только при выполнении ряда фильтров. Сделка разбивается на две части с раздельными
целями фиксации прибыли, а стоп-приказ подтягивается по мере развития тренда.

## Используемые данные

- **Основные свечи:** параметр `CandleType`, по умолчанию 1-часовые свечи.
- **Быстрая средняя:** EMA длиной `FastMaPeriod` (стандартное значение 1).
- **Медленная средняя:** SMA длиной `SlowMaPeriod` (стандартное значение 72).
- **RSI:** индикатор длиной `RsiLength`, рассчитываемый на `RsiTimeFrame`.
- **Дневной конверт:** SMA длиной `DailyEnvelopePeriod` на `DailyEnvelopeTimeFrame`
  с отклонением ±`DailyEnvelopeDeviation` процентов.
- **Четырёхчасовой конверт:** SMA длиной `H4EnvelopePeriod` на `H4EnvelopeTimeFrame`
  с отклонением ±`H4EnvelopeDeviation` процентов.
- **Плавающие экстремумы:** максимум и минимум за последние `HighLowHours` часов по основному таймфрейму.

## Ключевые параметры

| Параметр | Значение по умолчанию | Назначение |
| --- | --- | --- |
| `TriggerPips` | 38 | Смещение (в пунктах) от цены пересечения до уровня срабатывания. |
| `TrailingStopPips` | 90 | Дистанция трейлинг-стопа (0 — отключено). |
| `TakeProfit1Pips` | 210 | Первый тейк-профит, закрывает половину позиции. |
| `TakeProfit2Pips` | 280 | Второй тейк-профит, закрывает остаток позиции. |
| `FastMaPeriod` | 1 | Период быстрой EMA. |
| `SlowMaPeriod` | 72 | Период медленной SMA. |
| `StopLossLookback` | 4 | Количество баров для расчёта первоначального стопа. |
| `HighLowHours` | 10 | Размер окна (в часах) для фильтра «пробой максимума/минимума». |
| `BlackoutHours` | 144 | Длительность «тёмного периода» после сделки. |
| `RsiLength` | 10 | Период RSI. |
| `RsiUpper` | 55 | Минимальное значение RSI для лонгов. |
| `RsiLower` | 45 | Максимальное значение RSI для шортов. |
| `DailyEnvelopePeriod` | 24 | Период SMA дневного конверта. |
| `DailyEnvelopeDeviation` | 0.99 | Отклонение дневного конверта (в процентах). |
| `H4EnvelopePeriod` | 96 | Период SMA четырёхчасового конверта. |
| `H4EnvelopeDeviation` | 0.1 | Отклонение четырёхчасового конверта (в процентах). |
| `CandleType` | 1 час | Основной рабочий таймфрейм. |
| `RsiTimeFrame` | 1 час | Таймфрейм для RSI. |
| `DailyEnvelopeTimeFrame` | 1 день | Таймфрейм для дневного конверта. |
| `H4EnvelopeTimeFrame` | 4 часа | Таймфрейм для четырёхчасового конверта. |

## Правила торговли

1. **Определение пересечения**
   - Хранить значения EMA и SMA за три последних закрытых бара.
   - Если EMA пересекает SMA вверх на одном из двух прошлых баров — формировать бычий сигнал.
   - Если EMA пересекает SMA вниз — медвежий сигнал.
   - Рассчитывать среднюю цену пересечения и задавать двухбаровое окно для входа.

2. **Условия срабатывания**
   - Лонг возможен, если максимум текущей свечи достигает `TriggerPrice` выше цены пересечения.
   - Шорт возможен, если минимум опускается ниже соответствующего триггера.
   - Окно актуально две свечи после момента пересечения.

3. **Фильтры**
   - Нет открытых позиций и не истёк период блокировки (`BlackoutHours`).
   - RSI: для покупок `RSI > RsiUpper`, для продаж `RSI < RsiLower`.
   - Пробой: закрытие выше динамического максимума (лонг) или ниже минимума (шорт).
   - Конверты: цена должна находиться выше обоих верхних конвертов для лонга и ниже нижних для шорта.

4. **Вход и сопровождение**
   - Отправить рыночную заявку на объём стратегии (по умолчанию 2 лота).
   - Стоп ставится на минимум (лонг) или максимум (шорт) бара, отстоящего на `StopLossLookback` позиций назад.
   - Установить два тейк-профита в соответствии с параметрами.
   - Запустить таймер блокировки новых входов.

5. **Управление позицией**
   - Трейлинг-стоп сдвигается в сторону прибыли, если параметр включён.
   - На первом тейке закрывается половина позиции; остаток сопровождается до второго тейка, стопа или трейлинга.

## Управление риском

- Стопы рассчитываются только по закрытым барам, что снижает ложные срабатывания.
- Поэтапная фиксация прибыли улучшает устойчивость стратегии.
- Трейлинг-стоп защищает накопленную прибыль при сильных трендах.
- Длинный «blackout» предотвращает повторный вход сразу после выброса.

## Дополнительная информация

- Значение `Volume` по умолчанию равно 2, что имитирует двойной ордер оригинального советника.
- Сдвиг конвертов в MetaTrader заменён на использование актуальных значений из-за ограничений высокоуровневого API.
- Для корректного пересчёта пунктов необходимо задать минимальный шаг цены инструмента.
