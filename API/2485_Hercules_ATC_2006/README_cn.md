# Hercules A.T.C. 2006 策略

## 概述

Hercules A.T.C. 2006 是一套基于较高时间框架的趋势跟随系统，源自 2006 年的
MetaTrader 专家顾问。本移植版本在主时间框架上等待 K 线收盘，检测 EMA(1)
与 SMA(72) 的金叉/死叉，并在多个过滤条件满足后才开仓。策略将仓位拆分为两
个子仓，在不同目标价获利了结，并在价格朝有利方向发展时启动移动止损。

## 指标与数据

- **主时间框架：** 可配置，默认 1 小时 K 线。
- **快线：** 长度为 `FastMaPeriod` 的 EMA，默认 1。
- **慢线：** 长度为 `SlowMaPeriod` 的 SMA，默认 72。
- **RSI 过滤：** 在 `RsiTimeFrame`（默认 1 小时）上计算长度为 `RsiLength` 的 RSI。
- **日线包络线：** 在 `DailyEnvelopeTimeFrame` 上计算长度为 `DailyEnvelopePeriod`
  的 SMA，并使用 ±`DailyEnvelopeDeviation` 百分比的偏移。
- **四小时包络线：** 在 `H4EnvelopeTimeFrame` 上计算长度为 `H4EnvelopePeriod`
  的 SMA，并使用 ±`H4EnvelopeDeviation` 百分比的偏移。
- **滚动高低点：** 最近 `HighLowHours` 小时内的最高价与最低价（使用主时间框架数据）。

## 主要参数

| 参数 | 默认值 | 说明 |
| --- | --- | --- |
| `TriggerPips` | 38 | 触发价相对于交叉价的加减点数。 |
| `TrailingStopPips` | 90 | 移动止损距离（点），设为 0 表示关闭。 |
| `TakeProfit1Pips` | 210 | 第一目标获利点位，平掉半仓。 |
| `TakeProfit2Pips` | 280 | 第二目标获利点位，平掉剩余仓位。 |
| `FastMaPeriod` | 1 | 快速 EMA 的长度。 |
| `SlowMaPeriod` | 72 | 慢速 SMA 的长度。 |
| `StopLossLookback` | 4 | 用于确定初始止损的历史 K 线数量。 |
| `HighLowHours` | 10 | 计算滚动高低点所使用的小时数。 |
| `BlackoutHours` | 144 | 成交后进入冷却期的小时数，在此期间禁止开仓。 |
| `RsiLength` | 10 | RSI 计算长度。 |
| `RsiUpper` | 55 | 多头信号所需的最低 RSI 值。 |
| `RsiLower` | 45 | 空头信号允许的最高 RSI 值。 |
| `DailyEnvelopePeriod` | 24 | 日线包络线的 SMA 长度。 |
| `DailyEnvelopeDeviation` | 0.99 | 日线包络线的百分比偏移。 |
| `H4EnvelopePeriod` | 96 | 四小时包络线的 SMA 长度。 |
| `H4EnvelopeDeviation` | 0.1 | 四小时包络线的百分比偏移。 |
| `CandleType` | 1 小时 | 主工作时间框架。 |
| `RsiTimeFrame` | 1 小时 | 计算 RSI 使用的时间框架。 |
| `DailyEnvelopeTimeFrame` | 1 天 | 日线包络线使用的时间框架。 |
| `H4EnvelopeTimeFrame` | 4 小时 | 四小时包络线使用的时间框架。 |

## 交易逻辑

1. **交叉识别**
   - 记录最近三根已完成 K 线上的 EMA(1) 与 SMA(72) 数值。
   - 若 EMA 在前两根 K 线中的任意一根上向上穿越 SMA，生成多头候选信号。
   - 若 EMA 在前两根 K 线中的任意一根上向下穿越 SMA，生成空头候选信号。
   - 计算交叉价（快慢线的平均值），并启动两个主时间框架的触发窗口。

2. **触发条件**
   - 触发价 = 交叉价 ± `TriggerPips`（自动换算为价格单位）。
   - 多头要求在触发窗口内的任意一根 K 线最高价触及或突破触发价。
   - 空头要求最低价跌破触发价。

3. **过滤条件**
   - 当前无持仓且未处于冷却期。
   - RSI 滤波：多头需 RSI > `RsiUpper`；空头需 RSI < `RsiLower`。
   - 滚动高低点：多头收盘价必须超过滚动最高价；空头收盘价必须低于滚动最低价。
   - 包络线确认：多头收盘价需高于两个包络线的上轨；空头收盘价需低于两个包络线的下轨。

4. **下单与仓位管理**
   - 使用策略体积下市价单（默认 2 手，便于后续分批止盈）。
   - 初始止损：取 `StopLossLookback` 根之前的低点（多头）或高点（空头）。
   - 设置两个获利目标，用于逐步减仓。
   - 启动冷却计时，防止短时间内重复开仓。

5. **持仓处理**
   - 若启用移动止损，在价格走强时向盈利方向移动。
   - 到达第一目标时，平掉一半仓位并锁定部分利润。
   - 余下仓位在第二目标、止损或移动止损被触发时平仓。

## 风险控制

- 止损始终基于已完成的历史 K 线，避免噪音波动。
- 分级止盈机制有助于提前锁定收益。
- 移动止损确保在趋势延续时保护盈利。
- 冷却期限制策略在短时间内重复交易，贴近原始 EA 的逻辑。

## 其他说明

- 默认策略体积为 2，模拟原策略的双订单结构；可根据需求调整。
- MetaTrader 中的包络线前移功能在高层 API 中不可用，此处使用当前值进行近似。
- 需要正确设置标的的最小价格变动，以便准确换算点数。
