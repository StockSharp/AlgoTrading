# Стратегия Smart Trend Follower

## Обзор
**Smart Trend Follower** — порт на StockSharp советника MetaTrader 5 *Smart Trend Follower*. Исходный робот чередует
контртрендовое пересечение скользящих средних и трендовую модель с подтверждением стохастиком, а также наращивает позиции
по принципу мартингейла. В версии StockSharp сохранены все торговые идеи, но реализованы средствами высокоуровневого API
(подписки на свечи, связка индикаторов и рыночные заявки).

## Торговые сигналы
Режим работы выбирается параметром `SignalMode`:

1. **CrossMa** — повторяет контртрендовую схему. Если быстрая SMA пересекает медленную сверху вниз (текущее fast < slow, а
   на предыдущей свече fast > slow), стратегия открывает/усиливает длинную корзину. Обратное пересечение (fast > slow,
   ранее fast < slow) инициирует короткую корзину.
2. **Trend** — трендовый вариант. Длинный сигнал появляется при fast > slow, бычьей свече и значении стохастика %K ≤ 30.
   Короткий — при fast < slow, медвежьей свече и %K ≥ 70.

Условия оцениваются только по закрытым свечам. Если во время сигнала остаётся позиция противоположного направления, она
закрывается рыночным ордером до обработки новых сделок, что удерживает корзину в направлении актуального сигнала.

## Масштабирование позиций
Алгоритм полностью повторяет мартингейл оригинала:

- Первая сделка открывается объёмом `InitialVolume` лотов.
- Каждое дополнительное усреднение умножает предыдущий объём на `Multiplier` (значения ≤ 1 отключают рост лота).
- Новая заявка появляется только после смещения цены от лучшей цены входа (минимум для лонгов, максимум для шортов) минимум
  на `LayerDistancePips` пунктов.
- Объёмы нормализуются по `VolumeStep`, `VolumeMin` и `VolumeMax`, если биржевой инструмент предоставляет эти ограничения.

## Управление рисками
Для каждой корзины стратегия рассчитывает усреднённую цену входа и поддерживает общие цели:

- `TakeProfitPips` задаёт расстояние до цели фиксации прибыли. Лонги закрываются, когда максимум свечи достигает уровня,
  шорты — когда минимум касается своей цели. Ноль отключает тейк-профит.
- `StopLossPips` аналогично определяет защитный стоп. Лонги закрываются, если минимум свечи пробивает уровень, шорты — если
  максимум свечи превышает его. Ноль отключает жесткий стоп.

Выходы совершаются рыночными ордерами после того, как закрывшаяся свеча подтвердит достижение уровня. Флаги
`_longExitRequested` и `_shortExitRequested` предотвращают повторные заявки до прихода отчёта о сделке.

## Параметры
| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|------------------------|----------|
| `SignalMode` | enum (`CrossMa`, `Trend`) | `CrossMa` | Выбор источника сигналов (контртрендовый или трендовый режим). |
| `CandleType` | `DataType` | таймфрейм 30 минут | Основная свечная серия для расчётов и сигналов. |
| `InitialVolume` | decimal | `0.01` | Стартовый объём (в лотах) первой сделки в корзине. |
| `Multiplier` | decimal | `2` | Множитель объёма для каждого следующего усреднения. |
| `LayerDistancePips` | decimal | `200` | Минимальный отступ цены от лучшей сделки перед новым ордером. |
| `FastPeriod` | int | `14` | Период быстрой SMA. |
| `SlowPeriod` | int | `28` | Период медленной SMA (должен быть больше `FastPeriod`). |
| `StochasticKPeriod` | int | `10` | Базовый период стохастика %K. |
| `StochasticDPeriod` | int | `3` | Период сглаживания линии %D. |
| `StochasticSlowing` | int | `3` | Дополнительное сглаживание %K. |
| `TakeProfitPips` | decimal | `500` | Расстояние до тейк-профита в пунктах; `0` отключает. |
| `StopLossPips` | decimal | `0` | Расстояние до стоп-лосса в пунктах; `0` отключает. |

## Особенности реализации
- Размер пункта рассчитывается по `PriceStep` и количеству знаков (`Decimals`), что соответствует понятию point в MetaTrader
  (например, 0.0001 для пятизначных котировок).
- Для учёта сделок используются два списка `PositionEntry`, что имитирует тиковый учёт MT5; при обратных сделках позиции
  сокращаются по принципу FIFO.
- Индикаторы подключаются через `SubscribeCandles().BindEx(...)`; метод `GetValue` не используется, индикаторы не
  добавляются напрямую в `Strategy.Indicators`.
- В методе `OnStarted` вызывается `StartProtection()`, чтобы активировать стандартные защитные механизмы StockSharp.
- Поскольку StockSharp оперирует чистой позицией, перед открытием новой корзины противоположные позиции закрываются — это
  делает поведение предсказуемым и близким к оригинальному советнику.

## Файлы
- `CS/SmartTrendFollowerStrategy.cs` — реализация стратегии на C# с использованием высокоуровневого API StockSharp.

