# Стратегия Price Action Fractal

Стратегия является портом экспертного советника MetaTrader "PRICE_ACTION" на платформу StockSharp. Она сочетает фракталы Вильямса, линейно-взвешенные скользящие средние, индикатор Momentum и MACD, чтобы торговать подтверждённые ценовым действием пробои на выбранном таймфрейме.

## Идея

1. Анализируются только завершённые свечи – каждое решение принимается по цене закрытия выбранного периода.
2. В пятисвечном окне ищутся новые бычьи и медвежьи фракталы. Нижний фрактал показывает потенциальную поддержку, верхний – сопротивление.
3. Направление фильтруется двумя LWMA: для покупок быстрая средняя должна быть выше медленной, для продаж – ниже.
4. Проверяется сила импульса по абсолютному отклонению индикатора Momentum от базового уровня 100 на старшем периоде.
5. Дополнительный фильтр – MACD (по умолчанию 12/26/9). Для лонга основная линия должна быть выше сигнальной, для шорта – ниже.
6. Когда все фильтры совпадают, стратегия входит по направлению пробоя и сопровождает позицию фиксированным стопом, трейлинг-стопом и опциональным переносом в безубыток.

## Правила входа

- **Покупка**
  - На текущей свече сформирован новый нижний фрактал (паттерн из 5 свечей).
  - Быстрая LWMA &gt; медленной LWMA.
  - `abs(Momentum - 100)` &ge; `MomentumThreshold`.
  - Линия MACD &gt; сигнальной линии.
  - Объём рассчитывается из параметра `Volume` и ограничивается `MaxPositionUnits`.

- **Продажа**
  - На текущей свече сформирован новый верхний фрактал.
  - Быстрая LWMA &lt; медленной LWMA.
  - `abs(Momentum - 100)` &ge; `MomentumThreshold`.
  - Линия MACD &lt; сигнальной линии.

## Правила выхода

- Фиксированный стоп-лосс (`StopLossPoints`) и тейк-профит (`TakeProfitPoints`) в шагах цены.
- При включении трейлинг-стопа (`TrailingStopPoints`) позиция защищается по максимуму/минимуму после прохождения заданного расстояния.
- Перенос в безубыток: после достижения `BreakEvenTriggerPoints` стоп переносится на `EntryPrice ± BreakEvenOffsetPoints`.
- Закрытия выполняются рыночными заявками, свечные High/Low используются для проверки условий.

## Управление позицией

- Стратегия ведёт единую агрегированную позицию по инструменту.
- `Volume` задаёт базовый объём сделки. При развороте сначала закрывается встречная позиция, затем открывается новая.
- `MaxPositionUnits` ограничивает абсолютный размер позиции.

## Параметры

- `CandleType` – таймфрейм, на котором строятся индикаторы и принимаются решения (аналог переменной `T`).
- `FastMaPeriod` / `SlowMaPeriod` – периоды LWMA (`FastMA`, `SlowMA`).
- `MomentumPeriod` – длина расчёта Momentum (в оригинале 14).
- `MomentumThreshold` – минимальное отклонение от 100 (`Mom_Buy` / `Mom_Sell`).
- `MacdFastPeriod`, `MacdSlowPeriod`, `MacdSignalPeriod` – параметры MACD.
- `StopLossPoints`, `TakeProfitPoints` – дистанции стопа и тейка (`Stop_Loss`, `Take_Profit`).
- `TrailingStopPoints` – шаг трейлинг-стопа (`TrailingStop`).
- `BreakEvenTriggerPoints`, `BreakEvenOffsetPoints` – условия переноса в безубыток (`WHENTOMOVETOBE`, `PIPSTOMOVESL`).
- `FractalLifetime` – сколько свечей фрактал остаётся актуальным (`CandlesToRetrace`).
- `MaxPositionUnits` – лимит по абсолютному объёму (аналог `Max_Trades` в лотах).
- `EnableTrailing`, `EnableBreakEven`, `UseStopLoss`, `UseTakeProfit` – переключатели соответствующих механизмов выхода.

## Отличия от оригинального советника

- Не реализованы денежный тейк-профит, эквити-стоп и почтовые/Push уведомления.
- Алгоритмы оптимизации лота упрощены: используется нормализация объёма StockSharp.
- Вместо модификации отложенных ордеров применяются рыночные заявки – это соответствует архитектуре RiskManager в StockSharp.

## Файлы

- `CS/PriceActionFractalStrategy.cs` – реализация стратегии на C#.
- Python-версия пока отсутствует.
