# Стратегия ProtoType IX

## Обзор
ProtoType IX — конвертированная с MetaTrader 4 трендовая стратегия с несколькими фильтрами. Алгоритм отслеживает развороты Williams %R и подтверждает их расширением волатильности по индикатору ATR. Сделки открываются только тогда, когда ожидаемое соотношение прибыль/риск соответствует заданному порогу и присутствует подтверждённый пробой.

## Индикаторы и сигналы
- **Williams %R (настраиваемый период)** — фиксирует последние два экстремума, сформированные при выходе индикатора из зон перекупленности/перепроданности.
- **Average True Range (ATR)** — оценивает текущую волатильность. Пробой считается валидным, если расстояние между текущим и предыдущим экстремумом превышает `ATR × множитель`.

## Правила входа
1. Дождаться появления последних максимумов и минимумов, сформированных Williams %R.
2. Зафиксировать направление по Williams %R: выше верхнего порога — бычий уклон, ниже нижнего порога — медвежий.
3. Проверить структуру экстремумов через ATR:
   - Вверх — текущий максимум выше предыдущего максимума на величину `ATR × множитель`, и последний минимум выше предыдущего.
   - Вниз — текущий минимум ниже предыдущего минимума на `ATR × множитель`, и последний максимум ниже предыдущего.
4. Рассчитать потенциальное соотношение прибыль/риск исходя из текущей цены закрытия:
   - **Покупка**: цель = `max(последний максимум, предыдущий максимум)`; стоп = `max(последний минимум, предыдущий минимум)`.
   - **Продажа**: цель = `min(последний минимум, предыдущий минимум)`; стоп = `min(последний максимум, предыдущий максимум)`.
5. Сделка открывается, если `дистанция до тейк-профита / дистанция до стопа ≥ порога TP/SL` и цель превышает минимальное требование по спреду.

## Выход и сопровождение
- Сразу после открытия выставляются защитные стоп-лосс и тейк-профит, пересчитанные в шаги цены для защитных приказов StockSharp.
- После выдержки параметра `Zero Bar` включается ATR-трейлинг:
  - Длинные позиции — стоп подтягивается к `max(текущий стоп, закрытие − 2 × ATR)`.
  - Короткие позиции — стоп подтягивается к `min(текущий стоп, закрытие + 2 × ATR)`.

## Управление объёмом
Размер позиции определяется по величине счёта и параметру `Risk %`. Дистанция до стоп-лосса в шагах цены переводит допустимый риск в объём. Полученное значение нормализуется к шагу объёма инструмента и ограничивается `Max Order Size`.

## Параметры
| Название | Описание |
| --- | --- |
| Williams %R Period | Период индикатора Williams %R. |
| Criteria WPR | Абсолютный порог зон Williams %R. |
| ATR Period | Период индикатора ATR. |
| ATR Multiplier | Множитель ATR для валидации пробоя. |
| Zero Bar | Количество баров до включения ATR-трейлинга. |
| Min Target Spread | Минимальная дистанция цели в шагах спреда. |
| TP/SL Criteria | Минимально допустимое соотношение тейк/стоп. |
| Max Orders | Максимум одновременно открытых позиций. |
| Max Order Size | Верхний предел размера позиции. |
| Risk % | Процент риска для расчёта объёма. |
| Candle Type | Тип свечей для расчёта. |

## Примечания
- Стратегия рассчитана на один инструмент, но сохраняет многофакторную фильтрацию оригинального советника.
- Корректная работа защиты требует заполненных шагов цены и объёма инструмента.
- Если шаг цены или стоимость шага равны нулю, используются защитные значения по умолчанию, чтобы избежать деления на ноль.
