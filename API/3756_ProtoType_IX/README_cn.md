# ProtoType IX 策略

## 概述
ProtoType IX 是从 MetaTrader 4 专家顾问移植而来的多过滤趋势策略。算法利用 Williams %R 指标追踪最新的摆动高点和低点，并通过平均真实波幅（ATR）验证突破。当潜在的收益与风险比足够理想且突破得到确认时才会入场。

## 指标与信号
- **Williams %R（周期可调）**：跟踪超买/超卖区域的转折，记录指标离开极值区间时形成的最近两个摆动高点和摆动低点。
- **平均真实波幅（ATR）**：衡量当前波动性。只有当最新摆动与前一摆动之间的距离超过 `ATR × 系数` 时，突破才被视为有效。

## 入场条件
1. 等待最近的摆动高点和摆动低点都已经生成。
2. 根据 Williams %R 的位置确定方向：高于上阈值时保存看涨偏向，低于下阈值时保存看空偏向。
3. 使用 ATR 验证摆动结构：
   - 看涨趋势：最新摆动高点至少比前一摆动高点高 `ATR × 系数`，同时最新摆动低点高于前一摆动低点。
   - 看空趋势：最新摆动低点至少比前一摆动低点低 `ATR × 系数`，同时最新摆动高点低于前一摆动高点。
4. 以当前收盘价评估收益/风险比：
   - **多头**：目标价 = `max(最新摆动高点, 前一摆动高点)`；止损价 = `max(最新摆动低点, 前一摆动低点)`。
   - **空头**：目标价 = `min(最新摆动低点, 前一摆动低点)`；止损价 = `min(最新摆动高点, 前一摆动高点)`。
5. 仅在 `止盈距离 / 止损距离 ≥ TP/SL 阈值` 且目标距离大于最小点差要求时开仓。

## 出场与风控
- 下单后立即设置保护性止损和止盈，并按照价格步长转换为 StockSharp 的保护单。
- 当等待的 `Zero Bar` 根数结束后，启用 ATR 追踪止损：
  - 多头：新的止损价 = `max(当前止损, 收盘价 − 2 × ATR)`。
  - 空头：新的止损价 = `min(当前止损, 收盘价 + 2 × ATR)`。

## 仓位管理
头寸大小根据账户资金和 `Risk %` 参数计算。利用止损距离（以价格步长衡量）将允许的风险金额转换为下单量，并按照品种的交易步长归一化，最终被 `Max Order Size` 限制。

## 参数
| 名称 | 说明 |
| --- | --- |
| Williams %R Period | Williams %R 指标周期。 |
| Criteria WPR | 定义超买/超卖区间的绝对阈值。 |
| ATR Period | 平均真实波幅的周期。 |
| ATR Multiplier | 判定突破时使用的 ATR 系数。 |
| Zero Bar | 启用 ATR 追踪前需要等待的 K 线数量。 |
| Min Target Spread | 最小目标距离（以点差倍数表示）。 |
| TP/SL Criteria | 入场所需的最小止盈/止损比。 |
| Max Orders | 同时允许的最大持仓数。 |
| Max Order Size | 计算得到的下单量上限。 |
| Risk % | 仓位管理所使用的风险百分比。 |
| Candle Type | 用于计算的 K 线类型。 |

## 注意事项
- 策略聚焦于单一标的，但仍保留原始 EA 的多重过滤逻辑。
- 保护性订单依赖品种的价格步长，运行前请确认标的元数据已配置完整。
- 当交易步长或报价步值为 0 时，代码会使用合理的默认值以保持仓位计算稳定。
