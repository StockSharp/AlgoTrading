# Стратегия Pendulum

## Описание
**Pendulum Strategy** — порт MetaTrader-советника *Pendulum 1_01* на платформу StockSharp. Исходный советник удерживает пару встречных стоп-заявок и после каждого исполнения наращивает объём следующей заявки по принципу мартингейла. В данной реализации та же логика реализована через высокоуровневые методы StockSharp.

Основные идеи:

- На каждом завершённом баре возле текущей цены поддерживаются симметричные buy stop и sell stop заявки.
- После исполнения любая следующая заявка в том же направлении увеличивает объём согласно коэффициенту `VolumeMultiplier`.
- Позиция закрывается либо по локальному профиту в пунктах, либо при достижении глобальных уровней прибыли/убытка по счёту.

## Алгоритм работы
1. При запуске стратегия подписывается на основной таймфрейм (по умолчанию 15 минут) и, при необходимости, на дневные свечи. Диапазон дневной свечи определяет расстояние до стоп-заявок.
2. После закрытия каждой рабочей свечи выполняются действия:
   - Пересчёт контрольных уровней по капиталу.
   - Проверка локального тейк-профита для открытой позиции.
   - Вычисление расстояния до заявок из дневного диапазона или ручного значения и постановка/обновление стоп-заявок.
3. При исполнении стоп-заявки счётчик уровня для соответствующего направления увеличивается, и следующая заявка ставится с умноженным объёмом. Достигнув `MaxLevels`, стратегия прекращает ставить новые заявки в этом направлении до возврата позиции к нулю.
4. Глобальные пороги прибыли и убытка контролируются после каждой свечи; их пробитие приводит к полной ликвидации позиций и заявок.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --------------------- | -------- |
| `BaseVolume` | `decimal` | `0.1` | Объём первой стоп-заявки. |
| `VolumeMultiplier` | `decimal` | `2` | Во сколько раз увеличивается объём после каждого исполнения. |
| `MaxLevels` | `int` | `8` | Максимальное число исполнений в одном направлении. |
| `ManualStepPips` | `int` | `50` | Расстояние до заявок в пунктах при отсутствии дневных данных. |
| `UseDynamicRange` | `bool` | `true` | Использовать ли диапазон дневной свечи для расчёта шага. |
| `RangeFraction` | `decimal` | `0.2` | Доля дневного диапазона, становящаяся базовым шагом. |
| `TakeProfitPips` | `int` | `10` | Локальный тейк-профит в пунктах (0 — выключить). |
| `SlippagePips` | `int` | `3` | Дополнительный буфер, имитирующий настройки проскальзывания в MetaTrader. |
| `UseGlobalTargets` | `bool` | `true` | Включить глобальные уровни прибыли/убытка по капиталу. |
| `GlobalTakePercent` | `decimal` | `1` | Рост капитала в процентах, при котором закрываются все позиции. |
| `GlobalStopPercent` | `decimal` | `2` | Просадка капитала в процентах, вызывающая принудительное закрытие. |
| `CandleType` | `DataType` | `15m` | Таймфрейм для основной логики. |

## Примечания
- Объёмы автоматически подстраиваются под шаг и минимальные/максимальные значения инструмента.
- Цены заявок округляются к шагу цены, а небольшая толерантность помогает избежать лишних отмен.
- Глобальные уровни используют `Portfolio.CurrentValue` (или `BeginValue`, если текущее значение недоступно).
- При старте вызывается `StartProtection()` для включения встроенной защиты позиций.

## Отличия от MQL-версии
- Удалены графические подписи и таблицы расчётов, характерные для терминала MetaTrader.
- Глобальные уровни прибыли рассчитываются в процентах от капитала, что обеспечивает одинаковое поведение на разных брокерах.
- Вместо `OrderModify` используется отмена и повторная регистрация заявок через API StockSharp.
