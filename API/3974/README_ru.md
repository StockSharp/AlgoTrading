# Стратегия Natuseko Protrader 4H

## Обзор
Natuseko Protrader 4H — порт эксперта MetaTrader 4 *NatusekoProtrader4HStrategy* на платформу StockSharp. Алгоритм комбинирует три EMA,
осциллятор MACD, фильтрованный полосами Боллинджера, уровни RSI и Parabolic SAR, чтобы находить импульсные свечи на таймфрейме четыре
часа. Перенос воспроизводит логику отложенного входа после сильной свечи и блочную систему частичного закрытия позиций.

## Логика торговли
1. Подписка на свечи типа `CandleType` (по умолчанию 4H) и обработка только завершённых свечей.
2. Расчёт трёх EMA по ценам закрытия: быстрой, медленной и трендовой.
3. Построение MACD с параметрами оригинала, сглаживание главной линии SMA и наложение полос Боллинджера на значения MACD.
4. Расчёт RSI и Parabolic SAR; именно они задают условия входа и выхода.
5. Модель ищет бычью свечу, когда:
   - быстрая EMA выше медленной и трендовой;
   - RSI выше `RsiEntryLevel`, но ниже `RsiTakeProfitLong`;
   - главная линия MACD и её SMA расположены выше средней полосы Боллинджера;
   - тело свечи больше обоих хвостов (сильное закрытие в сторону тренда);
   - Parabolic SAR под ценой закрытия.
6. Медвежий сигнал зеркальный: порядок EMA обратный, RSI между `RsiTakeProfitShort` и `RsiEntryLevel`, MACD ниже средней полосы, медвежье
   тело и SAR над ценой.
7. Если свеча находится слишком далеко от трендовой EMA (`DistanceThresholdPoints`), стратегия фиксирует режим ожидания и ждёт возврата
   к быстрой EMA. Когда цена касается EMA и фильтры по RSI и SAR остаются в силе, выполняется отложенный вход (для шорта условия аналогичны).
8. При готовности стратегия закрывает противоположную позицию и открывает новую сделку объёмом `TradeVolume`. Стоп-лосс определяется SAR,
   если активирован `UseSarStopLoss`, иначе — трендовой EMA. Смещение `StopOffsetPoints` переводится в цену через шаг цены инструмента.
9. Управление открытым лонгом:
   - при пробое стоп-уровня позиция закрывается полностью;
   - после накопления прибыли не меньше `MinimumProfitPoints` возможен один частичный выход (50 %) по RSI (`RsiTakeProfitLong`) или по
     развороту SAR над ценой;
   - когда прибыль достаточна и RSI падает ниже `RsiEntryLevel`, оставшийся объём закрывается.
10. Для шортов используются симметричные правила с обратными порогами RSI и SAR.

## Управление позицией
- Частичное закрытие выполняется не более одного раза на сторону. После него стратегия ждёт условия полного выхода или срабатывания стопа.
- Стоп-цены пересчитываются на каждой свече по свежим значениям SAR/EMA, что соответствует логике MQL.
- При нулевой позиции внутренние флаги ожидания, ссылки на стопы и признак частичного выхода сбрасываются.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | 4H | Основной таймфрейм. |
| `TradeVolume` | `decimal` | `0.1` | Объём сделки. |
| `FastEmaPeriod` | `int` | `13` | Период быстрой EMA. |
| `SlowEmaPeriod` | `int` | `21` | Период медленной EMA. |
| `TrendEmaPeriod` | `int` | `55` | Трендовая EMA, используемая также для стопа и фильтра расстояния. |
| `MacdFastPeriod` | `int` | `5` | Быстрый период MACD. |
| `MacdSlowPeriod` | `int` | `200` | Медленный период MACD. |
| `MacdSignalPeriod` | `int` | `1` | Период сигнальной линии MACD. |
| `BollingerPeriod` | `int` | `20` | Длина выборки MACD для полос Боллинджера. |
| `BollingerWidth` | `decimal` | `1` | Множитель стандартного отклонения полос Боллинджера. |
| `MacdSmaPeriod` | `int` | `3` | Период SMA для сглаживания линии MACD. |
| `RsiPeriod` | `int` | `21` | Период RSI. |
| `RsiEntryLevel` | `decimal` | `50` | Центральный порог RSI. |
| `RsiTakeProfitLong` | `decimal` | `65` | RSI для частичного выхода из лонга. |
| `RsiTakeProfitShort` | `decimal` | `35` | RSI для частичного выхода из шорта. |
| `DistanceThresholdPoints` | `decimal` | `100` | Максимально допустимое расстояние (в пунктах) от цены до трендовой EMA. |
| `SarStep` | `decimal` | `0.02` | Шаг ускорения Parabolic SAR. |
| `SarMaximum` | `decimal` | `0.2` | Максимальное ускорение Parabolic SAR. |
| `UseSarStopLoss` | `bool` | `false` | Использовать ли SAR для расчёта стоп-лосса. |
| `UseTrendStopLoss` | `bool` | `true` | Использовать ли трендовую EMA в качестве стопа. |
| `StopOffsetPoints` | `int` | `0` | Дополнительное смещение стопа в пунктах. |
| `UseSarTakeProfit` | `bool` | `true` | Включить частичный выход по сигналу SAR. |
| `UseRsiTakeProfit` | `bool` | `true` | Включить частичный выход по RSI. |
| `MinimumProfitPoints` | `decimal` | `5` | Минимальная прибыль (в пунктах) для активации правил фиксации прибыли. |

## Отличия от оригинала
- В StockSharp используется нетто-позиция, поэтому перед разворотом стратегия закрывает текущее направление, имитируя MT4 с одним ордером.
- Управление рисками реализовано рыночными заявками, так как в StockSharp нет отдельного стопа на каждый ордер. Поведение (один частичный и
  окончательный выход) остаётся прежним.
- Расстояния и прибыли рассчитываются через `PriceStep`. Если у инструмента шаг цены не задан, используется значение 1 — в этом случае стоит
  скорректировать параметры под конкретный рынок.

## Рекомендации по использованию
- Подберите `TradeVolume` под спецификацию инструмента; конструктор дополнительно присваивает это значение свойству `Strategy.Volume`.
- Если сигналов слишком мало из-за большого отрыва цены от трендовой EMA, уменьшите `DistanceThresholdPoints` или обнулите его.
- Используйте график: стратегия рисует свечи, все три EMA, RSI, Parabolic SAR и MACD с полосами Боллинджера, что облегчает контроль переноса.
- Параметры MACD (5/200/1) полностью повторяют MQL-версию и дают очень сглаженный сигнал — перед реальной торговлей стоит провести оптимизацию.
