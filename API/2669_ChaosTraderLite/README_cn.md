# Chaos Trader Lite 策略

Chaos Trader Lite 策略使用 StockSharp 的高级 API 复刻了 Bill Williams 的“三个智者”入场模型。系统会在所选时间框架（默认 1 小时）的每根完结 K 线后执行判定，并在任意条件满足时挂出止损订单：

1. **第一智者——背离柱**：识别多头或空头背离 K 线，并要求价格与 Alligator 嘴唇线之间保持最小距离。
2. **第二智者——Awesome Oscillator 加速**：等待五个连续的 AO 数值显示动能正在增强。
3. **第三智者——分形突破**：确认两根之前形成的分形，并检查价格是否远离 Alligator 牙齿线，然后准备突破挂单。

出现做多信号时，策略会取消现有的卖出止损、平掉空头、在前一根 K 线高点上方一个最小跳动处挂出买入止损，同时记录防守止损位于该柱低点下方。做空信号执行完全对称的流程。每根新 K 线都会检查保存的止损价位，一旦被触及便以市价平仓。

## 指标与计算

- **Alligator 嘴唇**：对中位价进行 5 周期平滑移动平均（SMMA），并向前平移三根 K 线，通过队列保存以匹配 MetaTrader 的对齐方式。
- **Alligator 牙齿**：对中位价进行 8 周期 SMMA 并向前平移五根 K 线，作为第三智者的过滤条件。
- **Awesome Oscillator**：内置指标（中位价的 5 与 34 周期 SMA 差值）为第二智者提供动量序列。
- **分形**：检查位于当前柱左侧两个位置的 K 线，当其高点/低点高于（或低于）两侧各两根柱子时认定为有效分形。

## 交易流程

1. 订阅指定类型的蜡烛，并仅处理状态为 Finished 的 K 线。
2. 更新 Alligator 与 AO 指标，缓存平移后的结果。
3. 依次评估三个智者条件：
   - 背离柱需收于上半区（多头）或下半区（空头），且与嘴唇线的距离大于 `MagnitudePips * PriceStep`。
   - AO 加速要求五个值满足 `AO[1] > AO[2] > AO[3] > AO[4]` 且 `AO[4] < AO[5]`（空头条件为全体取反）。
   - 分形突破要求价格收在确认分形之上（或之下），并且超过 Alligator 牙齿加上距离阈值。
4. 当条件满足时，按体积 `Volume` 在高点上方一个跳动（或低点下方一个跳动）注册 `BuyStop` 或 `SellStop`，同时取消反向挂单并平掉反向持仓。
5. 维护追踪止损：多头仅上移，空头仅下移；若被新蜡烛突破，则立即以市价平仓。

## 参数

- `MagnitudePips` *(默认 10)* —— 背离柱与 Alligator 嘴唇之间的最小点差。
- `UseFirstWiseMan` *(默认 true)* —— 启用/禁用背离柱信号。
- `UseSecondWiseMan` *(默认 true)* —— 启用/禁用 AO 加速信号。
- `UseThirdWiseMan` *(默认 true)* —— 启用/禁用分形突破信号。
- `Volume` *(默认 0.01)* —— 止损订单的下单数量。
- `CandleType` *(默认 1 小时)* —— 策略使用的蜡烛类型。

## 备注

- 原始 MQL4 代码中的买卖价检查使用蜡烛收盘价近似实现。
- MetaTrader 的保证金和手数校验已省略，因为 StockSharp 在提交订单时会自行验证。
- 当出现新的反向信号时会取消对应挂单，以保持与原始 `CloseAll` 行为一致。
