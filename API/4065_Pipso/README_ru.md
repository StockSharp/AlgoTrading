# Стратегия Pipso

## Описание
Pipso — это ночная пробойная система, перенесённая из советника MetaTrader `Pipso.mq4`. Стратегия отслеживает максимум и минимум
предыдущих завершённых свечей и при выходе цены за эти границы немедленно переворачивает позицию: при обновлении максимума
закрываются лонги и открывается шорт, при пробое минимума закрываются шорты и открывается лонг. Дистанция защитного стопа
вычисляется исходя из ширины диапазона, благодаря чему стоп автоматически подстраивается под текущую волатильность.

## Алгоритм работы
1. Подписаться на выбранный таймфрейм (по умолчанию 15 минут) и дождаться формирования истории для индикаторов.
2. Для каждой новой завершённой свечи рассчитать максимальное и минимальное значение по предыдущим `BreakoutPeriod` свечам.
   Текущая свеча не попадает в расчёт, что повторяет вызов `iHighest(..., shift = 1)` в оригинальном коде.
3. Пересчитать расстояние до стоп-лосса как `(high - low) * StopLossMultiplier`, применяя ограничение `MinStopDistance` на
   минимально допустимую дистанцию.
4. Поддерживать торговое окно, заданное параметрами `SessionStartHour` и `SessionLengthHours`. Если окно переходит через ночь
   с пятницы на субботу, оно продлевается на 48 часов, чтобы сделки переживали выходные так же, как в MetaTrader.
5. При пробое верхней границы диапазона:
   - Закрыть все активные длинные позиции и, если торговля разрешена, открыть короткую позицию объёмом `OrderVolume`.
   - Установить защитный стоп выше цены входа на рассчитанное расстояние.
6. При пробое нижней границы диапазона:
   - Закрыть все активные короткие позиции и, если торговля разрешена, открыть длинную позицию объёмом `OrderVolume`.
   - Установить защитный стоп ниже цены входа на рассчитанное расстояние.
7. На каждой завершённой свече проверять защитные стопы. Если минимум свечи опускается ниже стопа лонга или максимум поднимается
   выше стопа шорта, позиция немедленно закрывается.

## Логика торговой сессии
- `SessionStartHour` задаёт час открытия окна в часах торговой площадки, продолжительность определяется `SessionLengthHours`.
- Если сумма `SessionStartHour + SessionLengthHours` превышает 24 часа и текущий день — пятница, конец окна переносится вперёд
  на двое суток, чтобы новые сделки стали доступны только в понедельник, как и в MQL4.
- Вне торгового окна стратегия только фиксирует существующие позиции, но не открывает новые до повторного входа в окно.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип свечей, используемых для расчёта сигналов. | Таймфрейм 15 минут |
| `OrderVolume` | Фиксированный объём рыночных заявок. | 1 |
| `SessionStartHour` | Час начала торгового окна. | 21 |
| `SessionLengthHours` | Продолжительность торгового окна в часах. | 9 |
| `BreakoutPeriod` | Количество завершённых свечей, формирующих пробойный диапазон. | 36 |
| `StopLossMultiplier` | Множитель диапазона для расчёта стоп-лосса (значение `3` соответствует исходному `SLpp = 300`). | 3 |
| `MinStopDistance` | Минимальная дистанция от цены входа до стопа, имитирующая брокерский StopLevel. | 0 |

## Примечания
- Стратегия работает только с рыночными заявками, целевой прибыли нет: выход осуществляется по стоп-лоссу или по встречному
  сигналу.
- При смене направления открывается одна рыночная заявка, которая одновременно закрывает старую позицию и открывает новую,
  повторяя последовательность `OrderClose` → `OrderSend` из исходного советника.
- На графике автоматически отображаются линии верхней и нижней границы диапазона, а также все совершённые сделки для удобного
  анализа.
