# Адаптивная стратегия Cyberia Trader

## Общее описание
**Адаптивная стратегия Cyberia Trader** — порт классического советника «CyberiaTrader» на платформу StockSharp. Стратегия
воссоздаёт исходное вероятностное ядро и дополняет его опциональными индикаторными фильтрами. Система непрерывно анализирует
динамику цены, оценивая вероятность разворота, после чего подтверждает сигнал фильтрами EMA, MACD, CCI, ADX либо
фракталами перед выставлением заявок.

## Вероятностный модуль
В основе стратегии лежит калькулятор вероятностей из оригинального MQL-советника. Он использует адаптивный период выборки
(`ValuePeriod`) и через фиксированные шаги просматривает историю свечей, классифицируя каждую выборку как:

* **Вероятность продажи** — бычья свеча после медвежьей выборки (потенциальный сигнал на контртренд).
* **Вероятность покупки** — медвежья свеча после бычьей выборки.
* **Неопределённость** — все остальные комбинации.

Для каждой группы стратегия накапливает среднюю амплитуду, число появлений и число «успешных» случаев. Количество
используемых данных задаётся формулой `ValuePeriod × HistoryMultiplier`. Адаптивный поиск перебирает периоды от `1` до
`MaxPeriod` (по умолчанию 23) и выбирает значение с наибольшей долей успешных исходов. Среди внутренних показателей:

* `BuyPossibility`, `SellPossibility`, `UndefinedPossibility` — значения для текущей свечи.
* `BuyPossibilityMid`, `SellPossibilityMid` и др. — скользящие средние, необходимые исходной логике.
* `PossibilityQuality`, `PossibilitySuccessQuality` — коэффициенты качества для диагностики и подбора периода.

При недостатке истории стратегия ожидает, пока модуль вероятностей не сформирует достоверную выборку.

## Индикаторные фильтры
Пользователь может включать дополнительные фильтры, как это делалось во входных параметрах советника:

* **EMA** — сравнение наклона EMA с периодом `MaPeriod` по двум последним свечам.
* **MACD** — проверка положения MACD относительно сигнальной линии (`MacdFast`, `MacdSlow`, `MacdSignal`).
* **CCI** — выявление зон перекупленности/перепроданности на основе `CciPeriod` и порогов ±100.
* **ADX** — анализ +DI и −DI (`AdxPeriod`) для определения доминирующего направления.
* **Фракталы** — поиск последнего фрактала на окне `FractalDepth` и блокировка заявок против него.
* **Детектор разворота** — инверсия разрешений, если текущая вероятность превышает среднее значение более чем в `ReversalIndex` раз.

Каждый фильтр включается отдельным флагом и полностью повторяет идеологию оригинальных `extern` переменных.

## Логика торговли
1. Подписаться на свечи типа `CandleType`.
2. На каждой закрытой свече пересчитать статистику и при необходимости подобрать новый период выборки.
3. Применить индикаторные фильтры и «киберийскую» логику для определения разрешённых направлений.
4. При активном сигнале открыть позицию, учитывая глобальные блокировки `BlockBuy` и `BlockSell`.
5. При заданных `StopLossPoints` или `TakeProfitPoints` активировать защиту в абсолютных пунктах.
6. Если решение становится `Unknown` и качество ухудшается, зафиксировать текущую позицию.

## Параметры
| Параметр | Описание |
| --- | --- |
| `CandleType` | Тип свечей для анализа. |
| `AutoSelectPeriod` | Включает адаптивный перебор периодов в диапазоне `1..MaxPeriod`. |
| `InitialPeriod` | Период выборки при отключённой адаптации. |
| `MaxPeriod` | Максимальный период, рассматриваемый при поиске (по умолчанию 23). |
| `HistoryMultiplier` | Количество выборок на один период. |
| `SpreadFilter` | Минимальный ход цены, чтобы считать вероятность «успешной». |
| `EnableCyberiaLogic` | Включает оригинальное дерево решений. |
| `EnableMa` / `EnableMacd` / `EnableCci` / `EnableAdx` / `EnableFractals` / `EnableReversalDetector` | Переключатели фильтров. |
| `MaPeriod` | Длина EMA в фильтре. |
| `MacdFast`, `MacdSlow`, `MacdSignal` | Настройки MACD. |
| `CciPeriod` | Период CCI. |
| `AdxPeriod` | Период ADX. |
| `FractalDepth` | Размер окна для поиска последнего фрактала (желательно нечётное ≥ 5). |
| `ReversalIndex` | Порог детектора разворота. |
| `BlockBuy`, `BlockSell` | Жёсткое запрещение открытия позиций в соответствующем направлении. |
| `TakeProfitPoints`, `StopLossPoints` | Абсолютные расстояния до тейк-профита и стоп-лосса. |

## Примечания
* Для корректной работы адаптивного поиска требуется минимум `ValuePeriod × HistoryMultiplier + ValuePeriod` закрытых свечей.
* Реализация использует высокоуровневые API StockSharp с привязкой индикаторов и комментариями на английском.
* Все статистики доступны внутри стратегии — при необходимости можно расширить логирование для углублённой диагностики.
