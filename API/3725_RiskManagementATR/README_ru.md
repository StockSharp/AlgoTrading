# Стратегия Risk Management ATR

## Обзор
Стратегия Risk Management ATR — это порт MetaTrader 5 эксперта *Risk Management EA Based on ATR Volatility* на платформу StockSharp. Оригинальный робот автоматически рассчитывал объём позиции исходя из баланса счёта и текущей волатильности, измеряемой индикатором Average True Range (ATR). В версии для StockSharp сохраняется тот же подход: стратегия открывает только длинные позиции при пересечении быстрой (10) и медленной (20) простых скользящих средних, причём объём каждой сделки подбирается так, чтобы возможный убыток по стоп-лоссу соответствовал заданному проценту риска.

Перенос выполнен с использованием высокоуровневого API StockSharp. Индикаторы подключены через `SubscribeCandles(...).Bind(...)`, что исключает прямые вызовы `iATR` и `iMA`. Управление сделкой реализовано через штатные методы `BuyMarket` и `SellStop`: после каждого исполнения защитный стоп снимается и перевыставляется с актуальным объёмом, поэтому нет рассогласования между позицией и защитной заявкой.

## Логика торговли
1. Подписаться на свечи типа `CandleType` и обрабатывать только завершённые (`Finished`) свечи.
2. Рассчитывать 14-периодный ATR и две простые скользящие средние с периодами 10 и 20 на тех же свечах.
3. Если быстрая SMA закрылась выше медленной и чистая позиция равна нулю, вычислить размер сделки с учётом выбранного риска и отправить рыночную заявку на покупку.
4. После исполнения определить расстояние до стоп-лосса: `ATR * AtrMultiplier`, если включён режим ATR, либо фиксированное число шагов цены при выключенном `UseAtrStopLoss`.
5. Округлить цену стопа вниз до ближайшего шага и выставить `SellStop` на текущий объём позиции, предварительно отменив прежний стоп.
6. Когда защитный стоп срабатывает и позиция закрывается, стратегия очищает внутреннее состояние и ждёт следующего сигнала пересечения скользящих.

## Управление рисками
- Параметр `RiskPercentage` задаёт долю стоимости портфеля, которую можно потерять в одной сделке. Стратегия берёт `Portfolio.CurrentValue` (или `BeginValue` в качестве резервного варианта) и умножает на процент риска, чтобы получить допустимую сумму убытка.
- Допустимый убыток делится на расстояние до стопа — так получается объём заявки. Затем объём приводится к сетке торгового инструмента с учётом `VolumeStep`, `MinVolume` и `MaxVolume`.
- Если `RiskPercentage` равен нулю, стратегия использует значение `Volume` (по умолчанию 1 лот), но защитный стоп всё равно создаётся автоматически.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | Таймфрейм 1 минута | Основная серия свечей, используемая стратегией. |
| `AtrPeriod` | `int` | `14` | Количество свечей в расчёте ATR. |
| `AtrMultiplier` | `decimal` | `2.0` | Множитель ATR для определения стоп-лосса. |
| `RiskPercentage` | `decimal` | `1.0` | Процент капитала, находящийся под риском в каждой сделке. 0 — фиксированный объём. |
| `UseAtrStopLoss` | `bool` | `true` | Включает режим стоп-лосса, зависящего от ATR. |
| `FixedStopLossPoints` | `int` | `50` | Количество шагов цены для фиксированного стопа, если ATR-режим отключён. |

## Отличия от оригинального эксперта
- В StockSharp используется нетто-позиция, поэтому стратегия отправляет только рыночные покупки, а выход из позиции осуществляется через защитный `SellStop`, что соответствует поведению MT5-версии после срабатывания стопа.
- Константа `_Point`, присутствующая в MetaTrader, заменена на `Security.PriceStep`. Если шаг цены недоступен, используется значение `1m` как резерв.
- Расчёт объёма учитывает торговые ограничения площадки (`VolumeStep`, `MinVolume`, `MaxVolume`), чтобы избежать отклонённых заявок.
- Обработка индикаторов выполняется событийно через механизм `Bind`, а не синхронными запросами к индикаторам, как в MQL.

## Рекомендации по использованию
- Убедитесь, что подключённый портфель возвращает корректное значение `CurrentValue`; без него риск-менеджмент не сможет посчитать объём и не будет торговать.
- Чтобы торговать фиксированным объёмом, установите `RiskPercentage` в ноль и заранее задайте желаемое `Volume`.
- Добавьте стратегию на график, чтобы видеть свечи, обе скользящие и исполненные сделки — так проще проверить корректность сигналов и размещения стопов.
- На более волатильных инструментах увеличьте `AtrMultiplier` или переключитесь на фиксированный стоп через `FixedStopLossPoints`, чтобы адаптировать стратегию к рыночным условиям.

## Индикаторы
- `AverageTrueRange` с периодом `AtrPeriod`.
- `SimpleMovingAverage` с периодом `10` (быстрая линия).
- `SimpleMovingAverage` с периодом `20` (медленная линия).
