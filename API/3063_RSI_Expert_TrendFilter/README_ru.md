# Стратегия RSI Expert Trend Filter

## Обзор
- Конверсия советника MetaTrader 5 **RSI_Expert_v2.0** на высокоуровневый API StockSharp.
- Сигналы формируются на выбранном параметре `CandleType` (по умолчанию 1 час) и исполняются по закрытию свечи.
- Используется неттинговый подход: стратегия управляет одной суммарной позицией и не поддерживает хеджирование несколькими ордерами, как в MT5.

## Логика входа
1. **Пересечение уровней RSI.** Лонг открывается, когда текущее значение RSI поднимается выше `RsiLevelDown`, а предыдущее закрытие находилось ниже. Шорт появляется, если RSI опускается ниже `RsiLevelUp` после нахождения выше порога.
2. **Фильтр скользящих средних.** Параметр `MaMode` повторяет варианты оригинала:
   - `Off` — торговля только по сигналам RSI без учета MA.
   - `Forward` — разрешить лонги лишь при нахождении быстрой MA выше медленной, шорты — когда она ниже.
   - `Reverse` — инвертировать фильтр, требуя противоположного расположения средних.

Позиция открывается только при одновременном выполнении обеих условий. При наличии активной позиции либо заявок новые сигналы игнорируются.

## Управление позицией
- Стоп-лосс и тейк-профит задаются в пунктах относительно `PriceStep`. Ноль отключает соответствующий уровень.
- При положительном `TrailingStopPips` стоп сопровождает цену после прохождения `TrailingStopPips + TrailingStepPips`. Шаг трейлинга должен быть строго больше нуля, иначе стратегия выбрасывает исключение.
- Включенный `UseMartingale` удваивает следующий объем после фиксации убытка (оценка по реализованному PnL). Прибыльный выход сбрасывает множитель.

## Управление капиталом
- `MoneyMode = FixedVolume` использует постоянное значение `VolumeOrRiskValue`.
- `MoneyMode = RiskPercent` трактует `VolumeOrRiskValue` как процент от капитала и рассчитывает объем по дистанции стоп-лосса. При отсутствии стопа значение используется напрямую.
- Объемы нормализуются под биржевые ограничения через `Security.MinVolume` и `Security.VolumeStep`.

## Дополнительные замечания
- Проверка стопов, целей и трейлинга выполняется на закрытых свечах, повторяя «работу на новом баре» из MQL.
- Флаг мартингейла обновляется по изменению реализованного PnL, поэтому учитываются и ручные закрытия.
- Неттинг означает отсутствие одновременных разнонаправленных позиций, что отличается от хеджевого режима MT5.

## Параметры
| Имя | Описание |
| --- | --- |
| `CandleType` | Таймфрейм для индикаторов и генерации сигналов. |
| `StopLossPips` | Дистанция стоп-лосса в пунктах; ноль отключает уровень. |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах; ноль отключает уровень. |
| `TrailingStopPips` | Размер трейлинг-стопа. Требует положительного `TrailingStepPips`. |
| `TrailingStepPips` | Дополнительные пункты перед очередным подтягиванием стопа. |
| `MoneyMode` | Выбор между фиксированным объемом и расчетом по риску. |
| `VolumeOrRiskValue` | Лот для фиксированного режима или процент риска при `RiskPercent`. |
| `UseMartingale` | Включает удвоение объема после убыточной сделки. |
| `FastMaPeriod` | Период быстрой скользящей средней. |
| `SlowMaPeriod` | Период медленной скользящей средней. |
| `RsiPeriod` | Период расчета RSI. |
| `RsiLevelUp` | Верхний порог RSI для коротких сигналов. |
| `RsiLevelDown` | Нижний порог RSI для длинных сигналов. |
| `MaMode` | Режим подтверждения скользящими средними. |
