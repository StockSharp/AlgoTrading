# Стратегия Freeman ATR MA RSI Grid

## Общее описание
Стратегия переносит советника MetaTrader «freeman» на высокоуровневый API StockSharp. Она наращивает сетку рыночных позиций, пока направление, заданное наклоном скользящей средней, подтверждается фильтром RSI. Все расстояния до входов и выходов задаются в пунктах и автоматически переводятся в ценовые значения через минимальный шаг цены инструмента, что позволяет воспроизвести поведение оригинальной форекс-версии.

## Логика торговли
1. Подписка на один поток свечей (настраиваемый таймфрейм) и обновление индикаторов ATR, MA и RSI на каждой закрытой свече.
2. Формирование торгового сигнала при выполнении условий:
   - Наклон скользящей средней положительный или отрицательный по сравнению с предыдущей свечой (опциональный трендовый фильтр).
   - Цена находится на заданном расстоянии от скользящей средней, чтобы избежать входов непосредственно на линии.
   - RSI пересекает верхний или нижний порог, если включён фильтр RSI. Полностью сохранена оригинальная логика MetaTrader, включая особенность, когда сигнал на продажу возвращает `-11`, поэтому одновременное включение обоих фильтров приводит к преимущественному открытию длинных позиций.
3. Соблюдение максимального количества одновременно открытых позиций. Дополнительные входы по направлению выполняются только если цена ушла против последней сделки на требуемое количество пунктов, что создаёт сетку усреднений.
4. Каждая сделка получает стоп-лосс и тейк-профит, рассчитанные на основе ATR. Трейлинг-стоп подтягивает защитный уровень после прохождения ценой суммы «трейлинг + шаг трейлинга».
5. Выход осуществляется рыночной встречной заявкой при достижении свечой стоп-уровня, цели или обновлённого трейлинг-стопа.

## Управление рисками
- Множители ATR определяют фиксированный стоп-лосс и тейк-профит. Значение `0` отключает соответствующий уровень.
- Трейлинг-стоп настраивается двумя параметрами в пунктах: собственно расстоянием и дополнительным шагом перед очередным переносом стопа.
- Для расчёта объёма используется базовое свойство `Volume`; автоматическое управление капиталом не применяется, кроме ограничения по количеству позиций.

## Параметры
| Название | Описание |
| --- | --- |
| `CandleType` | Таймфрейм свечей для расчёта индикаторов. |
| `MaxPositions` | Максимальное суммарное количество открытых длинных и коротких позиций. |
| `DistancePips` | Минимальное расстояние в пунктах между последовательными входами в одном направлении. |
| `AtrPeriod` | Период усреднения индикатора ATR. |
| `AtrStopLossMultiplier` | Множитель ATR для стоп-лосса. `0` отключает стоп. |
| `AtrTakeProfitMultiplier` | Множитель ATR для тейк-профита. `0` отключает цель. |
| `UseTrendFilter` | Включение трендового фильтра по скользящей средней. |
| `DistanceFromMaPips` | Минимальное расстояние между ценой и MA при активном трендовом фильтре. |
| `MaPeriod`, `MaShift`, `MaMethod`, `MaPriceType` | Настройки скользящей средней, соответствующие параметрам советника в MetaTrader. |
| `UseRsiFilter` | Включение фильтра RSI. |
| `RsiLevelUp`, `RsiLevelDown`, `RsiPeriod`, `RsiPriceType` | Параметры RSI и тип используемой цены. |
| `TrailingStopPips`, `TrailingStepPips` | Расстояние и шаг трейлинг-стопа в пунктах. |
| `CurrentBarOffset` | Смещение при чтении значений индикаторов, аналог параметра `CurrentBar` в советнике. |

## Примечания
- Перевод пунктов в цену умножает `PriceStep` на 10 для инструментов с 3 или 5 знаками после запятой, что повторяет корректировку point→pip в MetaTrader.
- Используется неттинговая модель: при появлении обратного сигнала текущая позиция закрывается и только потом открывается позиция нового направления.
- В `OnStarted` активируется `StartProtection`, чтобы защитить открытую позицию от внезапных переподключений до начала торговли.
