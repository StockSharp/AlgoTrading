# Macd Pattern Trader All v0.01
[English](README.md) | [中文](README_cn.md)

Стратегия воспроизводит эксперта MetaTrader "MacdPatternTraderAll v0.01". Она запускает шесть независимых паттернов входа на основе MACD на одном и том же потоке свечей, управляет рисками адаптивными стоп-лоссами и тейк-профитами, выполняет поэтапную фиксацию прибыли и по желанию использует мягкий мартингейл после убыточных серий.

## Ключевые особенности

- **Шесть паттернов MACD** – каждый модуль (`Pattern1` … `Pattern6`) имеет собственные периоды EMA и пороговые уровни. Любой паттерн можно отключить.
- **Динамические уровни риска** – стоп определяется по недавним экстремумам с заданным отступом, тейк-профит сканирует последовательные блоки баров, повторяя оригинальную реализацию MQL.
- **Торговые сессии** – при включённом `UseTimeFilter` сделки совершаются только между `StartTime` и `StopTime`.
- **Частичные выходы** – прибыльные позиции сокращаются в два этапа, когда условия EMA/SMA подтверждают импульс (логика `ActivePosManager`).
- **Медленный мартингейл** – при `UseMartingale = true` объём следующей сделки удваивается после убыточного цикла и возвращается к базовому после прибыльного.

## Логика входов по паттернам

1. **Pattern 1 (`Pattern1`)** – шорт активируется после выхода MACD выше `Pattern1MaxThreshold` и формирования понижающейся вершины. Лонг появляется при зеркальной ситуации ниже `Pattern1MinThreshold`.
2. **Pattern 2 (`Pattern2`)** – отслеживает колебания около нуля. Шорт возникает, когда положительный импульс затухает у уровня `Pattern2MinThreshold`; лонг – когда отрицательный импульс ослабевает возле `Pattern2MaxThreshold`. Проверка амплитуды воспроизводит сравнение `valueMin2` / `valueCurr2` из MQL.
3. **Pattern 3 (`Pattern3`)** – собирает до трёх последовательных вершин/впадин MACD для формирования "тройного крюка". Сделка разрешается только при выполнении всех порогов (`Pattern3MaxThreshold`, `Pattern3MaxLowThreshold`, `Pattern3MinThreshold`, `Pattern3MinHighThreshold`).
4. **Pattern 4 (`Pattern4`)** – реагирует на выбросы MACD за пределы `Pattern4MaxThreshold` / `Pattern4MinThreshold` с последующими неудачными попытками обновить экстремум. Счётчик `Pattern4AdditionalBars` сохранён для совместимости.
5. **Pattern 5 (`Pattern5`)** – реализует пробой нейтральной зоны советника: сначала возврат из экстремума в нейтральную область (`Pattern5MinNeutralThreshold` или `Pattern5MaxNeutralThreshold`), затем повторный разворот.
6. **Pattern 6 (`Pattern6`)** – считает число подряд идущих баров выше/ниже порогов. После нахождения дольше `Pattern6TriggerBars` в зоне перекупленности/перепроданности и возврата за уровень открывается сделка, если ограничитель `Pattern6MaxBars` не блокировал сигнал.

Все паттерны вызывают `TryOpenLong` / `TryOpenShort`, что гарантирует расчёт стопа и цели до отправки заявки.

## Управление риском и позициями

- **Стоп-лосс**: `CalculateStopPrice` анализирует последние `stopBars` закрытых свечей (без текущей) и добавляет заданный `offset`. Для инструментов с 3/5 знаками производится корректировка как в MQL-версии.
- **Тейк-профит**: `CalculateTakeProfit` последовательно просматривает блоки по `takeBars` свечей, пока не перестанет находить новые экстремумы, полностью повторяя цикл `iLowest` / `iHighest`.
- **Частичное закрытие**: `ManageActivePositions` закрывает треть позиции при прибыли больше `ProfitThreshold` и подтверждении `ema2`, затем половину остатка при достижении `(sma3 + ema4) / 2`.
- **Жёсткие выходы**: `CheckRiskManagement` отправляет рыночные ордера при достижении зафиксированных уровней стопа или тейк-профита.
- **Мартингейл**: `OnOwnTradeReceived` копит реализованную прибыль/убыток за цикл. После выхода в ноль `AdjustVolumeOnFlat` либо сбрасывает объём на `InitialVolume`, либо удваивает его при убытке (если `UseMartingale` включён).

## Параметры

Все настройки представлены через `StrategyParam<T>` для оптимизации в StockSharp Designer.

- **Общие**: `CandleType`, `InitialVolume`, `UseTimeFilter`, `StartTime`, `StopTime`, `UseMartingale`.
- **Паттерны 1–6**: количество баров для стопа/тейка, отступы, периоды MACD и пороги, совпадающие с `extern` переменными советника.
- **Менеджер позиции**: периоды EMA/SMA (`EmaPeriod1`, `EmaPeriod2`, `SmaPeriod3`, `EmaPeriod4`).

Значения по умолчанию полностью совпадают с настройками `MacdPatternTraderAll v0.01`.

## Рекомендации

- Инструмент должен иметь корректные `PriceStep` и `Decimals`, иначе расчёт уровней будет неточным.
- Задайте поток свечей через `CandleType` (например, `TimeSpan.FromMinutes(5).TimeFrame()`).
- Если несколько паттернов срабатывают одновременно, откроется только одна позиция: каждый вызов пересчитывает общий объём и очищает противоположные уровни.
- Частичные выходы работают с агрегированной позицией, поэтому фиксация происходит даже при совпадающем направлении сигналов от разных паттернов.

