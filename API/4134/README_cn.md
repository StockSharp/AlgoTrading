# 账户货币止盈止损策略

## 概述

本策略是 MetaTrader 4 专家顾问 **`sltp-currency.mq4`** 的 StockSharp 移植版本。原始脚本不会主动开仓，而是监控当前品种的所有持仓，当浮动收益达到预设的盈利金额或亏损金额时立即平仓。所有阈值直接用账户货币表示，而不是以点数为单位。C# 版本延续了这一思想，可为手动或其他策略开立的头寸提供自动化的货币化风控。

## 核心行为

1. **实时跟踪自身成交。** 每笔成交都会更新内部的持仓列表。每个条目记录方向、成交量以及成交价，从而忠实再现 MetaTrader 中“单笔订单”的概念。
2. **以账户货币计算浮盈浮亏。** 策略订阅 Level1 报价以获取最新买卖价。通过证券的 `PriceStep` 与 `StepPrice`，将价格差转换为账户货币金额，并按持仓逐一计算。
3. **独立处理平仓。** 多头在达到盈利目标或触及亏损阈值时提交卖出市价单；空头则提交买入市价单。平仓量始终等于该笔持仓剩余量，不会影响其他持仓。
4. **逐单跟踪平仓订单。** 每个平仓请求都会记录对应的订单对象，直到其完成。若出现部分成交，则剩余仓位会被逐渐削减；若订单失败或被撤销，则解除锁定，允许下一次报价再次尝试。
5. **不负责开仓。** 策略本身不会产生任何入场信号，可与其它入场策略组合使用，或在 Designer 中手动下单，所有成交都会被该策略捕获并保护。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `TakeProfitCurrency` | 单笔持仓达到该盈利金额（账户货币）时立即平仓。设为 `0` 可关闭止盈。 | `5` |
| `StopLossCurrency` | 单笔持仓浮亏超过该金额（账户货币）时强制平仓。设为 `0` 可关闭止损。 | `8` |

两个参数均通过 `StrategyParam<decimal>` 暴露在 UI 的 **Risk** 分组中，并标记为可优化。

## 执行流程

- **启动阶段。** 在 `OnStarted` 中调用 `SubscribeLevel1()` 订阅报价，`OnReseted` 重置所有缓存和集合。
- **成交记录。** `OnNewMyTrade` 在每笔成交后刷新持仓列表：新建仓会生成新的条目，平仓成交会减少或移除相应条目。
- **盈亏评估。** 每次收到 Level1 报价都会重新计算所有持仓的浮盈浮亏——多头使用买价，空头使用卖价。比较结果时始终以账户货币为准，无需任何技术指标。
- **平仓流程。** 一旦触发阈值即调用 `BuyMarket()` 或 `SellMarket()`，平掉该条目的剩余仓位。借助 `_closingOrders` 字典以及 `OnOrderRegisterFailed` / `OnOrderChanged` 覆写方法，策略能够处理报单失败、撤单或部分成交等情况。

## 使用注意事项

- 请确保数据源提供买卖价（或至少最新成交价），否则无法计算浮盈浮亏。
- 策略只会响应自身提交的订单。若希望保护外部持仓，请通过该策略实例执行下单操作，例如在 Designer 中连接该策略并由它代为报单。
- 盈亏阈值逐单评估，不同价位的多笔仓位会独立处理，不会做统一汇总。
- 将某个阈值设为 0 可禁用对应逻辑，例如只保留止损而允许利润继续运行。

## 文件

- `CS/CurrencyStopLossTakeProfitStrategy.cs` – C# 实现代码。
- `README.md` – 英文说明。
- `README_cn.md` – 本文档。
- `README_ru.md` – 俄文说明。

## 与 MetaTrader 版本的差异

- MT4 脚本会遍历终端中所有订单，而 StockSharp 版本仅关注本策略产生的成交，以保证回测与实盘行为一致。
- 为了贴近 MT4 的市值计算方式，本策略优先使用买/卖价来估算浮盈浮亏，仅在缺少双边报价时才退化为最新成交价。
- C# 实现会显式跟踪平仓订单，以便处理部分成交或失败的情况；而 MT4 中的 `OrderClose` 调用是同步的，不需要额外的状态管理。
