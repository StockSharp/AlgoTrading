# Currency Stop Loss Take Profit Strategy

## Overview

This strategy is a StockSharp port of the MetaTrader 4 expert advisor **`sltp-currency.mq4`**. The original script does not open positions by itself; instead, it watches all active trades on the current symbol and closes them when either a monetary take-profit or stop-loss threshold is reached. The thresholds are expressed directly in the deposit (account) currency rather than in pips. The C# version keeps the same idea and acts as an automated risk manager for positions that are opened manually or by another strategy.

## Core behaviour

1. **Continuous monitoring of own trades.** Every fill generated by the strategy updates an internal ledger of open lots. Each lot stores the entry direction, executed volume and entry price.
2. **Account-currency PnL calculations.** The strategy subscribes to Level1 data to obtain the latest bid/ask prices. Using the instrument's `PriceStep`/`StepPrice`, unrealised profit or loss is translated into account currency on a per-lot basis.
3. **Independent exit handling.** When a long lot earns at least the configured take-profit amount, or loses more than the stop-loss allowance, a market sell order for the remaining volume of that lot is submitted. Short lots are handled symmetrically using market buy orders.
4. **One order per lot.** A closing request is tracked until the order finishes. Partial fills progressively shrink the tracked lot, and failed/cancelled orders reset the exit request so it can be re-sent on the next evaluation.
5. **No automated entries.** The strategy never opens new positions on its own. Users can combine it with external entry logic or send manual orders through StockSharp — the fills will be captured and protected automatically.

## Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `TakeProfitCurrency` | Monetary profit per position (in account currency) that triggers a full exit. Set to `0` to disable the take-profit logic. | `5` |
| `StopLossCurrency` | Maximum acceptable floating loss per position (in account currency) before the strategy forcefully exits. Set to `0` to disable the stop-loss logic. | `8` |

Both parameters are exposed as `StrategyParam<decimal>` values, are included in the **Risk** group inside the UI, and are marked as optimisable.

## Execution flow

- **Start-up.** `SubscribeLevel1()` is used to receive bid/ask updates. Internal caches and collections are reset inside `OnReseted`.
- **Trade tracking.** `OnNewMyTrade` rebuilds the list of open lots after every fill. New entries create fresh lots, while closing trades shrink or remove existing ones.
- **PnL evaluation.** Each Level1 update recalculates unrealised results for longs (using the bid) and shorts (using the ask). Profit and loss thresholds are compared in account currency without relying on indicator values.
- **Exit orchestration.** When a threshold is hit the strategy calls `BuyMarket()` or `SellMarket()` with the exact remaining volume of the lot. Failures, cancellations or partial fills are handled through `_closingOrders` and the overrides `OnOrderRegisterFailed` / `OnOrderChanged`.

## Usage notes

- Ensure that Level1 data (bid/ask or last trade price) is available; otherwise, unrealised PnL cannot be evaluated.
- The strategy only reacts to orders submitted by itself. To protect positions opened elsewhere, route the trades through this strategy instance (for example, by delegating entries to it or by using the Designer runner).
- Because monetary thresholds are evaluated per lot, differing entry prices are handled independently. There is no aggregation of PnL across multiple trades.
- Set a threshold to zero if you want to disable that side of the protection (e.g., let winners run but cap the downside).

## Files

- `CS/CurrencyStopLossTakeProfitStrategy.cs` – main C# implementation.
- `README.md` – this document.
- `README_cn.md` – Simplified Chinese translation.
- `README_ru.md` – Russian translation.

## Differences from the MetaTrader version

- The StockSharp implementation observes only the strategy's own trades, while the MT4 expert scans the terminal-wide order pool. In StockSharp, this keeps the behaviour deterministic and reproducible during backtests.
- Bid/ask prices are preferred over a single close price to emulate MT4's mark-to-market rules (longs evaluated at bid, shorts at ask). When only the last trade price is available it is used as a fallback.
- Exit orders are tracked to handle partial fills and retry logic; the MT4 script simply calls `OrderClose` and relies on the platform to finish the request synchronously.
