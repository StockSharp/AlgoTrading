# Стратегия Test Chart Event

## Обзор
**Test Chart Event Strategy** — порт скрипта MQL4 `Test_ChartEvent.mq4` на C#. Оригинальная версия демонстрировала работу событий графика MetaTrader: создание объектов, реакции на клавиатуру и мышь, отправку пользовательских событий. Перенос для StockSharp сохраняет учебный акцент: кнопки эмулируются, события таймера воспроизводятся, перемещения мыши моделируются внутри потока стратегии. Торговые заявки не выставляются — весь функционал предназначен для демонстрации обработки событий.

## Основное поведение
- **Создание виртуальных кнопок.** На виртуальном холсте случайным образом размещаются две кнопки (зелёная и жёлтая). Первая по умолчанию считается выбранной, чтобы команды перемещения имели цель.
- **Эмуляция клавиатуры.** После закрытия каждой свечи стратегия случайным образом решает, имитировать ли нажатие клавиши. Направления полностью повторяют логику стрелок/NumPad из MQL. Позиции объектов ограничены размерами холста, поэтому кнопки не выходят за границы.
- **Пользовательские события таймера.** В MQL событие генерировалось каждые 60 секунд. Здесь ту же роль выполняет каждая завершённая свеча. Случайно выбирается идентификатор (0, 1 или broadcast), что моделирует вызов `EventChartCustom`. Для broadcast-события журнал фиксирует доставку сразу на несколько «графиков».
- **Режим мыши.** Стратегия периодически включает режим перемещения мышью, имитируя нажатие `M`. После включения фиксируется точка нажатия, а следующая свеча даёт точку отпускания. Если перемещение длится достаточно долго и смещение превышает порог, выводится подробный отчёт о траектории и ценовом диапазоне. Иначе событие игнорируется так же, как и в функции `IsMoved` оригинала.
- **Сообщения помощи и информации.** Первая обработанная свеча автоматически выводит подсказки и сведения об объектах, что соответствует нажатию клавиш `H` и `I` в скрипте MQL.

## Параметры
| Параметр | Описание | Значение по умолчанию | Примечание |
| --- | --- | --- | --- |
| `LogLevel` | Уровень подробности сообщений (0 = тихий режим, 1 = ключевые действия, 2 = расширенный лог). | 1 | При 2 отображаются координаты нажатия мыши и дополнительные детали. |
| `MoveStep` | Количество пикселей, на которое сдвигается объект за один «нажим». | 10 | Совпадает со значением `m_step` в `CObjectMan`. |
| `CanvasWidth` | Ширина виртуального холста (в пикселях). | 640 | Используется для ограничения перемещений по горизонтали. |
| `CanvasHeight` | Высота виртуального холста (в пикселях). | 360 | Используется для ограничения перемещений по вертикали. |
| `CandleType` | Тип свечей, который играет роль таймера. | Таймфрейм 1 минута | Можно выбрать любой тип свечей при запуске. |

Все параметры оформлены через `StrategyParam<T>`, поэтому их можно менять из UI StockSharp или задействовать в оптимизации.

## Ход выполнения
1. **Запуск.** В `OnStarted` создаются кнопки, оформляется подписка на свечи и выводится сообщение о будущей подсказке.
2. **Первая свеча.** После закрытия первой свечи печатаются подсказки и информация об объектах — аналог клавиш `H` и `I`.
3. **Основной цикл.** Каждая завершённая свеча:
   - Генерирует одно из трёх пользовательских событий и сообщает его идентификатор.
   - При необходимости сдвигает выбранную кнопку в соответствии с эмулированным направлением.
   - Периодически переключает выбранный объект между зелёной и жёлтой кнопками.
   - Обрабатывает автомат «мыши»: включение → фиксация нажатия → отпускание, с проверкой длительности и смещения.
4. **Остановка.** `OnStopped` сбрасывает эмулятор мыши, чтобы не оставалось активного режима.

## Уровни логирования
- **0:** только системные сообщения платформы.
- **1:** основные события — пользовательские идентификаторы, перемещения объектов, смена выбранной кнопки, удачные перетаскивания.
- **2:** дополнительные детали — координаты нажатия, игнорированные попытки перетаскивания и пр.

## Особенности реализации
- Класс `MouseEventEmulator` воспроизводит логику функций `MouseEventUse`, `MouseMove` и `IsMoved`; пороги 460 мс и 3 пикселя сохранены без изменений.
- `ChartButton` отвечает за случайную инициализацию, ограничение перемещений и форматированный вывод состояния (аналог `CObjectMan`).
- В роли таймера выступает поток свечей, поэтому стратегия не создаёт дополнительных потоков и не требует синхронизации.
- Комментарии в коде даны на английском языке в соответствии с правилами репозитория, а подробное описание присутствует в README.

## Отличия от MQL-версии
- StockSharp не получает прямых событий клавиатуры/мыши, поэтому взаимодействие моделируется случайными значениями. Цель — демонстрация логики через журнал.
- В коде нет фактического рисования объектов на графике, однако координаты и цвета фиксируются в сообщениях.
- Период таймера теперь определяется выбранным типом свечей. Таймфрейм 1 минута повторяет исходные 60 секунд.

## Использование
1. Добавьте стратегию в решение StockSharp и выберите нужный инструмент.
2. При необходимости измените параметры (размер холста, шаг перемещения и т.д.).
3. Запустите стратегию в режиме эмуляции или тестирования и отслеживайте журнал событий.
4. Остановите стратегию — все внутренние состояния будут сброшены, а заявок и позиций не останется.

Документ содержит все подробности, необходимые для изучения обработки событий графика в экосистеме StockSharp.
