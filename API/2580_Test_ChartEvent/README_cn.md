# 测试图表事件策略

## 概览
**测试图表事件策略** 是对 MQL4 脚本 `Test_ChartEvent.mq4` 的 C# 版本。原始脚本通过创建图表对象、响应键盘和鼠标事件并触发自定义事件，展示了 MetaTrader 图表事件的工作方式。本移植版本在 StockSharp 中重现了同样的教学目的：模拟按钮对象、复制基于定时器的自定义事件以及鼠标拖拽会话，且全部逻辑都在策略线程中执行，不会发送任何真实交易指令。

## 核心行为
- **虚拟按钮创建。** 在虚拟图表画布上随机放置两个按钮（绿色与黄色）。第一个按钮默认被选中，以便后续的移动命令有明确目标。
- **键盘移动仿真。** 每根完成的 K 线都会随机决定是否模拟一次键盘按键。触发后，水平与垂直方向标志与原 MQL 脚本中方向键/数字键盘的逻辑一致，按钮位置会被限制在画布范围内。
- **自定义定时器事件。** 原脚本每 60 秒触发一次定时器事件。本策略改为在每根完成的 K 线后触发，并随机选择事件编号（0、1 或广播），以日志形式展示 `EventChartCustom` 的使用。广播事件会遍历随机数量的“伪图表”来模拟分发效果。
- **鼠标模式。** 策略周期性地模拟按下 `M` 键开启鼠标移动模式。启用后会记录一次鼠标按下坐标，并在随后某根 K 线完成时生成松开坐标。若移动持续时间和位移达到阈值，则打印拖拽路径及对应价格区间，否则与原 `IsMoved` 一样忽略该事件。
- **帮助与信息输出。** 在处理第一根 K 线时自动打印帮助信息与按钮状态，等同于原脚本中按下 `H` 与 `I` 键的效果。

## 参数
| 参数 | 说明 | 默认值 | 备注 |
| --- | --- | --- | --- |
| `LogLevel` | 日志详细程度（0 = 静默，1 = 关键动作，2 = 完整细节）。 | 1 | 较高等级会显示鼠标按下坐标与更详细的事件跟踪。 |
| `MoveStep` | 每次模拟按键时移动的像素数。 | 10 | 对应原脚本 `CObjectMan` 类中的 `m_step`。 |
| `CanvasWidth` | 虚拟画布宽度（像素）。 | 640 | 用于限制按钮的水平范围。 |
| `CanvasHeight` | 虚拟画布高度（像素）。 | 360 | 用于限制按钮的垂直范围。 |
| `CandleType` | 用作“定时器”的 K 线类型。 | 1 分钟时间框架 | 运行策略时可自由切换任意 K 线类型。 |

所有参数均通过 `StrategyParam<T>` 暴露，可在 StockSharp 界面中直接调整或用于优化。

## 执行流程
1. **启动。** `OnStarted` 创建按钮、订阅 K 线，并提示帮助信息会自动打印。
2. **首根 K 线。** 第一根完成的 K 线会输出帮助文本与按钮状态，模拟原脚本中的 `H` 与 `I` 按键。
3. **循环处理。** 每根完成的 K 线依次执行：
   - 触发三种自定义事件之一并记录事件编号。
   - 根据随机结果移动当前选中按钮。
   - 偶尔切换当前选中按钮。
   - 执行鼠标状态机（启用 → 按下 → 松开），若满足持续时间与位移阈值则输出拖拽信息。
4. **停止。** `OnStopped` 重置鼠标仿真器，避免残留状态。

## 日志等级
- **等级 0：** 仅保留框架级别消息，适合关注性能时使用。
- **等级 1：** 输出自定义事件、按钮移动、选中切换以及成功的拖拽事件。
- **等级 2：** 追加鼠标按下坐标及被忽略的拖拽尝试等详细信息。

## 实现说明
- `MouseEventEmulator` 类实现了与 MQL 辅助函数（`MouseEventUse`、`MouseMove`、`IsMoved`）相同的状态机，时间与位移阈值分别为 460 毫秒和 3 像素。
- `ChartButton` 承担了原 `CObjectMan` 的职责：随机生成位置、限制移动范围并格式化输出状态。
- 定时器逻辑通过 K 线流实现，所有回调均在策略线程内完成，避免了额外线程带来的同步问题。
- 代码注释全部使用英文，符合仓库约定，同时在说明文档中保留了必要的中文描述。

## 与原脚本的差异
- StockSharp 策略无法直接接收真实的键盘和鼠标事件，因此交互过程通过随机仿真完成，重点仍是教学日志输出。
- 为保证跨平台兼容性，本版本未在图表上绘制实际对象，但日志中保留了位置和颜色信息。
- 定时器周期取决于所订阅的 K 线类型；选择 1 分钟 K 线可复现原脚本的 60 秒节奏。

## 使用方法
1. 将策略加入 StockSharp 解决方案并选择目标证券。
2. 根据需要调整参数（画布尺寸、步长等）。
3. 在仿真或回测模式下运行策略，观察日志以理解事件处理流程。
4. 停止策略即可清空所有内部状态；由于策略不下单，账户中不会留下任何仓位或委托。

该文档提供了理解并展示 StockSharp 中图表事件处理所需的全部背景信息。
