# Самооптимизирующаяся стратегия RSI/MFI v3

## Описание
Стратегия переносит советник MetaTrader «Self Optimizing RSI or MFI Trader» на высокоуровневый API StockSharp. После закрытия каждой свечи алгоритм перебирает `OptimizingPeriods` последних баров, тестирует все целые уровни между `IndicatorBottomValue` и `IndicatorTopValue` и определяет, на каких порогах индикатор приносил наибольшую прибыль для лонгов и шортов. В реальном времени сделки открываются только при пересечении текущим значением индикатора наиболее прибыльного уровня (или сразу в режиме `UseAggressiveEntries`). Выход осуществляется через стоп-лосс/тейк-профит по ATR или фиксированному расстоянию и необязательный перевод стопа в безубыток.

## Данные
- Поддерживаются любые инструменты с OHLC-свечами; для MFI необходимы объёмы.
- Таймфрейм задаётся параметром `CandleType` (по умолчанию 15 минут), можно выбрать любой доступный интервал.

## Индикаторы
- **RSI** или **MFI** в зависимости от `IndicatorChoice`, используют одинаковый период `IndicatorPeriod`.
- **ATR** нужен при включенном `UseDynamicTargets` для расчёта стопов и целей.

## Логика торговли
1. Хранится окно из `OptimizingPeriods + 1` завершённых свечей с индикаторными значениями и ценой закрытия.
2. Для каждого уровня внутри заданного диапазона проводится бэктест на окне: рассчитывается, какой исход (стоп или цель) наступил раньше при пробое уровня вниз (для шортов) и вверх (для лонгов).
3. Выбираются уровни, показавшие максимальную историческую прибыль. Если включён `TradeReverse`, прибыльность направлений меняется местами.
4. При пересечении индикатором лучшего уровня в прибыльном направлении (или немедленно в агрессивном режиме) открывается позиция, если позволяет `OneOrderAtATime`.
5. Управление позицией:
   - Стоп-лосс и тейк-профит вычисляются либо как ATR × множители `StopLossAtrMultiplier`/`TakeProfitAtrMultiplier`, либо как фиксированное число пунктов (`StaticStopLossPoints`/`StaticTakeProfitPoints`).
   - Опция `UseBreakEven` переносит стоп в точку входа плюс `BreakEvenPaddingPoints`, когда прибыль достигает `BreakEvenTriggerPoints`.
   - Позиция закрывается при достижении стопа или цели.

## Риск-менеджмент
- **Динамический размер:** при включённом `UseDynamicVolume` объём рассчитывается исходя из доли капитала `RiskPercent`, используя параметры шага цены (`PriceStep`) и стоимости шага (`StepPrice`).
- **Фиксированный размер:** при выключенной динамике каждая сделка открывается на `BaseVolume` контрактов.
- **Безубыток:** защищает прибыльные сделки после достижения заданного порога.

## Параметры
| Параметр | Описание |
|----------|----------|
| `OptimizingPeriods` | Количество свечей в окне самооптимизации (по умолчанию 144). |
| `IndicatorChoice` | Выбор индикатора (RSI или MFI). |
| `IndicatorPeriod` | Период индикатора и ATR. |
| `IndicatorTopValue` / `IndicatorBottomValue` | Верхняя и нижняя границы перебираемых уровней. |
| `UseAggressiveEntries` | Вход без подтверждающего пересечения. |
| `TradeReverse` | Инвертирует предпочтение направлений. |
| `OneOrderAtATime` | Запрещает одновременные позиции при включении. |
| `UseDynamicTargets` | Переключатель между ATR- и пунктовыми стопами. |
| `StopLossAtrMultiplier`, `TakeProfitAtrMultiplier` | Множители ATR для динамических выходов. |
| `StaticStopLossPoints`, `StaticTakeProfitPoints` | Дистанции в пунктах при статических выходах. |
| `UseBreakEven`, `BreakEvenTriggerPoints`, `BreakEvenPaddingPoints` | Настройки перевода в безубыток. |
| `UseDynamicVolume`, `RiskPercent`, `BaseVolume` | Управление объёмом. |
| `CandleType` | Таймфрейм расчётов. |

## Особенности реализации
- Используется подписка на свечи с `.Bind(...)`, поэтому расчёт выполняется только на завершённых барах.
- В неттинговых счетах желательно удерживать `OneOrderAtATime = true`, так как стратегия оперирует одной агрегированной позицией.
- Торговля начинается после формирования всех необходимых значений ATR и выбранного индикатора.
- При выборе MFI требуется поток данных с объёмами, иначе индикатор не сформируется.

## Рекомендации по настройке
- Подбирайте `OptimizingPeriods`, `IndicatorPeriod` и ATR-множители вместе, чтобы адаптироваться к волатильности инструмента.
- Сокращение диапазона уровней (например, 20–80) может снизить шум для боковых рынков.
- Рекомендуется проводить walk-forward тесты, так как стратегия постоянно адаптируется к свежим данным.

## Порядок использования
1. Подключите стратегию к нужному инструменту и портфелю в Designer или программно.
2. Настройте параметры, уровни риска и размер позиции.
3. Запустите стратегию — после накопления достаточного числа свечей начнут появляться сделки.

## Ограничения
- Самооптимизация запускается на каждом баре, что может быть ресурсоёмко при больших окнах или широком диапазоне уровней.
- Перебор выполняется по целым уровням, дробные значения не тестируются.
- Предполагается устойчивость недавней динамики рынка; при смене режима стоит пересмотреть параметры или остановить стратегию.
