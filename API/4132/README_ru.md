# Стратегия Indicate Orders

## Обзор
Indicate Orders — это порт индикатора MetaTrader *q_indicate_orders* на платформу StockSharp. Оригинальный MQL‑скрипт размещал на графике подписи с количеством открытых покупок и продаж, их суммарным объёмом и текущей плавающей прибылью. В версии для StockSharp те же сведения выводятся в журнал стратегии, что позволяет использовать их в автоматизированных сценариях, в визуализаторе и в отчётах по тестам.

Стратегия не генерирует сделки самостоятельно. Она только отслеживает сделки (`MyTrade`), которые создаёт основной алгоритм или ручные операции, выполненные через эту стратегию, и ведёт два списка: активные длинные позиции и активные короткие. При появлении новой сделки или обновлении эталонной цены оба списка пересчитываются, формируя текстовую сводку, максимально близкую к макету исходного индикатора.

## Последовательность обработки событий
1. **Запуск** — при старте сбрасывается накопленное состояние и сразу выводится сообщение "No open orders.", подтверждающее, что мониторинг активен.
2. **Обновления цен** — подписка `PriceDataType` поставляет закрытые свечи. Закрытие последней свечи используется как актуальная цена для расчёта плавающей прибыли по всем открытым тикетам.
3. **Обработка сделок** — метод `OnNewMyTrade` получает новые сделки. Покупки сначала уменьшают список открытых шортов, а остаток добавляется в список лонгов. Продажи работают зеркально. Такой подход поддерживает отображение хеджированных позиций и при этом соответствует неттинговой модели StockSharp.
4. **Формирование отчёта** — после каждого изменения состояния пересобирается текст журнала. Для каждой стороны выводится строка с итогами (количество, суммарный объём, плавающий результат) и до `MaxOrdersToShow` строк с деталями по отдельным тикетам. При отсутствии позиций журнал содержит "No open orders.". Идентичные сообщения повторно не публикуются.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `MaxOrdersToShow` | `int` | `25` | Максимальное число детализированных строк по каждому направлению. Избыточные тикеты свёрнуты в строку вида `... N more`. |
| `PriceDataType` | `DataType` | Таймфрейм 1 минута | Источник рыночных данных (свечи или иной тип), из которого берётся цена для расчёта плавающей прибыли. |

## Формат журнала
Каждая сводка имитирует исходную верстку индикатора в текстовом виде:

```
BUYS | <кол-во> | <совокупный объём> | <плавающий результат>
#<идентификатор>: <объём> @ <цена входа> | <время входа> | <плавающий результат>
...
SELLS | <кол-во> | <совокупный объём> | <плавающий результат>
#<идентификатор>: <объём> @ <цена входа> | <время входа> | <плавающий результат>
```

- Для положительного результата добавляется знак `+`; если актуальная цена ещё не получена, отображается `N/A`.
- Время входа конвертируется в локальный часовой пояс для удобства оператора.
- Когда число тикетов превышает `MaxOrdersToShow`, оставшиеся отображаются финальной строкой `... N more`.

## Отличия от индикатора MetaTrader
- Вместо графических подписей используются текстовые сообщения в журнале, что упрощает автоматизацию и анализ бэктестов.
- При сопоставлении разнонаправленных сделок применяется логика неттинга: обратная сделка сначала сокращает существующий объём и лишь затем добавляет новый тикет.
- Параметры визуального оформления (цвета, шрифты, координаты) отсутствуют, поскольку в формате журнала они не востребованы.
- Плавающая прибыль пересчитывается по последней цене из подписки `PriceDataType`, а не берётся из терминала MetaTrader.

## Рекомендации по использованию
- Подключайте стратегию в качестве дочерней к торговым алгоритмам, чтобы вести текстовый журнал открытых тикетов без изменения логики торговли.
- Подбирайте `PriceDataType` с подходящей частотой обновления: для внутридневных систем подойдут тики или короткие свечи, чтобы плавающая прибыль оставалась актуальной.
- Настраивайте `MaxOrdersToShow` в зависимости от максимального числа одновременно открытых ордеров: большие значения дают больше деталей, но увеличивают длину сообщений.

## Ограничения
- Стратегия видит только сделки, прошедшие через текущий объект `Strategy`. Внешние операции, не генерирующие `MyTrade`, не попадут в журнал.
- Точность плавающей прибыли зависит от своевременности данных `PriceDataType`. При задержках значения могут временно отличаться от фактических.
- В реплике отсутствуют элементы визуального интерфейса, присутствовавшие в MQL-версии (цветовые схемы, шрифт и т. п.).

## Индикаторы
Отдельные индикаторы не используются. Стратегия лишь подписывается на поток данных `PriceDataType`, чтобы получать цены для расчёта плавающей прибыли.
