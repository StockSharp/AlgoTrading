# 持仓提示策略

## 概述
持仓提示策略是 MetaTrader 指标 *q_indicate_orders* 的 StockSharp 版本。原始 MQL 脚本会在图表上绘制文本标签，显示当前持有的买单和卖单数量、合计手数以及每张订单的浮动盈亏。移植后的 StockSharp 策略改为将这些信息写入日志，方便在终端、可视化器或回测报告中统一查看。

该策略本身不会主动下单。它只会监听所在策略（或手工下单）产生的 `MyTrade` 事件，分别维护一个多头订单列表和一个空头订单列表。当出现新的成交或新的参考价格时，会根据这两个列表重新生成一份快照，格式与原始指标的文本布局保持一致。

## 事件处理流程
1. **启动阶段**：策略清空内部缓存，并立即输出首条日志 "No open orders."，提示监控器已经就绪。
2. **价格更新**：通过 `PriceDataType` 订阅的蜡烛序列提供收盘价，策略将最新收盘价保存为浮动盈亏的基准价格。
3. **成交处理**：`OnNewMyTrade` 收到新的成交后，买入成交会优先抵消现有的空头订单，剩余部分记为新的多头订单；卖出成交则先抵消多头，再把余量记录为空头。这种处理方式既再现了原指标对冲式的列表效果，又符合 StockSharp 的净头寸模型。
4. **日志生成**：每次状态更新后都会重建日志文本。多头与空头部分各包含一行汇总（订单数量、总手数、浮动盈亏）以及若干明细行，明细数量受 `MaxOrdersToShow` 限制。如果没有任何持仓，则输出 "No open orders."；重复内容不会再次写入日志。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `MaxOrdersToShow` | `int` | `25` | 每个方向最多输出的订单明细行数，超出的部分以 `... N more` 显示。 |
| `PriceDataType` | `DataType` | 1 分钟周期 | 用于获取最新参考价格的市场数据订阅（蜡烛或其他类型）。 |

## 日志格式
每次快照都会按照原始指标的样式输出文本：

```
BUYS | <数量> | <总手数> | <浮动盈亏>
#<订单编号>: <手数> @ <入场价> | <入场时间> | <浮动盈亏>
...
SELLS | <数量> | <总手数> | <浮动盈亏>
#<订单编号>: <手数> @ <入场价> | <入场时间> | <浮动盈亏>
```

- 盈亏为正时在数字前添加 `+` 号；如果尚未收到价格数据，则显示 `N/A`。
- 入场时间会转换为本地时区，便于人工核对。
- 若订单数量超过 `MaxOrdersToShow`，最后一行会提示剩余的订单数量，例如 `... 3 more`。

## 与原版 MetaTrader 指标的差异
- MetaTrader 采用图表标签展示信息，StockSharp 版本改为写入日志，便于自动化流程和回测环境读取。
- 在匹配多空成交时采用净头寸逻辑：反向成交会优先冲减已有持仓，然后再生成新订单记录。
- 原脚本中的颜色、字体、坐标等界面参数在日志输出中没有意义，因此未予保留。
- 浮动盈亏由最新收盘价重新计算，而非使用 MetaTrader 终端返回的服务器数据。

## 使用建议
- 可作为子策略附加到任何会主动下单的算法中，实时记录持仓结构而不干扰原有交易逻辑。
- 根据交易节奏选择合适的 `PriceDataType`。高频策略应选用逐笔行情或较短的时间框，以保持浮盈数据的及时性。
- 若策略可能同时持有大量订单，可提高 `MaxOrdersToShow`，以便在日志中保留更多明细；反之可降低以减少日志长度。

## 限制
- 策略只能看到通过当前 `Strategy` 产生的成交。若在外部终端手动开仓且未触发本策略的 `MyTrade` 事件，将无法记录。
- 浮动盈亏依赖 `PriceDataType` 提供的最新价格；若行情延迟或缺失，日志中的盈亏会显示为 `N/A` 或与实际存在滞后。
- 由于输出为文本日志，无法复现原指标中的视觉样式（字体、颜色等）。

## 指标
策略本身不使用技术指标，仅订阅 `PriceDataType` 指定的行情数据以计算浮动盈亏。
