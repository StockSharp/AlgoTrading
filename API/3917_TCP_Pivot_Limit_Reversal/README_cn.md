# TCP 枢轴限价策略

## 概述

TCP Pivot Reversal Limit 策略源自 MetaTrader 4 专家顾问 **gpfTCPivotLimit.mq4**。原版顾问使用小时 K 线计算每日枢轴价位，并在这些价位附近寻找假突破。当突破失败时立即反向入场，目标指向相对的枢轴价位。本实现使用 StockSharp 的高级策略 API 重现同样的思路。

策略依赖小时级别数据，任何时刻仅持有一笔仓位。每天第一次出现新交易日的 K 线时，会根据前一日的最高价、最低价与收盘价重新计算枢轴网格，随后所有的入场触发、止损、止盈和可选的跟踪止损都以这些价位为依据。

## 交易逻辑

1. **枢轴计算**
   - 新交易日开始的第一根 K 线到来时，策略聚合上一交易日的最高、最低与收盘价，并计算标准的枢轴价位（Pivot、R1–R3、S1–S3）。
   - 每次生成新的枢轴网格都会写入日志，方便跟踪价位变化。

2. **入场条件**
   - 在每根完成的小时 K 线上，策略都会检查前两根已经收盘的 K 线。
   - 当前前一根 K 线向上刺穿阻力位（或收盘价位于阻力位之上）但开盘价仍位于其下方，同时最近一根 K 线重新收于阻力位下方时，触发做空。这意味着突破失败，价格预期向下反转。
   - 当市场向下刺穿支撑位后又被后一根 K 线收回到支撑位上方时，触发做多。
   - 同一时间仅允许一笔仓位，委托数量由 `OrderVolume` 参数决定。

3. **离场与风控**
   - 每次入场都会按照 `TargetMode` 选择的预设组合设置止损与止盈。该参数完全对应原顾问中的 `TgtProfit` 选项，不同模式使用不同的枢轴价位：
     | 模式 | 空头入场 | 空头止损 | 空头止盈 | 多头入场 | 多头止损 | 多头止盈 |
     |------|----------|----------|----------|----------|----------|----------|
     | 1    | R1       | R2       | S1       | S1       | S2       | R1       |
     | 2    | R1       | R2       | S2       | S1       | S2       | R2       |
     | 3    | R2       | R3       | S1       | S2       | S3       | R1       |
     | 4    | R2       | R3       | S2       | S2       | S3       | R2       |
     | 5    | R2       | R3       | S3       | S2       | S3       | R3       |
   - 如果启用 `IntradayTrading`，则在 23:00 K 线收盘时强制平仓，避免隔夜持仓。
   - 可选的跟踪止损以点数表示（价格最小变动的倍数），只有当浮动盈利达到指定距离后才会激活，随后一旦价格回撤同样距离即离场，模拟 MetaTrader 中的行为。

## 参数

| 参数 | 说明 |
|------|------|
| `OrderVolume` | 做多与做空市价单的委托数量。 |
| `TargetMode` | 取值 1–5，决定入场、止损与止盈采用的枢轴价位组合。 |
| `TrailingPoints` | 跟踪止损距离（点数）。设为零可关闭跟踪止损。 |
| `IntradayTrading` | 设为 `true` 时在 23:00 平掉所有仓位，仅进行日内交易。 |
| `CandleType` | 使用的 K 线类型，默认是一小时，与原顾问一致。 |

## 注意事项

- 策略假设输入数据为连续的小时 K 线。如需使用其他周期，请先进行充分回测。
- 止损与止盈根据 K 线极值检查，若出现跳空，成交价可能比目标价位更差，这与原版顾问相同。
- 跟踪止损基于 K 线收盘和最高/最低价执行，在保持计算效率的同时接近原始逐笔逻辑。
