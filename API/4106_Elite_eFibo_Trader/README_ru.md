# Стратегия Elite eFibo Trader

## Общее описание
Elite eFibo Trader воспроизводит советника усреднения, который открывает серию ордеров по последовательности Фибоначчи и контролирует тренд с помощью пересечения скользящих средних и дополнительного фильтра RSI. Порт под StockSharp сохраняет корзинную механику: рыночный вход мгновенно сопровождается стоп-ордерами на следующих уровнях через заданное количество пунктов, а каждый новый сработавший уровень увеличивает позицию по схеме Фибоначчи. Корзина закрывается, когда плавающая прибыль достигает заданного денежного значения или когда фильтр тренда разворачивается против текущей позиции.

## Рыночные данные
- Подписка выполняется на один тип свечей, задаваемый параметром (по умолчанию 15‑минутные свечи).
- Для расчёта индикаторов и проверки стопов используется цена закрытия свечи.

## Логика входа
1. Направление задаётся либо логикой пересечения скользящих средних (включена по умолчанию), либо ручными переключателями `ManualOpenBuy`/`ManualOpenSell`.
2. При активной MA-логике бычье пересечение (быстрая SMA выше медленной) разрешает набор длинной корзины, а медвежье пересечение — короткой. На один бар генерируется только один сигнал.
3. Если включён фильтр RSI, длинные корзины открываются лишь при `RSI > RsiHigh`, короткие — при `RSI < RsiLow`.
4. Новая лестница запускается только при отсутствии активных ордеров и позиций стратегии и если разрешена торговля (`TradeAgainAfterProfit`).
5. Первый уровень открывается рыночным ордером, остальные выставляются как стоп-ордера с отступом `LevelDistancePips`. Объёмы задаются для каждого уровня и по умолчанию соответствуют числам Фибоначчи.

## Логика выхода
- Каждый исполненный уровень получает стартовый стоп на расстоянии `StopLossPips` и участвует в тралении, когда MA-логика фиксирует неблагоприятное пересечение.
- Траление смещает стоп до `close - TrailingStopPips` для длин и `close + TrailingStopPips` для коротких, не увеличивая изначальный риск.
- При достижении стоп-уровня (по минимуму/максимуму свечи) оставшийся объём уровня закрывается рыночным ордером.
- Если суммарная плавающая прибыль корзины (рассчитывается через `PriceStep` и `StepPrice` инструмента) превышает `MoneyTakeProfit`, стратегия закрывает все позиции и снимает отложенные ордера.
- После полного выхода любые стоп-ордера удаляются автоматически. Если `TradeAgainAfterProfit = false`, стратегия остаётся в режиме ожидания до ручного сброса.

## Параметры
| Параметр | Описание |
| -------- | -------- |
| `UseMaLogic` | Включить/выключить логику пересечения скользящих средних. |
| `MaSlowPeriod`, `MaFastPeriod` | Периоды медленной и быстрой SMA. |
| `TrailingStopPips` | Дистанция тралящего стопа в пунктах при неблагоприятном сигнале. |
| `UseRsiFilter`, `RsiPeriod`, `RsiHigh`, `RsiLow` | Настройки фильтра RSI. Лонги разрешены выше `RsiHigh`, шорты — ниже `RsiLow`. |
| `ManualOpenBuy`, `ManualOpenSell` | Ручные переключатели направления при отключённой MA-логике. |
| `TradeAgainAfterProfit` | Разрешить повторный запуск корзины после достижения денежной цели. |
| `LevelDistancePips` | Расстояние между уровнями усреднения в пунктах. |
| `StopLossPips` | Начальное смещение стопа для каждого уровня. |
| `MoneyTakeProfit` | Денежная цель по плавающей прибыли корзины. |
| `Level1Volume` … `Level14Volume` | Объём каждого уровня. Значение 0 отключает уровень. |
| `CandleType` | Тип свечей/таймфрейм для расчётов. |

## Особенности реализации
- Преобразование «пунктов» выполнено как в оригинальном MQL: при количестве знаков котировки 3 или 5 используется `PriceStep * 10`, что соответствует переменной `MyPoint` в советнике.
- Каждый уровень хранит собственные данные — цену входа, остаток объёма и стоп. Это позволяет корректно обрабатывать частичные исполнения и индивидуальные стоп-ауты.
- Плавающая прибыль вычисляется через `PriceStep` и `StepPrice`. Убедитесь, что у инструмента эти свойства заданы, иначе `MoneyTakeProfit` не сработает.
- `StartProtection()` вызывается один раз при запуске, включая встроенные защитные механизмы StockSharp.
- При отсутствии открытых объёмов автоматически отменяются все отложенные ордера, что повторяет многократные вызовы `subCloseAllPending()` в оригинале.

## Рекомендации по использованию
- Проверьте настройки брокера: `PriceStep`, `StepPrice`, `VolumeStep`, минимальный и максимальный лот, чтобы объёмы Фибоначчи соответствовали допустимым значениям.
- Подбирайте таймфрейм свечей в соответствии с используемым в MetaTrader графиком.
- Системы усреднения могут быстро накапливать позицию при затяжном тренде — сначала протестируйте стратегию на демо или исторических данных.
- Отключите `UseMaLogic`, если нужно вручную фиксировать направление, либо оставьте включённым для автоматического определения тренда.
