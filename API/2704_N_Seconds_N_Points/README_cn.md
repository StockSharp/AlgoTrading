# N Seconds N Points 策略

## 概述
该策略复刻了 MetaTrader 平台上 "N seconds N points" 指标型智能交易的资金管理行为。本策略本身不负责产生入场信号，而是专注于在达到设定的等待时间后管理已有仓位的止盈退出。适用于人工交易或由其他算法产生入场、需要在固定时间窗口内执行统一止盈逻辑的场景。

## 核心逻辑
1. 监听自身的成交回报，持续维护当前净头寸、平均持仓价以及持仓开始时间。
2. 订阅实时逐笔成交，以获取最新市场价格，并用每秒一次的定时器模拟原始 EA 的 `OnTimer` 行为。
3. 当持仓时间超过 `WaitSeconds` 时，策略会检查未实现盈亏：
   - 如果价格朝有利方向移动了至少 `TakeProfitPips`（根据合约精度自动转换为点值），则立即以市价单平仓。
   - 否则将在目标价位挂出或更新止盈限价单，且仅当目标价距离当前价大于一个点值时才会下单，避免过近的挂单。
4. 当仓位归零后，策略会撤销所有保护性订单并重置内部状态，以便下一次入场时从零开始计时。

## 参数
- **WaitSeconds** – 开始执行止盈管理前需要等待的秒数，默认值为 40 秒。
- **TakeProfitPips** – 止盈触发所需的点数距离。策略会根据 3 位或 5 位报价的外汇品种自动调整点值，对其他品种则使用交易所最小价差。默认值为 15 点。

## 实现细节
- 通过 `SubscribeTrades()` 获取实时成交价，确保盈亏计算基于最新市场信息。
- 使用 `Timer.Start(TimeSpan.FromSeconds(1), ProcessTimer)` 构建 1 秒心跳，与 MetaTrader 的定时粒度一致，同时可以精确统计持仓时间。
- 止盈价会根据品种的最小价差进行归一化，避免因价格不合法而被交易所拒绝。
- 在部分减仓、加仓或反手时会重新计算平均持仓价和持仓时间，保证时间过滤始终针对实际有效仓位。

## 使用建议
- 由于策略只负责离场控制，应与其他策略、手动交易或外部信号结合使用，以产生入场。
- 请确认交易账号允许在目标价位挂出限价单；若被拒绝，可适当调小点数距离或调整品种参数。
- 即使市场休市定时器仍会运行；若行情源暂停推送，则会持续使用最近一次成交价，直到收到新的成交。
