# Стратегия N Seconds N Points

## Обзор
Стратегия повторяет поведение одноимённого советника MetaTrader и отвечает за сопровождение уже открытых позиций. Она не ищет точки входа: задача заключается в том, чтобы после заданного ожидания контролировать фиксацию прибыли по любому нетто-положению инструмента. Такой подход полезен, когда входы поступают от другого робота, индикатора или ручной торговли, а выходы требуется стандартизировать во времени и по расстоянию в пунктах.

## Логика работы
1. Каждый собственный трейд обновляет среднюю цену входа, текущий объём и время открытия позиции.
2. Стратегия подписывается на поток сделок, чтобы иметь актуальную рыночную цену, и запускает таймер с шагом в одну секунду, имитируя оригинальный обработчик `OnTimer`.
3. Когда позиция находится в рынке дольше `WaitSeconds`, запускается проверка прибыли:
   - Если движение в нужную сторону превышает `TakeProfitPips` (значение конвертируется в пункты с учётом точности котировки), позиция закрывается рыночной сделкой.
   - В противном случае выставляется или обновляется лимитный ордер на фиксированный уровень тейк-профита. Ордер отправляется только тогда, когда между текущей ценой и уровнем остаётся хотя бы один пункт, чтобы не ставить цель слишком близко.
4. После закрытия позиции все защитные заявки отменяются, а внутренние переменные обнуляются, чтобы следующая сделка начиналась "с чистого листа".

## Параметры
- **WaitSeconds** – количество секунд ожидания перед активацией логики сопровождения. Значение по умолчанию: 40 секунд.
- **TakeProfitPips** – целевой профит в пунктах. Для инструментов с 3 или 5 знаками после запятой размер пункта умножается на 10, для остальных используется шаг цены инструмента. Значение по умолчанию: 15 пунктов.

## Особенности реализации
- Подписка `SubscribeTrades()` обеспечивает доступ к последней сделке и корректному расчёту текущего результата.
- Сердцебиение `Timer.Start(TimeSpan.FromSeconds(1), ProcessTimer)` даёт стабильный интервал проверки и повторяет принцип работы MetaTrader.
- Перед отправкой заявок цена нормализуется по шагу цены, что предотвращает отклонение ордеров торговой системой.
- При частичном закрытии, наращивании позиции или развороте пересчитываются как средняя цена, так и момент открытия, поэтому таймер всегда ориентируется на актуальную сделку.

## Рекомендации по использованию
- Комбинируйте стратегию с модулем, который отвечает за входы, или с ручными решениями — данный код занимается только выходами.
- Убедитесь, что брокер принимает лимитные ордера по рассчитанному уровню; при необходимости уменьшайте дистанцию тейк-профита или корректируйте настройки инструмента.
- Во время остановки торгов таймер продолжает тикать: если поток сделок недоступен, используется последнее известное значение цены до появления нового трейда.
