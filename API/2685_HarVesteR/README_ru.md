# Стратегия HarVesteR
[English](README.md) | [中文](README_cn.md)

Стратегия HarVesteR сочетает импульс MACD с двумя простыми скользящими средними и опциональным фильтром по силе тренда ADX.
Она ищет ситуации, когда цена «прилипает» к средним, а MACD недавно пересёк нулевую линию, что указывает на возможный выход из консолидации.
Стопы ставятся по ближайшим локальным экстремумам, половина позиции фиксируется при достижении заданного соотношения риск/прибыль, а остаток защищается выходом в безубыток, управляемым быстрой средней.

## Подробности

- **Условия входа**:
  - Лонг: `MACD > 0 && в истории MACD есть отрицательное значение && Close < SlowSMA && Close + Indentation > FastSMA && Close + Indentation > SlowSMA && ADX ≥ AdxBuyLevel (если фильтр включён)`
  - Шорт: `MACD < 0 && в истории MACD есть положительное значение && Close > SlowSMA && Close - Indentation < FastSMA && Close - Indentation < SlowSMA && ADX ≥ AdxSellLevel (если фильтр включён)`
- **Стоп-лосс**: последний локальный минимум/максимум за `StopLookback` закрытых свечей.
- **Частичное закрытие**: половина объёма закрывается, когда цена проходит `HalfCloseRatio` расстояний между входом и стопом, после чего стоп переносится в безубыток.
- **Окончательный выход**:
  - Лонг: полное закрытие, если цена опускается ниже `FastSMA + Indentation` после переноса стопа в безубыток.
  - Шорт: полное закрытие, если цена поднимается выше `FastSMA + Indentation` после переноса стопа в безубыток.
- **Направления**: торгует в обе стороны.
- **Фильтры**: опциональный фильтр по силе тренда ADX; отключается параметром `UseAdxFilter = false`.
- **Управление позицией**: при смене сигнала объём сделки включает текущую позицию для разворота без отдельного закрытия.

## Параметры

| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `MacdFast` | 12 | Быстрый период EMA для разностной линии MACD. |
| `MacdSlow` | 24 | Медленный период EMA для разностной линии MACD. |
| `MacdSignal` | 9 | Период EMA сигнальной линии MACD. |
| `MacdLookback` | 6 | Число последних свечей, анализируемых на смену знака MACD. |
| `SmaFastLength` | 50 | Период быстрой простой скользящей средней. |
| `SmaSlowLength` | 100 | Период медленной простой скользящей средней. |
| `MinIndentation` | 10 | Отступ в пунктах вокруг средних для условий входа и выхода. |
| `StopLookback` | 6 | Глубина поиска локального максимума/минимума для постановки стопа. |
| `UseAdxFilter` | false | Включает фильтр по силе тренда ADX для обоих направлений. |
| `AdxBuyLevel` | 50 | Минимальное значение ADX для разрешения лонгов при активном фильтре. |
| `AdxSellLevel` | 50 | Минимальное значение ADX для разрешения шортов при активном фильтре. |
| `AdxPeriod` | 14 | Период расчёта индикатора ADX. |
| `HalfCloseRatio` | 2 | Множитель к расстоянию «вход-стоп» перед частичной фиксацией прибыли. |
| `Volume` | 1 | Объём заявки для новых входов (с учётом текущей позиции). |
| `CandleType` | 1 час | Таймфрейм, по которому строятся свечи и индикаторы. |

## Примечания

- `MinIndentation` переводится в ценовое расстояние через шаг цены инструмента. Для котировок с тремя или пятью знаками используется дополнительный множитель ×10, чтобы приблизить величину к пунктам.
- При `UseAdxFilter = false` стратегия принимает сигналы без проверки значения ADX.
- Логика частичного выхода и перехода в безубыток выполняется на каждой закрытой свече, чтобы защищать позиции даже при временном запрете новых сделок.
