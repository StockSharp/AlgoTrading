# 3100 Close All Positions

## Обзор
- Конвертация вспомогательного MQL5-советника **Close all positions** в стратегию StockSharp на высокоуровневом API.
- Стратегия отслеживает закрытые свечи выбранного таймфрейма и суммирует плавающий результат всех открытых позиций в портфеле.
- Как только плавающая прибыль достигает заданного порога, отправляются рыночные заявки для всех задействованных инструментов (в том числе дочерних стратегий) до полного закрытия портфеля.
- Флаг `_closeAllRequested` воспроизводит переменную `m_close_all` из MQL и удерживается до тех пор, пока портфель не станет плоским.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `ProfitThreshold` | `decimal` | `10` | Минимальный объём плавающей прибыли в валюте счёта, после которого все позиции закрываются. Аналог параметра `InpProfit`. |
| `CandleType` | `DataType` | таймфрейм `1m` | Ряд свечей, который определяет моменты «новой свечи». Проверка прибыли выполняется только после формирования свечи, как в оригинальном скрипте через `PrevBars`. |

## Алгоритм работы
1. Подписываемся на свечи `CandleType` и обрабатываем только завершённые свечи (`CandleStates.Finished`). Это повторяет проверку на появление новой свечи в MQL.
2. На каждой завершённой свече метод `CalculateTotalProfit` в первую очередь пытается получить `Portfolio.CurrentProfit` (плавающий PnL с учётом комиссий и свопов). Если адаптер не предоставляет значение, используется сумма `position.PnL` по позициям.
3. Если плавающий результат меньше `ProfitThreshold`, стратегия ничего не делает.
4. При достижении порога устанавливаем `_closeAllRequested = true` и сразу вызываем `CloseAllPositions()`.
5. Метод `CloseAllPositions()` формирует множество всех инструментов с открытым объёмом и отправляет рыночные заявки противоположного направления (лонг → продажа, шорт → покупка).
6. Флаг `_closeAllRequested` остаётся активным, пока `HasAnyOpenPosition()` не убедится, что объём всех позиций равен нулю, что полностью повторяет циклическое закрытие в MQL.

## Дополнительные замечания
- По условиям задания реализована только C# версия, папка с Python не создавалась.
- Отложенные заявки не отменяются, поскольку оригинальный советник занимался исключительно закрытием рыночных позиций.
- Порог `ProfitThreshold` заранее подготовлен для оптимизации через `SetOptimize`, что позволяет тестировать различные значения в Designer.

## Файлы
- `CS/CloseAllPositionsStrategy.cs`
