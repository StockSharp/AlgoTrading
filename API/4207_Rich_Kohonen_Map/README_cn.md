# Rich Kohonen Map 策略

## 概述
Rich Kohonen Map 策略来源于 MetaTrader 4 专家顾问“Rich.mq4”的移植版。原始系统通过 Tom DeMark 枢轴所构建的特征向量训练自组织映射（Kohonen 网络），并将下一根 K 线分类为买入、卖出或观望。StockSharp 版本保持了该学习方法，同时与高层策略 API 集成，仅依赖已经完成的 K 线与市价单进行交易。

## 市场数据
- **交易品种**：由外部应用程序中绑定的 `Security` 决定。
- **K 线类型**：参数 `CandleType`（默认：1 小时时间框架）。策略在开始发出信号前需要至少七根已完成的 K 线，以便构建当前和上一根的特征向量。

## 交易逻辑
1. 维护最近七根完成 K 线的滚动窗口。
2. 在每根完成的 K 线上构建两个包含七个元素的向量：
   - **当前向量**：使用最新开盘价以及基于前五根 K 线计算的 Tom DeMark 枢轴预测值。
   - **上一向量**：整体向后移动一根，代表刚刚收盘的那根 K 线，该向量用于训练。
3. 将当前向量与三个 Kohonen 映射（买入、卖出、观望）进行比较，记录与各自最佳匹配单元的欧氏距离。
4. 选择距离最小的动作并设定目标持仓：
   - 买入 → 建立等于计算手数的多头仓位。
   - 卖出 → 建立相同手数的空头仓位。
   - 观望 → 保持空仓。
   策略会根据当前持仓与目标持仓的差值发送市价单，使最终仓位与决策保持一致。
5. 计算最近两根 K 线开盘价之间的点差（以点数计），并据此训练映射：
   - 正向点差落在 `[MinPips, MaxPips]` 内 → 将上一向量加入买入映射。
   - 负向点差落在 `[-MaxPips, -MinPips]` 内 → 将上一向量加入卖出映射。
   - 其它情况 → 将上一向量加入观望映射。
6. 仓位规模由账户余额动态决定：`floor(balance / 50) / 10`。若结果为零，则改用备用参数 `Lots`。

## 参数说明
- `MinPips` – 将正向开盘差值视为买入样本时的下限（点）。
- `MaxPips` – 买入/卖出训练样本的上限（点）。
- `TakeProfit`, `StopLoss` – 保留自原始 EA，主要用于文档说明。高层实现通过市价单平仓或反手，而不是挂出止盈/止损单。
- `Lots` – 当余额公式得到零时的备用手数。
- `Slippage` – 预留给手动下单控制（高层辅助方法未直接使用）。
- `MapPath` – 用于跨次运行保存三个 Kohonen 映射的二进制文件路径。
- `EAName` – 可选的订单备注。
- `CandleType` – 构建特征向量时订阅的 K 线类型。

## 映射持久化
策略会将训练后的映射写入 `MapPath` 指定的二进制文件（默认位于工作目录下的 `rl.bin`）。文件按照买入、卖出、观望矩阵的顺序存储双精度值。启动时读取文件，并统计每个矩阵的非空行数，以便在上次训练的基础上继续学习。如果文件不存在，则从全零的内存开始。

## 与原始 MQL 专家顾问的差异
- 订单通过 StockSharp 的 `BuyMarket` / `SellMarket` 辅助方法发送，并直接调整到目标持仓，而不是在每根 K 线上先完全平仓再重新建仓。这样在托管环境中避免了重复交易，同时保持原有效果。
- 止盈、止损参数仍然保留用于说明，但不会单独注册委托。当分类器给出相反方向或观望信号时，仓位会被市价单关闭。
- 文件操作使用 .NET I/O 工具，但映射的格式保持一致（双精度值顺序相同）。

## 使用建议
- 请确保所选 `Security` 提供有效的 `PriceStep`，以正确计算点差；若缺失或为零，则自动退回到单位步长。
- Kohonen 映射容量较大（买入/卖出各最多 10000 行，观望最多 25000 行），默认文件写满约占 2.5 MB，需要足够的磁盘空间。
- 建议在正式上线前通过历史数据运行策略，以便为映射积累具有代表性的样本。
