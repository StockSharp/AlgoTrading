# Стратегия NRTR ATR Stop

## Общее описание

**NRTR ATR Stop** — это конвертация эксперта MetaTrader `Exp_NRTR_ATR_STOP_Tm` на платформу StockSharp. В основе лежит индикатор NRTR, построенный на среднем истинном диапазоне (ATR). Он определяет актуальный тренд, переставляя уровни стопа при пробое противоположной линии предыдущей свечой. Сигналы формируются по закрытию свечи выбранного таймфрейма и могут быть отложены на заданное число готовых баров, что воспроизводит поведение параметра `SignalBar` оригинального робота.

Стратегия построена на высокоуровневом API StockSharp: данные поступают через подписку на свечи, индикаторы связываются через механизм `Bind`, а сделки регистрируются штатными методами `BuyMarket`/`SellMarket`. Благодаря этому решение совместимо с Designer, Shell, Runner и чистым API.

## Логика работы

1. **Расчёт индикатора**
   - ATR вычисляется по выбранному таймфрейму и периоду.
   - Значение ATR умножается на коэффициент, формируя верхнюю и нижнюю линии NRTR.
   - Если предыдущая свеча пробивает противоположную линию, фиксируется смена тренда и создаётся стрелочный сигнал.
2. **Отложенное исполнение**
   - Параметр `SignalBarDelay` задаёт, сколько полностью закрытых свечей необходимо подождать перед обработкой сигнала.
3. **Входы**
   - **Покупка** открывается при бычьем развороте NRTR, если включено разрешение на длинные позиции.
   - **Продажа** открывается при медвежьем развороте, если разрешены короткие позиции.
4. **Выходы**
   - Смена тренда закрывает противоположную позицию при активном разрешении на закрытие.
   - Вне торгового окна стратегия принудительно закрывает все позиции и не открывает новых сделок.
   - Дополнительная защита обеспечивается фиксированными стоп-лоссом и тейк-профитом (в шагах цены). При активной позиции уровень NRTR подтягивает защитный стоп, что позволяет сопровождать тренд.

## Управление рисками

- **Объём**: параметр `OrderVolume` задаёт базовый лот и может участвовать в оптимизации.
- **Стоп-лосс и тейк-профит**: расстояния задаются в шагах цены — как и в MetaTrader. Если одновременно доступны ручной стоп и линия NRTR, выбирается наиболее близкий к текущей цене уровень.
- **Торговая сессия**: при включённом `UseTradingWindow` сделки разрешены только внутри интервала `[StartHour:StartMinute, EndHour:EndMinute]`. Диапазон поддерживает переход через полуночь.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `OrderVolume` | 1 | Объём заявки при открытии позиции. |
| `StopLossPoints` | 1000 | Расстояние до стоп-лосса в шагах цены (0 — отключено). |
| `TakeProfitPoints` | 2000 | Расстояние до тейк-профита в шагах цены (0 — отключено). |
| `BuyPosOpen` / `SellPosOpen` | `true` | Разрешить открытие длинных / коротких позиций. |
| `BuyPosClose` / `SellPosClose` | `true` | Разрешить закрытие длинных / коротких позиций по сигналу. |
| `UseTradingWindow` | `true` | Использовать фильтр торговой сессии. |
| `StartHour` / `StartMinute` | 0 / 0 | Начало торгового окна. |
| `EndHour` / `EndMinute` | 23 / 59 | Конец торгового окна, возможен переход через сутки. |
| `CandleType` | Часовые свечи | Таймфрейм, на котором рассчитываются ATR и NRTR. |
| `AtrPeriod` | 20 | Период ATR. |
| `AtrMultiplier` | 2 | Множитель ATR для построения уровней NRTR. |
| `SignalBarDelay` | 1 | Сколько закрытых свечей ждать перед исполнением сигнала. |

## Дополнительно

- Стратегия принимает решения только на закрытии свечей, что соответствует архитектуре высокоуровневого API и упрощает перенос из MetaTrader.
- Комментарии в коде оставлены на английском языке согласно требованиям проекта.
- Python-версия намеренно не создавалась — добавлена только реализация на C#.
