# Контртрендовая стратегия XFatl XSatl Cloud
[English](README.md) | [中文](README_cn.md)

Эта стратегия StockSharp повторяет логику MT5-советника **Exp_XFatlXSatlCloud**. Она отслеживает сглаженное облако FATL/SATL и торгует **против** направления его пересечения. Если быстрая линия (XFATL) после пребывания выше медленной (XSATL) возвращается ниже, открывается длинная позиция. Когда быстрый фильтр поднимается выше после нахождения под медленным, открывается короткая позиция. Стоп-лосс и тейк-профит задаются в шагах цены инструмента.

## Торговая логика

- По умолчанию используется таймфрейм 8 часов. Параметр `CandleType` позволяет выбрать другой тип свечей.
- Две линии индикатора строятся на базе сглаживаний StockSharp. По умолчанию применяются Jurik MA с настраиваемыми длиной и фазой. Доступны альтернативы (SMA, EMA, SMMA, WMA).
- Сигналы рассчитываются на свече с номером `SignalBar` (смещение относительно последней закрытой). Значения индикаторов сохраняются в небольшой очереди, что позволяет сравнить текущий и предыдущий бар, как в оригинале MT5.
- Правила входа (контртренд):
  - **Покупка** — ранее быстрая линия была выше медленной и теперь опустилась на её уровень или ниже.
  - **Продажа** — ранее быстрая линия была ниже медленной и теперь поднялась на её уровень или выше.
- Правила выхода:
  - Лонг закрывается, когда предыдущий бар показал медвежье облако (быстрая ниже медленной) и включён параметр `AllowLongExit`.
  - Шорт закрывается, когда предыдущий бар показал бычье облако (быстрая выше медленной) и разрешён `AllowShortExit`.
- Новая позиция открывается только после полного закрытия предыдущей, что полностью соответствует поведению советника из MT5.

## Управление рисками

- Параметр `TradeVolume` задаёт объём рыночной заявки. Стратегия не усредняется — каждая сделка открывается одним и тем же количеством.
- `TakeProfitTicks` и `StopLossTicks` переводятся в расстояние в шагах цены и подключаются к модулю `StartProtection`. Нулевое значение отключает соответствующий защитный приказ.
- Поскольку в MT5 расчёт размера позиции зависел от брокерских параметров, здесь он заменён явным выбором объёма и уровней защиты.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей для расчёта индикаторов. |
| `FastMethod` / `SlowMethod` | Семейство сглаживания для XFATL и XSATL (по умолчанию Jurik). |
| `FastLength` / `SlowLength` | Периоды быстрого и медленного фильтров. |
| `FastPhase` / `SlowPhase` | Параметр фазы для Jurik MA, если он поддерживается. |
| `SignalBar` | Смещение бара для оценки пересечений (1 = предыдущий бар). |
| `TradeVolume` | Объём входа в позицию. |
| `AllowLongEntry` / `AllowShortEntry` | Включение контртрендовых входов в каждую сторону. |
| `AllowLongExit` / `AllowShortExit` | Разрешение закрытия позиций по противоположному сигналу. |
| `TakeProfitTicks` | Дистанция до тейк-профита в шагах цены. |
| `StopLossTicks` | Дистанция до стоп-лосса в шагах цены. |

## Особенности реализации

- Стратегия хранит только короткие очереди последних значений индикаторов и обрезает их до длины, необходимой для выбранного `SignalBar`.
- Фаза Jurik настраивается через reflection, чтобы сохранить совместимость с разными версиями StockSharp. Если свойство отсутствует, значение просто игнорируется.
- Используется только цена закрытия свечи — наиболее популярный вариант в оригинальном эксперте. Добавление альтернативных типов цен потребует расширения кода.
- Применяются высокоуровневые методы (`SubscribeCandles`, `Bind`, `StartProtection`), поэтому стратегия легко интегрируется в Designer, Runner и другие продукты StockSharp.
