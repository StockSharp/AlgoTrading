# Стратегия Fundamental Trader DailyFX

## Обзор
Стратегия представляет собой порт на StockSharp оригинального советника **Fundamental Trader DailyFX v0.04**. Она реагирует на публикации макроэкономических данных из CSV-календаря DailyFX и открывает позицию, когда фактическое значение заметно отличается от ожиданий. В переносе сохранена событийная логика, таблица размеров лотов и добавлены проверки, необходимые в среде торговли несколькими инструментами.

## Логика работы
- По таймеру стратегия перечитывает указанный CSV-файл календаря DailyFX.
- Рассматриваются события с важностью *High*, время которых попадает в настраиваемое окно `WaitingMinutes`.
- При наличии полей Actual и Forecast вычисляется относительное отклонение `|Actual - Forecast| / |Forecast|`. Если Forecast отсутствует, используется сравнение с Previous.
- Полученное отклонение выбирает один из 18 уровней объёма. Позитивная новость покупает валюту, если она является базовой в выбранной паре, и продаёт, если она котируемая. Негативная новость даёт обратное направление.
- Стоп-лосс и тейк-профит рассчитываются из `RiskPips` и `RewardMultiplier` на основе последних котировок bid/ask.
- Защитное сопровождение работает по Level1-данным. При включённой опции позиции закрываются также по таймеру (`EnableCloseByTime` / `CloseAfterMinutes`).

## Параметры
- **Calendar File** (`CalendarFilePath`): путь к CSV-календарю DailyFX. Файл необходимо подготовить заранее (загрузка не выполняется автоматически).
- **Waiting Minutes** (`WaitingMinutes`): время в минутах до и после события, в течение которого допускается торговля.
- **Enable Timed Exit** (`EnableCloseByTime`): включает принудительное закрытие по истечении заданного времени.
- **Timed Exit Minutes** (`CloseAfterMinutes`): длительность удержания позиции при активированном таймере.
- **Risk (pips)** (`RiskPips`): расстояние до стоп-лосса в пунктах.
- **Reward Multiplier** (`RewardMultiplier`): множитель для тейк-профита относительно стоп-лосса.
- **Timer Frequency (sec)** (`TimerFrequencySeconds`): частота опроса CSV и проверки таймеров.
- **Calendar TZ Offset (h)** (`CalendarTimeZoneOffsetHours`): поправка по часовому поясу для времени из календаря.
- **Currency Map** (`CurrencyMap`): сопоставление валют календаря и торгуемых инструментов, например `EUR=EURUSD;USD=EURUSD;JPY=USDJPY`.
- **VolumeLevel1 .. VolumeLevel18**: размеры лотов для диапазонов отклонения. Значения по умолчанию повторяют советника и могут оптимизироваться.

## Особенности реализации
- CSV анализируется встроенным парсером с поддержкой кавычек, поэтому не нужны внешние зависимости.
- Для получения цен используется подписка на Level1 по каждому инструменту — это аналог вызовов `MarketInfo` из MQL.
- Объёмы подгоняются под `VolumeMin`/`VolumeStep`, что предотвращает проблему «некорректных лотов», описанную в оригинале.
- Управление стопами и тейками выполняется внутри стратегии по потоковым котировкам, без серверных OCO-заявок.
- DLL `str2double` заменена на обработку строк с очисткой от символов валют, разделителей тысяч и скобок.

## Как использовать
1. Загрузите CSV-календарь DailyFX и обеспечьте его актуальность (например, внешним скриптом).
2. Настройте `CurrencyMap`, чтобы каждому коду валюты соответствовал инструмент, доступный вашему подключению StockSharp.
3. Отрегулируйте параметры риска, прибыли и таблицу объёмов под свои требования.
4. Запустите стратегию. Она подпишется на Level1, будет опрашивать CSV с заданной частотой и открывать/закрывать позиции по выходу новостей.

## Отличия от исходного советника
- Нет встроенной HTTP-загрузки календаря: файл предоставляет пользователь или сторонний процесс.
- Для эмуляции `MarketInfo` и сопровождения сделок используются Level1-котировки.
- Объёмы автоматически нормируются под ограничения инструмента.
- Таймер закрытия реализован через `OnTimer`, а не через основной цикл `start` в MQL.
- Добавлен подробный лог для ситуаций с отсутствием инструментов или котировок, что упрощает отладку.
