# Стратегия «Position Size Calculator»

Этот пример переносит панель MetaTrader 5 «Position Size Calculator» в StockSharp. Стратегия не
размещает заявки, а лишь рассчитывает рекомендуемый объём позиции, сумму риска и требуемую маржу на
основе текущих котировок и настроек риск-менеджмента. Все результаты выводятся в журнал, поэтому их
удобно анализировать прямо в интерфейсе StockSharp.

## Алгоритм работы

1. Подписка на поток `Level1` для получения лучших бидов/асков и последней цены сделки.
2. Для каждого обновления котировок выбирается цена входа (для покупок — лучшая заявка на продажу,
   для продаж — лучшая заявка на покупку). Стоп-цена рассчитывается из параметра `Stop Loss (points)`.
3. Стоимость портфеля берётся по приоритету:
   - При включённом `Use Equity`: `Portfolio.CurrentValue`, затем `CurrentBalance`, затем `BeginValue`.
   - При выключенном `Use Equity`: `Portfolio.BeginBalance`, далее `CurrentBalance`, `BeginValue`, `CurrentValue`.
4. В зависимости от `Use Risk Money` риск берётся из абсолютного значения `Risk Money` или вычисляется
   как доля (`Risk Percent`) от оценённого капитала.
5. Дистанция до стопа переводится в денежный эквивалент через `Security.PriceStep` и `Security.StepPrice`.
   Полученный объём нормализуется по шагу объёма и ограничивается `MinVolume`/`MaxVolume`.
6. Комиссия учитывается как двойное значение параметра `Commission per Lot` (вход и выход). Маржа
   оценивается с помощью `MarginBuy`/`MarginSell`; если данные отсутствуют, используется приближение через цену входа.
7. При изменении расчёта значение сохраняется в `Strategy.Volume`, а в лог записывается единое сообщение
   с ценой входа, стопом, объёмом, риском в валюте и процентах, а также маржой.

## Параметры

| Параметр | Описание |
|----------|----------|
| `Stop Loss (points)` | Дистанция до стоп-лосса в ценовых шагах. |
| `Use Equity` | Использовать ли текущую стоимость счёта вместо стартового баланса. |
| `Use Risk Money` | Переключатель между процентным и денежным заданием риска. |
| `Risk Percent` | Доля капитала под риском, если `Use Risk Money = false`. |
| `Risk Money` | Сумма риска в валюте счёта, если `Use Risk Money = true`. |
| `Commission per Lot` | Комиссия за одну сторону сделки (лот). В расчёте учитываются обе стороны. |
| `Trade Direction` | Направление, для которого оценивается размер позиции. |

## Особенности

- Стратегия не выставляет заявок — только обновляет `Strategy.Volume` и пишет диагностические сообщения.
- Если нормализованный объём меньше минимального лота, результат отбрасывается, повторяя поведение MQL-версии.
- При отсутствии данных о котировках или портфеле стратегия ждёт, не создавая лишних записей в журнале.
- Сообщение журнала повторяет поля оригинального калькулятора: цена входа, стоп, объём, риск в деньгах,
  риск в процентах и маржа.

## Рекомендации по использованию

- Запускайте стратегию на нужном инструменте и портфеле. Для корректных расчётов инструмент должен
  предоставлять `PriceStep` и желательно `StepPrice`.
- Настройте `Commission per Lot` в соответствии с тарифами брокера, чтобы приблизить оценки к реальности.
- Все вычисленные величины доступны через свойства `RecommendedVolume`, `CalculatedRiskMoney`,
  `CalculatedRiskPercent`, `CalculatedMargin`, `LastEntryPrice`, `LastStopPrice`, что упрощает интеграцию
  с пользовательскими панелями и составными стратегиями.

## Отличия от версии для MetaTrader

- Графический интерфейс заменён параметрами стратегии в StockSharp.
- Значения риска и маржи публикуются в логе, а не в элементах формы.
- Нормализация объёма использует метаданные StockSharp (`VolumeStep`, `MinVolume`, `MaxVolume`),
  что соответствует поведению MetaTrader на типичных инструментах Forex/CFD.
