# Стратегия TCP Pivot Limit

## Обзор

Стратегия TCP Pivot Limit является адаптацией эксперта MetaTrader 4 **gpfTCPivotLimit.mq4**. Она вычисляет дневные уровни классических pivot-точек и отслеживает ложные пробои этих уровней на часовых свечах. Когда пробой не подтверждается, стратегия мгновенно открывает позицию в противоположном направлении, ориентируясь на противоположные уровни pivot. Данный вариант реализован на высокоуровневом API StockSharp и полностью повторяет логику оригинала.

Торговля ведётся по часовым свечам, и одновременно может быть открыта только одна позиция. В начале каждого нового торгового дня пересчитывается сетка уровней на основе максимума, минимума и цены закрытия предыдущего дня. Эти уровни используются для условий входа, фиксации прибыли, установки стоп-лосса и, при необходимости, трейлинга.

## Логика торговли

1. **Расчёт pivot-уровней**
   - При появлении первой свечи нового дня агрегируются максимум, минимум и закрытие прошедшего дня и вычисляются уровни Pivot, R1–R3 и S1–S3.
   - Каждый пересчёт сопровождается записью в лог, что позволяет отслеживать динамику уровней.

2. **Условия входа**
   - На каждой завершённой часовой свече анализируются две предыдущие завершённые свечи.
   - *Short*-позиция открывается, когда свеча два периода назад прокалывала сопротивление (или закрывалась выше него), но открывалась ниже, а последняя свеча закрылась обратно под уровнем. Это сигнал ложного пробоя и ожидание разворота вниз.
   - *Long*-позиция открывается зеркально: рынок прокалывает поддержку, но следующая свеча закрывается выше неё.
   - Одновременно допускается только одна позиция; объём задаётся параметром `OrderVolume`.

3. **Выход из позиции**
   - Стоп-лосс и тейк-профит определяются пресетом `TargetMode`, который полностью соответствует параметру `TgtProfit` оригинального эксперта:
     | Режим | Short вход | Short стоп | Short тейк | Long вход | Long стоп | Long тейк |
     |-------|------------|------------|------------|-----------|-----------|-----------|
     | 1     | R1         | R2         | S1         | S1        | S2        | R1        |
     | 2     | R1         | R2         | S2         | S1        | S2        | R2        |
     | 3     | R2         | R3         | S1         | S2        | S3        | R1        |
     | 4     | R2         | R3         | S2         | S2        | S3        | R2        |
     | 5     | R2         | R3         | S3         | S2        | S3        | R3        |
   - Если параметр `IntradayTrading` включён, открытая позиция принудительно закрывается на свече с часом 23:00, что исключает перенос через ночь.
   - Дополнительный трейлинг-стоп задаётся в пунктах (шаг цены инструмента). Он активируется только после прохождения ценой заданного расстояния в прибыль и закрывает позицию при откате на ту же величину, имитируя механику MetaTrader.

## Параметры

| Параметр | Описание |
|----------|----------|
| `OrderVolume` | Объём рыночных заявок на покупку и продажу. |
| `TargetMode` | Целое число от 1 до 5, выбирающее комбинацию уровней для входа, стопа и цели. |
| `TrailingPoints` | Дистанция трейлинг-стопа в пунктах. Ноль — отключение трейлинга. |
| `IntradayTrading` | При значении `true` позиции закрываются в 23:00 и стратегия работает только внутри дня. |
| `CandleType` | Тип используемых свечей. По умолчанию — часовые свечи, как в исходном советнике. |

## Дополнительные замечания

- Для корректной работы необходим непрерывный поток часовых свечей. При смене таймфрейма рекомендуется полноценное тестирование.
- Стопы и цели проверяются по экстремумам свечей. При ценовых разрывах фактическая цена выхода может отличаться от рассчитанной, что соответствует поведению оригинала.
- Трейлинг выполняется по закрытиям и максимумам/минимумам свечей, обеспечивая баланс между точностью и производительностью в инфраструктуре StockSharp.
