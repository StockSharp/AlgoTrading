# Торговая панель (ID 3468)

## Описание
**TradingPanelStrategy** — это помощник для ручного трейдинга, портированный из MQL5-советника *EA_TradingPanel*. Он предоставляет методы `PlaceBuyOrders()` и `PlaceSellOrders()`, которые повторяют действия кнопок BUY/SELL оригинальной панели: за один вызов отправляется серия рыночных заявок, автоматически рассчитываются стоп-лосс и тейк-профит в пипсах, а при необходимости выбирается альтернативный инструмент. Значения по умолчанию полностью совпадают с MQL-версией (1 сделка, стоп 2 пипса, тейк 10 пипсов, объем 0.01).

Вместо встроенного интерфейса MT5 стратегия ориентирована на интеграцию с пользовательскими окнами StockSharp: внешний код управляет панелью, а сама стратегия берет на себя нормализацию объемов, округление цен и постановку защитных ордеров.

## Параметры
| Имя | Назначение | Примечания |
| --- | ---------- | ---------- |
| `TradeCount` | Сколько рыночных заявок отправлять за одно действие. | Минимум 0. Значение по умолчанию `1`. |
| `StopLossPips` | Дистанция стоп-лосса в пипсах. | `0` отключает стоп. По умолчанию `2`. |
| `TakeProfitPips` | Дистанция тейк-профита в пипсах. | `0` отключает тейк. По умолчанию `10`. |
| `VolumePerTrade` | Объем одной рыночной заявки. | Нормализуется по `VolumeStep`. По умолчанию `0.01`. |
| `TargetSecurity` | Необязательный инструмент, отличный от `Strategy.Security`. | Если не задан, используется основной инструмент стратегии. |

Все параметры созданы через `StrategyParam<T>`, поэтому доступны для оптимизации и интерактивного изменения из интерфейса StockSharp.

## Как работает стратегия
1. Определяет активный инструмент (`TargetSecurity` либо `Strategy.Security`).
2. Вычисляет размер пипса: при количестве знаков после запятой ≥ 3 умножает `PriceStep` на 10, как и в исходном советнике.
3. Получает актуальную цену (лучший бид/аск либо последнюю сделку) и приводит ее к допустимому шагу через `Security.ShrinkPrice`.
4. Рассчитывает желаемый объем `TradeCount × VolumePerTrade`, учитывает ограничения `MinVolume`/`MaxVolume`/`VolumeStep` и добавляет объем для закрытия противоположной позиции, чтобы одно действие могло развернуть позицию.
5. Отправляет рыночную заявку `BuyMarket` или `SellMarket`.
6. Создает защитные ордера (стоп и лимит) с учетом выбранных дистанций в пипсах.
7. При остановке стратегии или смене направления отменяет устаревшие защитные заявки.

## Логика защитных ордеров
- Для лонга ставится `SellStop` (стоп) и `SellLimit` (тейк).
- Для шорта ставится `BuyStop` (стоп) и `BuyLimit` (тейк).
- Объем защитных заявок соответствует объемy, запрошенному панелью.
- Очистка ссылок выполняется в `OnStopped`, `OnReseted` и при переходе на противоположное направление.

## Рекомендации по использованию
- До вызова методов панели назначьте `Strategy.Security` или заполните `TargetSecurity`, иначе сделки не будут отправлены.
- Методы `PlaceBuyOrders()` и `PlaceSellOrders()` предназначены для вызова из внешнего интерфейса, который заменяет кнопки MT5.
- Если нет данных лучшего бида/аска и последней сделки, стратегия запишет ошибку и пропустит отправку.
- В `OnStarted` вызывается `StartProtection()`, чтобы защититься от «зависших» позиций после перезапуска.
- При отсутствии `PriceStep` у инструмента используется значение `0.0001`. Задайте шаг вручную, если ваш брокер использует другой размер пипса.

## Отличия от MQL-версии
- В стратегии отсутствует встроенный графический интерфейс; его следует реализовать отдельно либо управлять методами напрямую.
- Стопы и тейки агрегируются на весь объем действия, а не на каждый отдельный тикет MT5, что упрощает реализацию при сохранении конечного результата.
- Выполняется дополнительная проверка объемов и цен согласно требованиям биржи (`VolumeStep`, `MinVolume`, `MaxVolume`, `Security.ShrinkPrice`).
- Для удобства контроля добавлены журнальные сообщения `LogInfo` и `LogError`.

## Порядок запуска
1. Создайте стратегию, назначьте портфель и инструмент.
2. Запустите стратегию, чтобы активировать `StartProtection()`.
3. Подключите пользовательский интерфейс к методам `PlaceBuyOrders()` и `PlaceSellOrders()`.
4. Следите за сообщениями лога и при необходимости реализуйте дополнительные проверки на стороне UI.

Стратегия предлагает детальную и точную адаптацию панели MT5 к высокоуровневой инфраструктуре StockSharp, сохраняя удобство ручного ввода сделок.
