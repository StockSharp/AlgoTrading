# Стратегия Small Inside Bar

## Общее описание
Small Inside Bar Strategy ищет компактную фигуру «внутренний бар» и после её формирования реагирует на изменение настроения между двумя последовательными свечами. Изначальный советник MetaTrader 5 был перенесён на высокоуровневый API StockSharp, поэтому расчёты ведутся исключительно по закрытым свечам. Подход подойдёт трейдерам, предпочитающим входы на пробой после фаз низкой волатильности.

## Определение паттерна
Стратегия анализирует две последние закрытые свечи:

1. **Условие внутреннего бара** – текущая завершённая свеча должна полностью находиться внутри диапазона предыдущей.
2. **Фильтр по размеру** – диапазон «материнской» свечи (две свечи назад) обязан как минимум в заданное число раз превышать диапазон внутреннего бара. Значение по умолчанию – 2:1.
3. **Направленные фильтры** –
   - Для покупки требуется бычий внутренний бар, расположенный в нижней половине материнской свечи, и медвежья материнская свеча.
   - Для продажи требуется медвежий внутренний бар, расположенный в верхней половине материнской свечи, и бычья материнская свеча.
4. Опция реверса меняет местами трактовку длинных и коротких сигналов, сохраняя геометрию свечей.

## Управление позициями
Параметр `OpenMode` повторяет режимы оригинального эксперта:

- **AnySignal** – отправлять рыночную заявку при каждом сигнале. При наличии противоположной позиции она частично перекрывается, поскольку в StockSharp используется неттинг.
- **SwingWithRefill** – перед входом закрывать противоположное направление и разрешать добавления к текущему тренду.
- **SingleSwing** – держать не более одной позиции в рынке; новые сигналы игнорируются, пока активна позиция в ту же сторону.

Длинные и короткие входы можно включать отдельно. Реверс просто меняет, какая комбинация условий генерирует покупку или продажу.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `CandleType` | Таймфрейм 1 час | Тип свечей, по которым ищется паттерн. |
| `RangeRatioThreshold` | 2.0 | Минимальное отношение диапазона материнской свечи к внутреннему бару. |
| `EnableLong` | true | Разрешить длинные сделки. |
| `EnableShort` | true | Разрешить короткие сделки. |
| `ReverseSignals` | false | Инвертировать направления сигналов. |
| `OpenMode` | SwingWithRefill | Сценарий обработки существующей позиции при новом сигнале. |

## Логика торговли
1. Подписаться на выбранную свечную серию и ждать закрытия баров.
2. Хранить две последние завершённые свечи для оценки паттерна.
3. При совпадении всех условий определить направление входа, при необходимости применив реверс.
4. Проверить доступность торговли через `IsFormedAndOnlineAndAllowTrading` и разрешение нужного направления.
5. Рассчитать объём заявки с учётом `OpenMode` и отправить рыночную сделку с базовым объёмом стратегии.
6. Обновить внутреннюю историю свечей, чтобы следующая проверка использовала актуальные значения.

## Особенности реализации
- Вызывается `StartProtection()` без параметров, что активирует стандартный риск-менеджер StockSharp (уровни SL/TP можно добавить отдельно).
- В памяти хранятся только две свечи, дополнительные коллекции не используются.
- Вся логика строится на закрытых свечах, что соответствует рекомендациям по использованию высокоуровневого API.
