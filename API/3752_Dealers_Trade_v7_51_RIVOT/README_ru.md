# Dealers Trade v7.51 RIVOT (C#)

## Краткое описание

Dealers Trade v7.51 — это советник MetaTrader 4 (`Dealers_Trade_v_7.51_RIVOT.mq4`), основанный на сетке с элементами мартингейла. Портированная версия в StockSharp повторяет исходную концепцию: направление задаётся классическим и плавающим пивотом, а каждый неблагоприятный откат на заданное число пунктов приводит к добавлению позиции с увеличенным объёмом. Риск контролируется стоп-лоссом, тейк-профитом и опциональным трейлинг-стопом.

## Логика работы

1. **Пивоты**
   - Для каждой завершённой свечи рассчитываются две опорные цены:
     - **Классический пивот** `P = (High_{prev} + Low_{prev} + Close_{prev} + Open_{curr}) / 4`;
     - **Плавающий пивот** `FLP = (High_{curr} + Low_{curr} + Close_{curr}) / 3`.
   - Торговля разрешается только при разнице между пивотами не меньше `GapThreshold` пунктов.

2. **Определение направления**
   - Если закрытие свечи выше обоих пивотов, активируется **лонговый** сценарий;
   - Если закрытие ниже обоих пивотов — **шортовый**;
   - Направление сохраняется, пока текущая серия сделок не будет полностью закрыта.

3. **Добавление позиций**
   - Одновременно ведётся только одна серия усреднений;
   - Первая сделка открывается сразу после подтверждения направления;
   - Следующие сделки добавляются, когда цена двигается против позиции минимум на `PipDistance` пунктов от последнего входа;
   - Объём каждой новой сделки умножается на `VolumeMultiplier`, но не превышает `MaxVolume`;
   - Общее количество сделок в серии ограничено `MaxTrades`.

4. **Управление рисками**
   - Стоп-лосс закрывает всю серию при движении против позиции на `StopLoss` пунктов от средневзвешенной цены входа;
   - Тейк-профит забирает прибыль при движении в нужную сторону на `TakeProfit` пунктов;
   - При включённом трейлинг-стопе фиксируется лучшая цена и подтягивается защитный уровень на расстоянии `TrailingStop` пунктов.

5. **Сброс состояния**
   - Любое полное закрытие позиции (стоп, тейк, трейлинг или ручное) очищает счётчики и снимает направление.

## Параметры

| Параметр | Значение по умолчанию | Назначение |
|----------|-----------------------|------------|
| `Volume` | 1 | Базовый объём первой сделки. |
| `MaxTrades` | 5 | Максимум сделок в одной серии. |
| `PipDistance` | 4 | Минимальный откат против позиции для следующего входа. |
| `TakeProfit` | 15 | Тейк-профит от средневзвешенной цены входа. |
| `StopLoss` | 90 | Стоп-лосс от средневзвешенной цены входа. |
| `TrailingStop` | 15 | Шаг трейлинг-стопа; 0 — отключено. |
| `VolumeMultiplier` | 1.5 | Множитель объёма при усреднении. |
| `MaxVolume` | 5 | Верхний предел объёма отдельной сделки. |
| `GapThreshold` | 7 | Минимальная разница между пивотами для активации торговли. |
| `CandleType` | Свечи M15 | Тип свечей, используемых для расчётов. |

Все параметры описаны через `StrategyParam<T>`, поэтому легко оптимизируются в Designer и других модулях StockSharp.

## Практические рекомендации

- Для работы стратегии достаточно свечных данных, поток заявок или тиков не требуется, но важно, чтобы провайдер поставлял выбранный таймфрейм.
- StockSharp использует агрегированную позицию, поэтому код хранит внутреннюю средневзвешенную цену, чтобы повторить поведение MT4 с несколькими ордерами.
- При наличии графика стратегия рисует две линии (`Pivot` и `FloatingPivot`) для визуального контроля уровней.
- Новое направление оценивается только после завершения текущей серии сделок.

## Отличия от версии MT4

- В MT4 советник выводил текст и объекты на графике; в StockSharp оставлена только функциональная часть, визуализация заменена линиями.
- Логика «защиты счёта» (учёт магических номеров, вручную заданных стоимостей пункта и т. п.) опущена как нерелевантная для StockSharp.
- Проверка условий `Ask == tp` заменена на сравнение с ценой свечи; управление позициями происходит рыночными ордерами при обработке свечей.

## Файлы

- `CS/DealersTradeV751RivotStrategy.cs` — C#-реализация стратегии.
- `README.md` — подробное описание на английском языке.
- `README_cn.md` — документация на китайском языке.

