# Dealers Trade v7.51 RIVOT（C#）

## 摘要

Dealers Trade v7.51 最初是 MetaTrader 4 平台上的 `Dealers_Trade_v_7.51_RIVOT.mq4` 专家顾问，属于典型的基于枢轴的网格马丁策略。本移植版本在 StockSharp 平台上重建了核心思想：利用经典枢轴价位与浮动枢轴价位之间的差异判定方向，只要价格向不利方向回撤到设定的点差，就逐步加仓并放大手数，同时通过止损、止盈与跟踪止损控制风险。

## 交易逻辑

1. **枢轴体系**
   - 每根完成的 K 线都会计算两条参考线：
     - **经典枢轴** `P` = `(上一根最高价 + 上一根最低价 + 上一根收盘价 + 当前开盘价) / 4`；
     - **浮动枢轴** `FLP` = `(当前最高价 + 当前最低价 + 当前收盘价) / 3`。
   - 当 `P` 与 `FLP` 之间的点差超过 `GapThreshold` 时，策略才允许在本根 K 线进行交易。

2. **方向判断**
   - 收盘价同时高于两条枢轴且满足点差过滤时，建立 **多头** 偏向；
   - 收盘价同时低于两条枢轴且满足点差过滤时，建立 **空头** 偏向；
   - 在当前加仓序列关闭之前，偏向保持不变。

3. **加仓方式**
   - 同一时间仅允许存在一个网格序列；
   - 第一笔订单在偏向确认后立即执行；
   - 只有当价格相对上一次成交向不利方向回撤至少 `PipDistance` 个点时，才会触发下一笔加仓；
   - 新订单手数按 `VolumeMultiplier` 倍数递增，但不会超过 `MaxVolume`；
   - 序列中的订单数量受 `MaxTrades` 限制。

4. **风险控制**
   - 以加权平均开仓价为基准，`StopLoss` 点的浮动止损触发全仓平仓；
   - 价格向有利方向运行 `TakeProfit` 点时，触发统一止盈；
   - 如果 `TrailingStop` 大于零，策略会在盈利扩大的同时移动跟踪止损，锁定部分收益。

5. **重置条件**
   - 当仓位被止损、止盈、跟踪止损或手动平仓后，加仓计数与方向状态都会被重置。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `Volume` | 1 | 首笔订单的基础手数。 |
| `MaxTrades` | 5 | 同一序列内最多允许的订单数量。 |
| `PipDistance` | 4 | 触发下一笔加仓所需的最小不利点数。 |
| `TakeProfit` | 15 | 相对平均开仓价的整体止盈距离。 |
| `StopLoss` | 90 | 相对平均开仓价的整体止损距离。 |
| `TrailingStop` | 15 | 跟踪止损与价格之间保持的点差，设为 0 表示关闭。 |
| `VolumeMultiplier` | 1.5 | 每次加仓后手数放大的倍数。 |
| `MaxVolume` | 5 | 单笔订单手数的上限。 |
| `GapThreshold` | 7 | 启动交易所需的最小枢轴点差。 |
| `CandleType` | 15 分钟时间框架 | 计算所用的 K 线类型。 |

所有参数均通过 `StrategyParam<T>` 声明，可在 StockSharp Designer 或回测环境中直接优化。

## 使用提示

- 策略完全依赖 K 线数据，无需逐笔报价；请确保数据源能够提供所选时间框架的蜡烛序列。
- StockSharp 默认采用净头寸模型，代码会维护内部的加权平均价来模拟 MT4 的多笔订单效果。
- 如果图表区域可用，程序会绘制 `Pivot` 与 `FloatingPivot` 两条参考线以便观察。
- 策略不会在持仓过程中反向开仓，只有在当前序列结束后才会评估新的方向。

## 与 MQL 版本的差异

- 原始 EA 会在 MT4 图表上绘制标签与文字提示，移植版本仅保留交易逻辑，并以图表线条代替视觉提示。
- 与账户余额、魔术号、品种点值相关的保护逻辑在 StockSharp 中不再需要，因此被删除。
- MT4 中基于 `Ask == tp` 的精确出场在此实现中转换为对 K 线价格的比较。
- 下单与平仓统一使用 `BuyMarket` / `SellMarket`，并在 K 线更新时执行风控，不再遍历 MT4 的订单列表。

## 最佳实践

- 在真实交易前务必进行历史回测或模拟盘测试，并考虑点差和手续费的影响。
- 对于波动性较大的品种，可适当降低 `VolumeMultiplier` 或 `MaxTrades` 以控制回撤。
- 可根据需要调整 `CandleType`（例如 M15、H1 等）以契合原始策略的使用场景。

## 文件

- `CS/DealersTradeV751RivotStrategy.cs` —— C# 策略实现。
- `README.md` —— 英文说明文档。
- `README_ru.md` —— 俄文说明文档。

