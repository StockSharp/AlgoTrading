# Стратегия Trend Line

## Краткое описание
Стратегия Trend Line повторяет базовый алгоритм исходного эксперта MetaTrader: используется связка из быстрой и медленной линейно-взвешенных скользящих средних, фильтр по индикатору Momentum и подтверждение через MACD. В реализации StockSharp задействован высокоуровневый API, что позволяет сохранить структуру исходного советника, но отказаться от ручного рисования линий тренда. Управление рисками осуществляется при помощи стоп-лосса, тейк-профита и опционального трейлинг-стопа в ценовых шагах.

## Логика работы
1. Подписка на выбранный тип свечей и расчёт следующих индикаторов:
   - Быстрая LWMA с периодом `FastMaPeriod`.
   - Медленная LWMA с периодом `SlowMaPeriod`.
   - Индикатор Momentum с периодом `MomentumPeriod`; хранятся три последних значения для имитации проверки нескольких баров, как в MQL-версии.
   - Индикатор MACD со стандартными периодами, значения основной и сигнальной линий сохраняются для фильтрации сигналов.
2. Открытие длинной позиции происходит, когда:
   - Быстрая LWMA расположена выше медленной;
   - Хотя бы одно из трёх последних значений Momentum превышает `MomentumBuyThreshold`;
   - Основная линия MACD выше сигнальной;
   - Отсутствует короткая позиция (при наличии она закрывается перед входом в лонг).
3. Открытие короткой позиции происходит, когда:
   - Быстрая LWMA находится ниже медленной;
   - Хотя бы одно из трёх последних значений Momentum меньше или равно `MomentumSellThreshold` (порог задаётся отрицательным, чтобы фиксировать нисходящую инерцию);
   - Основная линия MACD ниже сигнальной;
   - Нет открытой длинной позиции (при наличии она закрывается перед входом в шорт).
4. После входа выставляются стоп-лосс и тейк-профит на заданном расстоянии в шагах цены. Каждый раз при изменении позиции уровни пересчитываются.
5. Если заданы `TrailingStopSteps` и `TrailingTriggerSteps`, включается трейлинг-стоп: после достижения прибыли, равной триггеру, стоп переносится на расстояние `TrailingStopSteps` от текущей цены закрытия обрабатываемой свечи.

## Параметры
- `CandleType` – тип свечей для расчёта индикаторов (по умолчанию часовые).
- `FastMaPeriod` – период быстрой LWMA (6 по умолчанию).
- `SlowMaPeriod` – период медленной LWMA (85 по умолчанию).
- `MomentumPeriod` – период индикатора Momentum (14 по умолчанию).
- `MomentumBuyThreshold` – минимальное положительное значение Momentum для входа в лонг (0.3 по умолчанию).
- `MomentumSellThreshold` – максимальное (отрицательное) значение Momentum для входа в шорт (-0.3 по умолчанию).
- `MacdFastLength` – период быстрой EMA в MACD (12 по умолчанию).
- `MacdSlowLength` – период медленной EMA в MACD (26 по умолчанию).
- `MacdSignalLength` – период сигнальной EMA в MACD (9 по умолчанию).
- `StopLossSteps` – расстояние стоп-лосса в шагах цены (20 по умолчанию).
- `TakeProfitSteps` – расстояние тейк-профита в шагах цены (50 по умолчанию).
- `TrailingStopSteps` – величина трейлинг-стопа в шагах цены (40 по умолчанию, 0 отключает функцию).
- `TrailingTriggerSteps` – прибыль в шагах цены, необходимая для активации трейлинг-стопа (40 по умолчанию).

## Дополнительно
- Сигналы обрабатываются только на закрытых свечах, что предотвращает ложные срабатывания.
- Методы `SetStopLoss` и `SetTakeProfit` оперируют расстоянием в шагах цены, поэтому стратегия корректно работает с инструментами с различным минимальным тиком.
- Для коротких сигналов порог `MomentumSellThreshold` следует задавать отрицательным. При положительном значении условие выполнится сразу.
- Трейлинг-стоп обновляется по завершении каждой свечи, что соответствует оригинальному советнику, пересчитывающему уровни на открытии нового бара.
- Функции, зависящие от графических объектов терминала (построение трендовых линий, экстренное закрытие по equity), не перенесены, поскольку в StockSharp они требуют отдельного пользовательского интерфейса. Основные правила входа и сопровождения сделки сохранены.
