# Стратегия Fetch News

## Общее описание
- Порт эксперта MetaTrader 5 *FetchNews* (NewsEA.mq5) на высокоуровневый API StockSharp.
- Отслеживает пользовательский макроэкономический календарь и по выбранному режиму либо фиксирует предупреждения, либо ставит отложенные заявки.
- Подходит трейдерам, которые заранее собирают календарь новостей и хотят автоматизировать подготовку к публикации.
- Использует поток Level1 для получения лучших bid/ask и вспомогательные методы защиты (`SetStopLoss`, `SetTakeProfit`) для постановки стоп-лоссов и тейк-профитов.

## Режимы работы
1. **Alerting** (`Mode = Alerting`).
   - Отбирает события по важности (`AlertImportance`) и валютам инструмента (`OnlySymbolCurrencies`).
   - Пишет в журнал сообщение вида `Upcoming important news event: CPI at 2024-06-12T12:30:00Z (USD).`.
   - Торговых действий не выполняет — режим подходит для мониторинга.
2. **Trading** (`Mode = Trading`).
   - Также учитывает валютный фильтр (`OnlySymbolCurrencies`).
   - Требует, чтобы название события содержало одно из ключевых слов из `TradingKeywords` (разделитель `;`, `,` или перевод строки).
   - Событие становится активным за `LookBackSeconds` до указанного времени и остаётся активным `LookAheadSeconds` после публикации. Перед постановкой заявок стратегия проверяет:
     - Отсутствие открытой позиции и других активных страддлов.
     - Наличие последних значений bid/ask из Level1.
     - Определённость шага цены для пересчёта "пунктов" MetaTrader в реальные цены.
   - Выставляется две отложенные заявки:
     - Buy Stop по цене `ask + TakeProfitPoints * PriceStep`.
     - Sell Stop по цене `bid - TakeProfitPoints * PriceStep`.
   - После исполнения одной из сторон противоположная заявка отменяется, а для результата сделки выставляются защитные заявки с расстояниями `StopLossPoints` и `TakeProfitPoints`.
   - Отложенные заявки автоматически снимаются через `OrderLifetimeSeconds` секунд или при закрытии позиции.

## Формат календаря
Параметр `CalendarEventsDefinition` принимает события построчно (разделители — перевод строки или `;`). Каждая строка должна содержать минимум четыре значения, разделённые запятыми:

```
ДатаВремя, Валюта, Важность, Название
```

- **ДатаВремя** — распознаётся через `DateTime.TryParse` с инвариантной культурой, пример: `2024-06-12 12:30`.
- **Валюта** — код валюты события (`USD`, `EUR` и т.п.).
- **Важность** — допустимые значения: `Low`, `Moderate`, `High`, а также синонимы (`medium`, `important`).
- **Название** — полное описание события. Дополнительные запятые входят в название.

`TimeZoneOffsetHours` позволяет скорректировать часовой пояс календаря перед переводом времени в UTC. Например, для летнего восточного времени США (UTC-4) укажите `-4`. Сравнение выполняется в UTC по времени Level1 сообщений.

### Пример
```
2024-06-12 12:30,USD,High,Consumer Price Index (YoY)
2024-06-12 14:00,USD,Moderate,FOMC Interest Rate Decision
2024-06-13 08:00,EUR,High,ECB Press Conference
```

## Параметры
| Параметр | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `Mode` | Режим предупреждений или торговли. | `Alerting` |
| `OrderVolume` | Объём каждой отложенной заявки в лотах. | `0.1` |
| `TakeProfitPoints` | Расстояние от входа до тейк-профита в пунктах. | `150` |
| `StopLossPoints` | Расстояние от входа до стоп-лосса в пунктах. | `150` |
| `OrderLifetimeSeconds` | Время жизни отложенных заявок в секундах. | `500` |
| `LookBackSeconds` | За сколько секунд до события начать обработку. | `50` |
| `LookAheadSeconds` | Сколько секунд после события поддерживать активность. | `50` |
| `TradingKeywords` | Ключевые слова для торгового режима. | `cpi;ppi;interest rate decision` |
| `CalendarEventsDefinition` | Текст с событиями календаря. | пусто |
| `TimeZoneOffsetHours` | Сдвиг календаря по часовому поясу (часы). | `0` |
| `AlertImportance` | Минимальная важность для режима оповещений. | `Moderate` |
| `OnlySymbolCurrencies` | Ограничение по валютам, извлечённым из тикера. | `true` |

## Последовательность работы
1. `OnStarted` очищает состояние, загружает валютные фильтры, ключевые слова и календарь, подписывается на Level1. Вызов `StartProtection()` активирует защитный менеджер заявок.
2. Каждое обновление Level1 (`ProcessLevel1`) сохраняет bid/ask, снимает просроченные заявки и проверяет календарь в пределах активного окна.
3. В режиме предупреждений событие логируется один раз. В торговом режиме `ProcessTrading` подтверждает условия и выставляет страддл.
4. `OnNewMyTrade` определяет, какая заявка сработала, отменяет противоположную и сразу назначает стоп-лосс/тейк-профит для текущей позиции.
5. `OnPositionChanged` сбрасывает таймер срока жизни отложенных заявок при выходе в ноль, разрешая обработку следующего события.

## Отличия от версии MetaTrader
- В MetaTrader календарь загружался автоматически от брокера. В StockSharp события нужно заполнять вручную через `CalendarEventsDefinition`.
- В MT5 стоп и тейк можно было задать прямо в отложенной заявке. В StockSharp они выставляются уже после исполнения через `SetStopLoss` и `SetTakeProfit`.
- Определение валюты инструмента выполнено эвристически: берутся трёхбуквенные сегменты из кода инструмента (`EURUSD`, `GBP/JPY`). При необходимости отключите `OnlySymbolCurrencies`.
- Предупреждения выводятся через систему логирования (`LogInfo`), а не всплывающими окнами.

## Рекомендации по использованию
- Храните календарь во внешнем файле, а перед запуском стратегии вставляйте его содержимое в `CalendarEventsDefinition`.
- Настраивайте список ключевых слов (например, `cpi;ppi;interest rate decision;nfp`), чтобы отсекать малозначимые новости.
- Используйте поток котировок с поддержкой лучших bid/ask, иначе страддл не будет выставлен.
- Перед реальной торговлей протестируйте стратегию в симуляторе StockSharp, чтобы убедиться, что защитные заявки ведут себя корректно.
