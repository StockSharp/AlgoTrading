# Стратегия SampleTrailingstop MT5

## Описание
**SampleTrailingstopMt5Strategy** переносит в StockSharp логику советника MetaTrader 5 `SampleTrailingstop-MT5.mq5`. Стратегия круглосуточно поддерживает две встречные стоп-заявки на пробой, оформляет отдельные защитные ордера после входа и включает трейлинг-стоп при появлении плавающей прибыли. Все расчёты выполняются в «пунктах» и приводятся к цене через шаг цены инструмента, благодаря чему поведение совпадает с исходным МQL-скриптом.

## Логика работы
1. **Подписка на данные.** Используются котировки Level1 (лучшие bid/ask), которые инициируют обновление заявок и трейлинг-стопа.
2. **Вход в позицию.**
   - На основе `BuyStop` выставляется покупка выше рынка. Новая заявка создаётся только после завершения предыдущей.
   - Зеркально размещается `SellStop` ниже текущей цены.
   - Обе заявки используют одинаковый объём, стоп-лосс и тейк-профит, а также получают срок действия +1 сутки, как в оригинальном файле.
3. **Защита позиции.**
   - После сделок рассчитывается знаковая позиция и средняя цена входа.
   - Создаются отдельные защитные заявки: стоп-ордер (`SellStop`/`BuyStop`) и тейк-профит (`SellLimit`/`BuyLimit`), чтобы уровни сохранялись даже после отмены входных ордеров.
   - При изменении позиции или цены входа параметры защитных заявок синхронизируются автоматически.
4. **Трейлинг-стоп.**
   - Когда прибыль достигает заданной дистанции, стоп подтягивается на фиксированное расстояние от текущего bid (для лонга) или ask (для шорта).
   - Стоп не пересекает цену входа и обновляется минимум на один шаг цены.
5. **Учёт позиции.** Каждая своя сделка пересчитывает объём позиции и среднюю цену с учётом частичных закрытий и разворотов.

## Параметры
| Параметр | Назначение |
|----------|------------|
| `TradeVolume` | Постоянный объём для обеих пробойных стоп-заявок. |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах. Ноль отключает тейк-профит. |
| `StopLossPoints` | Дистанция защитного стоп-лосса в пунктах. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа в пунктах. Ноль отключает трейлинг. |

## Дополнительные детали
- Новые стоп-заявки размещаются только после завершения предыдущих, что соответствует функции `CheckPendingOrder` из оригинала.
- Перевод пунктов в цены выполняется через `Security.PriceStep`, что делает стратегию универсальной для инструментов с любой точностью.
- При полном закрытии позиции все защитные заявки отменяются, а внутренние состояния обнуляются.
- Для работы достаточно данных Level1; свечи и индикаторы не требуются, поэтому перенос максимально близок к MQL-версии.

## Порядок использования
1. Перед стартом задайте инструмент и портфель.
2. Настройте параметры: объём, дистанции стоп-лосса, тейк-профита и трейлинг-стопа под конкретный рынок.
3. Запустите стратегию — она самостоятельно будет поддерживать пробойные ордера и защиту позиции.
