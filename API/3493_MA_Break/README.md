# M.A Break Strategy

This strategy replicates the behaviour of the MetaTrader "M.A break mt5 buy" and "M.A break mt5 sell" experts by combining both breakout directions into a single StockSharp implementation. It watches a configurable candle series, analyses several exponential moving averages, and confirms a strong impulse candle before opening trades. Positions are managed through fixed protective stops and targets measured in pips.

## Trading logic

1. **Trend confirmation.** Two EMA pairs (fast vs. slow) must be aligned in the trade direction on the completed candle. For longs both fast averages must be above their slow counterparts; for shorts the relationships are inverted. The previous candle open also has to be on the correct side of a dedicated EMA filter.
2. **Quiet-range measurement.** A configurable number of earlier candles (excluding the most recent impulse candle) define the "quiet" period. Their highest range is compared against a minimum pip threshold.
3. **Impulse detection.** The latest finished candle must expand by at least `ImpulseStrength` times the quiet range. Candle size limits in pips can be enforced to ignore unusually small or large moves.
4. **Candlestick template.** The impulse candle must exhibit a specific wick structure:
   - Long trades: bullish body, upper wick not exceeding `BullUpperWickPercent` of the candle range, and lower wick at least `BullLowerWickPercent` of the range.
   - Short trades: bearish body, upper wick of at least `BearUpperWickPercent`, and lower wick not larger than `BearLowerWickPercent` of the range.
5. **Pullback condition.** The impulse low (for longs) or high (for shorts) must test an additional EMA to guarantee that the breakout emerged from a pullback.
6. **Position control.** Only one net position is allowed. The strategy closes the opposite side before entering a new trade and never opens a position against the trend filter.
7. **Exit management.** Stop-loss and take-profit levels are calculated in pips from the entry price. Each finished candle checks whether the price has touched the protective levels and exits accordingly.

## Parameters

| Parameter | Description |
|-----------|-------------|
| **Candle Type** | Primary candle series used for all calculations. |
| **Fast MA 1 / Slow MA 1** | Periods of the first EMA pair that defines the primary trend. |
| **Fast MA 2 / Slow MA 2** | Periods of the secondary EMA pair used as an additional trend filter. |
| **Open Filter MA** | EMA period that filters the previous candle open price. |
| **Pullback MA** | EMA period whose value must be touched by the impulse wick. |
| **Quiet Bars** | Number of historical candles used to measure the quiet market range. |
| **Quiet Range (pips)** | Minimal pip range required across the quiet candles before considering a breakout. |
| **Impulse Multiplier** | Minimal ratio between the impulse candle size and the quiet range. |
| **Min / Max Candle Size (pips)** | Optional limits for the impulse candle range. Zero disables the respective bound. |
| **Bull Upper Wick % / Bull Lower Wick %** | Shape filters for the bullish impulse candle, expressed as percentages of the candle range. |
| **Bear Upper Wick % / Bear Lower Wick %** | Shape filters for the bearish impulse candle. |
| **Volume** | Order size in lots used for both long and short entries. |
| **Stop-Loss (pips)** | Distance to the protective stop measured from the entry price. Zero disables the stop. |
| **Take-Profit (pips)** | Distance to the profit target. Zero disables the target. |
| **Enable Long / Enable Short** | Toggle breakout trading in each direction independently. |

## Usage notes

- Configure the candle series to match the timeframe used by the original expert (for example, M5 or H1). The default is a 5-minute timeframe.
- The strategy stores only the recent history required for the quiet-range calculation, preventing unnecessary memory usage.
- Entry prices are approximated by the impulse candle close, which matches the original MetaTrader behaviour of placing market orders at the beginning of the next bar.
- Stop-loss and take-profit levels are evaluated on every completed candle. If both levels are hit within the same bar the stop has priority, mirroring the conservative handling used in the source experts.
- Enabling only one direction reproduces the original "buy" or "sell" expert advisors, while leaving both toggles active allows symmetric breakout trading.

## Conversion details

- Both original MQ5 files were encoded in UTF-16 and built from blocks generated by the FXD engine. Each block has been translated into explicit C# logic.
- EMA comparisons and candlestick templates follow the same shifts as the MetaTrader version (`Shift = 1`), meaning the strategy always evaluates fully closed candles.
- Virtual stop logic and chart labels from the MQ5 scripts were intentionally omitted because they do not influence order placement.

## Testing

Compile the solution through `AlgoTrading.sln` or run the strategy inside the StockSharp strategy tester. Adjust the instrument price step if the security metadata lacks this information; the implementation falls back to `0.0001` to emulate common FX pip values.
