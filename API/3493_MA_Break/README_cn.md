# M.A均线突破策略

该策略源自MetaTrader上的“M.A break mt5 buy”和“M.A break mt5 sell”专家顾问，并将两个方向的逻辑整合为一个StockSharp策略。策略订阅指定周期的K线，在每根收盘K线上分析多组指数移动平均线（EMA），并验证是否出现足够强烈的突破动能。只有当所有过滤条件满足时才会建仓，并按照固定的止损与止盈（以点数衡量）管理头寸。

## 交易流程

1. **趋势确认**：两组快慢EMA必须按做单方向排列——做多时两条快线都要高于对应的慢线，做空时反之。上一根K线的开盘价还必须位于额外的EMA过滤器正确的一侧。
2. **安静区间测量**：在突破K线之前，向前回看若干根“安静K线”，记录它们的最大高低波动范围，并与设置的最小点数阈值比较。
3. **动量判定**：最新收盘K线的实体波幅需要至少是安静区间的`ImpulseStrength`倍，可选的最小与最大K线范围限制用于过滤异常的K线。
4. **K线形态过滤**：突破K线需要满足特定的影线结构：
   - 多单：必须是阳线，上影线不超过`BullUpperWickPercent`的百分比，下影线不少于`BullLowerWickPercent`的百分比。
   - 空单：必须是阴线，上影线至少占`BearUpperWickPercent`，下影线不得超过`BearLowerWickPercent`。
5. **回踩确认**：突破K线的低点（做多）或高点（做空）必须触及另一条EMA，保证行情确实从回踩位置爆发。
6. **持仓控制**：策略始终保持单一净仓位。如果已经持有反向仓位，会先平仓再开新单，并且绝不会逆势开仓。
7. **退出管理**：根据入场价和点数距离计算止损与止盈。在每根已收K线结束时检查是否触发保护价位，并立即平仓。若同一根K线同时触发止损与止盈，则以止损为优先。

## 参数说明

| 参数 | 说明 |
|------|------|
| **Candle Type** | 参与计算的主要K线数据类型与周期。 |
| **Fast MA 1 / Slow MA 1** | 第一组EMA的周期，用于基础趋势过滤。 |
| **Fast MA 2 / Slow MA 2** | 第二组EMA的周期，提供额外趋势确认。 |
| **Open Filter MA** | 与上一根K线开盘价比较的EMA周期。 |
| **Pullback MA** | 必须被突破K线影线触及的EMA周期，用来确认回踩。 |
| **Quiet Bars** | 参与安静区间测量的K线数量。 |
| **Quiet Range (pips)** | 安静区间需要达到的最小点数波幅。 |
| **Impulse Multiplier** | 突破K线实体波幅与安静区间之间的倍数要求。 |
| **Min / Max Candle Size (pips)** | 突破K线允许的最小与最大点数范围，设置为0表示不限制。 |
| **Bull Upper Wick % / Bull Lower Wick %** | 多头突破K线的上影线最大比例与下影线最小比例。 |
| **Bear Upper Wick % / Bear Lower Wick %** | 空头突破K线的上影线最小比例与下影线最大比例。 |
| **Volume** | 下单手数（以手/批为单位）。 |
| **Stop-Loss (pips)** | 入场价与止损价之间的点数距离，0表示不启用。 |
| **Take-Profit (pips)** | 入场价与止盈价之间的点数距离，0表示不启用。 |
| **Enable Long / Enable Short** | 分别启用或禁用多头、空头交易方向。 |

## 使用建议

- 将K线周期设置为与原版EA相同的级别（例如M5或H1）。默认使用5分钟周期。
- 程序仅保存安静区间计算所需的少量历史数据，避免无谓的内存占用。
- 入场价近似为突破K线的收盘价，对应原始EA在下一根K线开盘时以市价成交的行为。
- 每根完成的K线都会检测止损与止盈是否触发，若同时触发则优先执行止损，以便在模拟环境中保持保守处理。
- 只开启单一方向可复刻原始的“buy”或“sell”专家；同时开启双向则实现对称的突破交易。

## 转换细节

- 两个MQ5文件均为UTF-16编码，并使用FXD模块化框架生成。转换过程中将各个模块对应为清晰的C#实现逻辑。
- EMA比较与K线模板均遵循原策略的`Shift = 1`设定，即只在完全收盘的K线上进行判断。
- 原脚本中的虚拟止损和图表文字仅用于显示效果，对交易逻辑无影响，故在C#版本中省略。

## 测试方法

可通过`AlgoTrading.sln`解决方案编译，并在StockSharp策略测试器中运行本策略。若交易品种缺少价格步长信息，需手动设定；策略内部默认使用`0.0001`作为外汇常见的点值。
