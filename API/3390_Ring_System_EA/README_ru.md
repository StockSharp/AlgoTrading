# Стратегия Ring System EA

Стратегия переносит мультивалютного советника "RingSystemEA" с MetaTrader 4 на высокоуровневый API StockSharp. Она формирует треугольные кольца из заданного списка валют (каждая тройка валют образует три коррелированных инструмента) и управляет двумя хеджированными корзинами для каждого кольца: **плюсовой** (покупка/продажа/покупка) и **минусовой** (продажа/покупка/продажа). Алгоритм постоянно отслеживает плавающий PnL по каждому кольцу, добавляет дополнительные уровни ордеров при достижении заданных убытков и синхронно закрывает корзины при достижении целевой прибыли или допустимого убытка.

## Логика торговли

* Формируются все уникальные комбинации из трёх валют из строки `CurrenciesTrade` (например, EUR/GBP/AUD превращается в пары EURGBP, EURAUD и GBPAUD).
* Для каждой тройки поддерживаются две синхронные корзины:
  * **Плюсовая** открывает BUY по первой паре, SELL по второй и BUY по третьей.
  * **Минусовая** зеркально открывает SELL/BUY/SELL.
* Корзины запускаются автоматически, когда получены цены по всем инструментам и сессия допускает торговлю. Набор сторон определяется параметром `SideOpenOrders`.
* Если плавающий результат активной корзины ухудшается ниже порога `StepOpenNextOrders` (порог может увеличиваться по геометрической или экспоненциальной схеме), запускается дополнительный уровень сделок с объёмом, рассчитанным через `LotOrdersProgress`.
* Закрытие корзин происходит согласно выбранному режиму `TypeCloseInProfit`: по отдельной стороне, всей корзиной или по каждой паре отдельно.
* Защитные сценарии (`TypeCloseInLoss`) повторяют логику MT4: можно закрывать корзину полностью, частично сокращать объём или пропускать принудительное закрытие.
* При необходимости включается фильтр торговой недели: ожидание после открытия рынка в понедельник и остановка перед закрытием в пятницу.
* Денежный менеджмент соответствует оригиналу: автообъём рассчитывается от текущей стоимости портфеля и множителя риска, опция "fair lot" компенсирует различия тиковой стоимости между парами.

## Основные параметры

| Параметр | Назначение |
| --- | --- |
| `CurrenciesTrade` | Порядок валют, по которому строятся кольца. |
| `NoOfGroupToSkip` | Номера групп, которые следует исключить из торговли. |
| `SideOpenOrders` | Включение плюсовой, минусовой или обеих корзин. |
| `OpenOrdersInLoss` + `StepOpenNextOrders` | Логика доливки при отрицательном результате. |
| `StepOrdersProgress` | Как растёт порог убытка для новых уровней. |
| `LotOrdersProgress` | Схема увеличения объёма заявок. |
| `TypeCloseInProfit` / `TargetCloseProfit` | Механизм фиксации прибыли. |
| `TypeCloseInLoss` / `TargetCloseLoss` | Поведение при убытке. |
| `AutoLotSize`, `RiskFactor`, `ManualLotSize`, `UseFairLotSize` | Настройки объёма. |
| `ControlSession`, `WaitAfterOpen`, `StopBeforeClose` | Ограничения по времени торговли. |
| `MaxSpread`, `MaximumOrders`, `MaxSlippage` | Дополнительные фильтры риска. |

## Особенности порта

* Логика корзин и управления PnL идентична оригинальному советнику, но состояние хранится в объектных структурах StockSharp, а не в статических массивах.
* Индикаторы не используются — решения принимаются только на основании цен свечей и текущего PnL портфеля.
* Все ордера помечаются строкой `StringOrdersEA` для упрощения внешнего учёта.
* Визуализация и файловые отчёты MT4 не перенесены. При включённой опции `SaveInformations` информация пишется в лог стратегий.
* Режим `Open_With_Auto_Step` использует значение ручного шага, потому что специфические расчёты маржи MT4 недоступны в среде StockSharp.

## Рекомендации по использованию

1. Подключите и сопоставьте все валютные пары, которые формируются из `CurrenciesTrade`, с учётом префиксов и суффиксов брокера.
2. Настройте `SideOpenOrders`, чтобы определить, будет ли стратегия вести обе корзины или только одну сторону.
3. Аккуратно подберите `StepOpenNextOrders`, `StepOrdersProgress` и `LotOrdersProgress`: именно они задают темп наращивания объёмов и уровень риска.
4. Включите `SaveInformations`, чтобы наблюдать в логах процесс добавления уровней и закрытия корзин.

Порт сохраняет ключевую идею «кольцевого» хеджированного грид-алгоритма, адаптируя её к событийной модели StockSharp и расширенной системе параметров.
