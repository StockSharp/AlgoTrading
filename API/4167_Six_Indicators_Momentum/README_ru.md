# Стратегия Six Indicators Momentum

Стратегия переносит советник MetaTrader 4 **6xIndics_M** на высокоуровневый API StockSharp. Она объединяет шесть источников импульса, полученных из индикаторов Билла Вильямса Accelerator Oscillator (AC) и Awesome Oscillator (AO), пропускает их через настраиваемую матрицу условий и фильтрует результат медленным стохастиком. В любой момент времени открыта только одна позиция; реализованы мартингейл, фиксированные стоп/тейк и опциональный трейлинг-стоп — полностью как в оригинальном советнике.

## Алгоритм работы

1. **Подписка на данные** — используется серия свечей `CandleType` (по умолчанию часовые свечи).
2. **Индикаторы**:
   - Awesome Oscillator вычисляет разницу между 5- и 34-периодной SMA от медианной цены.
   - Скользящая SMA с периодом 5 от AO формирует значения Accelerator Oscillator.
   - Стохастик с параметрами 5/5/5 предоставляет линию %K, взятую с предыдущей закрытой свечи (сдвиг 1 в MT4).
3. **Шесть слотів индикаторов** — на каждой завершённой свече обновляются буферы:
   - Слот 0: `AC[1]` — значение AC со сдвигом 1.
   - Слот 1: `AC[10]` — значение AC со сдвигом 10.
   - Слот 2: `AC[20]` — значение AC со сдвигом 20.
   - Слот 3: импульс AO `AO[0] - AO[shift]`, где `shift` задаётся параметром `AoMomentumShift`.
   - Слот 4: импульс AC `AC[0] - AC[shift #1]` (`AcPrimaryShift`).
   - Слот 5: импульс AC `AC[0] - AC[shift #2]` (`AcSecondaryShift`).
4. **Матрица условий** — параметры `FirstSourceIndex` … `SixthSourceIndex` выбирают, какой слот задействовать в каждом из шести проверок (аналог переменных `k/u/t/e/r/o` в MT4). Те же значения используются при досрочном закрытии позиции через `CloseOnReverseSignal`.
5. **Правила входа**:
   - **Покупка**: `A > 0`, `B > 0.0001 × Sensitivity`, `C > 0.0002 × Sensitivity`, `D < 0`, `E < 0.0001 × Sensitivity`, `F < 0.0002 × Sensitivity`, стохастик %K (предыдущая свеча) < 15.
   - **Продажа**: `A < 0`, `B < 0.0001 × Sensitivity`, `C < 0.0002 × Sensitivity`, `D > 0`, `E > 0.0001 × Sensitivity`, `F > 0.0002 × Sensitivity`, стохастик %K > 85.
6. **Сопровождение позиции**:
   - Одновременно допускается только одна позиция — при открытой сделке новые входы игнорируются.
   - Стоп-лосс и тейк-профит вводятся в «пунктах» MT4 и переводятся в цену с учётом шага котировки (`Point`).
   - Трейлинг-стоп активируется после прохождения `TrailingStopPips` (и, при включённом `RequireProfitForTrailing`, дополнительного `LockProfitPips`) и сдвигает стоп только в прибыльную сторону.
   - `CloseOnReverseSignal` закрывает прибыльную позицию при появлении встречного сигнала (Bid выше цены входа для лонга, Ask ниже цены входа для шорта).
7. **Мартингейл** — если предыдущая сделка закрылась с убытком или в ноль, объём следующей сделки умножается на `(TakeProfitPips + StopLossPips) / TakeProfitPips`. При прибыльном закрытии объём возвращается к базовому `Volume`.

## Параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `AllowBuy`, `AllowSell` | Разрешить сделки в длинную/короткую сторону. | `true` |
| `CloseOnReverseSignal` | Закрывать прибыльную позицию при встречном сигнале. | `false` |
| `FirstSourceIndex` … `SixthSourceIndex` | Номера слотов (0–5), участвующих в шести проверках. Значения вне диапазона усекаются. | `1,2,3,4,3,4` |
| `AoMomentumShift` | Сдвиг AO для расчёта слота 3. | `10` |
| `AcPrimaryShift`, `AcSecondaryShift` | Сдвиги AC для расчёта слотов 4 и 5. | `10` / `10` |
| `SensitivityMultiplier` | Множитель для порогов 0.0001 и 0.0002. | `1.0` |
| `TakeProfitPips`, `StopLossPips` | Расстояние до тейка/стопа в пунктах MT4. | `300` / `300` |
| `UseTrailingStop` | Включить трейлинг-стоп. | `false` |
| `TrailingStopPips` | Расстояние трейлинг-стопа (в пунктах). | `300` |
| `RequireProfitForTrailing` | Требовать дополнительную прибыль `LockProfitPips` перед запуском трейлинга. | `false` |
| `LockProfitPips` | Дополнительная прибыль в пунктах перед запуском трейлинга. | `300` |
| `Volume` | Базовый объём сделки. | `0.1` |
| `UseMartingale` | Включить мартингейл после убытков. | `false` |
| `CandleType` | Тип свечей, используемых в расчётах. | `TimeSpan.FromHours(1)` |

## Рекомендации

- Обработка выполняется только по закрытию свечи, как и в MT4-версии с проверкой `prevtime`.
- Хранится лишь необходимая история (до 256 баров), что позволяет воспроизводить обращения со сдвигом без вызова `GetValue()`.
- Триггеры стопа и трейлинга моделируются по максимуму/минимуму свечи; в реальной торговле используйте реальные стоп-заявки.
- Расчёт объёма учитывает `VolumeStep`, `MinVolume` и `MaxVolume`, чтобы удовлетворить биржевым ограничениям.
- Отключение `AllowBuy` или `AllowSell` блокирует новые входы, но встречный сигнал всё равно можно использовать для раннего закрытия (`CloseOnReverseSignal`).

## Отличия от оригинального советника MT4

- Используются готовые индикаторы StockSharp (AO и SMA), исключая ручную работу с буферами.
- Входы выполняются через `BuyMarket`/`SellMarket`, выходы через `ClosePosition()`, тогда как MT4-версия вызывала `OrderSend`/`OrderClose`.
- Объём приводится к шагу и ограничивается `MinVolume`/`MaxVolume` инструмента.
- Добавлены визуальные помощники (`DrawCandles`, `DrawIndicator`, `DrawOwnTrades`) для проверки стратегии на графике.
