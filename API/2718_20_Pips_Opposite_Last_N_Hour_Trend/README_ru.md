# Стратегия 20 Pips Opposite Last N Hour Trend
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет логику советника MetaTrader **"20 Pips Opposite Last N Hour
Trend"**, используя высокоуровневый API StockSharp. На каждом часовом баре
сохраняется история закрытий. Когда завершается свеча выбранного часа, цена
сравнивается с закрытием `N` часов назад и позиция открывается в противоположную
сторону. Сделка сопровождается фиксированным тейк-профитом в 20 пунктов и
принудительным закрытием через час, а объём повышается по ступеням после
последовательных убыточных сделок.

## Логика входа

- Подписка выполняется на заданный тип свечей (по умолчанию H1).
- В завершённой свече хранится close в списке для дальнейших расчётов.
- Когда завершается свеча с `OpenTime.Hour == TradingHour` и накоплено достаточно
  истории:
  - Берётся close `HoursToCheckTrend` баров назад и закрытие предыдущей свечи.
  - Если цена снизилась (медвежий дрейф) — открывается покупка, если выросла —
    продажа. Равные значения пропускают сигнал.
- За сутки открывается максимум одна позиция и только в заданный час.

## Управление позицией

- Сразу после входа рассчитывается цель в 20 пунктов (корректируется для
  инструментов с 3/5 знаками). Если high/low любой завершённой свечи достигает
  цели, позиция закрывается по тейку.
- Если цель не достигнута, позиция закрывается по рыночной цене после завершения
  следующего часа, чтобы избежать ночного переноса.
- Счётчики сбрасываются при наступлении нового дня, что позволяет получить сигнал
  на следующей сессии.

## Мани-менеджмент

- Параметр `Volume` задаёт базовый объём, `MaxVolume` ограничивает верхнюю
  границу после применения множителей.
- После убытка следующий объём умножается на соответствующий множитель:
  первая убыточная сделка → `FirstMultiplier`, вторая → `SecondMultiplier` и т.д.
  После пятой подряд сделки применяется пятый множитель. Любая прибыльная или
  безубыточная сделка сбрасывает последовательность.
- Оценка результата выполняется по цене входа и закрытия, что позволяет работать
  без внешних данных о PnL.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `MaxPositions` | 9 | Максимум сделок в сутки. При значении 0 торговля отключается. |
| `Volume` | 0.1 | Базовый объём первой сделки в серии. |
| `MaxVolume` | 5 | Жёсткий предел объёма после применения множителей. |
| `TakeProfitPips` | 20 | Дистанция тейк-профита в пунктах. 0 отключает цель. |
| `TradingHour` | 7 | Час (0-23), в который допускается открытие позиции. |
| `HoursToCheckTrend` | 24 | Количество часовых закрытий, используемых для оценки тренда. |
| `FirstMultiplier` | 2 | Множитель после первой убыточной сделки подряд. |
| `SecondMultiplier` | 4 | Множитель после второй убыточной сделки подряд. |
| `ThirdMultiplier` | 8 | Множитель после третьей убыточной сделки подряд. |
| `FourthMultiplier` | 16 | Множитель после четвёртой убыточной сделки подряд. |
| `FifthMultiplier` | 32 | Множитель после пятой и последующих убыточных сделок. |
| `CandleType` | H1 | Тип свечей, используемых для сигналов и сопровождения. |

## Дополнительные замечания

- Размер пункта вычисляется из `Security.PriceStep` и точности котировки, поэтому
  тейк-профит корректно работает на инструментах с четырьмя и пятью знаками.
- При старте вызывается `StartProtection()`, включая встроенные механизмы защиты
  StockSharp.
- Вся логика опирается только на завершённые свечи, что соответствует требованиям
  из `AGENTS.md`.

> **Внимание:** ступенчатое увеличение объёма (мартингейл) может приводить к
> значительным просадкам. Перед реальной торговлей протестируйте параметры и
> убедитесь, что соблюдены риск-лимиты.
