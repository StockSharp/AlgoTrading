# 20 Pips Opposite Last N Hour Trend 策略
[English](README.md) | [Русский](README_ru.md)

该策略是 MetaTrader 顾问 **“20 Pips Opposite Last N Hour Trend”** 的 StockSharp
高阶移植版本。系统在每根小时 K 线收盘后记录价格，并在设定交易小时结束
时比较 `N` 小时前的收盘价与上一根 K 线，随后在相反方向开仓。仓位带有
固定 20 点（pip）的止盈和一小时超时退出，同时使用分级放大的马丁格尔式
资金管理来应对连续亏损。

## 交易逻辑

- 订阅指定的蜡烛类型（默认 1 小时）。
- 每根已结束的蜡烛都会把收盘价写入内部历史列表。
- 当 `OpenTime.Hour == TradingHour` 的蜡烛收盘且历史数据充足时：
  - 取 `HoursToCheckTrend` 根之前的收盘价与上一根收盘价比较。
  - 若价格在此区间下跌，则在当前收盘后买入；若上涨，则卖出；若持平则
    不交易。
- 每个交易日只在指定小时开仓一次，其余蜡烛仅用于仓位管理。

## 仓位管理

- 开仓后立即计算 20 点的止盈（会根据 3/5 位报价自动调整）。若任一已完
  成蜡烛的最高价/最低价触及目标，则按该价格平仓。
- 若目标未命中，则在下一根蜡烛收盘时按市价退出，避免隔夜暴露。
- 新交易日开始时自动重置计数，允许下一次信号触发。

## 资金管理

- `Volume` 为基础下单量，`MaxVolume` 限制放大后的最大手数。
- 连续亏损时按阶梯放大手数：第一次亏损→`FirstMultiplier`，第二次→
  `SecondMultiplier`，依此类推，超过五次依旧使用第五级倍数。一旦盈利或
  打平即重置倍数序列。
- 盈亏判定基于记录的开仓价与退出价，无需依赖外部 PnL 数据。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MaxPositions` | 9 | 每日最多交易次数，设为 0 将关闭策略。 |
| `Volume` | 0.1 | 序列第一笔交易的基础手数。 |
| `MaxVolume` | 5 | 应用倍数后的手数上限。 |
| `TakeProfitPips` | 20 | 止盈距离（点数），0 表示不设止盈。 |
| `TradingHour` | 7 | 允许开仓的小时（0-23）。 |
| `HoursToCheckTrend` | 24 | 用于衡量趋势的历史小时数。 |
| `FirstMultiplier` | 2 | 第一次连续亏损后的倍数。 |
| `SecondMultiplier` | 4 | 第二次连续亏损后的倍数。 |
| `ThirdMultiplier` | 8 | 第三次连续亏损后的倍数。 |
| `FourthMultiplier` | 16 | 第四次连续亏损后的倍数。 |
| `FifthMultiplier` | 32 | 第五次及之后连续亏损的倍数。 |
| `CandleType` | H1 | 用于信号与仓位管理的蜡烛类型。 |

## 其他说明

- 通过 `Security.PriceStep` 与小数位数估算每个点值，从而适配 4 位与 5 位
  报价的外汇品种。
- 启动时调用 `StartProtection()`，以启用 StockSharp 的保护机制。
- 策略仅使用已完成的蜡烛，完全符合仓库 `AGENTS.md` 中的约束。

> **风险提示：** 马丁格尔加仓可能导致极大的回撤。请务必在历史数据上
> 充分测试，并设置合理的风险控制后再用于实盘。
