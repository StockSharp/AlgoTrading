# Стратегия ProMart MACD Martingale
[English](README.md) | [中文](README_cn.md)

Эта стратегия — перенос на StockSharp исторического советника MQL **MartGreg_1 / ProMart**. Она объединяет две конфигурации MACD с управляемой моделью мартингейла. Основной MACD ищет локальные минимумы и максимумы импульса, а вспомогательный MACD подтверждает направление последнего наклона. После каждой закрытой сделки стратегия либо снова следует сигналу индикаторов (если предыдущая сделка была прибыльной), либо сразу переворачивает позицию (после убытка) с возможным удвоением объёма следующего ордера.

## Логика торговли

- **Сигналы**
  - На выбранной серии свечей строятся два индикатора MACD:
    - `MACD1` (быстрая = 5, медленная = 20, сигнал = 3) выступает детектором паттернов.
    - `MACD2` (быстрая = 10, медленная = 15, сигнал = 3) подтверждает краткосрочный наклон.
  - Сигналы оцениваются только на завершённых свечах, используя предыдущие три значения MACD1 и два значения MACD2 (что повторяет работу исходного эксперта, который смотрел на один бар назад).
  - **Лонг**: MACD1 образует локальную «впадину» (`MACD1[t-1] > MACD1[t-2] < MACD1[t-3]`), а MACD2 растёт (`MACD2[t-2] > MACD2[t-1]`).
  - **Шорт**: MACD1 формирует локальную «вершину», а MACD2 снижается.
  - Если последняя закрытая сделка прибыльная, стратегия ждёт следующего валидного паттерна. После убыточной сделки позиция открывается немедленно в противоположную сторону вне зависимости от текущей формы MACD, что копирует мартингейл-логику исходника.
- **Управление позицией**
  - Сделки открываются рыночными ордерами и контролируются на закрытии каждой свечи.
  - Уровни стоп-лосса и тейк-профита рассчитываются в пунктах от цены входа. Если максимум или минимум свечи достигает уровня, позиция закрывается по рынку, а результат фиксируется.
  - Новая сделка не открывается на той же свече, что закрыла позицию: стратегия ждёт следующий бар, как и в MQL-версии, срабатывавшей на первом тике нового бара.
- **Мартингейл и объём**
  - Базовый объём определяется как отношение стоимости портфеля к параметру `BalanceDivider` с приведением к шагу объёма инструмента (с запасным вариантом — свойство `Volume` стратегии или минимальный объём инструмента).
  - После убыточной сделки следующий объём может удвоиться относительно предыдущего, максимум `MaxDoublingCount` раз подряд. Прибыль сбрасывает счётчик удвоений.
  - Объём всегда ограничивается максимальным объёмом инструмента, чтобы избежать переоценки позиции.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `BalanceDivider` | Делитель стоимости портфеля для вычисления базового объёма ордера. | `1000` |
| `MaxDoublingCount` | Максимальное число последовательных удвоений объёма после убытков. | `1` |
| `StopLossPoints` | Размер стоп-лосса в пунктах (`PriceStep * StopLossPoints`). | `500` |
| `TakeProfitPoints` | Размер тейк-профита в пунктах. | `1500` |
| `Macd1Fast` / `Macd1Slow` / `Macd1Signal` | Периоды основного MACD, который ищет впадины и вершины. | `5 / 20 / 3` |
| `Macd2Fast` / `Macd2Slow` / `Macd2Signal` | Периоды вспомогательного MACD для фильтра наклона. | `10 / 15 / 3` |
| `CandleType` | Тип свечей для расчётов (по умолчанию — минутные). | `TimeSpan.FromMinutes(1).TimeFrame()` |

## Примечания

- Реализация аппроксимирует исполнение стоп-ордеров по максимумам и минимумам свечи, потому что пример StockSharp работает на закрытых свечах.
- Если данные по портфелю недоступны, объём сделки берётся из свойства `Volume` стратегии или минимального объёма инструмента.
- Версия на Python пока отсутствует, доступна только C#-реализация.
- Перед запуском на реальных деньгах обязательно протестируйте стратегию на истории. Мартингейл резко увеличивает риск.
