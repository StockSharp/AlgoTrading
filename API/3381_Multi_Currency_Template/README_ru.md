# Стратегия Multi Currency Template

## Обзор
**Multi Currency Template Strategy** — порт MetaTrader 4 советника *Multi Currency Template v4* на высокоуровневый API StockSharp. Стратегия сохраняет логику пересечения EMA для входов, поддерживает мартингейл-доливки, стопы и тейк-профиты в пунктах, а также управление плавающим трейлинг-стопом. По умолчанию используется таймфрейм 5 минут, но его можно настроить параметром.

## Логика торговли
- На каждой завершённой свече выбранного таймфрейма рассчитываются две экспоненциальные скользящие средние (EMA 20 и EMA 50).
- Сигнал на покупку возникает, когда EMA 20 закрывается выше EMA 50. Сигнал на продажу появляется при обратном пересечении.
- Параметр `Order Method` ограничивает торговлю обеими сторонами, только покупками или только продажами.
- Стратегия работает с чистой позицией. При появлении сигнала противоположного направления текущая позиция закрывается и затем открывается новая.

## Управление позицией
- **Стоп-лосс / Тейк-профит** — вводятся в метатрейдеровских пунктах. Значения автоматически пересчитываются в цену через минимальный шаг цены инструмента, что корректно работает для 4- и 5-знаковых валютных котировок.
- **Трейлинг-стоп** — активируется после движения в прибыль на `Trailing Stop (pts)` и подтягивается при каждом дополнительном улучшении на `Trailing Step (pts)`.
- **Мартингейл-доливки** — при включении стратегия добавляет рыночные ордера каждые `Step (pts)` против позиции. Объём каждого нового ордера умножается на `Lot Multiplier`, пока позиция не будет закрыта.
- **Усреднённый тейк-профит** — при наличии двух и более доливок целевой уровень может рассчитываться от средневзвешенной цены позиции плюс `Average TP Offset (pts)`, копируя поведение TP Average в исходном советнике.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| Order Method | Направление торговли (оба направления / только лонг / только шорт). | Buy & Sell |
| Volume (lots) | Базовый объём первой сделки в лотах. | 0.01 |
| Stop Loss (pips) | Размер стоп-лосса в пунктах MetaTrader. | 50 |
| Take Profit (pips) | Размер тейк-профита в пунктах MetaTrader. | 100 |
| Trailing Stop (pts) | Прибыль в пунктах для активации трейлинг-стопа. | 15 |
| Trailing Step (pts) | Минимальный шаг подтягивания трейлинга. | 5 |
| Enable Martingale | Включает доливки по мартингейлу. | true |
| Lot Multiplier | Множитель объёма следующей доливки. | 1.2 |
| Step (pts) | Расстояние между доливками в пунктах MetaTrader. | 150 |
| Average Take Profit | Использовать ли усреднённый тейк-профит при нескольких ордерах. | true |
| Average TP Offset (pts) | Смещение усреднённого тейк-профита относительно средней цены. | 20 |
| Candle Type | Тип свечей (таймфрейм) для расчётов индикаторов. | 5-минутные свечи |

## Отличия от оригинального советника
- StockSharp оперирует чистой позицией, а не отдельными тикетами. Мартингейл увеличивает общий объём позиции и не управляет индивидуальными стопами/тейками.
- Встроенного мультивалютного цикла нет: для торговли несколькими инструментами нужно запускать несколько экземпляров стратегии.
- Проверки доступности средств и брокерские ограничения (`CheckMoneyForTrade`, `CheckVolumeValue`) заменены встроенными механизмами проверки заявок в StockSharp.

## Рекомендации по использованию
1. Убедитесь, что у инструмента корректно настроены `PriceStep` и количество знаков, чтобы пересчёт пунктов в цену был точным.
2. Встроенное управление позицией работает на закрытии свечей. Для более частого контроля можно дополнительно обрабатывать поток заявок или сделок.
3. Стратегия использует рыночные ордера, поэтому контроль проскальзывания зависит от брокера или режима тестирования.
