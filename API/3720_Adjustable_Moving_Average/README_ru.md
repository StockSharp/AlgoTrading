# Стратегия Adjustable Moving Average

Стратегия переносит на StockSharp эксперт-советник MetaTrader «Adjustable Moving Average». Используются две скользящие средней одного типа, но с разными периодами. Когда быстрая средняя пересекает медленную с зазором не меньше заданного, стратегия закрывает встречную позицию и при необходимости открывает новую по направлению тренда. Сессионные фильтры, защитные уровни и опциональный трейлинг-стоп повторяют гибкость исходного робота.

## Логика торговли

- Быстрая и медленная средние рассчитываются одним алгоритмом. Меньший период автоматически назначается быстрой линии, больший — медленной.
- Сигнал появляется только после формирования обеих средних и когда их расстояние превышает `MinGapPoints`, переведённый в цену через шаг инструмента.
- Если быстрая средняя выше медленной на нужный зазор, внутренняя переменная принимает значение «покупка»; обратная ситуация переключает её в «продажу».
- При смене состояния закрывается текущая позиция (если включён `CloseOutsideSession` или время попадает в торговую сессию). Новые сделки подчиняются режиму `Mode` (только покупки, только продажи или оба направления) и выбранной модели объёма.
- На каждой завершённой свече проверяются защитные условия:
  - Стоп-лосс и тейк-профит измеряются в пунктах инструмента и сравниваются с диапазоном свечи.
  - Трейлинг-стоп активируется после движения цены в прибыль минимум на `TrailStopPoints` пунктов. Обновление уровня выполняется только в торговой сессии или если разрешён `TrailOutsideSession`. После активации стоп остаётся действовать даже вне сессии.

## Размер позиции

- При `EnableAutoLot = false` используется объём `FixedLot`, подгоняемый под шаг и границы объёма инструмента.
- При `EnableAutoLot = true` объём приближённо вычисляется по формуле `(PortfolioValue / 10 000) * LotPer10kFreeMargin` и округляется до одной десятой лота, после чего также корректируется по ограничениям инструмента.

## Параметры

| Имя | Тип / Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | `TimeFrame` = 5 минут | Таймфрейм, на котором строятся скользящие средние. |
| `FastPeriod` | `int` = 3 | Период быстрой средней (должен отличаться от `SlowPeriod`). |
| `SlowPeriod` | `int` = 9 | Период медленной средней (должен отличаться от `FastPeriod`). |
| `MaMethod` | `MovingAverageMethod` = Exponential | Тип средней: Simple, Exponential, Smoothed, Weighted. |
| `MinGapPoints` | `decimal` = 3 | Минимальный зазор между средними в пунктах инструмента. Переводится через шаг цены. |
| `StopLossPoints` | `decimal` = 0 | Размер стоп-лосса в пунктах. 0 — отключен. |
| `TakeProfitPoints` | `decimal` = 0 | Размер тейк-профита в пунктах. 0 — отключен. |
| `TrailStopPoints` | `decimal` = 0 | Расстояние трейлинг-стопа в пунктах. 0 — отключен. |
| `Mode` | `EntryMode` = Both | Разрешённые направления (Both, BuyOnly, SellOnly). |
| `SessionStart` | `TimeSpan` = 00:00 | Время начала торговой сессии (по времени площадки). |
| `SessionEnd` | `TimeSpan` = 23:59 | Время окончания сессии. Если `SessionEnd < SessionStart`, поддерживаются ночные сессии. |
| `CloseOutsideSession` | `bool` = true | При true встречные позиции закрываются даже вне сессии. |
| `TrailOutsideSession` | `bool` = true | При true трейлинг продолжает подтягиваться после завершения сессии. |
| `FixedLot` | `decimal` = 0.1 | Объём сделки при отключённом автолоте. |
| `EnableAutoLot` | `bool` = false | Включает расчёт объёма по стоимости портфеля. |
| `LotPer10kFreeMargin` | `decimal` = 1 | Количество лотов на каждые 10 000 единиц капитала при автолоте. |
| `MaxSlippage` | `int` = 3 | Параметр сохранён для совместимости; в StockSharp нельзя задать проскальзывание для рыночных ордеров. |
| `TradeComment` | `string` = "AdjustableMovingAverageEA" | Текст, выводимый в лог при совершении сделок. |

## Особенности

- В MetaTrader стопы и трейлинг выставлялись как модификации ордеров. В StockSharp поведение повторено через проверку диапазонов свечей и обратные рыночные сделки.
- Показатель `AccountFreeMargin()` недоступен, поэтому используется стоимость портфеля (`Portfolio.CurrentValue` с запасным вариантом `BeginValue`).
- Если у инструмента не задан шаг цены (`PriceStep`), расчёты в пунктах (зазор, стопы, трейлинг) не выполняются.
