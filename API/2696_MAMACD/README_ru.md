# Стратегия MAMACD

## Общая информация
Стратегия представляет собой прямую конвертацию эксперта MetaTrader 5 **MAMACD (редакция barabashkakvn)** из каталога `MQL/19334` на высокоуровневый API StockSharp. Логика использует две линейно-взвешенные скользящие средние (LWMA) по минимумам свечей, быструю экспоненциальную среднюю (EMA) по закрытиям и фильтр по основной линии MACD. Обработка выполняется только на закрытых свечах, а флаги готовности повторяют механику оригинального советника: для нового входа быстрая EMA сначала должна выйти за пределы канала из двух LWMA.

## Индикаторы
- **LWMA #1 (минимумы, по умолчанию 85)** — медленный фильтр направления тренда.
- **LWMA #2 (минимумы, по умолчанию 75)** — немного быстрее, подтверждает канал.
- **EMA-триггер (закрытия, по умолчанию 5)** — короткая EMA, которая должна пересечь обе LWMA для активации сигнала.
- **Основная линия MACD (быстрая 15, медленная 26)** — фильтр импульса; для покупок требуется положительный или растущий MACD, для продаж — отрицательный или снижающийся.

## Правила входа
1. Стратегия игнорирует незавершённые свечи (`CandleStates.Finished`).
2. Когда EMA-триггер опускается ниже обеих LWMA, устанавливается флаг готовности к покупке. Сделка на покупку открывается после возвращения EMA выше обеих LWMA и подтверждения по MACD (значение > 0 либо выше предыдущего). Одновременно может существовать только одна длинная позиция.
3. Когда EMA-триггер поднимается выше обеих LWMA, устанавливается флаг готовности к продаже. Короткая позиция открывается после возврата EMA ниже LWMA при условии, что MACD < 0 или меньше предыдущего значения. Одновременно разрешена только одна короткая позиция.
4. Объём заявок берётся из свойства `Volume`. При смене направления алгоритм сначала закрывает противоположную позицию.

## Правила выхода
- Дополнительных правил выхода в оригинальном советнике нет. Защитные ордера реализованы через `StartProtection` со стоп-лоссом и тейк-профитом в пунктах. Достижение любого из уровней автоматически закрывает позицию.

## Параметры
| Имя | Описание |
| --- | --- |
| `FirstLowMaLength` | Период первой LWMA по минимумам (значение по умолчанию 85). |
| `SecondLowMaLength` | Период второй LWMA по минимумам (значение по умолчанию 75). |
| `TriggerEmaLength` | Период быстрой EMA по закрытиям (значение по умолчанию 5). |
| `MacdFastLength` | Период быстрой EMA в расчёте MACD (значение по умолчанию 15). |
| `MacdSlowLength` | Период медленной EMA в расчёте MACD (значение по умолчанию 26). |
| `StopLossPips` | Расстояние стоп-лосса в пунктах; 0 отключает защиту (значение по умолчанию 15). |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах; 0 отключает (значение по умолчанию 15). |
| `CandleType` | Тип свечей/таймфрейм для расчётов (по умолчанию 1 час). |

## Особенности реализации
- Размер пункта вычисляется из `Security.PriceStep`. Для инструментов с 3 и 5 знаками после запятой шаг умножается на 10, что соответствует логике MT5.
- История MACD соответствует эксперту: первое валидное значение сохраняется и используется как база для следующей свечи перед проверкой условий.
- Флаги `_readyForLong` и `_readyForShort` повторяют переменные `startb` и `starts`, требуя выхода EMA за границы LWMA перед каждым новым входом.
- На график выводятся свечи, обе LWMA, EMA-триггер и отдельная область с MACD для визуальной проверки.

## Соответствие элементов MT5
| Элемент MT5 | Эквивалент в StockSharp |
| --- | --- |
| `iMA` по минимумам/закрытиям | `WeightedMovingAverage` (для минимумов) и `ExponentialMovingAverage` (для закрытий) |
| `iMACD` (основная линия) | `MovingAverageConvergenceDivergence` |
| Подсчёт позиций `buy`/`sell` | Проверка знака `Position` и объёма при `BuyMarket` / `SellMarket` |
| Magic number, проскальзывание | Не требуются в высокоуровневом API |
| Стоп-лосс / тейк-профит в пунктах | `StartProtection` с абсолютными смещениями цены, рассчитанными из размера пункта |

Конвертация сохраняет торговую логику оригинала и использует инфраструктуру StockSharp для индикаторов, подписок и управления рисками.
