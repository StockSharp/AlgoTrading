# Стратегия FX-CHAOS Scalp MT4

## Обзор
Стратегия FX-CHAOS Scalp MT4 представляет собой прямой порт эксперта MetaTrader 4, который объединяет фильтр Awesome Oscillator и уровни ZigZag, построенные на фракталах. Версия под StockSharp полностью сохраняет многотаймфреймовую структуру оригинала: часовые свечи формируют торговые сигналы и управляют рисками, а дневные свечи дают направление старшего таймфрейма. Два встроенных трекера воссоздают индикатор «ZigZag на фракталах», анализируя пятерки свечей и записывая попеременно экстремумы.

## Алгоритм работы
1. **Получение данных**
   - Часовые свечи обеспечивают логику входов и контроль стопов.
   - Дневные свечи обновляют старший ZigZag, используемый как трендовый фильтр.
   - Awesome Oscillator (5, 34) рассчитывается по часовому ряду через высокоуровневый API.
2. **Восстановление ZigZag**
   - Каждая завершенная свеча помещается в скользящее окно из пяти элементов.
   - Если центральная свеча формирует верхний фрактал, фиксируется ее максимум и направление меняется на «вверх»; нижний фрактал делает то же самое с минимумом и направлением «вниз».
   - Последовательные экстремумы одного направления заменяются только более выраженными значениями, что повторяет логику MT4 по работе с буферами.
3. **Обнаружение сигналов**
   - Параметр буфера прорыва добавляет два шага цены к максимуму/минимуму предыдущего часа, воспроизводя выражение `2*Point` в исходном коде.
   - Для покупки свеча должна открыться ниже буферизованного максимума, закрыться выше него, оставаться ниже последнего часового ZigZag, закрыться выше последнего дневного ZigZag и иметь отрицательное значение Awesome Oscillator.
   - Сигнал на продажу зеркален: используется буферизованный минимум, верхний уровень ZigZag и положительный осциллятор.
4. **Исполнение и разрешение конфликтов**
   - Противоположные позиции закрываются до отправки новой заявки, поэтому стратегия всегда имеет только одно направленное положение.
   - Цена закрытия запоминается для расчета уровней стоп-лосса и тейк-профита на следующих свечах.

## Управление рисками
- Параметры стоп-лосса и тейк-профита являются опциональными; значение `0` отключает соответствующее правило.
- После завершения каждой свечи проверяется, достиг ли диапазон свечи заданных уровней. При касании позиция закрывается и внутренний флаг входа очищается.
- При появлении встречного сигнала позиция закрывается и только затем выполняется новый вход, что поддерживает правило «одна позиция».

## Параметры
| Название | Описание |
| --- | --- |
| `Volume` | Объем сделки в лотах для каждой рыночной заявки. |
| `Stop Loss (pts)` | Дистанция до защитного стопа в пунктах, умножается на шаг цены инструмента. `0` — отключить. |
| `Take Profit (pts)` | Дистанция до тейк-профита в пунктах, также масштабируется шагом цены. `0` — отключить. |
| `Breakout Buffer` | Дополнительные пункты к экстремуму предыдущей свечи, необходимые для подтверждения прорыва. Значение по умолчанию повторяет `2*Point` из MT4. |
| `Spread (pts)` | Средний спред в пунктах, добавляемый к условию прорыва при покупках, что соответствует формуле `2*Point + spread` в MT4. |
| `Trading Candle` | Основной таймфрейм для торговли (по умолчанию 1 час). |
| `Daily Candle` | Старший таймфрейм для фильтра ZigZag (по умолчанию 1 день). |

## Особенности реализации
- Стратегия использует высокоуровневые методы `SubscribeCandles` и `BindEx`, не обращаясь напрямую к буферам индикаторов, что соответствует внутренним требованиям репозитория.
- Для перевода значений в пунктах в реальные цены применяется `Security.PriceStep`; при отсутствии шага используется запасной коэффициент `1`.
- Оба ZigZag-трекера сбрасываются в `OnReseted` и не допускают торговлю, пока не накопят достаточно данных для определения первого экстремума.
- На график выводятся часовые свечи, осциллятор и сделки стратегии, что помогает сравнивать версию StockSharp с шаблоном MT4.
