# FX-CHAOS Scalp MT4 策略

## 概述
FX-CHAOS Scalp MT4 策略是 MetaTrader 4 专家顾问的直接移植版本，它结合了 Awesome Oscillator（神奇震荡指标）与基于分形的 ZigZag 水平。StockSharp 版本完整保留了原始系统的多周期结构：小时级别的蜡烛驱动交易信号与风控，日线蜡烛提供趋势过滤。两个内置跟踪器通过扫描五根蜡烛的组合重建“基于分形的 ZigZag”指标，依次记录新的摆动高点和低点。

## 交易流程
1. **数据订阅**
   - 小时蜡烛用于触发交易、检查止损与止盈。
   - 日线蜡烛更新更高周期的 ZigZag 摆动，用于判定多空方向。
   - Awesome Oscillator（5，34）基于小时数据通过高阶 API 计算。
2. **ZigZag 重建**
   - 每根完成的蜡烛被推入一个大小为 5 的滑动窗口。
   - 当窗口中心形成向上分形时，记录该蜡烛的最高价作为新摆动高点并将方向切换为“向上”；向下分形则记录最低价并切换为“向下”。
   - 连续同方向的摆动只有在出现更极端的价格时才会被替换，从而模拟 MT4 指标缓冲区的行为。
3. **信号识别**
   - 突破缓冲参数会在上一根小时蜡烛的高/低点基础上增加两个价格步长，复现原始代码中的 `2*Point` 补偿。
   - 做多信号要求当前蜡烛开盘价低于缓冲后的高点，收盘价突破该价位，位于最近的小时 ZigZag 摆动之下，收盘价高于最新日线摆动，同时 Awesome Oscillator 为负值。
   - 做空信号对称成立，使用缓冲后的低点、上方 ZigZag 水平及正值震荡指标。
4. **下单与冲突处理**
   - 新信号出现前会先平掉相反方向的持仓，确保始终只有单向仓位。
   - 成交价会被保存，用于后续蜡烛推导止损与止盈价位。

## 风险管理
- 止损与止盈参数可选，设置为 `0` 即关闭对应功能。
- 每根完成的蜡烛都会检查价格区间是否触及止损或止盈，一旦到达立即平仓并清除入场标记。
- 当出现相反方向的突破时，先平仓再在同一根蜡烛上重新进场，以保持单向交易原则。

## 参数说明
| 名称 | 描述 |
| --- | --- |
| `Volume` | 每次市价单的交易手数。 |
| `Stop Loss (pts)` | 以点（Point）表示的止损距离，会乘以标的的最小价格步长。设置为 `0` 时关闭。 |
| `Take Profit (pts)` | 以点表示的止盈距离，同样乘以价格步长。设置为 `0` 时关闭。 |
| `Breakout Buffer` | 在上一根蜡烛高/低点之外增加的点数，用于识别突破；默认值复现 MT4 中的 `2*Point` 缓冲。 |
| `Spread (pts)` | 买入信号时附加在突破阈值上的平均点差，等价于 MT4 中的 `2*Point + spread` 逻辑。 |
| `Trading Candle` | 触发交易的主时间框架（默认 1 小时）。 |
| `Daily Candle` | 用作 ZigZag 过滤的高时间框架（默认 1 天）。 |

## 实现细节
- 策略完全依赖 `SubscribeCandles` 与 `BindEx` 等高级 API，不直接访问指标缓冲区，符合仓库约定。
- 使用 `Security.PriceStep` 将以点表示的参数转换为实际价格距离；当标的缺失该信息时回退到 1。
- 两个 ZigZag 跟踪器会在 `OnReseted` 中复位，并在累积足够蜡烛之前暂停交易，避免历史数据不足时产生错误信号。
- 图表输出包含小时蜡烛、Awesome Oscillator 以及策略成交，便于与 MT4 模板对照验证。
