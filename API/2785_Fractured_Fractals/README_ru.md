# Стратегия Fractured Fractals
[English](README.md) | [中文](README_cn.md)

Порт классического советника MetaTrader «Fractured Fractals». Стратегия отслеживает подтверждённые фракталы Вильямса, размещает стоп-заявки на свежих уровнях пробоя и сопровождает позицию стоп-заявкой на противоположном фрактале.

## Детали

- **Источник**: конвертация `MQL/20127/Fractured Fractals.mq5`.
- **Режим рынка**: пробой продолжения на любом инструменте, поддерживаемом StockSharp.
- **Типы заявок**: стоп-заявки для входов и защитные стоп-заявки для выходов.
- **Размер позиции**: расчёт по риску с параметрами `MaximumRiskPercent` и адаптивным коэффициентом серии `DecreaseFactor`.
- **Значения по умолчанию**:
  - `MaximumRiskPercent` = 2%
  - `DecreaseFactor` = 10
  - `ExpirationHours` = 1 час
  - `CandleType` = часовые свечи
- **Ключевые индикаторы**: встроенные пятисвечные фракталы Вильямса.
- **Тип стратегии**: пробойная торговля в обе стороны с динамическим стопом.

## Логика стратегии

### Отслеживание последовательности фракталов

- Поддерживаются очереди из пяти последних максимумов и минимумов свечей, что воспроизводит буфер `iFractals` в MT5.
- Каждый подтверждённый фрактал сдвигает тройку значений: «самый новый», «средний» и «старый». Дубликаты игнорируются с учётом шага цены инструмента.
- Для покупки требуется, чтобы новый верхний фрактал был выше среднего; для продажи — новый нижний фрактал ниже предыдущего.

### Заявки на вход и срок действия

- При отсутствии длинной позиции и активной заявки ставится buy-stop на последнем верхнем фрактале и защитный стоп на последнем нижнем фрактале.
- Для короткой позиции зеркально размещается sell-stop на последнем нижнем фрактале и защитный стоп на верхнем фрактале.
- Невыполненные заявки получают срок действия `ExpirationHours`. Если время свечи превышает срок или иерархия фракталов нарушается (новый более низкий верхний фрактал для лонга, новый более высокий нижний для шорта), заявка отменяется.
- После открытия позиции противоположные заявки сразу снимаются, чтобы не оставлять лишних ордеров в стакане.

### Защитные трейлинг-стопы

- Каждый подтверждённый противоположный фрактал обновляет защитную стоп-заявку: лонги подтягиваются к новому нижнему фракталу, шорты — к новому верхнему.
- Стопы только ужесточаются: новое значение должно улучшать цену текущей заявки, прежде чем она будет заменена.
- После закрытия позиции все оставшиеся защитные заявки немедленно отменяются.

### Управление риском и контроль серии

- Метод `CalculateOrderVolume` повторяет расчёт из MT5: риск на единицу = входная цена минус цена стопа (или наоборот для шорта).
- Целевой денежный риск равен `Portfolio.CurrentValue * MaximumRiskPercent / 100` с резервом в виде свойства `Volume`, если стоимость портфеля недоступна.
- Итоговый объём нормализуется по размеру лота, шагу объёма, минимальному и максимальному объёму из объекта `Security`.
- После убыточной сделки счётчик серии увеличивается; прибыльные и нулевые сделки сбрасывают его. При двух и более подряд убытках объём сокращается на долю `losses / DecreaseFactor`.

### Фиксация результатов сделок

- Переопределение `OnOwnTradeReceived` агрегирует исполнения, чтобы определить завершение цикла позиции и его итог — прибыль, убыток или ноль.
- Счётчик серии и отметка времени последней прибыльной сделки сохраняют логику оригинального советника, позволяя расширять аналитику при необходимости.

## Рекомендации по использованию

1. Привяжите стратегию к нужному инструменту и портфелю, выставьте `CandleType` и параметры риска под размер счёта.
2. Убедитесь, что брокер/адаптер поддерживает стоп-заявки; иначе замените защитные ордера на ручные выходы в методе `UpdateTrailingStops`.
3. Поскольку обработка идёт только по закрытым свечам, внутрисвечные всплески меньше выбранного таймфрейма не будут обрабатываться так же, как в тиковом тестере MT5.
4. Для анализа полезно включить журналы сообщений — они повторяют информативные выводы оригинальной MQL-версии.
