# Fractured Fractals 策略
[English](README.md) | [Русский](README_ru.md)

该策略移植自 MetaTrader 上的 “Fractured Fractals” 专家顾问。算法跟踪确认的威廉姆斯分形，在最新突破价位放置止损入场单，并使用相反方向的分形自动跟踪保护性止损单。

## 详情

- **来源**：由 `MQL/20127/Fractured Fractals.mq5` 转换而来。
- **市场环境**：适用于任意支持 StockSharp 的品种的突破延续行情。
- **委托类型**：入场使用止损委托，离场使用保护性止损委托。
- **仓位规模**：基于风险计算，由 `MaximumRiskPercent` 和连续亏损衰减系数 `DecreaseFactor` 控制。
- **默认参数**：
  - `MaximumRiskPercent` = 2%
  - `DecreaseFactor` = 10
  - `ExpirationHours` = 1 小时
  - `CandleType` = 1 小时时间框架
- **核心指标**：即时计算的五根 K 线威廉姆斯分形。
- **策略类型**：多空双向突破并带动态止损。

## 策略逻辑

### 分形序列跟踪

- 维护最近五根 K 线的高点和低点队列，复现 MT5 中的 `iFractals` 缓冲区。
- 每当出现新分形，会将“最新 / 中间 / 最旧”三个槽位前移，并利用品种的最小报价步长忽略重复值。
- 多头条件要求最新上分形高于中间分形；空头条件要求最新下分形低于前一分形。

### 入场委托与到期

- 当不存在多头头寸或待执行的买入止损单时，在最新上分形放置买入止损，止损价设置为最近的下分形。
- 空头逻辑对称：在最新下分形放置卖出止损，保护性止损位于最近的上分形。
- 未成交的委托带有 `ExpirationHours` 定义的有效期。若收盘时间超过有效期，或结构被新的分形破坏（多头出现更低的上分形、空头出现更高的下分形），委托会被撤销。
- 一旦有仓位建立，会立即取消方向相反的委托，避免帐面遗留多余订单。

### 保护性跟踪止损

- 每个确认的相反方向分形都会更新保护性止损：多头追踪最新下分形，空头追踪最新上分形。
- 仅在新分形带来更优价格时才会替换旧的止损委托，从而实现“只收紧、不放松”。
- 仓位关闭后，所有剩余止损委托会被立刻取消。

### 风险管理与亏损序列控制

- `CalculateOrderVolume` 复刻了 MT5 的风险计算：单位风险 = 入场价与止损价的差值（空头反向计算）。
- 目标风险金额 = `Portfolio.CurrentValue * MaximumRiskPercent / 100`，若账户估值不可用则回退到策略的 `Volume` 属性。
- 结果数量会依据 `Security` 的手数、成交步长、最小与最大交易量进行归一化。
- 连续亏损会递增计数器，盈利或打平则清零。当亏损次数大于 1 时，仓位规模会按 `losses / DecreaseFactor` 的比例缩减。

### 交易结果跟踪

- 重写 `OnOwnTradeReceived`，汇总持仓周期内的成交，判断最终是盈利、亏损还是持平。
- 连续亏损计数与最近盈利时间会同步更新，完全保留原版专家顾问的逻辑，便于进一步统计分析。

## 使用建议

1. 将策略绑定到目标证券与投资组合，按照账户规模调整 `CandleType` 及风险参数。
2. 确认经纪商或适配器支持止损委托；若不支持，可在 `UpdateTrailingStops` 中改为手动平仓逻辑。
3. 策略仅处理已完成的 K 线，细小的盘中波动不会像 MT5 的逐笔回测那样触发委托。
4. 建议开启日志查看移植后的提示信息，以便验证与原 MQL 版本的一致性。
