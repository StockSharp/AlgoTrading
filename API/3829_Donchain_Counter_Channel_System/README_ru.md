# Donchain Counter-Channel System

## Обзор
**Donchain Counter-Channel System** — портирование советника MetaTrader 4, опубликованного Michal Rutka в журнале *Currency Trader* в 2005 году. Стратегия рассчитывает Donchian-канал длиной 20 свечей на выбранном таймфрейме (по умолчанию дневном). Если нижняя граница канала на предыдущей свече поднялась выше значения двух свечей назад, это трактуется как попытка покупателей перехватить инициативу, и на следующей свече открывается длинная позиция по рынку. Если верхняя граница опустилась, система открывает короткую позицию. Защитный стоп всегда привязывается к противоположной границе канала, что полностью воспроизводит механику исходного эксперта.

В течение 24 часов допускается только одно открытие позиции: после входа включается таймер ожидания, и новые сигналы игнорируются до его истечения. Благодаря высокоуровневому API StockSharp значения Donchian-канала поступают вместе с завершёнными свечами через механизм `BindEx`.

## Логика торговли
1. Подписаться на свечи типа `CandleType` (по умолчанию дневные) и вычислять индикатор `DonchianChannels` с периодом `ChannelPeriod`.
2. После закрытия каждой свечи:
   - При открытой длинной позиции подтягивать уровень стопа к текущей нижней границе канала и закрывать позицию, если минимум свечи пробивает этот уровень.
   - При открытой короткой позиции опускать стоп до текущей верхней границы и закрывать позицию при пробое максимумом свечи.
   - Если позиции нет, игнорировать сигналы, пока с момента последнего входа не прошло `TradeCooldown`.
   - Открывать лонг, когда нижняя граница Donchian на предыдущей свече выше, чем на свече до неё, — признак разворота канала вверх. Начальный стоп ставится на текущую нижнюю границу.
   - Открывать шорт, когда верхняя граница Donchian на предыдущей свече ниже, чем на свече до неё, — сигнал ослабления восходящего движения. Стоп размещается на текущей верхней границе.
3. Сопровождать позицию до тех пор, пока цена не пересечёт соответствующий стоп-уровень.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `Volume` | `1` | Объём заявок для длинных и коротких позиций. |
| `ChannelPeriod` | `20` | Количество свечей для расчёта Donchian-канала. |
| `TradeCooldown` | `1 день` | Минимальный интервал между повторными входами. |
| `CandleType` | `Дневные` | Тип свечей, на которых строится канал. |

## Индикаторы и данные
- **Donchian Channels** — источник верхней и нижней границ, служащих для определения разворотов и постановки стопов.
- **Дневные свечи (по умолчанию)** — обеспечивают временную метку для контроля 24-часовой задержки и кормят индикатор новыми данными.

## Особенности реализации
- Обработчик свечей подписан через `BindEx`, что позволяет одномоментно получать типизированное значение `DonchianChannelsValue` и работать сразу с обеими границами.
- Стоп-уровни моделируются программно: стратегия следит за максимумами и минимумами свечей, как и исходный советник, который переносил стопы по мере появления новых значений канала.
- Таймер `TradeCooldown` обновляется только при открытии позиции, поэтому внутри суток повторный вход невозможен, даже если позиция была закрыта раньше.
