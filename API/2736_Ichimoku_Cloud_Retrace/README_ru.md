# Стратегия Ichimoku Cloud Retrace
[English](README.md) | [中文](README_cn.md)

Стратегия представляет собой перенос эксперта MetaTrader «ichimok2005» на платформу StockSharp. Логика основана на откатах внутрь облака Ichimoku с входом в сторону текущего наклона кума. Сигналы рассчитываются только по завершённым свечам.

## Общая информация

- Подходит для любого инструмента и таймфрейма, в котором доступны свечные данные.
- По умолчанию использует стандартные периоды Ichimoku (9/26/52), но все параметры настраиваются.
- Работает в обе стороны (лонг и шорт). Размер позиции задаётся свойством `Volume` стратегии.
- Стоп-лосс и тейк-профит задаются в абсолютных ценовых единицах и могут быть отключены установкой значения `0`.

## Индикаторы и параметры

- **Ichimoku**: периоды линий Tenkan, Kijun и Senkou Span B вынесены в параметры.
- **Тип свечей**: можно выбирать любой агрегирующий тип свечей, поддерживаемый подключением (по умолчанию часовые свечи).
- **Stop Loss Offset**: расстояние от цены входа для защитного стопа. `0` — отключено.
- **Take Profit Offset**: расстояние от цены входа для фиксации прибыли. `0` — отключено.

## Правила входа

### Открытие длинной позиции

1. `Senkou Span A` располагается выше `Senkou Span B`, что указывает на бычье облако.
2. Текущая завершённая свеча бычья (`Close > Open`).
3. Закрытие находится внутри облака (`Close` между линиями `Senkou Span A` и `Senkou Span B`).
4. При выполнении условий и отсутствии длинной позиции отправляется рыночная заявка на покупку. Объём заявки включает закрытие возможного короткого остатка и набор новой длинной позиции.

### Открытие короткой позиции

1. `Senkou Span B` располагается выше `Senkou Span A`, что указывает на медвежье облако.
2. Текущая завершённая свеча медвежья (`Open > Close`).
3. Закрытие находится внутри облака (`Close` между двумя линиями облака).
4. При выполнении условий и отсутствии короткой позиции отправляется рыночная заявка на продажу, совмещающая закрытие лонга и открытие шорта.

## Правила выхода

- Обратный сигнал разворачивает позицию: стратегия рассчитывает объём так, чтобы одновременно закрыть старую позицию и открыть новую.
- При включённом `Stop Loss Offset` выход из лонга выполняется на уровне `EntryPrice - Offset`, из шорта — на `EntryPrice + Offset` (проверка по цене закрытия свечи).
- При включённом `Take Profit Offset` выход из лонга выполняется на `EntryPrice + Offset`, из шорта — на `EntryPrice - Offset`.
- Принудительное закрытие (остановка стратегии) сбрасывает запомненную цену входа.

## Управление рисками

- Смещения указываются в абсолютной цене. Перед настройкой переведите значение стопа из пунктов или тиков в цену инструмента.
- Так как контроль стопов и тейков происходит по цене закрытия свечи, для мелких таймфреймов имеет смысл задавать меньшие значения смещений.
- Частичных выходов и трейлинг-стопа нет: позиция закрывается полностью.

## Дополнительные детали реализации

- Стратегия подписывается на свечи через высокоуровневый API и связывает индикатор Ichimoku с помощью `BindEx`.
- Обрабатываются только завершённые свечи; промежуточные обновления игнорируются.
- При наличии графика автоматически рисуются цены, облако Ichimoku и сделки стратегии.
- Метод `ManageRisk` вызывается до проверки сигналов, чтобы защитные выходы выполнялись приоритетно.
