# Стратегия Poker Show

## Обзор

Стратегия Poker Show представляет собой прямую конверсию советника MetaTrader 5 «Poker_SHOW». Она сочетает фильтр тренда на основе скользящей средней с вероятностным триггером, имитирующим вытягивание покерной комбинации. Сделка исполняется только тогда, когда случайно сгенерированное число оказывается меньше выбранного порога покерной комбинации. Такой подход обеспечивает редкие входы и удерживает стратегию в направлении текущего тренда, определяемого скользящей средней.

Алгоритм рассчитан на работу с одним инструментом и использует стандартные свечи по времени. Решения пересматриваются после формирования каждой свечи, что соответствует исходному советнику, реагирующему на открытие нового бара.

## Основная логика

1. **Трендовый фильтр по скользящей средней**
   - Используется настраиваемая скользящая средняя (SMA, EMA, SMMA или LWMA), вычисляемая по выбранному типу цены (close, open, high, low, median, typical, weighted).
   - Индикатор может быть сдвинут вперёд по оси времени, чтобы повторить параметр `ma_shift` из MetaTrader. Для принятия решений берётся значение предыдущей полностью сформированной свечи.

2. **Вероятностный фильтр**
   - Для каждого направления на каждом баре генерируется независимое случайное число от 0 до 32 767.
   - Это число сравнивается с выбранной покерной комбинацией. Чем выше комбинация (например, стрит-флеш), тем меньше порог и тем реже будут сделки. Низшие комбинации (например, пара) приводят к более частым входам.

3. **Правила входа**
   - Лонг открывается, если скользящая средняя находится выше цены минимум на заданное расстояние. При включённом параметре **Reverse Signals** условие инвертируется.
   - Шорт открывается, если средняя находится ниже цены на то же расстояние. При инверсии сигналов логика зеркально меняется.
   - В любой момент времени поддерживается только одна позиция. Открытие позиции в противоположном направлении автоматически закрывает текущую и разворачивает экспозицию.

4. **Управление рисками**
   - Стоп-лосс и тейк-профит задаются в шагах цены относительно цены входа. Нулевое значение отключает соответствующий уровень.
   - Срабатывание стопа или цели проверяется на закрытии каждой свечи. При достижении уровня позиция закрывается, а внутренние отметки риска сбрасываются.

5. **Защита позиции**
   - При запуске активируется встроенный модуль защиты StockSharp, что помогает ограничить неожиданные убытки при ручном использовании.

## Параметры

| Параметр | Описание |
|----------|----------|
| **Poker Combination** | Порог вероятности, который должен превысить случайное число, чтобы открыть сделку. Соответствует классическим покерным комбинациям от стрит-флеша (самая редкая) до пары (самая частая). |
| **Volume** | Объём ордера в лотах. Используется как для новых входов, так и для разворота позиции. |
| **Stop Loss** | Расстояние от цены входа до защитного стопа в шагах цены. Ноль — стоп отключён. |
| **Take Profit** | Расстояние до цели в шагах цены. Ноль — тейк отключён. |
| **Enable Buy** | Разрешает открытие длинных позиций. |
| **Enable Sell** | Разрешает открытие коротких позиций. |
| **MA Distance** | Минимально необходимое расстояние между значением скользящей средней и ценой. Выступает в роли фильтра тренда. |
| **MA Period** | Количество баров в расчёте скользящей средней. |
| **MA Shift** | Горизонтальный сдвиг скользящей средней (в барах), полностью повторяет параметр `ma_shift` исходного советника. |
| **MA Method** | Тип сглаживания скользящей средней: простая, экспоненциальная, сглаженная или линейно взвешенная. |
| **Applied Price** | Тип цены свечи, используемый в расчёте средней. |
| **Reverse Signals** | Инвертирует сравнение средней и цены, меняя местами условия для лонгов и шортов. |
| **Candle Type** | Таймфрейм используемых свечей. По умолчанию — один час, как в оригинале. |

## Примечания

- Из-за вероятностного фильтра стратегия сильно зависит от случайности. Для оценки устойчивости рекомендуется проводить несколько прогоночных тестов или анализ Монте-Карло.
- Управление рисками происходит только на закрытии свечи. При сильных внутридневных движениях цена может выходить за уровни стопа или тейка до того, как стратегия успеет отреагировать. Если это критично, используйте более мелкие таймфреймы.
- Для максимально точного совпадения с MetaTrader следует убедиться, что у инструмента совпадают размер контракта и шаг цены.
- Заявки отправляются рыночными ордерами (`BuyMarket` и `SellMarket`), как и в исходном советнике. Обработка проскальзывания выполняется инфраструктурой StockSharp.
