# Poker Show 策略

## 概述

Poker Show 策略是 MetaTrader 5 指标交易系统 “Poker_SHOW” 的完整移植版本。策略将趋势型移动平均线过滤器与概率触发器结合起来，通过模拟抽取扑克手牌来控制入场频率。只有当随机生成的数值低于所选扑克组合阈值时才会开仓，因此策略在保持顺势交易的同时，交易次数较少。

该策略面向单一标的，使用常规的时间周期蜡烛图。在每根蜡烛完成时重新评估交易信号，与原始 EA 在新 K 线打开时做出决策的逻辑一致。

## 核心逻辑

1. **移动平均趋势过滤**
   - 可配置的移动平均线（SMA、EMA、SMMA 或 LWMA）基于指定的价格类型（收盘价、开盘价、最高价、最低价、中价、典型价、加权价）进行计算。
   - 指标可以向前平移若干根柱线，从而复刻 MetaTrader 中的 `ma_shift` 参数。策略始终使用上一根完整蜡烛的移动平均值。

2. **概率触发器**
   - 多头与空头方向在每个周期各自生成一个 0 到 32,767 的随机整数。
   - 随机值与所选扑克组合进行比较。级别越高的组合（如同花顺）对应的阈值越小，触发频率越低；级别越低的组合（如一对）则会更频繁地发出信号。

3. **方向性规则**
   - 当移动平均线高于当前价格且差距超过设定的点数时触发做多。如果启用了 **Reverse Signals** 选项，则条件反向。
   - 当移动平均线低于当前价格且差距超过设定的点数时触发做空。启用反向信号后逻辑同样翻转。
   - 任意时刻只允许持有一个净头寸。若方向相反的信号触发，将先平掉现有仓位，再建立新的反向仓位。

4. **风险控制**
   - 止损与止盈均以价格步长（点数）为单位，相对于成交价计算。设置为 0 即表示禁用。
   - 每根蜡烛收盘时都会检查是否触发止损或止盈。一旦价格触碰目标，策略立即平仓并清除内部风险标记。

5. **仓位保护**
   - 策略启动时会调用 StockSharp 的保护模块，以便在手动运行时限制极端亏损。

## 参数说明

| 参数 | 说明 |
|------|------|
| **Poker Combination** | 允许开仓的概率阈值，模拟从同花顺到一对的经典扑克组合。阈值越小，信号越稀少。 |
| **Volume** | 订单手数，用于新开仓以及反向开仓时平旧仓。 |
| **Stop Loss** | 距离入场价的止损距离（点数）。为 0 时不设置止损。 |
| **Take Profit** | 距离入场价的止盈距离（点数）。为 0 时不设置止盈。 |
| **Enable Buy** | 允许策略开多仓。 |
| **Enable Sell** | 允许策略开空仓。 |
| **MA Distance** | 移动平均值与价格之间的最小距离（点数），用于确认趋势。 |
| **MA Period** | 移动平均线的计算周期。 |
| **MA Shift** | 移动平均线的水平平移（单位：柱），对应 MetaTrader 的 `ma_shift` 设置。 |
| **MA Method** | 移动平均线类型：简单、指数、平滑或线性加权。 |
| **Applied Price** | 参与移动平均计算的蜡烛价格类型。 |
| **Reverse Signals** | 反转移动平均与价格的比较关系，从而互换多空逻辑。 |
| **Candle Type** | 使用的蜡烛周期，默认是一小时，与原策略保持一致。 |

## 使用建议

- 概率门控使策略具有明显的随机性。回测时建议进行多次重复或使用蒙特卡洛分析来观察结果分布。
- 因为止损和止盈只在蜡烛收盘时检查，盘中快速波动可能会在策略反应之前突破目标位。若担心该问题，可选择更短周期的蜡烛。
- 为尽量还原 MetaTrader 环境，应确认标的的合约规模和最小变动价位与原始设置一致。
- 策略通过 `BuyMarket` 与 `SellMarket` 提交市价单，与原始 EA 的执行方式一致。具体的滑点处理由 StockSharp 交易基础设施完成。
