# Стратегия Training Simulator

## Обзор
Стратегия Training Simulator представляет собой перенос эксперта MetaTrader 4 `Training2.mq4` на платформу StockSharp. В
оригинале трейдер управлял сделками вручную: перетаскивал подписи на графике, чтобы открыть/закрыть покупки и продажи, менял
значения стоп-лосса и тейк-профита и останавливал тестер при достижении пользовательских уровней. В версии StockSharp эти
действия реализованы через параметры стратегии. Появились переключатели для ручного входа в лонг/шорт, отдельные флаги для
повторного расчёта защитных расстояний и мониторинг верхней/нижней границ, способный автоматически остановить стратегию.

Перенос рассчитан на неттинговую модель (одна суммарная позиция по инструменту) и использует высокоуровневый API StockSharp для
отправки рыночных заявок, закрытия позиции и подписки на сделки, необходимые для отслеживания ценовых прорывов.

## Логика работы
1. **Ручные переключатели входа**
   - Перевод `EnableBuy` в состояние `true` отправляет рыночную заявку на покупку с объёмом `Volume`. Возврат в `false` закрывает
     текущий лонг. При активации лонга переключатель шорта сбрасывается, чтобы избежать конфликтов.
   - `EnableSell` действует аналогично для короткой позиции. Пока оба переключателя равны `false`, стратегия остаётся вне рынка.
2. **Защитные расстояния**
   - `StopLossPoints` и `TakeProfitPoints` задаются в метатрейдеровских «пунктах». Стратегия умножает их на `PriceStep` инструмента,
     запоминает текущие значения и проверяет их на каждой новой сделке. При достижении стопа или цели генерируется лог и
     отправляется команда на закрытие позиции.
   - `ModifyLongTargets` и `ModifyShortTargets` позволяют вручную обновить защитные уровни в уже открытой позиции. После
     применения флаги автоматически возвращаются в `false`.
3. **Контроль прорывов**
   - Параметры `UpperStopPrice` и `LowerStopPrice` повторяют логику метатрейдеровских надписей «Upper/Lower Stop». Когда цена
     пересекает один из уровней, стратегия пишет сообщение и, при включённом `PauseOnBreakpoint`, вызывает `Stop()` для полной
     остановки.
4. **Управление состоянием**
   - Подписка на сделки оформляется через `SubscribeTrades().Bind(ProcessTrade).Start()`, а проверка ручных параметров выполняется
     таймером с шагом 250 мс. Внутренний флаг `_closeInProgress` защищает от повторной отправки ордера, пока предыдущая команда
     закрытия ещё не исполнена. После возврата к нулевой позиции переключатели автоматически сбрасываются в `false`, как и в MT4
     при возврате меток на исходное место.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `Volume` | Объём каждой рыночной заявки. | `0.1` |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах MetaTrader. | `30` |
| `StopLossPoints` | Расстояние до стоп-лосса в пунктах MetaTrader. | `30` |
| `UpperStopPrice` | Верхний уровень прорыва (0 отключает контроль). | `0` |
| `LowerStopPrice` | Нижний уровень прорыва (0 отключает контроль). | `0` |
| `PauseOnBreakpoint` | Автоматически остановить стратегию при срабатывании уровня. | `true` |
| `EnableBuy` | Ручной переключатель длинной позиции. | `false` |
| `EnableSell` | Ручной переключатель короткой позиции. | `false` |
| `ModifyLongTargets` | Повторно применить стоп/профит для лонга, затем сбросить флаг. | `false` |
| `ModifyShortTargets` | Повторно применить стоп/профит для шорта, затем сбросить флаг. | `false` |

## Особенности реализации
- Стратегия работает на потоке сделок, что позволяет реагировать на цену так же, как оригинальный советник, работавший на тиках.
- Таймер с периодом 250 мс обеспечивает быструю реакцию на изменение параметров, не создавая лишнюю нагрузку.
- Метод `AdjustVolume` приводит объём к допустимому шагу и диапазону `VolumeStep`/`MinVolume`/`MaxVolume`, чтобы заявки
  соответствовали требованиям площадки.
- При наличии данных берётся `PositionPrice`; если он пока равен нулю, используется последняя цена сделки `_lastTradePrice`.
- Для прорывов поддерживается одноразовый триггер — одно и то же событие не вызывает повторных `Stop()` и сообщений в логе.

## Отличия от версии на MQL
- Управление через графические метки заменено на булевы параметры, поскольку StockSharp не предоставляет аналогичных
  инструментов рисования на графике.
- MetaTrader в режиме хеджирования позволял одновременно держать лонг и шорт; перенос использует стандартную неттинговую модель
  StockSharp.
- В MT4 пауза тестера достигалась отправкой нажатия клавиши `Pause`. В StockSharp прерывание реализовано вызовом `Stop()` и
  подробной записью в журнал.
- Стопы и цели рассчитываются внутри стратегии, без вызова `OrderModify`, что делает код независимым от конкретного брокера и
  коннектора.
