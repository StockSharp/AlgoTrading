# Стратегия «Two Pair Correlation»

## Обзор

**Two Pair Correlation** переносит советник MetaTrader *«2-Pair Correlation EA»* (каталог `MQL/52043`) на высокоуровневый API StockSharp. Стратегия следит за ценами bid двух скоррелированных криптоинструментов (BTCUSD как основной, ETHUSD как хедж) и строит рыночно-нейтральную позицию, когда их спред выходит за границы допустимого коридора.

### Основные этапы

1. **Контроль риска** – капитал портфеля отслеживается непрерывно. Если просадка от исторического максимума превышает `MaxDrawdownPercent`, открытие новых сделок блокируется до тех пор, пока капитал не восстановится выше `RecoveryPercent` от пика.
2. **Фильтр волатильности** – обе бумаги формируют 5-минутные свечи и подаются в индикатор `AverageTrueRange` длиной `AtrPeriod`. Если хотя бы одно значение ATR превышает `PriceDifferenceThreshold * 0.01`, сигнал считается небезопасным и пропускается.
3. **Оценка спреда** – стратегия подписывается на Level1 по обоим инструментам и на каждом обновлении сравнивает их bid. При `Bid(BTCUSD) - Bid(ETHUSD) > PriceDifferenceThreshold` открывается покупка BTCUSD и продажа ETHUSD. При спреде ниже `-PriceDifferenceThreshold` выполняется зеркальная комбинация.
4. **Динамический объем** – объём каждой ноги рассчитывается из `RiskPercent` текущей стоимости портфеля, делённой на искусственный стоп `StopLossPips * PriceStep`. Полученное значение приводится к биржевым ограничениям по шагу и диапазону объёмов.
5. **Выход по прибыли** – суммарная нереализованная прибыль обеих позиций оценивается в валюте счёта. Когда она достигает `MinimumTotalProfit`, пара закрывается полностью независимо от исходного направления.

## Требуемые данные

- **Level1** (лучшие bid/ask) по основному инструменту (`Security`) и хеджу (`SecondSecurity`).
- **Свечи** типа `AtrCandleType` (по умолчанию 5 минут) для обеих бумаг – источник данных для ATR.

Убедитесь, что инструменты предоставляют корректные `PriceStep`, `StepPrice`, `VolumeStep`, а также допустимые минимальные и максимальные объёмы – от этого зависит точность расчёта лотов и прибыли.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --------------------- | -------- |
| `SecondSecurity` | `Security` | — | Хеджирующий инструмент (ETHUSD в оригинале). |
| `MaxDrawdownPercent` | `decimal` | `20` | Просадка, при которой новые входы блокируются. |
| `RiskPercent` | `decimal` | `2` | Доля капитала, используемая для расчёта объёма сделки. |
| `PriceDifferenceThreshold` | `decimal` | `100` | Порог расхождения bid-цен для открытия пары. |
| `MinimumTotalProfit` | `decimal` | `0.30` | Цель по совокупной прибыли в валюте счёта. |
| `AtrPeriod` | `int` | `14` | Длина ATR-фильтра волатильности. |
| `RecoveryPercent` | `decimal` | `95` | Процент восстановления от пика, после которого торговля возобновляется. |
| `StopLossPips` | `int` | `50` | Искусственный стоп для пересчёта `RiskPercent` в объёмы. |
| `AtrCandleType` | `DataType` | `TimeSpan.FromMinutes(5).TimeFrame()` | Тип свечей, используемых при вычислении ATR. |

## Файлы

- `CS/TwoPairCorrelationStrategy.cs` — реализация стратегии.
- `README.md` — документация на английском языке.
- `README_cn.md` — документация на китайском языке.
- `README_ru.md` — документация на русском языке.
