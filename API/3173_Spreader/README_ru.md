# Стратегия Spreader

## Описание

**Spreader** — это реализация классической парной стратегии, основанной на оригинальном советнике MetaTrader «Spreader». Она
одновременно отслеживает два положительно коррелированных инструмента, открывает рыночно-нейтральную позицию при краткосрочном
расхождении и фиксирует прибыль при достижении заданного денежного порога. По умолчанию стратегия рассчитана на минутные свечи,
но таймфрейм можно изменить в Designer, Shell или собственных приложениях StockSharp.

## Принцип работы

1. **Подготовка данных**
   - Подписывается на свечи по основному и второму инструменту, обрабатывает только завершённые свечи.
   - Хранит `2 * ShiftLength + 1` последних закрытий для каждого инструмента (при `ShiftLength = 30` требуется 61 свеча).
   - Продолжает расчёт только если свечи обоих инструментов имеют одинаковое время открытия — это защищает от несинхронных данных.

2. **Фильтр тренда**
   - Вычисляет две последовательные разницы цен для каждого инструмента. Совпадение знаков означает наличие тренда, поэтому вход
     игнорируется.

3. **Проверка корреляции**
   - Требует одинакового направления последнего движения на обоих инструментах. Противоположные знаки трактуются как отрицательная
     корреляция и сигнал отбрасывается.

4. **Согласование волатильности**
   - Рассчитывает величины недавних колебаний (``a`` и ``b``) и применяет их отношение для подбора объёма по второму инструменту.
     Значения вне диапазона `[0.3, 3]` считаются аномальными и приводят к отказу от сделки.

5. **Открытие позиции**
   - Если колебание на основном инструменте сильнее, покупает его и продаёт второй инструмент. В обратной ситуации продаёт основной
     инструмент и покупает второй.
   - Объёмы нормализуются с учётом минимального шага, минимального и максимального лота каждого инструмента.

6. **Сопровождение**
   - При отсутствии одной из ног (например, после повторного подключения) стратегия достраивает недостающую позицию, чтобы вернуть
     хеджирующую структуру.
   - Если остаётся только основная нога, она закрывается, чтобы не оставлять направленную позицию.
   - Когда открыты обе ноги, стратегия контролирует суммарную плавающую прибыль и закрывает обе позиции при достижении значения
     `TargetProfit`.

7. **Защитные проверки**
   - Если множители контрактов различаются, торговля блокируется — исходный алгоритм предполагает идентичные спецификации инструментов.
   - Любые торговые действия выполняются только после проверки `IsFormedAndOnlineAndAllowTrading`, то есть при готовности коннектора,
     наличии портфеля и разрешения на торговлю.

## Параметры

| Параметр | Описание |
|----------|----------|
| `SecondSecurity` | Второй инструмент в паре. Обязательный параметр. |
| `PrimaryVolume` | Базовый объём сделок по основному инструменту. Объём второй ноги масштабируется автоматически. |
| `TargetProfit` | Целевой размер совокупной прибыли (в валюте счёта), по достижении которого обе ноги закрываются. |
| `ShiftLength` | Количество свечей между сравниваемыми точками. Алгоритм использует `2 * ShiftLength + 1` свечей каждой бумаги. |
| `CandleType` | Тип свечей для анализа. По умолчанию — минутные. |

## Рекомендации

- Выбирайте пары с устойчивой положительной корреляцией и сопоставимой волатильностью (например, схожие валютные пары или фьючерсы на
  один индекс).
- Следите за тем, чтобы спецификации контрактов совпадали (шаг цены, минимальный лот, требования по марже), иначе нормализация объёмов
  может привести к слишком маленьким сделкам.
- Убедитесь, что поставщик данных отдает синхронные свечи по обеим бумагам; в противном случае входы будут пропускаться.

## Требования

- Две ликвидные бумаги с положительной корреляцией.
- Доступ к рыночным данным и возможность совершать сделки по обеим бумагам через подключенный коннектор StockSharp.
- Назначенный портфель (Portfolio) в настройках стратегии.
