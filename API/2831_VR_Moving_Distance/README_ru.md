# Стратегия VR Moving Distance
[English](README.md) | [中文](README_cn.md)

Эта стратегия StockSharp воспроизводит эксперта VR-Moving для MetaTrader 5. Она отслеживает настраиваемую скользящую среднюю и реагирует, когда цена уходит от неё на заданное количество пунктов. Алгоритм умеет наращивать позицию, умножая базовый объём ордера при последующих входах, и использует простое правило фиксации прибыли, пока открыта только одна позиция.

## Общее описание
- Работает с инструментом, назначенным стратегии, используя единственную подписку на свечи.
- Рассчитывает скользящую среднюю с настраиваемой длиной, типом сглаживания и источником цены.
- Переводит параметры расстояния и тейк-профита из пунктов в ценовые значения через шаг цены инструмента.
- Добавляет длинные позиции, когда цена поднимается достаточно высоко над средней, и короткие позиции, когда цена опускается ниже неё.
- Перед открытием позиции в противоположную сторону закрывает текущий нетто-объём, чтобы стратегия оставалась совместимой с неттингом портфеля.

## Индикаторы и данные
- Одна скользящая средняя (`Simple`, `Exponential`, `Smoothed`, `Weighted` или `VolumeWeighted`).
- Свечи приходят с заданным `Candle Type`; этот же поток используется для расчёта индикатора и торговых решений.

## Правила входа
1. На каждой завершённой свече стратегия ждёт, пока скользящая средняя полностью сформируется.
2. Если максимум бара находится минимум на `DistancePips` выше средней, формируется сигнал на покупку.
3. Если минимум бара находится минимум на `DistancePips` ниже средней, формируется сигнал на продажу.
4. При смене направления текущая позиция закрывается за счёт увеличения объёма нового рыночного ордера в противоположную сторону.

## Наращивание и объём
- Первый ордер использует заданный `BaseVolume`.
- Последующие ордера в ту же сторону используют `BaseVolume * VolumeMultiplier`.
- Хранится максимальная цена входа для лонгов и минимальная для шортов. Новый добор возможен только после того, как цена уйдёт ещё на `DistancePips` от соответствующего экстремума.

## Правила выхода
- Когда открыт ровно один лонг, устанавливается цель по прибыли на уровне входной цены плюс `TakeProfitPips` (в ценовых единицах). Если максимум свечи достигает цели, позиция закрывается.
- Аналогично, одиночный шорт получает цель на уровне входной цены минус `TakeProfitPips` и закрывается, если минимум свечи достигает отметки.
- При наличии нескольких ордеров стратегия удерживает позицию и ждёт следующих сигналов на добор; усреднённые выходы в этом порте не реализованы.

## Замечания по управлению рисками
- При запуске вызывается `StartProtection()`, чтобы подключиться к стандартным защитным механизмам StockSharp.
- Параметры расстояния и тейк-профита задаются в пунктах. Для инструментов с 3 или 5 знаками после запятой цена шага умножается на 10, как в оригинале MetaTrader.
- Автоматический стоп-лосс не используется; риски необходимо контролировать параметрами стратегии и внешними ограничениями портфеля.

## Параметры
- **Candle Type** – тип данных свечи для подписки.
- **MA Length** – период скользящей средней.
- **MA Type** – тип сглаживания скользящей средней.
- **Price Source** – цена свечи, используемая в расчёте средней.
- **Distance (pips)** – минимальный разрыв в пунктах между ценой и средней для открытия позиции.
- **Take Profit (pips)** – расстояние до цели по прибыли при одиночной позиции.
- **Volume Multiplier** – множитель объёма для дополнительных ордеров.
- **Base Volume** – базовый объём первого входа.
