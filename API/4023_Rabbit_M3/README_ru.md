# Rabbit M3

## Обзор
Rabbit M3 — порт советника MetaTrader 4 `RabbitM3` (известного также как «Petes Party Trick»). Стратегия определяет, торговать ли только в длинную или только в короткую сторону, по соотношению двух часовых экспоненциальных средних. Для входа требуется пересечение Williams %R и подтверждение по индикатору CCI, а экстремально длинный канал Дончиана отслеживает прорывы против текущего тренда. Правило увеличения объёма после крупной прибыльной сделки также перенесено из оригинала.

## Логика стратегии
### Фильтр режимов
* Если быстрая EMA закрывается ниже медленной, текущие длинные позиции закрываются и стратегия ищет только короткие сигналы.
* Если быстрая EMA закрывается выше медленной, текущие короткие позиции закрываются и разрешаются только длинные сделки.
* При равных значениях EMA сохраняется предыдущий режим — в исходном коде переключение происходило только при строгом неравенстве.

### Правила входа
* **Короткие позиции**
  * Режим должен быть «только шорт» (быстрая EMA ниже медленной).
  * Williams %R (период = `WilliamsPeriod`) на последней свече пересекает `WilliamsSellLevel` сверху вниз, а предыдущее значение остаётся ниже нуля.
  * Значение CCI (период = `CciPeriod`) должно быть не меньше `CciSellLevel`.
  * Чистая позиция должна быть нулевой; стратегия открывает не более `MaxOpenPositions` сделок и по умолчанию отправляет рыночную заявку объёмом `EntryVolume`.
* **Длинные позиции**
  * Режим должен быть «только лонг» (быстрая EMA выше медленной).
  * Williams %R пересекает `WilliamsBuyLevel` снизу вверх, при этом предыдущее значение остаётся ниже нуля.
  * CCI должно быть не выше `CciBuyLevel`.
  * Перед входом чистая позиция обязана быть нулевой.

### Правила выхода
* **Фиксированные уровни** — `StopLossPips` и `TakeProfitPips` переводятся в цену через минимальный шаг инструмента; значение `0` отключает соответствующую защиту.
* **Прорыв канала Дончиана** — закрытие выше предыдущей верхней границы (период = `DonchianLength`) немедленно закрывает шорты. Закрытие ниже предыдущей нижней границы закрывает лонги. Используется значение канала на предыдущей свече, чтобы повторить сдвиг `shift=1` из MQL.
* **Смена режима** — при смене направления по EMA противоположные позиции закрываются прежде, чем разрешить новые сделки в новом направлении.

### Управление капиталом
* Стартовый объём сделки — `EntryVolume`.
* Когда реализованная прибыль в момент отсутствия позиции превышает `BigWinThreshold`, следующий объём увеличивается на `VolumeIncrement`, а порог удваивается (4 → 8 → 16 и т. д.). Установка любого из параметров в `0` отключает увеличение объёма.

## Параметры
* **Fast EMA Period** — период быстрой EMA (по умолчанию 33).
* **Slow EMA Period** — период медленной EMA (по умолчанию 70).
* **Williams %R Period** — период осциллятора Williams %R (по умолчанию 62).
* **Williams Sell Level** — уровень, который должен быть пробит сверху вниз для шорт-сигнала (по умолчанию −20).
* **Williams Buy Level** — уровень, который должен быть пробит снизу вверх для лонг-сигнала (по умолчанию −80).
* **CCI Period** — период индикатора CCI (по умолчанию 26).
* **CCI Sell Level** — минимальное значение CCI для разрешения шортов (по умолчанию 101).
* **CCI Buy Level** — максимальное значение CCI для разрешения лонгов (по умолчанию 99).
* **Donchian Length** — количество свечей, используемых для выхода по каналу Дончиана (по умолчанию 410).
* **Max Open Positions** — максимум одновременно открытых позиций; оригинал использует одну (по умолчанию 1).
* **Take Profit (pips)** — расстояние до тейк-профита в пунктах (по умолчанию 360).
* **Stop Loss (pips)** — расстояние до стоп-лосса в пунктах (по умолчанию 20).
* **Entry Volume** — начальный торговый объём (по умолчанию 0.01).
* **Big Win Threshold** — прибыль, после которой объём увеличивается (по умолчанию 4.0).
* **Volume Increment** — добавка к объёму после преодоления порога (по умолчанию 0.01).
* **Candle Type** — таймфрейм свечей для расчёта индикаторов (по умолчанию 1 час).

## Дополнительные замечания
* Конвертация пунктов использует `PriceStep` инструмента; при его отсутствии применяется единичный шаг.
* Значения канала Дончиана намеренно сдвинуты на одну свечу, чтобы повторить вызовы `iHighest`/`iLowest` с параметром `shift=1`.
* Увеличение объёма анализирует только реализованную прибыль при нулевой позиции, чтобы колебания плавающего PnL не давали ложных срабатываний.
* Графические подписи из исходного MQL-советника не переносились: в StockSharp состояние контролируется через графики и логи.
* В пакете присутствует только C#-версия стратегии; Python-реализация отсутствует.
