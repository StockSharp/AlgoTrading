# Стратегия повторного входа по TTM Trend

## Обзор
Стратегия переносит логику советника MetaTrader *Exp_ttm-trend_ReOpen* в инфраструктуру StockSharp. Индикатор TTM Trend рассчитывается через свечи Heikin-Ashi, каждая свеча раскрашивается в соответствии с направлением тела, и при смене цвета система закрывает противоположную позицию и открывает сделку в новом направлении. Таким образом ловится переход от сжатия волатильности к расширению и наоборот.

## Работа индикатора
Окраска свечи зависит от комбинации Heikin-Ashi и обычной свечи:

- **Ярко‑зелёный (4)** – Heikin-Ashi бычья, обычная свеча тоже закрылась выше открытия.
- **Бирюзовый (3)** – Heikin-Ashi бычья, но классическая свеча закрылась ниже открытия.
- **Малиновый (0)** – Heikin-Ashi медвежья, и классическая свеча закрылась ниже открытия.
- **Фиолетовый (1)** – Heikin-Ashi медвежья, но классическая свеча закрылась выше открытия.
- **Серый (2)** – нейтральное состояние, когда определить направление невозможно.

Чтобы воспроизвести сглаживание MetaTrader, индикатор хранит `CompBars` последних значений Heikin-Ashi. Если новое тело полностью укладывается в диапазон любой из сохранённых свечей, используется предыдущий цвет. Это подавляет мелкие откаты и совпадает с поведением оригинальной реализации.

## Правила торговли
1. Подписаться на свечи типа `CandleType` и работать только с завершёнными барами. Параметр `SignalBar` задаёт, сколько закрытых баров брать от конца истории.
2. При появлении **бычьего цвета** (значения 1 или 4), которого не было на предыдущем сигнале:
   - Закрыть шорт, если включён `EnableShortExits`.
   - Открыть или перевернуться в лонг, если разрешён `EnableLongEntries`.
3. При появлении **медвежьего цвета** (значения 0 или 3), которого не было на предыдущем сигнале:
   - Закрыть лонг, если включён `EnableLongExits`.
   - Открыть или перевернуться в шорт, если разрешён `EnableShortEntries`.
4. При движении цены в прибыль на величину `PriceStepPoints` (переведённую в цену через `PriceStep`) стратегия добавляет ещё одну позицию базового объёма `Volume`. Общее число добавлений в одном направлении ограничено параметром `MaxPositions`.

## Пирамидинг
- `PriceStepPoints` повторяет одноимённый параметр советника: как только нереализованная прибыль превышает заданный шаг, добавляется следующий лот.
- `MaxPositions` ограничивает суммарное количество входов в одном направлении (включая первый). Значение `1` полностью отключает повторные входы.

## Управление рисками
`StopLossPoints` и `TakeProfitPoints` задаются в пунктах. Стратегия умножает их на `Security.PriceStep` и передаёт в `StartProtection`, формируя абсолютный уровень стоп-лосса и тейк-профита. Ноль отключает соответствующую защиту.

## Параметры
- `CandleType` – таймфрейм для расчёта TTM Trend (по умолчанию 4 часа).
- `CompBars` – глубина истории Heikin-Ashi для сглаживания цвета (по умолчанию 6).
- `SignalBar` – сколько закрытых баров отступить от последнего при анализе (по умолчанию 1 – последний закрытый бар).
- `PriceStepPoints` – минимальное благоприятное движение в пунктах перед добавлением позиции (по умолчанию 300).
- `MaxPositions` – максимум входов в одном направлении (по умолчанию 10).
- `EnableLongEntries` / `EnableShortEntries` – разрешение на открытие лонгов/шортов при смене цвета.
- `EnableLongExits` / `EnableShortExits` – разрешение на принудительное закрытие противоположных позиций.
- `StopLossPoints` – расстояние стоп-лосса в пунктах (по умолчанию 1000).
- `TakeProfitPoints` – расстояние тейк-профита в пунктах (по умолчанию 2000).

## Практические советы
- В оригинале использовался таймфрейм H4, однако вы можете выбрать любой `CandleType`.
- Из-за работы с Heikin-Ashi резкие гэпы могут отразиться только на следующей закрытой свече.
- Чтобы отключить пирамидинг, установите `PriceStepPoints` равным нулю.
