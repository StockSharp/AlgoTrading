# Стратегия Currencyprofits High-Low Channel

## Обзор
Данная стратегия — порт экспертного советника MetaTrader `Currencyprofits_01.1` на платформу StockSharp. Комбинация быстрой и медленной скользящих средних используется для оценки направления тренда, а пробой экстремумов канала из последних баров служит точкой входа. Когда быстрая средняя находится выше медленной, предполагается восходящий тренд и стратегия ждёт отката к минимуму канала. При обратном соотношении средних ожидается нисходящее движение и отслеживается возврат к максимуму канала для открытия короткой позиции.

Все расчёты выполняются по закрытым свечам, поэтому алгоритм устойчив в тестах и на реальных данных.

## Логика торговли
1. Подписка на выбранный тип свечей и расчёт двух скользящих средних вместе с каналом из последних `ChannelLength` баров (по умолчанию 6).
2. Сохранение значений предыдущей свечи для индикаторов, что повторяет оригинальную MQL-реализацию с использованием сдвига на один бар.
3. **Вход в лонг**: предыдущая быстрая средняя выше предыдущей медленной, текущий минимум свечи касается либо пробивает предыдущий минимум канала.
4. **Вход в шорт**: предыдущая быстрая средняя ниже предыдущей медленной, текущий максимум свечи касается либо пробивает предыдущий максимум канала.
5. **Правила выхода**:
   - Закрытие длинной позиции, если следующая свеча закрывается выше сохранённого максимума канала или достигается стоп-лосс.
   - Закрытие короткой позиции, если следующая свеча закрывается ниже сохранённого минимума канала или срабатывает стоп-лосс.
6. Одновременно может быть открыта только одна позиция; пока сделка активна, новые сигналы игнорируются.

## Управление риском
- `RiskPercent` задаёт долю капитала, допускаемую к риску в одной сделке (по умолчанию `0.14`, то есть 14%).
- Расстояние стоп-лосса рассчитывается как `StopLossPoints`, умноженное на `PriceStep` инструмента (или используется значение в пунктах, если метаданные отсутствуют).
- Денежный риск на контракт определяется через `StepPrice`. Если биржевые параметры недоступны, применяется чистая ценовая разница.
- Итоговый объём приводится к требованиям инструмента (`VolumeStep`, `MinVolume`, `MaxVolume`). При невозможности вычислить объём по риску используется базовое значение `Volume` стратегии.

## Параметры
- `FastLength` — период быстрой скользящей средней (по умолчанию 32).
- `FastMaType` — тип скользящей средней для быстрой линии (Simple, Exponential, Smoothed, Weighted).
- `SlowLength` — период медленной скользящей средней (по умолчанию 86).
- `SlowMaType` — тип скользящей средней для медленной линии.
- `PriceSource` — цена свечи, применяемая при вычислении средних (по умолчанию Close).
- `ChannelLength` — количество предыдущих свечей, формирующих канал максимумов/минимумов (по умолчанию 6).
- `StopLossPoints` — расстояние до стоп-лосса в пунктах (по умолчанию 170).
- `RiskPercent` — доля капитала под риском в сделке (по умолчанию 0.14 → 14%).
- `CandleType` — тип свечей, используемых для расчётов (по умолчанию часовой таймфрейм, можно изменять под нужды стратегии).

## Рекомендации по применению
- Перед запуском заполните свойства инструмента `PriceStep`, `StepPrice` и параметры объёма для корректного расчёта размера позиции.
- Установите разумное значение `Volume`, чтобы стратегия знала объём по умолчанию при отключённом управлении риском (например, `RiskPercent = 0`).
- Сделки открываются по закрытию свечи, которая подтверждает сигнал.
- Отдельного тейк-профита нет — логика выхода совпадает с оригинальным советником и использует стоп-лосс и обратный пробой канала.

## Источник
Конвертировано из `MQL/17641/Currencyprofits_01.1.mq5` с использованием высокоуровневого API StockSharp.
