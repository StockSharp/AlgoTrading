# 三根K线反转策略
[English](README.md) | [Русский](README_ru.md)

该策略将 MQL5 专家顾问 `Exp_ThreeCandles` 完整移植到 StockSharp。核心思想是寻找典型的三根K线反转形态：

1. 连续两根同向K线（多头反转时为两根阴线，空头反转时为两根阳线）。
2. 第三根K线方向反转，并且收盘价突破前一根中间K线的开盘价/高低点。
3. 可选的成交量确认，当最老的那根K线波动过大时会自动跳过此过滤。

当出现多头形态时，策略会先平掉空头，再根据参数决定是否开多；出现空头形态时逻辑相反。止损与止盈距离通过当前品种的最小报价单位（PriceStep）来设置。

## 形态识别

策略维护一段包含 `SignalBar + 3` 根已完成K线的滑动窗口。每当有新的K线收盘，就会取位于 `SignalBar` 偏移（默认：向前1根）的那根K线以及再往前的三根K线进行判断：

- **多头反转（准备做多）**：
  - 最老的两根K线（`SignalBar + 3` 与 `SignalBar + 2`）均为下跌K线。
  - 中间K线的收盘价高于最老K线的最低价。
  - 位于 `SignalBar + 1` 的最近一根K线为上涨K线，且收盘价高于中间K线的开盘价。
- **空头反转（准备做空）**：
  - 上述条件镜像互换。

成交量过滤完全复刻原始指标。当最老K线的振幅换算成价格步长后超过 `MaxBarSize`，或 `VolumeFilter` 设置为 `None` 时跳过过滤。否则需要满足以下条件之一：`最老成交量 < 中间成交量`、或`最近成交量 > 中间成交量`、或`最近成交量 > 最老成交量`。由于高阶API仅提供聚合成交量，`Tick` 与 `Real` 模式都使用蜡烛的 `TotalVolume` 字段。

## 交易管理

- 启用 `AllowSellExit` 时，检测到多头形态会立即平仓任何空头仓位，再根据 `AllowBuyEntry` 判断是否开多；`AllowBuyExit` 对多头仓位执行对称逻辑。
- 只有在当前仓位为空并且对应的 `Allow*Entry` 参数为真时才会开仓，成交量使用策略的默认下单量。
- `StopLossPips` 与 `TakeProfitPips` 以价格步长为单位，在每根已完成K线上检查是否命中。
- 策略缓存最近一次多/空信号的收盘时间，防止在同一根K线的多个tick上重复触发。

## 参数

| 参数 | 默认值 | 说明 |
| ---- | ------ | ---- |
| `CandleType` | 4小时K线 | 策略订阅与处理的K线类型。 |
| `SignalBar` | 1 | 用于评估信号的历史偏移，必须 ≥ 0。 |
| `MaxBarSize` | 300 | 如果最老K线的振幅（乘以 `PriceStep`）超过该值，则跳过成交量过滤；设置为0则永远跳过。 |
| `VolumeFilter` | `Tick` | 成交量模式（`Tick`、`Real` 或 `None`），前两者都使用 `TotalVolume`。 |
| `AllowBuyEntry` | `true` | 允许在多头形态出现时开多。 |
| `AllowSellEntry` | `true` | 允许在空头形态出现时开空。 |
| `AllowBuyExit` | `true` | 允许在空头形态出现时平掉多头仓位。 |
| `AllowSellExit` | `true` | 允许在多头形态出现时平掉空头仓位。 |
| `StopLossPips` | 1000 | 止损距离（价格步长单位，0 表示禁用）。 |
| `TakeProfitPips` | 2000 | 止盈距离（价格步长单位，0 表示禁用）。 |

## 移植说明

- 原MQL5中通过 `TradeAlgorithms.mqh` 计算头寸大小的资金管理被替换为 StockSharp 的 `BuyMarket`/`SellMarket` 调用，因此仓位规模遵循平台默认设置。
- 信号时序与专家顾问保持一致：在 `SignalBar` 偏移的K线上作出决策，并记录最近一次信号时间以避免重复执行。
- 指标中的声音、邮件和推送提醒在移植时被刻意省略。
- 虽然保留了 `Tick`/`Real` 两种选项，但由于高阶API无法区分，二者都映射到蜡烛的聚合成交量。
- 所有注释与文档均改写为英文，以符合仓库要求。

该策略在遵循原始逻辑的同时，完全兼容 StockSharp 的高阶订阅与执行模式。
