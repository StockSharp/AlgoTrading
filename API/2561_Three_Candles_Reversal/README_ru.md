# Стратегия «Three Candles Reversal»
[English](README.md) | [中文](README_cn.md)

Данная стратегия является переносом советника `Exp_ThreeCandles` из MQL5 в инфраструктуру StockSharp. Она ищет классический разворот из трёх свечей:

1. Две подряд свечи в одном направлении.
2. Третья свеча меняет направление и закрывается за ключевым уровнем предыдущей свечи.
3. При необходимости проверяется подтверждение объёмом, если диапазон самой ранней свечи не слишком велик.

Появление бычьей конфигурации закрывает короткие позиции (если это разрешено) и может открыть длинную. Медвежий сигнал выполняет зеркальные действия. Стоп-лосс и тейк-профит рассчитываются в шагах цены (`PriceStep`).

## Определение паттерна

Стратегия хранит скользящее окно из `SignalBar + 3` завершённых свечей. При закрытии новой свечи проверяется свеча с индексом `SignalBar` (по умолчанию — одна свеча назад) и три более старых бара:

- **Бычий разворот (возможная покупка)**:
  - Две более старые свечи (`SignalBar + 3` и `SignalBar + 2`) медвежьи.
  - Средняя свеча закрывается выше минимума самой ранней свечи.
  - Предыдущая свеча (`SignalBar + 1`) бычья и закрывается выше открытия средней свечи.
- **Медвежий разворот (возможная продажа)**:
  - Условия зеркально повторяют бычий сценарий.

Фильтр объёма полностью повторяет оригинальный индикатор. Если диапазон самой ранней свечи (переведённый в шаги цены) превышает `MaxBarSize` либо `VolumeFilter` установлен в `None`, фильтр пропускается. В остальных случаях выполняется одно из условий: `объём самой ранней свечи < объёма средней` **ИЛИ** `объём последней свечи > объёма средней` **ИЛИ** `объём последней свечи > объёма самой ранней`. В StockSharp для свечей доступен агрегированный объём, поэтому режимы `Tick` и `Real` используют одно и то же поле `TotalVolume`.

## Управление сделками

- При активном `AllowSellExit` бычий сигнал сначала закрывает шорт, затем, если `AllowBuyEntry` разрешён и позиция нулевая, открывает лонг. Параметр `AllowBuyExit` для медвежьего сигнала работает аналогично.
- Новая позиция открывается только при нулевой текущей позиции и разрешённом флаге `Allow*Entry`. Размер заявки определяется стандартными настройками стратегии.
- Стоп-лосс и тейк-профит (`StopLossPips`, `TakeProfitPips`) задаются в шагах цены и контролируются на каждой завершённой свече.
- Для защиты от повторных действий в рамках одной свечи сохраняется время последнего обработанного сигнала.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| -------- | --------------------- | -------- |
| `CandleType` | 4‑часовые свечи | Тип свечей, по которым строится паттерн. |
| `SignalBar` | 1 | Смещение по истории для оценки сигнала (≥ 0). |
| `MaxBarSize` | 300 | Если диапазон самой ранней свечи (в шагах цены) превышает порог, фильтр объёма отключается. Значение 0 полностью отключает фильтр. |
| `VolumeFilter` | `Tick` | Режим работы фильтра (`Tick`, `Real` или `None`). В первых двух случаях используется `TotalVolume`. |
| `AllowBuyEntry` | `true` | Разрешить открытие длинных позиций по бычьему сигналу. |
| `AllowSellEntry` | `true` | Разрешить открытие коротких позиций по медвежьему сигналу. |
| `AllowBuyExit` | `true` | Разрешить закрытие лонгов по медвежьему сигналу. |
| `AllowSellExit` | `true` | Разрешить закрытие шортов по бычьему сигналу. |
| `StopLossPips` | 1000 | Дистанция стоп-лосса в шагах цены (0 — нет стопа). |
| `TakeProfitPips` | 2000 | Дистанция тейк-профита в шагах цены (0 — нет тейк-профита). |

## Особенности переноса

- Модуль управления капиталом из `TradeAlgorithms.mqh` заменён на прямые вызовы `BuyMarket`/`SellMarket`, поэтому объём позиций определяется настройками StockSharp.
- Сигнал формируется на свече с заданным смещением `SignalBar`, как и в оригинале; время последнего сигнала используется для предотвращения повторной обработки.
- Функции звуковых, почтовых и push-уведомлений из индикатора не портировались.
- Настройки `Tick` и `Real` сохранены ради совместимости, но фактически используют одинаковый объём из свечи.
- Комментарии и документация переведены на английский язык во всех кодовых файлах, согласно правилам репозитория.

Стратегия воспроизводит поведение оригинала и при этом полностью укладывается в высокоуровневую модель подписки StockSharp.
