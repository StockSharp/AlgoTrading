# Стратегия MA Crossover Multi Timeframe

Стратегия повторяет идею оригинального советника **MA Crossover** для MetaTrader 4. Сравниваются две скользящие средние, которые могут строиться по разным таймфреймам. Пересечение быстрый MA выше медленного открывает длинную позицию, пересечение вниз – короткую. Дополнительные фильтры управляют допустимым направлением торговли, торговым расписанием и защитой по просадке. Стоп-лосс, тейк-профит и трейлинг реализованы "скрыто", как и в версии MQL.

## Логика работы

1. Подписка на два потока свечей (текущий и предыдущий таймфреймы) и расчёт выбранного типа скользящих средних.
2. Применение настроенных сдвигов по количеству завершённых баров перед сравнением значений.
3. Игнорирование незавершённых свечей и ожидание формирования обоих индикаторов.
4. Пропуск торговли вне заданного окна по дням и времени или при срабатывании защиты по equity.
5. При бычьем пересечении:
   - Опционально закрыть короткую позицию, если `ClosePositionsOnCross = true`.
   - Открыть длинную позицию, если разрешена торговля в лонг.
6. При медвежьем пересечении:
   - Опционально закрыть длинную позицию, если `ClosePositionsOnCross = true`.
   - Открыть короткую позицию, если разрешена торговля в шорт.
7. Управление открытой позицией с помощью стоп-лосса, тейк-профита и трейлинга, заданных в процентах от цены входа.

## Параметры

| Параметр | Описание |
|----------|----------|
| `AllowedDirection` | Ограничение направления торговли (`LongOnly`, `ShortOnly`, `LongAndShort`). |
| `ClosePositionsOnCross` | Закрывать противоположную позицию при новом пересечении. |
| `MaType` | Тип вычисления скользящей средней (`Simple`, `Exponential`, `Smoothed`, `Weighted`). |
| `CurrentMaPeriod` | Период быстрой скользящей. |
| `PreviousPeriodAddition` | Добавка к периоду медленной скользящей (`PreviousMaPeriod = CurrentMaPeriod + addition`). |
| `CurrentShift` / `PreviousShift` | Сдвиг значений скользящих по числу завершённых баров. |
| `CurrentCandleType` / `PreviousCandleType` | Свечные данные для расчёта быстрой и медленной скользящих. |
| `StopLossPercent` | Размер стоп-лосса в процентах от цены входа (скрытое закрытие). |
| `TrailingStopPercent` | Процент трейлинга, рассчитываемый от лучшей достигнутой цены. |
| `TakeProfitPercent` | Размер тейк-профита в процентах от цены входа (скрытое закрытие). |
| `StartDay` / `EndDay` | Фильтр по дням недели. |
| `StartTime` / `EndTime` | Временное окно внутри дня для открытия новых сделок. |
| `ClosePositionsOnMinEquity` | Закрывать позиции при срабатывании защиты по equity. |
| `MinimumEquityPercent` | Минимально допустимый процент от стартовой стоимости портфеля. |

## Управление рисками

- Стоп-лосс, тейк-профит и трейлинг рассчитываются внутри стратегии и исполняются рыночными заявками, что повторяет скрытую защиту из MQL-версии.
- `MinimumEquityPercent` фиксирует первоначальную стоимость портфеля и может вынудить закрыть все позиции при падении equity ниже порога.
- Размер позиции задаётся свойством `Strategy.Volume`. По умолчанию объём равен `1`.

## Практические рекомендации

- Необходимо обеспечить поставку свечей для обоих выбранных таймфреймов.
- Даже при совпадении таймфреймов стратегия создаёт две подписки для симметричной обработки сигналов.
- Защитные заявки не выставляются в стакан, так как выходы исполняются рыночными приказами.
- Параметры соответствуют ключевым настройкам советника в MQL; функции усреднения и хеджирования не перенесены из-за особенностей API StockSharp.

## Отличия от исходного MQL-кода

- Не реализованы опции усреднения (`Average_Up`, `Average_Down`) и хеджирование.
- Защита по equity основана на значении портфеля в StockSharp, а не на свободной марже брокера.
- Выходы по риску выполняются на закрытии свечи рыночными приказами и не видны в заявках.

