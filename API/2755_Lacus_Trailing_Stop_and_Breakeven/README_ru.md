# Диспетчер стопов Lacus Trailing Stop & Breakeven

## Обзор
Стратегия представляет собой порт советника **LacusTstopandBE.mq5** для MetaTrader. Она **не** открывает сделки самостоятельно, а лишь управляет уже существующей неттинговой позицией. Основные функции:

- установка стоп-лосса и тейк-профита (или их скрытая эмуляция в режиме stealth),
- перенос стопа в безубыток после достижения заданного профита,
- подтягивание стопа при дальнейшем росте прибыли,
- закрытие позиции при достижении индивидуальной цели по прибыли,
- закрытие позиции при достижении глобальных целей по прибыли (в валюте или в процентах от капитала).

Используется высокоуровневый API StockSharp (`SubscribeCandles`). Заказы на защитные уровни отправляются только если отключён stealth-режим.

## Логика работы
1. **Первичная защита** – при появлении новой позиции рассчитываются уровни SL/TP в пунктах и выставляются защитные ордера (или запоминаются для stealth-режима).
2. **Безубыток** – после прохождения `BreakevenGainPips` стоп переносится на цену входа ± `BreakevenLockPips` (если захват меньше триггера).
3. **Трейлинг** – когда цена прошла `TrailingStartPips`, стоп следует за ценой на расстоянии `TrailingStopPips` и никогда не откатывается назад.
4. **Stealth-режим** – уровни SL/TP контролируются на закрытии каждой свечи, и позиция закрывается вручную при достижении целевых цен.
5. **Цели по прибыли** –
   - `PositionProfitTarget` закрывает позицию при достижении заданной денежной прибыли;
   - `ProfitAmount` закрывает позицию при превышении суммарного PnL стратегии;
   - `PercentOfBalance` закрывает позицию при росте текущей стоимости портфеля на заданный процент от стартового значения.

## Параметры
| Параметр | Описание | Значение по умолчанию | Примечания |
|----------|----------|-----------------------|------------|
| `StopLossPips` | Расстояние стоп-лосса в пунктах. | 40 | Умножается на `Security.PriceStep`. |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах. | 200 | Умножается на `Security.PriceStep`. |
| `TrailingStartPips` | Профит для включения трейлинга. | 30 | 0 отключает трейлинг. |
| `TrailingStopPips` | Дистанция трейлинга. | 20 | Работает совместно с `TrailingStartPips`. |
| `BreakevenGainPips` | Профит для переноса в безубыток. | 25 | Должен быть больше `BreakevenLockPips`. |
| `BreakevenLockPips` | Пункты, фиксируемые в прибыли. | 10 | 0 переносит стоп прямо в точку входа. |
| `PositionProfitTarget` | Денежная цель по позиции. | 4 | Используется mark-to-market PnL. |
| `ProfitAmount` | Денежная цель по всей стратегии. | 12 | Основана на `Strategy.PnL`. |
| `PercentOfBalance` | Процент роста капитала для закрытия. | 1 | Используется `Portfolio.CurrentValue`. |
| `UseStealthStops` | Эмуляция SL/TP без ордеров. | `false` | Проверка выполняется на закрытии свечи. |
| `CandleType` | Тип свечей для анализа. | Минутные свечи | Можно настроить нужный таймфрейм. |

## Важные замечания
- Предполагается неттинговый счёт. Для хеджинговых счетов потребуется адаптация.
- В stealth-режиме реакция возможна только на закрытии свечи – выбирайте достаточно мелкий интервал.
- Для глобальных целей по прибыли необходимо, чтобы адаптер предоставлял `Portfolio.CurrentValue`.
- Комиссии и свопы из оригинального MQL-советника недоступны – используется чистый mark-to-market PnL.
- Для корректной работы убедитесь, что объём стратегии соответствует уже открытой позиции перед стартом.

## Особенности конвертации
- Функции MQL (`SetSLTP`, `Movebreakeven`, `TrailingStop`, `CloseOnProfit`, `CloseAll`, `CloseonStealthSLTP`) реализованы отдельными методами C#.
- Конвертация пунктов в цену выполняется через `Security.PriceStep`, аналогично `SymbolInfo.Point()`.
- Проверки прибыли счёта через `AccountInfo` заменены на `Strategy.PnL` и изменение стоимости портфеля.
- Магические номера в StockSharp не нужны и поэтому исключены.
- Все комментарии переведены на английский язык согласно требованиям.
