# Pendulum 策略
[English](README.md) | [Русский](README_ru.md)

一个以网格和马丁格尔为核心的“钟摆”系统。价格触及上方阈值时建立多头，跌回下方阈值时反向加倍做空。策略最多叠加若干层，每当方向反转就放大头寸和止盈目标，同时缩小新的防守区间，以复刻原始 Pendulum 专家的节奏。获利离场后会在同一价格计划新的入场，让钟摆运动得以持续。

## 细节

- **入场逻辑**
  - 使用 `StepSize` 将网格对齐到当前收盘价。
  - **触及上轨** → 以基础手数做多。
  - **触及下轨** → 以基础手数做空。
  - 当持仓移动到相反触发点时立即反向，并将净头寸乘以 `Multiplier`，同时按 MQL 版本的规则重新计算止盈与止损。
  - 盈利平仓后会登记一次延迟入场，只要上一笔交易完全结算，下一根 K 线就会在同一价位重新开仓。
- **离场逻辑**
  - 第一个层级的止盈距离为一个步长；后续层级的止盈距离为 `Multiplier` 个步长。
  - 防守距离遵循原版：首层使用较宽的止损 (`StepSize * Multiplier`)，之后的层级使用一个步长的保护位。
  - 达到 `MaxLayers` 后不再增加新层，等待止盈或止损触发后重新开始。
- **仓位管理**
  - 采用净头寸模式：StockSharp 端通过平仓再反向的方式模拟原策略的对冲网格，使其兼容净额结算的投资组合。
  - 如交易所提供手数步长，会将下单数量四舍五入到最近的有效手数。
- **数据来源**
  - 默认订阅 1 分钟蜡烛，但可以切换到任意支持的时间框架。网格判断基于蜡烛收盘价。
- **安全措施**
  - 调用 `StartProtection()`，在断线或手动干预后帮助清理遗留头寸。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `StepSize` | `0.001` | 网格间距，所有价格都会对齐到该步长的倍数。 |
| `Multiplier` | `2` | 每次反向时同时放大仓位与止盈距离，必须大于 1。 |
| `MaxLayers` | `3` | 最多叠加的层数，到达上限后只等待止盈或止损。 |
| `BaseVolume` | `1` | 第一层的基础手数，后续层级会乘以 `Multiplier`。 |
| `CandleType` | `1 Minute TimeFrame` | 订阅的蜡烛类型，可自由调整。 |

## 说明

- 该实现复刻了 `Pendulum.mq5` 的逻辑，但不使用同时持有的多空头寸，而是通过净仓反转来实现等效的风险敞口。
- 当止盈成交时会记录下一次入场的方向与价格，等待上一笔订单完全执行后立即重开。
- 请确保 `StepSize` 与标的的最小报价单位匹配，以减少对网格位置的额外四舍五入。
