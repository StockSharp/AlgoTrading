# Стратегия «Get Last Nth Close Trade»

## Общее описание
Стратегия **Get Last Nth Close Trade** переносит функциональность эксперта MetaTrader 4 `Get_Last_Nth_Close_Trade.mq4`. Оригинальный советник постоянно просматривает историю сделок, сортирует закрытые ордера по времени закрытия и выводит параметры *n*-й сделки, отсчитанной от самой свежей. Версия на C# использует высокоуровневый API StockSharp и повторяет этот алгоритм в управляемой среде.

Стратегия отслеживает все ордера, размещённые текущим экземпляром, фиксирует те, что перешли в состояние `Done`, сортирует их по времени закрытия в порядке убывания и публикует подробности сделки с заданным индексом. Если ни одна закрытая сделка не удовлетворяет выбранным фильтрам, в журнал добавляется поясняющее сообщение.

## Соответствие оригиналу
| Концепция MetaTrader 4 | Реализация в StockSharp |
| --- | --- |
| `OrdersHistoryTotal` и ручной перебор | Подписка на изменения ордеров и внутренний список закрытых ордеров. |
| Фильтр по символу (`ENABLE_SYMBOL_FILTER`) | При включении учитываются только ордера по `Strategy.Security`. |
| Фильтр по магическому номеру (`ENABLE_MAGIC_NUMBER`) | При включении числовой комментарий ордера сравнивается с параметром Magic Number. |
| Сортировка по `OrderCloseTime` | Сохраняется время последнего изменения и выполняется сортировка по убыванию. |
| Вызов `Comment()` с многострочным текстом | Используется `AddInfo` для вывода форматированного сообщения в лог стратегии. |

## Параметры
- **Enable Magic Number** – включает/выключает фильтр по магическому номеру, который считывается из комментария ордера.
- **Enable Symbol Filter** – ограничивает выборку ордерами по базовому инструменту стратегии.
- **Magic Number** – значение, с которым сравнивается числовой комментарий, если фильтр активен.
- **Trade Index** – нулевой индекс сделки относительно самой последней закрытой (0 – последняя, 1 – предпоследняя и т.д.).

Параметры оформлены через `StrategyParam<T>`, поэтому поддерживают оптимизацию.

## Вывод информации
При каждом изменении списка закрытых ордеров, а также при его пустом состоянии, стратегия публикует сообщение, повторяющее формат оригинального эксперта:

```
ticket 123456
symbol EURUSD@FXCM
lots 1
openPrice 1.2345
closePrice 1.2350
stopLoss 0
takeProfit 0
comment 1234
type Market
orderOpenTime 2024-03-01T10:15:00+00:00
orderCloseTime 2024-03-01T11:00:00+00:00
profit 0.0005
```

Запись обновляется только при изменении содержимого, что предотвращает засорение журнала.

## Ограничения
- В StockSharp нет отдельного поля для «магического номера», поэтому предполагается, что идентификатор передаётся в комментарии ордера и содержит только цифры.
- Значения прибыли, стоп-лосса и тейк-профита зависят от данных, которые предоставляет коннектор. При отсутствии информации поля остаются равными нулю.
- Стратегия анализирует только ордера, созданные после запуска. Исторические сделки, совершённые ранее, недоступны.

## Рекомендации по использованию
1. Настройте инструмент и портфель, затем запустите стратегию обычным способом.
2. Для работы фильтра по магическому номеру убедитесь, что комментарий ордера содержит целое число, совпадающее с параметром **Magic Number**.
3. Изменяйте **Trade Index**, чтобы выбрать сделку по количеству шагов от последнего закрытого ордера.
4. Следите за журналом стратегии, где появятся многострочные сообщения с подробностями сделки.

## Состав каталога
- `CS/GetLastNthCloseTradeStrategy.cs` – исходный код стратегии.
- `README.md` – документация на английском языке.
- `README_cn.md` – версия на китайском языке.
- `README_ru.md` – текущий файл с описанием на русском.

