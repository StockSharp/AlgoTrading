# Стратегия Percentage Crossover Channel System
[English](README.md) | [中文](README_cn.md)

Стратегия является прямой конверсией MetaTrader-советника *Exp_PercentageCrossoverChannel_System*. Она отслеживает, как цена взаимодействует с пользовательским индикатором «Percentage Crossover Channel», и реагирует, когда свечи после пробоя возвращаются внутрь канала. Логика полностью перенесена на высокоуровневый API StockSharp.

## Логика торговли

1. **Построение индикатора**
   - Индикатор формирует адаптивную среднюю линию, которая следует за ценой и не может удаляться быстрее, чем на заданный процент (`Percent`).
   - Верхняя и нижняя границы вычисляются от средней линии на ту же величину в процентах.
   - Каждая завершённая свеча получает цвет в зависимости от положения относительно канала `Shift` баров назад:
     - Цвет `3` / `4`: закрытие выше верхней границы (медвежье/бычье тело соответственно).
     - Цвет `0` / `1`: закрытие ниже нижней границы (медвежье/бычье тело соответственно).
     - Цвет `2`: свеча завершилась внутри канала.

2. **Правила входа и выхода**
   - Анализируются последняя свеча сдвига `SignalBar` и предыдущая (аналогично вызову `CopyBuffer` в MQL).
   - **Бычья последовательность** (`olderColor > 2`): рынок недавно закрылся выше канала. Если свежая свеча вернулась внутрь (`recentColor < 3`), стратегия:
     - Закрывает все короткие позиции при включённом параметре `SellPositionsClose`.
     - Открывает длинную позицию при отсутствии сделок и разрешённом `BuyPositionsOpen`.
   - **Медвежья последовательность** (`olderColor < 2`): рынок закрылся ниже канала. Если последняя свеча вернулась внутрь (`recentColor > 1`), стратегия:
     - Закрывает длинные позиции при активном `BuyPositionsClose`.
     - Открывает короткую позицию при пустом портфеле и включённом `SellPositionsOpen`.
   - Таким образом, вход выполняется после пробоя и обратного возврата в канал в сторону исходного импульса.

3. **Управление рисками**
   - Дополнительные стоп-лосс и тейк-профит задаются в шагах цены и проверяются по максимумам/минимумам свечей.
   - При срабатывании защитного приказа стратегия выходит из позиции и игнорирует новые сигналы в пределах текущей свечи, повторяя поведение оригинального советника, где стопы исполняются на стороне брокера.

## Параметры

| Параметр | Описание |
| -------- | -------- |
| `Percent` | Ширина канала в процентах — полностью соответствует входу индикатора в MQL. |
| `Shift` | Количество баров для сравнения с историческими границами канала. |
| `SignalBar` | Сдвиг по барам для оценки цветов. Значение 1 означает «предыдущий бар», как в исходном советнике. |
| `BuyPositionsOpen` / `SellPositionsOpen` | Разрешение открытия длинных/коротких позиций. |
| `BuyPositionsClose` / `SellPositionsClose` | Разрешение принудительного закрытия противоположных позиций при новом сигнале. |
| `StopLoss` | Размер стоп-лосса в шагах цены (`Security.PriceStep`). Ноль отключает защиту. |
| `TakeProfit` | Размер тейк-профита в шагах цены. Ноль отключает цель. |
| `CandleType` | Тип свечей (таймфрейм). По умолчанию — четырёхчасовые свечи (`PERIOD_H4`). |

## Особенности реализации

- Логика индикатора реализована внутри стратегии, поскольку в StockSharp отсутствует готовый Percentage Crossover Channel. Расчёт средней линии, границ и цветов полностью повторяет код из MQL.
- Управление позициями копирует функции `BuyPositionOpen`, `SellPositionOpen` и т. д.: сначала закрываются противоположные сделки, затем открывается новая, и вход пропускается, если активна обратная позиция.
- Модуль управления капиталом, параметр `Deviation` и расчёт лота по режимам маржи из файла `TradeAlgorithms.mqh` не перенесены. Объём заявок задаётся стандартными свойствами `Strategy` или инфраструктурой StockSharp.
- Значения стопа и тейка трактуются как количество шагов цены, что соответствует «пунктам» в MetaTrader. Необходимо, чтобы у инструмента был корректно задан `PriceStep`.

## Рекомендации по использованию

- Для воспроизведения поведения MetaTrader подключайте стратегию к инструментам с качественными четырёхчасовыми данными. При необходимости измените `CandleType` для внутридневной работы.
- Поскольку для расчёта сигналов нужны две завершённые свечи с корректными цветами, обеспечьте наличие истории минимум `Shift + SignalBar + 1` баров.
- Изменение `Percent` сильно влияет на чувствительность канала: маленькие значения приводят к частым сделкам, большие — фильтруют только сильные пробои.
- Стратегия оперирует одной позицией: возможны только состояния «лонг», «пусто» или «шорт». Планируйте управление риском портфеля с учётом этого.

