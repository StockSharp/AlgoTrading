# 止损止盈策略
[English](README.md) | [Русский](README_ru.md)

本策略为 MetaTrader “Stop Loss Take Profit” 专家的移植版本。每当账户没有持仓时，就抛掷一次“硬币”随机决定方向，并以市价单入场。成交后立即按照设定的点数(pip)放置止损和止盈订单。如果触发止损，下一笔交易的手数会加倍（同时受证券最大手数限制）；若触发止盈，则手数恢复为初始值。整个过程沿用了原策略的马丁格尔风格，并基于 StockSharp 的高级 API 实现。

## 交易逻辑

- **行情数据**：通过参数 `CandleType`（默认 1 分钟 K 线）驱动信号。
- **入场条件**：
  - 当 `Position == 0` 且没有挂单时，生成一个伪随机布尔值。
  - `true` 使用 `BuyMarket(volume)` 做多，`false` 使用 `SellMarket(volume)` 做空。
- **出场条件**：
  - 收到成交后立即提交止损和止盈委托。
  - 止损触发会将下一笔交易的手数翻倍，止盈触发则把手数重置为初始值。
  - 将止损或止盈距离设为 `0` 可以关闭相应的保护委托。
- **仓位管理**：
  - `InitialVolume` 定义初始下单手数。
  - 亏损后手数翻倍，但会根据 `Security.MaxVolume` 自动截断，保证不超过交易所限制。
  - 手数会按照 `VolumeStep`、`MinVolume`、`MaxVolume` 进行标准化，避免被交易所拒单。
- **Pip 处理**：
  - 默认根据证券的 `PriceStep` 与 `Decimals` 推算 pip（例如五位报价的外汇会得到 0.0001）。
  - 参数 `PipSize` 大于 0 时，可手动指定 pip 的绝对价格大小。

## 参数

| 名称 | 默认值 | 说明 |
| ---- | ------ | ---- |
| `CandleType` | 1 分钟 K 线 | 触发随机信号所使用的时间周期。 |
| `StopLossPips` | 1 | 止损距离（以 pip 为单位），设为 `0` 表示不下止损单。 |
| `TakeProfitPips` | 1 | 止盈距离（以 pip 为单位），设为 `0` 表示不下止盈单。 |
| `InitialVolume` | 0.01 | 初始下单手数。止损后翻倍，止盈后恢复。 |
| `PipSize` | 0（自动） | 可选的 pip 大小覆盖值，使用绝对价格单位。 |

## 使用提示

- 同时支持做多和做空，方向完全由随机逻辑决定。
- 头寸归零时会取消所有剩余的保护委托，避免遗留单子。
- 随机数生成器使用 `Environment.TickCount` 作为种子，因此每次启动都会得到不同的交易序列。
- 更适合作为风险管理与马丁格尔行为的演示案例，实盘使用前建议叠加额外的过滤器与风险控制。
