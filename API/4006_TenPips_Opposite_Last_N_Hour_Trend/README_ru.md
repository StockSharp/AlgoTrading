# Стратегия Ten Pips Opposite Last N Hour Trend

## Общее описание

Стратегия является переносом эксперта MetaTrader **10pipsOnceADayOppositeLastNHourTrend**. Она торгует ровно один раз в сутки в заранее заданный час и сознательно открывает позицию **против** движения цены за последние *N* завершённых часовых свечей. Логика рассчитана на валютные пары с пятизначными котировками, однако версия для StockSharp автоматически рассчитывает размер пункта на основании свойств инструмента (`PriceStep` и количество знаков после запятой).

В момент наступления торгового часа стратегия сравнивает цену закрытия `HoursToCheckTrend` часов назад с ценой закрытия последней законченной часовой свечи:

- Если более старая цена **выше**, значит рынок снижался, и открывается **покупка**.
- В противном случае рынок рос, и открывается **продажа**.

Выход из позиции осуществляется по защитным стопам, по ограничению времени удержания или при выходе цены за разрешённое торговое окно.

## Управление объёмом

Модель управления капиталом повторяет мартингейл-лесенку оригинального эксперта:

1. Базовый объём задаётся параметром `FixedVolume`. Если он равен нулю, используется расчёт `Portfolio.CurrentValue * MaximumRisk / 1000` с округлением до одной десятой лота.
2. Полученный объём ограничивается параметрами `MinimumVolume`, `MaximumVolume`, лимитами биржи по инструменту и дополнительной планкой `Portfolio.CurrentValue / 1000` лотов.
3. После закрытия сделки её результат попадает в буфер (до пяти последних значений). При следующем входе стратегия просматривает этот буфер и умножает объём при первом найденном убытке, используя последовательность `FirstMultiplier` … `FifthMultiplier`. Это полностью повторяет вложенные `OrderSelect` из MQL.

## Управление рисками

- `StopLossPips`, `TakeProfitPips` и `TrailingStopPips` задаются в пунктах. Размер пункта вычисляется с учётом шага цены и количества знаков (для трёх и пяти знаков используется множитель ×10).
- Трейлинг-стоп реализован симметрично для длинных и коротких позиций. В исходном коде МТ4 из-за знаковой ошибки трейлинг для шортов не срабатывал; в порте баг исправлен.
- `OrderMaxAge` закрывает позицию, если она удерживается дольше заданного времени (по умолчанию 21 час).
- Вне разрешённого торгового часа стратегия принудительно закрывает все позиции и ждёт следующего сигнала.
- `MaxOrders` не допускает повторного входа, пока открыта позиция или активны заявки.

## Подробный алгоритм

1. Подписка на свечи выбранного таймфрейма (по умолчанию 1 час, параметр `CandleType`).
2. Сохранение цены закрытия каждой завершённой свечи в компактном буфере.
3. При первой завершённой свече в разрешённый час:
   - Проверка соединения и отсутствия позиций.
   - Контроль, что имеется минимум `HoursToCheckTrend` исторических свечей.
   - Определение направления по разнице текущего закрытия и закрытия `HoursToCheckTrend` часов назад.
   - Расчёт объёма с учётом мартингейла и отправка рыночной заявки.
4. Пока позиция открыта:
   - Проверка срабатывания стоп-лосса, тейк-профита и трейлинг-стопа по максимуму/минимуму свечи.
   - Обновление уровня трейлинг-стопа при новых максимумах/минимумах.
   - Отслеживание времени входа для контроля `OrderMaxAge`.
   - Фиксация результата закрытой сделки для будущих умножений объёма.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `FixedVolume` | Фиксированный объём. `0` включает расчёт от риска. | `0.1` |
| `MinimumVolume` | Минимально допустимый объём заявки. | `0.1` |
| `MaximumVolume` | Максимально допустимый объём заявки. | `5` |
| `MaximumRisk` | Доля капитала при `FixedVolume = 0`. | `0.05` |
| `MaxOrders` | Максимум одновременно открытых позиций/заявок. | `1` |
| `TradingHour` | Час (0–23), в который допускаются входы. | `7` |
| `HoursToCheckTrend` | Глубина истории в часах для определения направления. | `30` |
| `OrderMaxAge` | Предельное время удержания позиции. | `21 ч` |
| `StopLossPips` | Дистанция стоп-лосса в пунктах. | `50` |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | `10` |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах. | `0` (выключен) |
| `FirstMultiplier` … `FifthMultiplier` | Множители объёма при убытке на соответствующей глубине истории. | `4`, `2`, `5`, `5`, `1` |
| `CandleType` | Таймфрейм свечей для расчётов. | `1 час` |

## Отличия от MQL-версии

- Мартингейл, ограничение по времени и торговое окно реализованы идентично оригиналу. Единственное осознанное изменение — исправленный трейлинг-стоп для коротких позиций.
- Защитные уровни исполняются рыночными заявками при появлении следующей завершённой свечи. Это соответствует поведению MT4-эксперта в момент срабатывания стоп-заявок.
- Для оценки капитала используется `Portfolio.CurrentValue`. Если адаптер не предоставляет это значение, берётся базовый `Volume` стратегии (по умолчанию `1`).
- Массив торговых часов соответствует диапазону `0…23`. Для ограничения торговли по дням недели можно изменить список `_tradingDayHours` в конструкторе.

## Рекомендации по применению

- Наиболее корректно стратегия работает на форекс-инструментах с часовыми свечами.
- Убедитесь, что у инструмента заданы `VolumeStep`, `VolumeMin` и `VolumeMax`, иначе корректировка объёма может оказаться невозможной.
- Запускайте стратегию заранее до наступления торгового часа, чтобы не пропустить единственный сигнал за день.

