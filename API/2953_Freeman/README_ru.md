# Стратегия Freeman
[English](README.md) | [中文](README_cn.md)

Freeman — внутридневная стратегия, комбинирующая несколько индикаторных фильтров для поэтапного входа в тенденцию. На рабочем таймфрейме используются две «RSI-школы», построенные на разных периодах скользящих средних, а тренд подтверждается фильтром с более высокого таймфрейма. Риски контролируются ATR-ориентированными уровнями стоп-лосса и тейк-профита, а также трейлинг-стопом в пунктах.

## Общая информация

- Работает на свечах таймфрейма, выбранного параметром `CandleType` (по умолчанию 15 минут).
- Для фильтрации тренда подключается отдельный поток свечей (`FilterCandleType`), по умолчанию — часовой.
- Сигналы формируются двумя блоками RSI, которые сравнивают текущее и предыдущее значения и анализируют наклон скользящих средних.
- Допускается наращивание позиции при движении цены, причём после убыточного выхода объём следующей заявки увеличивается по коэффициенту.

## Логика входов

### Длинные позиции

1. Трендовый фильтр опционален. При его включении часовая скользящая средняя должна расти.
2. RSI Teacher #1 активен, когда:
   - RSI #1 на предыдущей свече был ниже `RsiSellLevel`, а на текущей начинает расти.
   - Быстрая скользящая средняя увеличивается.
   - Часовой RSI (период 14) остаётся ниже `RsiBuyLevel`, подтверждая отсутствие перекупленности.
3. RSI Teacher #2 активен, когда:
   - RSI #2 был ниже `RsiSellLevel2` и поворачивает вверх.
   - Медленная скользящая средняя растёт.
   - Часовой RSI остаётся ниже `RsiBuyLevel2`.
4. Лонг открывается, если активен хотя бы один блок и трендовый фильтр (если включён) подтверждает направление.
5. Дополнительные покупки допускаются, когда цена прошла от последнего входа больше, чем `DistancePips`, умноженное на шаг цены инструмента. Если предыдущий выход по лонгу был убыточным, объём умножается на `LockCoefficient`.

### Короткие позиции

Условия зеркальны длинным позициям:

- При включённом фильтре часовая скользящая средняя должна снижаться.
- RSI Teacher #1 требует, чтобы RSI #1 был выше `RsiBuyLevel` и начал снижаться, быстрая SMA падала, а часовой RSI был выше `RsiSellLevel`.
- RSI Teacher #2 требует, чтобы RSI #2 был выше `RsiBuyLevel2` и развернулся вниз, медленная SMA падала, а часовой RSI был выше `RsiSellLevel2`.
- Правила по дистанции и коэффициенту для докупок аналогичны.

## Управление позицией

- Стоп-лосс и тейк-профит рассчитываются при каждом входе на основе текущего ATR и коэффициентов `StopLossAtrFactor` и `TakeProfitAtrFactor`.
- Трейлинг-стоп включается после прохождения ценой расстояния `TrailingStopPips + TrailingStepPips` и удерживает стоп на расстоянии `TrailingStopPips` от последнего закрытия.
- Выходы осуществляются рыночными заявками, как только минимум/максимум свечи пробивает рассчитанные уровни стопа или цели.
- Параметр `PositionsMaximum` ограничивает суммарное количество совершённых входов (лонг + шорт). Значение 0 снимает ограничение.

## Временные фильтры

- Торговлю по пятницам можно отключить параметром `TradeOnFriday`.
- `StartHour` и `EndHour` задают опциональное торговое окно во времени биржи; нули означают торговлю в течение всего дня.

## Параметры

| Имя | Описание |
| --- | --- |
| `CandleType` | Таймфрейм рабочих свечей для расчёта сигналов. |
| `FilterCandleType` | Таймфрейм фильтра тренда и часового RSI (по умолчанию 1 час). |
| `FirstMaPeriod` / `SecondMaPeriod` | Периоды быстрых и медленных скользящих средних. |
| `FilterMaPeriod` | Длина скользящей средней на фильтрующем таймфрейме. |
| `MaType` | Тип скользящих (SMA, EMA, SMMA или WMA). |
| `RsiFirstPeriod` / `RsiSecondPeriod` | Периоды RSI в блоках Teacher #1 и Teacher #2. |
| `RsiSellLevel`, `RsiBuyLevel`, `RsiSellLevel2`, `RsiBuyLevel2` | Граничные значения RSI для активации блоков. |
| `UseRsiTeacher1`, `UseRsiTeacher2`, `UseTrendFilter` | Переключатели компонентов стратегии. |
| `StopLossAtrFactor`, `TakeProfitAtrFactor` | Коэффициенты ATR для стоп-лосса и тейк-профита. |
| `TrailingStopPips`, `TrailingStepPips` | Настройки трейлинг-стопа в пунктах. |
| `PositionsMaximum` | Лимит на количество входов; 0 — без ограничения. |
| `DistancePips` | Минимальная дистанция (в пунктах) для добавления к позиции. |
| `TradeOnFriday` | Разрешить или запретить торговлю по пятницам. |
| `StartHour`, `EndHour` | Торговый интервал по времени биржи. |
| `LockCoefficient` | Коэффициент увеличения объёма после убыточного выхода. |
| `SignalShift` | Смещение при чтении значений индикаторов (0 — текущая закрытая свеча). |

## Особенности реализации

- Перенос на StockSharp обрабатывает только закрытые свечи, что эквивалентно включённому параметру Bars Control в MT5; торговля «на каждом тике» не поддерживается.
- Все расстояния в пунктах пересчитываются через шаг цены инструмента (`PriceStep`).
- Защитные механизмы (стопы, тейки, трейлинг) реализованы через рыночные заявки, поскольку используется высокоуровневый API StockSharp вместо прямой модификации позиций MT5.
- Учёт позиций ведётся агрегированно: после полного закрытия направления флаг убыточности сбрасывается, что соответствует оригинальной логике «локирования».

Перед использованием протестируйте стратегию и настройте управление риском под свой рынок.
