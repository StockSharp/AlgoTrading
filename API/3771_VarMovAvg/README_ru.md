# Стратегия VarMovAvg

## Общее описание
Стратегия VarMovAvg – это конвертация советника MetaTrader 4 `VarMovAvg_v0011`. В ней используется адаптивная скользящая средняя VMA для оценки тренда. Система ожидает двухэтапный откат (бар A и бар B по терминологии оригинала) и после его завершения переворачивает позицию. При открытой сделке применяется плавающий стоп на базе скользящей средней, а при появлении противоположного паттерна выполняется немедленный разворот.

## Логика работы
1. **Адаптивная VMA.** Индикатор `VariableMovingAverage` повторяет формулу MT4:
   - коэффициент эффективности сравнивает текущую цену закрытия с ценой `AmaPeriod` баров назад и делит на сумму абсолютных колебаний;
   - сглаживающий множитель интерполируется между быстрым и медленным периодом и возводится в степень `SmoothingPower` (параметр `G` в исходнике).
2. **Обнаружение сигнала (бар A / бар B).** Для длинных и коротких сделок ведутся отдельные конечные автоматы:
   - *бар A*: цена уходит от VMA минимум на `SignalPipsBarA` пунктов;
   - *бар B*: движение продолжается ещё на `SignalPipsBarB` пунктов, фиксируя экстремум;
   - *вход*: при возврате цены в диапазон `SignalPipsTrade ± EntryPipsDiff` выставляется рыночный ордер (или разворотная сделка).
3. **Трейлинг-стоп и разворот.**
   - Для лонга используется среднее по минимумам, для шорта — по максимумам, с учётом `StopMaShift` и `StopPipsDiff`.
   - Пробой свечой уровня стопа закрывает позицию.
   - При появлении противоположного паттерна совершается единичная сделка объёмом `|Position| + Volume`, что эквивалентно работе советника.

## Параметры
| Параметр | Назначение | Соответствие MT4 |
|----------|------------|------------------|
| `AmaPeriod` | Длина окна VMA. | `prm.vma.periodAMA` |
| `FastPeriod` | Быстрый сглаживающий период. | `prm.vma.nfast` |
| `SlowPeriod` | Медленный сглаживающий период. | `prm.vma.nslow` |
| `SmoothingPower` | Степень для адаптивного коэффициента (`G`). | `prm.vma.G` |
| `SignalPipsBarA` | Минимальное удаление цены для бара A. | `prm.sig.pipsBarA` |
| `SignalPipsBarB` | Дополнительное удаление для бара B. | `prm.sig.pipsBarB` |
| `SignalPipsTrade` | Смещение входной линии от экстремума бара B. | `prm.sig.pipsTrade` |
| `EntryPipsDiff` | Допустимый коридор вокруг входной цены. | `prm.entry.diff` |
| `StopPipsDiff` | Отступ от скользящей для трейлинг-стопа. | `prm.stop.diff` |
| `StopMaPeriod` | Период стоповой скользящей. | `prm.mastop.period` |
| `StopMaShift` | Сдвиг (в барах) стоповой скользящей. | `prm.mastop.shift` |
| `StopMaMethod` | Тип скользящей (`MODE_SMA/EMA/SMMA/LWMA`). | `prm.mastop.method` |
| `CandleType` | Рабочий таймфрейм. | Таймфрейм графика |

> **Перевод в пункты.** Все расстояния в пунктах домножаются на `Security.PriceStep`, если шаг цены настроен. При отсутствии шага значения трактуются как абсолютные цены — аналогично запасному варианту советника.

## Практические замечания
- Расчёт ведётся на закрытых свечах через `SubscribeCandles`; коридор входа имитирует тиковые проверки советника.
- Трейлинг-стоп реализован рыночным выходом при пробое экстремума, что эквивалентно постоянному модифицированию стоп-ордера в MT4.
- Для реализации `StopMaShift` используется очередь значений, поэтому сдвиг 0 означает текущую точку, а положительные значения выбирают прошлые бары.
- После любой сделки оба автомата сбрасываются в нейтральное состояние — полная аналогия `STATUS_TRADE` в MQL.

## Быстрый старт
1. Добавьте стратегию в StockSharp и выберите инструмент с корректно заданным `PriceStep`.
2. Настройте таймфрейм через `CandleType` (советник чаще применялся на M5).
3. Подберите параметры в пунктах и трейлинг под специфику брокера.
4. Запустите стратегию — при формировании паттернов бар A/бар B система будет чередовать длинные и короткие позиции.

## Отличия от оригинала
- Переход на расчёт по закрытым свечам: это упрощает реализацию, но благодаря входному коридору момент входа остаётся близок к MT4.
- Стопы реализованы через рыночные сделки вместо стоп-ордеров, что типично для стратегий StockSharp.
- Индикатор VMA переписан на C#, параметр `dK` исключён как неиспользуемый в исходнике.
