# Стратегия MA MACD Position Averaging v2

## Обзор
**MA MACD Position Averaging v2** — порт MetaTrader-советника Владимира Карпутова. Стратегия сочетает фильтр на основе взвешенной скользящей средней, подтверждение по MACD и модуль усреднения, наращивающий позицию при неблагоприятном движении рынка. Реализация для StockSharp сохраняет исходную последовательность сигналов, рассчитывает индикаторы на закрытых свечах и воспроизводит брокерскую логику (стопы, тейки, трейлинг) в коде.

## Логика торговли
1. **Подготовка индикаторов**
   - Гибкая скользящая средняя строится по выбранному типу свечей и ценовому источнику. Параметр `MaShift` эмулирует MetaTrader-смещение, считывая значения прошлых баров, а `BarOffset` позволяет анализировать текущий или предыдущие бары.
   - Индикатор MACD рассчитывает основную и сигнальную линии по настраиваемым периодам быстрых/медленных EMA и заданному типу цены — полностью повторяя оригинальный советник.
2. **Проверка сигнала**
   - Для покупки обе линии MACD должны быть отрицательными, цена — выше смещённой скользящей средней, а расстояние до неё — не меньше `MaIndentPips` (переведённых в абсолютную цену через размер пункта).
   - Для продажи условия зеркальные: обе линии MACD положительные, цена ниже средней, расстояние до неё превышает `MaIndentPips`.
   - Фильтр `MacdRatio` требует выполнения неравенства `MACD_main / MACD_signal >= MacdRatio` (деление в десятичном формате). 
   - При `ReverseSignals = true` направление ордера инвертируется после прохождения всех фильтров.
3. **Жизненный цикл позиции**
   - При **нулевой позиции** стратегия отправляет рыночный ордер объёмом `OrderVolume` (с учётом шага объёма инструмента) и сразу фиксирует уровни стоп-лосса и тейк-профита согласно `StopLossPips` и `TakeProfitPips`.
   - При **открытой позиции** противоположные сделки не формируются. Возможны два варианта: 
     - аварийное закрытие, если одновременно обнаружены лонги и шорты (контроль как в оригинале),
     - запуск модуля усреднения по направлению текущей позиции.
4. **Модуль усреднения**
   - Для лонгов выбирается открытая нога с минимальной ценой входа, чья плавающая просадка превышает `StepLossPips`. Для шортов — максимальная цена входа среди убыточных ног.
   - Если кандидат найден, отправляется рыночный ордер объёмом `Кандидат × LotCoefficient` (после округления по шагу, минимуму и максимуму объёма), что воспроизводит геометрическую прогрессию из MQL.
   - Новые ноги получают те же уровни стопа и тейка и попадают под действие трейлинг-алгоритма.
5. **Защита позиции**
   - Трейлинг-стоп активируется только если `TrailingStopPips > 0` и `TrailingStepPips > 0`. Для лонгов стоп переносится на `Close - TrailingStopPips`, когда прибыль превышает `TrailingStopPips + TrailingStepPips`; для шортов логика зеркальная.
   - На каждом закрытом баре проверяются условия срабатывания стоп-лосса/тейк-профита. При выполнении условий соответствующая нога закрывается рыночным ордером и удаляется из списка усреднения.

## Параметры
| Параметр | Описание |
| --- | --- |
| **OrderVolume** | Базовый объём первой сделки в серии. |
| **StopLossPips** | Расстояние до стоп-лосса в пунктах (0 — без стопа). |
| **TakeProfitPips** | Расстояние до тейк-профита в пунктах (0 — без тейка). |
| **TrailingStopPips** | Дистанция трейлинг-стопа, используется совместно с `TrailingStepPips`. |
| **TrailingStepPips** | Дополнительный ценовой ход, необходимый для переноса трейлинг-стопа. |
| **StepLossPips** | Минимальная просадка (в пунктах), при которой добавляется новая нога. |
| **LotCoefficient** | Множитель объёма выбранной убыточной ноги при усреднении. |
| **BarOffset** | Сдвиг назад при чтении индикаторов (0 — текущий завершённый бар). |
| **ReverseSignals** | Инвертирует направления сделок, сохраняя фильтры. |
| **MaPeriod** | Период скользящей средней. |
| **MaShift** | Смещение средней вперёд (как в MetaTrader). |
| **MaMethod** | Метод сглаживания (Simple, Exponential, Smoothed, Weighted). |
| **MaPrice** | Тип цены свечи для расчёта средней. |
| **MaIndentPips** | Минимальное расстояние цены от средней перед входом. |
| **MacdFastPeriod** | Быстрый период EMA для MACD. |
| **MacdSlowPeriod** | Медленный период EMA для MACD. |
| **MacdSignalPeriod** | Период сигнальной EMA для MACD. |
| **MacdPrice** | Применяемая цена в расчёте MACD. |
| **MacdRatio** | Минимальное отношение основной и сигнальной линий MACD. |
| **CandleType** | Тип свечей, используемый стратегией. |

## Особенности реализации
- Размер пункта вычисляется из шага цены инструмента с поправкой на 3/5 знаков, как в оригинальном советнике, поэтому все дистанции в пунктах совпадают.
- Для хранения смещённых значений используются очереди, что позволяет имитировать индексы `ma_shift` и `BarOffset` без запрещённых исторических вызовов.
- Корректировка объёма учитывает `Security.VolumeStep`, `Security.MinVolume` и `Security.MaxVolume`, предотвращая ошибки при умножении на `LotCoefficient`.
- Стопы, тейки и трейлинг реализованы на стороне стратегии, без обращения к брокерским методам модификации позиций.
- Класс размещён в пространстве имён `StockSharp.Samples.Strategies`, код отформатирован табуляцией и содержит комментарии только на английском, согласно требованиям репозитория.
