# Стратегия BARS Alligator

Стратегия BARS Alligator является прямым портом одноимённого эксперта MetaTrader. Она использует индикатор Alligator Билла Уильямса
для определения момента «пробуждения» тренда: пересечение зелёной линии Lips выше синей линии Jaw трактуется как зарождение
бычьего импульса, а обратное пересечение сигнализирует о медвежьем движении. Выходы выполняются при пересечении Lips и красной
линии Teeth, чтобы закрывать позицию при ослаблении импульса. Стоп-лосс, тейк-профит и трейлинг-стоп задаются в пунктах и
автоматически переводятся в цену с учётом шага цены инструмента и числа знаков после запятой.

## Логика торговли

1. **Формирование индикаторов**
   - Три скользящих средних с настраиваемыми периодами, смещениями и типом сглаживания (простая, экспоненциальная, сглаженная или
     взвешенная) формируют линии Alligator.
   - В качестве источника цены может использоваться close, open, high, low, медианная, типичная или взвешенная цена свечи.
   - Чтобы сохранить поведение MetaTrader с положительным смещением, для каждой линии ведётся небольшой буфер значений, и сигналы
     рассчитываются по тем же точкам, что отображались бы на графике.
2. **Условия входа**
   - **Лонг**: на предыдущей свече Lips находится выше Jaw, а на позапрошлой — ниже (бычий крест вверх).
   - **Шорт**: на предыдущей свече Lips ниже Jaw, а на позапрошлой — выше (медвежий крест вниз).
   - Новые заявки разрешены только при отсутствии позиции или при совпадении направления сигнала с текущей позицией. Суммарный
     объём не должен превышать `MaxPositions × OrderVolume` (или рассчитанный по риску эквивалент).
3. **Условия выхода**
   - **Лонг**: Lips пересекает Teeth сверху вниз, и позиция остаётся прибыльной относительно средневзвешенной цены входа.
   - **Шорт**: Lips пересекает Teeth снизу вверх, и позиция находится в прибыли.
   - Дополнительно выполняется закрытие при срабатывании заданных стоп-лоссов и тейк-профитов.
4. **Трейлинг-стоп**
   - При включении стоп переносится, как только прибыль превышает `TrailingStopPips + TrailingStepPips`. Новый стоп удерживается на
     расстоянии `TrailingStopPips` пунктов от текущей цены и продвигается дальше только при новом движении минимум на `TrailingStepPips`.
5. **Управление капиталом**
   - В режиме `FixedVolume` сделки выставляются объёмом `OrderVolume`.
   - В режиме `RiskPercent` объём рассчитывается так, чтобы при срабатывании стоп-лосса потери составили `MoneyValue` процентов от
     стоимости портфеля. Риск на единицу равен стоп-дистанции в ценовых единицах; итог округляется вниз к ближайшему шагу объёма
     (или к 1, если шаг неизвестен).

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `CandleType` | `DataType` | `TimeSpan.FromHours(1).TimeFrame()` | Таймфрейм, используемый для расчётов. |
| `OrderVolume` | `decimal` | `0.1` | Фиксированный объём сделки в режиме `FixedVolume`. |
| `MoneyMode` | `MoneyManagementMode` | `FixedVolume` | Выбор между фиксированным объёмом и расчётом по риску. |
| `MoneyValue` | `decimal` | `1` | Процент риска при `MoneyMode = RiskPercent`; в фиксированном режиме игнорируется. |
| `MaxPositions` | `int` | `1` | Максимальное число добавочных входов в одном направлении (в кратных рассчитанному объёму единицах). |
| `StopLossPips` | `int` | `150` | Расстояние до стоп-лосса в пунктах. Ноль отключает стоп. |
| `TakeProfitPips` | `int` | `150` | Расстояние до тейк-профита. Ноль отключает цель. |
| `TrailingStopPips` | `int` | `5` | Дистанция трейлинг-стопа. Ноль отключает сопровождение. |
| `TrailingStepPips` | `int` | `5` | Минимальный дополнительный ход цены перед переносом трейлинга; должен быть > 0 при активном трейлинге. |
| `JawPeriod` | `int` | `13` | Период линии Jaw. |
| `JawShift` | `int` | `8` | Сдвиг линии Jaw вперёд на указанное число свечей. |
| `TeethPeriod` | `int` | `8` | Период линии Teeth. |
| `TeethShift` | `int` | `5` | Сдвиг линии Teeth вперёд. |
| `LipsPeriod` | `int` | `5` | Период линии Lips. |
| `LipsShift` | `int` | `3` | Сдвиг линии Lips вперёд. |
| `MaType` | `MovingAverageType` | `Smoothed` | Тип скользящей средней для всех линий Alligator. |
| `AppliedPrice` | `AppliedPriceType` | `Median` | Тип цены, подаваемой на скользящие (close, open, high, low, median, typical, weighted). |

### Перевод пунктов в цену

Стратегия умножает значения в пунктах на `PriceStep` инструмента. Для инструментов с 3 или 5 знаками после запятой дистанция
дополнительно умножается на 10, чтобы соответствовать определению пипса в MetaTrader. Если шаг цены неизвестен, используется
значение 1.

## Особенности реализации

- В StockSharp используется неттинговый режим, поэтому `MaxPositions` ограничивает суммарный объём позиции: дополнительные входы
  изменяют среднюю цену, а не создают отдельные позиции.
- Стоп-лосс и тейк-профит контролируются во внутреннем состоянии стратегии и исполняются рыночными заявками на первой свече,
  пересекающей уровень, что повторяет логику оригинального советника.
- Риск-процентный режим требует ненулевой дистанции стоп-лосса; иначе стратегия возвращается к фиксированному объёму.
- Индикаторы обновляются только на закрытых свечах (`CandleStates.Finished`), чтобы исключить преждевременные сигналы.
