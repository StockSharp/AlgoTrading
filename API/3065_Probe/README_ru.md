# Стратегия Probe

## Обзор
Стратегия Probe повторяет работу советника MetaTrader 5 «Probe» в рамках высокоуровневого API StockSharp. Она отслеживает индикатор Commodity Channel Index (CCI) на настраиваемом таймфрейме и реагирует, когда осциллятор выходит за пределы симметричного канала. При пробое стратегия размещает стоп-заявку на расстоянии в пунктах от текущей цены, чтобы поймать продолжение импульса и одновременно ограничить риск с помощью фиксированных и трейлинг-стопов.

## Логика торговли
1. Строятся свечи выбранного таймфрейма и рассчитывается CCI с заданным периодом.
2. Сохраняются предыдущие и текущие значения CCI для отслеживания выхода индикатора за нижнюю или верхнюю границу канала.
3. Если CCI пересекает уровень `-CCI Channel` снизу вверх, создаётся стоп-заявка на покупку выше последней цены закрытия на расстоянии `Indent (pips)`.
4. Если CCI пересекает уровень `+CCI Channel` сверху вниз, выставляется стоп-заявка на продажу ниже последней цены закрытия на то же количество пунктов.
5. В системе одновременно может находиться только одна отложенная стоп-заявка. При появлении новой заявки противоположного направления предыдущая отменяется, а повторные сигналы игнорируются до её исполнения или отмены.

## Управление заявками
- Отложенные стоп-заявки отменяются, если рынок уходит от цены активации дальше чем на `1.5 * Indent (pips)`. Это предотвращает зависание неактуальных ордеров при затухании импульса.
- После срабатывания стоп-заявки стратегия фиксирует цену исполнения как цену входа и немедленно отменяет противоположные отложенные ордера.

## Управление рисками
- Начальный стоп-лосс вычисляется из параметра `Stop Loss (pips)` и контролируется внутри стратегии. При достижении стопа позиция закрывается рыночным ордером.
- Трейлинг-стоп активируется, когда плавающая прибыль превышает сумму `Trailing Stop (pips) + Trailing Step (pips)`. После этого уровень стопа сдвигается, фиксируя прибыль и соблюдая минимальную дистанцию.
- Все расстояния в пунктах автоматически подстраиваются под трёх- и пятизнаковые котировки за счёт масштабирования шага цены инструмента.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Таймфрейм, по которому строятся свечи и рассчитывается CCI. |
| `CciLength` | Период усреднения индикатора CCI. |
| `CciChannelLevel` | Абсолютный уровень CCI, формирующий границы пробойного канала. |
| `IndentPips` | Расстояние в пунктах от последней цены закрытия до цены выставления стоп-заявки. |
| `StopLossPips` | Размер защитного стоп-лосса в пунктах. |
| `TrailingStopPips` | Минимальная прибыль в пунктах, необходимая для включения трейлинг-стопа. |
| `TrailingStepPips` | Дополнительная прибыль в пунктах перед очередным сдвигом трейлинг-стопа. |

## Примечания
- Объём сделки задаётся через свойство `Volume` базового класса стратегии.
- Логика рассчитана на работу в режиме неттинга с единственной позицией, что соответствует исходному советнику.
- При наличии области графика отображаются свечи, индикатор CCI и совершённые сделки.
