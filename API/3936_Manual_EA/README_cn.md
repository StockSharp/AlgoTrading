# Manual EA 策略

**Manual EA 策略** 是 MetaTrader 4 智能交易系统 *Manual_EA.mq4*（目录 `MQL/8159`）的 StockSharp 高级 API 复刻版。原始脚本在随机指标（Stochastic）离开超买 / 超卖区间时发出手动交易信号。本移植版本保持 5-3-3 的随机指标配置，在下达新的市价单之前会自动对冲现有仓位，并将常见的资金管理选项暴露为可调参数。

## 交易逻辑

1. 订阅 `CandleType` 指定的 K 线数据（默认 15 分钟），并将收盘价送入随机指标，参数为：
   - `%K` 回看周期 `KPeriod`（默认 5 根）
   - `%K` 额外平滑 `Slowing`（默认 3 根）
   - `%D` 平滑周期 `DPeriod`（默认 3 根）
2. 仅在每根完成蜡烛的 %D（信号线）最终值上计算信号，比较最近两次读数以判断阈值穿越。
3. **做多入场**：当上一根蜡烛的 %D 小于等于 `OversoldLevel`（默认 10），而当前值突破该阈值向上时触发。策略会先平掉所有空头仓位，然后以市价买入 `Volume + |空头仓位|`。
4. **做空入场**：当上一根蜡烛的 %D 大于等于 `OverboughtLevel`（默认 90），而当前值跌破该阈值时触发。策略会先平掉所有多头仓位，再以市价卖出 `Volume + |多头仓位|`。
5. 风险控制通过 `StartProtection` 完成。`StopLoss` 和 `TakeProfit` 参数使用价格点数表示，设置为正值会启用对应的止损 / 止盈；设置为 `0` 则关闭该保护。

本移植严格遵循 StockSharp 高级 API 的最佳实践，避免直接访问指标缓冲或对未完成的蜡烛做出决策。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 用于构建蜡烛并驱动指标的时间框架 (`DataType`)。 | 15 分钟 |
| `KPeriod` | 随机指标 %K 的回看周期。 | 5 |
| `DPeriod` | 随机指标 %D 的平滑周期。 | 3 |
| `Slowing` | 对 %K 施加的额外平滑长度。 | 3 |
| `OverboughtLevel` | %D 向下穿越时触发做空的上阈值。 | 90 |
| `OversoldLevel` | %D 向上穿越时触发做多的下阈值。 | 10 |
| `StopLoss` | 以价格点数表示的止损距离（0 = 不启用）。 | 100 |
| `TakeProfit` | 以价格点数表示的止盈距离（0 = 不启用）。 | 100 |
| `Volume` | 每次新信号发送的下单数量（手）。在下单前会先抵消相反方向的仓位。 | 0.1 |

## 其他说明

- 策略使用 `SubscribeCandles` 搭配 `BindEx` 获取 `StochasticOscillatorValue`，确保只处理最终的指标读数。
- 如果界面允许，会自动绘制价格 K 线、随机指标曲线以及策略自身的成交记录。
- 由于信号基于相邻两根完成蜡烛的 %D 值，行为与 MQL 中比较 `MODE_SIGNAL`（shift=1 与 shift=2）的逻辑保持一致。
