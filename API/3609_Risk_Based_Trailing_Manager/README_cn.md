# 风险百分比追踪止损策略

## 概述
**风险百分比追踪止损策略** 是从 `MQL/44099/test.mq5` 的 MetaTrader 5 脚本转换而来。StockSharp 版本持续监控所选证券的当前持仓，将浮动盈亏与账户权益进行对比。当盈亏达到可配置的百分比阈值或触及虚拟追踪止损线时，策略会通过市价单立即离场，以保护资金安全。

与原始 MQL 代码直接修改券商止损单不同，转换后的实现把追踪止损逻辑保留在策略内部。一旦价格穿越计算出的追踪价位，策略会主动平仓，从而在保持原始意图的同时兼容 StockSharp 的高阶 API。

## 工作流程
1. 启动时订阅配置的K线数据（默认1分钟）并记录当前账户权益。
2. 每根完成的K线都会使用最新收盘价、建仓均价以及仓位数量来估算浮动盈亏。
3. 当浮盈超过盈利百分比或浮亏突破风险百分比（均以账户权益为基准）时，通过市价单平掉当前持仓。
4. 持仓期间持续维护虚拟追踪止损：
   - 多单在价格上涨后，将止损线跟随上移，但不会超过开仓价。
   - 空单在价格下跌后，将止损线跟随下移，但不会低于开仓价。
5. 当K线最高/最低价触及追踪价位时，策略立即执行平仓。

## 参数
| 名称 | 说明 |
| ---- | ---- |
| **Risk Percentage** | 允许的浮亏百分比，超过后立即止损。 |
| **Profit Percentage** | 目标浮盈百分比，到达后锁定利润。 |
| **Trailing Stop Points** | 追踪止损的价格点数，设为0可关闭追踪功能。 |
| **Candle Type** | 驱动评估的K线数据源，默认1分钟周期。 |

## 说明
- 仅针对策略绑定的单个证券执行风险管理。
- 调用 `StartProtection()` 以启用账户保护模块。
- 不会创建或修改挂单，仅在需要时直接平掉净持仓。

## 转换要点
- 将原脚本中基于百分比的平仓逻辑改写为直接在 StockSharp 中平仓的方式，避免逐笔遍历订单。
- 将追踪止损的 `PositionModify` 行为改写为策略内部的虚拟止损触发机制。
- 增加了对账户权益缺失、最小价格步长为零等异常情况的防护，使策略在 StockSharp 环境中运行更加稳健。
