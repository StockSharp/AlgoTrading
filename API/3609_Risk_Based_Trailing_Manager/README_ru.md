# Стратегия Risk Based Trailing Manager

## Обзор
**Risk Based Trailing Manager** — это конверсия скрипта MetaTrader 5 из файла `MQL/44099/test.mq5`. Версия для StockSharp непрерывно контролирует текущую позицию по выбранному инструменту и сравнивает плавающий финансовый результат с балансом портфеля. Как только прибыль или убыток достигают заданных процентных порогов либо цена пересекает виртуальный трейлинг-стоп, стратегия немедленно закрывает позицию рыночной заявкой, защищая капитал.

В оригинальном MQL-коде стоп-приказы модифицировались на стороне брокера. В StockSharp реализация выполняет трейлинг внутри стратегии: рассчитывает новое значение стопа в пунктах и хранит его локально. При пробое уровня свечой позиция закрывается вручную, что сохраняет исходную идею и полностью совместимо с высокоуровневым API StockSharp.

## Алгоритм работы
1. При запуске стратегия подписывается на заданный тип свечей (по умолчанию 1 минута) и фиксирует текущую стоимость портфеля.
2. Каждая завершённая свеча используется для оценки плавающей прибыли/убытка по средней цене входа и текущему объёму.
3. Если плавающая прибыль превышает процент прибыли или плавающий убыток опускается ниже процентного лимита риска, позиция закрывается рыночной заявкой.
4. При наличии открытой позиции поддерживаются виртуальные трейлинг-уровни:
   - Для длинных позиций уровень подтягивается вслед за ростом цены, но не выше цены входа.
   - Для коротких позиций уровень опускается вслед за снижением цены, но не ниже цены входа.
5. Когда минимум/максимум свечи пересекает соответствующий уровень, стратегия закрывает позицию.

## Параметры
| Название | Описание |
| -------- | -------- |
| **Risk Percentage** | Процент от текущего баланса, допускаемый как плавающий убыток перед закрытием позиции. |
| **Profit Percentage** | Процент от баланса, который необходимо заработать, чтобы зафиксировать прибыль. |
| **Trailing Stop Points** | Дистанция трейлинг-стопа в ценовых пунктах. Ноль отключает трейлинг. |
| **Candle Type** | Тип свечей, по которым выполняется переоценка условий (по умолчанию 1 минута). |

## Особенности
- Предназначена для одного инструмента, указанного в свойстве `Security`.
- Вызывает `StartProtection()` для активации встроенной защиты счёта.
- Не работает с отложенными заявками, а только закрывает текущую чистую позицию.

## Детали конверсии
- Перевели логику процентного закрытия из перебора отдельных позиций в прямое закрытие через API StockSharp.
- Реализовали трейлинг-стоп как виртуальный уровень, аналогичный `PositionModify` в MQL, с реакцией на пробой свечой.
- Добавили проверки на отсутствие данных портфеля и нулевой шаг цены, чтобы стратегия корректно работала в различных настройках StockSharp.
