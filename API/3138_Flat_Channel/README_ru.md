# Стратегия Flat Channel

**Flat Channel Strategy** — перенос эксперта MetaTrader 5 *Flat Channel (barabashkakvn's edition)* на высокоуровневый API StockSharp. Алгоритм полностью сохраняет оригинальную логику: сглаженное стандартное отклонение ищет периоды затухающей волатильности, экстремумы внутри диапазона формируют горизонтальный канал, а чуть выше/ниже его границ выставляются отложенные стоп-заявки. При пробое стратегия входит в направление импульса, получает заранее рассчитанные уровни стоп-лосса и тейк-профита и при необходимости сопровождает позицию трейлинг-стопом.

## Как работает стратегия

1. **Поиск флэта по волатильности.** Индикатор `StandardDeviation` с периодом `StdDevPeriod` дополнительно сглаживается скользящей средней длиной `SmoothingLength`. Если сглаженное значение `FlatBars` подряд не увеличивается, считается, что рынок вошёл во флэт, и разрешается постановка новых отложенных ордеров.
2. **Построение канала.** После подтверждения флэта берутся максимум и минимум последних `max(ChannelLookback, FlatBars + 1)` свечей через стандартные индикаторы `Highest`/`Lowest`. Высота канала фильтруется по порогам `ChannelMinPips` и `ChannelMaxPips` (величины в пипсах переводятся в цену через параметр `PipSize` либо автоматически по шагу цены инструмента).
3. **Размещение заявок.** Пока позиция отсутствует и разрешено торговать, стратегия ставит buy stop по цене `high + IndentPips` и sell stop по цене `low − IndentPips`. При постановке запоминаются соответствующие уровни защиты.
4. **Сопровождение пробоя.** После срабатывания одной заявки противоположная отменяется. Цена исполнения становится опорной точкой для трейлинг-стопа, а запомненные стоп-лосс и тейк-профит активируются.
5. **Контроль позиции.** На каждой завершённой свече проверяется достижение стоп-лосса или тейк-профита; при срабатывании отправляется рыночный выход. Если `TrailingStopPips` больше нуля, стоп переносится вслед за ценой при наборе прибыли не менее `TrailingStopPips + TrailingStepPips`.
6. **Торговые часы.** При включённом `UseTradingHours` сигналы отрабатываются только между `StartHour` (включительно) и `EndHour` (не включительно). Допускается переход через полночь (`StartHour > EndHour`).

## Управление рисками

- **Динамическая или фиксированная защита.** При положительных `StopLossPips` / `TakeProfitPips` используются фиксированные расстояния в пипсах. Значение `0` переключает расчёт на динамическую формулу с коэффициентами `DynamicStopMultiplier` и `DynamicTakeMultiplier`.
- **Трейлинг-стоп.** Параметр `TrailingStopPips` включает подтягивание стопа по мере движения цены. Шаг переноса задаётся `TrailingStepPips`, чтобы избежать лишних перестановок.
- **Ограничение объёма.** `MaxPositions` задаёт максимум совокупной позиции в долях `TradeVolume`. Пока суммарный объём достигает лимита, новые отложенные заявки не создаются.
- **Фильтр направлений.** Флаги `UseBuy` и `UseSell` позволяют запускать стратегию только на пробой вверх, только на пробой вниз или в обе стороны одновременно.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TradeVolume` | `1` | Объём каждой отложенной заявки. |
| `PipSize` | `0.0001` | Размер пункта в ценовых единицах. Ноль — использовать шаг цены инструмента (с учётом 3/5-знакового котирования). |
| `StdDevPeriod` | `46` | Период базового индикатора стандартного отклонения. |
| `SmoothingLength` | `3` | Длина сглаживающей скользящей средней. |
| `FlatBars` | `3` | Минимальное количество подряд уменьшающихся значений волатильности для разрешения торговли. |
| `ChannelLookback` | `5` | Число свечей для расчёта максимумов и минимумов после обнаружения флэта (сравнивается с `FlatBars + 1`). |
| `ChannelMinPips` | `15` | Минимальная высота канала в пипсах. `0` отключает нижний порог. |
| `ChannelMaxPips` | `105` | Максимальная высота канала в пипсах. `0` отключает верхний порог. |
| `DynamicStopMultiplier` | `1` | Множитель высоты канала для динамического стоп-лосса (если `StopLossPips = 0`). |
| `DynamicTakeMultiplier` | `1` | Множитель высоты канала для динамического тейк-профита (если `TakeProfitPips = 0`). |
| `StopLossPips` | `0` | Фиксированное расстояние до стоп-лосса в пипсах. При положительном значении замещает динамический расчёт. |
| `TakeProfitPips` | `0` | Фиксированное расстояние до тейк-профита в пипсах. При положительном значении замещает динамический расчёт. |
| `IndentPips` | `0` | Дополнительный отступ (в пипсах) от границ канала при размещении заявок. |
| `TrailingStopPips` | `5` | Дистанция трейлинг-стопа в пипсах. `0` отключает сопровождение. |
| `TrailingStepPips` | `5` | Минимальный шаг переноса трейлинг-стопа. |
| `UseBuy` | `true` | Разрешить пробои вверх (buy stop). |
| `UseSell` | `true` | Разрешить пробои вниз (sell stop). |
| `MaxPositions` | `5` | Максимальный совокупный объём в долях `TradeVolume`. |
| `UseTradingHours` | `true` | Включить фильтр торговых часов. |
| `StartHour` | `0` | Час начала торговой сессии (включительно). |
| `EndHour` | `23` | Час окончания торговой сессии (не включительно). |
| `CandleType` | `H1` | Таймфрейм свечей для расчётов (по умолчанию 1 час). |

## Примечания

- Стратегия работает только по завершённым свечам через высокоуровневый вызов `SubscribeCandles().Bind(...)`, что обеспечивает воспроизводимость как в оригинальном советнике.
- Все ценовые уровни нормализуются функцией `Security.ShrinkPrice`, чтобы соблюдать шаг котирования биржи.
- При срабатывании одной отложенной заявки противоположная немедленно снимается, поэтому одновременно может существовать только одна пробойная позиция.
