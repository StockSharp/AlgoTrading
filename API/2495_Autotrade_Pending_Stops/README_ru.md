# Стратегия Autotrade Pending Stops

## Обзор
Стратегия представляет собой конверсию советника MetaTrader *Autotrade (barabashkakvn's edition)* на платформу StockSharp. Она постоянно поддерживает две симметричные стоп-заявки вокруг текущей цены: Buy Stop выше рынка и Sell Stop ниже рынка. Когда позиции отсутствуют, отложенные ордера обновляются на каждом закрытом баре. После срабатывания стопа позиция сопровождается до тех пор, пока рынок не войдет в фазу низкой волатильности или пока прибыль/убыток не достигнет заданного порога. Реализация полностью следует требованиям AGENTS.md и использует высокоуровневый API StockSharp.

## Соответствие параметров MQL5
| Параметр StockSharp | Параметр MQL5 | Назначение |
| --- | --- | --- |
| `IndentTicks` | `InpIndent` | Расстояние в шагах цены от текущей котировки до уровня стоп-заявок. |
| `MinProfit` | `MinProfit` | Минимальная плавающая прибыль (в валюте счета) для выхода при стабилизации рынка. |
| `ExpirationMinutes` | `ExpirationMinutes` | Время жизни отложенных заявок перед их отменой и перерегистрацией. |
| `AbsoluteFixation` | `AbsoluteFixation` | Абсолютная величина прибыли или убытка (в валюте), при которой позиция закрывается принудительно. |
| `StabilizationTicks` | `InpStabilization` | Максимальный размер тела предыдущей свечи, считающийся консолидацией. |
| `OrderVolume` | `Lots` | Объем для Buy Stop и Sell Stop. |
| `CandleType` | `Period()` | Тип свечей, управляющий логикой (по умолчанию 1-минутные свечи). |

Значения, выраженные в пунктах, преобразуются в реальные шаги цены с помощью `Security.PriceStep`. Пороговые значения по прибыли/убытку рассчитываются через `Security.StepPrice`, что воспроизводит принципы расчета прибыли в MQL5.

## Торговая логика
### Установка отложенных ордеров
1. Обработка ведется только на закрытых свечах (`CandleStates.Finished`).
2. Первая свеча используется для сохранения истории (open/close) и мгновенной постановки ордеров.
3. При отсутствии позиции очищаются неактивные ссылки и выставляются:
   - Buy Stop по цене `Close + IndentTicks * PriceStep`.
   - Sell Stop по цене `Close - IndentTicks * PriceStep`.
4. Для каждого стопа рассчитывается срок действия `CloseTime + ExpirationMinutes`. По истечении срока заявка отменяется и будет перерегистрирована на следующей свече.

### Сопровождение позиции
1. При срабатывании одного стопа противоположный ордер отменяется, чтобы избежать хеджирования на неттинговой модели учета.
2. Сохраняется размер тела предыдущей свечи (`|Open - Close|`) для контроля спокойного рынка.
3. На каждой свече при открытой позиции рассчитывается нереализованная прибыль относительно `PositionAvgPrice`.
   - Если прибыль больше `MinProfit`, а тело предыдущей свечи меньше `StabilizationTicks * PriceStep`, позиция закрывается рыночным ордером.
   - Если абсолютная прибыль или убыток превышает `AbsoluteFixation`, позиция также закрывается.
4. После выхода в ноль все остаточные отложенные ордера снимаются.

### Дополнительные нюансы
- Стратегия рассчитана на одну позицию (неттинг). Параметр `OrderVolume` автоматически устанавливает `Volume` стратегии.
- В отсутствии потоков Bid/Ask при тестировании используется цена закрытия свечи для расчета уровней стопов.
- Проверяется состояние `IsFormedAndOnlineAndAllowTrading()` перед размещением новых заявок.

## Особенности реализации и отличия от MQL5
- Расчет прибыли требует корректных значений `Security.PriceStep` и `Security.StepPrice`. При их отсутствии используется fallback `1`.
- В оригинальном советнике противоположный стоп мог оставаться активным при открытой позиции. В версии StockSharp он снимается сразу после исполнения, что соответствует неттинговой модели.
- Срок действия отложенных ордеров опирается на `CloseTime` свечи. Для лент без этого поля необходимо адаптировать источник данных.
- Параметр `CandleType` позволяет использовать любые типы свечей, поддерживаемые StockSharp.

## Рекомендации по использованию
1. Подберите `CandleType` в соответствии с таймфреймом, использованным в MetaTrader.
2. Настройте `IndentTicks`, `StabilizationTicks`, `MinProfit` и `AbsoluteFixation` с учетом шага цены и стоимости тика инструмента.
3. Убедитесь, что портфель работает в нужном режиме учета. Стратегия рассчитана на неттинг и закрывает позицию перед повторной установкой стопов.
4. Используйте параметры для оптимизации в Designer/Backtester, чтобы адаптировать стратегию к различным инструментам.
5. Отслеживайте журнал: стратегия не размещает заявки, пока не будут доступны завершенные свечи и не разрешена торговля.

## Дисклеймер
Алгоритмическая торговля сопряжена с рисками. Проведите полноценное тестирование, учитывайте биржевые ограничения (минимальные расстояния до стопов) и только затем переходите к торговле на реальном счете.
