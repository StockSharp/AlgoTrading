# Trade Arbitrage 策略

## 概述
本策略将 MetaTrader 专家顾问“Trade-Arbitrage”移植到 StockSharp。它会根据配置的货币列表，为所有有序货币对重建合成报价，并在任意两个合成变体之间寻找错价。当两个报价的差值超过 `MinimumEdgePips` 阈值时，策略会建立一个市场中性的篮子：买入较便宜的一腿、卖出较贵的一腿。该篮子被拆分成真实的外汇合约，因此整体头寸完全对冲，与原始 EA 的行为一致。

## 市场数据与订阅
- 根据货币列表和可选的 `SymbolSuffix` 参数解析所有可交易的货币对，并通过 `SubscribeLevel1()` 订阅最佳买卖价。
- 如果主标的 `Strategy.Security` 带有后缀（例如 `EURUSDm`），在 `SymbolSuffix` 为空时会自动将该后缀应用到所有生成的合成符号。
- 每次 Level1 更新都会重新计算所有变体的合成报价，并立即重新评估套利图，不需要轮询循环。

## 交易逻辑
1. 对于每个有序货币对 A/B，策略生成与 MQL 版本相同的变体：直接汇率、倒置汇率以及通过第三种货币构造的四种交叉汇率。
2. `MinimumEdgePips` 转换为绝对价格步长 `MinEdge`，其大小依据价格水平（低于 10 的价格使用 0.0001，否则使用 0.01）。优势检测完全对应原始条件 `Bid1 - MinEdge > Ask2` / `Ask1 + MinEdge < Bid2`。
3. `AllowedPatterns` 参数可复现 `Trade-Arbitrage.txt` 的白名单过滤；为空时表示允许所有组合。
4. 内部状态 `NetPositions` 与 MQL 中的 `XPosition` / `CountArbitrage` 数组等价，防止在前一篮子未平仓前重复进入相同机会。
5. 当检测到优势时，策略按照原始 EA 的公式将两个变体分解为实际货币腿，并把需要的成交量累计到 `_pendingVolumes`。

## 委托与头寸管理
- 累计的成交量会依据各标的的 `VolumeStep`、`MinVolume`、`MaxVolume` 进行归一化，然后通过 `BuyMarket` / `SellMarket` 成交。超过 `MaxLot` 的篮子会被拆分，小于 `MinLot` 的金额则忽略。
- 所有篮子均使用市价单执行，不会留下挂单，因此无需额外的撤单逻辑。
- 当套利方向翻转时，`NetPositions` 会请求双倍的成交量，先平掉已有敞口再建立反向头寸，与原 EA 的处理完全一致。

## 风险提示
- 策略不会像原版本那样写入统计文件，但会通过日志输出无法解析的合约信息。
- 在运行前，请确认经纪商提供的合约规模和最小手数与 `MinLot` / `MaxLot` 一致，否则归一化后可能无法下单。

## 参数
| 参数 | 说明 |
|------|------|
| `Currencies` | 逗号分隔的 ISO 货币代码列表，用于构建所有合成汇率。 |
| `MinimumEdgePips` | 触发套利篮子所需的最小价差（以点为单位）。 |
| `LotSize` | 每个套利篮子的基准手数，也用于反转已有机会。 |
| `MinLot` | 归一化后允许的最小下单手数。 |
| `MaxLot` | 单个市价单的最大手数，超过部分将自动拆分。 |
| `AllowedPatterns` | 可选的“Variant1 && Variant2”白名单，与 `Trade-Arbitrage.txt` 格式一致。 |
| `SymbolSuffix` | 解析合成符号时附加到代码后的可选后缀。 |

## 使用建议
- 请确保行情系统中包含策略可能使用的所有货币对（包括交叉盘）。若找不到某个符号，日志会给出 `LogWarning`，该组合也会被跳过。
- 套利判断依赖 tick 级别的买卖价更新，建议使用延迟低的行情源，否则优势窗口会迅速消失。
- 如果经纪商支持对冲，请把 `MinLot` 设置为尽量接近合约最小手数，以便拆分后的成交量与原 MT4 行为一致，不会出现多余的四舍五入误差。
