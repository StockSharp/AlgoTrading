# Стратегия Trade Arbitrage

## Обзор
Эта стратегия — порт MetaTrader-советника «Trade-Arbitrage» на StockSharp. Она восстанавливает синтетические котировки для всех упорядоченных валютных пар из заданного списка валют и ищет расхождения между любыми двумя вариантами синтетических курсов. Когда разница превышает порог `MinimumEdgePips`, стратегия открывает рыночно-нейтральную корзину: покупает более дешёвую ножку и продаёт более дорогую. Каждая корзина раскладывается на реальные валютные инструменты, поэтому итоговая позиция полностью хеджирована — как и в исходном советнике.

## Рыночные данные и подписки
- Все торгуемые пары строятся из списка валют и необязательного суффикса `SymbolSuffix`. Для них оформляется подписка `SubscribeLevel1()` на лучшие bid/ask.
- Если в `Strategy.Security` присутствует суффикс (например `EURUSDm`), он автоматически применяется ко всем генерируемым символам, когда `SymbolSuffix` оставлен пустым.
- Любое обновление Level1 приводит к пересчёту синтетических bid/ask и немедленной проверке арбитражного графа. Никаких циклов ожидания не используется.

## Торговая логика
1. Для каждой упорядоченной пары A/B создаются те же варианты, что и в MQL-версии: прямой курс, обратный и четыре синтетических через третью валюту.
2. `MinimumEdgePips` конвертируется в абсолютный шаг цены (`MinEdge`), зависящий от величины котировки (0.0001 для цен ниже 10 и 0.01 иначе). Проверка преимущества полностью повторяет условие `Bid1 - MinEdge > Ask2` / `Ask1 + MinEdge < Bid2`.
3. Параметр `AllowedPatterns` позволяет перенести фильтр из файла `Trade-Arbitrage.txt`. Если строка пуста, разрешены все комбинации.
4. Внутренний словарь `NetPositions` копирует функциональность массивов `XPosition`/`CountArbitrage` и не даёт заново открыть то же направление, пока предыдущая корзина не закрыта или не развернута.
5. При обнаружении преимущества стратегия разлагает оба варианта на реальные валютные legs по тем же формулам, что и в MQL, и аккумулирует требуемые объёмы во временном словаре `_pendingVolumes`.

## Управление заявками и позициями
- Перед отправкой объёмы нормализуются по `VolumeStep`, `MinVolume` и `MaxVolume` каждой бумаги и исполняются через `BuyMarket` / `SellMarket`. Если результат превышает `MaxLot`, корзина делится на несколько частей; значения меньше `MinLot` отбрасываются.
- Все сделки исполняются рыночными ордерами, лимитные заявки не выставляются, поэтому дополнительная логика отмены не требуется.
- При смене направления `NetPositions` формирует двойной объём: сначала закрывается текущая экспозиция, затем открывается противоположная, что соответствует поведению исходного советника.

## Замечания по рискам
- В отличие от оригинала стратегия не ведёт файловую статистику, но фиксирует проблемы с разрешением инструментов через журнал стратегии.
- Обязательно сверяйте контрактные размеры и шаги объёмов у брокера с параметрами `MinLot`/`MaxLot`. Неверные значения приведут к игнорированию сделок после нормализации объёмов.

## Параметры
| Параметр | Описание |
|----------|----------|
| `Currencies` | Список валют в формате ISO, разделённый запятыми, для построения синтетических курсов. |
| `MinimumEdgePips` | Минимальное преимущество (в пунктах), необходимое для открытия арбитражной корзины. |
| `LotSize` | Базовый объём корзины, используемый также при развороте активного арбитража. |
| `MinLot` | Минимальный допустимый объём после нормализации. |
| `MaxLot` | Максимальный объём одного рыночного ордера; большие корзины дробятся автоматически. |
| `AllowedPatterns` | Необязательный «белый список» комбинаций вида «Вариант1 && Вариант2», аналог файла `Trade-Arbitrage.txt`. |
| `SymbolSuffix` | Дополнительный суффикс для генерируемых символов при разрешении инструментов. |

## Рекомендации по использованию
- Поддерживайте полный список инструментов в Market Watch, включая все используемые кроссы. Отсутствующие символы записываются в `LogWarning`, а соответствующие комбинации пропускаются.
- Для эффективности необходим быстрый поток котировок: проверка арбитража выполняется на каждом обновлении bid/ask, задержки значительно снижают результат.
- Если брокер поддерживает хеджирование, задайте `MinLot` максимально близко к биржевому минимуму, чтобы декомпозиция корзины повторяла оригинальные MT4-сделки без лишнего округления.
