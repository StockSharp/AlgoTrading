# Стратегия Market Watch Panel

## Обзор
**MarketWatchPanelStrategy** переносит эксперта MetaTrader 5 «Market Watch Panel» в экосистему StockSharp и реализует его как высокоуровневую стратегию. Вместо отрисовки пользовательской панели стратегия читает список инструментов с диска, оформляет подписки на поток Level1 и выводит последние цены в журнал стратегии. При необходимости можно включить запись ценовых снимков в текстовый файл для дальнейшего анализа.

## Основные возможности
1. **Управление списком инструментов через текстовый файл**
   - По умолчанию используется `symbols.txt` (по одному символу на строку).
   - При запуске стратегия читает файл, удаляет дубликаты и подписывается на каждый валидный инструмент.
   - Публичные методы позволяют добавлять и очищать список прямо из Designer, без ручного редактирования файла.
2. **Мониторинг текущих цен**
   - Каждая подписка Level1 обрабатывается методом `ProcessLevel1`.
   - При появлении новой цены в журнал выводится сообщение вида `"SYMBOL last price: VALUE"`.
   - Последняя цена по каждому инструменту кэшируется внутри стратегии и доступна для дальнейшей логики.
3. **Опциональное логирование цен**
   - При установке параметра `EnablePriceLogging` в `true` каждое изменение цены дописывается в файл `symbols_prices.log` (метка времени в формате ISO; идентификатор инструмента; цена).
   - Повторяющиеся значения не записываются, чтобы лог оставался компактным.
   - Ошибки при работе с файловой системой автоматически попадают в `LogError`.
4. **Обновление списка во время работы**
   - Вызов `AddSymbol("TICKER")` добавляет инструмент в файл, мгновенно запускает подписку (если стратегия уже запущена) и предотвращает дублирование символов без учёта регистра.
   - Вызов `ClearSymbols()` освобождает действующие подписки, очищает внутренние структуры и перезаписывает файл пустым содержимым.

## Параметры стратегии
| Имя | Описание | Примечания |
|-----|----------|------------|
| `SymbolsFile` | Путь к текстовому файлу со списком инструментов (по одному на строку). | Значение по умолчанию `symbols.txt`. При отсутствии файла стратегия выводит предупреждение и ожидает новых символов. |
| `PriceLogFile` | Файл, куда пишутся ценовые снимки при активном логировании. | По умолчанию `symbols_prices.log`. Запись ведётся в режиме добавления, чтобы сохранить историю. |
| `EnablePriceLogging` | Флаг включения записи цен в `PriceLogFile`. | По умолчанию `false`, чтобы исключить лишнюю дисковую нагрузку. |

## Особенности конверсии
- В оригинальном MQL5 решении панель обновляла подписи на каждом тике и хранила список символов в `symbols.txt`. В StockSharp визуальные элементы отсутствуют, поэтому их заменяет системный лог и запись в файлы.
- Действия кнопок перенесены в методы `AddSymbol` (добавление нового инструмента) и `ClearSymbols` (полная очистка списка).
- Методы `LoadSymbolsFromFile` и `SaveSymbolsToFile` сохранили исходную семантику: создают файл при отсутствии и полностью перезаписывают при обновлении списка.
- Подписки `SubscribeLevel1` обеспечивают ту же оперативность получения котировок, что и вызовы `iClose` в обработчике `OnTick`.

## Как использовать
1. Создайте или отредактируйте файл, указанный в параметре `SymbolsFile` (по умолчанию `symbols.txt`), вписав нужные тикеры по одному в строку.
2. Запустите стратегию в StockSharp Designer или программно через коннектор.
3. Следите за журналом стратегии, чтобы видеть актуальные цены; при необходимости включите `EnablePriceLogging` для записи на диск.
4. Чтобы добавить инструмент в ходе работы, вызовите `AddSymbol("NEW_SYMBOL")`. Для полной очистки используйте `ClearSymbols()`.

## Структура файлов
```
3682_Market_Watch_Panel/
├── CS/
│   └── MarketWatchPanelStrategy.cs
├── README.md
├── README_cn.md
└── README_ru.md
```
