# Стратегия New Martin

## Обзор
Стратегия New Martin воспроизводит одноимённого советника MetaTrader и использует симметричный мартингейл: одновременно удерживаются длинная и короткая позиции, а при пересечении сглаженных скользящих средних (SMMA) на убыточную сторону добавляется объём. Как только одна из ног начинает проигрывать, стратегия умножает её размер на заданный коэффициент и фиксирует прибыль по наиболее успешной позиции. При срабатывании тейк-профита освобождённое направление немедленно восстанавливается, а при необходимости закрываются также лучшая и худшая открытые сделки, чтобы сохранить компактность сетки.

Реализация построена на высокоуровневом API StockSharp и предполагает использование хеджингового счёта, позволяющего держать разнонаправленные позиции одновременно. Входы и выходы выполняются рыночными приказами, что соответствует логике оригинального MQL-советника с моментальным исполнением.

## Индикаторы и сигналы
- **Быстрая SMMA (период 5 по умолчанию):** отражает краткосрочное направление.
- **Медленная SMMA (период 20 по умолчанию):** задаёт доминирующий тренд.
- **Обнаружение пересечений:** анализируются значения индикаторов на двух последних завершённых свечах. Если линии поменялись местами, генерируется сигнал на мартингейл-добавление. Для каждой свечи сигнал используется только один раз за счёт запоминания времени открытия свечи.

## Управление позициями
- **Начальный хедж:** после формирования индикаторов открываются по одной длинной и короткой позиции базовым объёмом. Для обеих ног устанавливается симметричный тейк-профит в пипсах.
- **Рецикл после тейк-профита:** когда цена достигает тейк-профита, позиция закрывается, событие фиксируется, и при необходимости одновременно закрываются наиболее прибыльная и наиболее убыточная позиции. Отсутствующее направление сразу же восстанавливается базовым объёмом.
- **Мартингейл:** при каждом пересечении SMMA определяется позиция с наихудшим результатом. На её сторону добавляется позиция, объём которой равен произведению текущего объёма на коэффициент мартингейла (после нормализации по шагу объёма). Затем закрывается позиция с максимальной прибылью, чтобы зафиксировать часть результата.

## Управление рисками
- **Контроль просадки:** отслеживается максимальное значение капитала. Если текущая стоимость портфеля падает более чем на заданный процент от пика, все позиции закрываются и стратегия переинициализирует хедж на следующей свече.
- **Рост базового объёма:** когда капитал увеличивается хотя бы в коэффициент мартингейла по сравнению с предыдущим опорным значением, базовый объём хеджа увеличивается тем же множителем (с учётом ограничений по минимальному и максимальному объёму инструмента).
- **Нормализация объёма:** каждый объём приводится к допустимому шагу и ограничивается допустимым диапазоном, чтобы избежать отклонений заявок.

## Параметры
- **Take Profit (pips):** расстояние до тейк-профита для каждой ноги, по умолчанию 50 пипсов.
- **Initial Volume:** базовый объём для каждой стороны хеджа, по умолчанию 0.1 контракта.
- **Slow MA / Fast MA:** периоды медленной и быстрой SMMA (20 и 5 соответственно); медленная должна быть длиннее быстрой.
- **Equity DD %:** максимально допустимая просадка от пикового капитала, по умолчанию 12%.
- **Multiplier:** коэффициент мартингейла, который используется и при добавлении к убыточной позиции, и при увеличении базового объёма. По умолчанию 1.6.
- **Candle Type:** таймфрейм свечей для расчётов, по умолчанию 15 минут (можно изменить под нужный график).

## Особенности
- Необходим брокерский счёт с поддержкой хеджирования, иначе одновременное удержание длинной и короткой позиций невозможно.
- Используются рыночные приказы. При необходимости контроля проскальзывания можно расширить логику заявок.
- Убедитесь, что у инструмента корректно заданы шаг цены и шага объёма, а также минимальный и максимальный объём, чтобы нормализация объёма работала корректно.
