# New Martin 策略

## 概述
New Martin 策略复刻了 MetaTrader 平台上的 “New Martin” 智能交易系统，通过在市场两侧同时建立对冲仓位并在移动均线交叉时扩展亏损腿的仓位来实现马丁格尔思路。策略始终持有一张多单和一张空单，当某一侧浮亏时，就按乘数扩大该侧仓位，同时平掉当前盈利最大的头寸。止盈触发后会立即补回缺失的方向，并可选地清理盈利和亏损极值持仓，使网格保持紧凑。

实现基于 StockSharp 高级 API，并假设组合账户支持对冲，从而允许多空仓位共存。为了贴近原始 MQL 实现，进出场均采用市价单，默认视为即时成交。

## 指标与信号
- **快速 SMMA（默认周期 5）：** 捕捉短期价格动量。
- **慢速 SMMA（默认周期 20）：** 描述主要趋势方向。
- **交叉检测：** 使用上一根和上上一根已完成的 K 线，当两条 SMMA 交叉时触发马丁加仓。通过记录上次交叉的开盘时间，确保每根 K 线只响应一次信号。

## 仓位管理
- **初始对冲：** 指标形成后立即按初始手数各开一张多单和空单，并设置对称的止盈距离。
- **止盈循环：** 当价格触及任意一侧的止盈水平时，平掉该笔持仓，并可选择同时平掉当前盈利最高和亏损最大的仓位，以配对结算盈亏。若某个方向仓位被清空，会马上按照基准手数重新开仓，保证对冲结构持续存在。
- **马丁加仓：** 每次 SMMA 交叉时，先找出浮动盈亏最差的持仓，在该方向按乘数放大仓位（按交易所的最小手数向下取整）。随后立即平掉浮动盈利最大的持仓以锁定收益。

## 风险控制
- **权益回撤限制：** 记录账户历史最高权益，一旦从峰值回撤超过设定百分比，立刻清空全部仓位，等待下一根 K 线重新建立对冲。
- **动态基准手数：** 当账户权益相对上次记录的余额增长达到乘数倍时，按同样的乘数提高基础对冲手数（同样会遵循交易所最小 / 最大手数限制）。这与原版 EA 将利润滚入网格的方式一致。
- **手数归一化：** 每次下单都会把手数向下取整到交易所的步长，并限制在最小/最大手数之间，以避免被拒单。

## 参数
- **Take Profit (pips)：** 每条腿距入场价的止盈距离，默认为 50 点。
- **Initial Volume：** 每个方向的基础手数，默认 0.1 手。
- **Slow MA / Fast MA：** 慢速与快速 SMMA 的周期（默认分别为 20 和 5），必须保持慢线周期大于快线周期。
- **Equity DD %：** 从权益峰值计算的最大允许回撤，默认 12%。
- **Multiplier：** 马丁加仓以及基准手数扩张所用的乘数，默认 1.6。
- **Candle Type：** 用于计算的 K 线周期，默认 15 分钟，可根据原策略的图表周期调整。

## 注意事项
- 账户需支持对冲模式，才能同时持有多头与空头。
- 策略使用市价单，若需要严格控制滑点，可在此基础上拓展委托逻辑。
- 请确认标的证券的价格步长、手数步长及最小/最大手数信息配置正确，以便手数归一化计算生效。
