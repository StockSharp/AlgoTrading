# Стратегия Franks 4 Hour Limit Orders

## Обзор
**Franks 4 Hour Limit Orders Strategy** переносит советник MetaTrader 4 из файла `MQL/7684/Franks_4hour_limit_orders.mq4` на высокоуровневый API StockSharp. Оригинальный робот развивает идеи «Тройного экрана» Александра Элдера: на четырёхчасовом графике анализируется гистограмма MACD (OsMA) и Force Index, после чего выставляются встречные лимитные заявки возле экстремумов предыдущей свечи. Реализация для StockSharp сохраняет эту логику, строго соблюдает требования репозитория (табуляция, высокоуровневый API, отсутствие самописных коллекций) и снабжена подробными комментариями на английском языке прямо в коде.

## Логика торговли
1. **Источник данных.** Стратегия подписывается на свечи выбранного таймфрейма (по умолчанию H4) и обрабатывает только завершённые бары, чтобы полностью повторить поведение MT4-советника.
2. **Индикаторы.** Используются два готовых индикатора:
   - `MovingAverageConvergenceDivergenceSignal(12, 26, 9)` предоставляет линию MACD и сигнальную линию; их разница даёт значение гистограммы OsMA.
   - `ForceIndex(24)` рассчитывает силу предыдущей свечи. В расчётах участвуют только финальные значения.
3. **Контекст из истории.** Для определения направления требуется минимум две завершённые свечи. Внутренние переменные хранят предыдущие значения OsMA, Force Index и экстремумы свечи `High[1]/Low[1]`.
4. **Условия для продажи.** Если гистограмма OsMA растёт (`OsMA[1] > OsMA[2]`), а Force Index предыдущей свечи отрицателен, формируется встречный sell limit:
   - Базовая цена — максимум предыдущей свечи плюс один «пункт».
   - Дополнительно контролируется минимальный отступ 16 пунктов (настраивается) от текущего бид-курса: фактическая цена равна максимуму между базовой ценой и `Bid + buffer`.
   - Стоп-лосс и тейк-профит рассчитываются в пунктах (по умолчанию 35 и 150) и выравниваются по шагу цены инструмента.
5. **Условия для покупки.** Если гистограмма OsMA снижается (`OsMA[1] < OsMA[2]`) и Force Index положителен, выставляется buy limit ниже рынка:
   - Базовая цена — минимум предыдущей свечи минус один пункт.
   - Выполняется то же требование по отступу: выбирается минимум между базовой ценой и `Ask - buffer`.
6. **Сопровождение отложенных заявок.** При смене направления OsMA неисполнённая заявка снимается. Когда одна сторона срабатывает, противоположная заявка удаляется, чтобы исключить двойную экспозицию.
7. **Управление позицией.** После исполнения сохраняется цена входа, активируются заранее посчитанные уровни стоп-лосса и тейк-профита. Дополнительно включён трейлинг-стоп на основе пунктов (по умолчанию 30 пунктов), который сдвигает защитный стоп только в сторону прибыли при достаточном движении цены.
8. **Выходы.** На каждом завершённом баре проверяется, достигла ли цена уровней стопа или профита: для лонга позиция закрывается при касании стопа минимумом свечи либо при достижении цели максимумом. Для шорта условия зеркальные.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `OrderVolume` | 1 | Постоянный объём лимитных заявок. |
| `StopLossPips` | 35 | Расстояние от точки входа до стоп-лосса в пунктах. |
| `TakeProfitPips` | 150 | Расстояние от точки входа до тейк-профита в пунктах. |
| `TrailingStopPips` | 30 | Размер трейлинг-стопа в пунктах. |
| `EntryBufferPips` | 16 | Минимальный зазор между рынком и лимитной заявкой. |
| `PipSize` | 0.0001 | Размер одного пункта (можно менять под экзотические инструменты). |
| `CandleType` | H4 | Таймфрейм свечей, используемый в расчётах. |

## Состав папки
- `CS/Franks4HourLimitOrdersStrategy.cs` — реализация стратегии с подробными комментариями на английском языке.
- `README.md` — описание стратегии на английском языке.
- `README_ru.md` — эта русскоязычная документация.
- `README_cn.md` — китайская версия описания.

## Особенности реализации
- Применяется исключительно высокоуровневый API StockSharp: подписка на свечи, привязка индикаторов и готовые методы отправки заявок.
- Все ценовые уровни округляются к шагу цены инструмента, чтобы исключить ошибки площадки.
- Для хранения состояния используются только необходимые переменные, что соответствует запрету на самодельные коллекции.
- Управление стопами, тейк-профитом и трейлингом выполняется внутри обработчика свечей и повторяет механику оригинального MT4-советника.
