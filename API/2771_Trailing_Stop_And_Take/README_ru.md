# Стратегия Trailing Stop And Take

## Обзор
**Trailing Stop And Take Strategy** — это адаптация эксперта из `MQL/19963` на платформу StockSharp. Стратегия сосредоточена на управлении уже открытыми позициями: после входа выставляются стартовые StopLoss и TakeProfit, а затем уровни подтягиваются вслед за ценой. Корректировки учитывают настраиваемый минимальный шаг, защиту уровня безубыточности и возможность запретить работу в зоне убытка.

Стратегия работает с одним инструментом и анализирует только закрытые свечи. При отсутствии позиций она открывает сделку в направлении тела последней свечи (бычья — покупка, медвежья — продажа), что повторяет тестовый режим из оригинального MQL-робота и обеспечивает постоянные сделки для модуля сопровождения.

## Последовательность работы
1. Подписка на выбранный тип свечей и обработка только закрытых баров.
2. При отсутствии позиции выполняется вход по направлению свечи (с учётом фильтра по типу позиции).
3. Для новой сделки рассчитываются стартовые стоп и тейк при помощи `InitialStopLossPoints`/`InitialTakeProfitPoints`; если значения равны нулю, используются параметры трейлинга.
4. На каждом закрытии свечи вычисляются новые уровни сопровождения:
   - Стоп подтягивается ближе к цене лишь после движения на величину трейлингового шага.
   - Тейк подтягивается после отката минимум на величину шага.
   - При выключенном `AllowTrailingLoss` уровни не смещаются ниже границы безубыточности.
5. При достижении ценой стопа или тейка позиция закрывается рыночной заявкой и все уровни сбрасываются.

## Логика сопровождения
### Длинные позиции
- Стартовый стоп располагается не ближе, чем на `SpreadMultiplier * PriceStep` от цены входа.
- Стартовый тейк находится не ближе того же минимального расстояния выше цены входа.
- Трейлинг-стоп следует за ценой, опираясь на `TrailingStopLossPoints`, и учитывает шаг и ограничение по безубыточности.
- Трейлинг-тейк подтягивается при откатах и не опускается ниже безубыточности, если запрет на работу в убытке включён.

### Короткие позиции
- Стартовый стоп размещается над ценой входа на расстоянии не меньше, чем множитель спреда.
- Стартовый тейк располагается ниже входа с тем же минимальным зазором.
- Трейлинг-стоп снижается вместе с ценой, но не поднимается выше уровня безубыточности при запрете работы в убытке.
- Трейлинг-тейк поднимается к цене при откатах и ограничивается безубыточностью при необходимости.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей, используемых в расчётах. |
| `Volume` | Объём сделок для входа и выхода. |
| `PositionType` | Управление только лонгами, только шортами или обоими направлениями. |
| `InitialStopLossPoints` | Размер стартового стопа в пунктах (при 0 берётся расстояние трейлинга). |
| `InitialTakeProfitPoints` | Размер стартового тейка в пунктах (при 0 берётся расстояние трейлинга). |
| `TrailingStopLossPoints` | Дистанция между ценой и трейлинг-стопом. |
| `TrailingTakeProfitPoints` | Дистанция между ценой и трейлинг-тейком. |
| `TrailingStepPoints` | Минимальное движение цены для обновления уровней. |
| `AllowTrailingLoss` | Разрешение сопровождать позицию в зоне убытка. |
| `BreakevenPoints` | Смещение в пунктах для расчёта уровня безубыточности. |
| `SpreadMultiplier` | Множитель минимальной дистанции (аналог MQL `StopLevel`). |

## Примечания
- Закрытие по стопу или тейку выполняется рыночными заявками, что упрощает реализацию и повторяет логику модификации позиций в MQL.
- `SpreadMultiplier` имитирует ограничение брокера на минимальное расстояние до цены, подбирайте значение под ваш инструмент.
- По заданию реализована только C# версия, Python-вариант не создавался.
- При необходимости можно отключить встроенные входы и использовать стратегию как модуль сопровождения собственных сигналов.
