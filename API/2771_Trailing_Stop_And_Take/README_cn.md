# 跟踪止损与止盈策略

## 概述
**Trailing Stop And Take Strategy** 是 `MQL/19963` 中 MetaTrader 专家顾问的 StockSharp 版本。策略专注于头寸管理：开仓后立即设置初始止损与止盈，然后在价格波动时动态跟踪两者。跟踪调整遵循可配置的最小步长、保本保护，并可选择禁止在亏损区间内移动。

策略基于单一标的的收盘 K 线运行。当没有持仓时，它会按照最近一根 K 线的实体方向开仓（阳线买入、阴线卖出），以复现原 MQL 脚本的测试行为，从而为跟踪模块提供持续的持仓样本。

## 工作流程
1. 订阅配置的 K 线类型，仅处理收盘的 K 线。
2. 空仓时根据 K 线方向开多或开空（遵循仓位类型过滤器）。
3. 新持仓建立后，使用 `InitialStopLossPoints`/`InitialTakeProfitPoints` 设置初始止损与止盈；若为零，则改用对应的跟踪距离。
4. 每根 K 线收盘时计算新的跟踪价格：
   - 价格朝有利方向移动超过跟踪步长后才推动止损靠近价格。
   - 价格向不利方向回调超过跟踪步长时才收紧止盈。
   - 当 `AllowTrailingLoss` 关闭时，保本阈值阻止止损/止盈回到亏损区间。
5. 当价格穿越任何跟踪止损或止盈时，使用市价单离场并重置所有记录的价格。

## 跟踪逻辑
### 多头
- 初始止损至少要距离开仓价 `SpreadMultiplier * PriceStep`。
- 初始止盈同样至少高于开仓价这一最小距离。
- 跟踪止损按 `TrailingStopLossPoints` 与收盘价保持距离，在满足步长与保本条件后上移。
- 跟踪止盈在价格回调时下移，且在禁止亏损跟踪时不会低于保本线。

### 空头
- 初始止损位于开仓价上方，距离不少于乘以点差倍数的最小距离。
- 初始止盈位于开仓价下方，也遵循相同的距离规则。
- 跟踪止损随价格下跌而下移，但若禁用亏损跟踪则不会高于保本线。
- 跟踪止盈在价格反弹时上移，并在需要时限制在保本价位。

## 参数
| 参数 | 说明 |
|------|------|
| `CandleType` | 用于计算的 K 线周期。 |
| `Volume` | 开仓与平仓的默认数量。 |
| `PositionType` | 仅管理多头、空头或同时管理两者。 |
| `InitialStopLossPoints` | 初始止损距离（若为零则使用跟踪止损距离）。 |
| `InitialTakeProfitPoints` | 初始止盈距离（若为零则使用跟踪止盈距离）。 |
| `TrailingStopLossPoints` | 跟踪止损与价格之间的距离。 |
| `TrailingTakeProfitPoints` | 跟踪止盈与价格之间的距离。 |
| `TrailingStepPoints` | 更新止损或止盈所需的最小价格变动。 |
| `AllowTrailingLoss` | 是否允许在亏损区间内移动止损/止盈。 |
| `BreakevenPoints` | 用于计算保本价的点数偏移。 |
| `SpreadMultiplier` | 近似模拟 MQL `StopLevel` 的最小距离倍数。 |

## 说明
- 触发止损或止盈时使用市价单离场，简单直观，同时保留原脚本修改仓位的风格。
- `SpreadMultiplier` 近似 MQL 中的点差限制，可根据交易所或经纪商调整。
- 根据要求，本策略仅提供 C# 实现，不包含 Python 版本。
- 如需与自定义信号结合，可关闭内置入场逻辑并从外部注入订单，仅使用该跟踪模块。
