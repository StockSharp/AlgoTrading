# 银河爆炸策略

## 概述
银河爆炸策略将原版 MT5 网格专家移植到 StockSharp。策略只在收盘后的完整 K 线上工作，利用长期移动平均线来判定方向偏好，并根据价格与历史仓位的距离扩展网格。当价格持续位于移动平均线同侧时逐步加仓，在累积的已实现收益与浮动收益达到目标后一次性平掉全部仓位。

## 市场逻辑
1. **方向过滤**：比较最新 K 线收盘价与移动平均线。当收盘价低于均线时认为行情看多，高于均线则看空。
2. **渐进式网格**：前八次入场在满足方向条件时立即执行。超过八次后，会根据当前价格与最近一次和第一次入场价的距离决定是否继续加仓。
3. **间距控制**：距离以最小报价步长为单位衡量。价格若远离最近一笔仓位就允许加仓；同时根据与第一笔仓位的距离，决定立即交易、跳过三根 K 线或跳过六根 K 线后再入场。
4. **利润实现**：实时计算已实现收益与未实现收益之和，当总收益超过最小利润目标时，通过一笔市价单关闭全部持仓。

## 交易管理
- **下单手数**：每次下单都使用配置的交易量。如果信号反向且当前有仓位，会发送一笔市价单先平掉原方向再按需要额外开仓。
- **仓位跟踪**：分别维护多头和空头篮子的平均成本、首笔及末笔入场价，从而复刻原始专家中基于距离的加仓规则。
- **交易时段过滤**：只在设定的开始与结束小时之间交易。策略使用 K 线开盘时间判定是否处于交易窗口，窗口外的信号一律忽略。
- **安全检查**：如果交易时段配置错误（例如开始时间不早于结束时间）会记录警告并跳过交易逻辑。

## 参数
| 参数 | 说明 |
|------|------|
| **Order Volume** | 每次入场使用的交易量，同时用于估算当前打开的网格步数。 |
| **Start Hour** | 交易时段开始的小时，早于该时间的信号被忽略。 |
| **End Hour** | 交易时段结束的小时（不含），晚于该时间的信号被忽略。 |
| **Minimal Profit** | 触发整体平仓的已实现收益与浮动收益之和。 |
| **Indent After 8th** | 第八次入场之后，再次开仓所需与最近一次入场的最小距离（以价格步长计）。 |
| **Skip 3 Min** | 触发“跳过三根 K 线”规则的距离下限。 |
| **Skip 3 Max** | 保持“跳过三根 K 线”规则生效的距离上限。 |
| **Skip 6 Max** | 保持“跳过六根 K 线”规则生效的距离上限。 |
| **MA Length** | 用于判定方向的简单移动平均线长度。 |
| **Candle Type** | 策略订阅的 K 线类型，移动平均与网格逻辑都基于该数据流执行。 |

## 实现要点
- 通过 `SubscribeCandles` 订阅 K 线并绑定 `SimpleMovingAverage` 指标，仅处理已经完成的 K 线。
- 在 `OnNewMyTrade` 中维护仓位统计，精确记录多空篮子的首尾入场价及平均价格。
- 根据标的 `PriceStep` 将参数从“点”转换为实际价格距离，保持与 MT5 原策略一致的配置体验。
- 遵循项目规范，只使用标量状态变量而不引入额外集合结构。
