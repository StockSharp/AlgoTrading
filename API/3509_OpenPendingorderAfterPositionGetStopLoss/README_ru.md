# OpenPendingorderAfterPositionGetStopLoss

## Обзор
Стратегия **OpenPendingorderAfterPositionGetStopLoss** переносит одноимённого советника MetaTrader 5 на высокоуровневый API StockSharp. На каждом закрытом баре вычисляется наклон линии Stochastic %K выбранного таймфрейма. Если %K снижается, ниже рынка размещается sell stop, если растёт — выше рынка появляется buy stop. После срабатывания любой заявки сразу выставляются защитные стоп-лосс и тейк-профит. Когда позиция закрывается по стоп-лоссу, соответствующий отложенный ордер автоматически восстанавливается, поэтому сетка пробойных входов поддерживается без ожидания следующей свечи.

## Торговые правила
- Подписка на закрытые свечи заданного таймфрейма и вычисление стандартного стохастика (`KPeriod`, `DPeriod`, `Slowing`).
- Сравнение текущего значения %K со значением два бара назад:
  - `%K(current) < %K(two bars ago)` → выставить sell stop ниже лучшего bid.
  - `%K(current) > %K(two bars ago)` → выставить buy stop выше лучшего ask.
- Отложенные ордера смещаются от рынка на сумму текущего спреда и буфера `MinStopDistancePoints`, как в оригинальном MQL-скрипте.
- После активации заявки стратегия отправляет защитный стоп-ордер и при необходимости лимит на фиксацию прибыли.
- Если позиция закрылась по стоп-лоссу, соответствующий отложенный ордер немедленно создаётся заново по актуальным ценам.
- Защитные ордера автоматически снимаются при выполнении тейк-профита или остановке стратегии.

## Параметры
| Имя | Описание |
| --- | --- |
| `OrderVolume` | Объём сделки (в лотах) для каждого отложенного ордера. |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах инструмента. 0 — не использовать. |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах инструмента. 0 — не использовать. |
| `MinStopDistancePoints` | Минимальный буфер (в пунктах), добавляемый к спреду при выставлении ордера. |
| `MaxPositions` | Максимальное количество одновременно открытых позиций в одном направлении (для неттинга фактически 0 или 1). |
| `KPeriod` | Число баров для расчёта %K. |
| `DPeriod` | Длина сглаживающей линии %D. |
| `Slowing` | Дополнительное сглаживание %K перед сравнением. |
| `PendingExpiry` | Срок жизни отложенных заявок. Просроченные ордера снимаются на следующей свече. |
| `CandleType` | Таймфрейм свечей, используемый для расчётов. |

## Особенности реализации
- Управление заявками построено на высокоуровневых методах `BuyStop`, `SellStop`, `SellLimit`, `BuyLimit` в соответствии с требованиями `AGENTS.md`.
- Значения индикатора обрабатываются напрямую в обработчике `SubscribeCandles().BindEx(...)`, без вызовов `GetValue`.
- Обработчик `OnOwnTradeReceived` отвечает за установку и снятие защитных ордеров, повторяя логику `OnTradeTransaction` из оригинального эксперта.
- Все комментарии в коде приведены на английском языке, а отступы выполнены табуляцией, как предписано правилами репозитория.
