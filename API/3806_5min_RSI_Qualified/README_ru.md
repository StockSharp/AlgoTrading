# Стратегия 5min RSI Qualified

## Обзор

**5min RSI Qualified** — это порт MetaTrader-советника «5min_rsi_qual_01a». Изначально робот анализировал пятиминутные свечи с помощью RSI (28) и открывал контртрендовую позицию, если индикатор оставался в экстремальной зоне заданное количество баров. После входа стоп-лосс подтягивался к закрытию предыдущей свечи. Версия на StockSharp полностью сохраняет алгоритм подтверждения сигналов, дистанции стопов и ограничение на единственную сделку, используя высокоуровневый API подписки на свечи.

По умолчанию стратегия работает с пятиминутными свечами, однако параметр `CandleType` допускает любой другой таймфрейм, поддерживаемый инструментом. Все пороговые значения индикатора и стопы задаются в «пунктах» MetaTrader, что позволяет без пересчётов перенести оптимизированные настройки из MT4.

## Торговая логика

1. **Расчёт RSI.** Индикатор с периодом 28 пересчитывается на каждой завершённой свече. Используются только закрытые свечи, чтобы соответствовать обращению к `Close[1]` в MQL4.
2. **Счётчики квалификации.** Два счётчика фиксируют, сколько подряд свечей RSI находится выше уровня перекупленности (`UpperThreshold`) или ниже уровня перепроданности (`LowerThreshold`). Это повторяет цикл из MQL, который проверял последние 12 баров.
3. **Условия входа.** При отсутствии открытой позиции и достижении счётчиком перекупленности значения `QualificationLength` выполняется продажа по рынку. Аналогично, при выполнении условия перепроданности открывается покупка. Таким образом, в любой момент активна только одна позиция.
4. **Трейлинг-стоп.** Пока позиция открыта, стоп-уровень пересчитывается на каждой завершённой свече: берётся закрытие предыдущей свечи и вычитается/прибавляется `StopLossPoints`, конвертированный в абсолютное ценовое смещение. Стоп двигается только в сторону прибыли, как и в исходных вызовах `OrderModify`.
5. **Первичный стоп.** После исполнения ордера выставляется начальный стоп в соответствии с `InitialStopPoints`. Если он оказывается ближе, чем трейлинг, последний не будет его «расширять», что повторяет поведение MetaTrader.

## Управление рисками

- Дистанции стопов заданы в пунктах MetaTrader и при каждом расчёте переводятся в абсолютную цену через `PriceStep` (или `MinStep`, если основной шаг не задан).
- Стратегия не наращивает позицию и дожидается полного закрытия перед поиском нового сигнала.
- В `OnStarted` вызывается `StartProtection()`, чтобы защитные механизмы StockSharp отслеживали вручную управляемые стоп-уровни.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `RsiPeriod` | Период RSI. | `28` |
| `QualificationLength` | Количество последовательных свечей, в течение которых RSI должен оставаться в экстремальной зоне. | `12` |
| `UpperThreshold` | Уровень RSI для квалификации сигнала на продажу. | `55` |
| `LowerThreshold` | Уровень RSI для квалификации сигнала на покупку. | `45` |
| `StopLossPoints` | Дистанция трейлинг-стопа в пунктах MetaTrader. При значении `0` трейлинг отключается. | `21` |
| `InitialStopPoints` | Начальный стоп в пунктах MetaTrader, выставляемый сразу после входа. Значение `0` отменяет первичный стоп. | `11` |
| `CandleType` | Тип свечей для анализа (по умолчанию 5 минут). | `5-минутный таймфрейм` |

## Рекомендации по использованию

- Убедитесь, что шаг цены инструмента соответствует размеру пункта, использованному при оптимизации в MT4. Для пятизнаковых FX-пар один пункт равен 0.00010, поэтому стандартные значения 11/21 повторяют оригинальную схему.
- Поскольку стратегия контртрендовая, она эффективнее на боковых участках. Для трендовых инструментов увеличьте `QualificationLength` или расширьте пороги RSI.
- Объём берётся из свойства `Volume` базового класса. Настройте его перед запуском стратегии.
- Параметры отмечены `SetCanOptimize()`, поэтому их можно подбирать через оптимизатор StockSharp.

## Особенности конверсии

- Алгоритм обработки свечей, вычисление RSI и ограничение на единственную позицию полностью соответствуют коду MetaTrader.
- Трейлинг-стоп обновляется по закрытию предыдущей свечи, что гарантирует идентичные уровни выхода при развороте рынка.
- Проверки на количество баров и свободную маржу убраны: в StockSharp подготовка данных и доступность портфеля контролируются платформой.
