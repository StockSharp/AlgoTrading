# Стратегия Crypto SR

Стратегия Crypto SR переносит советник MetaTrader 4 «Crypto S&R» на инфраструктуру StockSharp. Перевод сохраняет многоуровневую систему фильтров исходного алгоритма: тренд оценивается двумя линейно-взвешенными средними (LWMA), направление подтверждается моментумом на старшем таймфрейме и долгосрочным MACD, а уровни поддержки/сопротивления строятся по фракталам Билла Вильямса. Сделки исполняются рыночными ордерами, позиция сопровождается фиксированными стоп-лоссом и тейк-профитом, переводом в безубыток и трейлинг-стопом в пунктах.

## Логика торговли

1. **Основной таймфрейм** — стратегия подписывается на выбранные свечи и рассчитывает две LWMA по типичной цене `(High + Low + Close) / 3`. Для покупок быстрая LWMA должна находиться выше медленной, для продаж — ниже.
2. **Моментум на старшем периоде** — индикатор Momentum анализируется на второй серии свечей. Максимальное отклонение трёх последних значений от уровня 100 должно превышать порог для покупок или продаж.
3. **Долгосрочный MACD** — третья подписка рассчитывает MACD (12, 26, 9). Для лонга линия MACD должна быть выше сигнальной, для шорта — ниже. По умолчанию используется дневной таймфрейм, что аппроксимирует месячные свечи из версии MT4; при наличии месячных данных параметр можно сменить.
4. **Фрактальные уровни** — завершённые свечи складываются в скользящее окно. При появлении классического фрактала (две соседние свечи с каждой стороны) соответствующий максимум или минимум становится активным уровнем сопротивления/поддержки. Вокруг уровня добавляется настраиваемый буфер в пунктах, повторяющий горизонтальные линии оригинала.
5. **Условия входа**:
   - *Покупка*: открытых лонгов нет, быстрая LWMA выше медленной, моментум превышает порог для покупок, MACD бычий, текущая свеча тестирует буфер поддержки и закрывается выше предыдущего закрытия.
   - *Продажа*: зеркальные требования относительно сопротивления, порога для продаж и медвежьего MACD.
6. **Управление рисками** — каждой позиции назначаются стоп-лосс и тейк-профит в пунктах. Логика безубыточности переносит стоп после достижения заданной прибыли, трейлинг-стоп следует за ценой по экстремумам свечей. Если MACD разворачивается против сделки, позиция закрывается.

## Особенности реализации

- Месячный MACD из исходного советника заменён дневным таймфреймом по умолчанию, так как готовых календарных месяцев в StockSharp нет. При необходимости можно подключить агрегатор с месячными свечами.
- Закрытие происходит рыночными ордерами при срабатывании защитных уровней, что соответствует вызовам `OrderClose` в MQL и не требует биржевых стоп-заявок.
- Все индикаторы обновляются через высокоуровневый API `SubscribeCandles().Bind(...)`, обращения к `GetValue` не требуются.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `FastMaPeriod` | Период быстрой LWMA на основном таймфрейме. | `6` |
| `SlowMaPeriod` | Период медленной LWMA на основном таймфрейме. | `85` |
| `MomentumPeriod` | Период Momentum на старшем таймфрейме. | `14` |
| `MomentumBuyThreshold` | Минимальное отклонение Momentum от 100 для разрешения покупок. | `0.3` |
| `MomentumSellThreshold` | Минимальное отклонение Momentum от 100 для разрешения продаж. | `0.3` |
| `MacdFastPeriod` | Быстрый период EMA в фильтре MACD. | `12` |
| `MacdSlowPeriod` | Медленный период EMA в фильтре MACD. | `26` |
| `MacdSignalPeriod` | Период сигнальной EMA в MACD. | `9` |
| `StopLossPips` | Расстояние стоп-лосса в пунктах. | `20` |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах. | `50` |
| `TrailingStopPips` | Длина трейлинг-стопа в пунктах (0 отключает). | `40` |
| `UseBreakEven` | Переводить ли стоп в безубыток после достижения цели. | `true` |
| `BreakEvenTriggerPips` | Прибыль в пунктах, после которой включается безубыток. | `30` |
| `BreakEvenOffsetPips` | Смещение стопа при переводе в безубыток. | `30` |
| `FractalWindowLength` | Размер окна для подтверждения фракталов. | `7` |
| `FractalBufferPips` | Дополнительный буфер вокруг фрактального уровня (пункты). | `10` |
| `TradeVolume` | Объём каждой рыночной заявки. | `1` |
| `CandleType` | Основной таймфрейм для LWMA и фракталов. | Свечи `15m` |
| `HigherCandleType` | Старший таймфрейм для Momentum. | Свечи `1h` |
| `LongTermCandleType` | Таймфрейм для фильтра MACD. | Свечи `1d` |

