# Стратегия Combo Right

Эта стратегия является точной портированной версией MetaTrader-советника **Combo_Right.mq4** для платформы StockSharp. Она сочетает фильтр на основе индикатора CCI, рассчитываемого по ценам открытия, и три перцептрона, которые анализируют импульс открытий на настраиваемых интервалах. В зависимости от значения `PassMode` перцептроны могут переопределять сигнал CCI и использовать собственные параметры защиты.

## Логика работы

1. Подписка на выбранный тип свечей и вычисление CCI по ценам открытия. Завершённая свеча даёт закрытие для проверки сигнала и одновременно пополняет буфер открытий.
2. Для каждой закрытой свечи в кольцевой буфер сохраняется цена открытия. Это позволяет перцептронам получать значения `period`, `2*period`, `3*period`, `4*period` без прямого обращения к внутреннему хранилищу индикаторов.
3. После завершения свечи выполняются следующие шаги:
   - Считывается CCI. Он задаёт базовый сигнал (`> 0` — покупка, `< 0` — продажа) и использует защитные расстояния `TakeProfit1` / `StopLoss1`.
   - В зависимости от `PassMode` рассчитываются один или несколько перцептронов. Каждый перцептрон использует веса из оригинального советника (`X** - 100`) и разности между последним закрытием и историческими открытиями.
   - Если условия перцептрона выполняются, базовый сигнал заменяется, а стоп-лосс и тейк-профит обновляются перед выставлением заявки.
4. Активные ордера снимаются, противоположная позиция закрывается, затем открывается новая рыночная сделка объёмом `TradeVolume`. После отправки заявки вызываются `SetTakeProfit` и `SetStopLoss`, которые размещают защитные ордера с рассчитанными смещениями.

### Режимы Pass

- **Pass 1** — учитывается только CCI, знак индикатора задаёт направление сделки.
- **Pass 2** — при отрицательном выходе первого перцептрона (`Perceptron1Period`, `X12…X42`) открывается шорт с параметрами второго профиля; иначе используется CCI.
- **Pass 3** — при положительном выходе второго перцептрона открывается лонг с параметрами третьего профиля; в противном случае действует CCI.
- **Pass 4** — сначала анализируется третий перцептрон. Если он положительный, требуется подтверждение вторым перцептроном для открытия лонга. Если третий отрицательный и первый перцептрон меньше нуля, открывается шорт. Если ни одна ветка не активна, используется CCI.

Во всех режимах стратегия ждёт накопления достаточной истории (до `period * 4` для самого длинного перцептрона), чтобы исключить выход за границы массивов, который допускался в MetaTrader.

## Управление рисками

Перед каждым входом вычисляются смещения по стопу и тейку через величину `PriceStep`. Если шаг цены отсутствует, используется само значение в пунктах. Функции `SetTakeProfit` и `SetStopLoss` получают рассчитанные смещения и конечную позицию, благодаря чему защитные ордера всегда соответствуют текущему объёму.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `TakeProfit1`, `StopLoss1` | `decimal` | 50 / 50 | Защитные расстояния (в пунктах) при работе по сигналу CCI. |
| `CciPeriod` | `int` | 10 | Период индикатора CCI по ценам открытия. |
| `X12`, `X22`, `X32`, `X42` | `int` | 100 | Исходные веса первого (медвежьего) перцептрона; в коде из них вычитается 100. |
| `TakeProfit2`, `StopLoss2` | `decimal` | 50 / 50 | Расстояния для сделок, открываемых первым перцептроном. |
| `Perceptron1Period` | `int` | 20 | Шаг выборки первого перцептрона в свечах. |
| `X13`, `X23`, `X33`, `X43` | `int` | 100 | Исходные веса второго (бычьего) перцептрона. |
| `TakeProfit3`, `StopLoss3` | `decimal` | 50 / 50 | Расстояния для сделок, открываемых вторым перцептроном. |
| `Perceptron2Period` | `int` | 20 | Шаг выборки второго перцептрона. |
| `X14`, `X24`, `X34`, `X44` | `int` | 100 | Исходные веса третьего (подтверждающего) перцептрона, используемого при `PassMode = 4`. |
| `Perceptron3Period` | `int` | 20 | Шаг выборки третьего перцептрона. |
| `PassMode` | `int` | 1 | Режим работы супервизора (1–4), полностью повторяющий ветвления оригинального советника. |
| `TradeVolume` | `decimal` | 0.01 | Объём новой позиции; перед входом закрывается встречная позиция. |
| `CandleType` | `DataType` | M1 | Тип свечей, используемый для расчёта CCI и перцептронов. |

## Дополнительно

- Стратегия строго следует требованиям репозитория: не использует произвольный доступ к индикаторам и хранит минимально необходимую историю открытий в массиве.
- Если инструмент не задаёт шаг цены, расстояния трактуются как абсолютные значения, что совпадает с поведением `Point` в MetaTrader.
- Все комментарии в коде и документация написаны на английском языке в соответствии с требованиями проекта.
