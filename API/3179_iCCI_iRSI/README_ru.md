# Стратегия iCCI iRSI

## Обзор
**iCCI iRSI Strategy** — конвертация советника MetaTrader 5 `iCCI iRSI.mq5`. Оригинальный алгоритм объединяет индикаторы Commodity Channel Index (CCI) и Relative Strength Index (RSI), чтобы найти зоны истощения. Когда оба осциллятора одновременно выходят в перепроданность или перекупленность, советник открывает сделку, выставляет защитные ордера и при необходимости сопровождает позицию трейлинг-стопом. Порт на StockSharp сохраняет эту логику, добавляя работу с "пипсовыми" параметрами, автоматическое закрытие встречных позиций и режим реверса сигналов.

## Логика торговли
1. Подписка на выбранный тип свечей и расчёт `CommodityChannelIndex` с периодом `CciPeriod` и `RelativeStrengthIndex` с периодом `RsiPeriod`.
2. Обработка только завершённых свечей — как и в MQL-версии, которая ждёт открытия нового бара.
3. Если CCI и RSI опускаются ниже своих нижних уровней (`CciLowerLevel`, `RsiLowerLevel`), открывается или переворачивается длинная позиция. Если оба индикатора поднимаются выше верхних уровней (`CciUpperLevel`, `RsiUpperLevel`), формируется короткий сигнал. Параметр `ReverseSignals` меняет направления на противоположные.
4. Перед отправкой нового ордера стратегия закрывает встречную позицию, чтобы итоговая позиция всегда соответствовала актуальному сигналу.
5. После входа контролируются цены закрытия следующих свечей. Стоп-лосс и тейк-профит задаются в пипсах и переводятся в цену по `PriceStep`. Для инструментов с 3 или 5 знаками выполняется дополнительное умножение на 10, полностью повторяющее MQL-переменную `digits_adjust`.
6. Если `TrailingStopPips` больше нуля, стоп-лосс подтягивается вслед за ценой, как только прибыль превышает сумму `TrailingStopPips + TrailingStepPips`. Минимальный шаг защищает от слишком частых модификаций.

## Управление рисками
- **Тейк-профит / Стоп-лосс** — необязательные расстояния в пипсах. При достижении уровня по цене закрытия позиция закрывается рыночным ордером.
- **Трейлинг-стоп** — повторяет механику MT5: движение должно превысить трейлинг плюс шаг, прежде чем стоп будет подтянут.
- **Объём** — параметр `TradeVolume` заменяет выбор между фиксированным лотом и риском в процентах (`ENUM_LOT_OR_RISK`). Для сложного мани-менеджмента используйте оптимизацию или внешние модули StockSharp.
- **Чистота позиции** — при появлении нового сигнала противоположные позиции закрываются, аналогично функции `ClosePositions` в исходнике.

## Параметры
- **Candle Type** — тип свечей для расчётов (по умолчанию: часовые свечи).
- **CciPeriod** — период сглаживания CCI (14).
- **CciUpperLevel / CciLowerLevel** — уровни перекупленности/перепроданности для CCI (+80 / −80).
- **RsiPeriod** — период RSI (42).
- **RsiUpperLevel / RsiLowerLevel** — триггеры RSI (60 / 30).
- **ReverseSignals** — реверс сигналов (`false` по умолчанию).
- **TradeVolume** — объём рыночного ордера (0.1 по умолчанию).
- **StopLossPips / TakeProfitPips** — стоп-лосс и тейк-профит в пипсах (0 и 140, 0 отключает уровень).
- **TrailingStopPips / TrailingStepPips** — дистанция трейлинг-стопа и минимальный шаг (5 / 5; если дистанция равна 0, трейлинг не используется).

## Особенности реализации
- Используются готовые индикаторы StockSharp и высокоуровневый метод `Bind`, поэтому дополнительные буферы `CopyBuffer` не нужны.
- Управление позицией выполняется на закрытии свечи, как и в MQL-версии, защищённой переменной `PrevBars`.
- Пересчёт пипсов повторяет MT5: шаг цены умножается на 10 для дробных котировок с 3 или 5 десятичными знаками.
- Защитные уровни моделируются рыночными выходами, так как внутри стратегии недоступны синхронные модификации ордеров брокера.
- Для визуального контроля автоматически создаются отдельные области графика с линиями CCI и RSI.

## Отличия от оригинального советника
- Модуль `MoneyFixedMargin` не переносился — объём задаётся напрямую через `TradeVolume`.
- Проверка брокерских ограничений (`FreezeStopsLevels`) недоступна, поэтому трейлинг ориентируется только на расстояние и шаг.
- Журналы и всплывающие сообщения исключены. При необходимости подключайте стандартный логгер StockSharp.
- Закрытия по стопу/тейку выполняются на закрытии бара, а не внутри бара, что делает тестирование детерминированным.

## Рекомендации по использованию
1. Начинайте с часового таймфрейма, соответствующего исходному шаблону. Уменьшение таймфрейма повышает частоту сделок и шум.
2. Оптимизируйте уровни CCI и RSI совместно — стратегия требует одновременного подтверждения двух индикаторов.
3. Для форекс-инструментов убедитесь, что в `Security` заполнены `PriceStep` и `Decimals`, чтобы переводы пипсов были корректными.
4. Оставляйте `ReverseSignals = false` для классической работы от откатов. Включайте реверс для торговли пробоев.
5. При необходимости подключайте внешние модули риск-менеджмента StockSharp (общий стоп по капиталу, ограничение просадки) вместо MT5-библиотеки `m_money`.

Документ содержит всю необходимую информацию для запуска, настройки и дальнейшего расширения стратегии iCCI iRSI в экосистеме StockSharp.
