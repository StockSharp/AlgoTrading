# Стратегия Trend Reversal

## Обзор
Trend Reversal — это направленная стратегия, которая пытается захватить выход цены из небольших откатов внутри существующего тренда. Она перенесена из советника MetaTrader "Trend Reversal" и переписана с использованием высокоуровневого API StockSharp. При переносе сохранены ключевые фильтры подтверждения (скользящие средние, Momentum и MACD), а проверка вручную нарисованных линий тренда заменена на детерминированную проверку перекрытия свечей.

## Набор индикаторов
- **Линейно-взвешенные скользящие средние (LWMA)** по типичной цене с настраиваемыми быстрым и медленным периодами. Быстрая линия отражает последний импульс, медленная — общий тренд.
- **Индикатор Momentum** на том же таймфрейме. Стратегия сохраняет модуль отклонения от уровня 100 для трёх последних закрытых свечей, повторяя логику оригинального советника.
- **Пара линий MACD (основная и сигнальная)** с независимыми периодами быстрых, медленных и сигнальных EMA. Направление гистограммы выступает старшим фильтром для покупок и продаж.

## Логика сделок
1. Ожидается закрытие свечи на заданном таймфрейме. Неформированные бары игнорируются.
2. Проверяется, что обе LWMA и Momentum полностью сформированы. Пока истории недостаточно, сделки не совершаются.
3. Ведётся скользящее окно из трёх последних отклонений Momentum от 100. Сигнал допустим только если хотя бы одно значение превышает соответствующий порог для покупок или продаж.
4. Свеча два бара назад должна иметь минимум ниже максимума предыдущей свечи. Это условие имитирует узкую консолидацию перед пробоем, использовавшуюся в оригинале.
5. Оцениваются направленные фильтры:
   - **Покупка:** быстрая LWMA выше медленной и основная линия MACD выше сигнальной.
   - **Продажа:** быстрая LWMA ниже медленной и основная линия MACD ниже сигнальной.
6. Соблюдается ограничение по чистой позиции. Новая сделка или добавление объёма выполняются только если текущая экспозиция (позиция, делённая на объём сделки) меньше параметра `MaxPositions`.
7. Заявки отправляются методами `BuyMarket()` или `SellMarket()`, что позволяет частично или полностью разворачивать позицию.

## Управление рисками
- При необходимости подключаются **тейк-профит** и **стоп-лосс** (в ценовых единицах) через стандартный защитный блок StockSharp. Если параметр равен нулю, уровень не активируется.
- В данной реализации отсутствуют трейлинг-стоп и перевод в безубыток. Их можно добавить отдельными обработчиками.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Таймфрейм, на котором строятся свечи. | Таймфрейм 15 минут |
| `FastLength` | Период быстрой LWMA. | 6 |
| `SlowLength` | Период медленной LWMA. | 85 |
| `MomentumLength` | Период индикатора Momentum. | 14 |
| `MomentumBuyThreshold` | Минимальное абсолютное отклонение Momentum (от 100) для покупок. | 0.3 |
| `MomentumSellThreshold` | Минимальное абсолютное отклонение Momentum (от 100) для продаж. | 0.3 |
| `MacdFastLength` | Период быстрой EMA в фильтре MACD. | 12 |
| `MacdSlowLength` | Период медленной EMA в фильтре MACD. | 26 |
| `MacdSignalLength` | Период сигнальной EMA в фильтре MACD. | 9 |
| `TakeProfit` | Дистанция тейк-профита в ценовых единицах (0 — отключено). | 50 |
| `StopLoss` | Дистанция стоп-лосса в ценовых единицах (0 — отключено). | 20 |
| `TradeVolume` | Торговый объём одной заявки в лотах. | 1 |
| `MaxPositions` | Максимальное число объёмов `TradeVolume` в чистой позиции. | 1 |

## Практические рекомендации
- Перед запуском убедитесь, что у инструмента корректно настроены шаг цены и шаг стоимости, иначе защитные ордера могут работать неверно.
- Для пирамидинга или добора позиции увеличьте `MaxPositions`. Стратегия будет наращивать объём, пока фильтры остаются активными и лимит не превышен.
- Тестируйте стратегию на том же таймфрейме, что указан в `CandleType`. StockSharp автоматически запросит необходимые данные при старте.
- Поскольку в оригинальном советнике использовались вручную построенные трендовые линии, в портированной версии применена проверка перекрытия свечей, обеспечивающая одинаковое поведение в тестах и реальной торговле.

## Отличия от оригинального советника
- Не реализованы трейлинг-стоп, перевод в безубыток и аварийное закрытие по просадке капитала, чтобы сосредоточиться на основной логике сигналов.
- Убраны функции управления капиталом вроде умножения лота и фильтрации по Magic Number — они не требуются в архитектуре StockSharp.
- MACD рассчитывается на том же таймфрейме, что и торговые свечи, а не на месячных данных, как в MetaTrader. При необходимости можно подписаться на более медленный таймфрейм и привязать MACD к отдельной подписке.

## Подсказки по оптимизации
- Сначала подберите периоды скользящих средних под характер движения инструмента, затем оптимизируйте пороги Momentum.
- На волатильных рынках увеличьте дистанции стоп-лосса и тейк-профита — трендовая логика часто выигрывает от более широких допусков.
- Контролируйте показатели просадки при оптимизации. Повышение `MaxPositions` ускоряет реакцию на тренд, но усиливает риск.
