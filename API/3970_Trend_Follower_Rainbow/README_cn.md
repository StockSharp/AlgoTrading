# 趋势追随彩虹策略

## 概述
趋势追随彩虹策略是 MetaTrader 4 专家顾问“TrendFollowerRainbowMethodkyast773”的 C# 移植版本。策略通过多层确认来捕捉强趋势行情，同时过滤震荡阶段。信号由彩虹式指数移动平均线的排列、MACD 动量、拉盖尔滤波阈值、资金流量指标以及快/慢 EMA 金叉/死叉共同驱动。

## 交易逻辑
1. **交易时段** – 只有当当前 K 线的收盘时间严格位于可配置的起止小时之间时才评估信号，以复刻原始 EA 避开交易日首尾时段的行为。
2. **EMA 交叉触发** – 多头需要快 EMA（默认长度 4）上穿慢 EMA（默认长度 8），空头则要求相反的下穿。
3. **MACD 确认** – MACD 线和信号线（默认 5/35/5）必须同时位于零轴上方才能做多，同时位于零轴下方才能做空，确认趋势方向的动量。
4. **拉盖尔滤波** – 拉盖尔滤波值必须上穿 0.15 才允许做多，下穿 0.75 才允许做空，复现原指标的阈值判断。
5. **彩虹排列** – 五组指数移动平均线（每组四条）必须保持单调排序：多头时要求不递增，空头时要求不递减，以确认彩虹结构的完整性。
6. **资金流量指标过滤** – 资金流量指标（默认周期 14）需要低于 40 才能做多，高于 60 才能做空，避免与资金流向相反交易。
7. **持仓管理** – 使用市价单入场。当出现反向信号时，先平掉当前持仓，再按新方向开仓。

## 风险管理
策略使用 StockSharp 的 `StartProtection` 工具提供内置保护：
- **止盈**与**止损**距离以价格步长表示，与 EA 的点数配置保持一致。
- **跟踪止损**同样以步长设置，一旦启动保护模块即开始工作。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `OrderVolume` | 基础下单手数。 | 1 |
| `TakeProfitPoints` | 止盈距离（价格步长）。 | 17 |
| `StopLossPoints` | 止损距离（价格步长）。 | 30 |
| `TrailingStopPoints` | 跟踪止损距离（价格步长）。 | 45 |
| `TradingStartHour` | 每日跳过信号评估的开始小时。 | 1 |
| `TradingEndHour` | 每日跳过信号评估的结束小时。 | 23 |
| `FastEmaLength` | 快速 EMA 长度。 | 4 |
| `SlowEmaLength` | 慢速 EMA 长度。 | 8 |
| `MacdFastLength` | MACD 快线 EMA 长度。 | 5 |
| `MacdSlowLength` | MACD 慢线 EMA 长度。 | 35 |
| `MacdSignalLength` | MACD 信号线 EMA 长度。 | 5 |
| `LaguerreGamma` | 拉盖尔滤波平滑系数。 | 0.7 |
| `LaguerreBuyThreshold` | 做多所需的拉盖尔上穿阈值。 | 0.15 |
| `LaguerreSellThreshold` | 做空所需的拉盖尔下穿阈值。 | 0.75 |
| `MfiPeriod` | 资金流量指标周期。 | 14 |
| `MfiBuyLevel` | 做多允许的最大 MFI 值。 | 40 |
| `MfiSellLevel` | 做空允许的最小 MFI 值。 | 60 |
| `RainbowGroup{1..5}Base` | 每组彩虹 EMA 的基准长度。通过基准值加上 0/2/4/6 的偏移生成四条 EMA。 | 5 / 13 / 21 / 34 / 55 |
| `CandleType` | 策略使用的主图 K 线类型，默认 5 分钟。 | 5 分钟 |

## 图表
策略会自动绘制：
- 订阅的价格 K 线；
- 快慢 EMA，用于直观观察交叉；
- 拉盖尔滤波曲线，用于跟踪阈值突破；
- 策略成交记录。

## 说明
- 彩虹逻辑使用可配置的 EMA 组合来近似原始的 RainbowMMA 自定义指标，可根据需要调整基准长度以贴合特定模板。
- 代码注释、日志及文档均使用英文，符合项目要求。
- 本次任务仅提供 C# 实现，未生成 Python 版本。
