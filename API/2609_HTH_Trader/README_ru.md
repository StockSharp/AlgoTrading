# Стратегия HTH Trader Hedge

## Описание

Стратегия представляет собой перенос эксперта MetaTrader «HTH Trader». Она торгует корзину из четырёх валютных пар, пытаясь использовать дневное расхождение между EURUSD и зеркальной комбинацией USDCHF, GBPUSD и AUDUSD. Реализация для StockSharp сохраняет первоначальные правила по времени, управлению риском и экстренному усреднению.

Основные особенности:

- Один раз в сутки, в промежутке 00:05–00:12 по серверному времени, формируется хедж из четырёх позиций.
- Направление корзины определяется знаком изменения закрытия EURUSD за предыдущие два торговых дня.
- Одновременно управляет четырьмя инструментами: EURUSD (основной), USDCHF, GBPUSD и AUDUSD.
- Подсчитывает общий нереализованный результат в пунктах и поддерживает дневные цели по прибыли и убытку.
- Содержит аварийную функцию удвоения прибыльных ног при достижении заданной просадки.
- Закрывает все позиции в 23:00 или при срабатывании целевых значений.

## Требования к данным

- **Внутридневные свечи**: все четыре инструмента должны предоставлять свечи выбранного таймфрейма (`IntradayCandleType`, по умолчанию 5 минут) для контроля времени и текущей цены.
- **Дневные свечи**: для каждого инструмента необходимы дневные свечи, чтобы отслеживать два последних закрытия.

## Логика работы

1. После формирования каждой внутридневной свечи стратегия вычисляет суммарную прибыль в пунктах:
   - При включённом `AllowEmergencyTrading` и просадке ≤ `-EmergencyLossPips` происходит удвоение всех прибыльных ног, после чего аварийная функция отключается до следующего дня.
   - При активном `UseProfitTarget` и прибыли ≥ `ProfitTargetPips` корзина закрывается.
   - При активном `UseLossLimit` и убытке ≤ `-LossLimitPips` корзина закрывается.
2. В 23:00 все позиции закрываются независимо от результата.
3. Когда позиций нет и текущее время попадает в окно 00:05–00:12, анализируются два последних дневных закрытия EURUSD:
   - **Положительное** изменение запускает покупки EURUSD, USDCHF и AUDUSD и продажу GBPUSD.
   - **Отрицательное** изменение приводит к продажам EURUSD, USDCHF и AUDUSD и покупке GBPUSD.
   - При нулевом изменении или отсутствии данных торговля пропускается.
4. Закрытие осуществляется рыночными заявками через `ClosePosition`.

## Параметры

| Имя | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `TradeEnabled` | Разрешение на выставление сделок. | `true` |
| `ShowProfitInfo` | Логирование текущей прибыли корзины в пунктах. | `true` |
| `UseProfitTarget` | Автоматическое закрытие по цели прибыли. | `false` |
| `UseLossLimit` | Автоматическое закрытие по пределу убытка. | `false` |
| `AllowEmergencyTrading` | Разрешение аварийного удвоения. | `true` |
| `EmergencyLossPips` | Просадка в пунктах для запуска удвоения. | `60` |
| `ProfitTargetPips` | Цель по прибыли (пункты). | `80` |
| `LossLimitPips` | Допустимый убыток (пункты). | `40` |
| `TradingVolume` | Объём каждой ноги. | `0.01` |
| `Symbol2` | Второй инструмент (USDCHF по умолчанию). | `null` |
| `Symbol3` | Третий инструмент (GBPUSD по умолчанию). | `null` |
| `Symbol4` | Четвёртый инструмент (AUDUSD по умолчанию). | `null` |
| `IntradayCandleType` | Таймфрейм внутренних свечей. | Свечи 5 минут |

## Рекомендации по использованию

- Назначьте `Strategy.Security` на EURUSD (или другой ведущий актив) и заполните параметры `Symbol2`, `Symbol3`, `Symbol4` соответствующими бумагами до запуска.
- Убедитесь, что для каждого инструмента задан корректный `PriceStep`; без него расчёт пунктов невозможен и аварийная логика не сработает.
- Аварийное удвоение применяется только к прибыльным ногам, чтобы не увеличивать текущий убыток.
- Предполагается исполнение рыночных заявок около цены закрытия последней свечи; для точного повторения необходимо обеспечить стабильный поток внутридневных данных.
- Поскольку стратегия реагирует на закрытие свечей, возможны небольшие отличия по времени входа относительно тиковой версии в MetaTrader, однако последовательность решений полностью соответствует оригиналу.
