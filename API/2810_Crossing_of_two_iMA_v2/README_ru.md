# Стратегия Crossing of Two iMA v2

## Обзор
Эта стратегия переносит советник MetaTrader «Crossing of two iMA v2» на высокоуровневый API StockSharp. Сигналы возникают при пересечении двух смещённых скользящих средних, а при необходимости направление дополнительно подтверждается третьей средней. Встроенные стоп-приказы, фиксированное или процентное управление объёмом и ступенчатое трейлинг-сопровождение сделок воспроизводят поведение оригинального робота и остаются совместимыми с правилами разработки StockSharp.

## Индикаторы и входные данные
- **Первая скользящая средняя** – настраиваемые период, сдвиг, метод сглаживания и тип цены.
- **Вторая скользящая средняя** – отдельный набор параметров, позволяющий задать другую конфигурацию.
- **Фильтр третьей скользящей средней** – опциональный трендовый фильтр; лонги разрешаются только когда первая средняя ниже фильтра, шорты – когда выше фильтра.
- **Тип свечей** – указывает таймфрейм/источник данных для подписки на свечи.

## Логика торговли
### Шаг 1 – мгновенное пересечение
1. После закрытия каждой свечи стратегия обновляет значения всех скользящих средних в соответствии с выбранными типами цен.
2. **Лонг** открывается, если первая средняя пересекает вторую **снизу вверх** между предыдущей и текущей свечой.
3. **Шорт** открывается, если первая средняя пересекает вторую **сверху вниз** между предыдущей и текущей свечой.
4. При активном фильтре для лонга требуется, чтобы первая средняя оставалась **ниже** фильтра; для шорта – чтобы первая средняя была **выше** фильтра.

### Шаг 2 – подтверждение с задержкой
Если на Шаге 1 сигнал не сформировался, стратегия проверяет, не произошло ли пересечение двумя барами ранее и остаётся ли оно актуальным. Это повторяет логику оригинального советника, который анализирует недавнюю историю. Для предотвращения повторных входов сигнал допускается только спустя минимум три свечи после последней сделки.

### Исполнение сделок
- Входы выполняются по рыночной цене. Противоположные позиции закрываются перед открытием в новом направлении.
- Выход происходит при достижении стоп-лосса, тейк-профита или трейлинг-стопа. Как только цена касается защитного уровня на текущей свече, позиция закрывается рыночной заявкой.

## Управление рисками
- **Стоп-лосс** и **тейк-профит** задаются в пипсах. Для получения ценового смещения значения умножаются на `PriceStep` инструмента (при отсутствии шага используется значение `1`).
- **Трейлинг-стоп** стартует от цены входа и сопровождает позицию при движении в прибыль. Новый уровень фиксируется, когда лучшая цена улучшилась минимум на `TrailingStepPips` пипсов относительно предыдущего уровня.
- Если одновременно активны обычный стоп и трейлинг, стратегия выбирает более консервативный уровень (выше для лонга, ниже для шорта).

## Управление объёмом
- При `UseRiskPercent = true` объём рассчитывается как `Equity * RiskPercent / (StopLossPips * PipValue)`. При отсутствии стопа используется резервный фиксированный объём.
- При `UseRiskPercent = false` всегда применяется значение `FixedVolume`.
- Параметр `PipValue` должен отражать денежную стоимость одного пипса на один лот/контракт выбранного инструмента.

## Особенности реализации
- Реализация работает только по закрытым свечам и не регистрирует отложенные заявки. При необходимости лимитных/стоповых входов стратегию можно расширить.
- Фильтр третьей средней можно отключить, чтобы торговать каждое пересечение (аналог `InpFilterMA = false` в исходном роботе).
- Для корректного управления рисками проверьте соответствие типа свечей, шага цены и стоимости пипса торгуемому инструменту.

## Параметры
| Название | Описание | Значение по умолчанию |
| --- | --- | --- |
| `FirstPeriod` | Период первой скользящей средней. | 5 |
| `FirstShift` | Сдвиг (в барах) выходного значения первой средней. | 3 |
| `FirstMethod` | Метод сглаживания первой средней (`Simple`, `Exponential`, `Smoothed`, `Weighted`). | `Smoothed` |
| `FirstAppliedPrice` | Тип цены для расчёта первой средней (`Close`, `Open`, `High`, `Low`, `Median`, `Typical`, `Weighted`). | `Close` |
| `SecondPeriod` | Период второй скользящей средней. | 8 |
| `SecondShift` | Сдвиг (в барах) выходного значения второй средней. | 5 |
| `SecondMethod` | Метод сглаживания второй средней. | `Smoothed` |
| `SecondAppliedPrice` | Тип цены для расчёта второй средней. | `Close` |
| `UseFilter` | Включает фильтр третьей скользящей средней. | `true` |
| `ThirdPeriod` | Период фильтрующей скользящей средней. | 13 |
| `ThirdShift` | Сдвиг (в барах) фильтрующей средней. | 8 |
| `ThirdMethod` | Метод сглаживания фильтра. | `Smoothed` |
| `ThirdAppliedPrice` | Тип цены для фильтра. | `Close` |
| `UseRiskPercent` | Переключение между фиксированным объёмом и риском в процентах. | `true` |
| `FixedVolume` | Объём сделки при фиксированном управлении. | 0.1 |
| `RiskPercent` | Доля капитала, которую допускается рискнуть в сделке. | 5 |
| `PipValue` | Денежная стоимость одного пипса для одного лота/контракта. | 1 |
| `StopLossPips` | Размер стоп-лосса в пипсах. | 50 |
| `TakeProfitPips` | Размер тейк-профита в пипсах. | 50 |
| `TrailingStopPips` | Размер трейлинг-стопа в пипсах. | 10 |
| `TrailingStepPips` | Минимальный шаг, на который должен сдвинуться трейлинг-стоп. | 4 |
| `CandleType` | Тип свечей/таймфрейм, используемый стратегией. | Свечи 1 минуты |

