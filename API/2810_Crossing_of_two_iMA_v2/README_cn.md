# Crossing of Two iMA v2 策略

## 概述
该策略将 MetaTrader 中的 “Crossing of two iMA v2” 专家顾问迁移到 StockSharp 的高级 API。策略利用两条带位移的移动平均线产生交叉信号，并可选用第三条移动平均线作为趋势过滤。通过止损/止盈、防御性追踪止损以及固定或按风险百分比计算的持仓量，尽可能重现原始 EA 的行为，同时满足 StockSharp 的开发规范。

## 指标与输入
- **第一条移动平均线**：可设置周期、位移、平滑方法以及取价方式。
- **第二条移动平均线**：拥有独立的一组配置参数。
- **第三条移动平均线过滤器**：可选的趋势过滤器；只有当第一条均线位于过滤均线下方时才允许做多，位于过滤均线上方时才允许做空。
- **K线类型**：定义订阅数据的时间框架/数据源。

## 交易逻辑
### 步骤 1 – 即时交叉
1. 每根收盘 K 线都会使用选定的价格类型更新所有移动平均指标。
2. 当第一条均线在上一根与当前 K 线之间上穿第二条均线时触发**多头**信号。
3. 当第一条均线在上一根与当前 K 线之间下穿第二条均线时触发**空头**信号。
4. 启用过滤器时，多头信号要求第一条均线保持在过滤均线下方；空头信号要求第一条均线保持在过滤均线上方。

### 步骤 2 – 延迟确认
若步骤 1 未出现信号，策略会检查两根 K 线之前是否发生过交叉且仍然有效。这与原始 EA 会回溯近几根 K 线寻找遗漏信号的逻辑一致。为避免重复交易，只有在距离上一次成交至少 3 根 K 线后才允许触发该补充信号。

### 下单方式
- 所有进场均采用市价单执行，若已有反向持仓会先平仓再建仓。
- 当价格在当前 K 线触及止损、止盈或追踪止损价位时立即以市价单离场。

## 风险控制
- **止损**与**止盈**以点（pip）为单位设定，并根据交易品种的 `PriceStep`（若缺省则使用 1）换算为价格差。
- **追踪止损**从入场价开始，随着价格向有利方向移动而上调。当最佳价格较上一止损位至少前进 `TrailingStepPips` 个点时，更新新的追踪止损。
- 当固定止损与追踪止损同时存在时，策略会采用更保守的一侧（多头取较高价，空头取较低价）。

## 仓位管理
- 当 `UseRiskPercent` 为 **true** 时，持仓量按 `Equity * RiskPercent / (StopLossPips * PipValue)` 计算。如果没有有效的止损设置，则回退到固定持仓量。
- 当 `UseRiskPercent` 为 **false** 时，始终使用 `FixedVolume`。
- `PipValue` 应填写单手/单合约每个点的货币价值，以便正确换算风险。

## 实现细节
- 策略仅基于收盘 K 线运行，并不会注册任何挂单。若需要止损/限价入场，可以在此基础上扩展实现。
- 可关闭第三条移动平均线过滤器，从而在每次交叉时都交易（对应原始 EA 的 `InpFilterMA = false`）。
- 请根据具体品种正确设置 K 线类型、价格最小变动及点值参数，以确保风险管理准确。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `FirstPeriod` | 第一条移动平均线的周期。 | 5 |
| `FirstShift` | 第一条移动平均线输出值的位移（以 K 线数计）。 | 3 |
| `FirstMethod` | 第一条移动平均线的平滑方法（`Simple`、`Exponential`、`Smoothed`、`Weighted`）。 | `Smoothed` |
| `FirstAppliedPrice` | 第一条移动平均线的取价方式（`Close`、`Open`、`High`、`Low`、`Median`、`Typical`、`Weighted`）。 | `Close` |
| `SecondPeriod` | 第二条移动平均线的周期。 | 8 |
| `SecondShift` | 第二条移动平均线的位移。 | 5 |
| `SecondMethod` | 第二条移动平均线的平滑方法。 | `Smoothed` |
| `SecondAppliedPrice` | 第二条移动平均线的取价方式。 | `Close` |
| `UseFilter` | 是否启用第三条移动平均线过滤器。 | `true` |
| `ThirdPeriod` | 第三条移动平均线的周期。 | 13 |
| `ThirdShift` | 第三条移动平均线的位移。 | 8 |
| `ThirdMethod` | 第三条移动平均线的平滑方法。 | `Smoothed` |
| `ThirdAppliedPrice` | 第三条移动平均线的取价方式。 | `Close` |
| `UseRiskPercent` | 切换固定仓位与风险百分比持仓的开关。 | `true` |
| `FixedVolume` | 固定持仓模式下的下单数量。 | 0.1 |
| `RiskPercent` | 单笔交易允许承担的账户资金百分比。 | 5 |
| `PipValue` | 单手/单合约每个点的货币价值。 | 1 |
| `StopLossPips` | 止损距离（点）。 | 50 |
| `TakeProfitPips` | 止盈距离（点）。 | 50 |
| `TrailingStopPips` | 追踪止损距离（点）。 | 10 |
| `TrailingStepPips` | 追踪止损最小调节步长（点）。 | 4 |
| `CandleType` | 策略使用的 K 线数据类型/时间框架。 | 1 分钟 K 线 |

