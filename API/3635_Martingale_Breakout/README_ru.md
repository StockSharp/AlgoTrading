# Стратегия Martingale Breakout

## Общее описание

**Martingale Breakout Strategy** — порт MetaTrader-советника `MartinGaleBreakout.mq5` на платформу StockSharp. Алгоритм ждет
аномально крупной свечи-пробоя и открывает единственную сделку в направлении пробоя. В оригинале управление позициями ведется
через «магический номер», но в StockSharp это достигается изоляцией стратегии, поэтому поведение полностью совпадает.

В основе системы лежат две идеи:

1. **Фильтр пробоев.** Для каждой завершённой свечи рассчитывается диапазон (`High - Low`) и сравнивается со средним диапазоном
   предыдущих десяти свечей. Если текущая свеча более чем втрое шире среднего и закрывается в сторону пробоя, формируется сигнал.
2. **Восстановление по типу мартингейла.** Стратегия отслеживает нереализованную прибыль/убыток. Когда плавающий результат
   достигает заданного убытка, все позиции закрываются, а цель по прибыли увеличивается на размер потери. После выполнения новой
   цели значения порогов возвращаются к исходным, как и в версии на MQL5.

Порт сохраняет все параметры управления капиталом из исходника: процент баланса, доступный под маржу, целевую прибыль и стоп в
процентах от баланса, а также множитель, расширяющий дистанцию тейк-профита при восстановлении.

## Логика торговли

1. Подписаться на заданный тип свечей и обрабатывать только завершенные бары.
2. Поддерживать кольцевой буфер из десяти диапазонов, чтобы вычислять эталонное среднее для определения «аномальности» свечи.
3. Рассчитывать плавающий PnL через средние цены входа для лонгов и шортов. При достижении целевой прибыли или стоп-убытка
   немедленно закрывать позиции и сбрасывать состояние восстановления.
4. Не открывать новые сделки, пока у стратегии уже есть позиция либо торговля недоступна по состоянию соединения.
5. При бычьем пробое вычислять объем так, чтобы ожидаемая прибыль соответствовала текущей цели. Во время восстановления расстояние
   до тейк-профита умножается на `RecoveryPointsMultiplier`, аналог `TP_Points_Multiplier` в MQL5.
6. Проверять рассчитанный объем на соответствие шагу, минимуму и максимуму инструмента, а также на достаточность маржи. При
   прохождении проверок отправлять рыночную заявку на покупку.
7. При медвежьем пробое повторять процедуру и выставлять рыночную заявку на продажу.

Такой набор правил полностью воспроизводит поведение оригинального советника, включая переход в режим восстановления после
срабатывания стоп-лосса.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `TakeProfitPoints` | Расстояние от входа до тейк-профита в шагах цены. | `50` |
| `BalancePercentAvailable` | Максимальный процент баланса, который можно задействовать под маржу. | `50` |
| `TakeProfitPercentOfBalance` | Целевая прибыль в процентах от текущего баланса. | `0.1` |
| `StopLossPercentOfBalance` | Стоп-убыток в процентах от текущего баланса. | `10` |
| `RecoveryStartFraction` | Доля стоп-убытка, используемая до включения режима восстановления. | `0.1` |
| `RecoveryPointsMultiplier` | Множитель дистанции тейк-профита во время восстановления. | `1` |
| `CandleType` | Тип свечей, по которым строятся сигналы (таймфрейм, тиковые свечи и т. д.). | `15-минутные свечи` |

## Дополнительные замечания

- Расчет объема повторяет помощник `CalcLotWithTP`: целевая прибыль делится на ожидаемое движение и переводится в объем с
  учётом шага объема инструмента.
- Проверка маржи выполнена по аналогии с функциями `CheckVolumeValue` и ограничением доли баланса из оригинального кода.
  Заявки отклоняются, если требуемая маржа превышает выделенный процент или свободные средства портфеля.
- Перед закрытием позиций стратегия отменяет активные заявки, что соответствует поведению `CloseAllOrders` в MQL5.
- Буфер диапазонов хранит только десять значений, полностью заменяя цикл по `iHigh`/`iLow` из исходного советника и не
  требуя загрузки глубокой истории.
