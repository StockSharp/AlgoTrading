# Стратегия Lucky Code
[English](README.md) | [中文](README_cn.md)

Lucky Code — это скальпер, перенесённый с оригинального советника MetaTrader «Lucky_code». Стратегия следит за экстремальными изменениями между лучшим бидом и аском и реагирует, когда спрэд расширяется или сужается на заданное количество пунктов. Сделки сопровождаются агрессивным управлением: прибыль фиксируется сразу после выгодного тика, а убыток ограничивается при превышении допустимого отклонения.

## Данные и исполнение

- **Рыночные данные**: необходим поток котировок Level 1, предоставляющий актуальные значения лучшего bida и aska.
- **Типы заявок**: для входа и выхода используются рыночные приказы, что повторяет тик-ориентированную логику версии на MQL.
- **Режим позиций**: подходит как для неттинговых, так и для хеджевых счетов. Несколько сделок суммируются в единую нетто-позицию и управляются общим блоком.

## Параметры

- **Shift points** — минимальное количество пунктов между последовательными котировками, при котором допускается новый вход. Чем выше значение, тем меньше сделок и шума.
- **Limit points** — максимально допустимое неблагоприятное смещение цены, после которого позиция принудительно закрывается. Параметр переводится в цену с учётом шага тика инструмента.

## Логика торговли

1. **Инициализация**
   - Конвертирует параметр в пунктах в денежный эквивалент через шаг цены инструмента.
   - Подписывается на поток Level 1 и обнуляет внутренние переменные последнего bida/aska.
2. **Правила входа**
   - Если лучший ask вырос минимум на заданный шаг относительно предыдущего значения, стратегия открывает короткую позицию (аналогично исходному советнику, который продавал на всплесках).
   - Если лучший bid упал на тот же шаг ниже предыдущего значения, стратегия открывает длинную позицию в расчёте на возврат.
3. **Размер позиции**
   - Базовый объём берётся из свойства `Volume` стратегии.
   - При наличии стоимости портфеля объём увеличивается до `round(Equity / 10 000, 1)` лота, что соответствует расчёту `AccountFreeMargin/10000` в MetaTrader.
4. **Правила выхода**
   - Длинная позиция закрывается сразу, как только bid превышает среднюю цену входа, либо если ask снизился от цены входа на величину лимита.
   - Короткая позиция закрывается, когда ask опускается ниже цены входа, либо когда bid поднимается выше на заданный лимит.

## Практические замечания

- Стратегия реагирует на каждый тик, поэтому на «шумных» потоках имеет смысл повышать параметр Shift или фильтровать данные.
- Рыночные заявки требуют достаточной ликвидности, иначе всплески спрэда могут привести к нежелательным проскальзываниям.
- Рекомендуется дополнить стратегию портфельными ограничениями: дневной стоп, лимит по просадке, контроль максимального количества открытых сделок.
