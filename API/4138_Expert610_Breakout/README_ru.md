# Стратегия Expert610 Breakout

## Обзор
Expert610 Breakout — это порт на C# советника MetaTrader 4 `Expert610.mq4`. Исходный робот отслеживает широкую свечу и
выставляет симметричные отложенные заявки Buy Stop и Sell Stop вокруг максимумов и минимумов предыдущего бара. Размер позиции
рассчитывается как доля свободного капитала, который трейдер готов рискнуть, а параметры стоп-лосса и тейк-профита задаются в
пунктах. Реализация на StockSharp повторяет эту логику с использованием высокоуровневого API и предоставляет все настройки через
параметры стратегии.

## Торговая логика
1. **Сбор данных**
   - Стратегия подписывается на выбранный тип свечей и сохраняет последнюю закрытую свечу.
   - Из подписки на стакан рассчитывается текущий спрэд. Если актуальных котировок нет, спрэд считается равным нулю — как и в
     оригинальном советнике при отсутствии онлайн-спрэда.
2. **Фильтр волатильности**
   - Разница между максимумом предыдущей свечи и текущей ценой закрытия, а также между текущим закрытием и минимумом
     предыдущей свечи должна быть не меньше `ThresholdPips` (переведённого в цену).
   - Открытие текущей свечи должно находиться ниже предыдущего максимума для лонга и выше предыдущего минимума для шорта. При
     выполнении обеих условий стратегия размещает обе заявки.
3. **Выставление ордеров**
   - Buy Stop устанавливается по формуле `предыдущий максимум + BreakoutOffset + спрэд`, что соответствует MT4, где применяется
     цена Ask.
   - Sell Stop размещается по формуле `предыдущий минимум - BreakoutOffset` — без учёта спрэда, как и в оригинальном коде.
   - Одновременно может существовать только одна пара отложенных ордеров. Если активный ордер ещё висит, новый сигнал
     игнорируется.
4. **Управление риском**
   - Объём сделки = (свободный капитал `Portfolio.CurrentValue - Portfolio.BlockedValue`) × `RiskPercent / 100`, округлённый до
     `RoundingDigits` и переведённый в лоты по формуле MT4 `lot = risk / stopPips * 0.1`. Формула предполагает, что 0.1 лота даёт
     стоимость одного пункта, равную одной единице валюты счёта.
   - Объём дополнительно нормируется по `VolumeStep`, ограничивается `MinVolume`/`MaxVolume` инструмента и параметром
     `MinimumVolume`, чтобы заказ всегда соответствовал биржевым требованиям.
   - `StartProtection` автоматически привязывает стоп и цель (в ценовых единицах) к каждой открытой позиции, моментально включая
     заданные `StopLossPips` и `TakeProfitPips`.

## Параметры
| Имя | Описание | Значение по умолчанию | Примечания |
| --- | --- | --- | --- |
| `RoundingDigits` | Количество знаков после запятой при расчёте риска и объёма. | `2` | Значение ≥ 0. |
| `RiskPercent` | Процент свободного капитала на одну сделку. | `1` | При `0` стратегия использует `MinimumVolume`. |
| `MinimumVolume` | Минимально допустимый объём отложенного ордера. | `0.1` | Также учитываются `MinVolume` и `VolumeStep` инструмента. |
| `ThresholdPips` | Минимальная дистанция от цены закрытия до экстремумов предыдущей свечи. | `5` | Указывается в пунктах. |
| `BreakoutOffsetPips` | Дополнительное смещение выше/ниже экстремумов при постановке ордера. | `2` | Применяется для обеих сторон. |
| `StopLossPips` | Дистанция стоп-лосса. | `5` | Передаётся в `StartProtection`. |
| `TakeProfitPips` | Дистанция тейк-профита. | `10` | Можно установить `0`, чтобы отключить. |
| `CandleType` | Тип свечей для расчёта уровней. | Таймфрейм 1 час | Поддерживаются любые `DataType` StockSharp. |

## Особенности реализации
- Размер пункта вычисляется на основе `PriceStep` и `Decimals` инструмента (для 3- и 5-знаковых валютных пар используется множитель 10) —
  так же, как в MQL4.
- Нормализация объёма учитывает `VolumeStep`, ограничивает значения в пределах `MinVolume`/`MaxVolume`, а затем применяет порог
  `MinimumVolume`, чтобы исключить невыполнимые заявки.
- Компенсация спрэда строится на лучших котировках из стакана. Если данные недоступны, входные цены совпадают с MT4-версией без
  учёта спрэда.
- После смены состояния ордера на исполненный/отменённый/ошибочный он удаляется из внутреннего состояния, что позволяет сразу
  подготовить новую пару ордеров на следующую подходящую свечу.

## Отличия от версии MQL
- Помимо округления по `Digits2Round`, реализация на StockSharp дополнительно подгоняет объём под шаг объёма биржи.
- Вместо передачи стопов и тейков в момент создания ордера используется `StartProtection`, автоматически выставляющий защитные
  заявки после фактического открытия позиции.
- В качестве источника свободного капитала используются поля `Portfolio.CurrentValue` и `Portfolio.BlockedValue`. При отсутствии
  данных стратегия возвращается к фиксированному минимальному объёму.
- Все вычисления выполняются только по закрытым свечам, что исключает внутридневные перерисовки и соответствует логике вызова
  `start()` в конце бара.
