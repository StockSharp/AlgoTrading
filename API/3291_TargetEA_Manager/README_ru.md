# Target EA Manager Strategy

## Обзор
**Target EA Manager Strategy** — это перенос MetaTrader-советника *TargetEA_v1.5* на платформу StockSharp. Стратегия не открывает новые сделки: она отслеживает текущие ордера стратегии и при достижении заданных порогов закрывает позиции и снимает отложенные заявки. Поведение полностью повторяет «корзинную» логику оригинала: длинные и короткие позиции можно оценивать раздельно либо как единую корзину.

Стратегия подписывается на котировки Level1 (лучшие bid/ask) и использует высокоуровневый API для закрытия позиций и отмены заявок. Актуальные цены преобразуются в показатели нереализованной прибыли и убытка по каждой стороне.

## Ключевые особенности
- **Раздельные или общие корзины** — параметр `ManageBuySellOrders` определяет, рассматриваются ли покупки и продажи отдельно или совместно.
- **Несколько типов целей** — пороговые значения могут задаваться в пунктах, в валюте на лот или в процентах от баланса (`TypeTargetUse`).
- **Два типа триггеров** — флаги `CloseInProfit` и `CloseInLoss` разрешают реагирование на плавающую прибыль или убыток.
- **Очистка отложенных заявок** — при закрытии корзины можно автоматически снять соответствующие buy- или sell-ордера.
- **Высокоуровневые операции** — используется `BuyMarket`/`SellMarket` для рыночных выходов и прямой обход коллекции заявок для отмены pending-ордеров.

## Параметры
| Параметр | Описание |
|----------|----------|
| `ManageBuySellOrders` | `Separate` — раздельные корзины для лонгов и шортов, `Combined` — совмещённая корзина. |
| `CloseBuyOrders` / `CloseSellOrders` | Разрешают закрывать соответствующую сторону при срабатывании условий. |
| `DeleteBuyPendingPositions` / `DeleteSellPendingPositions` | Удаляют активные отложенные заявки после закрытия корзины. |
| `TypeTargetUse` | Выбор метрики: пункты (`Pips`), валюта на лот (`CurrencyPerLot`) или процент от баланса (`PercentageOfBalance`). |
| `CloseInProfit` / `CloseInLoss` | Включают реакцию на прибыль или убыток. |
| `TargetProfitInPips`, `TargetLossInPips` | Порог в пунктах. При наличии `PriceStep` пункт вычисляется как `разница цены / PriceStep * (объём / VolumeStep)`. |
| `TargetProfitInCurrency`, `TargetLossInCurrency` | Порог в валюте на лот, перед сравнением умножается на текущий объём. |
| `TargetProfitInPercentage`, `TargetLossInPercentage` | Порог в процентах от баланса. Как и в оригинале, плавающая прибыль сравнивается с `Balance ± Balance * Percentage / 100`. |

## Алгоритм работы
1. **Учёт состояния** — обработчик сделок обновляет объёмы и средние цены по длинной и короткой стороне, что позволяет корректно вести хеджевые позиции.
2. **Расчёт PnL** — по каждому обновлению Level1 пересчитываются пункты и прибыль/убыток в валюте для обеих сторон.
3. **Проверка условий** — в зависимости от выбранного режима корзин и типа цели выполняются сравнения с порогами (для прибыли — `>=`, для убытка — `<=`).
4. **Ликвидация корзины** — при срабатывании условия стратегия при необходимости снимает pending-ордера и отправляет рыночные заявки для закрытия открытого объёма.

Реализация не вводит дополнительных коллекций и полностью опирается на высокоуровневые инструменты StockSharp, что соответствует духу MQL-оригинала.
