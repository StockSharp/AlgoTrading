# Стратегия Next Bar Momentum
[English](README.md) | [中文](README_cn.md)

Эта стратегия торгует импульсные пробои, которые возникают, когда последний завершённый бар закрывается значительно дальше старого контрольного бара. Она создана на основе советника MetaTrader «Nextbar» и сохраняет оригинальные механизмы управления рисками: стопы в пунктах, трейлинг и ограничение срока жизни позиции.

Конфигурация по умолчанию рассчитана на быстро движущиеся валютные пары или индексные фьючерсы с таймфреймом 15 минут, однако логику можно применять к любому инструменту, предоставляющему стандартные свечи. Все заявки исполняются по рынку с заданным объёмом.

## Торговая логика

- **Поиск сигнала**
  - После закрытия нового бара алгоритм сравнивает цену закрытия предыдущего бара с закрытием, которое произошло `SignalBar` баров назад.
  - Если предыдущее закрытие выше удалённого закрытия более чем на `MinDistancePips`, формируется длинный сигнал.
  - Если предыдущее закрытие ниже удалённого закрытия более чем на `MinDistancePips`, формируется короткий сигнал.
  - Флаг `ReverseSignals` инвертирует направления сигналов для контртрендовых сценариев.
- **Обработка заявок**
  - Пока позиция открыта, новые сигналы игнорируются — стратегия, как и оригинальный советник, удерживает только одну позицию.
  - После входа сохраняется цена открытия и заранее рассчитываются уровни стоп-лосса и тейк-профита в ценовых величинах. Значения в пунктах переводятся через минимальный шаг цены инструмента (для пятизнака автоматически используется множитель ×10, чтобы соответствовать метатрейдеровскому понятию пункта).

## Правила выхода

- **Стоп-лосс и тейк-профит** – Оба уровня необязательны. Нулевое значение отключает соответствующую защиту. Стратегия контролирует минимумы и максимумы свечей, чтобы закрыть позицию при достижении уровней.
- **Трейлинг-стоп** – При включении (`TrailingStopPips` > 0) стоп переносится ближе к текущей цене, как только прибыль превышает `TrailingStopPips + TrailingStepPips`. Расстояние между ценой и стопом никогда не сокращается, что обеспечивает монотонный трейлинг.
- **Срок жизни позиции** – После нахождения в рынке `LifetimeBars` завершённых свечей позиция закрывается на открытии следующего бара независимо от результата. Это повторяет исходный механизм «закрыть через N баров».

## Параметры

- `CandleType` – Таймфрейм, на котором оцениваются сигналы. По умолчанию — 15-минутные свечи.
- `OrderVolume` – Объём каждой рыночной заявки.
- `StopLossPips` – Расстояние от цены входа до защитного стопа в пунктах.
- `TakeProfitPips` – Расстояние от цены входа до цели по прибыли в пунктах.
- `TrailingStopPips` – Расстояние, поддерживаемое трейлинг-стопом. Ноль отключает трейлинг.
- `TrailingStepPips` – Дополнительная прибыль, необходимая для очередного переноса трейлинг-стопа. Игнорируется, если трейлинг отключён.
- `SignalBar` – Количество баров между сравниваемыми закрытиями. Минимум два, чтобы не использовать текущую свечу.
- `MinDistancePips` – Минимальная дистанция в пунктах между закрытиями для подтверждения сигнала.
- `LifetimeBars` – Максимальное количество завершённых свечей, которые позиция может находиться в рынке. Ноль отключает таймер.
- `ReverseSignals` – Инвертирует длинные и короткие сигналы.

## Особенности реализации

- Для расчёта используется короткий скользящий список закрытий, что позволяет обходиться без тяжёлых структур исторических данных.
- Перевод пунктов в цены выполняется через шаг цены инструмента. Для котировок с 3 или 5 знаками после запятой автоматически используется традиционное определение пункта.
- Все правила риска контролируются по завершённым свечам. Для внутрибаральной защиты можно сочетать стратегию с биржевыми стоп-заявками через настройки платформы.
- Автоматические тесты для примера не поставляются. Обязательно проверяйте стратегию на истории перед реальной торговлей.
