# XP Trade Manager Grid (порт StockSharp)

## Общее описание стратегии
Оригинальный советник **XP Trade Manager Grid** управляет сеткой усредняющих позиций: когда цена
идёт против последней сделки на фиксированное число пунктов, открывается следующая позиция с
комментарием `order1`, `order2`, …, `order15`. Первые три уровня имеют собственные цели по прибыли,
а начиная с четвёртого используется расчет безубыточной цены плюс дополнительная прибыль. При
достижении целевой прибыли весь «корзинный» портфель закрывается. Советник также накапливает
прибыль, полученную первым ордером, и заново открывает `order1`, если последняя фиксация прибыли
не дотянула до суммарного порога.

Реализация на StockSharp воспроизводит эти правила управления позицией через высокоуровневый API
репозитория (`SubscribeCandles().Bind(...)`). Свечи используются лишь как триггеры — после закрытия
каждой свечи стратегия считывает актуальные цены Bid/Ask и проверяет все условия по дистанциям и
прибыли.

## Ход выполнения
1. **Подписка на данные.** Стратегия подписывается на выбранный тип свечей. Индикаторы не нужны,
   поскольку логика целиком опирается на ценовые разницы.
2. **Контроль тейк-профитов уровней 1–3.** После завершения свечи проверяется, достигли ли первые
   три ордера своих индивидуальных целей (`TakeProfit1Partitive`, `TakeProfit2`, `TakeProfit3`). При
   срабатывании соответствующий объём закрывается рыночным ордером с комментарием `orderN_tp`.
3. **Расширение сетки.** Если последняя позиция в направлении ушла в минус минимум на
   `AddNewTradeAfter` пунктов, отправляется следующий ордер (`order{N+1}`) — но не больше, чем
   разрешает `MaxOrders`. Параллельно ведётся учёт заявок в регистрации, чтобы не отправлять дубликаты.
4. **Общий тейк-профит.** Когда открыто четыре и более позиций, рассчитывается средневзвешенная
   цена безубыточности и к ней прибавляется суммарная цель для текущего количества ордеров. Если
   цена пересекает этот уровень, вся сетка закрывается ордером с комментарием `breakeven_exit`.
5. **Контроль риска.** На каждой свече вычисляется плавающий результат. Если убыток превышает
   `RiskPercent` процентов от стоимости портфеля, все позиции принудительно закрываются с пометкой
   `risk_exit`.
6. **Переоткрытие первого ордера.** После закрытия `order1` (как по индивидуальному тейк-профиту,
   так и при общем выходе) сохраняются заработанные пункты, прибыль в валюте и направление сделки.
   Если суммарная прибыль всё ещё ниже `TakeProfit1Total`, а цена отошла от последнего тейк-профита
   минимум на `TakeProfit1Offset` пунктов, создаётся новый `order1` в том же направлении.

## Соответствие параметров
| Параметр MetaTrader         | Параметр StockSharp           | Назначение |
|-----------------------------|-------------------------------|-----------|
| `AddNewTradeAfter`          | `AddNewTradeAfter`            | Шаг сетки в пунктах между усреднениями. |
| `TakeProfit1Partitive`      | `TakeProfit1Partitive`        | Дистанция тейк-профита для `order1`. |
| `TakeProfit2`               | `TakeProfit2`                 | Дистанция тейк-профита для `order2`. |
| `TakeProfit3`               | `TakeProfit3`                 | Дистанция тейк-профита для `order3`. |
| `TakeProfit4Total` … `15`   | `TakeProfitXTotal`            | Суммарная цель (в пунктах) при N открытых ордерах. |
| `TakeProfit1Total`          | `TakeProfit1Total`            | Накопительная цель прибыли `order1` перед повторным запуском. |
| `TakeProfit1Offset`         | `TakeProfit1Offset`           | Минимальное удаление цены от последнего тейк-профита для нового `order1`. |
| `MaxOrders`                 | `MaxOrders`                   | Максимальное число усредняющих ордеров по одному направлению. |
| `Risk`                      | `RiskPercent`                 | Допустимый плавающий убыток в процентах от стоимости портфеля. |
| `Lots`                      | `OrderVolume`                 | Объём каждой сделки усреднения. |
| —                           | `CandleType`                  | Тип свечей, запускающий управляющий цикл. |
| —                           | `AutoRenewFirstOrder`         | Разрешает автоматический перезапуск `order1`. |

Все расстояния в пунктах пересчитываются в цены через `Security.PriceStep`. Для инструментов без
шага и стоимости шага предусмотрены безопасные значения по умолчанию.

## Особенности реализации
- Для всех сделок используются высокоуровневые методы `BuyMarket`/`SellMarket`, а комментарии
  полностью повторяют названия из MQL.
- Механизм контроля «заявок в пути» предотвращает отправку повторных `orderN`, пока предыдущая
  заявка ещё не исполнена и не отменена.
- Плавающий PnL рассчитывается вручную через шаг цены, поэтому защита счёта работает даже при
  отсутствии онлайн данных по нереализованной прибыли.
- Логика повторного открытия `order1` соответствует оригиналу: сделка появляется только если
  суммарная прибыль ещё не достигла `TakeProfit1Total` и рынок ушёл от последнего тейк-профита не
  меньше чем на `TakeProfit1Offset` пунктов.

## Отличия от версии MetaTrader
- Графические подписи (profit pips / profit currency) не переносятся. Статистика хранится внутри
  стратегии и может быть выведена через пользовательский интерфейс.
- Используются события закрытия свечей вместо каждого тика. При таймфрейме 1 минута поведение
  практически совпадает с исходным.
- Тейк-профиты реализованы через рыночные сделки, а не модификацию ордеров, что лучше вписывается в
  высокоуровневую модель StockSharp.

## Рекомендации по запуску
1. Назначьте портфель и инструмент, задайте шаг сетки, параметры лестницы тейк-профитов и риск.
2. Оставьте `AutoRenewFirstOrder = true`, чтобы стратегия автоматически перезапускала `order1` после
   успешных тейк-профитов, или выключите параметр при ручном управлении.
3. Запустите стратегию. Все усреднения, выходы и защитные остановки выполняются автоматически; ручной
   контроль нужен только для задания первичного направления.

## Предупреждения по рискам
Сеточные стратегии быстро наращивают объём позиций. Всегда проверяйте значения `MaxOrders`,
`OrderVolume` и `RiskPercent` перед работой на реальном счёте и прогоняйте стратегию в тестере под
различные сценарии волатильности.
