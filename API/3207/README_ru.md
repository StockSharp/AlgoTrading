# 3207 – Стратегия MA Trend

## Обзор
**MA Trend Strategy** повторяет советник MetaTrader *MA Trend.mq5* на высокоуровневом API StockSharp. Алгоритм отслеживает одну линейно-взвешенную скользящую среднюю с настраиваемым сдвигом вперёд. Закрытие цены выше сдвинутой средней даёт сигнал на покупку, а ниже – на продажу. Защитные приёмы (стоп-лосс, тейк-профит и трейлинг) воспроизводят логику оригинального MQL-кода.

## Логика торговли
1. Подписка на выбранный тип свечей (по умолчанию минутные) и расчёт скользящей средней с заданным методом и источником цены.
2. Сдвиг значения скользящей на указанное число завершённых свечей перед сравнением с текущим закрытием.
3. Формирование сигналов:
   - **Покупка** – закрытие выше сдвинутой средней (при `ReverseSignals=true` условие инвертируется).
   - **Продажа** – закрытие ниже сдвинутой средней (при `ReverseSignals=true` условие инвертируется).
4. Управление позицией:
   - При `CloseOpposite=true` перед открытием новой позиции закрывается встречное направление.
   - При `OnlyOnePosition=true` новые входы блокируются, если позиция уже существует.
5. Выходы по стоп-лоссу, тейк-профиту и трейлинг-стопу задаются в пунктах. Трейлинг подтягивает стоп только после прохода цены на `TrailingStopPips + TrailingStepPips`, как в исходном советнике.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
|-----|-----|-----------------------|----------|
| `OrderVolume` | `decimal` | `0.1` | Объём ордера в лотах/контрактах. |
| `StopLossPips` | `int` | `50` | Стоп-лосс в пунктах. Ноль отключает фиксированный стоп. |
| `TakeProfitPips` | `int` | `140` | Тейк-профит в пунктах. Ноль отключает цель. |
| `TrailingStopPips` | `int` | `15` | Дистанция трейлинг-стопа. Ноль отключает сопровождение. |
| `TrailingStepPips` | `int` | `5` | Дополнительное движение цены перед подтяжкой трейлинга. При включённом трейлинге должно быть > 0. |
| `MaPeriod` | `int` | `12` | Период скользящей средней. |
| `MaShift` | `int` | `3` | Количество завершённых баров для сдвига средней вперёд. |
| `MaMethod` | `MovingAverageKind` | `Weighted` | Метод расчёта СС (Simple, Exponential, Smoothed, Weighted). |
| `AppliedPrice` | `AppliedPriceMode` | `Weighted` | Цена свечи для расчёта (Close, Open, High, Low, Median, Typical, Weighted). |
| `OnlyOnePosition` | `bool` | `false` | Разрешить только одну открытую позицию. |
| `ReverseSignals` | `bool` | `false` | Инвертировать направления сигналов. |
| `CloseOpposite` | `bool` | `false` | Закрывать противоположные позиции перед новым входом. |
| `CandleType` | `DataType` | `1 минута` | Тип/таймфрейм свечей, используемый в расчёте. |

## Примечания
- Размер пункта автоматически корректируется для инструментов с 3/5 десятичными знаками, как в MetaTrader.
- Проверка трейлинг-стопа идентична MQL: если `TrailingStopPips > 0`, но `TrailingStepPips <= 0`, запуск завершается исключением.
- Все расчёты ведутся только по завершённым свечам, что упрощает повторяемость тестов и оптимизаций.
