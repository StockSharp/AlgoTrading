# Стратегия Trailing Stop Manager
[English](README.md) | [中文](README_cn.md)

Эта стратегия воспроизводит логику советника `MQL/17263/TrailingStop.mq5`, который автоматически подтягивал стоп-лосс после открытия позиции.

## Исходная идея
- **Источник**: TrailingStop.mq5 Владимира Карпутова для хеджинговых счетов MetaTrader.
- **Концепция**: на первом тике советник открывал и покупку, и продажу, после чего независимо подтягивал стопы для каждой позиции, опираясь на расстояние в пунктах.
- **Цель**: показать, как реализовать трейлинг-стоп с настраиваемой дистанцией активации и шагом обновления.

## Адаптация под StockSharp
- **Неттинговый режим**: в StockSharp позиции суммируются, поэтому порт управляет одним направлением одновременно. Чтобы сопровождать лонг и шорт параллельно, запустите две копии стратегии.
- **Обновление по тикам**: подписка на сделки (`DataType.Ticks`) позволяет повторить тик-ориентированную обработку исходного эксперта.
- **Пересчёт пунктов**: параметры в пунктах умножаются на `Security.PriceStep` (при отсутствии шага цена используется значение 1), что даёт абсолютные ценовые смещения.
- **Опциональный авто-вход**: параметр позволяет отправить рыночную заявку при запуске, что удобно для тестов или демонстрации.

## Торговая логика
1. **Запуск**
   - Стратегия считывает ценовой шаг инструмента и подписывается на поток тиков.
   - При необходимости отправляется рыночная заявка в направлении из параметра `Initial Direction`.
2. **Отслеживание входа**
   - Каждая собственная сделка сбрасывает состояние трейлинга и запоминает фактическую цену входа.
3. **Активация**
   - Для лонга трейлинг включается, когда цена выросла на `Trailing Stop (pips)` от входа, для шорта требуется аналогичное падение.
4. **Обновление стопа**
   - После активации уровень стопа равен текущей цене минус/плюс дистанция активации.
   - Стоп подтягивается только если последняя сделка сдвинула его вперёд минимум на `Trailing Step (pips)`.
   - Нулевой шаг означает обновление на каждом выгодном тике.
5. **Выход**
   - При возврате цены к уровню трейлинг-стопа позиция закрывается рыночной заявкой.

## Параметры
| Название | Описание |
| --- | --- |
| **Trailing Stop (pips)** | Расстояние активации в пунктах. Значение должно быть больше нуля. |
| **Trailing Step (pips)** | Минимальное выгодное движение в пунктах для очередного подтягивания стопа. Может быть нулевым. |
| **Initial Direction** | Опциональная рыночная заявка при старте (`None`, `Long`, `Short`). |

## Дополнительные замечания
- Оригинальный эксперт использовал Bid/Ask. В C# версии применяется последняя цена сделки, что достаточно для ликвидных инструментов.
- В стратегии отсутствуют тейк-профит и сигналы на повторный вход. Её можно комбинировать с любым источником сигналов или запускать после ручного открытия позиции.
- Убедитесь, что брокер предоставляет корректный `PriceStep` для дробных пунктов, иначе скорректируйте параметры под фактический тик.
- Автоматических тестов для модуля нет — протестируйте на демо-потоке перед использованием на реальных деньгах.
