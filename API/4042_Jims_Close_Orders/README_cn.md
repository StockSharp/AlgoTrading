# Jim's Close Orders 策略
[English](README.md) | [Русский](README_ru.md)

该工具策略来自原始的 MetaTrader 4 脚本，用于批量平仓。启动后会立即遍历投资组合中的所有持仓，根据所选模式判断盈亏并发送市价单，尽快将敞口降为零。

## 细节

- **用途**：在需要快速退出市场、手动控制风险时，一键平掉现有仓位。
- **作用范围**：检查投资组合里的每一个持仓，与 `Security` 属性无关。
- **工作流程**：
  1. 启动时读取三个模式参数。
  2. 如果只有一个模式被启用，则生成当前持仓快照。
  3. 对符合条件的持仓调用 `ClosePosition` 发送相反方向的市价单。
  4. 完成处理后立即停止自身，完全复现 MT4 脚本的一次性逻辑。
- **价格来源**：判断盈亏时，做多仓使用买一价（Bid），做空仓使用卖一价（Ask）；若报价缺失，则退回最后成交价。无法获得任何价格的持仓会被跳过并写入警告日志。
- **不开新仓**：策略不会开仓，也不会处理挂单，只负责关闭已经存在的持仓。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CloseOpenOrders` | `true` | 忽略浮动盈亏，直接关闭所有持仓。三个选项必须保持互斥。 |
| `CloseOrdersWithPlusProfit` | `false` | 只关闭浮动盈亏大于等于零的持仓。 |
| `CloseOrdersWithMinusProfit` | `false` | 只关闭浮动盈亏小于等于零的持仓。 |

### 参数提示

- 三个布尔参数中必须恰好开启一个。如果全部关闭或同时开启多个，策略会记录警告并直接停止，不会发送任何订单。
- 浮动盈亏按 `(exitPrice - averagePrice) * signedVolume` 计算，并根据持仓方向选择退出价。
- 如果持仓缺少关联的 `Security` 或者无法取得市场价格，为安全起见会跳过该持仓。

## 使用建议

- 请确保有 Level1（买一/卖一）或成交数据，以便策略正确判断盈亏状态。
- 因为策略会处理整个投资组合，若只想关闭部分头寸，建议在单独账户或投资组合中运行。
- 仅在行情连接正常时启动，否则市价单会等待到连接恢复后才执行。
- 若还需要撤销挂单，可与其他辅助策略配合使用；本策略忠实还原 MT4 脚本，仅针对已开仓位。
