# Стратегия Jim's Close Orders
[English](README.md) | [中文](README_cn.md)

Утилитарная стратегия, перенесённая из оригинального скрипта MetaTrader 4 для массового закрытия сделок. После запуска она мгновенно перебирает все открытые позиции в подключённом портфеле, оценивает их текущий результат и выставляет рыночные заявки на закрытие в соответствии с выбранным режимом.

## Подробности

- **Назначение**: аварийное закрытие позиций и ручное управление рисками, когда необходимо быстро обнулить весь портфель.
- **Область действия**: обрабатываются все открытые позиции портфеля вне зависимости от выбранного в настройках инструмента `Security`.
- **Алгоритм**:
  1. При старте проверяется, какой из режимов закрытия включён.
  2. Если активен ровно один режим, берётся снимок текущих позиций.
  3. Позиции, удовлетворяющие фильтру, закрываются через `ClosePosition` рыночными заявками.
  4. После обработки снимка стратегия сразу останавливается, что повторяет одноразовую логику MT4-скрипта.
- **Источник цены**: для фильтра прибыли/убытка используется лучшая заявка (bid для закрытия лонгов, ask для закрытия шортов). Если котировка отсутствует, берётся последняя сделка. При отсутствии любой цены позиция пропускается с предупреждением.
- **Отсутствие торговли**: стратегия не открывает новых позиций и не работает с отложенными ордерами — она только закрывает уже открытые сделки.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CloseOpenOrders` | `true` | Закрывать все позиции, игнорируя их плавающий результат. За один запуск разрешён только один режим. |
| `CloseOrdersWithPlusProfit` | `false` | Закрывать только позиции с нулевой или положительной плавающей прибылью. |
| `CloseOrdersWithMinusProfit` | `false` | Закрывать только позиции с нулевым или отрицательным плавающим результатом. |

### Примечания по параметрам

- Должен быть включён ровно один из трёх флагов. Если не выбран ни один или включено несколько, стратегия выдаёт предупреждение и сразу останавливается без отправки заявок.
- Плавающий результат оценивается по формуле `(exitPrice - averagePrice) * signedVolume`, где цена выхода выбирается по направлению позиции.
- Позиции без привязанного инструмента `Security` или без доступной рыночной цены пропускаются для безопасности.

## Рекомендации по использованию

- Убедитесь, что доступны данные Level1 (лучшие bid/ask) или сделки, иначе фильтры прибыли/убытка не смогут корректно оценить позиции.
- Поскольку стратегия закрывает весь портфель, используйте отдельный счёт или портфель, если требуется селективное закрытие.
- Запускайте стратегию только при активном соединении — иначе рыночные заявки останутся в подвешенном состоянии до восстановления связи.
- Для отмены отложенных ордеров комбинируйте её с другими сервисными стратегиями, так как данная реализация намеренно повторяет MT4-скрипт, работавший только с открытыми позициями.
