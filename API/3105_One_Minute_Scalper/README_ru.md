[English](README.md) | [中文](README_cn.md)

Эта стратегия переносит советник **1 MINUTE SCALPER** из MetaTrader 4 на высокоуровневый API StockSharp. Логика сохраняет многоуровневую фильтрацию тренда, подтверждение импульса на старшем таймфрейме и месячный фильтр MACD, но управление риском адаптировано под модель неттинговых позиций StockSharp.

## Основная логика

1. **Каскад LWMA** – тринадцать линейно-взвешенных средних (LWMA 3/5/8/10/12/15/30/35/40/45/50/55/200) должны быть строго упорядочены. Для лонга каждая быстрая средняя расположена выше следующей, для шорта условия инвертируются.
2. **Базовый тренд-фильтр** – дополнительная быстрая LWMA (по умолчанию 6) должна находиться выше медленной LWMA (85) в лонге и ниже в шорте, как и в исходном скрипте.
3. **Структура свечей** – сигнал формируется только при наличии перекрытий из исходного кода: для покупки минимум позапрошлой свечи должен быть ниже максимума прошлой, для продажи минимум прошлой свечи должен опускаться ниже максимума двух свечей назад.
4. **Импульсный фильтр** – индикатор Momentum длиной 14 на более крупном таймфрейме (по умолчанию 15-минутные свечи) должен отклониться от уровня 100 как минимум на величину заданных порогов на любом из трех последних значений. Это повторяет проверки `MomLevelB/MomLevelS`.
5. **Месячный MACD** – MACD на выбранном таймфрейме (по умолчанию 30-дневные свечи, приблизительный аналог месяца) должен показывать, что основная линия выше сигнальной для лонгов и ниже для шортов.

## Управление сделкой

- **Исходные уровни** – стоп-лосс и тейк-профит задаются в шагах цены. После открытия позиция получает абсолютные значения с учётом `Security.PriceStep`.
- **Переход в безубыток** – при движении цены на `BreakEvenTriggerSteps` в прибыльную сторону стоп переносится к цене входа с дополнительным отступом `BreakEvenOffsetSteps` (для шорта условие зеркально).
- **Ступенчатый трейлинг** – при положительном `TrailingStopSteps` стоп следует за экстремумом с расстоянием, выраженным в шагах.
- **Денежный трейлинг** – когда плавающий результат превышает `MoneyTrailTarget`, стратегия отслеживает максимальную прибыль и закрывает позицию, если откат достигает `MoneyTrailStop`.
- **Денежные/процентные цели** – опциональные фиксаторы закрывают позицию при достижении абсолютного или процентного порога плавающей прибыли. Процент вычисляется от стоимости портфеля на момент старта.
- **Эквити-стоп** – фиксируется максимум совокупного капитала (стоимость портфеля плюс нереализованная прибыль). Если просадка превышает `EquityRiskPercent`, позиция закрывается, как в функции `AccountEquityHigh()` оригинального советника.

## Параметры

| Параметр | Описание |
| --- | --- |
| `Volume` | Объём заявки. При смене направления к нему прибавляется текущая абсолютная позиция, чтобы сразу развернуться. |
| `FastMaPeriod` / `SlowMaPeriod` | Периоды LWMA основного тренд-фильтра. |
| `MomentumPeriod` | Период индикатора Momentum на старшем таймфрейме. |
| `MomentumBuyThreshold` / `MomentumSellThreshold` | Минимальное отклонение от уровня 100 для подтверждения импульса в лонг/шорт. |
| `MacdFastLength` / `MacdSlowLength` / `MacdSignalLength` | Настройки MACD на `MacdCandleType`. |
| `StopLossSteps` / `TakeProfitSteps` | Дистанции стоп-лосса и тейк-профита в шагах цены (0 отключает). |
| `TrailingStopSteps` | Дистанция ступенчатого трейлинга (0 отключает). |
| `BreakEvenTriggerSteps` / `BreakEvenOffsetSteps` | Условие и смещение при переводе стопа в безубыток. |
| `UseMoneyTakeProfit`, `MoneyTakeProfit` | Включение и размер денежного тейк-профита. |
| `UsePercentTakeProfit`, `PercentTakeProfit` | Включение и размер процентного тейк-профита относительно стартового капитала. |
| `EnableMoneyTrailing`, `MoneyTrailTarget`, `MoneyTrailStop` | Настройка денежного трейлинга прибыли. |
| `UseEquityStop`, `EquityRiskPercent` | Эквити-стоп и допустимая просадка в процентах. |
| `CandleType` | Рабочий таймфрейм (по умолчанию 1 минута). |
| `MomentumCandleType` | Таймфрейм для Momentum (по умолчанию 15 минут). |
| `MacdCandleType` | Таймфрейм для MACD (по умолчанию 30 дней ≈ месяц). |

## Отличия от MT4-версии

- StockSharp использует неттинг, поэтому стратегия удерживает только одну агрегированную позицию вместо пачки ордеров (`Max_Trades`). Разворот закрывает текущую позицию и сразу открывает обратную.
- Параметр `PercentTakeProfit` опирается на стоимость портфеля в момент старта, а не на постоянно меняющийся `AccountBalance()` MetaTrader. Это исключает ложные срабатывания при внешних операциях по счёту.
- Денежные правила выхода (`Take_Profit_In_Money`, `TRAIL_PROFIT_IN_MONEY2`) рассчитываются по плавающей прибыли от средней цены позиции, что соответствует оригиналу, но вписано в инфраструктуру StockSharp.
- Необходимо обеспечить поставку свечей всех выбранных таймфреймов (`CandleType`, `MomentumCandleType`, `MacdCandleType`). Убедитесь, что подключённый адаптер поддерживает эти интервалы.

Подбирайте параметры под волатильность инструмента. Для «шумных» рынков стоит увеличить шаги стопов и пороги импульса, чтобы снизить число ложных входов.
