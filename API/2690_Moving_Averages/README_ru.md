# Стратегия Moving Averages

## Обзор
Стратегия Moving Averages воспроизводит классического эксперта MetaTrader, который торгует по пересечениям цены с сдвинутой простой скользящей средней (SMA). Алгоритм обрабатывает только закрытые свечи, поэтому решения принимаются на основе полностью сформированных баров. Размер позиции рассчитывается по динамической модели риска, связанной с капиталом портфеля, и уменьшается при серии убыточных сделок, как и в исходном MQL-скрипте.

## Логика торговли
- Рассчитывается простая скользящая средняя с настраиваемым периодом и сдвигом на заданное количество завершённых баров.
- Для каждой завершённой свечи проверяется: открытие выше сдвинутой SMA и закрытие ниже неё (медвежий сигнал) или открытие ниже и закрытие выше (бычий сигнал).
- В стратегии одновременно может быть открыта только одна позиция. Если появляется сигнал, направленный против текущей позиции, позиция закрывается, и разворот в ту же свечу не выполняется.
- При отсутствии позиции:
  - Бычий сигнал открывает длинную позицию.
  - Медвежий сигнал открывает короткую позицию.

## Управление позицией
- Медвежий сигнал закрывает длинную позицию.
- Бычий сигнал закрывает короткую позицию.
- Для сделок используются рыночные заявки по базовому инструменту стратегии.
- Журнал сделок ведётся для расчёта средней цены входа, что позволяет корректно оценить финансовый результат при закрытии позиции.

## Риск-менеджмент и размер позиции
- Базовый объём заявки вычисляется как произведение стоимости портфеля на параметр **MaximumRisk**, делённое на текущую цену закрытия. Если данные о капитале недоступны, используется стандартный объём стратегии.
- Параметр **DecreaseFactor** уменьшает рассчитанный объём при серии убыточных сделок. Степень сокращения пропорциональна длине серии, что повторяет адаптивное управление объёмом в версии для MetaTrader.
- Итоговый объём никогда не становится отрицательным. Если уменьшение превышает базовое значение, сделка пропускается.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `MaximumRisk` | Доля капитала, которую стратегия рискует в сделке. | `0.02` |
| `DecreaseFactor` | Делитель, уменьшающий объём после серии убытков. | `3` |
| `MovingPeriod` | Период SMA для расчёта сигналов. | `12` |
| `MovingShift` | Количество завершённых баров, на которые смещается SMA. | `6` |
| `CandleType` | Тип свечей (таймфрейм), используемый в расчётах. | Свечи 5 минут |

## Примечания
- Сдвиг скользящей средней реализован через внутренний циклический буфер, поэтому стратегия использует значения SMA нескольких баров назад, как и параметр shift в MetaTrader.
- Заявки отправляются только после того, как SMA и буфер сдвига полностью сформированы, что исключает преждевременные входы во время разогрева.
- Журнальные сообщения фиксируют входы, выходы и результаты сделок, упрощая анализ и отладку стратегии.
