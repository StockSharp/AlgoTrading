# 移动平均策略

## 概述
移动平均策略重现了 MetaTrader 专家顾问，通过价格与平移后的简单移动平均线（SMA）交叉来进行交易。算法只处理已经收盘的K线，从而确保交易决策基于完整数据。仓位规模使用动态风险模型，与账户权益挂钩，并根据连续亏损自动调整，延续原始 MQL 逻辑。

## 交易逻辑
- 计算可配置周期的简单移动平均线，并向前平移指定数量的已完成K线。
- 每根完成的K线都会检查是否出现以下情形：开盘价高于平移后的 SMA 且收盘价跌破它（看空交叉），或开盘价低于平移后的 SMA 且收盘价突破它（看多交叉）。
- 策略同时只持有一个方向的仓位。当出现与当前仓位相反的交叉时，会先平仓，当根K线内不会反向开仓。
- 当没有持仓时：
  - 看多交叉开多单。
  - 看空交叉开空单。

## 仓位管理
- 看空交叉触发多头平仓。
- 看多交叉触发空头平仓。
- 所有交易使用市场委托执行。
- 策略跟踪成交历史以计算有效入场价，用于在平仓时评估盈亏。

## 风险管理与仓位控制
- 基础下单量由投资组合权益乘以 **MaximumRisk** 参数并除以当前收盘价得到。当无法获取权益时，会退回到策略默认手数。
- **DecreaseFactor** 参数用于连续亏损时削减下单量，削减幅度与亏损次数成比例，从而模拟原始 MQL 的自适应仓位机制。
- 下单量不会为负值；当削减量超过基础手数时，该笔交易会被跳过。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `MaximumRisk` | 每笔交易占用账户权益的比例。 | `0.02` |
| `DecreaseFactor` | 连续亏损后缩小仓位的除数。 | `3` |
| `MovingPeriod` | 计算信号的 SMA 周期。 | `12` |
| `MovingShift` | 将 SMA 向前平移的已完成K线数量。 | `6` |
| `CandleType` | 计算所用的K线类型（时间框架）。 | `5` 分钟K线 |

## 说明
- 平移后的均线通过内部循环缓冲区实现，使策略使用几根K线之前的 SMA 值，行为与 MetaTrader 的 shift 参数保持一致。
- 只有当 SMA 和平移缓冲都完全形成后才会发出订单，避免在热身阶段过早入场。
- 日志会记录入场、出场和交易结果，便于调试与绩效分析。
