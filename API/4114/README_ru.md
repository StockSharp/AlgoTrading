# Демонстрационная стратегия параметров индикаторов

## Обзор

`IndicatorParametersDemoStrategy` — это адаптация учебного скрипта MetaTrader *IndicatorParameters_Demo.mq5* для высокоуровневого API StockSharp. В оригинале советник отслеживал событие изменения графика и выводил подробную информацию обо всех индикаторах, добавленных на график или удалённых с него. Перенос в C# реализует тот же сценарий в контексте стратегии: каждый индикатор, привязанный к подписке на свечи, регистрируется внутренним трекером, который формирует структурированный отчёт с параметрами и пишет его в лог.

В стратегии отсутствует торговая логика — она ничего не покупает и не продаёт. Цель примера — показать, как из кода получить список свойств индикаторов, прочитать текущие значения и увидеть, когда данные становятся доступными. Благодаря этому стратегию можно безопасно запускать на боевом или демо счёте, используя её как инструмент диагностики и обучения.

## Ключевые возможности

- Создаёт три популярные индикаторы (простое скользящее среднее, экспоненциальное скользящее среднее и индекс относительной силы) и демонстрирует извлечение их параметров.
- При каждом добавлении индикатора выводит строку `+ added`, а при очистке трекера — `- deleted`, тем самым повторяя поведение MQL-версии.
- Генерирует читаемый отчёт, где указаны тип индикатора, имя параметра, его тип и актуальное значение.
- Предоставляет публичный метод `RefreshIndicatorSnapshots`, который можно вызвать из пользовательского интерфейса для принудительного обновления отчёта.
- Поддерживает необязательное логирование фактических значений индикаторов на закрытии каждой свечи через параметр `LogIndicatorValues`.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `CandleType` | Тип свечей или источник данных, используемый для расчёта всех индикаторов. Настройте его в соответствии с нужным таймфреймом или типом данных. | Свечи 1 минута |
| `SmaLength` | Длина окна простого скользящего среднего. Значение фиксируется в отчёте, что позволяет проследить его путь через подсистему логирования. | 20 |
| `EmaLength` | Длина окна экспоненциального скользящего среднего. | 50 |
| `RsiLength` | Период индекса относительной силы. | 14 |
| `LogIndicatorValues` | Если `true`, стратегия записывает в лог сообщения вида `[timestamp] indicator value: X` после закрытия каждой свечи. Если `false`, выводятся только сообщения об изменении состава индикаторов. | `false` |

Все параметры созданы через `StrategyParam<T>`, что обеспечивает валидацию, работу с оптимизатором и корректное отображение в UI. Структуру легко расширить: добавьте нужный индикатор в `OnStarted`, вызовите `TrackIndicator`, и он автоматически появится в отчёте.

## Как работает логирование

1. **Запуск**. В методе `OnStarted` создаются три индикатора, сразу же отслеживаются с помощью `TrackIndicator` и пишут строки `+ added: name=...`. Сразу после этого в лог добавляется подробный отчёт наподобие:

   ```
   SMA(20) parameter snapshot:
       Length (Int32) = 20
       IsFormed (Boolean) = False
       LastValue (Decimal?) = null
   ```

   Перечень полей зависит от конкретной реализации индикатора. В отчёт попадают все публичные свойства с типами `bool`, числовыми типами, `string`, `TimeSpan`, `DateTime`, `DateTimeOffset`, `DataType` и любыми перечислениями.

2. **Работа в онлайне**. При включённом `LogIndicatorValues` после закрытия каждой свечи для каждого индикатора выводится строка с временной меткой и рассчитанным значением. Формат ISO 8601 упрощает сопоставление с рыночными данными.

3. **Принудительное обновление**. Метод `RefreshIndicatorSnapshots()` повторно проходит по всем отслеживаемым индикаторам и выдаёт актуальный отчёт. Это аналог вызова `GetParametersInfo` из оригинальной MQL-версии при событии `CHARTEVENT_CHART_CHANGE`.

4. **Сброс**. Переопределение `OnReseted` очищает трекер и записывает строки `- deleted`, демонстрируя обработку удаления индикаторов.

## Порядок использования

1. Назначьте стратегии инструмент и портфель.
2. При необходимости измените тип свечей и периоды индикаторов в параметрах.
3. Решите, нужно ли логирование значений, и включите или выключите `LogIndicatorValues`.
4. Запустите стратегию и наблюдайте за логом: в нём появятся описания индикаторов и их свойств.
5. (Опционально) вызывать `RefreshIndicatorSnapshots`, когда требуется получить свежий снимок параметров без перезапуска.

Поскольку стратегия не посылает заявок, дополнительной подготовки не требуется. Её можно запускать как в тестере, так и при подключении к реальному провайдеру данных.

## Отличия от MQL-реализации

- Вместо обработки `CHARTEVENT_CHART_CHANGE` используется явный вызов `TrackIndicator` при создании индикатора. Это соответствует архитектуре StockSharp, где стратегия управляет собственными подписками.
- Вместо дескрипторов и массивов `MqlParam` применяется рефлексия. Стратегия перебирает публичные свойства каждого `IIndicator` и выводит их значения.
- Сообщения печатаются через `AddInfoLog`, интегрируясь с общей системой логов StockSharp.

## Расширение примера

Чтобы добавить новые индикаторы, создайте их в `OnStarted`, подпишите на ту же свечную серию и вызовите `TrackIndicator`, передав понятное имя (например, с указанием периода или источника). После этого все вспомогательные методы начнут автоматически работать и с новыми индикаторами.

Если во время работы вы меняете параметры индикатора вручную, вызовите `RefreshIndicatorSnapshots`, чтобы увидеть обновлённые значения в логах.

## Примечания по безопасности

- Стратегия не выполняет никаких торговых операций и не взаимодействует со стаканом или заявками.
- Работа зависит от высокоуровневой подписки на свечи. Убедитесь, что выбранный `CandleType` поддерживается вашим коннектором.
- При очень мелком таймфрейме объём логов может стать существенным, если включено `LogIndicatorValues`. В таких случаях лучше использовать ручное обновление отчётов.
