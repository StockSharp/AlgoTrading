# Стратегия фиксированного риска

## Общее описание
Стратегия фиксированного риска представляет собой перенос эксперта MetaTrader 5 **Money Fixed Risk.mq5**. Оригинальный советник регулярно определяет максимально допустимый объём позиции при ограничении риска фиксированным процентом от капитала, после чего открывает рыночную покупку с симметричными уровнями стоп-лосса и тейк-профита. Реализация на StockSharp повторяет этот алгоритм, используя подписку на тиковые сделки и встроенные средства управления риском.

Стратегия обрабатывает каждый тик выбранного инструмента. Когда внутренний счётчик достигает заданного количества тиков, стратегия переоценивает размер позиции: считывает текущую стоимость портфеля, переводит заданный стоп в пунктах в абсолютное расстояние по цене и вычисляет объём, соответствующий целевому проценту риска. Если вычисленный объём удовлетворяет биржевым ограничениям, отправляется рыночная покупка, а уровни стоп-лосса и тейк-профита фиксируются на равном расстоянии от цены входа. В дальнейшем на каждом тике контролируется достижение этих уровней и позиция закрывается при первом срабатывании.

## Требования к данным
- Необходим поток тиковых сделок (`SubscribeTrades()`), поскольку именно по тикам ведётся счётчик.
- Для корректного расчёта объёма должны быть заданы свойства инструмента: `PriceStep`, `StepPrice`, `VolumeStep`, `MinVolume` и при необходимости `MaxVolume`.

## Логика работы
1. Подписаться на сделки по инструменту.
2. На каждом тике увеличивать счётчик.
3. При достижении счётчиком значения **Ticks Interval** выполнить пересчёт:
   - Определить размер пункта на основе `PriceStep` и количества знаков (`Decimals`). Для котировок с 3 или 5 знаками используется множитель 10.
   - Перевести стоп-лосс из пунктов в абсолютное расстояние по цене.
   - Получить величину капитала портфеля (`CurrentValue`, затем `CurrentBalance`, затем `BeginValue`).
   - Рассчитать денежный риск на один контракт и максимально допустимый объём с учётом заданного процента риска.
   - Привести объём к шагу торгов и ограничениям `MinVolume`/`MaxVolume`.
4. Если нормализованный объём положительный, закрыть возможный шорт и открыть длинную позицию рассчитанного размера.
5. Запомнить уровни стоп-лосса и тейк-профита и следить за их достижением по каждому тику.

## Параметры
- **Stop Loss (pips)** – величина стоп-лосса в пунктах (тейк-профит размещается на таком же расстоянии).
- **Risk %** – доля капитала, которой стратегия готова рискнуть в одной сделке.
- **Ticks Interval** – количество тиков между очередными расчётами позиции и попытками входа.

Все параметры проходят проверку на положительность и доступны для оптимизации.

## Особенности управления риском
- Риск на сделку = `Equity * (Risk % / 100)`.
- Расстояние стопа = `Stop Loss (pips) * pip size`, где `pip size = PriceStep * 10` для инструментов с 3/5 знаками после запятой и `PriceStep` для остальных.
- Денежный риск на контракт = `(stop distance / PriceStep) * StepPrice`.
- Объём = `risk amount / risk per contract`, округляется вниз до ближайшего `VolumeStep` и ограничивается `MinVolume`/`MaxVolume`. Если результат меньше минимального объёма, сделка пропускается.

## Отличия от оригинала
- Полностью реализована на StockSharp и не требует библиотек MetaTrader.
- Использует `StartProtection()` для подключения стандартных защитных механизмов платформы.
- Данные об equity берутся из объекта портфеля стратегии, а не из MQL-классов.
- Выход из позиции контролируется по тикам, поэтому для демонстрации не регистрируются отдельные стоп-заявки.

## Рекомендации по использованию
- Как и исходный эксперт, реализация открывает только длинные позиции. Для добавления шортов расширьте метод `ProcessTrade`.
- При тестировании необходимо использовать тиковые данные достаточной плотности, иначе счётчик может не достигнуть порога.
- Перед запуском на реальном рынке убедитесь, что шаг цены и допустимые объёмы инструмента настроены корректно.
- Код не создаёт дополнительных коллекций, а хранит состояние во внутренних полях, что соответствует рекомендациям по конверсии.
