# RSI EA v2 策略

该策略是 MetaTrader 5 专家顾问 **“RSI EA v2”** 的 StockSharp 版本。它围绕 RSI 阈值突破自动化交易，并保留原始 EA 的资金管理、移动止损以及交易时间控制。默认使用 1 分钟 K 线，但可以通过参数替换为任何所需的烛图类型。

## 交易逻辑

- **入场条件**
  - 当 RSI 向上穿越买入阈值且上一根已完成 K 线的 RSI 位于阈值下方，同时处于允许交易的时间段时开多。
  - 当 RSI 向下穿越卖出阈值且上一根已完成 K 线的 RSI 位于阈值上方，同时满足交易时段要求时开空。
  - 如果当前持有反向仓位，策略会下发足够的市价单以先平掉现有敞口，再建立新的净方向（StockSharp 中为净仓模式）。
- **离场条件**
  - 新仓位被识别后立即根据设定的点数（pips）附加止损和止盈。
  - 移动止损复刻原始 EA：只有当价格收益超过“TrailingStop + TrailingStep”后才激活，并且每次至少推进一个 trailing step。
  - 可选的“信号反向平仓”逻辑：当 RSI 向下穿越卖出阈值时平掉多头；当 RSI 向上穿越买入阈值时平掉空头。
  - 所有判断均在已完成的 K 线上进行，便于回测和复现。

## 风险与仓位管理

- **止损 / 止盈**：以点数定义，并根据合约的价格精度（包含 3/5 位外汇报价）转换为价格距离。
- **移动止损**：距离为零时关闭；只要启用移动止损，就必须提供正的 TrailingStep。
- **仓位大小**：可选择固定手数，或根据风险百分比与止损距离自动计算手数。风险模式需要账户权益及有效的价格步长信息。
- **交易时段**：可选的日内过滤器，通过起始小时（包含）与结束小时（不包含）限定交易窗口；当两者相等时视为全天禁止交易。

## 参数

| 参数 | 说明 |
| ---- | ---- |
| `OpenBuy` / `OpenSell` | 分别控制多头或空头入场。 |
| `CloseBySignal` | 是否依据反向 RSI 信号平仓。 |
| `StopLossPips` | 止损点数，0 表示关闭止损。 |
| `TakeProfitPips` | 止盈点数，0 表示关闭止盈。 |
| `TrailingStopPips` | 移动止损距离（点）。 |
| `TrailingStepPips` | 每次更新移动止损所需的额外点数，启用移动止损时必须为正。 |
| `RsiPeriod` | RSI 计算周期。 |
| `RsiBuyLevel` / `RsiSellLevel` | 多头/空头的入场与信号平仓阈值。 |
| `UseRiskSizing` | 切换到风险百分比仓位管理。 |
| `FixedVolume` | 固定模式下的下单手数，也是风险模式失败时的回退值。 |
| `RiskPercent` | 每笔交易愿意承担的账户权益百分比，仅在启用风险模式且止损距离大于零时使用。 |
| `UseTimeControl` | 是否启用日内时间过滤。 |
| `StartHour` / `EndHour` | 交易窗口的起始小时（含）与结束小时（不含），范围 0–23。 |
| `CandleType` | 用于计算 RSI 的烛图类型。 |

## 实现细节

- 使用高层订阅 API，将 RSI 指标绑定到蜡烛流。
- 根据 `PriceStep` 与 `Decimals` 计算点值，兼容外汇常见的 3 位/5 位报价。
- 下单前会按照交易品种的数量步长及最小/最大手数对订单量进行归一化。
- 移动止损只维护内部参考价格，一旦触发就通过市价单平仓。
- 分别维护多头与空头的入场价格、保护价位与移动止损状态，避免在蜡烛之间丢失信息。

## 使用步骤

1. 将策略附加到已经连接的 StockSharp 交易适配器，确保证券与投资组合元数据可用。
2. 根据交易品种设置 RSI 阈值、止损止盈点数以及可选的交易时段。
3. 若账户权益可用，可启用风险百分比仓位管理；否则保持固定手数模式。
4. 启动策略后，它会等待完整 K 线，依据 RSI 信号下单，并持续管理止损、止盈和移动止损。
