# Стратегия Trend Line By Angle

## Общее описание

Стратегия является портом советника MetaTrader *Trend Line By Angle* на StockSharp. В оригинале сделки открывались вручную нажатием кнопок, а управление риском реализовано множеством фильтров. Перенос автоматизирует работу за счёт MACD, но сохраняет все элементы защиты:

- MACD 12/26/9 рассчитывается на свечах `SignalCandleType`. Пересечение вверх открывает длинные позиции, пересечение вниз — короткие.
- Объём набирается порциями до значения `TradeVolume * MaxEntries`, что повторяет последовательные клики по кнопкам в MQL.
- На торговом таймфрейме рассчитываются полосы Боллинджера 20/2. Касание верхней полосы закрывает лонги, касание нижней — шорты.
- Стоп-лосс, тейк-профит, трейлинг и перевод в безубыток задаются в пунктах и пересчитываются через `PriceStep` инструмента.
- Дополнительно действуют денежный и процентный тейк-профиты, а также денежный трейлинг общей прибыли.

## Логика работы

1. **Подготовка индикаторов**. `MovingAverageConvergenceDivergenceSignal` подключается к подписке `SignalCandleType`, `BollingerBands` — к `CandleType`.
2. **Формирование сигналов**. После закрытия каждой свечи проверяется последнее пересечение MACD. При смене знака стратегия закрывает встречные позиции и открывает новые в сторону сигнала.
3. **Пошаговое наращивание**. Пока суммарный объём меньше `TradeVolume * MaxEntries`, стратегия добавляет лоты рыночными заявками.
4. **Контроль риска**. На каждой свече пересчитываются стопы, трейлинг и уровни безубытка. Касание полос Боллинджера принудительно закрывает позицию.
5. **Защита счёта**. Сначала выполняются проверки денежных/процентных целей и трейлинга прибыли, и только затем анализируются новые сигналы.

## Особенности управления капиталом

- **Суммарная прибыль** = реализованная `PnL` + плавающая прибыль, оценённая по цене закрытия свечи и параметрам шага цены.
- **Перевод в безубыток**: при профите свыше `BreakEvenTriggerPips` стоп переносится на `Entry ± BreakEvenOffsetPips`.
- **Трейлинг**: при росте цены более чем на `TrailingStopPips` стоп подтягивается ближе к цене. Для лонгов уровень только повышается, для шортов только понижается.
- **Денежный трейлинг**: после достижения `MoneyTrailTrigger` фиксируется максимум прибыли; просадка более `MoneyTrailStop` закрывает все сделки.

## Параметры

| Параметр | Описание |
| --- | --- |
| `TradeVolume` | Объём одной заявки. |
| `MaxEntries` | Максимальное число заявок, формирующих позицию. |
| `StopLossPips` | Расстояние стоп-лосса в пунктах. |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах. |
| `TrailingStopPips` | Размер трейлинг-стопа в пунктах. |
| `UseBreakEven` | Включение перевода в безубыток. |
| `BreakEvenTriggerPips` | Порог активации безубытка. |
| `BreakEvenOffsetPips` | Дополнительный запас при переносе стопа. |
| `UseBollingerExit` | Использовать выходы по полосам Боллинджера. |
| `BollingerPeriod` / `BollingerDeviation` | Настройки полос Боллинджера. |
| `UseProfitMoneyTarget` / `ProfitMoneyTarget` | Денежная цель и её значение. |
| `UseProfitPercentTarget` / `ProfitPercentTarget` | Процентная цель и её значение. |
| `EnableMoneyTrail` | Включение денежного трейлинга прибыли. |
| `MoneyTrailTrigger` | Минимальная прибыль для запуска трейлинга. |
| `MoneyTrailStop` | Допустимая просадка от максимума прибыли. |
| `MacdFastPeriod`, `MacdSlowPeriod`, `MacdSignalPeriod` | Параметры MACD. |
| `CandleType` | Таймфрейм исполнения. |
| `SignalCandleType` | Таймфрейм расчёта MACD. |

## Практические рекомендации

- Перед запуском убедитесь, что у инструмента задан корректный `PriceStep` и `StepPrice`, иначе расчёт пунктов и стоимости шага будет неточным.
- Если провайдер портфеля не возвращает `Portfolio.CurrentValue` или `Portfolio.BeginValue`, процентный тейк-профит автоматически отключается.
- В исходном C# файле все комментарии сделаны на английском языке для единообразия и будущей поддержки.
