# Стратегия Bollinger Bands N Positions v2

## Обзор
Стратегия повторяет эксперта "Bollinger Bands N positions v2" Владимира Карпутова. Алгоритм работает только по завершённым свечам и оценивает положение цены относительно границ полос Боллинджера. Перенос на StockSharp сохраняет пирамидирование, параметры управления рисками и траление, адаптируя при этом регистрацию сделок к неттинговой модели платформы.

## Торговая логика
- На выбранной серии свечей рассчитываются полосы Боллинджера с настраиваемыми периодом и отклонением.
- Если свеча закрывается выше верхней полосы, стратегия закрывает активные короткие позиции и добавляет новую длинную позицию (до достижения максимального количества усреднений).
- Если свеча закрывается ниже нижней полосы, стратегия закрывает активные длинные позиции и добавляет новую короткую позицию (также ограничено максимальным числом входов).
- Объём каждой добавки фиксирован и задаётся параметром **Volume**, благодаря чему наращивание позиции происходит дискретными ступенями.
- Средняя цена набранной позиции пересчитывается при каждом усреднении и используется для корректной работы стоп-лосса, тейк-профита и трейлинг-стопа.

## Управление рисками
- Стоп-лосс и тейк-профит задаются в пунктах. Значение автоматически переводится в абсолютное смещение цены умножением на шаг цены инструмента. Для инструментов с 3 или 5 знаками после запятой шаг дополнительно умножается на 10, чтобы имитировать поправку MetaTrader на "пятизнак".
- Параметры трейлинг-стопа (расстояние и шаг) также задаются в пунктах. Трейлинг активируется, когда цена уходит от средней цены позиции более чем на `TrailingStop + TrailingStep` пунктов; при каждом обновлении стоп переносится на расстояние трейлинга, соблюдая дополнительный буфер шага.
- Защитные заявки эмулируются внутри стратегии: если завершившаяся свеча пересекает уровень стопа или цели, вся позиция закрывается рыночным ордером.

## Параметры
| Параметр | Описание |
|----------|----------|
| **Bollinger Period** | Период скользящей средней полос Боллинджера. |
| **Bollinger Deviation** | Множитель стандартного отклонения для расчёта полос. |
| **Max Positions** | Максимальное количество наращиваний в одну сторону. |
| **Volume** | Объём ордера для каждого входа. |
| **Stop Loss (pips)** | Расстояние стоп-лосса в пунктах (0 — отключён). |
| **Take Profit (pips)** | Расстояние тейк-профита в пунктах (0 — отключён). |
| **Trailing Stop (pips)** | Расстояние трейлинг-стопа в пунктах (0 — отключён). |
| **Trailing Step (pips)** | Дополнительное смещение в пунктах перед очередным переносом трейлинг-стопа; должно быть положительным при включённом трейлинге. |
| **Candle Type** | Тип свечей, по которым работает стратегия. |

## Особенности реализации
- Используются высокоуровневые подписки на свечи с привязкой индикатора через `BindEx`, что соответствует рекомендациям StockSharp.
- Обработка ведётся только по закрытым свечам, как и в оригинальном советнике.
- Из-за неттинговой модели StockSharp при появлении сигнала в противоположную сторону стратегия сначала закрывает существующую позицию и только затем открывает новую ступень.
- Проверка параметров гарантирует, что при активном трейлинге шаг переноса больше нуля, как это реализовано в MetaTrader-версии.
- В этом релизе отсутствует Python-версия стратегии.
