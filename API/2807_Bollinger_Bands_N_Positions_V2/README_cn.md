# 布林带多仓位 v2 策略

## 概述
本策略复刻 Vladimir Karputov 的 "Bollinger Bands N positions v2" 智能交易顾问。策略仅在蜡烛图收盘后运行，比较收盘价与布林带上下轨的位置。在迁移到 StockSharp 时保留了原策略的加仓、风险控制以及移动止损逻辑，同时符合平台的净持仓体系。

## 交易逻辑
- 在所选蜡烛序列上计算布林带指标，周期与偏差均可配置。
- 当蜡烛收盘价高于上轨时，策略先平掉所有空头仓位，再按设定的手数加仓多头（最多累积到 **Max Positions** 次）。
- 当蜡烛收盘价低于下轨时，策略先平掉所有多头仓位，再按设定手数加仓空头（同样受最大次数限制）。
- 每次加仓的交易量固定，由 **Volume** 参数控制，因此仓位会按等量阶梯扩展。
- 策略跟踪当前方向的平均持仓价格，用于统一计算止损、止盈和移动止损的触发点。

## 风险管理
- 止损与止盈距离以“点”（pip）为单位输入。程序会将其乘以品种的最小价格变动（PriceStep）转换为绝对价格偏移；若品种精度为 3 或 5 位小数，则额外乘以 10，以模拟 MetaTrader 中的五位定价处理。
- 移动止损距离与移动步长同样以点数表示。只有当价格从平均入场价向有利方向移动超过 `TrailingStop + TrailingStep` 点后，策略才会将止损价格上移/下移指定的 trailing stop 距离，并保持额外的步长缓冲，避免过于频繁地修改订单。
- 保护性止损在策略内部模拟：一旦收盘蜡烛触及止损或止盈水平，将通过市价单立即平仓全部头寸。

## 参数
| 参数 | 说明 |
|------|------|
| **Bollinger Period** | 计算布林带的移动平均周期。 |
| **Bollinger Deviation** | 布林带的标准差倍数。 |
| **Max Positions** | 同方向最多允许的累计加仓次数。 |
| **Volume** | 每次入场的下单量。 |
| **Stop Loss (pips)** | 止损距离（点），0 表示不启用。 |
| **Take Profit (pips)** | 止盈距离（点），0 表示不启用。 |
| **Trailing Stop (pips)** | 移动止损距离（点），0 表示不启用。 |
| **Trailing Step (pips)** | 再次移动止损前需要的额外盈利点数；启用移动止损时必须为正值。 |
| **Candle Type** | 用于计算的蜡烛类型或时间框架。 |

## 实现细节
- 使用高层 API 的蜡烛订阅与 `BindEx` 绑定指标，符合 StockSharp 的开发规范。
- 仅处理已完成的蜡烛，保持与原 MT5 脚本 "new bar" 逻辑一致。
- 由于 StockSharp 采用净持仓模式，策略在切换方向前会先平掉相反方向的仓位，再执行新的加仓。
- 当启用移动止损时会强制检查步长必须大于零，与原版专家顾问的安全限制一致。
- 本次仅提供 C# 版本，暂未包含 Python 实现。
