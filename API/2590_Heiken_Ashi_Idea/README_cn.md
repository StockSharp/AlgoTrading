# Heiken Ashi Idea 策略

## 概览

该策略使用 StockSharp 高级 API 复刻了原始的 **HeikenAshiIdea.mq4** 专家顾问。策略在两个时间框架上重建 Heikin Ashi 蜡烛，当两个周期同时给出没有反向影线的延续信号时，在市场价附近的指定距离挂出限价单，意图捕捉强势趋势的回调入场。

## 交易逻辑

1. **Heikin Ashi 重建**：在主交易周期与更高确认周期上重建 Heikin Ashi 蜡烛，并保存最近两根蜡烛以分析实体方向与影线。
2. **突破条件**：当两个周期同时满足以下条件时给出多头信号：
   - 最新 Heikin Ashi 蜡烛收阳，并且开盘价等于最低价（无下影线）；
   - 前一根 Heikin Ashi 蜡烛同样收阳，但具有下影线。
   空头信号则要求对称的条件：最新蜡烛收阴且无上影线，上一根收阴但具有上影线。
3. **ATR 波动过滤**：若启用过滤器，则平均真实波幅必须走高（`ATR[t] > ATR[t-1]`），对应原始 EA 的 `ActiveMarket` 检查。
4. **交易时段**：只在用户设定的交易时段（默认 09:00–19:00）内处理信号。
5. **挂单入场**：满足条件时仅放置一个挂单：
   - 多头：在 `收盘价 - DistancePoints * PriceStep` 处挂买入限价单；
   - 空头：在 `收盘价 + DistancePoints * PriceStep` 处挂卖出限价单。
   新信号出现前会取消相反方向的挂单，策略始终只跟踪每个方向的一张挂单。
6. **仓位管理**：可选的止盈与止损距离通过 `StartProtection` 转换成 StockSharp 的保护机制。当“平仓周期”出现新蜡烛时（参数启用），策略会取消所有挂单并平掉现有持仓，对应原始 `UseCloseAll` 功能。

## 风险控制

- 止盈止损距离以价格最小跳动（点）表示，保持与 MetaTrader 实现一致。设为 `0` 即关闭对应保护。
- 只有当挂单距离为正且下单量大于零时才会提交新挂单。
- 策略不会自动加仓，触发新方向信号之前会先撤销相反方向的挂单。
- 在判断 Heikin Ashi 蜡烛是否存在影线时，使用等于价格步长一半的容差，以避免浮点误差，同时保持与原始代码严格比较的思想一致。

## 参数

| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `DistancePoints` | 挂出限价单距离市场的价格步数。 | `8` |
| `StopLossPoints` | 止损距离（价格步），`0` 表示关闭。 | `0` |
| `TakeProfitPoints` | 止盈距离（价格步），`0` 表示关闭。 | `20` |
| `UseCloseAllOnNewBar` | 新的平仓周期蜡烛出现时是否平仓并撤单。 | `true` |
| `CandleType` | 主交易时间框架。 | `30` 分钟 |
| `HigherCandleType` | 多周期确认使用的时间框架。 | `1` 天 |
| `CloseAllCandleType` | 触发平仓流程的时间框架。 | `7` 天 |
| `StartHour` | 交易时段起始小时（含）。 | `9` |
| `EndHour` | 交易时段结束小时（含）。 | `19` |
| `UseAtrFilter` | 是否启用 ATR 上升过滤器。 | `true` |
| `AtrPeriod` | ATR 过滤器使用的周期长度。 | `14` |

## 其他说明

- 策略使用 `Strategy.Volume` 作为下单手数，请在启动前根据账户情况调整。
- 由于本实现基于蜡烛收盘价计算挂单价格，与原始 MQL 版本使用即时买卖价的结果可能略有差异，但核心思想保持不变。
- 可通过调整时间框架、交易时段和挂单距离，将该策略适配到不同市场。
