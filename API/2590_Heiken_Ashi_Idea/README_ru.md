# Стратегия Heiken Ashi Idea

## Обзор

Стратегия повторяет поведение оригинального советника **HeikenAshiIdea.mq4**, используя высокоуровневый API StockSharp. Она анализирует Heikin Ashi свечи на двух таймфреймах и выставляет отложенные лимитные заявки на заданном расстоянии, если оба таймфрейма подтверждают импульс без противоположных теней.

## Логика торговли

1. **Пересчёт Heikin Ashi** – стратегия самостоятельно формирует Heikin Ashi свечи по основному торговому таймфрейму и по старшему подтверждающему таймфрейму. Для каждого таймфрейма хранятся две последние свечи, чтобы оценивать направление тела и наличие теней.
2. **Условие входа** – длинный сигнал формируется, когда:
   - текущая Heikin Ashi свеча бычья и её открытие равно минимуму (нет нижней тени);
   - предыдущая Heikin Ashi свеча также бычья, но имеет нижнюю тень.
   Для короткого сигнала условия симметричны: текущая свеча медвежья без верхней тени, предыдущая медвежья с верхней тенью.
3. **Фильтр ATR** – при включенном фильтре средний истинный диапазон должен расти (`ATR[t] > ATR[t-1]`), что соответствует функции `ActiveMarket` в исходном коде.
4. **Торговая сессия** – сигналы игнорируются вне настроенного торгового окна (по умолчанию 09:00–19:00).
5. **Размещение заявок** – при появлении сигнала выставляется одна отложенная заявка:
   - длинная заявка: buy limit по цене `ClosePrice - DistancePoints * PriceStep`;
   - короткая заявка: sell limit по цене `ClosePrice + DistancePoints * PriceStep`.
   Перед размещением новой заявки отменяется противоположная активная заявка. Стратегия отслеживает только по одной заявке в каждом направлении и автоматически сбрасывает ссылки на исполненные или снятые заявки.
6. **Управление позицией** – опциональные значения take-profit и stop-loss задаются в шагах цены и подключаются через `StartProtection`. Если включен флаг `UseCloseAllOnNewBar`, то при появлении новой свечи выбранного таймфрейма все заявки отменяются и позиция закрывается, что повторяет поведение `UseCloseAll` в MQL.

## Управление риском

- Stop-loss и take-profit выражены в шагах цены, как в оригинальном советнике. Значение `0` отключает соответствующий уровень.
- Заявки ставятся только при положительном расстоянии и ненулевом объёме.
- Стратегия не усредняется: перед выставлением заявки в другом направлении отменяются противоположные заявки.
- Для проверки отсутствия/наличия теней используется допуск, равный половине шага цены, что позволяет избежать ошибок округления и при этом сохраняет строгие сравнения оригинала.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `DistancePoints` | Расстояние для лимитных заявок в шагах цены. | `8` |
| `StopLossPoints` | Стоп-лосс в шагах цены (`0` – выключено). | `0` |
| `TakeProfitPoints` | Тейк-профит в шагах цены (`0` – выключено). | `20` |
| `UseCloseAllOnNewBar` | Закрывать позицию и отменять заявки при новой свече таймфрейма закрытия. | `true` |
| `CandleType` | Основной торговый таймфрейм. | 30 минут |
| `HigherCandleType` | Подтверждающий таймфрейм. | 1 день |
| `CloseAllCandleType` | Таймфрейм, запускающий процедуру закрытия. | 7 дней |
| `StartHour` | Начало торгового окна (час включительно). | `9` |
| `EndHour` | Конец торгового окна (час включительно). | `19` |
| `UseAtrFilter` | Использовать ли фильтр роста ATR. | `true` |
| `AtrPeriod` | Период ATR для фильтра. | `14` |

## Дополнительные замечания

- В качестве объёма сделок используется свойство `Strategy.Volume`; скорректируйте его перед запуском.
- Из-за использования закрытия свечи для расчёта цены лимитных заявок возможны небольшие отличия от версии MT4, которая опиралась на bid/ask. Основная логика при этом сохранена.
- Подстройка таймфреймов, торгового окна и расстояния до заявок позволяет адаптировать стратегию к другим инструментам.
