# Стратегия Exp iCustom

## Обзор

`ExpICustomStrategy` — это порт классического советника MetaTrader, который торгует по буферам любого пользовательского индикатора. Конверсия сохраняет модульность оригинала и при этом использует высокоуровневый API StockSharp. Поведение стратегии полностью зависит от выбранного индикатора и настроек интерпретации его буферов.

* Единый механизм входа/выхода с настраиваемыми режимами обработки буферов индикатора.
* Индикаторы создаются отражением: задайте имя класса и параметры в виде строки `Length=14/Width=2`.
* Реализованы все ключевые блоки управления риском из MQL-версии: фиксированные стоп/профит, перевод в безубыток, классический трейлинг и сопровождение по вторичному индикатору.
* Сохранены эксплуатационные ограничения советника: «сон» между сделками, счётчики максимумов по направлению, фильтры по прибыли и расстоянию до стопа.
* В порте используется только рыночное исполнение — логика отложенных заявок сознательно опущена в соответствии с рекомендациями репозитория.

## Настройка индикаторов

Индикаторы создаются через отражение. В параметрах `EntryIndicatorName`, `CloseIndicatorName`, `TrailingIndicatorName` укажите тип (`StockSharp.Algo.Indicators.SMA` или просто `SMA`). Строка параметров разбивается по символу `/`:

```
Length=20/Width=2
```

* Если сегмент содержит `=`, левая часть трактуется как имя свойства (регистронезависимо), правая часть — значение в инвариантной культуре.
* Если `=` отсутствует, значение присваивается первому доступному числовому/логическому свойству, которое ещё не настраивалось.
* Поддерживаются типы `int`, `decimal`, `double`, `bool` и перечисления (числовые либо текстовые представления).

Строки параметров для trailing-индикатора настраиваются таким же образом. Оставьте строку пустой, если дополнительный индикатор не требуется.

## Логика входа

`EntryMode` повторяет переключатель `_O_Mode` из исходного эксперта.

1. **Arrows** — буферы трактуются как бинарные сигналы. Индексы `EntryBuyBufferIndex` и `EntrySellBufferIndex` должны указывать на буферы, выдающие ненулевые значения на баре сигнала. `EntryShift` определяет, по какому бару считывается значение (по умолчанию `1` — последний завершённый бар).
2. **Cross** — сравнение буферов `EntryMainBufferIndex` и `EntrySignalBufferIndex`. Длинный вход возникает, если основной буфер поднялся выше сигнального на текущем баре, а на предыдущем (`shift + 1`) этого не было. Для короткого входа условия зеркальные.
3. **Levels** — проверка пробоев уровней. Длинный сигнал появляется при выходе значения `EntryMainBufferIndex` выше `EntryBuyLevel`, короткий — при падении ниже `EntrySellLevel`.
4. **Slope** — разворот наклона. Для покупки текущее значение должно быть выше значения на баре `shift + 1` и на баре `shift + 2`. Для продажи — обратное условие.
5. **RangeBreak** — реакция на одноразовые метки. Появление ненулевого значения в буфере покупки при отсутствии метки на предыдущем баре генерирует новый длинный сигнал (аналогично для продаж).

Если оба направления срабатывают одновременно, сигналы взаимно гасятся, чтобы избежать неоднозначности.

## Логика выхода

`CloseMode` использует те же пять режимов и может работать либо на отдельном индикаторе, либо на индикаторе входа (`CloseUseOpenIndicator=true`). Дополнительные фильтры:

* `CheckProfit` закрывает позицию только при прибыли не меньше `MinimalProfit` пунктов.
* `CheckStopDistance` блокирует закрытие, если активный стоп находится дальше, чем `MinimalStopDistance` пунктов (когда защитный стоп уже фиксирует прибыль).

При `EntryMode = Cross` автоматически используется реверс сигнала входа — аналог `_O_Mode = 2` в MetaTrader.

## Управление риском и трейлинг

* **Фиксированные стоп/профит** — параметры `StopLossPoints` и `TakeProfitPoints` переводятся в цену с учётом шага цены инструмента. Ноль отключает соответствующий уровень.
* **Классический трейлинг** (`TrailingStopEnabled`) — после достижения прибыли в `TrailingStartPoints` пунктов стоп подтягивается на расстоянии `TrailingDistancePoints`.
* **Безубыток** (`BreakEvenEnabled`) — при прибыли `BreakEvenStartPoints` стоп переносится, фиксируя `BreakEvenLockPoints` пунктов.
* **Индикаторный трейлинг** (`IndicatorTrailingEnabled`) — на каждом баре считывается trailing-индикатор. Для лонга его значение уменьшается на `TrailingIndentPoints` и должно быть не ниже цены входа плюс `TrailingProfitLockPoints`. Стоп обновляется только в сторону усиления защиты. Для шорта всё симметрично.

Несколько модулей могут работать совместно: для лонга выбирается максимальный уровень стопа, для шорта — минимальный.

## Управление ордерами и ограничения

* `SleepBars` реализует «сон» между сделками: после открытия позиции стратегия пропускает указанное число баров для входа в том же направлении. `CancelSleeping` сбрасывает счётчик после сделки в противоположную сторону.
* `MaxOrdersCount`, `MaxBuyCount`, `MaxSellCount` ограничивают количество наращиваемых позиций. Порт StockSharp переводит текущую чистую позицию в приблизительное число сделок, исходя из базового объёма.
* Поддерживается только рыночное исполнение (`ExecutionMode.Market`). Режимы отложенных заявок (`OrdType=1/2`) исключены — высокоуровневый API рекомендует работать рыночными заявками.

## Особенности порта

* Блок money-management (`MMMethod`, `Risk`, `MeansStep`) не перенесён — используйте свойство `Volume` или параметр `BaseOrderVolume` для задания объёма сделки.
* Исходный советник обслуживал набор отложенных ордеров и несколько символов. Версия StockSharp работает с чистой позицией одного инструмента.
* Буферы индикаторов читаются без `GetValue()`: значения извлекаются через отражение из `IIndicatorValue`, поэтому подходит любой индикатор StockSharp с публичными свойствами `decimal`/`double`.

## Сводка параметров

| Параметр | Описание |
|----------|----------|
| `CandleType` | Базовый таймфрейм (по умолчанию час). |
| `EntryIndicatorName`, `EntryIndicatorParameters` | Тип и параметры индикатора для входа. |
| `EntryMode`, `EntryShift`, индексы буферов и уровни | Настройка логики входа. |
| `CloseUseOpenIndicator`, `CloseIndicatorName`, `CloseMode` и т. д. | Логика выхода. |
| `CheckProfit`, `MinimalProfit`, `CheckStopDistance`, `MinimalStopDistance` | Фильтры закрытия. |
| `SleepBars`, `CancelSleeping`, `MaxOrdersCount`, `MaxBuyCount`, `MaxSellCount` | Эксплуатационные ограничения. |
| `StopLossPoints`, `TakeProfitPoints`, `BaseOrderVolume` | Основные параметры риска и объёма. |
| `TrailingStopEnabled`, `TrailingStartPoints`, `TrailingDistancePoints` | Классический трейлинг. |
| `BreakEvenEnabled`, `BreakEvenStartPoints`, `BreakEvenLockPoints` | Перевод в безубыток. |
| `IndicatorTrailingEnabled` и параметры trailing-индикатора | Сопровождение по индикатору. |

## Рекомендации по использованию

1. Настройте `Security`, `Portfolio` и соединение с брокером стандартным для StockSharp образом.
2. Задайте `BaseOrderVolume` (или `Volume`) — размер одной заявки.
3. Опишите индикаторы и их параметры. Пример для RSI с сигнальной SMA:
   * `EntryIndicatorName = "StockSharp.Algo.Indicators.RSI"`
   * `EntryIndicatorParameters = "Length=14"`
   * `EntryMode = Cross`, `EntryMainBufferIndex = 0`
   * `CloseUseOpenIndicator = true`, `CloseMode = Cross`
4. Подберите индексы буферов и уровни под конкретный индикатор. Для составных индикаторов (например, Bollinger Bands) ориентируйтесь на публичные свойства класса значения.
5. При необходимости активируйте блоки трейлинга и безубытка.

Такой набор настроек позволяет воспроизвести поведение исходного эксперта и при этом соответствует требованиям репозитория (высокоуровневый API, `SubscribeCandles`, привязка индикаторов и отрисовка сделок).
