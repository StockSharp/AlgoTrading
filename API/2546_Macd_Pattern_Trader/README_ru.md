# Стратегия MACD Pattern Trader

## Общее описание
Стратегия является прямой конверсией советника MetaTrader **MacdPatternTraderAll0.01**. Она торгует одним инструментом, используя шесть различных паттернов на основе MACD, опциональный торговый интервал по времени, частичную фиксацию прибыли и возможность мартингейла. Все расчёты выполняются по закрытым свечам типа `CandleType`.

## Логика работы
1. На каждой закрытой свече пересчитываются шесть индикаторов MACD (для каждого паттерна свой набор быстрых/медленных EMA и сигнальная EMA длиной 1).
2. При включённом временном фильтре новые входы рассматриваются только между `SessionStart` и `SessionEnd`. Контроль рисков выполняется всегда.
3. Каждый паттерн анализирует конкретные соотношения между текущим значением MACD и двумя предыдущими, чтобы обнаружить разворот. При выполнении условий отправляется рыночная заявка и запоминаются цены стоп-лосса и тейк-профита.
4. Стоп-лосс рассчитывается как экстремум последних `StopLossBars` свечей (максимум для шорта, минимум для лонга) плюс/минус `Offset` в шагах цены. Тейк-профит ищет экстремумы в последовательных блоках свечей, повторяя рекурсивный алгоритм оригинального советника.
5. Стратегия поддерживает только одну чистую позицию. При появлении обратного сигнала текущая позиция закрывается и открывается противоположная с учётом коэффициента мартингейла.
6. Метод `ManageActivePosition` имитирует частичную фиксацию:
   - Для лонгов: если плавающая прибыль превышает 5 денежных единиц и предыдущая закрытая свеча выше средней EMA, закрывается треть позиции. Если прибыль сохраняется и максимум прошлой свечи выше среднего между SMA и медленной EMA, закрывается половина остатка.
   - Для шортов применяется зеркальный алгоритм.
7. Контроль риска проверяет каждую свечу. Если максимум или минимум свечи пробивает записанный стоп/профит, позиция закрывается по этой цене.
8. После полного закрытия позиции оценивается результат. При включённом `UseMartingale` убыточная сделка удваивает следующий объём, а прибыльная возвращает объём к базовому `LotSize`.

## Основные паттерны
- **Паттерн 1.** Ищет всплески MACD выше `Pattern1MaxThreshold` с признаками разворота и падения ниже `Pattern1MinThreshold` с отскоком.
- **Паттерн 2.** Отслеживает быстрые пересечения нулевой линии MACD с малой амплитудой.
- **Паттерн 3.** Использует пары порогов (`Pattern3MaxThreshold`, `Pattern3SecondaryMax`, `Pattern3MinThreshold`, `Pattern3SecondaryMin`) для выявления трёхэтапных разворотов и считает количество подряд идущих свечей выше второго порога (аналог переменной `bars_bup`).
- **Паттерн 4.** Входит, когда MACD пробивает основной порог, но предыдущая свеча находится внутри более узкого диапазона вторичных порогов.
- **Паттерн 5.** Реагирует на быстрые развороты MACD внутри узких коридоров (`Pattern5PrimaryMax/Min` и дополнительные границы).
- **Паттерн 6.** Использует счётчики (`Pattern6MaxBars`, `Pattern6MinBars`, `Pattern6CountBars`), требуя нескольких последовательных баров за пределами порога перед входом.

## Управление рисками
- Стоп и тейк рассчитываются при открытии каждой сделки. Стоп-лосс основан на экстремуме + смещение в шагах цены, тейк-профит рекурсивно ищет более выгодный экстремум в предыдущих блоках свечей.
- Частичные фиксации соблюдают минимальный объём 0.01 и учитывают номер срабатывания для лонгов/шортов.
- Защитные приказы на биржу не выставляются — закрытие выполняется программно по данным свечи.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Серия свечей для сигналов и индикаторов. | Часовые свечи |
| `LotSize` | Базовый объём сделки до применения мартингейла. | 0.1 |
| `UseTimeFilter` | Ограничивать торговлю часовым интервалом. | true |
| `SessionStart` / `SessionEnd` | Начало и конец торговой сессии (временная зона площадки). | 07:00 / 17:00 |
| `UseMartingale` | Удваивать объём после убыточной сделки. | true |
| `Ema1Period`, `Ema2Period`, `SmaPeriod`, `Ema3Period` | Скользящие средние для частичных выходов. | 7, 21, 98, 365 |
| Параметры паттернов | Включение, длины стоп/тейк блоков, смещения, EMA и пороги каждого паттерна. | См. значения в конструкторе |

Все параметры объявлены через `StrategyParam`, что позволяет оптимизировать стратегию в тестере.

## Дополнительные замечания
- Для корректного перевода пунктов в денежное выражение используются `PriceStep` и `PriceStepCost`. При их отсутствии расчёты ведутся напрямую в цене.
- Стопы и тейки моделируются внутри стратегии и проверяются на закрытии свечи, что может отличаться от поведения MetaTrader в режиме тиковой торговли.
- Мартингейл сильно увеличивает риск — используйте его осторожно.
