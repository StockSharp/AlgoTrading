# MACD Pattern Trader 策略

## 概述
本策略是 MetaTrader 专家顾问 **MacdPatternTraderAll0.01** 的等价移植版。策略在单一标的上运行，结合六组不同的 MACD 形态、可选的交易时段过滤、分批止盈以及可配置的马丁格尔加仓机制。所有计算均基于所设置 `CandleType` 的完结 K 线。

## 策略逻辑
1. 每根收盘 K 线都会重新计算六个 MACD 指标（每个形态拥有独立的快/慢 EMA 周期以及长度为 1 的信号线）。
2. 若启用时间过滤，仅在 `SessionStart` 与 `SessionEnd` 之间评估新的开仓信号；风险控制始终运行。
3. 各 MACD 形态通过比较当前值与前两根 K 线的 MACD 值来识别反转。当条件满足时下达市价单，并记录内部的止损/止盈价位。
4. 止损使用最近 `StopLossBars` 根 K 线的极值（空头取最高价、多头取最低价）并加/减 `Offset` 个价格步长。止盈按块扫描更久远的历史数据，逐步寻找更优的极值，以再现原始 EA 的递归算法。
5. 策略一次仅维持一个净头寸。若出现反向信号，会先平掉当前仓位，再按马丁格尔调整后的手数开立反向单。
6. `ManageActivePosition` 负责模拟原始 EA 的分批止盈：
   - 多头：当未实现收益超过 5 个货币单位且上一根 K 线收盘价高于中期 EMA 时，平掉三分之一仓位；若利润维持且上一根 K 线最高价高于 SMA 与慢速 EMA 的平均值，则再平掉剩余仓位的一半。
   - 空头：条件对称。
7. 风险控制每根 K 线都会检查是否触发内部止损或止盈。当 K 线高点或低点突破目标价位时，立即按该价格平仓。
8. 当持仓完全关闭后，如果 `UseMartingale` 为真且本次结果亏损，则下一次基础手数加倍；若盈利则将交易手数恢复为初始 `LotSize`。

## 主要形态
- **形态 1**：监测 MACD 突破 `Pattern1MaxThreshold` 后回落、以及跌破 `Pattern1MinThreshold` 后反弹的情况。
- **形态 2**：寻找 MACD 在零轴附近的快速穿越与回归。
- **形态 3**：利用双重阈值（`Pattern3MaxThreshold`/`Pattern3SecondaryMax` 与 `Pattern3MinThreshold`/`Pattern3SecondaryMin`）识别三步式反转，并统计连续高于次级阈值的次数。
- **形态 4**：当 MACD 突破主阈值但上一根 K 线仍位于更窄的次级区间时提前布局。
- **形态 5**：在 MACD 于狭窄区间内迅速翻转时入场。
- **形态 6**：通过计数器 (`Pattern6MaxBars`, `Pattern6MinBars`, `Pattern6CountBars`) 限制只有连续多根 K 线满足条件时才允许入场。

## 风险控制
- 每次开仓都会重新计算内部止损和止盈。止损基于最近极值加偏移，止盈会继续向历史回溯直到极值不再改善。
- 分批止盈遵循原策略的最小手数 0.01，并记录已执行的分批次数。
- 策略内部模拟保护价位，不会向交易所提交真实止损/止盈委托。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 用于信号和指标的 K 线类型。 | 1 小时 K 线 |
| `LotSize` | 在马丁格尔调整前的基础下单手数。 | 0.1 |
| `UseTimeFilter` | 是否限制交易时段。 | true |
| `SessionStart` / `SessionEnd` | 允许交易的起止时间（交易所时区）。 | 07:00 / 17:00 |
| `UseMartingale` | 亏损后是否将手数翻倍。 | true |
| `Ema1Period`, `Ema2Period`, `SmaPeriod`, `Ema3Period` | 分批止盈所用均线周期。 | 7, 21, 98, 365 |
| 形态相关参数 | 每个形态的启用开关、止损/止盈窗口、偏移、EMA 周期以及阈值。 | 详见构造函数 |

所有参数均通过 `StrategyParam` 暴露，便于回测和优化。

## 注意事项
- 推荐为标的提供 `PriceStep` 与 `PriceStepCost`，以便正确换算价格偏移及盈亏；若缺失则直接使用价格差值。
- 止损与止盈由策略内部判定，只在 K 线收盘时检查，因此与 MetaTrader 的逐笔执行可能存在差异。
- 马丁格尔会迅速扩大风险敞口，请谨慎使用。
