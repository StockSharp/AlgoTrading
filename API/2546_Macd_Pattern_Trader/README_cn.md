# MACD模式交易策略

## 概述

**MACD模式交易策略** 是 MetaTrader 5 智能交易系统 *MacdPatternTraderAll* 的移植版本。策略整合了六组基于 MACD 主线的独立形态，依靠主线的峰值与回撤组合在不同阈值附近寻找反转机会。每次触发都会重新计算止损和止盈价位，同时保留原始顾问中的分批减仓和慢速马丁格尔资金管理模块。

策略在单一标的和可配置的K线类型上运行，只在完成的K线上进行判断。每根K线结束时会按顺序评估六个形态，满足条件时进入新的方向。策略始终保持单一净仓位，分批出场只会减少仓位，不会同时持有多空方向。

## 交易逻辑

在 MetaTrader 版本中每个形态依次读取 `macd[1]`、`macd[2]`、`macd[3]` 三个历史值。本移植版本通过六个 `MovingAverageConvergenceDivergence` 指标复现相同的数值序列。

- **形态1（A）**：MACD 主线突破上阈值后再度回落并跌破前高时做空；跌破下阈值后反抽失败时做多。
- **形态2（B）**：关注零轴附近的翻转，主线重新穿越零轴并保持动量时沿穿越方向入场。
- **形态3（C）**：跟踪双顶/三重顶与双底/三重底，连续两次未创新高/低后第三次失败触发交易，复刻原 EA 中的 `S3`、`stops3`、`sstops` 标志逻辑。
- **形态4（D）**：记录首次突破阈值的峰值（或谷值），之后若出现更小的峰值则入场反向交易。
- **形态5（E）**：实现“重置”逻辑，主线快速越过重置线后回到触发线，按照回归方向开仓。
- **形态6（F）**：统计超过阈值的连续K线数量，在计数达到要求且未超过最大允许值时入场。

每次信号都调用 `TryOpenLong` 或 `TryOpenShort`：

* **止损**：在最近 `StopLossBars` 根K线中寻找最高价或最低价，再加上点差偏移。
* **止盈**：复刻原始 `TakeProfit` 函数的分段极值搜索算法，逐段向更早的历史寻找新的极值，直到无法刷新。

策略在K线收盘时以市价下单，并记录计算得到的止损和止盈价位，后续K线会检查是否触发退出条件。

## 仓位管理

* `Initial Volume` 定义基础手数；当 `Slow Martingale` 开启且上一笔交易亏损时，下一次下单手数翻倍，盈利则恢复基础手数。
* 多头持仓当浮盈超过5个最小价位且前一根K线收盘价高于 EMA(21) 时减仓三分之一；若前一根K线最高价超过 SMA(98) 与 EMA(365) 的平均值，再减仓一半。空头逻辑完全对称。
* 每次进场都会重新计算止损止盈，一旦价格越过任一水平，立即平掉剩余仓位。

## 参数说明

| 参数 | 含义 |
|------|------|
| **Candle Type** | 工作周期与K线类型。 |
| **Time Filter / Start / Stop** | 交易时段过滤器。 |
| **Initial Volume** | 初始手数。 |
| **Min Volume** | 最小下单手数。 |
| **Slow Martingale** | 是否启用慢速马丁加仓。 |
| **Pattern N Enable** | 是否启用第 N 个形态。 |
| **Pattern N Stop Bars / Take Bars / Offset** | 止损回溯根数、止盈搜索根数以及止损偏移。 |
| **Pattern N Fast EMA / Slow EMA** | 每个形态的 MACD 快速/慢速均线周期。 |
| **Pattern thresholds** | 各形态使用的上下触发阈值。 |
| **Pattern 6 Counters** | 形态6的计数、最大值和最小值限制。 |
| **EMA/SMA Periods** | 分批出场所需的三条均线周期。 |

默认值与 MetaTrader 智能交易系统完全一致，便于对照验证。

## 使用建议

1. 在 StockSharp 环境中加载策略，设置标的与K线类型。
2. 根据需求开启或关闭不同形态，以聚焦特定的 MACD 行为模式。
3. 如需限制交易时间，可调整 `Time Filter`、`Start` 和 `Stop` 参数。
4. 根据标的波动性调整止损、止盈窗口和点差偏移。
5. 关注策略日志中的 `PatternX: buy/sell` 信息，了解信号来源和计算出的保护价位。

## 与 MetaTrader 版本的差异

* StockSharp 版本使用市价单并在内部监控止损/止盈，未在撮合层直接挂出保护单。
* 下单手数按照交易所提供的 `VolumeStep` 进行舍入，若无数据则使用 0.01 手。
* 分批减仓与马丁格尔逻辑仍基于原始阈值，但执行在每根完成的K线之后。

整体参数和信号结构保持原样，方便从 MetaTrader 平台迁移到 StockSharp 时继续使用相同的交易思路。
