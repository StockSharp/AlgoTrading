# Стратегия Exp AFIRMA

## Обзор

**Exp AFIRMA** — порт на StockSharp оригинального советника `Exp_AFIRMA.mq5`. В основе лежит индикатор AFIRMA (Adaptive Finite
Impulse Response Moving Average), который сочетает фильтр конечной импульсной характеристики с прогнозирующим блоком ARMA. В
переносе полностью сохранена логика: покупка открывается, когда прогноз ARMA разворачивается вверх, продажа — когда наклон
становится отрицательным. Анализ выполняется по закрытым свечам выбранного таймфрейма (по умолчанию H4).

Стратегия записывает последовательность значений ARMA и сравнивает наклон трёх последовательных баров. Перед сменой направления
приказы на закрытие текущей позиции отправляются раньше, чем команды на открытие противоположной. Для управления рисками можно
включить автоматическое выставление стоп-лосса и тейк-профита средствами StockSharp.

## Торговая логика

1. **Расчёт индикатора**
   - Встроенный `AfirmaIndicator` пересчитывает фильтр AFIRMA. FIR-часть использует `Taps` коэффициентов, умноженных на выбранное
     окно (`Rectangular`, `Hanning1`, `Hanning2`, `Blackman`, `BlackmanHarris`). Параметр `Periods` задаёт полосу пропускания
     (в терминах исходного советника — `1/(2*Periods)`).
   - Прогноз ARMA вычисляется методом наименьших квадратов с теми же суммами `sx2…sx6`, что и в MQL-версии. Индикатор возвращает
     обе линии (FIR и ARMA), что позволяет визуализировать их на графике.
2. **Выявление сигналов**
   - После закрытия каждой свечи сохраняется новое значение ARMA. Параметр `SignalBar` определяет, сколько закрытых баров следует
     пропустить. Значение `1` соответствует анализу баров *t-1, t-2, t-3* и исполнению сделок в начале бара *t*.
   - **Бычий сценарий**: `ARMA[t-2] < ARMA[t-3]` и одновременно `ARMA[t-1] > ARMA[t-2]`. При выполнении условия разрешается
     закрытие шорта и открытие/наращивание лонга.
   - **Медвежий сценарий**: `ARMA[t-2] > ARMA[t-3]` и `ARMA[t-1] < ARMA[t-2]`. Это приводит к закрытию лонга и открытию/усилению
     короткой позиции.
3. **Управление позицией**
   - Поддерживается одна совокупная позиция. При появлении нового сигнала целевой размер приводит позицию к `±TradeVolume`.
   - При срабатывании встречных условий сначала отменяются активные заявки (`CancelActiveOrders()`), затем закрывается текущая
     позиция и только после этого выставляется встречная сделка.
   - При наличии ненулевых `StopLossPoints` и/или `TakeProfitPoints` запускается `StartProtection`, создающий защитные ордера в
     ценовых единицах.

## Параметры

| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Базовый объём позиции для открытия лонгов и шортов. |
| `CandleType` | Таймфрейм свечей, по которым рассчитывается индикатор. |
| `Periods` | Ширина полосы фильтра FIR (`1/(2*Periods)`), как в оригинальном советнике. |
| `Taps` | Количество коэффициентов FIR. Внутри автоматически корректируется к ближайшему нечётному значению. |
| `Window` | Тип окна для сглаживания коэффициентов (прямоугольное, Ханнинга, Хемминга и т.д.). |
| `SignalBar` | Количество закрытых баров, которые нужно пропустить при подтверждении сигнала. Значение `1` соответствует последнему полностью закрытому бару. |
| `EnableBuyEntries` / `EnableSellEntries` | Разрешение на открытие длинных/коротких позиций. |
| `EnableBuyExits` / `EnableSellExits` | Разрешение на автоматическое закрытие длинных/коротких позиций. |
| `StopLossPoints` | Дистанция стоп-лосса в ценовых единицах. |
| `TakeProfitPoints` | Дистанция тейк-профита в ценовых единицах. |

## Особенности конвертации

- Параметры управления капиталом из MQL (`MM`, `MMMode`, `Deviation_`) заменены на единый параметр `TradeVolume`. Для сложного
  манименеджмента используйте настройки портфеля StockSharp или внешние модули.
- В оригинале стоп и тейк задавались в пунктах. Здесь они трактуются как абсолютные ценовые величины, что упрощает перенос на
  разные инструменты. При необходимости умножайте значение на шаг цены.
- Значение `SignalBar = 1` полностью повторяет вызов `CopyBuffer` со смещением в советнике: анализируются три закрытых значения
  ARMA, а сделки подаются на следующей свече. При `SignalBar = 0` стратегия по-прежнему использует последнее закрытое значение,
  потому что вычисления выполняются только по завершённым свечам.
- Реализация `AfirmaIndicator` воспроизводит математическую модель оригинала, что позволяет накладывать линии FIR и ARMA на
  график для визуальной проверки.

## Рекомендации по использованию

1. Привяжите стратегию к нужному инструменту и портфелю, выставьте `TradeVolume` и таймфрейм через `CandleType`.
2. Уточните разрешение на работу в длинную и короткую сторону, используя соответствующие флаги.
3. Задайте `StopLossPoints` и `TakeProfitPoints`, если требуется автоматическое сопровождение позиций.
4. При оптимизации параметров наблюдайте за визуализацией на графике, чтобы контролировать согласованность линий FIR/ARMA и
   реальных сделок.
