# Стратегия Psar Bug

## Общее описание
**Psar Bug** — порт советника MetaTrader 4 `pSAR_bug.mq4`. Стратегия реагирует на первое появление точки Parabolic SAR по другую сторону от цены и сразу разворачивает позицию. В реализации StockSharp используется подписка на свечи, обработка только завершённых баров и высокоуровневый API для отправки рыночных ордеров и автоматического сопровождения стоп-приказов.

## Логика торговли
- Рассчитывается Parabolic SAR с настраиваемыми параметрами ускорения (по умолчанию `0.02`) и максимального ускорения (`0.2`).
- Сигнал формируется только на завершённой свече:
  - **Покупка** — текущий SAR находится ниже цены закрытия, тогда как на предыдущей свече SAR был выше закрытия, что означает смену направления индикатора.
  - **Продажа** — текущий SAR выше цены закрытия, а предыдущий SAR был ниже, что указывает на разворот вниз.
- При каждом сигнале позиция разворачивается: при сигнале на покупку закрываются все шорты и открывается лонг заданного объёма, при сигнале на продажу выполняется противоположная операция.
- Применяются фиксированные стоп-лосс и тейк-профит, задаваемые в шагах цены. Модуль защиты запускается через `StartProtection`, поэтому уровни автоматически прикрепляются к новым позициям.

## Параметры
| Название | Описание |
| --- | --- |
| `TradeVolume` | Объём заявки в лотах, по умолчанию `0.1`. |
| `StopLossPoints` | Дистанция до стоп-лосса в шагах цены, аналог параметра `StopLoss` в исходном советнике. |
| `TakeProfitPoints` | Дистанция до тейк-профита в шагах цены, аналог параметра `TakeProfit`. |
| `SarAccelerationStep` | Начальный коэффициент ускорения Parabolic SAR. |
| `SarAccelerationMax` | Максимальный коэффициент ускорения Parabolic SAR. |
| `CandleType` | Тип свечей (таймфрейм), используемый для расчётов. По умолчанию — 15 минут. |

## Особенности портирования
- В MetaTrader робот работает на активе и таймфрейме текущего графика. В StockSharp таймфрейм вынесен в параметр, что упрощает тестирование на разных интервалах.
- Стоп-приказы переводятся в абсолютные ценовые смещения и передаются менеджеру защитных ордеров один раз при запуске.
- Для разворота позиции применяется неттинговая логика: покупка или продажа объёма `Volume + |Position|` одновременно закрывает старый объём и открывает новый, тем самым повторяя оригинальный алгоритм "сначала закрыть, потом открыть".

## Как использовать
1. В Designer или Backtester выберите инструмент, задайте `CandleType`, объём и уровни риска.
2. Убедитесь в наличии рыночных данных и запустите стратегию. Сигналы проверяются только после закрытия свечи.
3. Наблюдайте за свечами, кривой Parabolic SAR и сделками на графике, чтобы контролировать исполнение разворотных сигналов.
