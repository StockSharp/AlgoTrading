# Psar Bug 策略

## 概述
**Psar Bug 策略** 来自 MetaTrader 4 专家顾问 `pSAR_bug.mq4`，核心思想是在抛物线 SAR 第一次翻转到价格另一侧时立即反手。StockSharp 版本订阅蜡烛数据，只在蜡烛完成后计算，并借助高级 API 下达市价单，同时自动维护止损和止盈。

## 交易逻辑
- 按可配置的加速因子（默认 `0.02`）和最大加速因子（默认 `0.2`）计算抛物线 SAR。
- 只在蜡烛状态为 `Finished` 时评估信号：
  - **做多信号**：当前 SAR 低于收盘价，且上一根蜡烛的 SAR 高于上一根收盘价，意味着指标从上方翻转到下方。
  - **做空信号**：当前 SAR 高于收盘价，且上一根蜡烛的 SAR 低于上一根收盘价，意味着指标从下方翻转到上方。
- 每次出现信号时都将仓位反向：出现买入信号时平掉所有空头并以设定手数开多，卖出信号时执行相反操作。
- 使用以最小报价步长表示的固定止损与止盈距离。通过 `StartProtection` 初始化保护参数，平台会自动为每一笔新仓位附加对应的风险控制。

## 参数说明
| 名称 | 描述 |
| --- | --- |
| `TradeVolume` | 下单手数，默认 `0.1` 手。 |
| `StopLossPoints` | 止损距离，按照价格步长计量，对应原版 `StopLoss` 输入。 |
| `TakeProfitPoints` | 止盈距离，按照价格步长计量，对应原版 `TakeProfit` 输入。 |
| `SarAccelerationStep` | 抛物线 SAR 的初始加速因子。 |
| `SarAccelerationMax` | 抛物线 SAR 的最大加速因子。 |
| `CandleType` | 指标计算使用的蜡烛类型（时间框架），默认 15 分钟。 |

## 转换要点
- 原始 EA 直接使用图表上的周期与品种，迁移版将时间框架暴露为参数，方便在 Backtester 或 Designer 中调整。
- 止损与止盈以绝对价格位移表示，并在启动时一次性配置到保护模块中。
- 通过净额逻辑实现“先平仓再开仓”的效果：当出现反向信号时，买入 `Volume + |Position|` 手可以同时平掉已有仓位并建立新的方向，从而复现 MetaTrader 的处理方式。

## 使用步骤
1. 在 StockSharp Designer 或 Backtester 中选择交易品种、`CandleType` 以及风险参数。
2. 确保数据源可用后启动策略；策略只在蜡烛收盘后触发信号。
3. 借助平台提供的图表功能观察蜡烛、抛物线 SAR 以及成交记录，以验证翻转逻辑的执行情况。
