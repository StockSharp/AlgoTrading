# MP 烛形策略

## 概述
**MP 烛形策略** 是将 MetaTrader 5 专家顾问 `mp candlestick.mq5` 移植到 StockSharp 高级策略框架的结果。系统基于完成蜡烛的方向选择交易方向，同时执行严格的资金与风险管理。策略既支持以 MetaTrader 点 (pip) 表示的固定止损距离，也支持基于平均真实波幅 (ATR) 的自适应止损方案。

## 交易逻辑
1. 订阅一个可配置的蜡烛序列（默认：1 小时蜡烛）。
2. 当出现新的完结蜡烛时：
   - 收盘价高于开盘价 → 计划做多。
   - 收盘价低于开盘价 → 计划做空。
   - 开收盘相同或几乎相同的十字星将被忽略。
3. 在入场前根据设定的模式计算止损价位：
   - 若启用 ATR，则使用 ATR × 1.5 作为止损距离。
   - 若禁用 ATR，则使用输入的固定点数转换成价格距离。
4. 使用设定的风险收益比计算目标价，验证预估保证金占用是否低于阈值，并根据风险金额得出下单手数。
5. 成交后在后续蜡烛中监控：
   - 通过蜡烛最高价/最低价检测是否触发止损或止盈。
   - 当启用 ATR 风控时，动态上调/下调止损价位以跟随价格。
6. 仓位平仓后重新等待下一根完结蜡烛以寻找新的机会。

## 风险与资金管理
- **Risk Percent** 控制账户权益中可承受的最大亏损比例，基于止损距离与合约步长计算下单量。
- **Risk/Reward Ratio** 将初始风险距离乘以指定倍数，用以确定止盈价位。
- **Max Margin Usage** 限制新仓所需的预估保证金占当前权益的百分比，防止过度杠杆。
- **Trailing Stop** 在启用 ATR 的情况下自动生效，在不超过最新收盘价的前提下，把止损向盈利方向移动以锁定收益。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `RiskPercent` | 1 | 单笔交易允许承担的权益百分比。 |
| `RiskRewardRatio` | 1.5 | 止盈距离与初始风险距离之间的倍数关系。 |
| `MaxMarginUsage` | 30 | 估算保证金占用的上限（权益百分比）。 |
| `StopLossPips` | 50 | 关闭 ATR 时使用的固定止损点数。 |
| `UseAutoSl` | true | 是否启用 ATR × 1.5 的自适应止损。 |
| `CandleType` | 1 小时时间框架 | 信号与 ATR 计算使用的蜡烛序列。 |

## 实现要点
- 使用 StockSharp 的 `SubscribeCandles` 和 `AverageTrueRange` 指示器绑定实现高层数据流。
- 仓位大小符合交易品种的成交量步长、最小及最大手数约束。
- 保证金检查优先使用合约提供的 `MarginBuy`/`MarginSell` 信息，不可用时退化为价格近似。
- 通过监控蜡烛极值来触发止损与止盈，保证不同交易所环境的一致性。
- 代码中的注释全部使用英文，以符合转换指南的要求。

## 文件列表
- `CS/MpCandlestickStrategy.cs` — C# 主策略实现。
- `README.md` — 英文文档。
- `README_cn.md` — 中文文档（本文件）。
- `README_ru.md` — 俄文文档。
