# Стратегия MP Candlestick

## Общее описание
**MP Candlestick Strategy** — это конвертация эксперта MetaTrader 5 `mp candlestick.mq5` в стратегию StockSharp. Система анализирует завершённые свечи и открывает позиции по направлению свечи, строго контролируя риск. Доступен фиксированный стоп-лосс в пунктах MetaTrader, а также адаптивный стоп на основе индикатора Average True Range (ATR).

## Логика торговли
1. Стратегия подписывается на одну настраиваемую серию свечей (по умолчанию часовые свечи).
2. После закрытия каждой свечи выполняется анализ:
   - Закрытие выше открытия → рассматривается покупка.
   - Закрытие ниже открытия → рассматривается продажа.
   - Нейтральные свечи типа доджи пропускаются.
3. До открытия позиции вычисляется цена стоп-лосса:
   - При включённом ATR стоп равен ATR × 1.5.
   - При выключенном ATR используется фиксированное количество пунктов.
4. Цель по прибыли рассчитывается умножением стартового риска на заданный коэффициент `Risk/Reward`.
5. Открытие позиции выполняется только при соблюдении ограничений по марже и корректности рассчитанного объёма.
6. Пока позиция активна стратегия:
   - Проверяет экстремумы свечи на предмет срабатывания стоп-лосса или тейк-профита.
   - При использовании ATR подтягивает стоп-лосс ближе к цене, фиксируя прибыль.
7. После закрытия позиции ожидание продолжается до следующей завершённой свечи.

## Управление рисками и капиталом
- **Risk Percent** задаёт долю капитала, которую допускается потерять в одной сделке; объём вычисляется через шаг цены и расстояние до стопа.
- **Risk/Reward Ratio** определяет, во сколько раз цель по прибыли превышает стартовый риск.
- **Max Margin Usage** ограничивает долю используемой маржи от текущей стоимости портфеля, что предотвращает чрезмерную загрузку плеча.
- **Trailing Stop** активен при работе с ATR: стоп подтягивается в направлении прибыли, но не превышает ограничения по последней цене закрытия.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `RiskPercent` | 1 | Максимальная доля капитала, которую можно потерять в сделке. |
| `RiskRewardRatio` | 1.5 | Отношение цели по прибыли к изначальному риску. |
| `MaxMarginUsage` | 30 | Предельная доля маржи от стоимости портфеля. |
| `StopLossPips` | 50 | Фиксированный стоп-лосс в пунктах при отключённом ATR. |
| `UseAutoSl` | true | Использовать ATR × 1.5 для адаптивного стопа. |
| `CandleType` | Часовой таймфрейм | Серия свечей для сигналов и расчёта ATR. |

## Особенности реализации
- Используется высокоуровневое API StockSharp (`SubscribeCandles`, `AverageTrueRange`).
- Объём приводится к шагу объёма инструмента с учётом минимальных и максимальных ограничений.
- Проверка маржи опирается на доступные поля `MarginBuy`/`MarginSell`, при их отсутствии применяется оценка через цену.
- Стоп-лосс и тейк-профит контролируются программно через анализ ценовых экстремумов свечей, что обеспечивает одинаковую логику на разных площадках.
- Все комментарии в коде приведены на английском языке согласно требованиям.

## Файлы
- `CS/MpCandlestickStrategy.cs` — реализация стратегии на C#.
- `README.md` — документация на английском языке.
- `README_cn.md` — документация на китайском языке.
- `README_ru.md` — документация на русском языке (данный файл).
