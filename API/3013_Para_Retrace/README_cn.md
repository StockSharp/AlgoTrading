# Para Retrace 策略

## 概述
**Para Retrace Strategy** 是将 MetaTrader 4 指标专家 `Para_Retrace.mq4` 转换为 C# 的版本。策略核心仍然是利用 Parabolic SAR 指标作为动态锚点，当价格回撤到该水平附近时才入场。实现中使用了 StockSharp 的高级 API，方便地完成行情订阅、指标绑定以及订单执行。

## 交易逻辑
1. 在每根收盘的 K 线（完成状态）上计算 Parabolic SAR，参数包括加速步长和最大加速度。
2. 根据价格相对 SAR 的位置确定行情方向：
   - **空头环境**：当整根 K 线（最高价和最低价）都位于 SAR 之下。
   - **多头环境**：其它情况（价格触及或位于 SAR 之上）。
3. 按照设定的点差（pips）对 SAR 值进行偏移，得到入场触发价：
   - 空头环境下，用 SAR 减去偏移，等待价格反弹到该位置再做空。
   - 多头环境下，用 SAR 加上偏移，等待价格回落到该位置再做多。
4. 当价格触及触发价（K 线最高价突破触发价做空，或最低价跌破触发价做多）时，发送市价单顺势入场。
5. 通过 `StartProtection` 自动附加止损和止盈，距离与原脚本一致。

与原脚本不同，StockSharp 版本在开仓后不会清空偏移值，策略会持续寻找下一次机会。同时，只在完整 K 线上进行判断，避免了盘中数据造成的差异。

## 使用指标
- **Parabolic SAR**：用于判定趋势方向并计算入场价位。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `SarStep` | Parabolic SAR 的初始加速系数。 | `0.01` |
| `SarMax` | Parabolic SAR 的最大加速系数。 | `0.2` |
| `RetraceOffsetPips` | SAR 与触发价之间的点差（pips）。 | `30` |
| `StopLossPips` | 止损距离（pips，转换为绝对价格）。设为 `0` 表示不启用。 | `30` |
| `TakeProfitPips` | 止盈距离（pips，转换为绝对价格）。设为 `0` 表示不启用。 | `30` |
| `CandleType` | 用于计算的 K 线周期。 | `5 分钟` |

> **提示：** 策略会根据品种的最小价格变动估算点值。如果报价有五位小数（常见于外汇），一个 pip 等于十个最小价格步长。

## 订单管理
- 触发条件满足后使用市价单进场。
- 默认下单量为 `Volume = 1`，可以在启动策略前修改基础 `Strategy.Volume` 属性。
- 通过 `StartProtection` 自动下达止损和止盈订单，距离由参数换算得到。

## 使用建议
- 根据标的物的波动性调整偏移、止损和止盈参数。
- 在组合策略时可以添加额外过滤条件（时间、波动、成交量等）。
- 在实盘运行前请务必完成历史回测和模拟账户验证。

## 与原版的差异
- 不再依赖全局变量，开仓后无需手动复位即可继续交易。
- 只处理收盘后的 K 线，回测结果更加稳定、可复现。
- 使用 StockSharp 的保护性订单模块统一处理止损止盈。

## 免责声明
本策略仅供学习交流使用。在投入真实资金之前，请进行充分测试与验证。
