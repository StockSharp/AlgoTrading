# Стратегия Para Retrace

## Описание
**Para Retrace Strategy** — это портированная на C# версия советника MetaTrader 4 `Para_Retrace.mq4`. Логика основана на индикаторе Parabolic SAR, который используется как динамический ориентир: стратегия ожидает возврата цены к значению SAR и только затем входит в сделку. Для работы применяется высокоуровневый API StockSharp, что упрощает подписку на данные, вычисление индикаторов и выставление заявок.

## Логика торговли
1. На каждой закрытой свече рассчитывается значение Parabolic SAR с заданными параметрами шага и максимального ускорения.
2. Определяется контекст:
   - **Медвежий** — если максимум и минимум свечи находятся ниже значения SAR.
   - **Бычий** — во всех остальных случаях (цена касается или находится выше SAR).
3. Для входа вычисляется целевая цена: к значению SAR прибавляется или вычитается заданное количество пунктов.
4. Когда цена касается целевого уровня (для шорта — максимум свечи достигает уровня, для лонга — минимум опускается ниже), отправляется рыночная заявка по направлению тренда.
5. Стоп-лосс и тейк-профит выставляются автоматически через `StartProtection`, дистанции соответствуют исходному советнику.

В отличие от оригинала, в версии StockSharp после совершения сделки нет необходимости вручную сбрасывать смещение: стратегия продолжает торговать на следующих сигналах. Обработка ведётся только по завершённым свечам, что повышает повторяемость результатов тестирования.

## Индикаторы
- **Parabolic SAR** — используется для определения тренда и расчёта уровней входа.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `SarStep` | Начальный коэффициент ускорения Parabolic SAR. | `0.01` |
| `SarMax` | Максимальный коэффициент ускорения Parabolic SAR. | `0.2` |
| `RetraceOffsetPips` | Смещение в пунктах между значением SAR и уровнем входа. | `30` |
| `StopLossPips` | Дистанция стоп-лосса в пунктах (переводится в абсолютную цену). `0` — отключить. | `30` |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах (переводится в абсолютную цену). `0` — отключить. | `30` |
| `CandleType` | Таймфрейм свечей для расчётов. | `5 минут` |

> **Важно:** Размер пункта оценивается по характеристикам инструмента. Для инструментов с пятью знаками после запятой один пункт равен десяти минимальным шагам цены.

## Управление заявками
- Входы осуществляются по рынку после достижения целевого уровня.
- Базовый объём позиции — `Volume = 1`, при необходимости измените его перед запуском стратегии.
- `StartProtection` автоматически создаёт стоп-лосс и тейк-профит на основе указанных смещений.

## Рекомендации по использованию
- Подберите параметры смещения, стопа и цели под волатильность торгуемого инструмента.
- При интеграции в сложные торговые системы добавляйте фильтры (время, волатильность и т. д.).
- Перед реальной торговлей обязательно протестируйте стратегию на истории и демо-счетах.

## Отличия от исходного советника
- Нет необходимости вручную сбрасывать глобальные переменные после сделки.
- Используются завершённые свечи вместо тиковых проверок, что делает результаты бэктеста детерминированными.
- Риск-менеджмент реализован через встроенный механизм защитных ордеров StockSharp.

## Отказ от ответственности
Стратегия предоставляется исключительно в образовательных целях. Перед использованием на реальном счёте проведите тщательное тестирование.
