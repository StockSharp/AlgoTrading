# Стратегия Contrarian Trade MA
[English](README.md) | [中文](README_cn.md)

Недельная контртрендовая система, перенесённая из исходного MQL-советника "Contrarian_trade_MA". Алгоритм оценивает экстремумы недельных свечей и простую скользящую среднюю, чтобы входить против избыточных движений в начале новой торговой недели.

## Логика торговли

- **Источник данных**: Недельные свечи, задаются параметром `CandleType` (по умолчанию таймфрейм 7 дней).
- **Исторические экстремумы**: Индикаторы `Highest` и `Lowest` отслеживают максимум и минимум прошлых `CalcPeriod` завершённых недель, исключая текущую свечу.
- **Фильтр средней**: Простая скользящая средняя длиной `MaPeriod`, рассчитанная по закрытиям недель, формирует дополнительное условие направления.
- **Условия входа**:
  - **Покупка**, если закрытие прошлой недели выше сохранённого максимума (`highest < previousClose`), либо если средняя находится выше открытия текущей недели.
  - **Продажа**, если закрытие прошлой недели ниже сохранённого минимума (`lowest > previousClose`), либо если средняя находится ниже открытия текущей недели.
  - Одновременно допускается только одна позиция; противоположные сигналы игнорируются до закрытия сделки.
- **Условия выхода**:
  - Позиция закрывается по истечении семи дней (604 800 секунд) независимо от направления.
  - Защитный стоп контролируется на каждой завершённой недельной свече. Дистанция рассчитывается как `StopLossPoints * PriceStep` (при отсутствии шага цены подставляется значение `1`).

## Параметры

| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CalcPeriod` | `4` | Число завершённых недель, используемых для расчёта экстремумов. |
| `MaPeriod` | `7` | Период простой скользящей средней по закрытиям недель. |
| `StopLossPoints` | `300` | Дистанция до стоп-лосса в шагах цены. Значение `0` отключает стоп. |
| `Volume` | `0.5` | Размер ордера в лотах при исполнении `BuyMarket`/`SellMarket`. |
| `CandleType` | `7 дней` | Таймфрейм свечей, на которых выполняются расчёты. |

## Дополнительные замечания

- Стратегия получает шаг цены из `Security.PriceStep`. Заполните это поле в описании инструмента, чтобы стоп-лосс рассчитывался корректно.
- Метод `StartProtection()` активирован для отслеживания изменений позиции, сделанных вручную или другими стратегиями.
- Поскольку логика основана на завершённых недельных свечах, в режиме тестирования входы моделируются по цене закрытия сигнальной свечи.
