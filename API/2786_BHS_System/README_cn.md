# BHS System 策略

## 概述

BHS System 是将原始 MetaTrader 5 专家顾问移植到 StockSharp 高级 API 的突破型策略。策略跟踪收盘价与 Kaufman 自适应移动平均线（AMA）之间的关系：当收盘价高于 AMA 时，为潜在的多头突破做准备；当收盘价低于 AMA 时，为潜在的空头扩张做准备。算法不会立刻进场，而是等待价格触及用户指定的“整数关口”，并在这些价位挂出止损单，从而完全复刻 MQL 版本始终在圆整价位挂单的行为。

## 交易逻辑

1. 每根完成的 K 线都会根据设置的点数步长和合约的最小价格变动，计算出最近的上方和下方圆整价位。
2. 将上一根 K 线的 AMA 数值（对应原始 MQL 中的 `iAMAGet(1)`）与当前 K 线的收盘价进行比较。
3. 若没有持仓且没有挂出的入场单：
   - 当收盘价大于 AMA 时，在圆整价位的上方挂出买入止损单；
   - 当收盘价小于 AMA 时，在圆整价位的下方挂出卖出止损单。
4. 入场挂单会按照设置的小时数自动失效，对应 MT5 中的挂单有效期。
5. 当挂单成交后，会取消相反方向的挂单，并按设定的止损距离注册保护性止损单，同时开始跟踪止损逻辑。
6. 只有当价格向有利方向移动超过“跟踪距离 + 跟踪步长”时，才会移动止损，以避免频繁修改订单并忠实还原 MQL 版本的离散式跟踪机制。

## 风险控制

- **初始止损：** 多空独立的点数距离会换算成绝对价格偏移，在入场后立即生成保护性止损单。
- **跟踪止损：** 多单与空单拥有独立的跟踪距离，只有当新的止损价相对旧价至少改善一个跟踪步长时才会移动，防止在震荡环境中过度调整。
- **挂单失效：** 入场挂单会记录创建时间，当挂单存续时间超过设定值时自动撤单，避免长时间暴露。

## 参数

- `OrderVolume` – 入场与保护性订单使用的手数。
- `StopLossBuyPoints` / `StopLossSellPoints` – 多头与空头的初始止损点数。
- `TrailingStopBuyPoints` / `TrailingStopSellPoints` – 多头与空头的跟踪止损点数。
- `TrailingStepPoints` – 每次更新跟踪止损所需的额外点数间隔。
- `RoundStepPoints` – 用于计算圆整价位的点数步长。
- `ExpirationHours` – 入场挂单的有效期（小时），为 0 时表示不过期。
- `AmaLength`、`AmaFastPeriod`、`AmaSlowPeriod` – Kaufman AMA 指标的参数。
- `CandleType` – 驱动策略的 K 线数据类型或周期。

## 实现说明

- 策略使用 StockSharp 自带的 `KaufmanAdaptiveMovingAverage` 指标，并采用文件级命名空间以符合仓库规范。
- 所有交易动作均通过高级 API（`BuyStop`、`SellStop`、`CancelOrder` 等）完成，不调用任何 `GetValue` 方法读取指标值。
- 若存在图表上下文，策略会绘制价格、AMA 曲线以及自身成交记录，方便可视化分析。
- 保护性止损与跟踪止损共用同一个订单引用，从而在更新时直接修改原有止损单，避免产生多余订单。
- 代码中的注释全部使用英文，并保持与原始 MQL 版本一致的跟踪触发条件，确保移植后的行为一致。
