# Стратегия BHS System

## Обзор

BHS System — это порт оригинального советника MetaTrader 5 на платформу StockSharp, работающий по логике пробоя. Стратегия отслеживает положение цены относительно адаптивной скользящей средней Кауфмана (Kaufman Adaptive Moving Average, AMA). Если свеча закрывается выше AMA, готовится покупка через отложенный buy stop; если закрытие ниже AMA — готовится sell stop. Заявки выставляются только на «круглых» ценовых уровнях, определяемых пользователем, что полностью повторяет механику исходного MQL-кода.

## Логика торговли

1. После завершения каждой свечи вычисляются ближайшие сверху и снизу округлённые уровни. Для расчёта используется шаг в пунктах, заданный пользователем, и минимальный шаг цены инструмента.
2. Текущее закрытие сравнивается с предыдущим значением AMA (значение индикатора со смещением на одну свечу, как и в функции `iAMAGet(1)` исходного робота).
3. При отсутствии позиции и активных заявок:
   - если закрытие выше AMA, выставляется buy stop на ближайшем округлённом уровне выше цены;
   - если закрытие ниже AMA, выставляется sell stop на ближайшем округлённом уровне ниже цены.
4. Каждая заявка имеет ограниченный срок жизни в часах. По его истечении невыполненные заявки снимаются, что соответствует параметру Expiration в MT5.
5. После исполнения отложенного ордера противоположная заявка отменяется, создаётся защитный стоп по заданной дистанции и запускается механизм трейлинга.
6. Трейлинг переносит стоп только тогда, когда цена продвинулась на величину «дистанция + шаг трейлинга», что исключает постоянные модификации и повторяет дискретную схему MQL-версии.

## Управление рисками

- **Первичный стоп-лосс:** для длинных и коротких позиций задаются отдельные расстояния в пунктах. После сделки они переводятся в абсолютные цены и используются для размещения защитного стоп-ордера.
- **Трейлинг-стоп:** расстояния для лонга и шорта задаются отдельно. Перенос стопа выполняется только при улучшении не менее чем на один шаг трейлинга, что предотвращает излишние корректировки во флэте.
- **Истечение заявок:** каждая заявка хранит время создания. Если она активна дольше разрешённого срока, стратегия её отменяет, не позволяя заявкам «зависать» в рынке.

## Параметры

- `OrderVolume` — объём заявок (в лотах) для входа и защитных ордеров.
- `StopLossBuyPoints` / `StopLossSellPoints` — расстояние до первоначального стоп-лосса в пунктах для длинных и коротких сделок.
- `TrailingStopBuyPoints` / `TrailingStopSellPoints` — дистанция трейлинг-стопа в пунктах для лонга и шорта.
- `TrailingStepPoints` — минимальное дополнительное смещение (в пунктах) перед очередным переносом стопа.
- `RoundStepPoints` — число пунктов, определяющее сетку округлённых цен.
- `ExpirationHours` — срок жизни отложенных ордеров в часах (0 — бессрочно).
- `AmaLength`, `AmaFastPeriod`, `AmaSlowPeriod` — параметры адаптивной скользящей средней Кауфмана.
- `CandleType` — тип и таймфрейм свечей, используемых в расчётах.

## Особенности реализации

- Используется индикатор `KaufmanAdaptiveMovingAverage` из библиотеки StockSharp, код оформлен с файловой областью имён согласно стандартам репозитория.
- Для торговли применяются высокоуровневые методы (`BuyStop`, `SellStop`, `CancelOrder`), индикаторные значения не извлекаются через `GetValue`.
- При наличии графического окружения выводятся свечи, линия AMA и собственные сделки стратегии для наглядного контроля.
- Один и тот же ордер используется как для начального стопа, так и для последующих трейлинговых переносов, что избегает избыточных заявок.
- В коде сохранены комментарии на английском языке и полностью воспроизведены условия срабатывания трейлинга из MQL-версии, обеспечивая идентичность поведения.
