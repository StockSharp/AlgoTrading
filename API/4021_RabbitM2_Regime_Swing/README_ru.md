# Стратегия Rabbit M2

## Описание
Rabbit M2 — это советник Питера Байрома для MetaTrader 4, перенесённый на StockSharp. Алгоритм чередует «бычий» и «медвежий»
режимы, которые определяются пересечением экспоненциальных средних на часовом таймфрейме. В активном режиме стратегия ждёт
колебаний Williams %R и проверяет их показания с помощью индикатора CCI, после чего открывает рыночные сделки. Защитный блок
повторяет оригинальный код: фиксированные стоп-лосс и тейк-профит выставляются на заданном расстоянии, а позиции принудительно
закрываются, если цена пробивает противоположную границу канала Дончиана. Денежное управление увеличивает базовый объём после
каждой крупной прибыли и удваивает порог для следующего повышения.

## Рыночные данные и индикаторы
- **Основной таймфрейм** (по умолчанию минутные свечи) используется для расчёта Williams %R, CCI и канала Дончиана.
- **Часовой таймфрейм** служит для вычисления быстрой (40) и медленной (80) EMA, которые задают торговое направление.
- **Williams %R (50)** отслеживает выход из зон -20/-80 и даёт импульсный сигнал.
- **CCI (14)** подтверждает, что цена перекуплена или перепродана.
- **Канал Дончиана (100)** формирует уровни для принудительного выхода по пробитию предыдущего диапазона.
- **Фиксированные стоп и профит** пересчитываются из пунктов (по умолчанию 50) в абсолютную цену с учётом шага котировки и
форекс-инструментов с 3 или 5 знаками после запятой.

## Логика торговли
### Управление режимами
1. Если EMA(40) на часовиках опускается ниже EMA(80), все длинные позиции закрываются, и разрешается только работа в шорт.
2. Если EMA(40) поднимается выше EMA(80), закрываются короткие позиции, и стратегия ищет только покупки.

### Условия входа
- **Продажа** возможна, когда:
  - Williams %R переходит из диапазона -20..0 в зону перепроданности (< -20).
  - Значение CCI превышает уровень `CciSellLevel` (по умолчанию 101).
  - Текущий шорт не превысил лимит `MaxTrades` (каждый сигнал добавляет один базовый объём).
- **Покупка** выполняется, когда:
  - Williams %R выходит из зоны -100..-80 и поднимается выше -80.
  - CCI опускается ниже `CciBuyLevel` (по умолчанию 99).
  - Накопленная длинная позиция меньше ограничения `MaxTrades`.

Новые заявки увеличивают нетто-позицию. На платформе StockSharp позиции неттируются, поэтому повторные сигналы лишь наращивают
объём до установленного предела.

### Условия выхода
1. Стоп и профит контролируются на каждой завершённой свече. При пробое уровня позиция закрывается рыночной заявкой.
2. Независимо от стопов: лонг закрывается, если цена закрытия опускается ниже предыдущей нижней границы канала Дончиана; шорт —
если закрытие выше верхней границы.
3. Смена режима по EMA немедленно ликвидирует позиции, идущие против нового тренда.

### Управление объёмом
- Базовый объём стартует со значения `InitialVolume` (по умолчанию 0.01) и приводится к шагу и ограничениям инструмента.
- После каждой реализованной прибыли больше `BigWinTarget` (15 денежных единиц) объём увеличивается на `VolumeIncrement`
(0.01), а порог «крупного выигрыша» удваивается, повторяя поведение оригинального советника.
- При выходе в ноль вспомогательные значения стопа и профита сбрасываются, чтобы избежать устаревших уровней.

## Параметры
| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CciSellLevel` | 101 | Минимальный CCI для подтверждения продажи. |
| `CciBuyLevel` | 99 | Максимальный CCI для подтверждения покупки. |
| `CciPeriod` | 14 | Период индикатора CCI. |
| `DonchianPeriod` | 100 | Длина канала Дончиана для выходов. |
| `MaxTrades` | 1 | Максимальное количество базовых объёмов в нетто-позиции. |
| `BigWinTarget` | 15 | Прибыль, после которой увеличивается базовый объём. |
| `VolumeIncrement` | 0.01 | Прирост объёма после «крупного выигрыша». |
| `WprPeriod` | 50 | Период Williams %R. |
| `FastEmaPeriod` | 40 | Период быстрой EMA на часовом таймфрейме. |
| `SlowEmaPeriod` | 80 | Период медленной EMA на часовом таймфрейме. |
| `TakeProfitPoints` | 50 | Дистанция тейк-профита в пунктах. |
| `StopLossPoints` | 50 | Дистанция стоп-лосса в пунктах. |
| `InitialVolume` | 0.01 | Стартовый базовый объём. |
| `CandleType` | Минутные свечи | Основной таймфрейм для расчётов. |

## Особенности реализации
- Стоп-лосс и тейк-профит контролируются внутри стратегии, что повторяет работу `OrderSend` с параметрами SL/TP в MetaTrader.
- Изменение объёма зависит от данных о реализованной прибыли. Необходимо получать подтверждения сделок от брокерского адаптера
StockSharp.
- Метод `CalculatePriceOffset` корректирует шаг цены для инструментов с 3 и 5 знаками после запятой, чтобы соответствовать
константе `Point` в MetaTrader.
