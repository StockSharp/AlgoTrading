# Rabbit M2 策略

## 概述
Rabbit M2 是 Peter Byrom 为 MetaTrader 4 编写的专家顾问，现已移植到 StockSharp。策略通过比较小时级
40/80 周期指数移动平均线来判断市场处于多头还是空头状态。在允许交易的方向上，程序等待 Williams %R
摆脱关键区间并由 CCI 指标确认后，以市价单入场。保护模块完全复制原始 EA：为每笔交易设置固定距离的
止损/止盈，并在价格突破相反方向的 Donchian 通道时强制平仓。资金管理逻辑会在获得超额利润后增加基础
手数，并将下一次加仓所需的利润目标加倍。

## 数据源与指标
- **主周期**（默认 1 分钟 K 线）用于计算 Williams %R、CCI 以及 Donchian 通道。
- **小时周期**提供 40 与 80 周期 EMA，用于切换交易方向并关闭反向头寸。
- **Williams %R (50)** 监控 -20/-80 阈值附近的动量突破。
- **CCI (14)** 确认市场处于超买或超卖状态。
- **Donchian 通道 (100)** 在突破前高/前低时触发保护性平仓。
- **固定止损和止盈** 根据点数（默认 50）以及品种最小报价单位换算为价格距离，并针对三位或五位小数
的外汇品种进行调整。

## 交易规则
### 趋势控制
1. 当小时级 EMA(40) 下穿 EMA(80) 时，立即平掉所有多单，只允许做空信号。
2. 当 EMA(40) 上穿 EMA(80) 时，所有空单被平仓，只允许做多信号。

### 入场条件
- **做空** 需满足：
  - Williams %R 从 -20..0 区域跌入超卖区（<-20）。
  - CCI 高于 `CciSellLevel`（默认 101）。
  - 当前净空头仓位未超过 `MaxTrades` 限制（每次加仓增加一个基础手数）。
- **做多** 需满足：
  - Williams %R 从 -100..-80 区域上升并突破 -80。
  - CCI 低于 `CciBuyLevel`（默认 99）。
  - 当前净多头仓位低于 `MaxTrades` 限制。

StockSharp 账户使用净持仓模式，因此重复信号会在允许范围内逐步增加净仓量，而不会开启独立订单。

### 出场条件
1. 每根完成的 K 线都会检查止损和止盈，一旦价格触及目标即平仓。
2. 若多单收盘价跌破上一根 Donchian 下轨，或空单收盘价突破上一根上轨，也会强制离场。
3. 小时级 EMA 发生反向交叉时，所有反向仓位立即平掉。

### 资金管理
- 基础手数由 `InitialVolume`（默认 0.01）初始化，并自动匹配交易品种的交易步长、最小与最大手数限制。
- 每当实现利润超过 `BigWinTarget`（默认 15 账户货币单位）时，基础手数增加 `VolumeIncrement`（默认 0.01），
同时把利润阈值翻倍，模拟原始 EA 的递进加仓机制。
- 当仓位归零时，会清除内部记录的止损/止盈价格，避免残留数据影响后续交易。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `CciSellLevel` | 101 | 触发做空所需的最小 CCI 值。 |
| `CciBuyLevel` | 99 | 触发做多所需的最大 CCI 值。 |
| `CciPeriod` | 14 | CCI 指标的计算周期。 |
| `DonchianPeriod` | 100 | Donchian 通道的回溯长度。 |
| `MaxTrades` | 1 | 允许的净持仓倍数上限。 |
| `BigWinTarget` | 15 | 触发加仓的实现利润阈值。 |
| `VolumeIncrement` | 0.01 | 达到目标后增加的基础手数。 |
| `WprPeriod` | 50 | Williams %R 的计算周期。 |
| `FastEmaPeriod` | 40 | 小时级快速 EMA 的周期。 |
| `SlowEmaPeriod` | 80 | 小时级慢速 EMA 的周期。 |
| `TakeProfitPoints` | 50 | 止盈距离（点）。 |
| `StopLossPoints` | 50 | 止损距离（点）。 |
| `InitialVolume` | 0.01 | 初始基础手数。 |
| `CandleType` | 1 分钟 K 线 | 主要数据周期。 |

## 实现说明
- 止损和止盈在策略内部根据价格监控执行，而不是发送独立的保护单，以贴近原始 EA 的 `OrderSend` 行为。
- 基础手数的调整依赖 StockSharp 返回的已实现盈亏信息，请确保适配器能够推送成交结果。
- `CalculatePriceOffset` 方法会根据品种的小数位数调整点值，模拟 MetaTrader 中的 `Point` 常量。
