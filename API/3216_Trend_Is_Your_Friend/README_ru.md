# Стратегия "Trend Is Your Friend"

## Обзор
Trend Is Your Friend — мультифреймовая трендовая стратегия, основанная на оригинальном советнике MetaTrader. Она согласует внутридневной импульс с фильтром MACD на старшем таймфрейме, а управление рисками реализовано через выход по полосам Боллинджера, классические уровни стоп-лосса и тейк-профита, а также опциональные перенос стопа в безубыток и трейлинг.

Стратегия работает на настраиваемом базовом таймфрейме (по умолчанию 1 час) и анализирует структуру свечей для поиска краткосрочного импульсного паттерна: медвежья свеча, за которой следует более крупная бычья свеча для входа в лонг, либо обратная комбинация для шорта. Перед открытием позиции паттерн должен совпасть с трендовым фильтром на основе скользящих средних и с месячным сигналом MACD.

## Логика входа
1. На выбранном таймфрейме рассчитываются быстрая EMA и медленная LWMA.
2. Отслеживаются две последние завершённые свечи:
   - **Лонг:** свеча два бара назад медвежья, предыдущая свеча бычья и больше по амплитуде.
   - **Шорт:** свеча два бара назад бычья, предыдущая свеча медвежья и меньше по амплитуде.
3. Паттерн подтверждается трендовым фильтром (быстрая средняя выше медленной для лонга, ниже — для шорта).
4. Дополнительный фильтр — MACD на старшем таймфрейме (по умолчанию месяц). Для покупок линия MACD должна быть выше сигнальной, для продаж — ниже.
5. При выполнении всех условий открывается позиция по рынку заданным объёмом.

## Логика выхода
- **Полосы Боллинджера:** длинные позиции закрываются, когда цена закрытия выходит выше верхней полосы; короткие — когда закрытие ниже нижней полосы.
- **Тейк-профит и стоп-лосс:** необязательные фиксированные дистанции в пунктах. Перевод пунктов в цену выполняется через шаг цены инструмента.
- **Перенос в безубыток:** опция, перемещающая защитный стоп к цене входа после достижения заданной прибыли.
- **Трейлинг-стоп:** опция, активирующаяся после достижения порога прибыли и сопровождающая цену на фиксированном расстоянии. Трейлинг использует ту же переменную, что и уровень безубытка.

## Параметры
| Название | Описание | Значение по умолчанию |
| -------- | -------- | --------------------- |
| Entry Candle | Таймфрейм для расчёта условий входа | 1 час |
| MACD Candle | Старший таймфрейм для MACD | 30 дней |
| Fast MA | Период быстрой EMA | 8 |
| Slow MA | Период медленной LWMA | 20 |
| Bollinger Length | Период полос Боллинджера | 20 |
| Bollinger Width | Множитель стандартного отклонения | 2.0 |
| Stop Loss (pips) | Стоп-лосс в пунктах | 20 |
| Take Profit (pips) | Тейк-профит в пунктах | 50 |
| Use Break-Even | Включить перенос в безубыток | true |
| Break-Even Trigger | Прибыль в пунктах для переноса | 10 |
| Break-Even Offset | Смещение стопа при переносе | 5 |
| Use Trailing | Включить трейлинг-стоп | true |
| Trailing Activation | Прибыль в пунктах для активации трейлинга | 40 |
| Trailing Distance | Расстояние трейлинга в пунктах | 40 |

## Примечания
- Стратегия хранит только две последние завершённые свечи, что избавляет от тяжёлых буферов истории.
- Данные MACD запрашиваются с выбранного старшего таймфрейма с включённой агрегацией, поэтому месячный сигнал может быть построен даже из дневных свечей.
- Конвертация пунктов в цену основывается на шаге цены инструмента, поэтому для инструментов с нестандартным определением пункта параметры следует откалибровать.
