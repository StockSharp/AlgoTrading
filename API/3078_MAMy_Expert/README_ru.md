# Стратегия MAMy Expert

## Обзор
- Порт советника MetaTrader 5 «MAMy Expert» Виктора Чеботарёва на высокоуровневый API StockSharp.
- Полностью воспроизводит оригинальный индикатор, сравнивающий три скользящие средние по разным типам цен (open, close, weighted).
- Работает только по завершённым свечам и удерживает не более одной совокупной позиции, полностью повторяя логику исходного эксперта.

## База индикаторов
- Стратегия строит три скользящие средние с одинаковой длиной и методом сглаживания:
  - `MA(close)` — рассчитывается по ценам закрытия свечей.
  - `MA(open)` — рассчитывается по ценам открытия свечей.
  - `MA(weighted)` — рассчитывается по взвешенной цене `(High + Low + 2 × Close) / 4`.
- Параметр `MaType` выбирает алгоритм усреднения (Simple, Exponential, Smoothed, Weighted LWMA), что соответствует значениям `MODE_*` в MetaTrader.
- «Буфер закрытия» равен разности `MA(close) − MA(weighted)`.
- «Буфер открытия» появляется только при сформированном трендовом расположении средних:
  - **Нисходящее условие**: `MA(close)` и `MA(weighted)` падают, закрытие ниже взвешенной средней, обе ниже средней по open, а буфер закрытия уменьшается.
  - **Восходящее условие**: `MA(close)` и `MA(weighted)` растут, закрытие выше взвешенной средней, обе выше средней по open, а буфер закрытия увеличивается.
  - При выполнении одного из условий буфер открытия вычисляется как `(MA(weighted) − MA(open)) + (MA(close) − MA(weighted))`, иначе он сбрасывается в ноль.
- Если новая положительная величина буфера открытия совпадает с переходом буфера закрытия в отрицательную область, буфер закрытия принудительно обнуляется — так же, как в исходном коде индикатора.

## Логика сигналов
- **Входы**
  - **Покупка** — когда буфер открытия пересекает уровень 0 снизу вверх (предыдущее значение ≤ 0, текущее > 0).
  - **Продажа** — когда буфер открытия пересекает 0 сверху вниз (предыдущее ≥ 0, текущее < 0).
  - Сигналы входа рассматриваются только при отсутствии открытых позиций.
- **Выходы**
  - **Закрыть лонг** — буфер закрытия пересекает 0 сверху вниз (предыдущее ≥ 0, текущее < 0).
  - **Закрыть шорт** — буфер закрытия пересекает 0 снизу вверх (предыдущее ≤ 0, текущее > 0).
  - Закрытия обрабатываются раньше входов, поэтому стратегия никогда не держит разнонаправленные позиции одновременно.
- Заявки выставляются по рынку с объёмом `TradeVolume`. Вызов `StartProtection()` обеспечивает защитные механизмы, аналогичные примерам StockSharp.

## График и поток данных
- Подписывается на таймфрейм, заданный `CandleType`, и анализирует только свечи в состоянии `Finished`.
- На графике отображаются свечи цены, все три скользящие средние и сделки, что обеспечивает визуальное сходство с оригинальным индикатором MetaTrader.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | `TimeSpan.FromHours(1).TimeFrame()` | Основной таймфрейм для расчёта индикаторов и сигналов. |
| `MaPeriod` | `int` | `3` | Длина всех трёх скользящих средних. |
| `MaType` | `MaCalculationType` | `Weighted` | Метод усреднения (Simple, Exponential, Smoothed, Weighted). |
| `TradeVolume` | `decimal` | `1` | Объём каждой рыночной заявки. |

## Особенности реализации
- Используется высокоуровневый конвейер `SubscribeCandles().Bind(...)` и встроенные индикаторы StockSharp; хранится только минимум последних значений, необходимых для сигналов.
- Сигналы анализируются лишь после формирования всех индикаторов и проверки готовности к торговле (`IsFormedAndOnlineAndAllowTrading()`).
- Во время открытой позиции новые входы игнорируются, что соответствует поведению оригинального советника.
