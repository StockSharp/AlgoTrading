# Стратегия Hist Training

## Обзор
Стратегия Hist Training переносит функциональность вспомогательного советника MetaTrader "HistoryTrain" в высокоуровневый API StockSharp. Исходный скрипт реагировал на вручную нанесённые горизонтальные линии и значения, передаваемые через внешнюю DLL, формируя сценарии пробоя, отката и мгновенных рыночных сделок. В портированной версии все эти переключатели заменены параметрами стратегии, поэтому поведение можно воспроизвести без объектов на графике и без обмена данными через DLL. Стратегия отслеживает три ценовых уровня и автоматически управляет стоповыми, лимитными или рыночными ордерами согласно выбранной конфигурации.

Подписка на свечи (по умолчанию таймфрейм 1 минута) используется для оценки взаимного расположения последней цены закрытия и заданных уровней. Как только выполняются условия, стратегия создаёт соответствующий отложенный ордер либо исполняет рыночную заявку, тем самым воспроизводя логику исходного эксперта, но с использованием удобных обёрток StockSharp.

## Назначение уровней
* **Верхний уровень** – выступает тейк-профитом для длинных позиций и стоп-лоссом для коротких. При включённых стоповых ордерах дополнительно определяет цену активации шорта.
* **Уровень входа** – центральная точка, вокруг которой строятся стоповые/лимитные заявки и рыночные триггеры. В MQL-версии ему соответствовала центральная горизонтальная линия цвета лайм.
* **Нижний уровень** – выполняет обратную роль по отношению к верхнему: используется как стоп-лосс для лонга, тейк-профит для шорта и (при активном сценарии пробоя) служит ценой активации покупки.

## Логика работы с ордерами
* **Режим пробоя** (`UseBreakoutOrders`) – если цена находится ниже уровня входа и разрешена работа в лонг, активируется buy stop на уровне входа. Если цена выше уровня входа и разрешена работа в шорт, активируется sell stop. Объём нормализуется по шагу инструмента, и система гарантирует наличие не более одного активного ордера в каждом направлении.
* **Режим отката** (`UsePullbackOrders`) – когда цена выше уровня входа, стратегия выставляет buy limit, рассчитывая на возврат. Когда цена ниже уровня входа, формируется sell limit. Оба режима могут работать одновременно, что повторяет сочетания флагов `25` и `26` в оригинальном коде.
* **Рыночные триггеры** (`EnableMarketBuy`, `EnableMarketSell`) – при активных переключателях стратегия отслеживает закрытие свечи выше (для покупок) или ниже (для продаж) уровня входа, пока позиция равна нулю. Срабатывание условия приводит к рыночной сделке, отмене всех отложенных ордеров и сохранению защитных уровней по верхней/нижней границе.

Отложенные заявки пересоздаются при любом расхождении их цены с заданным уровнем входа или после отмены/исполнения. Дополнительно очищаются устаревшие ссылки на ордера, что моделирует удаление цветных линий в MetaTrader.

## Управление позицией
При появлении открытой позиции стратегия деактивирует все отложенные ордера и контролирует экстремумы свечи:

* Для **лонга** нижний уровень считается стоп-лоссом, верхний – тейк-профитом. Достижение любого уровня приводит к немедленному закрытию рынка.
* Для **шорта** верхний уровень выступает стоп-лоссом, нижний – тейк-профитом. Используется тот же механизм рыночного выхода, что и в MQL-версии при заполнении параметров `OrderSend`.

Защитные значения пересчитываются при смене направления и сбрасываются, когда позиция снова становится нулевой. Это повторяет поведение исходного инструмента MT4, очищавшего горизонтали после срабатывания.

## Параметры
| Имя | Описание |
| --- | --- |
| `UpperLevel` | Тейк-профит для лонга и стоп-лосс для шорта. |
| `EntryLevel` | Центральный уровень, вокруг которого строятся все ордера и триггеры. |
| `LowerLevel` | Стоп-лосс для лонга и тейк-профит для шорта. |
| `EnableLongSide` | Разрешение на выставление сделок в лонг. При выключении стратегия работает только в сторону продаж. |
| `EnableShortSide` | Разрешение на выставление сделок в шорт. При выключении стратегия работает только в сторону покупок. |
| `UseBreakoutOrders` | Активирует сценарий стоповых ордеров (аналог `OP_BUYSTOP` / `OP_SELLSTOP` из MQL). |
| `UsePullbackOrders` | Активирует сценарий лимитных ордеров (аналог `OP_BUYLIMIT` / `OP_SELLLIMIT`). |
| `EnableMarketBuy` | Разрешает автоматическую рыночную покупку при закрытии выше уровня входа, если позиции нет. |
| `EnableMarketSell` | Разрешает автоматическую рыночную продажу при закрытии ниже уровня входа, если позиции нет. |
| `OrderVolume` | Базовый объём сделок. Стратегия нормализует его по шагу объёма инструмента. |
| `CandleType` | Тип данных для наблюдения за инструментом (по умолчанию минутные свечи). |

## Примечания по конверсии
* Параметры, ранее передававшиеся через DLL (`GetInt@4`, `SetInt@8` и т.д.), заменены на типизированные свойства стратегии. Каждому флагу исходного кода соответствует отдельная настройка в StockSharp.
* Не требуется считывать горизонтальные линии с графика: три ключевых уровня задаются непосредственно параметрами, что сохраняет логику выбора линий цвета лайм без зависимостей от интерфейса MetaTrader.
* Выставление ордеров основано на высокоуровневых методах (`BuyStop`, `SellLimit` и т.п.), обеспечивающих корректное округление цены и интеграцию с биржевым стаканом.
* Стоп-лосс и тейк-профит реализованы через анализ свечных максимумов/минимумов, поэтому защита работает даже на площадках без нативной поддержки SL/TP.
* Подробное логирование заменяет сообщения `Print`, что упрощает анализ хода стратегии через журнал StockSharp.
