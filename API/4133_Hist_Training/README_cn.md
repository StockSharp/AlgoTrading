# Hist Training 策略

## 概述
Hist Training 策略是在 StockSharp 高级 API 中复刻 MetaTrader 助手 "HistoryTrain" 的实现。原始的 MQL 脚本依靠用户手动绘制的水平线以及外部 DLL 传递的标志来布置突破、回撤以及即时的市价单。本移植版本通过参数化方式取代了这些外部依赖，从而无需图表对象或共享内存即可还原同样的行为。策略跟踪三个关键价位，并根据设置自动管理止损单、限价单以及市价入场。

默认情况下，策略订阅一分钟 K 线。每根收盘 K 线都会与配置的价位比较，一旦满足触发条件就会创建对应的挂单或直接下市价单。这种处理流程忠实地反映了原始专家顾问的触发结构，同时充分利用了 StockSharp 提供的下单工具。

## 价位映射
* **上轨价位** – 对多头仓位来说是获利目标，对空头仓位则是止损价。当开启突破模式时，该价位同时也是空头入场的触发点。
* **入场价位** – 所有止损单、限价单以及市价触发均围绕该价位展开。在 MQL 脚本中它对应的是中间的绿色水平线。
* **下轨价位** – 与上轨相反：它是多头的止损、空头的获利目标，并且在突破模式下成为多头入场的激活价。

## 下单逻辑
* **突破模式**（`UseBreakoutOrders`） – 当价格低于入场价且允许做多时，会在入场价上方挂出买入止损单；当价格高于入场价且允许做空时，会挂出卖出止损单。策略会按照交易品种的最小步长规范化下单价格与数量，同时保证每个方向只有一个有效挂单。
* **回撤模式**（`UsePullbackOrders`） – 当价格高于入场价时，策略会提前在入场价挂出买入限价单，等待回落；当价格低于入场价时，会挂出卖出限价单。两个模式可以同时启用，对应于原始脚本中 `25` 与 `26` 标志的组合。
* **市价触发**（`EnableMarketBuy`、`EnableMarketSell`） – 当开启时，策略会在空仓状态下监控 K 线收盘价，一旦收盘价突破入场位（向上代表买入、向下代表卖出）就立即以市价入场，同时取消所有挂单并记录上下轨作为保护位。

挂单会在价格发生偏离、被取消或被成交后重新创建。策略还会清理已经完成的订单引用，以模拟 MetaTrader 中删除绿色水平线后清空挂单的效果。

## 仓位管理
在持仓期间，策略会停止所有挂单并监控当根 K 线的最高价和最低价：

* **多头仓位** – 下轨价位被视为止损，上轨价位是获利目标。触及任一价位都会立即以市价平仓。
* **空头仓位** – 上轨价位作为止损，下轨价位作为获利目标。该处理方式等价于 MQL 代码在 `OrderSend` 中设置的止损和止盈。

当仓位方向改变时，保护价位会重新计算；当仓位归零时，保护价位被重置。这一流程与 MT4 工具在成交后删除水平线的行为相一致。

## 参数
| 名称 | 说明 |
| --- | --- |
| `UpperLevel` | 多头的获利目标与空头的止损价。 |
| `EntryLevel` | 用于锚定所有订单与触发条件的核心价位。 |
| `LowerLevel` | 多头的止损价与空头的获利目标。 |
| `EnableLongSide` | 允许策略提交多头订单，关闭后仅交易空头。 |
| `EnableShortSide` | 允许策略提交空头订单，关闭后仅交易多头。 |
| `UseBreakoutOrders` | 启用突破挂单流程，对应 MQL 中的 `OP_BUYSTOP`/`OP_SELLSTOP`。 |
| `UsePullbackOrders` | 启用回撤挂单流程，对应 MQL 中的 `OP_BUYLIMIT`/`OP_SELLLIMIT`。 |
| `EnableMarketBuy` | 在收盘价上破入场位且空仓时自动执行市价买入。 |
| `EnableMarketSell` | 在收盘价跌破入场位且空仓时自动执行市价卖出。 |
| `OrderVolume` | 每笔新订单的基础数量，策略会按交易品种的数量步长进行规范化。 |
| `CandleType` | 用于驱动逻辑的数据类型，默认是一分钟 K 线。 |

## 转换说明
* 原脚本依赖的 DLL 共享变量（`GetInt@4`、`SetInt@8` 等）已经替换为强类型的策略参数，可在 StockSharp 中直接配置和优化。
* 不再需要读取图表上的水平线，三个关键价位直接通过参数输入，从而保留了选择绿色水平线的思路，同时摆脱对 MetaTrader 图形界面的依赖。
* 所有下单动作均使用高级 API 提供的封装方法（如 `BuyStop`、`SellLimit`），确保价格四舍五入规则与交易所要求一致。
* 止损与止盈通过监控 K 线的高低价来执行，即使交易场所不支持附带 SL/TP 的挂单也能提供保护效果。
* 丰富的日志记录继承了原脚本的 `Print` 信息，使策略在 StockSharp 日志查看器中的运行轨迹更加清晰。
