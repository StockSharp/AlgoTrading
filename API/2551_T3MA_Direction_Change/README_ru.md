# Стратегия T3 MA Direction Change

## Общее описание
Данная стратегия повторяет логику советника **T3MA(barabashkakvn's edition)**. Исходный советник использует индикатор «T3MA-ALARM», который дважды экспоненциально сглаживает цены закрытия и формирует сигнал при смене направления сглаженной кривой. Порт на StockSharp реализует тот же подход: рассчитывает EMA от цены закрытия, затем вторую EMA от полученного ряда и реагирует на изменение наклона этого двойного сглаживания.

Стратегия работает только на завершённых свечах. Чтобы воспроизвести параметр `InpBarNumber`, введена задержка исполнения сигналов на заданное число свечей (по умолчанию одна свеча). Сделки отправляются рыночными приказами, поэтому позиция всегда одна – при смене направления происходит разворот, а не накопление нескольких хеджирующих ордеров.

## Торговые правила
1. Подписаться на выбранный тип свечей и рассчитать EMA по ценам закрытия. Затем применить вторую EMA к выходным значениям первой EMA, получив ряд для анализа направления.
2. Сравнить текущее значение сглаженного ряда (при необходимости сдвинутое на `EMA Shift`) с предыдущим. Рост интерпретируется как восходящий наклон, падение – как нисходящий.
3. Когда наклон меняется с нисходящего на восходящий – поместить в очередь **покупку**. При обратном переходе – **продажу**. Если наклон не изменился, в очередь добавляется нулевой сигнал, чтобы задержка учитывала каждую свечу.
4. После истечения заданной задержки `Signal Delay` сигнал извлекается из очереди и исполняется. Покупка закрывает текущий шорт (если есть) и открывает лонг базовым объёмом `Trade Volume`. Продажа аналогично закрывает лонг и открывает шорт.
5. Защитные ордера на стоп-лосс и тейк-профит создаются через `StartProtection`. Расстояния задаются в шагах цены, поэтому автоматически учитывают минимальный тик выбранного инструмента.

## Параметры
| Название | Описание |
| --- | --- |
| `EMA Length` | Длина EMA для обоих этапов сглаживания, аналог параметра `MAPeriod` в исходном индикаторе. |
| `EMA Shift` | Сдвиг сглаженного ряда перед сравнением наклонов, соответствует `MAShift`. |
| `Signal Delay` | Количество завершённых свечей, через которое исполняется сигнал. Значение 1 повторяет обработку предыдущей свечи как в `InpBarNumber`. |
| `Stop Loss (steps)` | Дистанция стоп-лосса в шагах цены. Ноль отключает защиту. |
| `Take Profit (steps)` | Дистанция тейк-профита в шагах цены. Ноль отключает защиту. |
| `Trade Volume` | Базовый объём сделки. При развороте к нему добавляется абсолютное значение текущей позиции. |
| `Candle Type` | Тип свечей, используемый в расчётах (по умолчанию 5-минутные). |

## Управление рисками
* `StartProtection` автоматически выставляет уровни стоп-лосса и тейк-профита при запуске и поддерживает их в актуальном состоянии относительно шага цены.
* Переходы выполняются рыночными приказами. Если сигнал совпадает с текущим направлением, дополнительных сделок не совершается, что предотвращает непреднамеренное наращивание позиции.
* Каждая сделка сопровождается записью в журнал с указанием причины и опорной цены из свечи-источника.

## Отличия от версии для MQL5
* Оригинальный советник требовал хеджинговый счёт и мог накапливать несколько позиций. В StockSharp используется неттинговый подход – всегда одна позиция, которая разворачивается по сигналу.
* Обработка сигналов выполняется по завершённым свечам, а не по каждому тику, что естественно для высокоуровневого API StockSharp.
* Управление стопами и тейками реализовано через `StartProtection`, а не через индивидуальные SL/TP в каждом ордере.
* Код снабжён комментариями на английском языке, параметрами с описаниями и вспомогательной визуализацией.

## Рекомендации по применению
1. Запускайте стратегию на инструменте с корректно настроенным `PriceStep`, чтобы защитные уровни выставлялись на адекватных расстояниях.
2. Подберите `EMA Length` и значения защитных параметров под волатильность конкретного рынка. Увеличение `Signal Delay` уменьшает шум, но замедляет реакцию.
3. Контролируйте журналы сделок: по ним легко отследить, какая свеча сформировала сигнал и какое направление было принято.
