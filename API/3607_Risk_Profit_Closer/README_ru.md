# Стратегия Risk Profit Closer

## Обзор
**Risk Profit Closer** непрерывно отслеживает текущий торгуемый инструмент и немедленно закрывает позицию, как только плавающая прибыль или убыток достигают заданного процента от стоимости портфеля. В оригинальном скрипте MetaTrader проверка выполнялась на каждом тике: вычислялась разница между ценой входа и последними котировками Bid/Ask, после чего позиции с избыточной прибылью или убытком закрывались. Порт StockSharp сохраняет тот же алгоритм, подписываясь на Level1 и выполняя идентичные процентные пороги.

В отличие от классических торговых стратегий, модуль не инициирует новые сделки. Его задача – дополнять другие роботы или ручные позиции в роли защитного механизма, который фиксирует результат при достижении лимитов по прибыли или риску.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `RiskPercentage` | Максимально допустимая доля убытка от капитала для одной позиции. | `1` |
| `ProfitPercentage` | Доля прибыли от капитала, при достижении которой позиция закрывается. | `2` |
| `TimerInterval` | Интервал повторной проверки, когда новые котировки не поступают. | `00:00:01` |

## Логика работы
1. При старте стратегия убеждается, что заданы `Security` и `Portfolio`, оформляет подписку `SubscribeLevel1()` на поток Bid/Ask и запускает периодический таймер с шагом `TimerInterval`.
2. Любое обновление Level1 или срабатывание таймера вызывает функцию оценки риска. Она получает стоимость портфеля (`Portfolio.CurrentValue`, при необходимости `Portfolio.BeginValue`) и переводит процентные пороги в абсолютные денежные величины.
3. Для позиции по текущему инструменту рассчитывается плавающая прибыль: сравнивается средняя цена входа с актуальным `BestBidPrice` (для лонга) или `BestAskPrice` (для шорта). При наличии `PriceStep` и `StepPrice` разница переводится в денежное выражение, иначе используется произведение ценового отклонения на объём.
4. Если плавающая прибыль ≥ `ProfitPercentage × капитал` либо плавающий убыток ≥ `RiskPercentage × капитал`, позиция немедленно закрывается через `ClosePosition`.

## Особенности портирования
- Функция `CheckTrades()` в MetaTrader перебирала все позиции и сравнивала названия инструментов. В StockSharp применяется фильтрация `Portfolio.Positions` по объекту `Security`, что полностью повторяет исходное поведение.
- В MetaTrader для лонга использовалась цена `symbolInfo.Ask()`, для шорта – `symbolInfo.Bid()`. Перенос сохранил этот подход: приоритет отдан последним `BestAskPrice`/`BestBidPrice`, а при их отсутствии берутся последняя сделка или последняя цена.
- В оригинале прибыль оценивалась через умножение ценового отклонения на `SymbolInfo.Point()`. В StockSharp данные о шаге цены (`PriceStep`) и стоимости шага (`StepPrice`) позволяют точно перевести отклонение в деньги; при нехватке данных используется базовая формула «цена × объём».
- Таймер имитирует цикл `OnTick`, благодаря чему защита сработает даже при редких обновлениях рынка.

## Рекомендации по использованию
- Перед запуском укажите `Security` и `Portfolio`. Без оценки портфеля (`Portfolio.CurrentValue` или `Portfolio.BeginValue`) стратегия не сможет вычислить пороги.
- Предполагается неттированная позиция по инструменту (один общий лонг или шорт). При наличии нескольких хеджевых позиций команда `ClosePosition` закроет суммарную позицию, как и оригинальный скрипт.
- Модуль можно запускать совместно с другими стратегиями: он не выставляет новых заявок, пока значения плавающей прибыли или убытка находятся в пределах допустимых лимитов.
