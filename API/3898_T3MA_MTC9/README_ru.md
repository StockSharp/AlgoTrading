# Стратегия T3MA(MTC)

Конвертация из советника MetaTrader 4 **T3MA(MTC).mq4** (каталог `MQL/7904`). Исходный робот торгует по сигналам индикатора «T3MA-ALARM»: строится двойное экспоненциальное сглаживание и открывается сделка, как только наклон кривой меняет направление. Версия на StockSharp реализует тот же алгоритм с использованием высокоуровневого API.

## Торговая идея

1. Рассчитываем первую EMA по выбранному типу свечей и периоду.
2. Полученный ряд сглаживаем второй EMA с тем же периодом.
3. Сравниваем текущее значение сглаженного ряда с предыдущим (с учётом `MaShift`, если он больше нуля).
4. При смене знака наклона формируется сигнал. Исполнение переносится на `CalculationBarOffset` завершённых свечей вперёд, что повторяет параметр `CalculationBarIndex` в MQL4-версии.
5. Для каждого сигнала фиксируется цена экстремума свечи (Low для покупки, High для продажи) и используется как уникальный маркер, чтобы не дублировать сделки — аналог переменной `LastOrder`.

## Особенности порта

- Две EMA (`ExponentialMovingAverage`) выстраивают ту же цепочку сглаживания, что и индикатор T3MA-ALARM.
- Очередь последних сглаженных значений позволяет корректно применять `MaShift` при сравнении наклона.
- Сигналы складываются в FIFO-очередь и исполняются только после заданной задержки по свечам.
- Защитные приказы подключаются через `StartProtection`, а расстояния задаются в шагах цены, что соответствует «пунктам» MetaTrader.
- Флаг `AllowMultiplePositions` повторяет входной параметр `MultiPositions`: при отключении стратегия ждёт, пока позиция обнулится, прежде чем открыть новый ордер.

## Параметры

- `MaPeriod` – период EMA для обоих этапов сглаживания (по умолчанию 4).
- `MaShift` – сдвиг ряда при проверке изменения наклона (по умолчанию 0).
- `CalculationBarOffset` – задержка в завершённых свечах перед исполнением сигнала (по умолчанию 1).
- `TradeVolume` – базовый объём заявки в лотах (по умолчанию 1).
- `UseStopLoss` / `StopLossPoints` – включение и расстояние стоп-лосса в шагах цены (по умолчанию включено, 40 шагов).
- `UseTakeProfit` / `TakeProfitPoints` – включение и расстояние тейк-профита в шагах цены (по умолчанию включено, 11 шагов).
- `AllowMultiplePositions` – разрешить накапливать позиции, даже если открыта противоположная (по умолчанию включено).
- `CandleType` – тип свечей или таймфрейм, который подаётся на вход индикаторам (по умолчанию 5-минутные свечи).

## Последовательность работы

1. Подписка на свечи и прогон закрытий через цепочку двойной EMA.
2. Отслеживание текущего направления наклона и генерация сигнала при его смене.
3. Помещение сигнала (или его отсутствия) в очередь задержки, чтобы исполнение произошло строго через `CalculationBarOffset` завершённых свечей, как и в MQL4, где считываются более старые буферы индикатора.
4. При наступлении времени исполнения:
   - Пропуск, если торговля запрещена, платформа не готова или `AllowMultiplePositions` выключен при ненулевой позиции.
   - Проверка, что маркер цены отличается от предыдущего, чтобы избежать дублей.
   - Отправка рыночной заявки (`BuyMarket`/`SellMarket`) с заданным объёмом. При активных защитных настройках стоп и тейк подключаются автоматически.

## Дополнительно

- Сравнение цен выполняется с небольшой дельтой, чтобы исключить артефакты округления при проверке аналога `LastOrder`.
- При отключённом `AllowMultiplePositions` стратегия не переворачивает позицию, полностью повторяя поведение оригинала, где выход осуществлялся стопами/тейками.
- При наличии графического движка можно включить визуализацию свечей и собственных сделок.
