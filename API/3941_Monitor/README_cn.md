# 监控策略

## 概述

该策略复刻了原始 MetaTrader Monitor 智能交易系统的逻辑，通过 Windows 内存映射文件在多个终端之间共享买价和终端元数据。每个实例都会向共享内存写入自己的终端信息，同时读取其他终端发布的数据，并将整理后的结果打印到日志中，从而在无需网络通信的情况下构建轻量级状态面板。

## 核心流程

1. 订阅一级行情，接收所选品种的最佳买价更新。
2. 在可配置目录（默认 `Local`）下创建或打开名为 `Monitor_<symbol>` 的内存映射文件。
3. 将当前终端记录（时间戳、账户标识、缩放后的买价、终端类型、工作站名称）写入分配给该实例的槽位。
4. 读取所有槽位，使用可配置的延迟阈值过滤过期记录，并把状态表写入日志。
5. 按照刷新周期持续同步，策略停止时减少全局使用计数并关闭映射。

## 参数

| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| **Directory** | 创建或打开共享内存文件的目录。 | `Local` |
| **File Prefix** | 文件名前缀，与截断后的代码组合。 | `Monitor_` |
| **Refresh Interval** | 两次同步之间的间隔。 | `500 ms` |
| **Max Latency** | 记录允许的最大时间差，超出即视为无效。 | `5000 ms` |

## 设计细节

- 文件头与 MQL 版本保持一致：第一个整数保存已连接终端数量，第二个整数记录分配的最高槽位索引。每个槽位包含四个整数（时间戳、账户、缩放买价、终端类型）和一个短 UTF-8 终端名称。
- 价格使用 `0.000001` 的缩放系数，与原脚本的 `kprice` 常量一致。
- 通过当前环境 TickCount 与记录时间比较并结合延迟阈值来判定终端是否活跃。
- 所有写入操作都在互斥锁内执行，确保共享内存的并发安全。
- 日志输出格式与 MetaTrader 专家顾问保持一致，便于对比与迁移。

## 使用说明

1. 在需要参与监控的每个终端上部署该策略。
2. 确保所有实例共享同一目录，以访问同一内存映射文件。
3. 可以利用 StockSharp 的标准日志体系将输出重定向到文件或外部监控工具。
4. 策略不会提交任何交易指令，仅用于监控目的。
