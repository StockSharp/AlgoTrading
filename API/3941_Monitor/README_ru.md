# Стратегия Monitor

## Общее описание

Стратегия переносит логику исходного эксперта MetaTrader Monitor: несколько терминалов обмениваются ценами и служебной информацией через общий файл, отображаемый в память. Каждый экземпляр записывает в файл собственные данные и параллельно читает записи остальных участников, после чего формирует таблицу состояния в журнале StockSharp. Такой подход позволяет построить простой мониторинг без сетевого взаимодействия между терминалами.

## Последовательность работы

1. Подписаться на уровень 1, чтобы получать обновления лучшей цены покупки по выбранному инструменту.
2. Создать или открыть память `Monitor_<symbol>` в настраиваемой директории (по умолчанию `Local`).
3. Записать в выделенный слот текущее состояние терминала: отметку времени, идентификатор счёта, масштабированную цену, код платформы и имя рабочей станции.
4. Прочитать все слоты, отфильтровать устаревшие записи с учётом максимальной задержки и вывести агрегированную информацию в лог.
5. Повторять синхронизацию с заданным интервалом до остановки стратегии, затем уменьшить счётчик подключений и закрыть отображение.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| **Directory** | Каталог, в котором создаётся или открывается общий файл. | `Local` |
| **File Prefix** | Префикс имени файла перед укороченным кодом инструмента. | `Monitor_` |
| **Refresh Interval** | Пауза между циклами синхронизации. | `500 ms` |
| **Max Latency** | Максимально допустимая «устарелость» записи, мс. | `5000 ms` |

## Технические особенности

- Заголовок файла повторяет структуру MQL: первый целочисленный параметр хранит число подключённых терминалов, второй — последний занятый слот. Каждый слот содержит четыре целых (время, счёт, цена, тип платформы) и короткую строку с названием терминала в UTF-8.
- Цена масштабируется константой `0.000001`, что полностью совпадает с параметром `kprice` в MQL-версии.
- Активность терминала определяется сравнением текущего `Environment.TickCount` и времени записи с учётом порога задержки.
- Все операции чтения и записи синхронизированы через mutex, что исключает гонки между параллельными процессами.
- Формат строки в журнале соответствует оригинальному эксперту: `{latency} ({timestamp}) | {account} | {price} | {terminal} | MT {platform}`.

## Практические рекомендации

1. Запускайте стратегию на всех терминалах, которые должны обмениваться состоянием.
2. Убедитесь, что все экземпляры используют одну и ту же директорию для доступа к общему файлу.
3. Журнальные сообщения легко перенаправить в файл или внешнюю систему мониторинга средствами StockSharp.
4. Стратегия не размещает торговых заявок и используется исключительно для наблюдения.
