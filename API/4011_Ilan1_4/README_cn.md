# Ilan 1.4 网格策略

## 概述
Ilan 1.4 是典型的网格加仓系统。本策略订阅单一周期的 K 线序列，根据最近两根已完成 K 线的收盘价决定首单方向：如果最新收盘价低于更早的收盘价，则以卖单开启篮子，否则开多。价格按照配置的 **Pip Step** 逆向移动时，策略可选择性地在同一方向加仓，并重新计算加权平均建仓价。

所有交易均以市价成交。当价格回到平均建仓价并达到 **Take Profit** 距离时，整篮订单一起平仓。策略同时还实现了移动止损、固定止损、基于权益的紧急止损以及最长持仓时间限制，与原 MetaTrader 智能交易系统的保护模块保持一致。

## 交易规则
1. 等待新的 K 线收盘，读取最近两根收盘价。
2. 当没有持仓时，如果最新收盘价高于前一收盘价则开多，否则开空。
3. 维护最近一次成交价与篮子的加权平均建仓价。
4. 当启用 **Use Add** 且价格逆向运行超过 **Pip Step** 点时，计算下一手数并在同方向加仓；若启用 **Close Before Adding**，则先平掉当前篮子，再按照放大后的手数重新开仓。
5. 每次成交后重新计算平均价，一旦价格触及平均价加上（或减去）盈利距离或任一风险控制触发，立即平掉整个篮子。
6. 篮子平仓后立即根据最近两根收盘价准备新的入场信号。

## 资金管理模式
**Money Management** 参数对应原脚本中的 `MMType`：
- **Fixed**：每次下单都使用 **Initial Volume** 指定的基础手数。
- **Geometric**：后续订单的手数按照 `LotExponent^n` 放大，`n` 为当前已开订单数量。
- **RecoverLastLoss**：若上一次篮子亏损，则下一次使用上一笔成交手数乘以 **Lot Exponent**；如果上一次获利，则恢复到基础手数。

手数会根据 **Volume Digits** 以及交易品种的最小成交步长进行四舍五入；若四舍五入后为零，则退回未取整的输入值。

## 风险控制
- **Take Profit**：价格到达平均建仓价 ± 设定点数时整体平仓。
- **Stop Loss**：价格相对平均建仓价逆向超出设定点数时平仓。
- **Use Trailing Stop** 配合 **Trail Start** 与 **Trail Stop**：在篮子盈利达到阈值后启动移动止损，跟随价格保护利润。
- **Use Equity Stop** 配合 **Equity Risk %**：监控投资组合权益，当浮亏超过历史权益峰值的一定比例时强制平仓。
- **Use Timeout** 配合 **Max Open Hours**：当篮子持仓时间超过设定小时数时强制平仓。

## 参数说明
- **Candle Type**：用于生成信号的 K 线周期。
- **Initial Volume**：新篮子初始手数。
- **Volume Digits**：手数保留的小数位数。
- **Money Management**：手数计算模式（`Fixed`、`Geometric`、`RecoverLastLoss`）。
- **Lot Exponent**：几何放大及亏损恢复模式使用的乘数。
- **Close Before Adding**：在加仓前先平掉当前篮子。
- **Use Add**：是否允许加仓。
- **Pip Step**：触发加仓所需的逆向点数。
- **Take Profit**：平均价附近的获利目标。
- **Stop Loss**：平均价允许的最大逆向距离。
- **Use Trailing Stop / Trail Start / Trail Stop**：移动止损设置。
- **Max Trades**：单个篮子允许的最大加仓次数。
- **Use Equity Stop / Equity Risk %**：浮亏保护参数。
- **Use Timeout / Max Open Hours**：篮子最长持仓时间设置。

## 转换说明
- 原 EA 中的挂单函数被直接替换为市价交易，因为原逻辑始终立即执行。
- 移动止损针对整个篮子计算，而非逐单修改，触发阈值保持与脚本一致。
- 通过 StockSharp 的投资组合对象跟踪权益，以复现脚本中的权益止损机制。
- 策略内部通过累计变量计算平均价和篮子数据，遵循高层 API 要求，不额外存储逐笔集合。
