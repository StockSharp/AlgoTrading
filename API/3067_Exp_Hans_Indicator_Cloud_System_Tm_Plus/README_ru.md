# Стратегия Exp Hans Indicator Cloud System Tm Plus

## Общее описание
Exp Hans Indicator Cloud System Tm Plus — это порт MQL5-советника, построенного на диапазонах лондонской сессии. Стратегия отслеживает цветовые состояния индикатора Hans на выбранном таймфрейме: после завершения бычьего прорыва (цвета 0/1) и возврата цены в канал открывается длинная позиция, после медвежьего прорыва (цвета 3/4) — короткая. Все сигналы формируются только по закрытым свечам; риск-менеджмент реализован через пункты и ограничение времени удержания позиции, как в исходном коде.

Алгоритм работает с единственным инструментом и свечной подпиской, возвращаемой `GetWorkingSecurities()`. Размер сделок рассчитывается на основе свойства `Volume` стратегии и коэффициента money-management.

## Логика индикатора
1. Метки времени свечей переводятся из серверного часового пояса (`LocalTimeZone`) в целевой (`DestinationTimeZone`). По умолчанию используется GMT+4 — стандартная настройка Hans.
2. Каждый торговый день собираются два диапазона:
   - **Диапазон 1**: 04:00–08:00 целевого времени. Его максимум/минимум формируют исходный канал.
   - **Диапазон 2**: 08:00–12:00. После завершения заменяет диапазон 1 до конца дня.
3. Границы расширяются на `PipsForEntry` пунктов вверх и вниз. Пункт вычисляется из `PriceStep` инструмента; для инструментов с 3 или 5 знаками после запятой используется поправка ×10, аналогичная MetaTrader.
4. Цвет свечи определяется точно так же, как в индикаторе:
   - Закрытие выше верхней границы → цвет `0` (бычья свеча) или `1` (медвежья).
   - Закрытие ниже нижней границы → цвет `4` (медвежья) или `3` (бычья).
   - Закрытие внутри канала → нейтральный цвет `2`.

## Правила торговли
- **Вход**: если предыдущая закрытая свеча имела бычий цвет (0/1), а последняя свеча больше не окрашена в бычий цвет, открывается лонг (при разрешении). Аналогично для шорта при цветах 3/4.
- **Выход**:
  - Закрытие позиции при смене цвета на противоположный (0/1 для шорта, 3/4 для лонга).
  - При активном `UseTimeExit` позиция ликвидируется после превышения `HoldingMinutes`.
  - Стоп-лосс и тейк-профит (`StopLossPoints`, `TakeProfitPoints`) задаются в пунктах. Если `PriceStep` отсутствует, уровни игнорируются.
- Перед открытием новой позиции всегда выполняется закрытие текущей — как в оригинальных функциях `BuyPositionOpen`/`SellPositionOpen`.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `MoneyManagement` | Доля от `Volume`, используемая в сделке (≤ 0 → используется весь объем). | `0.1` |
| `MoneyMode` | Перечисление режимов money-management из MQL. Реализован только `Lot`. | `Lot` |
| `StopLossPoints` / `TakeProfitPoints` | Дистанция стоп-лосса и тейк-профита в пунктах (0 = выключено). | `1000` / `2000` |
| `DeviationPoints` | Максимально допустимый слиппедж в пунктах. Параметр сохраняется для совместимости и не контролируется ордером. | `10` |
| `AllowBuyEntries` / `AllowSellEntries` | Разрешение на вход в лонг / шорт. | `true` |
| `AllowBuyExits` / `AllowSellExits` | Разрешение на автоматическое закрытие лонгов / шортов. | `true` |
| `UseTimeExit` | Включает временное ограничение позиции. | `true` |
| `HoldingMinutes` | Максимальное время удержания позиции (минуты). | `1500` |
| `PipsForEntry` | Количество пунктов, добавляемых к диапазону. | `100` |
| `SignalBar` | Сдвиг по закрытым свечам для сигналов. Рекомендуется ≥ 1 (как в MT5). | `1` |
| `LocalTimeZone` | Часовой пояс брокера (часы относительно UTC). | `0` |
| `DestinationTimeZone` | Целевой часовой пояс для сессий Hans. | `4` |
| `CandleType` | Таймфрейм, на котором выполняются расчеты. | 30-минутные свечи |

## Управление позицией
- Объем сделки = `Volume * MoneyManagement`, нормализованный к `VolumeStep`. При неположительном результате используется минимальный шаг объема.
- При смене направления отправляется единый рыночный ордер на сумму нового объема и текущей обратной позиции.
- Стоп-лосс и тейк-профит пересчитываются при каждой сделке и сбрасываются после закрытия позиции.

## Рекомендации по использованию
1. Выбирайте инструмент с корректно заданными `PriceStep`, `Decimals` и `VolumeStep`.
2. Настройте `Volume` стратегии перед запуском; параметр `MoneyManagement` масштабирует именно его.
3. Используйте таймфрейм, соответствующий тесту в MT5 (по умолчанию M30). Логика работает только по закрытым свечам.
4. При необходимости скорректируйте `LocalTimeZone` и `DestinationTimeZone`, чтобы диапазоны совпадали с источником котировок.
5. Следите за логами: при отсутствии шага цены уровни стоп/тейк и расширение диапазонов отключаются.

## Особенности реализации
- Применяется высокоуровневый API `SubscribeCandles`, нет ручного доступа к буферам индикатора.
- Диапазоны пересчитываются по мере поступления свечей; хранятся только актуальные значения текущего дня.
- Параметр `DeviationPoints` оставлен для полноты настроек, но не влияет на исполнение рыночных ордеров.
- Метод `OnReseted()` очищает историю цветов и состояние сессий, что облегчает многократные тесты.

## Ограничения
- Поддерживаются только значения `SignalBar ≥ 1`. Для работы с `0` требуется обработка тиков, отсутствующая в портированной версии.
- Дополнительные режимы money-management (`Balance`, `FreeMargin` и т.п.) не реализованы. При необходимости расширяйте `GetOrderVolume()`.
- Без корректного `PriceStep` невозможно перевести пункты в абсолютные цены: стопы, тейки и границы индикатора будут отключены.

