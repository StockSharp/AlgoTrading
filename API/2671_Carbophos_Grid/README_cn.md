# Carbophos 网格策略

## 概述
Carbophos 网格策略是对 MetaTrader 5 专家顾问“Carbophos”的直接移植。它会在当前买入/卖出价附近持续维护对称的限价单梯队，并持续监控整个网格的浮动盈亏。当达到既定盈利目标或者浮亏超过允许阈值时，策略会立即关闭所有头寸并撤销挂单；当市场重新回到空仓状态并且没有未完成订单时，网格会被重新建立。

## 交易逻辑
1. 策略启动且当前没有持仓或挂单时，根据用户配置的“步长（以点为单位）”以及标的的价格精度计算出具体的价格间距，然后在最优买价上方放置若干（可配置）卖出限价单，并在最优卖价下方放置同样数量的买入限价单。
2. 任意挂单成交后，策略会通过 Level1 行情逐笔跟踪仓位。浮动盈亏根据当前平仓价（多头使用买一价，空头使用卖一价）与加权平均持仓价格的差值计算得出。
3. 当浮动盈利超过目标值，或浮动亏损突破保护阈值时，策略会发送市价单平掉剩余仓位，并撤销所有仍在排队的限价单，然后清空内部标记，以便在下一次价格更新时重新搭建网格。
4. 如果所有挂单都成交但净持仓重新回到零（例如市场穿越整个网格来回震荡），下一笔 Level1 行情会触发新的网格布置。

## 参数说明
| 参数 | 说明 |
|------|------|
| `ProfitTarget` | 触发整体平仓的浮动盈利金额。 |
| `MaxLoss` | 触发紧急止损的最大浮动亏损金额。 |
| `StepPips` | 相邻网格层之间的距离，单位为点。策略会结合交易品种的最小跳动单位自动换算成价格距离。 |
| `OrdersPerSide` | 在当前价格上方和下方各自布置的限价单数量。 |
| `OrderVolume` | 每一张网格挂单的下单数量。 |

所有参数都预设了优化区间，便于在 StockSharp 优化器中进行批量测试。

## 风险控制与保护
策略调用一次 `StartProtection()` 并在策略层面设置硬性的资金止盈/止损。当任一阈值触发时，会使用市价单关闭现有仓位并调用 `CancelActiveOrders()` 撤销所有挂单。浮动盈亏通过 `PriceStep` 与 `StepPrice` 计算，因此需要保证所选标的在连接端已正确配置这些交易参数。

## 转换说明
- 原始 MQL5 版本会针对 3 位或 5 位小数的外汇品种调整点值。StockSharp 版本检测标的的 `Decimals` 字段，在为 3 或 5 时自动将 `PriceStep` 乘以 10，从而复现该行为。
- MQL5 会按魔术号统计仓位盈利、手续费与隔夜利息。StockSharp 版本直接通过当前买卖价与平均持仓价计算浮动盈亏，因此无需显式处理手续费。
- 订单的提交、撤销与头寸管理全部使用高层 API（`BuyLimit`、`SellLimit`、`BuyMarket`、`SellMarket`、`CancelActiveOrders`），符合仓库的实现规范。
- 策略完全依赖 Level1 行情驱动，等价于原策略的 `OnTick` 行为，未引入额外的计时器或自定义集合。

## 使用方法
1. 在启动策略前为其实例指定 `Security`（交易标的）和 `Portfolio`（账户）。
2. 根据标的的波动性与风险偏好调整上述参数。
3. 启动策略。策略会立即订阅 Level1 行情，在同时收到买一和卖一价格后搭建初始网格，并自动管理仓位。
4. 关注日志中的提示，例如“Profit target reached”或“Maximum loss reached”，以了解网格何时被重置。

请确保所选交易品种能够提供实时的买卖价 Level1 行情，否则策略无法计算网格位置。
