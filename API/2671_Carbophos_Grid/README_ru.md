# Стратегия Carbophos Grid

## Обзор
Стратегия Carbophos Grid — это прямая конверсия советника MetaTrader 5 «Carbophos». Она постоянно поддерживает симметричную лестницу отложенных ордеров вокруг текущих цен bid/ask, отслеживает совокупную плавающую прибыль по всей сетке и закрывает позиции при достижении цели по прибыли либо при превышении допустимого убытка. После полной фиксации позиции и отмены оставшихся заявок сетка автоматически строится заново.

## Логика торговли
1. При старте стратегии, когда нет открытых позиций и активных ордеров, рассчитывается расстояние между уровнями сетки на основе шага в пунктах и точности котировки инструмента. Затем над лучшей ценой покупки размещается заданное количество (по умолчанию пять) заявок SellLimit, а под лучшей ценой продажи — такое же количество заявок BuyLimit.
2. При исполнении любого ордера стратегия начинает контролировать позицию по каждой новой котировке Level1. Плавающий PnL вычисляется как разница между текущей ценой закрытия (для лонга — лучшая цена bid, для шорта — лучшая цена ask) и средневзвешенной ценой входа.
3. Если плавающая прибыль превышает установленную цель или плавающий убыток достигает предельного значения, стратегия отправляет рыночный ордер для закрытия позиции и отменяет все оставшиеся лимитные заявки. После этого внутренний флаг сбрасывается, и при следующем обновлении цены сетка строится заново.
4. Если все ордера были исполнены, но суммарная позиция вернулась к нулю (например, цена прошла сетку в обе стороны), следующее обновление Level1 приведёт к постановке новой сетки.

## Параметры
| Параметр | Описание |
|----------|----------|
| `ProfitTarget` | Уровень плавающей прибыли (в деньгах), при котором закрывается вся сетка. |
| `MaxLoss` | Максимально допустимый плавающий убыток (в деньгах), запускающий аварийное закрытие. |
| `StepPips` | Расстояние между соседними уровнями сетки в пунктах. Внутри стратегии переводится в цену с учётом `PriceStep` инструмента. |
| `OrdersPerSide` | Количество отложенных ордеров над и под текущей ценой. |
| `OrderVolume` | Объём каждой лимитной заявки сетки. |

Для всех параметров заданы диапазоны оптимизации, что облегчает исследование стратегии в оптимизаторе StockSharp.

## Управление рисками и защита
Стратегия однократно вызывает `StartProtection()` и дополнительно контролирует жёсткие денежные уровни прибыли/убытка. Расчёт плавающего результата опирается на значения `PriceStep` и `StepPrice`. При срабатывании одного из порогов выполняется рыночное закрытие позиции и вызывается `CancelActiveOrders()` для отмены всех активных ордеров, после чего сетка может быть построена заново.

## Особенности конверсии
- В оригинальном MQL5 для инструментов с тремя или пятью знаками после запятой точка пересчитывалась отдельно. Порт StockSharp выполняет ту же корректировку, умножая `PriceStep` на 10, когда `Security.Decimals` равен 3 или 5.
- MetaTrader суммирует прибыль, комиссию и своп по «магическому» номеру. В версии StockSharp плавающий PnL пересчитывается по текущим ценам bid/ask и средневзвешенной цене входа, поэтому отдельная обработка комиссий не требуется.
- Управление ордерами реализовано через высокоуровневые методы `BuyLimit`, `SellLimit`, `BuyMarket`, `SellMarket` и `CancelActiveOrders`, что соответствует требованиям репозитория.
- Обновление состояния происходит только по событиям Level1, что повторяет поведение `OnTick` в MetaTrader и не требует дополнительных таймеров или самописных структур данных.

## Использование
1. Перед запуском стратегии укажите нужные `Security` и `Portfolio`.
2. При необходимости скорректируйте параметры под характеристики инструмента и допустимый риск.
3. Запустите стратегию: она подпишется на Level1, построит первую сетку после получения лучшего bid и ask и дальше будет управлять позициями автоматически.
4. Следите за сообщениями в журнале (например, «Profit target reached» или «Maximum loss reached»), чтобы понимать, когда сетка была закрыта и построена заново.

Убедитесь, что выбранный инструмент предоставляет поток котировок с лучшим bid/ask; без этих данных сетка не будет построена.
