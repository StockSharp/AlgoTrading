# Surfing 3.0 策略

## 概述

该 C# 策略忠实移植自 MetaTrader 4 专家顾问 **Surfing 3.0**。它监控由蜡烛最高价和最低价构成的指数移动平均线（EMA）通道，只要上一根蜡烛仍位于通道内部，而最新收盘价突破上下边界，就按突破方向开仓。移植版完全依赖 StockSharp 的高级 API、蜡烛订阅以及内置指标，而不是手动维护缓存数组。

算法只处理选定聚合周期的已收盘蜡烛，并保留最少量的历史数据来模拟原始代码中的 `iMA` 与 `iClose` 调用。每根蜡烛只计算一次信号，这与 MQL 版本“以收盘价决策”的风格保持一致。

## 指标

- **最高价 EMA / 最低价 EMA** – 以蜡烛最高价和最低价为输入的两条指数移动平均线，形成一个动态通道，用于判断向上或向下突破。
- **相对强弱指数 (RSI)** – 趋势过滤器。只有当 RSI 高于 `LongRsiThreshold` 时才允许做多，低于 `ShortRsiThreshold` 时才允许做空。

## 交易规则

1. 订阅 `CandleType` 指定的蜡烛，并在每根收盘蜡烛上更新 EMA 与 RSI 指标。
2. 保存上一根蜡烛的收盘价以及对应的 EMA 数值，它们分别对应原始专家中的 `PriceClose_2`、`PriceHigh_2` 和 `PriceLow_2`。
3. 当最新收盘价 (`PriceClose_1`) **向上** 突破最高价 EMA，且上一根收盘价位于通道内部或边界，同时 RSI 满足多头阈值时：
   - 平掉现有的空头仓位（如存在）。
   - 以 `OrderVolume` 的数量买入做多。
   - 按照点数计算止损与止盈价格。
4. 当最新收盘价 **向下** 突破最低价 EMA，且上一根收盘价位于通道内部或边界，同时 RSI 低于空头阈值时：
   - 平掉现有的多头仓位。
   - 以 `OrderVolume` 的数量卖出做空。
   - 套用相同点数距离的保护性止损与止盈。
5. 同一时间只保持一个净头寸。反向信号会先平仓再开立反方向头寸。
6. 在 `[TradeStartHour, TradeEndHour)` 交易时段之外不会开新仓。一旦时间达到 `TradeEndHour`，策略会强制平仓并清空内部历史，重现 MQL 中 `closeAllPos()` 的行为。

## 风险控制

- **止损 / 止盈** – 使用合约最小变动价位（Price Step）将点数距离转换为绝对价格。设置为 `0` 即可关闭对应的保护水平。
- **交易时段平仓** – 当达到 `TradeEndHour` 时立即平仓并清除目标价，避免头寸隔夜，完全符合原策略的交易时间限制。

## 参数

| 名称 | 说明 | 默认值 |
|------|------|--------|
| `OrderVolume` | 每笔市场订单的交易量。 | `1` |
| `TakeProfitPoints` | 止盈距离（点数）。 | `80` |
| `StopLossPoints` | 止损距离（点数）。 | `50` |
| `MaPeriod` | 计算高低价 EMA 的周期。 | `50` |
| `RsiPeriod` | RSI 指标的周期长度。 | `10` |
| `LongRsiThreshold` | 允许做多所需的最小 RSI 值。 | `40` |
| `ShortRsiThreshold` | 允许做空所需的最大 RSI 值。 | `65` |
| `TradeStartHour` | 允许开仓的起始小时（交易所时间）。 | `8` |
| `TradeEndHour` | 平仓并停止开仓的小时（不含该刻）。 | `18` |
| `CandleType` | 用于计算的蜡烛聚合方式（默认 15 分钟）。 | `15m` |

## 说明

- 仅基于已收盘蜡烛计算信号，忽略盘中波动，与 MetaTrader 中的行为一致。
- 交易时段结束后会重置 EMA 历史，避免不同交易日之间的数据混淆。
- 根据项目要求，本策略未提供 Python 版本。
