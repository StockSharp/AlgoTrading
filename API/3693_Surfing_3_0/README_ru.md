# Стратегия Surfing 3.0

## Обзор

Данная стратегия на C# является точной адаптацией эксперта MetaTrader 4 **Surfing 3.0**. Она повторяет пробойную логику, основанную на экспоненциальных скользящих средних (EMA), построенных по максимумам и минимумам свечей. Когда предыдущая свеча закрывается внутри канала, а последняя закрытая свеча пробивает границу, система открывает сделку в направлении пробоя. Перенос выполнен на высокоуровневом API StockSharp с использованием подписки на свечи и встроенных индикаторов, без ручного копирования буферов.

Алгоритм работает исключительно с закрытыми свечами выбранной агрегации. Он хранит только минимальный набор значений, чтобы воспроизвести обращения `iMA` и `iClose` из оригинала. Решения принимаются один раз на каждую закрытую свечу, что полностью соответствует стилю "по закрытию бара" в версии MQL.

## Индикаторы

- **EMA по максимумам / EMA по минимумам** – две экспоненциальные скользящие, вычисляемые по High и Low. Они образуют динамический коридор, относительно которого определяется пробой для входа в покупки или продажи.
- **Индекс относительной силы (RSI)** – фильтр тренда. Для длинных позиций RSI должен быть выше `LongRsiThreshold`, для коротких – ниже `ShortRsiThreshold`.

## Торговые правила

1. Подписаться на свечи типа `CandleType` и на каждой закрытой свече обновлять значения EMA и RSI.
2. Сохранять значения закрытия и EMA предыдущей свечи – это аналоги `PriceClose_2`, `PriceHigh_2` и `PriceLow_2` в исходном коде.
3. Если последняя закрытая свеча (`PriceClose_1`) пробивает **вверх** EMA по максимумам, а предыдущая свеча закрылась ниже либо на границе, и RSI подтверждает сигнал:
   - Закрыть открытую короткую позицию (если она есть).
   - Открыть рыночную покупку объёмом `OrderVolume`.
   - Рассчитать стоп-лосс и тейк-профит в пунктах инструмента.
4. Если последняя закрытая свеча пробивает **вниз** EMA по минимумам, а предыдущая свеча закрылась выше либо на границе, и RSI находится ниже порога для шорта:
   - Закрыть открытую длинную позицию.
   - Открыть рыночную продажу объёмом `OrderVolume`.
   - Установить защитные уровни с теми же точными отступами в пунктах.
5. Одновременно может существовать только одна чистая позиция. Сигналы разворота сначала закрывают текущую позицию и только потом открывают противоположную.
6. Вне торгового окна `[TradeStartHour, TradeEndHour)` новые сделки не открываются. Как только наступает `TradeEndHour`, стратегия закрывает все позиции и сбрасывает внутреннюю историю, что повторяет логику `closeAllPos()` из MQL.

## Риск-менеджмент

- **Стоп-лосс / тейк-профит** – задаются в пунктах инструмента и переводятся в абсолютные цены с учётом шага цены. Значение `0` отключает соответствующий уровень.
- **Выход по окончании сессии** – при наступлении `TradeEndHour` все позиции закрываются по рынку, после чего очищаются контрольные уровни. Это не позволяет переносить сделки через ночь, как и в оригинальном эксперте со свойствами `startHour` и `endHour`.

## Параметры

| Имя | Описание | Значение по умолчанию |
|-----|----------|-----------------------|
| `OrderVolume` | Объём каждой рыночной сделки. | `1` |
| `TakeProfitPoints` | Дистанция тейк-профита в пунктах. | `80` |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах. | `50` |
| `MaPeriod` | Период EMA, рассчитываемых по максимумам и минимумам. | `50` |
| `RsiPeriod` | Период индикатора RSI. | `10` |
| `LongRsiThreshold` | Минимальное значение RSI для разрешения покупок. | `40` |
| `ShortRsiThreshold` | Максимальное значение RSI для разрешения продаж. | `65` |
| `TradeStartHour` | Час (время биржи), начиная с которого разрешены новые сделки. | `8` |
| `TradeEndHour` | Час (исключительно), после которого сделки закрываются и новые не открываются. | `18` |
| `CandleType` | Тип свечей для расчётов (по умолчанию – 15-минутные свечи). | `15m` |

## Примечания

- Сигналы оцениваются только по закрытым свечам, внутрибараные колебания игнорируются, как и в MetaTrader.
- История EMA очищается после завершения торгового окна, чтобы не смешивать данные разных дней.
- Python-версия умышленно не создаётся согласно требованиям проекта.
