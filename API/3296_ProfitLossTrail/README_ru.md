# ProfitLossTrailStrategy

## Описание

ProfitLossTrailStrategy — это портированный в StockSharp инструмент управления риском из эксперта **ProfitLossTrailEA v2.30** для MetaTrader. Стратегия не открывает позиции самостоятельно: она следит за текущей позицией по выбранному инструменту и выполняет защитные действия автоматически:

- постановка стартовых уровней стоп-лосса и тейк-профита относительно средней цены входа;
- сопровождение позиции трейлинг-стопом с настраиваемым запуском и шагом подтягивания;
- перевод сделки в безубыток после достижения заданной прибыли;
- возможность полностью отключить автоматическое сопровождение, чтобы управлять позициями вручную.

Поведение стратегии соответствует режиму "Same_Type_As_One" из исходного советника: все сделки одного направления агрегируются в единую корзину, при изменении объёма пересчитываются защитные уровни.

## Параметры

| Параметр | Назначение |
|----------|------------|
| **Manage As Basket** | Включает пересчёт средней цены и защитных уровней при каждом увеличении позиции. Если выключить параметр, стопы и цели после первой сделки не пересчитываются. |
| **Enable Take Profit** | Включает автоматическое выставление тейк-профита. |
| **Take Profit (pips)** | Расстояние в пунктах от цены входа до тейк-профита. |
| **Enable Stop Loss** | Включает автоматическое выставление стоп-лосса. |
| **Stop Loss (pips)** | Расстояние в пунктах от цены входа до первоначального стоп-уровня. |
| **Enable Trailing Stop** | Активирует трейлинг-стоп после появления прибыли. |
| **Trailing Activation (pips)** | Минимальная прибыль (в пунктах), необходимая для запуска трейлинга. Значение `0` — запуск сразу. |
| **Trailing Stop (pips)** | Базовое расстояние трейлинг-стопа в пунктах. |
| **Trailing Step (pips)** | Дополнительная прибыль, требуемая для очередного подтягивания стопа. |
| **Enable Break-Even** | Переводит стоп-лосс в безубыток после достижения заданного профита. |
| **Break-Even Trigger (pips)** | Прибыль в пунктах, после которой активируется перевод в безубыток. |
| **Break-Even Offset (pips)** | Дополнительное смещение стоп-лосса относительно цены входа при переводе в безубыток. |
| **Remove Take Profit** | При значении `true` очищает тейк-профит и отменяет автоматическое закрытие по цели. |
| **Remove Stop Loss** | При значении `true` удаляет стоп-лосс и отключает трейлинг и безубыток. |
| **Candle Type** | Тип свечей, по закрытию которых выполняется проверка условий сопровождения. |

## Рекомендации по использованию

1. Запускайте стратегию совместно с другой логикой, которая формирует входы. ProfitLossTrailStrategy управляет исключительно уже открытой позицией.
2. Параметры расстояний задаются в пунктах; размер пункта рассчитывается автоматически по `Security.PriceStep`.
3. Если одновременно включены трейлинг и безубыток, сначала срабатывает безубыток, после чего трейлинг подтягивает стоп только при улучшении уровня как минимум на величину шага.
4. Установка **Remove Stop Loss** полностью отменяет автоматическое сопровождение сделки — поведение идентично оригинальному советнику.
5. При срабатывании защитных уровней стратегия закрывает позицию рыночными ордерами `BuyMarket` / `SellMarket`.

## Особенности портирования

- Раздельное управление заявками (режим "Order_By_Order") в StockSharp отсутствует, поэтому параметр **Manage As Basket** отражает базовую логику объединения позиций.
- Фильтры по magic number и комментариям из MetaTrader не потребовались — стратегия работает только с инструментом, назначенным в `Strategy.Security`.
- Интерфейсные элементы, звуковые уведомления и таймер из оригинального эксперта не перенесены, так как StockSharp предоставляет собственные механизмы визуализации и журналирования.
