# Прорыв по полосам Боллинджера DC2008
[English](README.md) | [中文](README_cn.md)

Портирование эксперта Сергея Павлова (DC2008) для MetaTrader в среду StockSharp. Стратегия отслеживает закрытые свечи выбранного таймфрейма, строит полосы Боллинджера по указанной цене и открывает/разворачивает позиции только тогда, когда текущая сделка не убыточна.

## Краткое описание
- Формирует оболочку из полос Боллинджера на выбранном типе свечей и источнике цены (закрытие, открытие, максимум, минимум, медиана, типичная, взвешенная или средняя цена).
- **Покупка** происходит, когда минимум свечи пробивает нижнюю полосу, а максимум остаётся ниже средней линии (сильное движение вниз, ожидается возврат).
- **Продажа** выполняется, когда максимум свечи пробивает верхнюю полосу, а минимум находится выше средней линии (сильное движение вверх, ожидается возврат).
- В оригинале сигналы проверялись на каждом тике; в этой версии расчёты выполняются на закрытии свечи, что повышает устойчивость и соответствует логике индикатора.
- Позиции открываются или переворачиваются только при неотрицательной плавающей прибыли, повторяя фильтр исходного робота.

## Алгоритм работы
### Построение индикатора
1. Подписка на свечи типа `CandleType` (по умолчанию часовые свечи).
2. Передача выбранной цены в индикатор Bollinger Bands (`Length = BandsPeriod`, `Width = BandsDeviation`).
3. До появления валидных значений верхней, средней и нижней линий сигналы игнорируются.

### Условия входа
- **Лонг**: `Low < LowerBand` и одновременно `High < MiddleBand`. Вся свеча торгуется ниже средней линии после пробоя нижней полосы.
- **Шорт**: `High > UpperBand` и одновременно `Low > MiddleBand`. Вся свеча находится выше средней линии после пробоя верхней полосы.

### Фильтр позиции и сопровождение
- При отсутствии позиции выставляется рыночный ордер объёмом `Volume` сразу после сигнала.
- Если позиция уже открыта:
  - Для противоположного сигнала вычисляется нереализованная прибыль как `Position * (Close - PositionPrice)` по цене закрытия свечи.
  - При отрицательной прибыли действия пропускаются (аналог `return` в MQL).
  - При прибыли ≥ 0 и противоположном сигнале отправляется рыночный ордер объёмом `Volume + |Position|`, что закрывает текущую позицию и открывает новую в направлении сигнала.
  - Сигналы в сторону текущей позиции не наращивают объём — поведение полностью повторяет оригинал.
- Стоп-лосс и тейк-профит не задаются; выход осуществляется только по встречному сигналу, прошедшему фильтр прибыли.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `BandsPeriod` | 80 | Количество свечей для расчёта средней и отклонений полос Боллинджера. Положительное, доступно для оптимизации. |
| `BandsDeviation` | 3.0 | Множитель стандартного отклонения, задающий ширину полос. Положительный, доступен для оптимизации. |
| `AppliedPrice` | Close | Источник цены для расчёта индикатора: Close, Open, High, Low, Median, Typical, Weighted или Average (OHLC/4). Аналог `ENUM_APPLIED_PRICE` из MetaTrader. |
| `CandleType` | Часовой таймфрейм | Тип свечей, используемый в анализе. Можно заменить на любой другой поддерживаемый StockSharp. |
| `Volume` (унаследованный) | зависит от брокера | Объём новых входов. При развороте автоматически добавляется текущий модуль позиции. |

## Отличия от эксперта MetaTrader
- В MQL стратегия работала на тиках; здесь используется закрытие свечей, чтобы не реагировать на незавершённые бары.
- Параметр сдвига индикатора в исходнике всегда равнялся нулю, поэтому отдельно не выводится.
- В MetaTrader плавающая прибыль берётся из торгового ядра, в порте она оценивается через `PositionPrice` и цену закрытия, что достаточно для проверки знака.
- Убраны текстовые комментарии и управление ордерами, не влияющие на торговую логику.

## Технические детали
- Используются высокоуровневые методы StockSharp: подписка на свечи, индикаторы, `BuyMarket`/`SellMarket`.
- При наличии области графика отображаются свечи, индикатор и сделки для визуального контроля.
- При перезапуске стратегия пересоздаёт индикатор, поэтому изменения параметров учитываются с нового запуска.
