# Total Power Indicator X 策略

## 概览
该策略使用 StockSharp 的高级 API 重现 MetaTrader 专家顾问 “Exp_TotalPowerIndicatorX”。自定义的 Total Power 指标通过统计滚动窗口内多少根 K 线的高点高于内部 EMA、低点低于内部 EMA 来衡量多空力量，并在两条力量线发生交叉时做出交易决策。

指标适用于任意品种和周期。默认订阅 4 小时 K 线，以匹配原始 EA 的设置，不过可以通过参数自由调整时间框架。

## 交易逻辑
1. 每当一根 K 线收盘时，将数据送入 Total Power 指标，该指标会：
   - 按 **Power Period** 指定的周期计算 EMA。
   - 在最近 **Lookback Period** 根 K 线中统计 `High > EMA` 的次数（多头）以及 `Low < EMA` 的次数（空头）。
   - 将计数转换为 0–100 范围的百分比型力量值。
2. 当多头力量上穿空头力量时，如果允许做多且当前没有持仓，则开多。
3. 当空头力量上穿多头力量时，如果允许做空且当前没有持仓，则开空。
4. 如果开启了对应的平仓开关，则在出现相反交叉时平掉已有头寸。
5. 可选的交易时段过滤器会在离开设定时间窗口时强制平仓，并禁止在该时间段外开仓。起始时间晚于结束时间的跨夜窗口同样支持。
6. 可选的止损与止盈以价格步长的倍数表示。当 K 线的最高价或最低价触及这些水平时，会立即发出平仓指令并重新计算目标。

## 参数
- **Candle Type**：用于计算的时间框架，默认 4 小时。
- **Power Period**：指标内部 EMA 的长度，对应 MQL 输入参数，默认 10。
- **Lookback**：多空力量统计所使用的 K 线数量，默认 45。
- **Volume**：每次下单的数量，默认 1。
- **Enable Long Entry / Enable Short Entry**：允许或禁止新的多头/空头建仓。
- **Enable Long Exit / Enable Short Exit**：在相反信号出现时是否自动平仓。关闭后头寸会保持，直到手动或被止损止盈处理。
- **Use Trading Hours**：启用时段过滤，仅在 **Start Hour/Minute** 与 **End Hour/Minute** 之间进行交易，并在时段外平掉现有头寸。
- **Stop Loss Points / Take Profit Points**：距离开仓价的价格步长数量。设置为 0 表示禁用，需要保证 `Security.PriceStep` 元数据可用。

## 说明
- 策略只有在该品种没有持仓时才会开新仓，从而与原版 EA 的行为保持一致。
- 止损与止盈依赖于品种的价格步长，如果元数据缺失则会自动禁用这些保护。
- 若界面可用，策略会在图表面板上绘制 Total Power 指标，便于观察多空力量的交叉情况。
