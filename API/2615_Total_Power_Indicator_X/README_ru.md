# Стратегия Total Power Indicator X

## Обзор
Стратегия повторяет логику советника MetaTrader «Exp_TotalPowerIndicatorX», используя высокоуровневые API StockSharp. Пользовательский индикатор Total Power оценивает преобладание быков и медведей, подсчитывая, сколько свечей в скользящем окне закрылись выше или ниже внутренней EMA. Сделки совершаются, когда линии силы пересекаются.

Индикатор работает на любом инструменте и таймфрейме. По умолчанию используется четырехчасовой график, как и в исходном советнике, однако период можно менять через параметр.

## Правила торговли
1. Для каждой завершенной свечи стратегия обновляет индикатор Total Power, который:
   - Вычисляет EMA с периодом **Power Period**.
   - Подсчитывает количество свечей в пределах **Lookback Period**, у которых `High > EMA` (бычья сила) и `Low < EMA` (медвежья сила).
   - Преобразует подсчеты в значения силы в диапазоне 0–100.
2. **Бычье пересечение** (бычья сила становится выше медвежьей) приводит к открытию длинной позиции, если разрешена торговля в длинную сторону и нет открытых позиций.
3. **Медвежье пересечение** (медвежья сила становится выше бычьей) приводит к открытию короткой позиции, если разрешено открывать шорты и нет открытых позиций.
4. Обратные пересечения закрывают существующие позиции, если включены соответствующие флаги выхода.
5. Дополнительный фильтр торговых сессий закрывает позиции вне заданного интервала времени и запрещает новые входы до возвращения в рабочее окно. Поддерживаются ночные сессии, когда время начала больше времени окончания.
6. Необязательные уровни стоп-лосса и тейк-профита задаются в шагах цены инструмента. После открытия позиции уровни рассчитываются заново и срабатывают при пробое максимумом или минимумом свечи.

## Параметры
- **Candle Type** – таймфрейм для расчетов, по умолчанию H4.
- **Power Period** – длина EMA внутри индикатора, эквивалентна параметру MQL. Значение по умолчанию 10.
- **Lookback** – количество свечей для подсчета силы быков и медведей. По умолчанию 45.
- **Volume** – объем заявки. По умолчанию 1.
- **Enable Long Entry / Enable Short Entry** – разрешение на открытие длинных/коротких позиций.
- **Enable Long Exit / Enable Short Exit** – закрытие позиций при противоположных сигналах. Если отключить, позиция останется открытой до ручного закрытия или до срабатывания стопов.
- **Use Trading Hours** – фильтр торговых часов. При включении стратегия торгует только между **Start Hour/Minute** и **End Hour/Minute**, а вне этого диапазона закрывает позиции. Поддерживаются окна, пересекающие полночь.
- **Stop Loss Points / Take Profit Points** – расстояние от цены входа в шагах цены. Значение 0 отключает уровень. Расчет использует `Security.PriceStep`, поэтому важно, чтобы данные инструмента были доступны.

## Примечания
- Новая позиция открывается только при отсутствии текущей позиции по инструменту, что соответствует поведению оригинального советника.
- Если шаг цены инструмента неизвестен, уровни стоп-лосса и тейк-профита будут автоматически отключены.
- При наличии интерфейса стратегия отображает значение индикатора на графике, что облегчает визуальный анализ пересечений.
