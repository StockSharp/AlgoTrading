# Стратегия Lilith Goes To Hollywood

## Обзор
Данная реализация переносит эксперт MetaTrader «Lilith goes to Hollywood» на высокий уровень API StockSharp. Стратегия строит хеджирующую сетку и умеет работать в двух режимах:

* **Автоматический режим** – входы выполняются по сигналам индикатора Parabolic SAR (ускорение 0.02, максимум 0.2).
* **Ручной режим** – вокруг заданных ценовых уровней выставляются отложенные ордера stop/limit, которые ожидают срабатывания.

В обоих режимах стратегия раздельно ведёт учёт объёмов длинных и коротких позиций, рассчитывает плавающий результат сетки и принимает решения о догрузке или хеджировании.

## Режимы работы
* **Автоматический**. Пока позиция отсутствует, стратегия отслеживает значения Parabolic SAR на завершённых свечах. Если цена закрытия выше SAR – покупка по рынку, если ниже – продажа. Цена сделки становится новой **точкой фокуса**, а восстановительные ордера размещаются на заданном расстоянии (AnchorSteps) вокруг неё.
* **Ручной**. Пока позиция отсутствует, поддерживается по одному отложенному ордеру на каждую сторону. Если рынок ниже `PriceUp`, создаётся buy stop, иначе buy limit. Для продаж аналогично используется уровень `PriceDown`. После срабатывания одного ордера второй остаётся активным до отмены вручную или логикой стратегии.

## Управление ордерами
* Стратегия постоянно контролирует накопленные объёмы по длинной/короткой стороне и объёмы отложенных заявок, что позволяет оценить дисбаланс сетки.
* Когда плавающий результат достигает динамической цели (`стоимость счёта / 1000`), все позиции закрываются, а ордера отменяются.
* Если плавающий результат опускается ниже `-AccountValue * RiskPercent / 100`, включается аварийное хеджирование: по рынку открываются сделки, выравнивающие превышающий объём.
* Восстановительные заявки выставляются в виде stop-ордеров вокруг точки фокуса (для автоматического режима) или вокруг ручных уровней. Их объём рассчитывается как `(противоположный объём * XFactor) - текущий объём`, что повторяет оригинальный алгоритм MT4.

## Параметры
| Имя | Описание |
| --- | --- |
| `Automated` | Включает/отключает автоматические входы по Parabolic SAR. |
| `PriceUp` | Уровень для размещения buy stop/buy limit в ручном режиме. |
| `PriceDown` | Уровень для размещения sell stop/sell limit в ручном режиме. |
| `AnchorSteps` | Расстояние в шагах цены, на которое смещаются восстановительные ордера от точки фокуса. |
| `ManualVolume` | Базовый объём сделок в ручном режиме или при нулевом результате динамического расчёта. |
| `XFactor` | Множитель объёма противоположной стороны при расчёте восстановительных заявок. |
| `RiskPercent` | Максимально допустимая плавающая просадка (в процентах от стоимости счёта) перед запуском аварийного хеджирования. |
| `CandleType` | Тип свечей, используемый для обновления индикатора и логики управления. |

## Управление рисками
* Цель по прибыли масштабируется от стоимости портфеля, автоматически повышая планку по мере роста счёта.
* При превышении порога `RiskPercent` стратегия защищает сетку, выравнивая перекос объёмов рыночными сделками.
* Все цены заявок округляются к шагу котировки, а объёмы корректируются в соответствии с ограничениями инструмента, что повторяет защитные механизмы оригинального советника.

## Особенности конверсии
* Вместо тиковых вызовов MetaTrader используются завершённые свечи. По умолчанию выбран минутный таймфрейм, но его можно изменить через параметр `CandleType`.
* Параметр `Anchor` из MQL задавался в «поинтах»; здесь он выражается количеством шагов цены, что позволяет автоматически учитывать размер тика инструмента.
* Сообщения, выводимые через `Comment`, преобразованы в записи `LogInfo`, поэтому состояние стратегии видно в системном журнале StockSharp.
