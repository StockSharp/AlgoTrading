# Стратегия Couple Hedge
[English](README.md) | [中文](README_cn.md)

Стратегия Couple Hedge представляет собой мультивалютную сетку, перенесённую из советника **MT4 CoupleHedgeEA v2.5**. Пользователь задаёт упорядоченный список валют, после чего стратегия строит все возможные валютные пары и торгует их в виде хеджирующих корзин. Плюсовые корзины открывают длинные позиции, минусовые — короткие, сохраняя относительную нейтральность по рынку. Убытки отрабатываются добавлением позиций по правилам «шагов» и «прогрессий», аналогичным оригиналу.

В версии для StockSharp упор сделан на торговые алгоритмы. Графический интерфейс и визуальные элементы MT4 убраны, зато сохранились ключевые параметры управления капиталом: режим работы, логика добавления ордеров, закрытие по прибыли/убытку и прогрессии лотов.

## Идея оригинала
- Одновременная торговля несколькими парами, собранными из трёх-пяти валют.
- Ведение плюсовых и минусовых корзин с ребалансировкой по изменению относительной силы.
- Доливка в убыточные корзины с настраиваемыми шагами и множителями объёма до выхода общей прибыли в плюс.
- Закрытие корзин при достижении заданной прибыли (в расчёте на лот) с возможной задержкой в несколько свечей.

## Реализация в StockSharp
- Генерация всех комбинаций валют на основе строки `CurrencyTrade` (например, `EUR/GBP/USD` создаёт пары EURGBP, EURUSD и GBPUSD). Если инструмент не найден у поставщика, он пропускается, а стратегию можно запустить на базовом символе.
- Для оценки относительной силы используется скользящая средняя (`TrendPeriod`) и ATR (`AtrPeriod`). Новая корзина открывается только после превышения `SignalThreshold` (отклонение цены, нормированное на ATR).
- Поддерживаются все варианты фильтра по направлению (`TradeOnlyPlus`, `TradeOnlyMinus`, `TradePlusAndMinus`). Плюсовые корзины покупают инструмент, минусовые продают.
- Дополнительные уровни доливаются при достижении требуемого убытка на лот. В ручном режиме используется параметр `StepOpenNextOrders`, в автоматическом шаг умножается на текущий ATR. Доступны прогрессии шагов и лотов (`Statical`, `Geometrical`, `Exponential`).
- Реализовано закрытие как по отдельным билетам, так и по общей корзине. Счётчики задержек (`DelayCloseProfit`, `DelayCloseLoss`) имитируют ожидание перед закрытием.
- Управление убытками позволяет закрыть всю корзину либо снять только первый уровень, оставив остальную сетку в работе.
- Автолотовка приближена к оригинальному "RiskFactor": стратегия выделяет процент от капитала портфеля на каждую корзину. При отключении используется фиксированный `ManualLotSize`.

## Правила торговли
- **Вход**
  - Рассчитывается отклонение = (Close − SMA) / ATR.
  - Плюсовая корзина открывается, если отклонение ≥ `SignalThreshold` и разрешено направление long.
  - Минусовая корзина открывается, если отклонение ≤ −`SignalThreshold` и разрешено направление short.
- **Доливка**
  - Включена, если `OpenOrdersInLoss` ≠ `NotOpenInLoss`.
  - Срабатывает, когда плавающий убыток на лот достигает текущего шага.
  - Объём доливки определяется типом прогрессии лотов.
  - Учитывается лимит `MaximumOrders` (0 — без ограничения).
- **Выход по прибыли**
  - Режим Ticket: закрывает конкретную пару после превышения `TargetCloseProfit` на протяжении `DelayCloseProfit` свечей.
  - Режим Basket: закрывает все пары при достижении общей цели прибыли и выдержке задержки.
  - Hybrid требует одновременного подтверждения обоими режимами.
  - При `CloseInProfitAndStop` стратегия останавливается после фиксации прибыли.
- **Выход по убытку**
  - Активируется при убытке на лот ≥ `TargetCloseLoss` в течение `DelayCloseLoss` свечей.
  - `WholeTicket` закрывает всю корзину, `OnlyFirstOrder` снимает только первый уровень, `NotCloseInLoss` игнорирует сигнал.

## Параметры (по умолчанию)
- `TypeOperation` = `NormalOperation`
- `OpenOrdersInLoss` = `OpenWithAutoStep`
- `StepOpenNextOrders` = 50 (USD на лот)
- `StepOrdersProgress` = `GeometricalStep`
- `LotOrdersProgress` = `StaticalLot`
- `TypeCloseInProfit` = `BasketOrders`
- `TargetCloseProfit` = 50 (USD на лот)
- `DelayCloseProfit` = 3 свечи
- `TypeCloseInLoss` = `NotCloseInLoss`
- `TargetCloseLoss` = 1000 (USD на лот)
- `DelayCloseLoss` = 3 свечи
- `MaximumOrders` = 0 (без ограничения)
- `SideToOpenOrders` = `TradePlusAndMinus`
- `CurrencyTrade` = `EUR/GBP/USD`
- `AutoLotSize` = false
- `RiskFactor` = 0.1 (10% капитала при автолоте)
- `ManualLotSize` = 0.01
- `TrendPeriod` = 34
- `AtrPeriod` = 14
- `SignalThreshold` = 0.3
- `CandleType` = таймфрейм 15 минут

## Ограничения
- Не перенесены группы, списки исключений, цветовые настройки интерфейса, управление сессиями и логирование в файлы.
- Таймер MT4 заменён на обработку свечей; отдельного таймера с миллисекундами нет.
- Автолотовка использует упрощённую модель процента капитала, потому что в StockSharp нет данных о кредитном плече счёта MT4.
- Для работы режимов закрытия требуется публикация PnL по позициям со стороны коннектора.
- Python-версия намеренно не создавалась согласно заданию.
