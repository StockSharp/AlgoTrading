# Стратегия Exp XBullsBearsEyes Vol Direct

## Обзор
Данная стратегия представляет собой порт MetaTrader-советника **Exp_XBullsBearsEyes_Vol_Direct** на язык C# и платформу
StockSharp. Алгоритм восстанавливает пользовательский осциллятор, построенный на индикаторах Bulls Power и Bears Power, умножает
его на выбранный источник объёма и применяет ту же адаптивную фильтрацию гамма-сеткой, что и оригинал. Торговые решения
принимаются исключительно по буферу направления индикатора: стратегия реагирует на смену наклона сглаженной гистограммы, а не на
пересечение уровней.

В отличие от упрощённых портов, версия для StockSharp сохраняет взвешивание по объёму и четырёхзвенную фильтрацию `Gamma`,
использовавшуюся в MQL. Гистограмма сглаживается дважды одним и тем же типом скользящего среднего — отдельно для самой серии и
для потока объёма — поэтому сигналы появляются только после полного формирования обеих компонент. Стратегия обрабатывает только
закрытые свечи и может работать как с тиковым объёмом, так и с реальным объёмом торгов, что делает её универсальной для разных
рынков.

## Логика индикатора
1. Рассчитываются Bulls Power и Bears Power с экспоненциальной скользящей средней цены закрытия длиной `Period`.
2. Полученные значения проходят через четырёхступенчатый гамма-фильтр (`L0`–`L3`), формируя нормализованную гистограмму в диапазоне
   от -50 до +50.
3. Гистограмма умножается на выбранный источник объёма (количество тиков или фактический объём сделок).
4. Гистограмма и объём дополнительно сглаживаются выбранным типом скользящего среднего (`Method`, `SmoothingLength`, `SmoothingPhase`).
5. Строится буфер направления: цвет `0`, если сглаженная гистограмма растёт, и `1`, если падает. Это точный аналог буфера
   `ColorDirectBuffer` из версии MetaTrader.

Пороговые уровни (HighLevel/LowLevel) также рассчитываются для совместимости, но не участвуют в фильтрации сделок, повторяя
поведение исходного советника.

## Правила торговли
- **Закрытие коротких позиций** происходит, если предыдущая свеча имела восходящее направление (`olderColor = 0`).
- **Открытие длинных позиций** разрешено, когда длинные сделки включены, восходящая свеча сменяется нисходящей (`currentColor = 1`)
  и стратегия не находится в длинной позиции.
- **Закрытие длинных позиций** выполняется, если предыдущая свеча была нисходящей (`olderColor = 1`).
- **Открытие коротких позиций** выполняется при включённых коротких сделках, когда нисходящая свеча сменяется восходящей
  (`currentColor = 0`) и отсутствует длинная позиция.
- При развороте позиции сначала закрывается встречная сделка, затем отправляется рыночный ордер объёмом `OrderVolume`.

Оценка сигналов ведётся с учётом сдвига `SignalBar`. Значение по умолчанию `1` полностью воспроизводит поведение MQL-советника,
который ждал закрытия свечи перед подачей команд.

## Параметры
| Имя | Описание |
|-----|----------|
| `CandleType` | Тип/таймфрейм свечей, используемых стратегией (по умолчанию двухчасовые свечи). |
| `Period` | Длина расчёта Bulls/Bears Power. |
| `Gamma` | Коэффициент сглаживания гамма-фильтра (0…1). |
| `VolumeMode` | Источник объёма: тиковый или реальный. |
| `Method` | Тип скользящего среднего для сглаживания гистограммы и объёма (SMA, EMA, SMMA, LWMA, Jurik; устаревшие варианты
переходят к SMA). |
| `SmoothingLength` | Длина обоих этапов сглаживания. |
| `SmoothingPhase` | Параметр фазы Jurik (для совместимости). |
| `SignalBar` | Количество баров назад, откуда берётся направление. |
| `AllowBuyOpen` / `AllowSellOpen` | Разрешение на открытие длинных/коротких позиций. |
| `AllowBuyClose` / `AllowSellClose` | Разрешение на принудительное закрытие длинных/коротких позиций по противоположному сигналу. |
| `OrderVolume` | Объём рыночных ордеров при открытии позиций. |
| `StopLossPoints` | Необязательный стоп-лосс в шагах цены (0 — без стопа). |
| `TakeProfitPoints` | Необязательный тейк-профит в шагах цены (0 — без тейк-профита). |

## Рекомендации по использованию
- Стратегия работает с единственным инструментом, возвращаемым методом `GetWorkingSecurities()`, и лучше всего подходит для
  инструментов со стабильным профилем объёма.
- Для валютного рынка используйте тиковый объём (`VolumeMode = Tick`). Для бирж с доступом к реальным объёмам переключитесь на
  `VolumeMode = Real`.
- Дистанции стоп-лосса и тейк-профита указываются в шагах цены и автоматически пересчитываются в абсолютное значение через
  `PriceStep` инструмента.
- Если сглаженная гистограмма не меняется, буфер направления сохраняет предыдущий цвет — это полностью соответствует логике
  MetaTrader.
- По умолчанию стратегия выводит на график только свечи. При необходимости можно добавить собственные визуализации
  сглаженной гистограммы.
