# Стратегия Market Watch Panel

## Общее описание
**Market Watch Panel Strategy** — порт скрипта MetaTrader *Market Watch Panel.mq5* на платформу StockSharp. В оригинале пользователь управляет панелью, формирует список наблюдаемых инструментов, сохраняет его в файл и видит постоянно обновляющиеся котировки. Перенос сохраняет функциональные возможности панели в виде серверной стратегии:

- чтение списка инструментов из файла `symbols.txt`;
- подписка на поток Level1 для каждого инструмента списка;
- вывод актуальной цены в лог при каждом обновлении Level1;
- набор публичных методов, повторяющих кнопки панели для добавления, обновления и очистки списка.

Стратегия не исполняет торговых операций и предназначена исключительно для мониторинга рынка и ведения журнала цен.

## Параметры
| Параметр | Назначение |
|----------|------------|
| `SymbolsFileName` | Путь к текстовому файлу со списком инструментов (по одному тикеру на строку). При отсутствии файл создаётся автоматически. |
| `IncludePrimarySecurity` | При включении главный инструмент стратегии всегда наблюдается, но не записывается в файл. |

Оба параметра реализованы через `StrategyParam<T>` и защищены от оптимизации, чтобы их можно было настраивать в интерфейсе StockSharp аналогично параметрам MQL-скрипта.

## Управление во время работы
В скрипте MetaTrader было две кнопки и поле ввода. В стратегии им соответствуют три метода:

- `AddSymbol(string symbolCode)` — добавляет инструмент, подписывается на его Level1 и сразу обновляет `symbols.txt`.
- `ReloadSymbols()` — очищает текущие постоянные записи, перечитывает файл и восстанавливает подписки. Полезно после внешнего редактирования файла.
- `ClearSymbols()` — отменяет подписки по всем постоянным инструментам и обнуляет файл; при активном `IncludePrimarySecurity` главный инструмент продолжает отслеживаться.

При остановке или сбросе стратегии все подписки завершаются автоматически.

## Логика работы
1. **Запуск** — `OnStarted` очищает состояние, загружает `symbols.txt` и создаёт подписки Level1 для каждого инструмента.
2. **Главный инструмент** — при включённом флаге добавляется к наблюдению после загрузки файла, но не сохраняется на диск.
3. **Обновления цен** — каждое сообщение Level1 формирует запись `Market Watch update: <symbol> price=<value>`, имитируя обновление подписей на панели.
4. **Синхронизация файла** — все вспомогательные методы сразу переписывают `symbols.txt`, поддерживая актуальность списка.

## Формат файла
Используется текстовый файл UTF-8, каждая строка содержит идентификатор инструмента. Пустые строки и дубликаты игнорируются. По умолчанию файл размещается в рабочей директории стратегии, но можно указать абсолютный путь.

## Порядок использования
1. Подключите сборку стратегии к StockSharp и назначьте портфель с инструментом по умолчанию.
2. При необходимости измените путь `SymbolsFileName`.
3. Запустите стратегию — она создаст либо загрузит `symbols.txt` и начнёт писать обновления в лог.
4. Управляйте наблюдаемыми инструментами через `AddSymbol`, `ReloadSymbols` и `ClearSymbols` (например, из скриптовой консоли).
5. Следите за журналом, чтобы видеть актуальные цены (last/bid/ask) по каждому инструменту списка.

## Отличия от версии MetaTrader
- Отсутствует графический интерфейс: управление осуществляется параметрами и методами.
- Логика ограничена подписками Level1 и журналированием, без отрисовки меток.
- Цветовые и визуальные настройки из скрипта опущены, поскольку их роль в StockSharp минимальна.

При этом основная идея — поддержание постоянного списка инструментов с оперативным обновлением цен — реализована полностью, что делает стратегию функциональным аналогом оригинальной панели.
