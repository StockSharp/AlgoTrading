# 市场观察面板策略

## 概述
**市场观察面板策略** 是 MetaTrader 脚本 *Market Watch Panel.mq5* 的 StockSharp 版本。原脚本通过自定义面板让交易者可以维护一个符号观察列表、将该列表保存到文本文件并持续刷新价格。本实现重现了这些核心功能：

- 从 `symbols.txt` 文件读取符号列表。
- 为每个符号订阅实时 Level1 数据。
- 在收到 Level1 更新时将最新价格写入日志。
- 提供与面板按钮等效的公共方法，用于添加、重新加载和清空观察列表。

策略不会发送任何交易指令，它只负责监控市场并将最新行情推送到终端日志中。

## 参数
| 参数 | 说明 |
|------|------|
| `SymbolsFileName` | 保存观察列表的文本文件路径，每行一个符号。若文件不存在会自动创建。|
| `IncludePrimarySecurity` | 是否始终监控主策略证券。启用时不会把该证券写回文件。|

参数均通过 `StrategyParam<T>` 定义，并禁止优化，以便在 StockSharp 界面中像 MetaTrader 脚本一样配置。

## 运行控制
原始面板包含两个按钮与一个输入框。策略使用三个公共方法复刻这些交互：

- `AddSymbol(string symbolCode)`：将新符号加入观察列表，订阅其 Level1 数据，并把最新列表写回 `symbols.txt`。
- `ReloadSymbols()`：移除所有持久化条目，重新读取 `symbols.txt` 并恢复订阅。适用于外部编辑文件的场景。
- `ClearSymbols()`：取消所有持久化符号的订阅并清空 `symbols.txt` 文件；若启用主证券选项，它仍会继续监控。

策略在停止或复位时会自动终止所有订阅，避免产生遗留的数据流。

## 数据流程
1. **启动**：`OnStarted` 清理先前状态，加载 `symbols.txt`，并为列表中的每个符号创建 Level1 订阅。
2. **主证券**：当 `IncludePrimarySecurity` 为真时，会在加载文件后附加主证券但不会写回文件。
3. **行情刷新**：每一次 Level1 更新都会记录 `Market Watch update: <symbol> price=<value>`，模拟面板中文字的即时刷新。
4. **持久化**：公共方法会立即同步更新 `symbols.txt`，确保文件与实际观察列表一致。

## 文件格式
观察列表文件是 UTF-8 文本，每行一个符号，空行与重复符号会被自动忽略。默认存放在策略工作目录中，也可以指定绝对路径。

## 使用步骤
1. 将编译后的策略程序集加载到 StockSharp，并设置组合与主证券。
2. 根据需要调整 `SymbolsFileName` 的路径。
3. 启动策略，它会创建或读取 `symbols.txt` 并开始记录价格更新。
4. 通过脚本控制台或自定义界面调用 `AddSymbol`、`ReloadSymbols`、`ClearSymbols` 来管理观察列表。
5. 观察日志以获取每个符号的最新买价、卖价或成交价信息。

## 与 MetaTrader 版本的差异
- 不再提供图形界面，所有交互通过参数与公共方法完成。
- 仅关注 Level1 订阅与日志输出，不再绘制或缓存面板标签。
- 原脚本的颜色和布局选项被省略，遵循 StockSharp 的可视化方式。

尽管界面形式有所改变，策略仍忠实地实现了原脚本的核心逻辑：维护一个可持久化的符号列表并实时更新它们的价格。
