# Стратегия Nirvaman Imax

## Обзор
Стратегия Nirvaman Imax представляет собой конвертацию эксперта MetaTrader 4 `NirvamanImax.mq4` вместе с индикаторами HA, Moving Averages2 и iMAX3alert. Реализация на StockSharp сохраняет первоначальную идею: анализ Heikin-Ashi свечей, определение направления по двум фазам тренда и фильтрация через EMA-базис, дополнительно используя таймер принудительного закрытия позиций.

## Индикаторы и фильтры
- **Свечи Heikin-Ashi** — воссоздают индикатор HA и определяют бычьи/медвежьи тела по соотношению Heikin-открытия и закрытия.
- **Пересечение быстрых/медленных EMA** — замена двух буферов индикатора `iMAX3alert1`. Сигнал на покупку возникает при пересечении быстрой EMA выше медленной, сигнал на продажу — при обратном пересечении.
- **EMA-фильтр тренда** — эквивалент буфера Moving Averages2. Разрешает входить в длинные сделки только выше линии фильтра и в короткие — только ниже неё.
- **Временной фильтр** — пропускает сделки, если час свечи попадает в окно `NoTradeStartHour` – `NoTradeEndHour`. Окно поддерживает переход через полночь и сдвиг часового пояса брокера.
- **Принудительное закрытие по времени** — параметр `CloseAfter` повторяет логику `tiempoCierre` и завершает сделку после превышения максимального времени удержания.
- **Стоп-лосс и тейк-профит** — рассчитываются в шагах цены относительно значения `PriceStep`. Нулевое значение отключает соответствующий уровень.

## Правила торговли
1. Дождаться формирования Heikin-Ashi, быстрой и медленной EMA, EMA-фильтра, а также появления закрытия предыдущей свечи.
2. Пропустить обработку, если текущий час попадает в запретный торговый интервал.
3. Условия для длинной позиции:
   - Быстрая EMA пересекает медленную снизу вверх на текущей свече.
   - Heikin-Ashi закрывается выше открытия (бычий корпус).
   - Закрытие предыдущей свечи находится выше EMA-фильтра.
4. Условия для короткой позиции — зеркальные.
5. Выход из позиции осуществляется, если:
   - Диапазон свечи достигает стоп-лосса или тейк-профита.
   - Время удержания превысило `CloseAfter`.
   - Система защиты (вызов `StartProtection()`) требует закрыть позицию.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TradeVolume` | Базовый объём рыночной заявки. | `0.1` |
| `CandleType` | Таймфрейм, на котором рассчитываются индикаторы. | 30 минут |
| `FastTrendLength` | Длина быстрой EMA (аналог синего буфера iMAX). | `10` |
| `SlowTrendLength` | Длина медленной EMA (аналог красного буфера iMAX). | `21` |
| `FilterLength` | Период EMA-фильтра (аналог Moving Averages2). | `13` |
| `StopLoss` | Дистанция стоп-лосса в шагах цены, `0` — без стопа. | `50` |
| `TakeProfit` | Дистанция тейк-профита в шагах цены, `0` — без тейка. | `100` |
| `CloseAfter` | Максимальное время удержания позиции. | `15000` секунд |
| `NoTradeStartHour` | Начало запретного торгового окна (0–23). | `22` |
| `NoTradeEndHour` | Конец запретного окна (0–23). | `2` |
| `BrokerTimeOffset` | Часовой сдвиг торгового сервера относительно UTC. | `0` |

## Особенности конвертации
- Двухцветный индикатор `iMAX3alert1` заменён пересечением быстрых и медленных EMA, что позволяет сохранить событийный характер сигналов.
- Индикатор Moving Averages2 использовался в режиме EMA с периодом 13 — в стратегии применяется стандартная `ExponentialMovingAverage` с тем же периодом.
- Логика сопровождения сделок соответствует исходному коду: позиция закрывается по таймауту до оценки новых сигналов, дополнительные трейлинг-стопы не добавлялись.

## Рекомендации по использованию
1. Перед запуском выберите нужный инструмент и таймфрейм (`CandleType`).
2. Настройте `TradeVolume`, `StopLoss`, `TakeProfit` и `CloseAfter` под волатильность инструмента и допустимый риск.
3. Для адаптации под другие рынки оптимизируйте периоды EMA (`FastTrendLength`/`SlowTrendLength`).
4. При одновременном запуске нескольких стратегий используйте надстройки риск-менеджмента портфеля.
