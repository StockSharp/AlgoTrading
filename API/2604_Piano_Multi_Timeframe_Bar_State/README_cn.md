# Piano 多周期K线状态策略

## 概述
该策略复刻了 Vladimir Karputov 编写的 **Piano.mq5** 指标逻辑。与在 MetaTrader 中绘制画布不同，此移植版本会监控同一品种在 21 个不同周期上的最新已完成K线，判断其多头或空头状态，并把结果组合成三行文本：当前K线、上一根K线和上上一根K线。这些字符串会通过公共属性公开，同时在任一周期生成新K线时写入策略日志。

策略本身不包含任何交易行为，可作为监控组件，为设计器或运行器提供多周期同步市场情绪参考。

## 与 MQL 版本的差异
| 项目 | MQL5 实现 | StockSharp 移植 |
| --- | --- | --- |
| 可视化 | 自定义 Canvas 标签 | 通过属性和日志输出文本 |
| 周期集合 | M1…MN1（21 个） | 使用相同周期的 `TimeSpan` 订阅 |
| 状态编码 | `1` 多头、`0` 空头、`-` 持平 | 完全一致 |
| 数据来源 | 每个周期调用 `CopyRates` | 每个周期调用 `SubscribeCandles` |
| 交易 | 纯指标，无订单 | 监控策略，无订单 |

## 实现细节
1. **数据订阅**：在 `TimeFrames` 数组中定义了 21 个周期，`SubscribeCandles` 会为每个周期创建订阅，通过高阶 API 把完成的K线发送到统一的处理方法。
2. **K线分类**：`DetermineStatus` 比较开盘价与收盘价，返回 `1`、`0` 或 `-`。当历史数据不足时会返回 `-`，与原指标在无数据时的表现一致。
3. **滚动缓冲**：每个周期持有一个小型 `PianoBuffer`（基于数组的循环缓冲），保存可配置数量的最新状态，默认保留三根K线。
4. **字符串聚合**：`UpdateLines` 遍历所有缓冲并生成三行字符串，格式与原脚本的 `text1`、`text2`、`text3` 相同，均以 `*` 作为分隔符。
5. **输出**：`LatestCurrentBarLine`、`LatestPreviousBarLine`、`LatestSecondPreviousBarLine` 属性提供三行文本，日志会指明是哪个周期触发了更新。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `BarsToTrack` | `int` | `3` | 每个周期需要保存的已完成K线数量，控制缓冲区长度以及输出字符串的字符数。优化区间设置为 1–5，步长 1。 |

## 输出内容
- **LatestCurrentBarLine**：表示各周期最新已完成K线的 `*X` 序列。
- **LatestPreviousBarLine**：表示上一根K线的 `*X` 序列。
- **LatestSecondPreviousBarLine**：默认表示第三行（最早保留的那根K线）。
- **日志**：每当收到新K线时会打印 `"[H1] Piano states updated..."`，方便实时监控。

## 使用建议
1. 将策略附加到目标品种，并确保全部周期的历史数据可用。在获取足够数据之前，输出会以 `-` 占位。
2. 通过属性或日志观察不同周期的状态是否一致，可用于构建自定义仪表盘。
3. 根据需求调整 `BarsToTrack`，扩大该值即可延长历史窗口。
4. 策略不会发送订单，可与其他交易策略同时运行，仅提供市场背景信息。

## 注意事项
- 周线与月线分别使用 `TimeSpan.FromDays(7)` 与 `TimeSpan.FromDays(30)` 订阅，符合大部分 StockSharp 示例的处理方式。
- 如果某个周期无法提供K线，则输出中会保持 `-` 作为占位符。
- 开发者可以将字符串属性传递给自定义 UI，扩展可视化能力。

