# Стратегия Piano Multi Timeframe Bar State

## Общее описание
Стратегия переносит идею индикатора **Piano.mq5**, созданного Владимиром Карпутовым. Вместо отрисовки панели Canvas в MetaTrader она отслеживает направление последней завершённой свечи по двадцати одному таймфрейму одного инструмента. Полученные состояния объединяются в три строки: текущая свеча, предыдущая и предпредыдущая. Каждая строка публикуется через публичные свойства и записывается в журнал стратегии при поступлении новой завершённой свечи.

Торговых операций стратегия не выполняет и может использоваться как вспомогательный монитор для Designer, Runner или других приложений StockSharp.

## Сопоставление с MQL-версией
| Компонент | MQL5 | StockSharp |
| --- | --- | --- |
| Отображение | Canvas-метка на графике | Строки в свойствах и логах |
| Таймфреймы | Массив M1…MN1 (21 шт.) | Подписки `TimeSpan` на тот же набор |
| Кодирование свечи | `1` бычья, `0` медвежья, `-` равенство | Аналогично |
| Источник данных | `CopyRates` | `SubscribeCandles` |
| Торговля | Нет заявок | Нет заявок |

## Детали реализации
1. **Подписки** – метод `SubscribeCandles` вызывается для каждого элемента массива `TimeFrames`. Готовые свечи доставляются в обработчик через высокоуровневый API.
2. **Оценка свечей** – метод `DetermineStatus` сравнивает цену открытия и закрытия и возвращает `1`, `0` или `-`. При отсутствии истории заполняется `-`, как и в оригинальном индикаторе.
3. **Буфер состояний** – для каждого таймфрейма создаётся компактный `PianoBuffer`, который хранит заданное число последних состояний (по умолчанию три).
4. **Формирование строк** – метод `UpdateLines` проходит по буферам и собирает три строки, полностью повторяющие формат `text1`, `text2`, `text3` из MQL (разделитель `*`).
5. **Доступ к данным** – свойства `LatestCurrentBarLine`, `LatestPreviousBarLine`, `LatestSecondPreviousBarLine` и сообщения журнала позволяют оперативно контролировать изменения.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `BarsToTrack` | `int` | `3` | Сколько завершённых свечей хранить для каждого таймфрейма. Параметр регулирует размер буфера и длину выходных строк. Границы оптимизации: 1–5 с шагом 1. |

## Выходные данные
- **LatestCurrentBarLine** – последовательность `*X`, описывающая последнюю завершённую свечу на всех таймфреймах (`X` ∈ {`1`, `0`, `-`}).
- **LatestPreviousBarLine** – аналогичная строка для предыдущей свечи.
- **LatestSecondPreviousBarLine** – строка для самой старой свечи, которая хранится в буфере (третья строка при настройке по умолчанию).
- **Журнал** – при каждой обработке свечи появляется запись вида `"[H4] Piano states updated..."`, что помогает быстро определить источник изменения.

## Рекомендации по использованию
1. Подключите стратегию к нужному инструменту и убедитесь, что исторические данные доступны для всех таймфреймов. Пока буферы не заполнены, в строках отображаются символы `-`.
2. Используйте публичные свойства или журнал для визуального контроля синхронизации разных таймфреймов. Формат удобно интегрировать в пользовательские панели.
3. Увеличивайте параметр `BarsToTrack`, если требуется анализировать более длинную историю. Логика обработки остаётся прежней.
4. Стратегию можно запускать параллельно с торговыми алгоритмами — она не регистрирует заявки и лишь предоставляет контекст.

## Примечания
- Для недельных и месячных данных применяются подписки `TimeSpan.FromDays(7)` и `TimeSpan.FromDays(30)`, что соответствует распространённой практике в примерах StockSharp.
- Если какая-либо подписка недоступна, в соответствующей позиции остаётся символ `-`.
- При необходимости строки можно отправлять в собственные визуальные компоненты или внешние сервисы мониторинга.

