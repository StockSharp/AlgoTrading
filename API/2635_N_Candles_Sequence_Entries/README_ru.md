# Стратегия N Candles

## Концепция
Стратегия N Candles отслеживает последовательности свечей, которые закрываются в одном направлении. Когда формируется заданное количество подряд идущих бычьих или медвежьих свечей, стратегия открывает позицию по направлению импульса. Реализация является адаптацией советника MetaTrader «N Candles v4» и сохраняет его параметры управления рисками, настройку в пунктах и алгоритм трейлинг-стопа, перенесённый на высокоуровневый API StockSharp.

## Условия входа
- Анализ выполняется только по завершённым свечам.
- Свечи с закрытием выше открытия считаются бычьими, ниже открытия — медвежьими, а дожи обнуляют счётчик последовательности.
- При появлении `ConsecutiveCandles` свечей подряд стратегия отправляет рыночную заявку в сторону движения.
- В зависимости от параметра `AccountingMode` используются ограничения по суммарному объёму (неттинг) или по количеству позиций в каждом направлении (хеджинг).

## Управление выходом
- Параметры `StopLossPips` и `TakeProfitPips` задают фиксированные уровни выхода в пунктах относительно средней цены входа.
- Если `TrailingStopPips` больше нуля, активируется трейлинг-стоп:
  - При отсутствии фиксированного стоп-лосса (например, когда `StopLossPips` равен нулю) стоп переводится в безубыток, когда цена проходит `TrailingStopPips` пунктов в прибыль.
  - После появления стоп-лосса он смещается вслед за ценой, как только разница между ценой и стопом превышает `TrailingStopPips + TrailingStepPips`.
- Расчёт защитных уровней выполняется при каждом изменении позиции; на каждой свече проверяется, достигнут ли стоп или тейк-профит, и при срабатывании позиция немедленно закрывается.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `ConsecutiveCandles` | Количество одинаковых свечей для сигнала. | 3 |
| `TakeProfitPips` | Размер тейк-профита в пунктах (0 — отключить). | 50 |
| `StopLossPips` | Размер стоп-лосса в пунктах (0 — отключить). | 50 |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах (0 — отключить). | 10 |
| `TrailingStepPips` | Дополнительное смещение для переноса трейлинг-стопа. | 4 |
| `MaxPositionsPerDirection` | Максимум входов в одном направлении при хеджинге. | 2 |
| `MaxNetVolume` | Максимальный суммарный объём позиции при неттинге. | 2 |
| `AccountingMode` | Режим учёта: `Netting` или `Hedging`. | Netting |
| `CandleType` | Тип свечей для анализа. | 1-минутные свечи |

Параметры, заданные в пунктах, преобразуются в ценовые величины на основе шага цены инструмента. Для инструментов с 3 или 5 знаками после запятой размер пункта умножается на 10, как в оригинальном советнике.

## Особенности реализации
- Используется высокоуровневая подписка на свечи (`SubscribeCandles`), что избавляет от ручного хранения истории.
- Для имитации поведения оригинального трейлинг-стопа стратегия отслеживает максимальную (для лонгов) или минимальную (для шортов) цену после входа.
- Лимиты по позициям автоматически масштабируются вместе с базовым объёмом стратегии (`Volume`).
- При закрытии позиции по стопу или тейк-профиту в лог выводится соответствующее сообщение, что упрощает анализ тестов.

## Рекомендации по использованию
- Выбирайте режим `Hedging`, если требуется моделировать площадку с независимыми позициями по каждому направлению; режим `Netting` соответствует единой неттинговой позиции.
- Установите `TrailingStepPips` в ноль, чтобы трейлинг-стоп сдвигался при каждом продвижении цены на `TrailingStopPips` пунктов.
- Если важно реагировать на внутрибарные колебания, используйте более мелкий таймфрейм свечей.
