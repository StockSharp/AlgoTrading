# Trade on Qualified RSI 策略

## 概述
该策略将 MetaTrader 的 "Trade on qualified RSI" 专家顾问迁移到 StockSharp 高级 API。它是一种逆势策略：当 RSI 长时间停留在极端区域时，算法将其视为动能耗尽的信号，并在获得多根蜡烛确认后，向相反方向开仓。止损按价格最小变动单位（PriceStep）进行跟踪，只在价格向有利方向移动时上调或下调。

## 信号逻辑
### 指标
* 可配置周期的相对强弱指标（RSI），默认长度为 28。
* 基于所选蜡烛序列计算，默认使用 15 分钟蜡烛。

### 做空条件
1. 最近一根已收盘的蜡烛 RSI 大于或等于上限阈值（默认 55）。
2. 在此之前的 `CountBars` 根蜡烛 RSI 也全部高于该阈值。策略内部维护一个连续计数器，当计数达到 `CountBars + 1` 时触发信号。
3. 当前没有持仓。满足条件后，以设定的交易量市价卖出，并将收盘价记录为入场价。

### 做多条件
1. 最近一根已收盘的蜡烛 RSI 小于或等于下限阈值（默认 45）。
2. 在此之前的 `CountBars` 根蜡烛 RSI 也全部低于该阈值（同样需要连续 `CountBars + 1` 根满足条件）。
3. 当前没有持仓。满足条件后，以设定的交易量市价买入，并记录收盘价。

## 仓位管理
* **初始止损：** 开仓后立即将止损设置在距离入场价 `StopLossPoints` 个价格步长的位置（多头在入场价下方，空头在上方）。价格步长来自 `Security.PriceStep`，若未定义则回退为 `1`。
* **跟踪止损：** 每根收盘蜡烛都会尝试收紧止损。多头仓位的新止损为 `收盘价 - StopLossPoints * PriceStep`（前提是该值高于当前止损）；空头仓位的新止损为 `收盘价 + StopLossPoints * PriceStep`（前提是该值低于当前止损）。
* **离场：** 当多头蜡烛最低价跌破止损，或空头蜡烛最高价突破止损时，策略以市价平掉全部仓位。没有额外的止盈目标或反向信号，只有在前一笔仓位关闭后才会出现新的入场。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `RsiPeriod` | RSI 指标的计算周期。 | 28 |
| `UpperThreshold` | 触发做空信号的 RSI 阈值。 | 55 |
| `LowerThreshold` | 触发做多信号的 RSI 阈值。 | 45 |
| `CountBars` | 需要连续保持在阈值外侧的历史蜡烛数量（总计 `CountBars + 1` 根）。 | 5 |
| `StopLossPoints` | 止损距离（以价格步长计），实际价格偏移量为 `StopLossPoints * PriceStep`。 | 21 |
| `TradeVolume` | 每次入场使用的交易量。 | 1 |
| `CandleType` | 用于计算的蜡烛类型。 | 15 分钟蜡烛 |

所有参数均支持优化。阈值采用十进制，可以精细调整 RSI 边界以适应不同市场。

## 实现细节
* 通过 `SubscribeCandles(...).Bind(...)` 订阅蜡烛数据并驱动 RSI，只在蜡烛完全收盘后触发逻辑。
* 不通过索引读取 RSI 历史值，而是使用连续计数器来验证阈值条件。
* 止损在策略内部模拟，当价格突破止损时发送市价单平仓，无需额外挂单。
* 入场和出场都会写入日志，方便监控运行状态，并贴近原始专家顾问的详细输出。

## 使用建议
1. 将策略添加到 StockSharp 应用中，选择交易品种和投资组合，并配置所需的蜡烛序列。
2. 根据标的波动性调整 RSI 阈值、确认蜡烛数量以及止损步长。
3. 启动策略，观察日志了解信号触发和止损移动情况。
4. 如需进一步优化，可使用 StockSharp 优化器搜索不同参数组合。
