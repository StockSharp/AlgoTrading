# Стратегия «Trade on Qualified RSI»

## Описание
Данная реализация переносит эксперт "Trade on qualified RSI" из MetaTrader в инфраструктуру StockSharp. Алгоритм относится к контртрендовым: он ищет затяжные экстремальные значения индикатора RSI и открывает позицию против направления импульса после подтверждения несколькими свечами. Управление риском выполняется с помощью плавающего стоп-лосса, выраженного в шагах цены инструмента.

## Логика сигналов
### Индикатор
* Индекс относительной силы (RSI) с настраиваемым периодом расчёта (по умолчанию 28).
* Расчёт выполняется по выбранным свечам (по умолчанию 15-минутные свечи).

### Условия для короткой позиции
1. Последняя закрытая свеча имеет значение RSI выше либо равно верхнему порогу (по умолчанию 55).
2. Каждая из предыдущих `CountBars` свечей также находилась выше этого порога. Внутри стратегии ведётся счётчик последовательных свечей; сигнал формируется, когда счётчик достигает `CountBars + 1`.
3. Открытых позиций нет. При выполнении условий отправляется рыночная заявка на продажу с заданным объёмом, а цена закрытия свечи запоминается как цена входа.

### Условия для длинной позиции
1. Последняя закрытая свеча имеет значение RSI ниже либо равно нижнему порогу (по умолчанию 45).
2. Каждая из предыдущих `CountBars` свечей также находилась ниже этого порога (всего требуется `CountBars + 1` последовательных наблюдений).
3. Позиция отсутствует. Стратегия отправляет рыночную заявку на покупку и сохраняет цену закрытия как цену входа.

## Управление позицией
* **Начальный стоп:** сразу после открытия рассчитывается уровень стоп-лосса на расстоянии `StopLossPoints` шагов цены от цены входа (ниже для лонга, выше для шорта). Шаг цены берётся из `Security.PriceStep`; при его отсутствии используется значение `1`.
* **Трейлинг:** на каждой закрытой свече стоп подтягивается к цене закрытия. Для длинной позиции новый стоп равен `Close - StopLossPoints * PriceStep`, если это значение выше текущего стопа. Для короткой позиции новый стоп равен `Close + StopLossPoints * PriceStep`, если это значение ниже текущего стопа.
* **Выход:** если минимум свечи опускается ниже стопа в лонге либо максимум поднимается выше стопа в шорте, стратегия полностью закрывает позицию рыночной заявкой. Дополнительных целей по прибыли и разворотов нет; новые входы возможны только после закрытия предыдущей позиции.

## Параметры
| Имя | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `RsiPeriod` | Период расчёта индикатора RSI. | 28 |
| `UpperThreshold` | Порог RSI для квалификации шорт-сигнала. | 55 |
| `LowerThreshold` | Порог RSI для квалификации лонг-сигнала. | 45 |
| `CountBars` | Количество предыдущих свечей, которые должны удерживаться за порогом (`CountBars + 1` последовательных свечей). | 5 |
| `StopLossPoints` | Расстояние до стоп-лосса в шагах цены (`StopLossPoints * PriceStep`). | 21 |
| `TradeVolume` | Объём рыночной заявки при входе. | 1 |
| `CandleType` | Тип свечей, используемых для анализа. | 15-минутные свечи |

Все параметры допускают оптимизацию. Пороговые значения задаются в десятичных числах, что позволяет тонко настроить границы RSI под конкретный инструмент.

## Особенности реализации
* Используется высокоуровневый API: подписка на свечи с помощью `SubscribeCandles(...).Bind(...)`, что гарантирует работу только с полностью сформированными свечами.
* Значения RSI не запрашиваются по индексу — вместо этого применяется счётчик последовательных свечей, удовлетворяющих условиям.
* Стоп-лоссы моделируются внутри стратегии: при срабатывании условия закрытия отправляется рыночная заявка, что упрощает переносимость.
* В журнал выводятся сообщения о сделках, что облегчает контроль работы и повторяет подробный лог оригинального эксперта.

## Использование
1. Добавьте стратегию в приложение StockSharp, назначьте инструмент и портфель, настройте источник свечей.
2. При необходимости измените пороговые значения RSI, количество подтверждающих свечей и размер шага стоп-лосса, чтобы адаптировать стратегию к волатильности инструмента.
3. Запустите стратегию и наблюдайте за журналом, чтобы оценить моменты входа и траекторию подтягивания стопа.
4. Для подбора оптимальных параметров воспользуйтесь модулем оптимизации StockSharp.
