# Стратегия Colibri Grid Manager

## Обзор
Colibri Grid Manager — это перенос советника MetaTrader 4 `Colibri.mq4` (каталог `MQL/9713`) в экосистему StockSharp. Стратегия рассчитана на полуавтоматическую работу с сеткой заявок: формирует уровни по требованию, рассчитывает объём исходя из заданного риска, выставляет защитные стопы/тейк-профиты и блокирует дальнейшую торговлю при превышении дневного лимита убытков.

## Логика работы
1. При запуске стратегия подписывается на выбранные свечи и стакан, сбрасывает предыдущие заявки и фиксирует стартовые показатели прибыли/убытка на текущий день.
2. Если `EnableGrid` включён и отсутствуют позиции либо активные сеточные заявки, формируется новая сетка по разрешённым направлениям (`AllowBuy`, `AllowSell`). Уровни можно расставить симметрично относительно центра (`CenterPrice`) либо отталкиваться от отдельных точек входа для покупок/продаж.
3. Параметр `OrderType` определяет тип входа (лимитный, стоповый или рыночный). Расстояние между уровнями задаётся в пунктах (`LevelSpacingPoints`) и переводится в абсолютное значение через `PriceStep` инструмента.
4. Объём каждой заявки можно зафиксировать (`FixedOrderVolume`) либо рассчитать по доле риска (`RiskPercent`). В риск-режиме доля капитала делится на количество уровней по данному направлению и нормируется на денежный риск, связанный с защитным стопом.
5. После исполнения входящей заявки стратегия автоматически выставляет пару защитных ордеров. Стоп-цена берётся из `StopLossPrice` либо рассчитывается по `StopDistancePoints`, тейк-профит — из `TakeProfitDistancePoints` или по умолчанию равен одному шагу сетки. Заявки могут иметь срок действия `ExpirationHours`.
6. Реализован постоянный контроль суммарного (реализованного + плавающего) PnL. Если дневной убыток превышает `DailyLossLimitPercent`, все заявки отменяются, позиции закрываются, а построение новой сетки блокируется до начала следующего дня.
7. Ручные флаги (`CloseAllPositions`, `CloseLongPositions`, `CloseShortPositions`, `CancelOrders`) позволяют мгновенно закрыть позиции или очистить книгу заявок без правок кода.

## Параметры
- **EnableGrid** — главный переключатель автоматического сопровождения сетки.
- **OrderType** — тип заявок для уровней (`Limit`, `Stop`, `Market`).
- **AllowBuy / AllowSell** — разрешённые направления торговли.
- **UseCenterLine / CenterPrice** — распределение уровней симметрично вокруг центральной цены; при нуле используется средняя цена.
- **LevelSpacingPoints** — интервал между уровнями в пунктах, пересчитывается в абсолютные цены.
- **LevelsCount** — количество уровней на направление (для рыночного входа фактически используется одно срабатывание).
- **BuyEntryPrice / SellEntryPrice** — опорные цены входа для длинной/короткой сетки при отключённом центрировании (ноль — текущие bid/ask).
- **StopLossPrice** — абсолютный уровень стоп-лосса, применяемый ко всем ордерам. Ноль означает использование `StopDistancePoints`.
- **StopDistancePoints** — расстояние до стопа в пунктах, если абсолютная цена не задана.
- **TakeProfitDistancePoints** — расстояние до тейк-профита в пунктах; при нуле равняется одному шагу сетки.
- **UseRiskSizing / RiskPercent** — включение расчёта объёма по проценту капитала и величина этого процента. Значение распределяется поровну между уровнями одного направления.
- **FixedOrderVolume** — объём по умолчанию, если риск-расчёт отключён или невозможен.
- **ExpirationHours** — срок жизни отложенных заявок (в часах).
- **DailyLossLimitPercent** — дневной лимит убытков в долях от капитала.
- **CloseAllPositions / CloseLongPositions / CloseShortPositions / CancelOrders** — ручные команды для оперативного управления позицией и заявками.
- **CandleType** — таймфрейм свечей, используемых для служебных проверок и дневного сброса.

## Особенности реализации
- Используются только высокоуровневые методы StockSharp (`SubscribeCandles`, `SubscribeOrderBook`, `BuyLimit`, `SellStop` и т. д.), что упрощает интеграцию.
- При расчёте объёма учитываются `PriceStep` и `StepPrice`, благодаря чему точная конвертация пунктов в денежный риск соответствует оригинальной логике MT4.
- Защитные ордера регистрируются отдельно от входящих заявок, что согласуется с моделью связанных ордеров в StockSharp.
- Лимит дневных потерь сбрасывается при смене календарного дня; при необходимости можно вручную возобновить работу, переключив `EnableGrid`.
- MT4-глобальные переменные, сложные сценарии аварийного закрытия и очистки графических объектов заменены типизированными параметрами и понятными ручными флагами.

## Рекомендации по использованию
1. До запуска определите тип сетки: симметричную относительно центра или от конкретных точек входа, и заполните соответствующие параметры.
2. Подбирайте значения `LevelSpacingPoints`, `StopDistancePoints` и `TakeProfitDistancePoints` исходя из волатильности инструмента (все значения задаются в пунктах).
3. При использовании риск-менеджмента убедитесь, что для инструмента корректно настроены `PriceStep` и `StepPrice`.
4. Для оперативных изменений конфигурации сначала воспользуйтесь ручными командами отмены/закрытия, затем меняйте параметры.
5. Сочетайте внутренний дневной лимит с внешними системами управления риском, если один счёт используется несколькими стратегиями.

## Отличия от оригинального советника
- Вместо MT4-глобальных переменных и «магических» комментариев используются понятные параметры и ручные переключатели.
- Сложная логика аварийного закрытия, автонастройки количества уровней и удаления графических объектов упрощена и сведена к управляемым настройкам.
- Функции трейлинг-стопа из MQL не перенесены; при необходимости можно комбинировать стратегию с готовыми trailing-модулями StockSharp.
- Схема зависимостей «мать-дочь» между ордерами не реализована: каждый уровень работает автономно со своими защитными заявками.

Таким образом, реализованная стратегия сохраняет ключевые идеи Colibri — поэтапный вход и строгий контроль риска — но в более прозрачной и типовой для StockSharp форме.
