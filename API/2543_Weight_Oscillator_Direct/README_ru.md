# Стратегия Weight Oscillator Direct

## Общая идея
Стратегия переносит эксперта MetaTrader **Exp_WeightOscillator_Direct** на высокоуровневый API StockSharp. Она объединяет четыре классических осциллятора (RSI, Money Flow Index, Williams %R и DeMarker) в единый взвешенный показатель, сглаженный выбранной скользящей средней. В режиме «Direct» стратегия следует за наклоном результирующего осциллятора, а в режиме «Against» работает как контртрендовая, открывая противоположные сделки.

## Цепочка индикаторов
1. **RSI** – нормализован к диапазону 0..100.
2. **MFI** – оценивает денежные потоки в том же диапазоне 0..100.
3. **Williams %R** – смещён на +100, чтобы привести значения к положительной шкале.
4. **DeMarker** – умножается на 100 для согласования с остальными источниками.
5. **Сглаживание** – одна из доступных скользящих средних: Simple, Exponential, Smoothed (RMA), Weighted, Jurik, Kaufman.
6. **Композитный осциллятор** – взвешенное среднее нормализованных значений, прошедшее дополнительное сглаживание.

Значение композитного осциллятора фиксируется на каждой завершённой свече. Параметр *Signal Bar* позволяет, как и в оригинальном советнике, пропустить несколько последних баров при вычислении сигналов.

## Логика торговли
1. Дождаться формирования всех индикаторов и сглаживающей средней.
2. Рассчитать сглаженный композитный осциллятор на текущей завершённой свече и сохранить его в историю.
3. Взять три исторических значения `current`, `previous`, `prior`, отстоящих на `Signal Bar`, `Signal Bar + 1` и `Signal Bar + 2` баров назад.
4. Найти изменение наклона:
   - **Рост**: `previous < prior` и одновременно `current > previous`.
   - **Падение**: `previous > prior` и `current < previous`.
5. В режиме **Direct** рост генерирует сигнал на покупку, падение – на продажу. В режиме **Against** сигналы инвертируются.
6. Выполнить соответствующие действия:
   - Закрыть противоположные позиции, если разрешены переключатели *Close Shorts/Longs on Signal*.
   - Открыть новую позицию, если включены *Allow Long/Short Entries*. Объём заявки равен `Volume + |Position|`, что позволяет моментально переворачиваться.
7. Параметры *Stop Loss Points* и *Take Profit Points* активируют защиту через `StartProtection`, расстояния задаются в шагах цены инструмента.

## Параметры
| Группа | Название | Описание |
|--------|----------|----------|
| General | **Candle Type** | Таймфрейм свечей для расчёта индикаторов. |
| Trading | **Trend Mode** | `Direct` – следование наклону, `Against` – контртренд. |
| Trading | **Signal Bar** | Количество закрытых баров, которые нужно пропустить (1 = последний закрытый бар). |
| Oscillator | **RSI / MFI / WPR / DeMarker Weight** | Вес каждого осциллятора во взвешенном среднем. Ноль отключает компонент. |
| Oscillator | **RSI / MFI / WPR / DeMarker Period** | Периоды расчёта соответствующих осцилляторов. |
| Oscillator | **Smoothing Method** | Тип сглаживания (Simple, Exponential, Smoothed, Weighted, Jurik, Kaufman). |
| Oscillator | **Smoothing Length** | Период сглаживающей средней. |
| Risk Management | **Stop Loss Points** | Стоп-лосс в шагах цены; `0` отключает. |
| Risk Management | **Take Profit Points** | Тейк-профит в шагах цены; `0` отключает. |
| Trading | **Allow Long/Short Entries** | Разрешить открытие длинных/коротких позиций. |
| Trading | **Close Shorts/Longs on Signal** | Разрешить закрытие текущей позиции при противоположном сигнале. |

Все параметры оформлены через `StrategyParam`, поэтому доступны для оптимизации в Designer.

## Особенности использования
- Перед запуском задайте свойство `Volume`. При перевороте позиции заявка увеличивается на величину текущего объёма, чтобы закрыть старую и открыть новую позицию одной сделкой.
- Стратегия подписывается только на один поток свечей, возвращаемый `GetWorkingSecurities()`.
- Защитные стопы пересчитываются из шагов цены (`PriceStep`) в абсолютные уровни.
- Режим `Against` меняет только направление сигналов, а остальная логика полностью совпадает с оригиналом.
- Williams %R и DeMarker нормализуются к диапазону 0..100, как и в MQL-версии.

## Отличия от MQL-советника
- В оригинале присутствовали дополнительные методы сглаживания (`ParMA`, `JurX`, `VIDYA`, `T3`). В StockSharp реализованы надёжные аналоги (Jurik и Kaufman), по умолчанию используется Jurik.
- Money Flow Index всегда использует объём свечи. В MetaTrader можно выбирать тип объёма, здесь всё зависит от поставщика данных.
- Управление рисками выполняется через `StartProtection`, что удобнее в экосистеме StockSharp и обеспечивает сопоставимое поведение при корректном `PriceStep`.

## Быстрый старт
1. Подключите стратегию к нужному портфелю и инструменту.
2. Настройте веса, периоды и переключатели входов/выходов.
3. Выберите тип и длину сглаживания под волатильность инструмента.
4. Укажите защитные стопы и тейк-профиты (при необходимости).
5. Запустите стратегию – сигналы будут срабатывать только на завершённых свечах, что делает поведение детерминированным.
