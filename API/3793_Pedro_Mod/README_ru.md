# Стратегия Pedro Mod

## Обзор

Стратегия представляет собой портирование MetaTrader 4 советника **Pedroxxmod** в экосистему StockSharp. Исходный робот ждёт,
когда цена отклонится от опорного уровня на заданное число пунктов, и открывает встречную позицию. При возврате цены на указанную
дистанцию он добавляет новые сделки в ту же сторону. В StockSharp сохранена эта логика, а параметры вынесены в типизированный
интерфейс `Strategy` для удобства оптимизации и бэктестинга.

## Логика торговли

1. Подписаться на лучшую котировку Level1 и кэшировать текущие значения бид/аск.
2. При отсутствии позиций сохранить текущий аск в качестве опорной цены. Торговля разрешена только между `StartHour` и
   `EndHour`, а также начиная с календарного года `StartYear`.
3. Если аск поднимается выше опорного уровня на `Gap` пунктов MetaTrader, отправляется рыночная продажа. Если опускается ниже на
   `Gap` пунктов — отправляется рыночная покупка. Для сделок автоматически выставляются стоп и тейк через `SetStopLoss` и
   `SetTakeProfit` с теми же расстояниями, что и в советнике.
4. После выбора направления стратегия ведёт FIFO-список виртуальных сделок, имитируя хеджирующие счета MT4. Пока число сделок в
   корзине меньше `MaxTrades`, добавление в позицию происходит при возврате аска к последней цене входа внутри диапазона
   `ReEntryGap` пунктов.
5. Управление объёмом может опираться на фиксированное значение `Lots` либо на правило money management `floor(Equity / 20000)`
   с ограничением сверху `MaxLots`. Перед регистрацией ордеров объём нормализуется по `VolumeStep`, `MinVolume` и `MaxVolume` инструмента.
6. Во время простоя (вне торгового окна) опорные уровни сбрасываются, чтобы при следующем сеансе не возникли ложные сигналы.

## Параметры

| Имя | Описание |
|-----|----------|
| `Lots` | Фиксированный объём, если отключено динамическое управление. |
| `StopLoss` | Расстояние до защитного стопа в пунктах MetaTrader (`0` отключает стоп). |
| `TakeProfit` | Расстояние до тейк-профита в пунктах (`0` отключает тейк). |
| `Gap` | Отклонение от опорной цены, необходимое для открытия первой сделки. |
| `MaxTrades` | Максимальное число одновременно открытых сделок (размер корзины). |
| `ReEntryGap` | Возврат цены в пунктах, при котором добавляются новые сделки в корзину. |
| `MoneyManagement` | Включает формулу `floor(Equity / 20000)` для расчёта объёма. |
| `MaxLots` | Верхний предел для динамически рассчитанного объёма. |
| `StartHour` / `EndHour` | Временные границы торговли по серверному времени (включительно). |
| `StartYear` | Минимальный год, начиная с которого разрешено торговать. |

## Примечания

- Стратегия использует только поток Level1 и не подписывается на свечи, поэтому реагирует на котировки так же оперативно, как
  обработчик `start()` в MT4.
- Стопы и тейки вычисляются стандартными методами `Strategy`, что требует корректных торговых параметров инструмента (`PriceStep`,
  `StepPrice`, `VolumeStep`).
- FIFO-учёт виртуальных сделок позволяет воспроизвести поведение хеджирующих счетов, несмотря на то, что StockSharp хранит
  агрегированную позицию. Частичное закрытие и срабатывание защитных ордеров обрабатывается в `OnPositionChanged`.
- Python-версия намеренно не создаётся во исполнение требований репозитория.
