# Стратегия Night Flat Trade
[English](README.md) | [中文](README_cn.md)

Стратегия Night Flat Trade повторяет оригинальный советник MQL5, который отслеживает узкие ночные диапазоны по EURUSD на часовом таймфрейме. Она концентрируется на периоде вокруг смены торгового дня: ожидает возврата цены к границам диапазона и пытается присоединиться к прорыву. В реализации для StockSharp используется высокоуровневое API: подписка на свечи, индикаторы Highest/Lowest и параметры `StrategyParam<T>` для удобного тестирования и оптимизации.

## Краткое описание

- **Рынок и таймфрейм**: изначально EURUSD, H1. Можно применять к другим инструментам с корректно заданным шагом цены.
- **Торговое окно**: сигналы разрешены только в течение двух часов — с `OpenHour` по `OpenHour + 1` (по времени биржи).
- **Фильтр по диапазону**: разница между максимумом и минимумом последних трёх свечей должна находиться между `DiffMinPips` и `DiffMaxPips` (значения пересчитываются в цену по шагу инструмента).
- **Направление сделки**: определяется положением закрытия внутри диапазона — в нижней четверти ищутся покупки, в верхней четверти продажи.

## Логика работы

1. **Определение диапазона**
   - Подписка на индикаторы `Highest` и `Lowest` с длиной 3 предоставляет максимум и минимум по трём последним свечам.
   - Полученный размах используется для проверки условий входа и расчёта защитных уровней.

2. **Условия входа**
   - **Покупка**: во время разрешённого окна закрытие находится выше минимума, но не выходит за пределы нижней четверти диапазона. Стоп выставляется на уровне `lowest - range/3`.
   - **Продажа**: симметрично, закрытие ниже максимума и внутри верхней четверти. Стоп задаётся как `highest + range/3`.

3. **Сопровождение позиции**
   - **Стоп-лосс**: уровень хранится во внутренней переменной, при пробое следующей свечой выполняется рыночный выход.
   - **Тейк-профит**: при `TakeProfitPips > 0` рассчитывается фиксированная цель в пунктах от цены входа.
   - **Трейлинг**: при положительных `TrailingStopPips` и `TrailingStepPips` стоп подтягивается только после движения в пользу позиции на `TrailingStop + TrailingStep` пунктов. Далее для каждого обновления требуется дополнительный прирост на величину `TrailingStepPips`, что повторяет ступенчатый алгоритм из MQ5.

4. **Повторные входы**
   - Пока активна позиция, стратегия не ищет новых сигналов, сохраняя режим «одна сделка — одно направление» как в исходном советнике.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Тип свечей для расчётов (по умолчанию H1). | Часовые свечи |
| `TakeProfitPips` | Дистанция до тейк-профита в пунктах (0 — без цели). | 50 |
| `TrailingStopPips` | Базовое плечо трейлинг-стопа в пунктах (0 отключает трейлинг). | 15 |
| `TrailingStepPips` | Дополнительное движение для каждого пересчёта трейлинга. | 5 |
| `DiffMinPips` | Минимальный допустимый диапазон трёх свечей (в пунктах). | 18 |
| `DiffMaxPips` | Максимальный допустимый диапазон трёх свечей (в пунктах). | 28 |
| `OpenHour` | Час начала торгового окна (по времени площадки). | 0 |

## Используемые индикаторы

- `Highest` с длиной 3 — отслеживает локальные максимумы.
- `Lowest` с длиной 3 — отслеживает локальные минимумы.

## Особенности реализации

- Пересчёт пунктов учитывает инструменты с 3 или 5 знаками после запятой (шаг цены умножается на 10, как и в оригинальном MQ5 коде).
- В версии для StockSharp анализ ведётся по закрытым свечам, поэтому внутрисвечные условия входа аппроксимируются ценой закрытия. Это обеспечивает детерминированность и сохраняет логику исходного алгоритма.
- Все параметры объявлены через `StrategyParam<T>`, благодаря чему отображаются в интерфейсе, участвуют в оптимизации и легко интегрируются в батчевые эксперименты.
