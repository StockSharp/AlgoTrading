# 夜间区间突破策略（Night Flat Trade）
[English](README.md) | [Русский](README_ru.md)

该策略复刻了原始的 MQL5 智能交易程序：在 EURUSD 的 H1 周期寻找夜间的窄幅震荡区间，并尝试在价格靠近区间边缘时参与突破。StockSharp 版本完全使用高级 API —— 蜡烛订阅、Highest/Lowest 指标绑定以及 `StrategyParam<T>` 参数体系 —— 既保持了原有思想，也便于配置与优化。

## 概览

- **市场与周期**：默认针对 EURUSD 的 1 小时图；任何具有明确报价步长的品种均可应用。
- **交易时间窗**：只在 `OpenHour` 到 `OpenHour + 1` 的两个交易小时内寻找信号（交易所时间）。
- **区间过滤**：最近三根已完成蜡烛的高低差需处于 `DiffMinPips` 与 `DiffMaxPips`（换算成价格）之间。
- **方向判定**：若收盘价位于区间下四分之一则做多，在上四分之一则做空。

## 交易流程

1. **计算区间边界**
   - 通过 `Highest` 与 `Lowest` 指标（长度为 3）获取最近三根蜡烛的最高价与最低价。
   - 两者之间的差值即为后续判断与风控所用的有效区间。

2. **入场条件**
   - **做多**：在允许时间段内，若收盘价高于区间下沿且不超过下四分之一（`lowest + range/4`），则市价买入，并将初始止损放在 `lowest - range/3`。
   - **做空**：若收盘价低于区间上沿并处于上四分之一（`highest - range/4`），则市价卖出，同时把止损设为 `highest + range/3`。

3. **离场与风控**
   - **止损**：将目标价位保存在变量中，只要下一根蜡烛突破该水平，就以市价平仓。
   - **止盈**：当 `TakeProfitPips > 0` 时，会在入场价基础上设置固定点数的止盈目标。
   - **移动止损**：当 `TrailingStopPips` 与 `TrailingStepPips` 都大于 0 时，只有在价格朝有利方向移动至少 `TrailingStop + TrailingStep` 点后才会上调/下调止损；之后每次更新都需要额外 `TrailingStepPips` 的推进，以还原原策略的阶梯式拖尾逻辑。

4. **再入场控制**
   - 策略在持仓结束之前不会寻找新的信号，确保交易模式始终保持「一笔仓位对应一个方向」。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 订阅的蜡烛类型（默认 H1）。 | 1 小时蜡烛 |
| `TakeProfitPips` | 止盈距离（点数，0 表示不使用）。 | 50 |
| `TrailingStopPips` | 基础拖尾距离（点数，0 表示禁用）。 | 15 |
| `TrailingStepPips` | 每次调整拖尾所需的附加点数。 | 5 |
| `DiffMinPips` | 三根蜡烛区间的最小允许值（点数）。 | 18 |
| `DiffMaxPips` | 三根蜡烛区间的最大允许值（点数）。 | 28 |
| `OpenHour` | 交易时间窗的起始小时（交易所时间）。 | 0 |

## 指标

- `Highest(Length = 3)`：追踪最近区间的上边界。
- `Lowest(Length = 3)`：追踪最近区间的下边界。

## 实现细节

- 点值换算会在报价精度为 3 或 5 位小数的品种上自动将最小报价步长乘以 10，与原 MQ5 代码保持一致。
- 由于该版本基于已完成蜡烛运行，所有入场判断使用收盘价来近似盘中行为，从而保持确定性并忠实反映原策略意图。
- 全部输入参数都封装为 `StrategyParam<T>`，方便在图形界面查看，也可以直接用于批量测试或参数优化。
