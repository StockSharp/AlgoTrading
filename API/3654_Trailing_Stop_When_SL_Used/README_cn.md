# Trailing Stop When SL Used 策略
[English](README.md) | [Русский](README_ru.md)

该模块将 MetaTrader 专家顾问 `MQL/49021/Traling Stop (when SL used and Not).mq5` 移植到 StockSharp 高级 API。原始代码会持续上调已有的止损价，同时也能为没有预设止损的持仓创建追踪止损。

## 原始思路
- **定位**：MetaTrader 5 的工具型 EA，用于统一管理所有持仓的止损。
- **核心逻辑**：对于多单，程序监控买价（Bid）。一旦市场按照设定的步长上涨，就把止损提升到新的水平；空单则以卖价（Ask）执行相同流程。
- **风险控制**：只有当价格突破入场价后，追踪止损才会生效，从而避免在亏损区间锁定交易。

## StockSharp 适配要点
- **净持仓模型**：StockSharp 策略只维护一个净持仓，因此转换版针对每个方向只保留一个保护性止损，并在持仓方向变化时将其清理。
- **点值换算**：在 MetaTrader 中步长会乘以 `Point()`。C# 版本改为乘以 `Security.PriceStep`（若未提供则退化为 `1`），使追踪距离能够贴合标的的真实跳动单位。
- **按成交更新**：策略通过 `SubscribeTrades().Bind(...)` 订阅成交数据，从而复现专家顾问按每个 Tick 更新止损的方式。
- **止损处理**：当需要调整时，会先撤销旧的保护单，再在最新的追踪价位重新挂出 stop 单，对应 MQL 中的 `PositionModify` 操作。

## 交易流程
1. **初始化**
   - 记录价格步长并开始监听成交数据。
   - 策略本身不会开仓，只负责管理已有仓位。
2. **多头管理**
   - 当最新成交价高于入场价时，计算 `trailingLevel = price - step`。
   - 若当前没有保护单，则挂出新的 `SellStop`；若已有止损，仅当新水平高于旧水平时才上移。
3. **空头管理**
   - 采用镜像逻辑，计算 `trailingLevel = price + step` 并使用 `BuyStop` 订单。
4. **仓位清理**
   - 当净持仓归零时，撤销所有保护单并重置已保存的追踪价位。

## 参数
| 名称 | 说明 |
| --- | --- |
| **Trailing Step (points)** | 追踪更新之间的点数距离，先乘以标的的价格步长再用于计算，必须大于零。 |

## 使用提示
- 原始 EA 会遍历终端中的所有仓位。要达到类似效果，可以在手动开仓后启动本策略，或与发出入场信号的策略组合使用。
- 策略使用 `PositionPrice` 作为平均建仓价，因此即使出现部分成交，追踪距离也能按照真实价格计算。
- 如果经纪商的买卖价差较大，最后成交价依然是一个可靠的近似值；如有需要，可以把追踪步长调大一些。
- 本转换未附带自动化测试，请先在模拟环境验证行为，再考虑投入真实资金。
