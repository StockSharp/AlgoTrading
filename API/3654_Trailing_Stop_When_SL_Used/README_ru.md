# Стратегия Trailing Stop When SL Used
[English](README.md) | [中文](README_cn.md)

Данный модуль переносит советник MetaTrader `MQL/49021/Traling Stop (when SL used and Not).mq5` в высокоуровневый API StockSharp. Исходный код постоянно подтягивал существующий стоп-лосс и выставлял трейлинг даже для сделок, открытых без защитных ордеров.

## Исходная идея
- **Назначение**: сервисный советник для MetaTrader 5, который сопровождает стоп-лоссы по всем активным позициям.
- **Базовое поведение**: для покупок отслеживалась цена Bid. Как только рынок уходил выше на заданный шаг, стоп переносился под текущий Bid. Для продаж та же логика работала через цену Ask.
- **Контроль риска**: трейлинг включался только после выхода цены за уровень входа, поэтому советник никогда не фиксировал убыток раньше времени.

## Адаптация под StockSharp
- **Неттинговая модель**: стратегии StockSharp работают с единой позицией. Конвертация хранит по одному защитному ордеру на направление и очищает его при смене знака позиции.
- **Перевод пунктов**: в MetaTrader шаг умножается на `Point()`. В C# версия умножает введённое значение на `Security.PriceStep` (при отсутствии шага берётся `1`), чтобы расстояние учитывало специфику инструмента.
- **Обновление по тикам**: стратегия подписывается на сделки через `SubscribeTrades().Bind(...)`, что повторяет тиковые обновления оригинала.
- **Работа со стопами**: при необходимости предыдущий стоп отменяется и выставляется новый ордер на обновлённом уровне — аналог вызова `PositionModify` в MQL.

## Логика торговли
1. **Инициализация**
   - Сохраняется шаг цены и запускается подписка на сделки.
   - Стратегия не создаёт входы автоматически и управляет только уже открытыми позициями.
2. **Длинные позиции**
   - После выхода цены выше точки входа рассчитывается `trailingLevel = price - step`.
   - При отсутствии стопа регистрируется `SellStop`. Далее стоп двигается только когда новый уровень выше предыдущего.
3. **Короткие позиции**
   - Используется зеркальная схема с `trailingLevel = price + step` и ордерами `BuyStop`.
4. **Сброс состояния**
   - При закрытии позиции активный защитный ордер отменяется, а сохранённые уровни очищаются.

## Параметры
| Имя | Описание |
| --- | --- |
| **Trailing Step (points)** | Расстояние между обновлениями трейлинг-стопа в пунктах. Переводится в цену через шаг цены инструмента. Значение должно быть больше нуля. |

## Практические заметки
- Оригинальный советник обходил все позиции терминала. Чтобы повторить это поведение, запускайте стратегию после ручного входа или соединяйте её с модулем, который генерирует сигналы на вход.
- Для определения средней цены используется `PositionPrice`, поэтому расчёт расстояния корректен даже при частичном исполнении.
- Если брокер предоставляет заметный спред, используемая последняя сделка остаётся хорошим приближением. При необходимости увеличьте расстояние трейлинга.
- Автоматические тесты для данного переноса отсутствуют. Перед использованием на реальных деньгах протестируйте стратегию на демо-счёте.
