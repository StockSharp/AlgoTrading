# Стратегия Expert Candles

## Обзор

**Expert Candles Strategy** — порт MetaTrader 5 советника *Expert_Candles* на платформу StockSharp. Стратегия анализирует
закрывающиеся свечи на предмет разворотных фигур с длинными тенями. При появлении бычьей или медвежьей комбинации открывается
позиция в соответствующем направлении и задействуются правила управления капиталом, реализованные в оригинальном EA.

Реализация использует высокоуровневый API StockSharp: свечи поступают через подписку, сделки выполняются рыночными ордерами, а
стоп-уровни сопровождаются непосредственно внутри стратегии.

## Логика торговли

1. После закрытия каждой свечи она объединяется с максимум `Range` предыдущими свечами, пока высота составной свечи не превысит
   `MinimumPoints`, пересчитанные из пунктов в цену с помощью шага котировки инструмента.
2. **Бычий** сигнал возникает, когда верхняя тень короткая (`ShadowSmall`), а нижняя тень существенно длиннее (`ShadowBig`).
   **Медвежий** сигнал формируется при обратном соотношении теней.
3. Цена входа смещается от цены закрытия на `LimitFactor * rangeSize`. Положительное значение имитирует лимитный ордер внутри
   диапазона свечи.
4. Стоп-лосс и тейк-профит выставляются на расстоянии `StopLossFactor` и `TakeProfitFactor` от цены входа, умноженном на высоту
   составной свечи. При достижении любого из уровней позиция закрывается на ближайшей завершённой свече.
5. Сигнал остаётся активным в течение `ExpirationBars` полностью сформированных свечей. По истечении периода ожидания требуется
   новое формирование.
6. Перед открытием сделки в противоположную сторону существующая позиция закрывается, что соответствует поведению MQL5-эксперта.

## Управление капиталом

- По умолчанию используется объём `FixedVolume`.
- Если задан стоп-лосс и `RiskPercent` больше нуля, стратегия рассчитывает объём исходя из доли капитала. Денежный эквивалент
  расстояния до стопа вычисляется по `Security.PriceStep` и `Security.StepPrice`.
- При наличии информации о `VolumeStep` итоговый объём приводится к допустимому шагу.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CandleType` | H1 | Таймфрейм запрашиваемых свечей. |
| `Range` | 3 | Максимальное число свечей, объединяемых в составную фигуру. |
| `MinimumPoints` | 50 | Минимальная высота составной свечи в пунктах (`PriceStep`). |
| `ShadowBig` | 0.5 | Минимальная доля доминирующей тени. |
| `ShadowSmall` | 0.2 | Максимальная доля противоположной тени. |
| `LimitFactor` | 0.0 | Смещение цены входа как доля высоты свечи (положительное — внутрь диапазона). |
| `StopLossFactor` | 2.0 | Расстояние стоп-лосса в кратных высоты составной свечи (0 — без стопа). |
| `TakeProfitFactor` | 1.0 | Расстояние тейк-профита в кратных высоты составной свечи (0 — без цели). |
| `ExpirationBars` | 4 | Количество завершённых свечей, в течение которых сигнал считается актуальным. |
| `FixedVolume` | 0.1 | Резервный объём сделки при невозможности рассчитать риск. |
| `RiskPercent` | 10 | Процент капитала, которым рискует сделка при наличии стоп-лосса. |

## Рекомендации по использованию

- Для корректного пересчёта пунктов необходимы метаданные `PriceStep`, `StepPrice` и `VolumeStep`. При их отсутствии параметры
  следует подбирать вручную.
- Сигналы формируются только по свечам со статусом `CandleStates.Finished`. Убедитесь, что источник данных публикует завершённые
  свечи.
- Стоп-лосс и тейк-профит отрабатываются внутри стратегии: если максимум/минимум завершённой свечи пробивает уровень, позиция
  закрывается.
- Хранится не более 500 последних свечей, что ограничивает потребление памяти.

## Отличия от версии для MetaTrader

- В портированной версии используются рыночные ордера; параметр `LimitFactor` сдвигает цену, чтобы повторить эффект лимитной
  заявки.
- Управление капиталом можно отключить, установив `RiskPercent` в ноль — тогда останется фиксированный объём.
- Логика сопровождения позиций реализована внутри стратегии и не требует внешних модулей трейлинг-стопа.
