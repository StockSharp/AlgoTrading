# AutoMagiCal 策略

## 概述
AutoMagiCal 策略是同名 MetaTrader 脚本的忠实移植版本。原始工具用于生成一个确定性的“magic number”，让其他专家顾问可以用它来标记自己的订单。脚本本身不会开仓，而是分析交易品种的名称，并在 MetaTrader 图表上显示计算结果。StockSharp 版本在策略生命周期内部复现了这一流程，使自动化工作流能够以完全相同的方式复用这个标识符。

与传统的交易策略不同，AutoMagiCal 完全专注于数据准备。当策略启动时，它会检查所分配的 `Security`，从品种代码中提取特定字符，将字符转换成 ASCII 数值，并把这些数字拼接成一个长整型。最终的 magic number 保存在 `MagicNumber` 属性中，同时写入策略日志，供其他策略或人工操作员引用。

## Magic number 计算步骤
1. 读取交易品种标识。策略首先尝试 `Security.Id`，如果没有值则退回到 `Security.Code`。如果没有设置任何品种，将在日志中报告错误。
2. 读取与 MetaTrader 相同的四个字符：标识的第 1 到第 4 位（跳过第 0 位）。每个字符都会转换成 ASCII 十进制代码，然后追加到临时字符串中。
3. 将拼接好的数字字符串解析成十进制数。若解析失败，`AddErrorLog` 会记录错误，与原始 MQL 代码中的防御性检查保持一致。
4. 使用原脚本定义的阈值缩减过大的结果。当数值大于 `999,999,999` 时除以 10；在第一次调整后仍然大于 `9,999,999,999` 的结果再除以 100。这样可以避免当数字过长时出现整数溢出。
5. 将调整后的值四舍五入为最接近的整数，并通过 `MagicNumber` 暴露出来。日志会打印 `"Magic No. = X"` 的信息，模拟 MetaTrader 在图表左上角显示标签的方式。

## 实现要点
- 类继承自 `Strategy` 并覆盖 `OnStarted`，在策略启动时立即运行计算逻辑。`OnReseted` 会清空缓存的 magic number，确保每次重新运行都会重新计算。
- 源代码中的所有注释都使用英文，符合仓库的通用规范。
- 算法刻意保持无交易逻辑。策略不会注册订单，也不会订阅市场数据；它只作为一个供其他策略查询稳定标识的工具组件。
- StockSharp 的日志系统代替了 MetaTrader 的图表标签。无论是 UI、日志文件还是遥测系统，都可以轻松看到该信息。
- `MagicNumber` 属性是可空类型。只有在第一次计算成功后才会赋值，可帮助使用者检测配置问题。

## 使用说明
1. 在调用 `Start()` 之前，将策略绑定到组合和目标品种。没有品种标识就无法生成 magic number。
2. 启动策略。`OnStarted` 会立即触发并执行 AutoMagiCal 逻辑。
3. 在日志中查找 `Magic No. = <数值>` 的信息条目，同样的数值也可以通过 `MagicNumber` 属性获取。
4. 如果只需要得到数值，可以在读取后停止策略。由于策略不会执行任何交易操作，即便让它一直运行也不会带来影响。
5. 如果日志出现“Security is not assigned”或“Symbol is too short”等错误，请检查品种标识。确保其长度至少为五个字符，以便提取步骤能够复现原脚本的行为。

## 与 MetaTrader 版本的差异
- MetaTrader 脚本会在图表窗口绘制标签。StockSharp 版本用日志消息替代了这一界面元素，更适合跨平台的自动化流程。
- StockSharp 实现将计算与错误处理放在同一个策略类中，以符合仓库的目录结构，而不是像某些 MQL 工程那样拆分到多个文件。
- 转换使用 .NET 的 `Math.Round`（`MidpointRounding.AwayFromZero`）显式地对结果进行四舍五入。MetaTrader 的 `NormalizeDouble` 采用相同的舍入规则，但在 C# 中明确写出可以帮助使用者理解行为。
- MetaTrader 依赖从 double 到 int 的隐式类型转换。C# 版本使用可空整型保存结果，使得成功计算这一状态更加直观。

## 故障排查
- **未分配品种** – 在启动前关联一个 `Security`。算法必须依赖品种字符串才能生成确定性的数字。
- **品种长度不足** – 原脚本假设标识至少有五个字符。如果交易所的代码较短，可考虑手动补全或者调整算法的取值位置。
- **结果与预期不符** – 请注意 ASCII 数值会受到标识字符的精确写法影响。例如 `EURUSD` 与 `EURUSDm` 会产生完全不同的 magic number，即便基础品种相同。

## 参数
该策略不提供运行时参数。所有行为都固定为 MetaTrader 的实现方式，从而确保生成的 magic number 在两个平台之间保持一致。
