# Стратегия Kloss MQL/8186
[English](README.md) | [中文](README_cn.md)

**Kloss MQL/8186** — это перенос советника MetaTrader 4 `Kloss.mq4` в инфраструктуру StockSharp. Стратегия использует комбинацию индикатора CCI, стохастического осциллятора и фильтра по типичной цене, сдвинутой на несколько свечей, чтобы открывать и переворачивать одиночную позицию. Реализация на StockSharp сохраняет исходные пороговые значения, расстояния стоп-лосса и тейк-профита, а также логику расчёта объёма (фиксированный лот или процент от капитала) и при этом задействует высокоуровневое API подписки на свечи.

## Логика торговли

- **Данные**: завершённые свечи выбранного таймфрейма (по умолчанию M5). Индикаторы рассчитываются по тем же свечам.
- **Индикаторы**:
  - CCI с периодом 10. Сравнивается модуль значения с порогом `±CciThreshold` (стандартно 120).
  - Стохастический осциллятор с параметрами `%K=5`, `%D=3`, сглаживание `=3`. Проверяется основная линия %K на выход за уровни перекупленности/перепроданности.
  - Типичная цена ((High + Low + Close) / 3), сдвинутая на пять завершённых свечей — эквивалент LWMA со сдвигом из оригинального советника.
- **Вход в лонг**:
  - CCI ≤ `-CciThreshold`.
  - Стохастик %K < `StochasticOversold` (по умолчанию 30).
  - Открытие предыдущей свечи > типичной цены пятой свечи назад.
  - Нет открытого лонга (`Position <= 0`). Любой шорт закрывается и позиция переворачивается в лонг одним рыночным ордером.
- **Вход в шорт**:
  - CCI ≥ `CciThreshold`.
  - Стохастик %K > `StochasticOverbought` (по умолчанию 70).
  - Закрытие предыдущей свечи < типичной цены пятой свечи назад.
  - Нет открытого шорта (`Position >= 0`). Любой лонг закрывается и позиция переворачивается в шорт одним рыночным ордером.
- **Управление позицией**: `StartProtection` в StockSharp автоматически выставляет стоп-лосс и тейк-профит на заданных расстояниях в пунктах. В остальном стратегия поддерживает единственную позицию (флэт, лонг или шорт).

## Расчёт объёма

- **Фиксированный объём**: при `FixedVolume > 0` торгуется именно этот объём (после приведения к `VolumeStep` и `MinVolume` инструмента).
- **Процент от капитала**: если `FixedVolume = 0`, объём оценивается как `RiskPercent` (по умолчанию 0.2) от стоимости портфеля, делённой на последнюю цену закрытия. Значение ограничивается `MaxVolume` (по умолчанию 5) и округляется по шагу объёма.
- **Защита**: если информация о портфеле недоступна или расчёт даёт неположительный результат, используется минимально допустимый объём инструмента.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `CciPeriod` | Количество свечей в расчёте Commodity Channel Index. | 10 |
| `CciThreshold` | Абсолютный порог CCI для сигналов. | 120 |
| `StochasticKPeriod` | Период %K стохастика. | 5 |
| `StochasticDPeriod` | Период сглаживания %D. | 3 |
| `StochasticSmooth` | Дополнительное сглаживание %K перед сигналом. | 3 |
| `StochasticOversold` | Уровень %K для подтверждения лонга. | 30 |
| `StochasticOverbought` | Уровень %K для подтверждения шорта. | 70 |
| `StopLossPoints` | Расстояние стоп-лосса в пунктах цены. | 48 |
| `TakeProfitPoints` | Расстояние тейк-профита в пунктах цены. | 152 |
| `FixedVolume` | Положительное значение фиксирует объём сделки. | 0 |
| `RiskPercent` | Доля капитала, переводимая в объём при `FixedVolume = 0`. | 0.2 |
| `MaxVolume` | Максимально допустимый объём сделки. | 5 |
| `CandleType` | Тип/таймфрейм свечей для расчётов. | Свечи 5 минут |

## Особенности исполнения

- **Одиночная позиция**: стратегия не наращивает позиции. Переворот закрывает старое направление и открывает новое одним ордером.
- **Синхронизация индикаторов**: фильтр по типичной цене использует последние пять завершённых свечей; перед первым сигналом нужно обработать минимум шесть свечей.
- **Стопы и цели**: `StartProtection` преобразует расстояния в пунктах в абсолютные цены через `PriceStep`. Если шаг цены неизвестен, используется указанное значение пунктов без пересчёта.
- **Требования к данным**: необходимы OHLC-свечи; объём приводится к `MinVolume` и `VolumeStep`, если они заданы у инструмента.
- **Отличия от MT4**: расчёт свободной маржи заменён приближением через стоимость портфеля (`Portfolio.CurrentValue`). При отсутствии данных стратегия переходит на минимальный объём.

## Рекомендации по использованию

1. Подберите `CandleType` в соответствии с таймфреймом, применявшимся в MetaTrader (по умолчанию M5).
2. Проверьте соответствие расстояний стопов шагу цены инструмента — пересчёт выполняется автоматически, но значения могут потребовать подстройки.
3. Для фиксированных контрактов задайте `FixedVolume`, а `RiskPercent` установите в ноль.
4. Включите оптимизацию порогов индикаторов при адаптации стратегии под новые инструменты.

