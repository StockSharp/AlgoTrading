# Стратегия Three Neural Networks

## Обзор

Стратегия представляет собой перенос советника MetaTrader «Three neural networks» на высокоуровневый API StockSharp. Она использует подписки на свечи трёх таймфреймов (H1, H4, D1) и встроенные индикаторы `SmoothedMovingAverage`, полностью повторяя вычисления оригинала в рамках экосистемы StockSharp.

## Алгоритм работы

1. При запуске стратегия оформляет подписки на свечи H1, H4 и D1 и связывает их с сглаженными скользящими средними по медианной цене — аналог вызова `iMA(..., MODE_SMMA, PRICE_MEDIAN)` в MetaTrader.
2. Для каждого таймфрейма поддерживается скользящее окно значений с учётом смещения. После появления четырёх смещённых точек рассчитываются три нейронных выхода по формуле исходного эксперта, а результат округляется до четырёх знаков.
3. После закрытия свечи H1 значения комбинируются:
   - Все три выхода > 0 → открываем или удерживаем длинную позицию.
   - Выход H1 > 0 и выходы H4, D1 < 0 → открываем или удерживаем короткую позицию.
4. Размер позиции выбирается либо фиксированным лотом, либо как процент риска. В режиме риска берётся `VolumeOrRisk` процентов от стоимости портфеля и делится на текущую цену инструмента.
5. Сразу после изменения позиции рассчитываются уровни стоп-лосса и тейк-профита в ценах. Также реализован трейлинг-стоп: при закрытии свечи H1 он подтягивается, если цена прошла расстояние `TrailingStopPips + TrailingStepPips` и прирост превышает заданный шаг.
6. Каждая завершённая свеча H1 сначала проверяет, достигнуты ли уровни стопа или цели, и при необходимости закрывает позицию рыночным ордером через `ClosePosition()`. Параметр `EnableDetailedLog` включает детальный лог, аналогичный `InpPrintLog` оригинального советника.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `StopLossPips` | `50` | Дистанция защитного стоп-лосса в пунктах. Ноль отключает стоп. |
| `TakeProfitPips` | `50` | Дистанция тейк-профита в пунктах. Ноль отключает цель. |
| `TrailingStopPips` | `15` | Расстояние между ценой и трейлинг-стопом. |
| `TrailingStepPips` | `5` | Минимальное улучшение, необходимое для очередного сдвига трейлинг-стопа. |
| `ManagementMode` | `RiskPercent` | Режим управления капиталом: `FixedLot` — фиксированный объём, `RiskPercent` — доля капитала. |
| `VolumeOrRisk` | `1` | Величина лота или процент риска в зависимости от выбранного режима. |
| `H1Period`, `H1Shift` | `2`, `5` | Период и горизонтальный сдвиг H1 сглаженной средней. |
| `H4Period`, `H4Shift` | `2`, `5` | Период и сдвиг H4 сглаженной средней. |
| `D1Period`, `D1Shift` | `2`, `5` | Период и сдвиг D1 сглаженной средней. |
| `P1`, `P2`, `P3` | `0.1` | Веса трёх компонентов нейросети для H1. |
| `Q1`, `Q2`, `Q3` | `0.1` | Веса компонентов для H4. |
| `K1`, `K2`, `K3` | `0.1` | Веса компонентов для D1. |
| `EnableDetailedLog` | `false` | Включает подробный журнал сообщений. |

## Управление рисками

- Определение стоимости пункта повторяет логику MetaTrader: учитывается шаг цены и трёх/пятизначные котировки, после чего стоп и цель выставляются в локальных переменных сразу после изменения позиции.
- Трейлинг-стоп активируется только после прохождения ценой дистанции `TrailingStopPips + TrailingStepPips` и смещается лишь при приросте больше заданного шага.
- Все выходы совершаются рыночными заявками посредством `ClosePosition()`, так как на уровне высокоуровневого API нет серверных стоп/лимит ордеров.

## Особенности

- Проверка уровней Freeze/Stops из MetaTrader недоступна, поэтому стратегия ограничивается пересчётом пунктов и нормализацией объёма по `VolumeStep`, `VolumeMin`, `VolumeMax` инструмента.
- Режим риска приближённо воспроизводит `CheckOpenLong/Short`: рассчитывает объём как долю капитала, делённую на текущую цену, что позволяет сохранять поведение оригинала без брокерских калькуляторов маржи.
- При необходимости диагностики можно включить `EnableDetailedLog`, чтобы получить последовательный вывод событий, аналогичный логам советника.
