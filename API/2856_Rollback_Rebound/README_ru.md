# Стратегия Rollback Rebound

## Обзор
Стратегия Rollback Rebound — это C#-адаптация советника MQL5 «TST (barabashkakvn's edition)». Она отслеживает один инструмент на таймфрейме, заданном параметром `CandleType`, и ищет свечи, которые сначала расширяются, а затем откатываются внутрь диапазона. Когда бычья свеча откатывается от максимума больше заданного порога, стратегия покупает; аналогичный откат от минимума формирует сигнал на продажу. Реализация использует высокоуровневый интерфейс StockSharp для подписки на свечи, а все защитные уровни задаются в пунктах и переводятся в абсолютные цены.

Пункты рассчитываются от шага цены инструмента. Для инструментов с тремя или пятью знаками после запятой шаг автоматически умножается на десять, чтобы повторить метатрейдеровскую трактовку pip. Объём сделок берётся из свойства `Volume` стратегии.

## Логика входа
- Сигналы вычисляются только по закрытым свечам выбранного `CandleType`.
- При `ReverseSignal = false` (значение по умолчанию):
  - **Покупка:** свеча закрывается ниже открытия, а разница между максимумом и закрытием превышает `RollbackRatePips` (в ценовом выражении). Это означает, что цена выросла и затем откатилась достаточно глубоко для контртрендового входа.
  - **Продажа:** свеча закрывается выше открытия, а разница между закрытием и минимумом превышает `RollbackRatePips`, что является зеркальным условием.
- Если `ReverseSignal = true`, условия покупок и продаж меняются местами.
- Новая позиция открывается только при отсутствии позиции или наличии встречной. Объём ордера равен `Volume + |Position|`, что позволяет одновременно закрыть противоположную позицию и открыть новую.

## Логика выхода
- При открытии сделки сохраняются уровни стоп-лосса и тейк-профита, вычисленные из параметров в пунктах. Если свеча достигает одного из уровней, позиция закрывается рыночным ордером.
- Значения `StopLossPips = 0` или `TakeProfitPips = 0` отключают соответствующий защитный уровень.
- Трейлинг включается, когда плавающая прибыль превышает `TrailingStopPips + TrailingStepPips`.
  - Для длинных позиций стоп подтягивается к `максимум - TrailingStopPips`, если новое значение минимум на `TrailingStepPips` выше предыдущего.
  - Для коротких позиций стоп подтягивается к `минимум + TrailingStopPips`, если новое значение минимум на `TrailingStepPips` ниже предыдущего.
  - Если цена возвращается за текущий трейлинг, позиция закрывается немедленно.
- После закрытия всех позиций внутреннее состояние очищается, чтобы исключить повторное использование старых данных.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Свечная серия, на которой рассчитываются сигналы. | 15-минутные свечи |
| `StopLossPips` | Стоп-лосс в пунктах (0 — отключить). | 30 |
| `TakeProfitPips` | Тейк-профит в пунктах (0 — отключить). | 90 |
| `TrailingStopPips` | Базовая дистанция трейлинга в пунктах (0 — отключить). | 1 |
| `TrailingStepPips` | Дополнительная прибыль в пунктах для очередного смещения трейлинга; при включённом трейлинге должно быть > 0. | 15 |
| `RollbackRatePips` | Минимальный откат от экстремума бара для подтверждения сигнала. | 15 |
| `ReverseSignal` | Инвертирует направление входов. | false |

## Рекомендации по использованию
- Перед запуском задайте свойство `Volume`, оно определяет объём ордеров.
- При активном трейлинге необходимо, чтобы `TrailingStopPips > 0` и `TrailingStepPips > 0`, иначе стратегия завершит запуск с ошибкой.
- Оригинальный советник анализировал тики внутри формирующейся свечи; порт использует закрытые свечи (максимум, минимум, закрытие), что приближает исходную логику и позволяет работать с высокоуровневым API StockSharp.
- Стратегия рассчитана на один инструмент. Для торговли несколькими инструментами запустите отдельные экземпляры стратегии.
