# Macd Pattern Trader v02 (порт StockSharp)

Стратегия представляет собой перенос советника **MacdPatternTraderv02.mq4** (каталог `MQL/8194`) на высокоуровневый API StockSharp. Логика поиска паттерна MACD и алгоритм активного сопровождения позиции полностью соответствуют оригиналу, но параметры удобно вынесены для оптимизации.

## Основная идея

1. Рассчитывается главная линия MACD с периодами EMA `FastEmaPeriod` и `SlowEmaPeriod` и единичным периодом сигнальной линии (точно как в MQL-версии).
2. Анализируются только завершённые свечи. Когда MACD формирует характерную последовательность из четырёх значений около нулевой линии, активируется заготовка на шорт или лонг:
   - **Шорт-паттерн**: требуется положительная фаза MACD, затем отрицательная коррекция выше `MinThreshold` и последующий разворот вниз.
   - **Лонг-паттерн**: зеркальное условие — отрицательная фаза, затем положительная коррекция ниже `MaxThreshold` и разворот вверх.
3. После подтверждения паттерна выставляется рыночная заявка объёмом `TradeVolume`.
4. Стоп-лосс размещается за ближайшим экстремумом последних `StopLossBars` свечей с дополнительным отступом в пунктах (`OffsetPoints`).
5. Тейк-профит вычисляется последовательным поиском экстремумов по блокам длиной `TakeProfitBars`, пока встречаются новые минимумы/максимумы.
6. Блок сопровождения позиций повторяет оригинал: после прибыли в пять пунктов закрывается треть объёма при подтверждении предыдущей свечой (фильтр `Ema2Period`), затем половина остатка при касании средней между `SmaPeriod` и `Ema3Period`.

## Параметры

| Параметр | Описание |
|----------|----------|
| `StopLossBars` | Количество свечей для определения экстремума стоп-лосса. |
| `TakeProfitBars` | Размер окна (в свечах) для последовательного поиска тейк-профита. |
| `OffsetPoints` | Дополнительный отступ от экстремума в пунктах. |
| `FastEmaPeriod` | Период быстрой EMA в MACD. |
| `SlowEmaPeriod` | Период медленной EMA в MACD. |
| `MaxThreshold` | Положительный порог MACD, при превышении которого снимается подготовка к шорту. |
| `MinThreshold` | Отрицательный порог MACD, при котором завершается подготовка к лонгу. |
| `Ema1Period` | Первый период EMA в блоке сопровождения (оставлен для совместимости). |
| `Ema2Period` | Второй период EMA для фильтра частичного выхода. |
| `SmaPeriod` | Период SMA, участвующий во втором частичном выходе. |
| `Ema3Period` | Период медленной EMA, образующей среднее с SMA. |
| `TradeVolume` | Объём рыночных сделок (лоты). |
| `CandleType` | Тип свечей, подаваемых на индикаторы. |

## Логика торговли

- **Вход в шорт**: выполняется при выполнении последовательности MACD `(prev3, prev2, prev1, current)` согласно оригинальным условиям (`macdPrev1 < macdPrev3`, `macdPrev1 > macdPrev2`, `current < prev1`, `current < 0` и проверка амплитуды). Перед открытием шорта закрывается открытый лонг.
- **Вход в лонг**: зеркальное условие (`current > 0` и т.п.); перед входом закрывается шорт.
- **Стоп и тейк**: рассчитываются сразу после входа и не пересчитываются, пока не появится новый сигнал.
- **Частичное закрытие**: после прибыли в пять пунктов закрывается треть позиции при подтверждении EMA2; следующая половина закрывается при касании средней `(SMA + EMA3)/2` предыдущей свечой.
- **Полный выход**: при достижении стоп-лосса или тейк-профита позиция полностью закрывается, внутреннее состояние сбрасывается.

## Дополнительно

- Размер пункта берётся из `Security.PriceStep`, а при отсутствии — по количеству знаков после запятой; при невозможности вычисления используется значение `0.0001`.
- История свечей (до 1024 записей) хранится для имитации функций `iHighest`, `iLowest` и оригинального алгоритма `TakeProfit()`.
- Все комментарии внутри стратегии переведены на английский язык в соответствии с требованиями репозитория.
- Python-версия и соответствующая папка не создавались намеренно.
