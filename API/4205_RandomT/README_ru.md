# Стратегия RandomT

## Общее описание
Стратегия представляет собой перенос советника MetaTrader 4 «RandomT» на платформу StockSharp. Оригинальная версия ждёт совпадения точки ZigZag и подтверждённого фрактала, после чего сверяет направление с линиями MACD. Переписанная реализация сохраняет эту последовательность: отслеживает заданное количество свечей (`BarWatch`), убеждается, что пятиточечный фрактал образует крайнюю точку качания, и сравнивает основную и сигнальную линии MACD на той же исторической свече.

## Логика торговли
- На каждой завершённой свече выбранного таймфрейма (`CandleType`) обновляются буферы и рассчитывается MACD.
- Свеча `Shift` баров назад проверяется на наличие восходящего или нисходящего фрактала (по два бара с каждой стороны).
- Фрактал сверяется с локальным движением: максимум должен быть самым высоким значением, а минимум — самым низким в окне `BarWatch`. Это повторяет подтверждение ZigZag из MQL.
- Для продаж основная линия MACD на смещённой свече должна быть выше сигнальной, для покупок — ниже.
- При появлении сигнала стратегия отправляет одну рыночную заявку, которая сначала закрывает встречную позицию и затем открывает новую в нужном направлении.

## Управление трейлинг-стопом
- Блок трейлинга активируется только при включённом `UseTrailingProfit` и при плавающей прибыли, превышающей `MinProfit` (пересчитанной через `PriceStep` и `StepPrice`).
- Расстояние задаётся в пунктах. Если `AutoStopLevel = true`, используется `StartStopLevelPoints`, иначе — `StopLevelPoints`.
- Для длинных позиций стоп ведётся по формуле `ClosePrice - расстояние`, для коротких — `ClosePrice + расстояние`. При пробое уровня позиция закрывается рыночным ордером.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Базовый объём сделки в лотах. |
| `BarWatch` | Количество баров, используемых для подтверждения фрактала как экстремума ZigZag. |
| `Shift` | Сдвиг по истории для оценки сигналов (классический фрактал требует значения 2). |
| `UseTrailingProfit` | Включает логику трейлинг-стопа. |
| `AutoStopLevel` | Переключает расстояние трейлинга на `StartStopLevelPoints`. |
| `StartStopLevelPoints` | Альтернативная дистанция трейлинга в пунктах. |
| `StopLevelPoints` | Основная дистанция трейлинга в пунктах. |
| `MinProfit` | Минимальная плавающая прибыль (в валюте счёта) для запуска трейлинга. |
| `CandleType` | Таймфрейм, по которому строятся свечи и индикаторы. |
| `MacdFastLength` | Период быстрой EMA в фильтре MACD. |
| `MacdSlowLength` | Период медленной EMA в фильтре MACD. |
| `MacdSignalLength` | Период сигнальной EMA в фильтре MACD. |

## Примечания
- Фракталы рассчитываются внутри стратегии (два бара слева и справа) и используются повторно для проверки ZigZag, что соответствует обращению к буферам в MQL.
- Подтверждение ZigZag реализовано через проверку диапазона `BarWatch` вместо вызова индикатора MetaTrader, что обеспечивает детерминированное поведение в StockSharp.
- Прибыль для трейлинг-стопа рассчитывается из `PriceStep` и `StepPrice`. Перед запуском убедитесь, что для выбранного инструмента указаны корректные значения.
