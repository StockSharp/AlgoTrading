# Стратегия ExpertClor 2MA Stop ATR

## Обзор

ExpertClor 2MA Stop ATR — это защитный модуль, перенесённый из советника MetaTrader 4 `ExpertCLOR_2MAwampxStATR_v01`. Исходный робот только сопровождает позиции, которые открывают другие системы. Порт на StockSharp сохраняет тот же подход: стратегия никогда не создаёт новые заявки самостоятельно, она лишь отслеживает активную позицию на выбранном таймфрейме и инициирует выходы при выполнении условий оригинала.

## Основная логика

1. **Выход по пересечению скользящих средних**  
   Две настраиваемые скользящие средние (быстрая и медленная) рассчитываются на закрытых свечах. Когда быстрая линия пересекает медленную сверху вниз, стратегия закрывает длинные позиции. Если быстрая пересекает медленную снизу вверх, закрываются короткие позиции. Сравнение выполняется по двум последним завершённым свечам, чтобы повторить логику MQL.
2. **ATR-трейлинг StopATR_auto**  
   Пользовательский индикатор `StopATR_auto` заменён стандартным Average True Range. Кандидат на трейлинг рассчитывается как `Close ± ATR × Target`. Активный уровень подтягивается только после ожидания `AtrShiftBars` завершённых свечей, что воспроизводит задержку `CountBarsForShift` из исходного кода. Стоп передвигается лишь в сторону прибыли.
3. **Перевод в безубыток**  
   После движения цены на `BreakevenPoints × PriceStep` в прибыльную сторону защитный уровень переносится к цене входа плюс один шаг цены для лонга или минус один шаг для шорта. Это повторяет оригинальную установку стопа чуть выше/ниже точки входа.
4. **Контроль направления позиции**  
   Внутреннее состояние трейлинга очищается при смене направления позиции или при выходе в ноль, что предотвращает использование устаревших уровней в следующей сделке.

## Индикаторы

- Быстрая скользящая средняя с настраиваемым периодом, типом (SMA, EMA, SMMA, WMA) и типом цены (Close, Open, High, Low, Typical, Median, Weighted).
- Медленная скользящая средняя с аналогичными настройками.
- Average True Range (ATR), формирующий трейлинг в стиле StopATR_auto.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `MaCloseEnabled` | Включить/выключить выход по пересечению скользящих. | `true` |
| `AtrCloseEnabled` | Включить/выключить ATR-трейлинг. | `true` |
| `FastMaPeriod` | Период быстрой скользящей средней. | `5` |
| `FastMaMethod` | Тип быстрой скользящей (Simple, Exponential, Smoothed, Weighted). | `Exponential` |
| `FastPriceType` | Тип цены для быстрой скользящей. | `Close` |
| `SlowMaPeriod` | Период медленной скользящей средней. | `7` |
| `SlowMaMethod` | Тип медленной скользящей. | `Exponential` |
| `SlowPriceType` | Тип цены для медленной скользящей. | `Open` |
| `BreakevenPoints` | Сколько шагов цены нужно пройти, чтобы перенести стоп в безубыток. | `15` |
| `AtrShiftBars` | Сколько закрытых свечей ждать перед подтягиванием ATR-стопа. | `7` |
| `AtrPeriod` | Период усреднения ATR. | `12` |
| `AtrTarget` | Множитель ATR для расчёта трейлинга. | `2.0` |
| `CandleType` | Тип свечей, используемый в расчётах. | `5 минут` |

## Рекомендации по использованию

- Подключайте стратегию к инструменту, где входы выполняет внешняя логика. ExpertClor 2MA Stop ATR будет только закрывать позиции по рынку.
- Требуются завершённые свечи выбранного таймфрейма. Убедитесь, что подписка на свечи совпадает с параметром `CandleType`.
- Если инструмент не предоставляет `PriceStep`, стратегия использует значение `1`, чтобы сохранить работоспособность перевода в безубыток.
- ATR-трейлинг начинает работать только после формирования индикатора; до этого срабатывают лишь пересечение скользящих и перевод в безубыток.
- Python-версия пока отсутствует, реализована только C# стратегия.

## Детали конверсии

- Индикатор StopATR_auto реализован через стандартный Average True Range с задержкой `AtrShiftBars`, отражающей параметр `CountBarsForShift` оригинала.
- В MQL модификация ордеров через `OrderModify` заменена на вызовы `ClosePosition()` при достижении расчётного уровня стопа.
- В коде использованы подробные комментарии на английском языке для упрощения дальнейшей поддержки.
