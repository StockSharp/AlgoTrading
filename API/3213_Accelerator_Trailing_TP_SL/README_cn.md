# Accelerator Trailing TP & SL 策略

## 概述
Accelerator Trailing TP & SL 策略是将 MetaTrader 平台上的 "Accelerator Trailing TP&SL" 智能交易系统移植到 StockSharp 高级 API 的版本。策略结合了比尔·威廉姆斯的加速指标、多周期动量确认以及月线 MACD 趋势过滤。仓位按照几何级数逐步加码，退出部分则整合了固定止损止盈、移动止损以及保本移动。

## 交易逻辑
- **动量过滤**：在更高周期上计算的 14 周期动量指标，最近三根完成的 K 线中任意一根偏离 100 的绝对值必须达到设定阈值。
- **加速指标**：在信号周期上加速指标为正时允许做多，为负时允许做空。
- **移动平均**：快速线性加权移动平均 (LWMA) 必须高于慢速 LWMA 才能做多，反之才能做空，复现原策略中的趋势过滤。
- **月线 MACD 趋势**：默认使用月线数据。做多时要求 MACD 主线高于信号线（即使两者都为负），做空则要求主线低于信号线。
- **阶梯式加仓**：策略可以在同一方向上逐次加仓，直到达到最大层数。每次新仓位都会乘以指定的手数指数，模拟原始 EA 的马丁格尔加仓方式。

## 风险管理
- **固定止损/止盈**：以点数定义的止损和止盈距离与原策略一致。
- **移动止损**：启用后按照设定的点数对浮动盈利进行跟踪。
- **保本移动**：当浮动盈利达到触发距离时，将止损移动到设定的保本偏移位置，锁定利润。
- **MACD 反转退出**：当高周期 MACD 与持仓方向相反时，可立即平掉全部仓位，对应原策略中的人工退出逻辑。

## 参数
| 参数 | 说明 |
| --- | --- |
| `FastMaLength` / `SlowMaLength` | 信号周期上快/慢 LWMA 的周期数。 |
| `MomentumThreshold` | 高周期动量指标相对 100 的最小绝对偏差。 |
| `StopLossPips` / `TakeProfitPips` | 固定止损与止盈的点数距离。 |
| `TrailingStopPips` | 移动止损的点数距离。 |
| `BreakEvenTriggerPips` / `BreakEvenOffsetPips` | 定义保本触发位置与移动后的偏移量。 |
| `MaxTrades` | 同一方向允许的最大加仓次数。 |
| `BaseVolume` | 第一笔仓位的交易量。 |
| `LotExponent` | 每次加仓的手数倍率。 |
| `EnableTrailing` | 是否启用移动止损。 |
| `UseBreakEven` | 是否启用保本移动。 |
| `CloseOnMacdFlip` | MACD 反向时是否立即清仓。 |
| `CandleType` | 主信号使用的 K 线周期（默认 15 分钟）。 |
| `MomentumCandleType` | 用于动量过滤的更高周期 K 线（默认 1 小时）。 |
| `MacdCandleType` | MACD 过滤使用的 K 线周期（默认月线）。 |

## 注意事项
- 策略依赖品种的 `PriceStep` 信息来将点值转换为实际价格距离，运行前请确认交易标的的元数据已正确填充。
- 由于 StockSharp 使用净持仓模式，加仓通过重复发送市价单实现，并在达到最大层数后停止。平仓将一次性关闭所有净持仓，与原始 EA 中的 "全部平仓" 行为一致。
- 可通过 `MacdCandleType` 参数调整 MACD 所用的时间框架，以适配不同市场或回测需求。
