# Cash Machine 5 min Legacy

## Обзор
Cash Machine 5 min Legacy — порт советника MetaTrader 4 `CashMachine_5min` на платформу StockSharp. Стратегия отслеживает разворотные импульсы по индикаторам DeMarker и Stochastic на пятиминутных свечах. После входа защитные уровни стоп-лосса и тейк-профита остаются скрытыми во внутренней логике, чтобы не публиковать их на стороне брокера. При росте прибыли включается поэтапная защита на трёх настраиваемых уровнях.

## Логика стратегии
### Условия входа
* **Длинная позиция** — DeMarker должен пересечь снизу вверх уровень 0.30, а линия %K стохастика на той же свече пересекает уровень 20 вверх. Оба условия отслеживаются по переходу между предыдущей завершённой свечой и текущей. При отсутствии позиции совершается рыночная покупка с указанным объёмом.
* **Короткая позиция** — зеркально: DeMarker пересекает уровень 0.70 сверху вниз, а %K опускается ниже 80. Сигнал активен только если на прошлой свече индикаторы находились по другую сторону границ. Открывается короткая позиция рыночной продажей при отсутствии позиций.

### Сопровождение сделки
* **Скрытые ограничения** — лонг закрывается, когда цена падает на величину `Hidden Stop Loss` или растёт на `Hidden Take Profit`. Для шорта условия зеркальны. Эти уровни контролируются кодом без регистрации реальных стоп-заявок.
* **Ступенчатый трейлинг** — три целевых уровня (`Target TP1`, `Target TP2`, `Target TP3`) подтягивают скрытый стоп по мере продвижения цены. Для лонга стоп переносится на максимум свечи минус `(target − 13)` пунктов; для шорта — на минимум плюс `(target + 13)` пунктов. Каждая ступень срабатывает только один раз и не ослабляется.
* **Закрытие по трейлингу** — после активации хотя бы одной ступени касание стопа приводит к закрытию позиции рыночным ордером.

### Дополнительные механизмы
* Размер пункта определяется автоматически по шагу цены инструмента, корректно обрабатывая четырёх- и пятизначные валютные котировки (а также трёх- и двухзначные кроссы).
* Индикаторы и сигналы рассчитываются на выбранном типе свечей (по умолчанию пятиминутные). Обрабатываются только завершённые свечи.

## Параметры
* **Hidden Take Profit** — скрытая дистанция тейк-профита в пунктах (по умолчанию `60`).
* **Hidden Stop Loss** — скрытая дистанция стоп-лосса в пунктах (по умолчанию `30`).
* **Target TP1 / TP2 / TP3** — уровни фиксации прибыли, активирующие ступени трейлинга (по умолчанию `20`, `35`, `50`).
* **Order Volume** — объём рыночных заявок при входе (по умолчанию `0.2`).
* **DeMarker Length** — период усреднения индикатора DeMarker (по умолчанию `14`).
* **Stochastic Length** — базовый период стохастика (по умолчанию `5`).
* **Stochastic %K** — сглаживание линии %K (по умолчанию `3`).
* **Stochastic %D** — сглаживание линии %D (по умолчанию `3`).
* **Candle Type** — таймфрейм расчётов (по умолчанию пятиминутные свечи).

## Дополнительная информация
* Стратегия работает только с одной позицией и не переворачивается немедленно — новый вход возможен после закрытия текущей сделки.
* Защитные уровни реализованы через рыночные заявки, поэтому стопы отсутствуют в стакане заявок.
* В пакете представлена только реализация на C#; версия на Python не поставляется.
