# Cash Machine 5 min Legacy

## 概述
Cash Machine 5 min Legacy 是将 MetaTrader 4 智能交易系统 `CashMachine_5min` 迁移到 StockSharp 的版本。策略在五分钟 K 线上结合 DeMarker 指标与快速随机指标的反转信号。当仓位开启后，保护性的止损和止盈仅在策略内部跟踪，不会向经纪商暴露，同时在三个可配置的利润目标上逐步收紧止损。

## 策略逻辑
### 入场条件
* **做多**——当上一根已完成 K 线的 DeMarker 低于 0.30 而当前值上穿 0.30，并且随机指标 %K 线同时从 20 下方上穿 20 时触发。仅在当前无持仓时按设置的交易量市价买入。
* **做空**——与做多对称：DeMarker 从 0.70 上方跌破 0.70，且 %K 线从 80 上方跌破 80。只有在上一根 K 线位于阈值另一侧时信号才有效，策略在空仓时市价卖出开空。

### 仓位管理
* **隐藏风险阈值**——多头在价格下跌到 `Hidden Stop Loss` 点数或上涨到 `Hidden Take Profit` 点数时平仓；空头使用镜像条件。这些水平仅在代码中监控，不会发送真实的止损单。
* **分段式拖尾**——三个目标 (`Target TP1`、`Target TP2`、`Target TP3`) 会在价格到达时上调或下调隐藏止损。多头触发后，将止损抬至当前最高价减去 `(target − 13)` 点；空头则将止损压至当前最低价加上 `(target + 13)` 点。每个阶段只执行一次且不会放松。
* **拖尾执行**——一旦任意阶段被激活，只要价格触及拖尾止损就会立即用市价单平仓。

### 辅助机制
* 策略会根据交易品种的最小报价步长自动估算“点”的大小，适配 4/2 位和 5/3 位的外汇报价。
* 指标运算基于所选的蜡烛类型（默认五分钟），仅处理已完成的 K 线。

## 参数
* **Hidden Take Profit**——隐藏的止盈距离（点，默认 `60`）。
* **Hidden Stop Loss**——隐藏的止损距离（点，默认 `30`）。
* **Target TP1 / TP2 / TP3**——触发拖尾的利润目标（点，默认 `20`、`35`、`50`）。
* **Order Volume**——开仓所使用的市价单手数（默认 `0.2`）。
* **DeMarker Length**——DeMarker 指标的计算周期（默认 `14`）。
* **Stochastic Length**——随机指标的基础周期（默认 `5`）。
* **Stochastic %K**——%K 线平滑系数（默认 `3`）。
* **Stochastic %D**——%D 线平滑系数（默认 `3`）。
* **Candle Type**——用于计算的 K 线类型（默认五分钟）。

## 其他说明
* 策略一次只持有一个方向的仓位，不会立即反手，必须等待当前仓位平仓后才会响应下一个信号。
* 风险控制通过代码内的市价平仓完成，盘口中不会出现真实的止损挂单。
* 本包仅提供 C# 实现，不包含 Python 版本。
