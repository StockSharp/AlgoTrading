# BreakRevert Pro 策略

BreakRevert Pro 是 MetaTrader 5 专家顾问 *BreakRevertPro.mq5* 的 StockSharp 版本。策略将 1 分钟级别的突破筛选与 15 分钟和 1 小时级别的趋势、波动率分析结合在一起。原始 EA 中的概率指标通过高层 API 指标进行了等效近似，从而在遵守 StockSharp 架构的同时最大限度地保留原有思路。

## 核心逻辑

1. **主周期（1 分钟）**
   - ATR 估算当前的日内波动幅度。
   - 收盘价的移动平均用于衡量短期趋势。
   - 第二条移动平均统计大幅波动出现的频率，等效于原程序中的泊松突破概率。
   - 绝对价差的指数移动平均提供指数型概率，用于安全过滤器。
2. **确认周期（15 分钟）**
   - 简单移动平均刻画中期方向，阻止逆势交易。
3. **背景周期（1 小时）**
   - 小时级别的最高价与最低价范围决定整体波动环境，并帮助判断区间行情是否适合做反转。

当泊松与“魏布尔”代理概率高于突破阈值，同时 M1 与 M15 趋势向上、H1 波动率放大时，策略通过市价单开多；当概率下降至均值回归阈值以下且 H1 趋势趋于平缓时，策略通过市价单开空，博弈价格回到区间。市价执行与原始 MT5 顾问保持一致。

## 风险控制

- `TradeDelaySeconds` 设定交易之间的最小时间间隔，避免过度交易。
- `MaxPositions` 限制同向持仓数量。若出现反向信号，会一次性平掉旧仓并建立新仓位。
- 头寸规模根据账户余额、ATR 以及 `RiskPerTrade` 参数动态计算。若无法得到合理结果，则回退到品种的最小交易步长。
- `EnableSafetyTrade` 可在验证环境中打开，确保在没有信号时也能生成最少一笔交易。方向依据 M1 与 M15 趋势之和。
- `StartProtection()` 启用 StockSharp 的保护机制，防止连接异常造成的悬挂仓位。

## 参数说明

| 参数 | 含义 |
|------|------|
| `RiskPerTrade` | 每笔交易的风险百分比，用于计算下单手数。 |
| `LookbackPeriod` | 参与所有移动统计的历史蜡烛数量。 |
| `BreakoutThreshold` | 触发突破入场所需的最低综合概率。 |
| `MeanReversionThreshold` | 允许执行均值回归空单的最高概率。 |
| `TradeDelaySeconds` | 连续入场之间的最小秒数。 |
| `MaxPositions` | 最大持仓数量（对多空皆适用）。 |
| `EnableSafetyTrade` | 是否在无信号时启用安全性交易。 |
| `SafetyTradeIntervalSeconds` | 安全性交易检查间隔。 |
| `CandleType` | 主数据周期（默认 1 分钟）。 |

## 使用建议

1. 在具备 1 分钟行情的品种上运行，StockSharp 会自动聚合 15 分钟与 1 小时数据。
2. 若需要固定手数，可直接设置 `Volume`；否则系统会按照风险百分比自动计算。
3. 根据交易品种调整阈值与周期。高波动市场适合提高阈值以减少假突破。
4. 常规实盘通常无需安全性交易功能，它主要用于验证或回测环境。

该移植方案保留了“突破 + 回归”双重策略的核心思想，并充分利用 StockSharp 高层 API 的优势，方便测试与部署。
