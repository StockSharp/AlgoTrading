# BreakRevert Pro Стратегия

BreakRevert Pro — это конверсия советника MetaTrader 5 *BreakRevertPro.mq5* на платформу StockSharp. Алгоритм объединяет импульсные пробои на минутных свечах с анализом тренда и волатильности по таймфреймам M15 и H1. Вероятностные оценки из оригинала воспроизведены через индикаторы высокого уровня, что позволяет максимально точно повторить логику при строгом соблюдении архитектуры StockSharp.

## Логика работы

1. **Основной таймфрейм M1**
   - Индикатор ATR оценивает текущую внутридневную волатильность.
   - Скользящая средняя по закрытиям формирует локальное направление.
   - Вторая скользящая средняя считает долю свечей с резким движением — это аналог пуассоновской вероятности пробоя.
   - Экспоненциальная средняя от модулей ценовых изменений отвечает за экспоненциальную «вероятность» из блока фильтра безопасности.
2. **Подтверждение по M15**
   - Простая скользящая средняя отслеживает среднесрочный тренд и запрещает входы против доминирующего направления.
3. **Контекст по H1**
   - Часовые свечи предоставляют диапазон волатильности и глобальный тренд, необходимые для проверки условий пробоя и возврата в диапазон.

Когда пуассоновская и «вейбулловская» оценки превышают порог пробоя, а тренд на M1 и M15 направлен вверх при повышенной волатильности H1, стратегия покупает по рынку. Если вероятности падают ниже порога возврата и тренд на H1 почти горизонтальный, выполняется короткая продажа для отработки обратного движения. Рыночные заявки сохраняют мгновенный стиль исполнения исходного эксперта.

## Управление рисками

- Задержка между сделками (`TradeDelaySeconds`) предотвращает чрезмерную активность и дает рынку время стабилизироваться.
- Параметр `MaxPositions` ограничивает суммарное количество одновременных позиций. При смене направления текущая позиция закрывается и открывается новая рыночная сделка.
- Динамический расчет объема использует баланс портфеля, ATR и долю риска `RiskPerTrade`, чтобы подобрать консервативный размер. При невозможности расчета применяется минимальный шаг объема инструмента.
- Опциональные защитные сделки (`EnableSafetyTrade`) предназначены для валидационных запусков, где требуется хотя бы одна сделка. Направление выбирается по сумме трендов M1 и M15.
- Вызов `StartProtection()` активирует системную защиту StockSharp и страхует от неуправляемых позиций при сбоях связи.

## Настройки

| Параметр | Описание |
|----------|----------|
| `RiskPerTrade` | Доля капитала в процентах, используемая при расчете объема сделки. |
| `LookbackPeriod` | Количество свечей, участвующих в скользящих расчетах на всех таймфреймах. |
| `BreakoutThreshold` | Минимальная совокупная вероятность для открытия сделки на пробой. |
| `MeanReversionThreshold` | Максимальная вероятность, допускающая сделки на возврат в диапазон. |
| `TradeDelaySeconds` | Минимальная пауза между входами в сделку. |
| `MaxPositions` | Максимальное число открытых позиций (для обоих направлений). |
| `EnableSafetyTrade` | Включает обязательные защитные сделки при отсутствии сигналов. |
| `SafetyTradeIntervalSeconds` | Интервал между проверками условия защитной сделки. |
| `CandleType` | Основной тип свечей (по умолчанию минутные). |

## Рекомендации по использованию

1. Запускайте стратегию на инструментах с доступными минутными котировками. StockSharp автоматически агрегирует данные для M15 и H1.
2. При необходимости фиксированного объема установите свойство `Volume`. В противном случае применяется динамический расчет по риску.
3. Подбирайте пороги и период анализа под конкретный инструмент: для высоковолатильных рынков увеличивайте пороги, чтобы уменьшить число ложных пробоев.
4. Для живой торговли обычно отключайте защитные сделки — они нужны главным образом для тестовых запусков и процедур валидации.

Конверсия сохранила гибридную природу стратегии «пробой + возврат», одновременно опираясь на высокоуровневые инструменты StockSharp для удобного тестирования и эксплуатации.
