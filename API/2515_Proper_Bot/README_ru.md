# Стратегия Proper Bot

## Обзор
**Proper Bot** – сеточная торговая система, перенесённая из советника MetaTrader 4 "Proper Bot". Стратегия запускает направленный портфель ордеров, расширяет его по заранее заданной карте расстояний и объёмов и управляет всем циклом с помощью фильтров по времени, объёму и цене. Реализация на C# использует высокоуровневые подписки на свечи и индикаторы StockSharp.

## Логика работы
1. **Определение сигнала**
   - При активном EMA-фильтре стратегия рассчитывает три экспоненциальные средние на выбранной серии свечей. Пересечение быстрой и медленной средних задаёт направление, а средняя линия блокирует неподтверждённые сигналы.
   - При отключенном фильтре используется направление тела предыдущей завершённой свечи.
2. **Предторговые фильтры**
   - Простое скользящее среднее объёма контролирует минимальный допустимый уровень активности.
   - Торговля доступна только внутри заданного торгового окна.
   - Ценовые уровни `HighLevel` и `LowLevel` запрещают покупки слишком высоко и продажи слишком низко; выход цены за пределы уровней может принудительно открыть позицию в соответствующем направлении.
3. **Расширение сетки**
   - Первую сделку стратегия открывает объёмом `FirstVolume`. Дальнейшие приращения соответствуют парам `расстояние/объём` из строки `GridMap`. Как только цена проходит против текущей позиции указанное количество пунктов, добавляется новый ордер заданного объёма.
   - Расстояния переводятся в цену через шаг цены инструмента (`PriceStep`). Если значение недоступно, используется 0.0001.
4. **Управление рисками**
   - Вся сетка разделяет общий тейк-профит и стоп-лосс, рассчитываемые от взвешенной средней входа.
   - Суммарная плавающая прибыль контролируется трейлинг-алгоритмом: после достижения порога любое снижение прибыли больше `TrailStepPoints` закрывает все позиции.
   - При срабатывании любого условия выхода стратегия закрывает весь портфель рыночным ордером и сбрасывает состояние сетки.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `FastMaPeriod` | Период быстрой EMA в фильтре входа. | 10 |
| `MidMaPeriod` | Период промежуточной EMA; 0 отключает фильтр. | 25 |
| `SlowMaPeriod` | Период медленной EMA в фильтре входа. | 50 |
| `DisableMaFilter` | Игнорировать EMA и следовать направлению предыдущей свечи. | true |
| `VolumePeriod` | Число свечей в среднем объёма; 0 отключает фильтр. | 1 |
| `VolumeMinimum` | Минимальный средний объём для открытия позиций. | 69 |
| `HighLevel` | Уровень, выше которого покупки запрещены и возможна принудительная продажа. | 1.50001 |
| `LowLevel` | Уровень, ниже которого продажи запрещены и возможна принудительная покупка. | 1.40001 |
| `FirstVolume` | Объём первого ордера в каждом цикле сетки. | 0.08 |
| `GridMap` | Список пар `расстояние/объём`, разделённых пробелами, задающих шаги сетки. | `120/0.1 ... 120/0.19` |
| `TakeProfitPoints` | Расстояние тейк-профита (в шагах цены) для общего портфеля. | 10000 |
| `StopLossPoints` | Расстояние стоп-лосса (в шагах цены) для общего портфеля. | 30000 |
| `TrailStartPoints` | Минимальная прибыль для активации трейлинг-контроля. | 52 |
| `TrailDistancePoints` | Прибыль, которую нужно набрать (минус шаг трейлинга), чтобы запустить сопровождение. | 52 |
| `TrailStepPoints` | Допустимая отдача прибыли после активации трейлинга. | 2 |
| `StartHour` / `StartMinute` | Начало торговой сессии (включительно). | 06:00 |
| `FinishHour` / `FinishMinute` | Конец торговой сессии (включительно, допускает переход через ночь). | 21:00 |
| `CandleType` | Тип свечей, обрабатываемых стратегией. | Таймфрейм 1 минута |

## Практические замечания
- `GridMap` анализируется в инвариантной культуре: до косой черты указываются пункты, после – объём.
- Все дистанции преобразуются через `PriceStep` инструмента. Перед запуском убедитесь, что шаг цены задан корректно.
- Трейлинг оценивает суммарную плавающую прибыль по завершённым свечам. Для более оперативных выходов используйте более мелкий таймфрейм.
- Принудительные входы на пробое уровней используют цену закрытия свечи как приближение bid/ask.
- В отличие от MT4-версии, порт на StockSharp закрывает весь портфель при выполнении условий тейка, стопа или трейлинга, упрощая управление через высокоуровневый API.

## Отличия от версии MT4
- В MT4 каждому ордеру назначались индивидуальные защитные уровни; здесь расчёт ведётся по агрегированной позиции.
- Bid/ask оцениваются по цене закрытия свечи, так как свечные данные не содержат спредов.
- Порог активации трейлинга равен максимуму между `TrailDistancePoints - TrailStepPoints` и `TrailStartPoints`, что стабилизирует работу при пересечении параметров.
- Торговые часы привязаны к `DateTimeOffset` свечи. Убедитесь, что источник данных выдаёт время в нужной зоне.

## Файлы
- `CS/ProperBotStrategy.cs` – реализация стратегии.
- `README.md` – описание на английском.
- `README_cn.md` – описание на китайском.
- `README_ru.md` – описание на русском (этот файл).

