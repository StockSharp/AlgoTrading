# Proper Bot 策略

## 概述
**Proper Bot 策略** 是从 MetaTrader 4 的 "Proper Bot" 智能交易系统移植而来的网格化交易模型。策略通过初始方向性头寸启动一个订单篮子，根据可配置的距离/手数映射逐步加仓，并结合时间、成交量与价格过滤器管理整个交易周期。该 C# 版本基于 StockSharp 的高级蜡烛订阅与指标接口实现。

## 工作原理
1. **信号判定**
   - 当启用 EMA 过滤器时，策略在选定的蜡烛序列上计算快、中、慢三条指数移动平均线。快线与慢线的交叉决定方向，中线用于过滤尚未确认的趋势信号。
   - 当关闭过滤器时，算法直接使用上一根已完成蜡烛的实体方向。
2. **交易前过滤**
   - 使用成交量的简单移动平均，只有当平均值高于阈值时才允许进场。
   - 交易仅在配置的会话起止时间内执行。
   - 价格高于 `HighLevel` 时阻止做多，低于 `LowLevel` 时阻止做空；极端突破这些边界会强制产生对应方向的信号。
3. **网格扩张**
   - 初始市价单使用 `FirstVolume` 参数。之后的加仓按照 `GridMap` 中的 "距离/手数" 对逐级执行，当价格相对当前方向回撤到指定距离时，按映射手数加仓。
   - 距离以交易品种的 `PriceStep` 转换为价格差；若未提供步长则使用 0.0001 作为默认值。
4. **风险管理**
   - 整个订单篮子共享基于加权平均持仓价的整体止盈与止损距离。
   - 浮动利润累计到激活阈值后启动跟踪止盈，只要回撤超过 `TrailStepPoints` 就平仓所有持仓。
   - 任一退出条件触发时，策略通过市价单平掉整个网格并重置状态。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `FastMaPeriod` | 进场过滤使用的快 EMA 长度。 | 10 |
| `MidMaPeriod` | 可选中间 EMA 长度，必须位于快慢线之间才确认信号，设为 0 可禁用。 | 25 |
| `SlowMaPeriod` | 进场过滤使用的慢 EMA 长度。 | 50 |
| `DisableMaFilter` | 启用后忽略 EMA 条件，直接跟随上一根蜡烛方向。 | true |
| `VolumePeriod` | 成交量平均周期，设为 0 表示不启用。 | 1 |
| `VolumeMinimum` | 允许开仓的最小平均成交量。 | 69 |
| `HighLevel` | 高于此价格禁止做多，并可能触发做空。 | 1.50001 |
| `LowLevel` | 低于此价格禁止做空，并可能触发做多。 | 1.40001 |
| `FirstVolume` | 每次网格循环的第一笔订单手数。 | 0.08 |
| `GridMap` | 用空格分隔的 `距离/手数` 列表，定义加仓触发距离和对应手数。 | `120/0.1 ... 120/0.19` |
| `TakeProfitPoints` | 应用于整体仓位加权成本的止盈距离（以价格步长计）。 | 10000 |
| `StopLossPoints` | 应用于整体仓位加权成本的止损距离（以价格步长计）。 | 30000 |
| `TrailStartPoints` | 启动跟踪止盈前所需的最小浮盈。 | 52 |
| `TrailDistancePoints` | 激活跟踪止盈所需的利润距离（减去跟踪步长）。 | 52 |
| `TrailStepPoints` | 跟踪止盈允许的最大利润回吐。 | 2 |
| `StartHour` / `StartMinute` | 交易会话起始时间（含）。 | 06:00 |
| `FinishHour` / `FinishMinute` | 交易会话结束时间（含，可跨夜）。 | 21:00 |
| `CandleType` | 策略处理的蜡烛数据类型。 | 1 分钟时间框架 |

## 使用说明
- `GridMap` 采用不变文化格式解析，请在斜杠前输入点数距离，在斜杠后输入手数。
- 所有止盈、止损与跟踪参数均会依据品种的 `PriceStep` 转换为实际价格差。运行前请确认证券对象的步长设置正确。
- 跟踪止盈按照所有持仓的浮动利润之和工作，并在蜡烛收盘时检查；如需更快退出可使用更小的时间框架。
- `HighLevel` 与 `LowLevel` 触发的强制进场使用蜡烛收盘价近似买卖价差。
- 与 MT4 版本不同，本实现检测到止盈、止损或跟踪条件时会一次性平掉全部仓位，便于使用高级 API 管理订单。

## 与 MT4 版本的差异
- MT4 版本为每个订单单独设置保护价位，StockSharp 版本则针对组合头寸计算统一的退出点。
- 由于蜡烛订阅默认不包含逐笔价差，买卖价使用蜡烛收盘价近似。
- 跟踪退出的激活阈值取 `TrailDistancePoints - TrailStepPoints` 与 `TrailStartPoints` 中较大者，以保证参数重叠时的稳定性。
- 交易时段依据蜡烛的 `DateTimeOffset`，请确保数据源时间符合预期时区。

## 文件
- `CS/ProperBotStrategy.cs` – 策略实现。
- `README.md` – 英文说明。
- `README_cn.md` – 中文说明（本文）。
- `README_ru.md` – 俄文说明。

