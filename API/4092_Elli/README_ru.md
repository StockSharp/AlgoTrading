# Стратегия Elli

## Обзор
Стратегия Elli переносит советник MetaTrader 4 «Elli» на высокоуровневый API StockSharp. В оригинале робот сочетал структуру Ichimoku Kinko Hyo на часовом таймфрейме и фильтр ADX на младшем периоде, дополняя их жёстким управлением рисками. При конверсии сохранены те же правила направленного отбора, ручные модификации ордеров заменены на `StartProtection`, а все настройки вынесены в `StrategyParam<T>`, чтобы параметры можно было оптимизировать и менять на лету.

## Логика торговли
1. **Трендовая структура Ichimoku**
   - Подписка на свечи таймфрейма `CandleType` (по умолчанию H1) и расчёт линий Tenkan, Kijun и Senkou по исходным периодам 19/60/120.
   - Сигнал на покупку требует соблюдения цепочки Tenkan > Kijun > Senkou Span A > Senkou Span B и закрытия свечи выше Kijun. Для продаж условия зеркальные.
   - Абсолютное расстояние между Tenkan и Kijun должно быть больше `TenkanKijunGapPips` пунктов, что отсекает плоские облака.
2. **Подтверждение Directional Movement**
   - Вторая подписка запускает индикатор Average Directional Index на таймфрейме `AdxCandleType` (по умолчанию M1).
   - Лонг разрешён только если предыдущий +DI меньше `ConvertLow`, а текущий +DI превышает `ConvertHigh`. Для шорта аналогично проверяется −DI. Тем самым воспроизводится ускорение, проверяемое через `iADX` в МQL.
3. **Исполнение входов**
   - При выполнении условий отправляется рыночная заявка объёмом `OrderVolume + |Position|`, что сначала закрывает обратную позицию и затем открывает новую.
   - В любой момент времени допускается только одно направленное удержание, как и в оригинале с проверкой `OrdersTotal() < 1`.
4. **Управление риском**
   - `StartProtection` добавляет симметричные стоп-лосс и тейк-профит, переводя расстояния в пунктах в абсолютные цены с учётом размера пункта инструмента.
   - Дальнейшее сопровождение позиции передано защитным ордерам, что соответствует поведению советника MT4.

## Индикаторы и подписки
- Основные свечи: `CandleType` (по умолчанию часовой график) для расчёта Ichimoku.
- Свечи ADX: `AdxCandleType` (по умолчанию минутный график) для контроля +DI/−DI.
- Индикаторы: `Ichimoku` (Tenkan, Kijun, Senkou Span B) и `AverageDirectionalIndex` (возвращает компоненты +DI/−DI).
- При наличии области графика стратегия отображает свечи, индикаторы и собственные сделки.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `OrderVolume` | `1` | Базовый объём рыночных заявок. |
| `TakeProfitPips` | `60` | Дистанция до тейк-профита в пунктах. |
| `StopLossPips` | `30` | Дистанция до стоп-лосса в пунктах. |
| `TenkanPeriod` | `19` | Период линии Tenkan-sen. |
| `KijunPeriod` | `60` | Период линии Kijun-sen. |
| `SenkouSpanBPeriod` | `120` | Период Senkou Span B для облака Ichimoku. |
| `TenkanKijunGapPips` | `20` | Минимальное расстояние между Tenkan и Kijun в пунктах. |
| `ConvertHigh` | `13` | Порог DI, который должен превысить текущее значение. |
| `ConvertLow` | `6` | Порог DI, ниже которого должно находиться предыдущее значение. |
| `AdxPeriod` | `10` | Период расчёта ADX. |
| `CandleType` | `H1` | Таймфрейм для логики Ichimoku. |
| `AdxCandleType` | `M1` | Таймфрейм для расчёта ADX и DI. |

Все параметры реализованы через `StrategyParam<T>`, поэтому доступны для оптимизации и изменения в Designer.

## Особенности реализации
- Перевод пунктов учитывает особенности форекс-котировок (0.0001 для пятизнака и 0.01 для трёхзнака), что сохраняет исходные пороги.
- Значения ADX кэшируются в полях `_latestPlusDi`, `_previousPlusDi`, `_latestMinusDi`, `_previousMinusDi`, повторяя обращения `iADX` со сдвигами 0 и 1.
- Вызов `IsFormedAndOnlineAndAllowTrading()` гарантирует, что торговля начинается только после прогрева данных и индикаторов.
- При входе объём вычисляется как `Volume + Math.Abs(Position)`, благодаря чему стратегия автоматически переворачивается и поддерживает единственную позицию.
