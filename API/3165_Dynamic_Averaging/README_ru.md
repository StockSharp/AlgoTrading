# Стратегия Dynamic Averaging

## Обзор
Dynamic Averaging — перенос эксперта MetaTrader 5 «Dynamic averaging.mq5» (id 23319). Стратегия объединяет быстрый стохастик с фильтром волатильности на основе стандартного отклонения. Сделки разрешены только тогда, когда текущая волатильность не превышает сглаженное среднее, что заставляет входить в рынок во время консолидаций, где развороты стохастика более надёжны.

## Параметры
- **TradeVolume** — базовый объём заявки. После убыточной серии автоматически удваивается, при прибыльной или безубыточной — возвращается к исходному значению.
- **MinimumProfit** — размер плавающей прибыли (в валюте счёта), при достижении которого все позиции закрываются.
- **SlidingWindowDays** — количество календарных дней, используемых для усреднения значений стандартного отклонения и построения эталона волатильности.
- **StochasticKPeriod** — число баров для расчёта линии %K.
- **StochasticDPeriod** — период сглаживания линии %D.
- **StochasticSlowPeriod** — финальное сглаживание стохастика.
- **StdDevPeriod** — длина окна стандартного отклонения.
- **CandleType** — тип свечей, применяемый для расчётов (по умолчанию 15-минутный таймфрейм).

## Правила торговли
1. Работа ведётся только по завершённым свечам. После закрытия бара индикаторы обновляются через `SubscribeCandles().BindEx`.
2. Рассчитывается текущее стандартное отклонение (`StandardDeviation(StdDevPeriod)`) и сравнивается с его средним значением за `SlidingWindowDays`, вычисленным через `SimpleMovingAverage`.
3. Если волатильность выше среднего значения, бар пропускается.
4. При спокойном рынке:
   - Открывается **лонг**, когда %K опускается ниже 25 и наклон между двумя предыдущими значениями %K положительный (разница между %K[1] и %K[2] больше нуля).
   - Открывается **шорт**, когда %K поднимается выше 75 и наклон между предыдущими значениями отрицательный.
5. При смене направления выставляется объём, достаточный для закрытия противоположной позиции и открытия новой экспозиции с объёмом `TradeVolume`.
6. Если плавающая прибыль превышает `MinimumProfit`, позиция немедленно закрывается.

## Управление объёмом и восстановление
- Начальный объём равен `TradeVolume`.
- После закрытия позиции анализируется изменение реализованного PnL.
  - **Убыток** приводит к удвоению объёма следующей сделки (шаг мартингейла), повторяя оригинальную логику советника.
  - **Прибыль или ноль** возвращают объём к базовому значению.

## Особенности реализации
- Свечи, стохастик и стандартное отклонение обрабатываются высокоуровневым API через `BindEx`, что избавляет от ручного копирования буферов.
- Окно волатильности переводит календарные дни в количество баров с учётом таймфрейма свечей.
- Контроль плавающей прибыли опирается на цену закрытия текущей свечи и `PositionAvgPrice`, повторяя MQL-версию, которая учитывает только прибыль по открытым позициям.
- Комментарии в коде написаны на английском языке; версия на Python не создавалась по требованию задания.
