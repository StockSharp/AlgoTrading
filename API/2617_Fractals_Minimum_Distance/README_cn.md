# 分形最小距离策略

## 概述
分形最小距离策略在 StockSharp 高层 API 中重现 MetaTrader 专家顾问“Fractals minimum distance”的逻辑。策略订阅所选的 K 线序列，在每根新 K 线结束后检查信号栏位（`SignalBar`）处是否生成了新的比尔·威廉姆斯五根 K 线分形。只有当最新的上分形和下分形之间的间距（以点数 `DistancePips` 表示）达到要求时才允许开仓。

该移植版本保留了原程序在入场前先平掉反向仓位的处理方式，并同样不设置止损或止盈。与 MQL 版本不同的是，仓位大小不再根据账户风险计算，而是直接使用策略的 `Volume` 属性。

## 信号逻辑
1. 根据 `CandleType` 订阅蜡烛数据，并维护一个滑动窗口，窗口中总能包含信号栏位以及其左右各两个邻近的高低点。
2. 当窗口中心的最高价大于前两根和后两根 K 线的最高价时确认上分形；当中心的最低价小于左右两侧各两根 K 线的最低价时确认下分形。
3. 将 `DistancePips` 乘以交易品种的 `PriceStep` 转换为实际价格距离。对于三位或五位小数报价，会自动将 0.001/0.00001 视为一个点。
4. 确认上分形时：
   - 记录新的上分形价位，并平掉所有多头仓位。
   - 若最近的上下分形之间的距离不小于阈值，并且策略允许交易，则按 `Volume` 下市价卖单。
5. 确认下分形时：
   - 记录新的下分形价位，并平掉所有空头仓位。
   - 在满足距离条件时按 `Volume` 下市价买单。

所有判断都在 K 线收盘后执行，因此尚未完成的 K 线不会触发信号。策略依赖 `IsFormedAndOnlineAndAllowTrading()` 来确认终端已准备就绪。

## 参数说明
| 参数 | 含义 | 备注 |
| --- | --- | --- |
| `DistancePips` | 最近上分形与下分形之间的最小间距，单位为点（pip）。 | 会根据 `PriceStep` 自动转换为价格单位。 |
| `SignalBar` | 信号分形所在的历史 K 线距离当前的根数。 | 实际有效的最小值为 2，符合分形左右各两根 K 线的定义。 |
| `CandleType` | 用于计算的蜡烛数据类型。 | 默认是一分钟 K 线，可根据需要改为其他周期。 |
| `Volume` | 交易量，来自 Strategy 基类的属性。 | 取代原专家顾问的风险比例开仓方式。 |

## 与 MQL 版本的差异
- 继续在反向开仓前平掉已有仓位，与源代码中的 `ClosePositions` 函数一致。
- 原程序中的 `RefreshRates`、滑点设置和下单验证交由 StockSharp 的撮合层处理。
- 没有添加止损/止盈逻辑，以保持与原版一致。
- `DistancePips` 和 `SignalBar` 分别对应 MQL 的 `ushort` 与 `uchar` 输入，保留整型语义。
- StockSharp 采用净头寸模式，因此反向下单会直接翻转仓位，行为与 MetaTrader 净额账户相符。

## 使用建议
- 起步时可使用默认的 `SignalBar = 3`，再根据交易品种波动性调整 `DistancePips`。
- 若市场波动较大，可增加 `SignalBar` 以等待更多确认蜡烛，从而减少噪音信号。
- 如需风控保护，可结合 `StartProtection()` 等平台级风控工具。
