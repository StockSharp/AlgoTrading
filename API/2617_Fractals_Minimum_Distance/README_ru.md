# Fractals Minimum Distance

## Обзор
Стратегия Fractals Minimum Distance переносит советник MetaTrader «Fractals minimum distance» на высокоуровневый API StockSharp. Алгоритм подписывается на выбранный поток свечей и после закрытия каждой новой свечи проверяет, сформировался ли на баре с отступом `SignalBar` подтверждённый пятисвечный фрактал Билла Вильямса. Сделка разрешается только тогда, когда расстояние между последними верхним и нижним фракталами превышает заданный минимум `DistancePips`.

Как и оригинал, порт сначала закрывает позицию противоположного направления, а затем разворачивается. Размер лота теперь задаётся свойством стратегии `Volume`, поэтому расчёт риска от свободной маржи, присутствующий в MQL-версии, исключён. Стоп-лоссы и тейк-профиты не выставляются, что полностью соответствует исходному коду.

## Логика сигналов
1. Подписаться на свечи типа `CandleType` и поддерживать скользящее окно максимумов и минимумов, в котором всегда присутствует бар с указанным отступом и два соседних бара с каждой стороны.
2. Верхний фрактал считается подтверждённым, если максимум центрального бара больше максимумов двух предыдущих и двух последующих свечей. Аналогично определяется нижний фрактал по минимумам.
3. Значение `DistancePips` переводится в ценовое расстояние через `PriceStep`. Для инструментов с тремя или пятью знаками после запятой автоматически применяется множитель 10, чтобы 0.001 и 0.00001 интерпретировались как один пункт.
4. При появлении верхнего фрактала:
   - Сохранить новое значение и закрыть все длинные позиции.
   - Если оба последних фрактала известны и их разница не меньше порога, отправить рыночную заявку на продажу объёмом `Volume`.
5. При появлении нижнего фрактала:
   - Сохранить уровень и закрыть короткие позиции.
   - При выполнении условия дистанции отправить рыночную заявку на покупку объёмом `Volume`.

Обработка выполняется только после получения свечи в состоянии `Finished`, поэтому незавершённые бары не приводят к входам. Перед подачей заявок дополнительно проверяется `IsFormedAndOnlineAndAllowTrading()`, чтобы убедиться в готовности окружения.

## Параметры
| Параметр | Описание | Примечание |
| --- | --- | --- |
| `DistancePips` | Минимальное расстояние между последними верхним и нижним фракталами в пунктах. | Внутри переводится в абсолютное ценовое значение с учётом шага цены инструмента. |
| `SignalBar` | Количество закрытых свечей между текущим моментом и баром, на котором должен находиться фрактал. | Эффективный минимум — 2, что соответствует определению фрактала у Вильямса. |
| `CandleType` | Тип свечей, используемых для расчётов. | По умолчанию минутные свечи, но можно выбрать любой другой таймфрейм. |
| `Volume` | Стандартный объём сделок стратегии. | Замещает расчёт риска и объёма из MQL-реализации. |

## Отличия от MQL-версии
- Закрытие противоположных позиций реализовано теми же рыночными ордерами, что и функция `ClosePositions` в исходнике.
- Вызовы `RefreshRates`, задание проскальзывания и ручные проверки объёма делегированы инфраструктуре StockSharp.
- Ограничения по риску (SL/TP) отсутствуют, как и в оригинальном коде.
- Параметры `DistancePips` и `SignalBar` сохраняют целочисленные значения, соответствующие типам `ushort` и `uchar` из MQL.
- StockSharp использует неттинговую модель, поэтому противоположная заявка автоматически переворачивает позицию, что повторяет поведение MetaTrader на неттинговых счетах.

## Рекомендации по применению
- Начинайте с стандартного значения `SignalBar = 3`, затем адаптируйте `DistancePips` под волатильность конкретного инструмента.
- Увеличение `SignalBar` позволяет дождаться большего числа подтверждающих свечей и снизить количество ложных сигналов.
- При необходимости защитить позицию комбинируйте стратегию с сервисами управления риском StockSharp, например `StartProtection()`.
