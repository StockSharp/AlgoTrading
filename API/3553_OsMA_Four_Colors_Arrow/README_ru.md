# Стратегия OsMA Four Colors Arrow

## Обзор

Стратегия переносит советник MetaTrader «OsMA Four Colors Arrow» в инфраструктуру StockSharp. В оригинале точки входа генерируются стрелками одноимённого индикатора, который отслеживает смену фаз гистограммы OsMA (MACD). В версии для StockSharp то же поведение моделируется через отслеживание переходов гистограммы через ноль: переход снизу вверх формирует длинный сигнал, сверху вниз — короткий. Дополнительный режим инверсии позволяет мгновенно переключиться на контртрендовую логику.

Алгоритм работает только по закрытым свечам и может ограничивать торговлю дневным временным окном, как это делалось в MQL-варианте. Встроенное управление позицией включает настраиваемый объём сделки, ограничение общего размера позиции и автоматическое сопровождение стоп-лосс/тейк-профит/трейлинг-стопа в пипсах.

## Логика торговли

1. Подписка на выбранный таймфрейм и расчёт гистограммы MACD (OsMA) с настраиваемыми периодами EMA.
2. После закрытия свечи проверяется знак гистограммы:
   - Переход гистограммы в положительную область ⇒ «бычья» стрелка ⇒ сигнал на покупку.
   - Переход в отрицательную область ⇒ «медвежья» стрелка ⇒ сигнал на продажу.
3. Перед отправкой заявки применяются дополнительные фильтры:
   - Ограничение направления (только покупки, только продажи либо обе стороны).
   - Инверсия сигналов.
   - Закрытие встречной позиции перед открытием новой.
   - Запрет усреднения при включённом параметре «OnlyOnePosition» и контроль общего лимита позиций.
4. Рыночные заявки отправляются с заданным объёмом. Метод `StartProtection` преобразует параметры в пипсах в абсолютные цены и управляет стопами и трейлингом автоматически.
5. При активированном фильтре времени сигналы, попадающие вне торговой сессии, игнорируются.

## Параметры

| Имя | Описание |
| --- | -------- |
| `CandleType` | Таймфрейм расчётов и поиска сигналов. |
| `FastPeriod` / `SlowPeriod` / `SignalPeriod` | Периоды EMA для гистограммы MACD (OsMA). |
| `StopLossPips` / `TakeProfitPips` | Размеры стоп-лосса и тейк-профита в пипсах (0 — выключено). |
| `TrailingActivatePips` | Прибыль в пипсах, после которой включается трейлинг. |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пипсах (0 — отключено). |
| `TrailingStepPips` | Дополнительный профит для очередного подтягивания трейлинга. |
| `MaxPositions` | Максимальное количество агрегированных позиций (в объёмах `TradeVolume`). 0 — без ограничений. |
| `ReverseSignals` | Инверсия сигналов. |
| `DirectionMode` | Разрешённое направление сделок. |
| `CloseOppositePositions` | Закрывать встречную позицию перед новым входом. |
| `OnlyOnePosition` | Запрет на добавление к уже открытой позиции в том же направлении. |
| `UseTimeControl` | Включение фильтра торговых часов. |
| `StartHour`, `StartMinute`, `EndHour`, `EndMinute` | Начало и конец сессии (поддерживается переход через полуночь). |
| `TradeVolume` | Объём рыночной заявки в лотах. |

## Особенности

- Параметры трейлинг-стопа повторяют логику советника: сначала требуется пройти `TrailingActivatePips`, затем стоп подтягивается с шагом `TrailingStepPips`.
- Для корректного пересчёта пипсов инструмент должен предоставлять `PriceStep` и `Decimals`. При отсутствии данных используется единица цены.
- Если `MaxPositions` больше нуля, стратегия может наращивать позицию пакетами по `TradeVolume`, не превышая заданный предел.
- При включённом фильтре времени совпадающие значения начала и конца сессии блокируют торговлю, чтобы избежать двусмысленности.
- Работа ведётся только по закрытым свечам, что соответствует исходному MQL-советнику.
