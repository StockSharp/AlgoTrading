[English](README.md) | [中文](README_cn.md)

# MACD Four Colors 2 Martingale

Стратегия переносит советник «MACD Four Colors 2 Martingale» с платформы MetaTrader в StockSharp и сохраняет оригинальную логику, основанную на цветовом анализе MACD и мартингейле при наборе позиции.

## Общее описание

Базовый индикатор раскрашивает гистограмму MACD в пять цветов. В стандартной «новой» схеме цвет меняется в зависимости от того, растёт или падает линия MACD и находится ли она выше либо ниже нулевой линии. Советник открывает позицию, когда палитра меняется с серебристой на жёлтую (MACD остаётся ниже нуля и снова начинает падать) или с красной на синюю (MACD выше нуля и разворачивается вниз). Версия для StockSharp восстанавливает эти переходы по значениям MACD и повторяет сигналы.

Одновременно допускается только одна направленная серия сделок. Новый вход разрешён, если цена улучшает среднюю цену набранной серии: ниже для покупок и выше для продаж. Каждый следующий ордер умножает объём предыдущего заполненного ордера на коэффициент `LotCoefficient`, что реализует мартингейл из оригинального кода.

## Торговые правила

- **Логика индикатора**: используется `MovingAverageConvergenceDivergenceSignal` с классическими параметрами 12/26/9.
- **Восстановление цветов**: стратегия сравнивает два последних значения MACD. Растущий отрицательный MACD соответствует цвету 1 (серебро), растущий положительный — цвету 2 (красный), падающий положительный — цвету 3 (синий), падающий отрицательный — цвету 4 (жёлтый).
- **Вход в лонг**: сигнал формируется, когда цвета переходят с 1 на 4, а MACD на предыдущем баре остаётся ниже нуля. Сделка исполняется только при отсутствии коротких позиций и если цена ниже всех предыдущих входов в лонг.
- **Вход в шорт**: сигнал возникает при переходе цветов с 2 на 3 и положительном MACD на предыдущем баре. Сделка разрешена только при отсутствии длинных позиций и если цена выше всех открытых шортов.
- **Управление объёмом**: первый ордер использует `InitialVolume`. Каждый следующий ордер внутри серии умножает объём на `LotCoefficient`. Если коэффициент ≤ 0, усиление отключается.
- **Контроль прибыли и убытков**: плавающая прибыль пересчитывается на каждом закрытом баре. Достижение `TargetProfit` закрывает все позиции и сбрасывает цикл. Пробой `MaxDrawdown` (порог убытка) также приводит к полному выходу и перезапуску. Поддерживаются отрицательные пороги по аналогии с MQL-реализацией.
- **Выход из позиции**: кроме денежных целей автоматических стопов нет. Позиции удерживаются, пока не сработают ограничители или пока пользователь не вмешается.

## Параметры

- `CandleType` *(DataType, по умолчанию 1h)* — таймфрейм для расчёта MACD.
- `InitialVolume` *(decimal, по умолчанию 1)* — объём первого ордера в серии.
- `LotCoefficient` *(decimal, по умолчанию 2)* — множитель объёма для следующего ордера в мартингейле.
- `MaxDrawdown` *(decimal, по умолчанию 50)* — порог плавающего убытка в деньгах, при достижении которого закрываются все позиции. Положительное значение контролирует `-MaxDrawdown`, отрицательное трактуется напрямую.
- `TargetProfit` *(decimal, по умолчанию 150)* — цель по плавающей прибыли в деньгах. Отрицательное значение инвертирует сравнение, как и в версии MQL.
- `FastEmaPeriod` *(int, по умолчанию 12)* — период быстрой EMA в MACD.
- `SlowEmaPeriod` *(int, по умолчанию 26)* — период медленной EMA в MACD.
- `SignalPeriod` *(int, по умолчанию 9)* — период сигнальной EMA.

## Рекомендации по использованию

- Стратегии требуется инструмент с заданными `PriceStep` и `StepPrice`, поскольку не реализован независимый расчёт плавающего PnL.
- Мартингейл быстро наращивает объём позиции, поэтому заранее проверьте лимиты риска и маржинальные требования брокера.
- Для визуального контроля используйте создаваемую область графика: на ней отображаются свечи, MACD и сделки стратегии.

## Фильтры каталога

- **Категория**: тренд / усреднение по импульсу
- **Направление**: обе стороны (лонг и шорт)
- **Индикаторы**: MACD
- **Стопы**: только денежные цели
- **Таймфрейм**: настраиваемый (по умолчанию 1h)
- **Сложность**: средняя
- **Риск**: высокий из-за мартингейла
- **Автоматизация**: полная

