# Стратегия Flat Channel (2684)

Стратегия представляет собой перенос на C# советника MetaTrader 5 *Flat Channel (редакция barabashkakvn)*. Алгоритм выявляет периоды затухающей волатильности по индикатору Standard Deviation и строит ценовой коридор. При прорыве границ коридора выставленные отложенные ордера Buy Stop или Sell Stop активируются, а противоположный ордер снимается, чтобы не попасть в ловушку обеих сторон рынка.

## Основная логика

1. **Фильтр волатильности.** Для каждой свечи рассчитывается стандартное отклонение медианной цены. Плоский участок считается сформированным, если значение индикатора уменьшается как минимум `FlatBars` свечей подряд.
2. **Построение канала.** После подтверждения флэта фиксируются максимумы и минимумы диапазона. Ширина канала должна оставаться между порогами `ChannelMinPips` и `ChannelMaxPips` (значения пересчитываются из пунктов в цену с учётом `PriceStep`).
3. **Выставление ордеров.** Пока цена остаётся внутри канала, создаются:
   - Buy Stop на верхней границе с стоп-лоссом на расстоянии `2 × ширина канала` ниже и тейк-профитом на `1 × ширина` выше.
   - Sell Stop на нижней границе с зеркальными уровнями стоп-лосса и тейк-профита.
4. **Время жизни ордеров.** Периметр `OrderLifetimeSeconds` задаёт срок действия отложенных стоп-ордеров. По его истечении активные заявки снимаются и могут быть выставлены заново, если условия флэта сохраняются.
5. **Управление позицией.** После срабатывания стоп-ордера противоположная заявка отменяется, а для текущей позиции регистрируются защитные стоп-лосс и тейк-профит. При включённом параметре `UseBreakeven` стоп-лосс переносится в точку входа, когда цена проходит долю `FiboTrail` от расстояния до тейк-профита (Fibonacci trailing).
6. **Торговый календарь.** Флаг `UseTradingHours` ограничивает торговлю по дням недели и по времени начала/окончания сессии в понедельник/пятницу, полностью повторяя логику оригинального советника.

## Используемые индикаторы

- **StandardDeviation** по медианной цене (период = `StdDevPeriod`) — фиксирует снижение волатильности.
- **DonchianChannels** (период = `FlatBars`) — даёт начальные значения верхней и нижней границ канала.

## Риск-менеджмент

- Параметр `FixedVolume` задаёт базовый объём сделки при отключённом управлении капиталом.
- Если `UseMoneyManagement = true`, объём рассчитывается исходя из `RiskPercent` капитала и денежного эквивалента расстояния до стоп-лосса (`PriceStep` × `StepPrice`).
- После убыточной сделки следующий вход выполняется объёмом `FixedVolume × 4`, что соответствует механизму восстановления в оригинальном коде.

## Параметры

| Параметр | Назначение |
|----------|------------|
| `UseTradingHours` | Включить/выключить торговый календарь. |
| `TradeTuesday`, `TradeWednesday`, `TradeThursday` | Разрешение торговли во вторник, среду и четверг. |
| `MondayStartHour`, `FridayStopHour` | Часы начала торговли в понедельник и окончания в пятницу (формат 0–23). |
| `UseMoneyManagement`, `RiskPercent`, `FixedVolume` | Опции управления капиталом. |
| `OrderLifetimeSeconds` | Время жизни отложенных ордеров (0 = без ограничения). |
| `StdDevPeriod`, `FlatBars` | Настройки индикаторов для определения флэта. |
| `ChannelMinPips`, `ChannelMaxPips` | Минимальная и максимальная ширина канала в пунктах. |
| `UseBreakeven`, `FiboTrail` | Перевод стоп-лосса в безубыток и коэффициент Fibonacci. |
| `CandleType` | Тип/таймфрейм свечей для расчётов. |

## Дополнительные замечания

- Для корректного перевода пунктов в цену инструмент должен предоставлять `PriceStep` и `StepPrice`.
- Если стандартное отклонение перестаёт снижаться, состояние флэта сбрасывается и все отложенные заявки удаляются.
- Стоп-лосс и тейк-профит отменяются автоматически при закрытии позиции.

## Отказ от ответственности

Материал предоставлен исключительно в образовательных целях и не является торговой рекомендацией. Перед использованием стратегии на реальном рынке протестируйте её на исторических данных и убедитесь в понимании всех рисков.
