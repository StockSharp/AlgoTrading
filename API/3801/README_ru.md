# Стратегия стабилизации ордеров

## Обзор
**Стратегия стабилизации ордеров** — это конверсия эксперта MetaTrader `hjueiisyx8lp2o379e_www_forex-instruments_info.mq4`. Изначальный робот выставляет пару стоповых ордеров вокруг текущей цены и ждёт пробоя. После открытия позиции система отслеживает размеры тел последних свечей, чтобы определить, застыл ли рынок, и закрывает сделку при потере импульса или достижении заданной прибыли.

Версия на C# воспроизводит те же правила с использованием высокоуровневого API StockSharp и работает только по закрытым свечам. Это делает поведение стратегии воспроизводимым как на тестах, так и в реальной торговле.

## Правила торговли
1. При отсутствии позиций и активных заявок стратегия размещает **buy stop** выше рынка и **sell stop** ниже рынка на расстоянии `OrderDistancePoints` пунктов (MetaTrader points).
2. При исполнении стоп-заявки:
   - Открывается позиция объёмом `OrderVolume` лотов.
   - Противоположный стоп остаётся в стакане, чтобы поймать разворот в другую сторону.
3. Пока позиция открыта, анализируются тела двух последних завершённых свечей:
   - Если тело последней свечи меньше `StabilizationPoints`, а плавающая прибыль превышает `ProfitThreshold`, позиция закрывается, а противоположный стоп отменяется.
   - Если две подряд свечи укладываются в предел `StabilizationPoints`, позиция закрывается вне зависимости от текущего результата.
   - Если прибыль достигает `AbsoluteFixation`, сделка закрывается немедленно.
4. Стоп-заявки снимаются после истечения `ExpirationMinutes`, если параметр больше нуля.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `OrderVolume` | Объём сделки в лотах. | `0.1` |
| `OrderDistancePoints` | Расстояние до стоповых ордеров в пунктах MetaTrader. | `20` |
| `ProfitThreshold` | Минимальная прибыль (в валюте счёта) для выхода по стабилизации. | `-2` |
| `AbsoluteFixation` | Уровень прибыли (валюта счёта), при котором позиция закрывается безусловно. | `30` |
| `StabilizationPoints` | Максимальный размер тела свечи, считающийся признаком флэта. | `25` |
| `ExpirationMinutes` | Время жизни стоп-заявок в минутах, `0` — без ограничения. | `20` |
| `CandleType` | Тип свечи для анализа стабилизации (по умолчанию 5-минутные). | `TimeFrame(5m)` |

## Особенности конверсии
- В оригинале расчёты велись по тикам; в порте используется завершённая свеча, что упрощает тестирование.
- Пункты MetaTrader сопоставлены с `PriceStep`. Если шаг цены не задан, используется значение `1`.
- Прибыль пересчитывается через `PriceStep` и `StepPrice`, чтобы получить оценку в валюте счёта.
- Все комментарии и описания параметров переведены на английский язык в соответствии с требованиями репозитория.

## Использование
1. Добавьте стратегию в свой проект StockSharp и назначьте инструмент с портфелем.
2. Настройте параметры, уделив особое внимание таймфрейму свечей и расстоянию до стопов.
3. Запустите стратегию — она автоматически выставит стоповые ордера и будет сопровождать позицию согласно описанным правилам.

## Идеи для развития
- Подбирать таймфрейм под волатильность инструмента, чтобы избежать ложных выходов.
- Добавить фильтры волатильности (ATR, полосы Боллинджера) для работы только в активные периоды.
- Реализовать трейлинг-стоп или частичную фиксацию прибыли при приближении к целевому уровню.
