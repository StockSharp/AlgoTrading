# Стратегия Farhad Crab

## Обзор

**Farhad Crab** — это порт оригинального советника MetaTrader `FarhadCrab1.mq4` на высокоуровневый API StockSharp. Изначально алгоритм предназначался для минутных графиков пар GBP/JPY, GBP/USD и EUR/USD и комбинировал агрессивные входы по движению с динамическим сопровождением позиций. В новой реализации вся логика переписана на C#, а обмен данными происходит исключительно через подписки StockSharp.

В рабочем таймфрейме стратегия рассчитывает две скользящие средние: 9-периодную EMA от типичной цены и 9-периодную SMA от цен открытия свечи. Дополнительно ведётся дневная 55-периодная сглаженная средняя (SMMA), служащая «страховкой» от глобального разворота. Если минимум текущей свечи держится выше EMA и позиция отсутствует, открывается покупка. Если максимум остаётся ниже SMA от открытий, открывается продажа. Пересечение дневной SMMA с ценой закрытия в противоположную сторону немедленно закрывает позицию.

Система управления выходами повторяет настройки советника: отдельные значения тейк-профита (в пунктах) для длинных и коротких сделок, а также независимые параметры трейлинг-стопа. Трейлинг активируется только после движения цены на заданную величину, как и в MetaTrader. Закрытия выполняются рыночными заявками, что соответствует событиям высокоуровневого API.

## Ключевые особенности

- **Полное соответствие индикаторной базе** — EMA(9) по типичной цене, SMA(9) по ценам открытия и дневная SMMA(55).
- **Работа с несколькими таймфреймами** — одновременная подписка на торговый и дневной таймфреймы без ручного накопления данных.
- **Настраиваемые выходы** — тейк-профиты и трейлинг-стопы в пунктах, доступные для оптимизации.
- **Дневной предохранитель** — строгая реализация условия закрытия при пересечении дневной SMMA и цены закрытия.
- **Защита позиций** — однократный вызов `StartProtection()` в момент запуска стратегии.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `OrderVolume` | Объём сделки при открытии рынка. | `0.1` |
| `LongTakeProfitPips` | Дистанция тейк-профита для покупок в пунктах. | `10` |
| `ShortTakeProfitPips` | Дистанция тейк-профита для продаж в пунктах. | `10` |
| `LongTrailingStopPips` | Дистанция трейлинг-стопа для покупок (0 отключает). | `8` |
| `ShortTrailingStopPips` | Дистанция трейлинг-стопа для продаж (0 отключает). | `8` |
| `DailyMaPeriod` | Период дневной сглаженной средней. | `55` |
| `CandleType` | Основной таймфрейм стратегии (по умолчанию 1 минута). | `1m` |

Все параметры объявлены через `StrategyParam<T>` и помечены для оптимизации там, где это имеет смысл, поэтому стратегию легко адаптировать под конкретный инструмент.

## Правила торговли

1. **Открытие лонга**: минимум свечи находится выше EMA(9) по типичной цене, позиция отсутствует.
2. **Открытие шорта**: максимум свечи находится ниже SMA(9) по ценам открытия, позиция отсутствует.
3. **Защитное закрытие лонга**: дневная SMMA закрывается выше цены закрытия при условии, что ранее была ниже.
4. **Защитное закрытие шорта**: дневная SMMA закрывается ниже цены закрытия при условии, что ранее была выше.
5. **Тейк-профит**: достижение целевого количества пунктов закрывает позицию.
6. **Трейлинг-стоп**: после движения в прибыль на заданное расстояние отслеживается обратный ход и при откате позиция закрывается.

## Особенности реализации

- Вся обработка данных выполняется через `SubscribeCandles().Bind(...)`, что исключает прямой доступ к буферам индикаторов и соответствует внутренним правилам репозитория.
- Размер пункта вычисляется на основании `PriceStep` с учётом пятого и третьего знаков, как в MetaTrader, поэтому параметры в пунктах работают идентично.
- Стоп-приказы не выставляются, вместо этого стратегия контролирует цену и закрывает позиции рыночными ордерами при наступлении условий.
- Метод `OnReseted` очищает все поля, благодаря чему повторные запуски и оптимизации выполняются из чистого состояния.

## Рекомендации по использованию

- Для повторения исходных результатов используйте минутные свечи по основным валютным парам. Тем не менее параметры позволяют адаптироваться к другим инструментам и волатильности.
- Стратегия всегда держит только одну позицию, что упрощает мониторинг и анализ сделок.
- В условиях бокового рынка можно сократить расстояние трейлинг-стопа или сосредоточиться на тейк-профите, чтобы уменьшить число ложных выходов.
- Увеличение `DailyMaPeriod` сделает фильтр по дневной средне менее чувствительным, что подойдёт для более долгосрочных сценариев.
