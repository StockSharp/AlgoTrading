# Стратегия Ilan 1.4 Basket Grid

## Обзор
Ilan 1.4 — классическая сеточная стратегия усреднения. Конвертированная версия подписывается на один поток свечей и открывает первый ордер по направлению последних двух закрытых свечей: если последняя свеча закрылась ниже предыдущей, корзина стартует с продажи, в противном случае — с покупки. При движении цены против позиции на расстояние **Pip Step** стратегия, при разрешённом усреднении, добавляет ещё один ордер в том же направлении и пересчитывает среднюю цену входа.

Все сделки исполняются рыночными ордерами. Когда цена достигает средней цены входа плюс расстояние **Take Profit**, вся корзина закрывается. Модуль также включает трейлинг-стоп, фиксированный стоп-лосс, аварийное ограничение по просадке капитала и таймер жизни корзины — полностью повторяя защитные блоки оригинального эксперта MetaTrader.

## Правила торговли
1. Дождаться закрытия очередной свечи и считать цены закрытия двух последних свечей.
2. При отсутствии позиций открыть корзину в покупку, если последняя свеча закрылась выше предыдущей, иначе открыть продажу.
3. Хранить цену последней сделки и взвешенную среднюю цену корзины.
4. При активном усреднении (**Use Add**) и обратном движении цены на величину **Pip Step** вычислить следующий объём и открыть дополнительный рыночный ордер. Если включено **Close Before Adding**, текущая корзина сначала закрывается и тут же переоткрывается с увеличенным объёмом.
5. После каждой сделки пересчитывать среднюю цену входа. Корзина закрывается при достижении целевой прибыли либо при срабатывании любого защитного правила.
6. После закрытия корзины стратегия сразу формирует новый сигнал на основе последних двух свечей.

## Режимы управления капиталом
Параметр **Money Management** воспроизводит переключатель `MMType`:
- **Fixed** — каждый ордер использует базовый объём **Initial Volume**.
- **Geometric** — объём последующих ордеров умножается на `LotExponent^n`, где `n` — текущее число открытых сделок в корзине.
- **RecoverLastLoss** — если последняя корзина закрылась в минус, следующий ордер берёт объём последней сделки и умножает его на **Lot Exponent**; прибыльная корзина возвращает объём к базовому значению.

Объёмы округляются согласно **Volume Digits** и шагу объёма инструмента. Если округление даёт ноль, используется исходное значение без округления.

## Блоки защиты
- **Take Profit** — закрывает всю корзину при достижении средней цены входа ± заданного расстояния.
- **Stop Loss** — закрывает корзину при неблагоприятном движении цены на заданное число пунктов.
- **Use Trailing Stop** с параметрами **Trail Start** и **Trail Stop** — включает трейлинг-стоп после накопления достаточной прибыли и сопровождает цену.
- **Use Equity Stop** с параметром **Equity Risk %** — отслеживает стоимость портфеля и закрывает корзину, если текущая плавающая просадка превышает долю от зафиксированного максимума капитала.
- **Use Timeout** с параметром **Max Open Hours** — принудительно закрывает корзину по истечении заданного количества часов.

## Параметры
- **Candle Type** — таймфрейм, на основе которого строятся сигналы.
- **Initial Volume** — стартовый объём для новой корзины.
- **Volume Digits** — количество знаков после запятой при округлении объёма.
- **Money Management** — режим расчёта объёма (`Fixed`, `Geometric`, `RecoverLastLoss`).
- **Lot Exponent** — множитель для геометрического и восстановительного режимов.
- **Close Before Adding** — закрывать текущую корзину перед добавлением новой сделки.
- **Use Add** — разрешить или запретить усреднение.
- **Pip Step** — обратное движение цены (в шагах цены), требуемое для добавления сделки.
- **Take Profit** — целевое расстояние прибыли от средней цены.
- **Stop Loss** — максимально допустимое обратное движение от средней цены.
- **Use Trailing Stop / Trail Start / Trail Stop** — параметры трейлинг-стопа.
- **Max Trades** — максимальное количество ордеров усреднения в корзине.
- **Use Equity Stop / Equity Risk %** — параметры ограничения плавающей просадки.
- **Use Timeout / Max Open Hours** — ограничение по времени жизни корзины.

## Особенности конвертации
- Функции постановки отложенных ордеров заменены на рыночные заявки, поскольку исходный алгоритм всегда исполнял сделки немедленно.
- Трейлинг-стоп реализован для всей корзины целиком, а не через модификацию каждого ордера; пороги соответствуют оригиналу.
- Контроль капитала реализован через объект портфеля StockSharp, что позволяет повторить логику `AccountEquityHigh()` и стопа по просадке.
- Средняя цена и статистика корзины рассчитываются внутренними переменными без хранения коллекций сделок, что соответствует требованиям высокоуровневого API.
