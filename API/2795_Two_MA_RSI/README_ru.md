# Стратегия Two MA RSI

## Обзор
Стратегия Two MA RSI — это перенос советника MetaTrader «2MA_RSI». Она использует пересечение быстрой и медленной экспоненциальных скользящих средних (EMA), дополненное фильтром из индекса относительной силы (RSI). Размер позиции определяется модулем мартингейла: после убыточной сделки объём следующей заявки увеличивается. Реализация на StockSharp работает только по завершённым свечам и воспроизводит исходные уровни тейк-профита и стоп-лосса, заданные в пунктах.

## Данные и индикаторы
- Подписка ведётся на одну серию свечей `CandleType` (по умолчанию пятиминутные свечи).
- На каждой закрытой свече пересчитываются три индикатора:
  - EMA с периодом `FastLength` по цене закрытия.
  - EMA с периодом `SlowLength`.
  - RSI с периодом `RsiLength`.
- Значения EMA предыдущих свечей сохраняются внутри стратегии — доступ к буферам индикаторов не требуется.

## Логика входа
1. Анализируется только закрытая свеча, что исключает повторные сигналы внутри бара.
2. Позиция должна отсутствовать (`Position == 0`).
3. **Вход в лонг:**
   - Быстрая EMA пересекает медленную снизу вверх (текущее значение EMA_fast больше EMA_slow, тогда как на прошлой свече EMA_fast < EMA_slow).
   - RSI опускается ниже порога `RsiOversold`, подтверждая перепроданность.
4. **Вход в шорт:**
   - Быстрая EMA пересекает медленную сверху вниз при условии `EMA_fast < EMA_slow` на текущей свече и `EMA_fast > EMA_slow` на предыдущей.
   - RSI превышает порог `RsiOverbought`, что трактуется как перекупленность.
5. При выполнении условий отправляется рыночная заявка с объёмом, рассчитанным модулем мартингейла.

## Логика выхода
- После открытия позиции сразу рассчитываются уровни стоп-лосса и тейк-профита. Расстояния задаются в пунктах и переводятся в цену через `PriceStep` инструмента:
  - **Лонг:**
    - Stop Loss = `цена входа - StopLossPoints * PriceStep`.
    - Take Profit = `цена входа + TakeProfitPoints * PriceStep`.
  - **Шорт:**
    - Stop Loss = `цена входа + StopLossPoints * PriceStep`.
    - Take Profit = `цена входа - TakeProfitPoints * PriceStep`.
- Сделка закрывается только достижением защитных уровней. На следующей свече проверяется диапазон High/Low, и при касании соответствующего уровня вызывается `ClosePosition()`.
- При одновременном попадании стопа и цели в диапазон свечи приоритет остаётся консервативным: сперва проверяется стоп-лосс, затем тейк-профит, как и в оригинальном роботе.

## Управление объёмом и мартингейл
1. Базовый объём вычисляется как `floor(balance / BalanceDivider) * VolumeStep`. Используется текущая стоимость портфеля (`Portfolio.CurrentValue`, при необходимости `BeginValue`). Объём не опускается ниже шага объёма инструмента.
2. После каждой убыточной фиксации счётчик мартингейла увеличивается на единицу, но не превышает `MaxDoublings`. Следующая заявка умножается на `2^stage`.
3. Любая прибыльная сделка или достижение максимального числа удвоений сбрасывает счётчик в ноль, возвращая базовый объём.
4. Если `MaxDoublings` меньше либо равно нулю, увеличение объёма отключено и всегда используется базовый объём.

## Дополнительные особенности
- Стратегия хранит необходимые прошлые значения EMA и не запрашивает индикаторы с произвольным сдвигом.
- Сделки совершаются только при готовности индикаторов и разрешённой торговле (`IsFormedAndOnlineAndAllowTrading`).
- На график выводятся свечи, собственные сделки и линии трёх индикаторов для визуального контроля.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `FastLength` | Период быстрой EMA. | 5 |
| `SlowLength` | Период медленной EMA. | 20 |
| `RsiLength` | Количество свечей в расчёте RSI. | 14 |
| `RsiOverbought` | Уровень RSI для поиска шорт-сигналов. | 70 |
| `RsiOversold` | Уровень RSI для допуска лонг-сигналов. | 30 |
| `StopLossPoints` | Размер стоп-лосса в шагах цены. | 500 |
| `TakeProfitPoints` | Размер тейк-профита в шагах цены. | 1500 |
| `BalanceDivider` | Делитель баланса для расчёта базового объёма. | 1000 |
| `MaxDoublings` | Максимальное число последовательных удвоений. | 1 |
| `CandleType` | Тип свечей, с которыми работает стратегия. | Таймфрейм 5 минут |

## Примечания по использованию
- Необходимо, чтобы у инструмента были заданы `PriceStep` и `VolumeStep`, иначе пересчёт пунктов и объёма может быть некорректным.
- Выходы выполняются рыночными заявками, поэтому фактическое проскальзывание возможно, хотя логика определения стопов и целей сохранена.
- Python-версия не предоставляется — создан только C# вариант в соответствии с требованиями задания.
