# Trailing Take Profit MQ5 Strategy

## Обзор
Стратегия представляет собой порт советника MetaTrader 5 `TrailingTakeProfit.mq5` на платформу StockSharp. Оригинальный код обновляет уровень тейк-профита по уже открытым позициям, чтобы цель следовала за ценой, когда сделка уходит в просадку. Перенесённая версия делает то же самое, отслеживая лучшую цену bid/ask и закрывая позицию, когда обновлённый уровень достигнут.

Стратегия не открывает новые сделки. Её задача — сопровождать уже существующую позицию, запущенную вручную или другой стратегией. При активном трейлинге компонент рассчитывает условия включения и поддерживает целевую цену в соответствии с логикой исходного эксперта.

## Ключевые особенности
- Использование высокоуровневого API `SubscribeLevel1()` для получения лучших bid/ask.
- Активация трейлинга только после движения цены против позиции на заданное число пунктов.
- Поддержание максимальной дистанции между текущей ценой и уровнем тейк-профита, аналогично модификации ордера в MQL.
- Закрытие длинных и коротких позиций рыночными ордерами при достижении обновлённого уровня.
- Автоматический сброс внутренних состояний при закрытии позиции или отключении функции.

## Параметры
| Название | Значение по умолчанию | Описание |
| -------- | --------------------- | -------- |
| `TrailingEnabled` | `true` | Включение или отключение сопровождения тейк-профита. |
| `TrailingStartPoints` | `200` | Количество шагов цены против позиции до запуска трейлинга. |
| `TrailingDistancePoints` | `200` | Максимальный разрыв между текущей ценой и обновлённым тейк-профитом. |

Все расстояния переводятся в цену через `PriceStep` инструмента. Для числовых параметров заданы диапазоны оптимизации.

## Логика работы
1. Подписка на поток Level1 и отслеживание последнего bid/ask.
2. При наличии позиции и активном трейлинге рассчитывается просадка от средней цены входа. Когда она превышает `TrailingStartPoints`, вычисляется кандидат на уровень тейк-профита на расстоянии `TrailingDistancePoints` от текущей котировки.
3. Для длинных позиций новый уровень устанавливается только если он ниже предыдущего (то есть сжимает цель). Для коротких — только если уровень повышается.
4. При достижении актуальной котировки целевого уровня позиция немедленно закрывается рыночным ордером.
5. После закрытия позиции или отключения функции внутренние цели очищаются, что повторяет поведение оригинального эксперта.

## Рекомендации по использованию
- Запускайте стратегию на инструменте, по которому уже открыта позиция для сопровождения.
- Убедитесь, что у инструмента задан корректный `PriceStep`, иначе расчёты расстояний выполняться не будут.
- Так как закрытие происходит рыночными ордерами, выставьте нужный объём в параметрах стратегии.
- Решение легко комбинируется с другими стратегиями входа, выполняя роль менеджера тейк-профита.
