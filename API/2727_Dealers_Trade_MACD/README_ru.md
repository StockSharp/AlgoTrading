# Стратегия Dealers Trade MACD
[English](README.md) | [中文](README_cn.md)

Перенесённая стратегия Dealers Trade v7.74 MACD – это пирамидальная система, которая открывает серии сделок по направлению наклона основной линии MACD. Она разрабатывалась для таймфреймов H4 и D1, где импульсные развороты менее шумные и дают времени для наращивания позиций.

## Как работает стратегия

- **Определение сигнала.** На каждом закрытом баре выбранного таймфрейма рассчитывается MACD. Рост основной линии воспринимается как бычий сигнал, падение – как медвежий. При необходимости направление можно инвертировать параметром `ReverseCondition`.
- **Управление размером позиции.** Первая заявка берёт фиксированный объём `FixedVolume`. Если он равен нулю, объём рассчитывается от капитала счёта по доле `RiskPercent` и расстоянию до стоп-лосса. Каждый следующий вход умножается на `VolumeMultiplier` в степени текущего количества сделок (1.6, 1.6², 1.6³ …). Новый ордер отправляется только при выполнении двух условий: цена отошла минимум на `IntervalPoints * PriceStep` от последней покупки и не превышены лимиты `MaxPositions` и `MaxVolume`.
- **Сопровождение сделок.** Для каждой позиции запоминаются собственные уровни стоп-лосса и тейк-профита, рассчитанные в шагах цены (`StopLossPoints`, `TakeProfitPoints`). Если задан `TrailingStopPoints`, стоп подтягивается вслед за ценой, когда плавающая прибыль превышает сумму `TrailingStopPoints + TrailingStepPoints`, что повторяет логику MQL-версии.
- **Защита счёта.** Когда число открытых сделок больше `PositionsForProtection`, а суммарная нереализованная прибыль достигает `SecureProfit`, стратегия фиксирует наиболее прибыльную позицию, прежде чем продолжить пирамиду.

## Параметры

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | H4 | Таймфрейм, по которому строятся свечи и рассчитывается MACD. |
| `FixedVolume` | 0.1 | Базовый объём первой сделки. Ноль включает риск-менеджмент по проценту капитала. |
| `RiskPercent` | 5 | Доля капитала, которую можно потерять при одном входе, если `FixedVolume = 0`. |
| `StopLossPoints` | 90 | Расстояние до стоп-лосса в шагах цены. Ноль отключает жёсткий стоп. |
| `TakeProfitPoints` | 30 | Расстояние до тейк-профита в шагах цены. Ноль отключает цель. |
| `TrailingStopPoints` | 15 | Базовое расстояние трейлинг-стопа в шагах цены. |
| `TrailingStepPoints` | 5 | Минимальное дополнительное движение цены до следующего подтягивания стопа. |
| `MaxPositions` | 5 | Максимальное число одновременно открытых сделок. |
| `IntervalPoints` | 15 | Минимальное расстояние между соседними входами в шагах цены. |
| `SecureProfit` | 50 | Порог прибыли (в валюте котировки) для срабатывания защиты счёта. |
| `AccountProtection` | true | Включает защиту счёта. |
| `PositionsForProtection` | 3 | Минимальное число сделок для работы защиты. |
| `ReverseCondition` | false | Инвертировать направление сигнала MACD. |
| `MacdFastPeriod` | 14 | Быстрая EMA в MACD. |
| `MacdSlowPeriod` | 26 | Медленная EMA в MACD. |
| `MacdSignalPeriod` | 1 | Длина сигнальной EMA MACD (в оригинале равна 1). |
| `MaxVolume` | 5 | Максимальный совокупный объём позиции. |
| `VolumeMultiplier` | 1.6 | Множитель объёма для каждой новой сделки. |

## Особенности и ограничения

- В MQL-версии робот мог одновременно держать длинные и короткие сделки (хедж). В StockSharp позиции неттингуются, поэтому перед сменой направления текущая противоположная позиция закрывается.
- MACD анализируется только по закрытым свечам. Внутри бара сигнал может появиться чуть позже, зато стратегия устойчивее при тестировании на истории.
- Все значения в "пунктах" умножаются на шаг цены инструмента `PriceStep`. Если провайдер не передаёт эту величину, используется запасной шаг 0.0001 – в этом случае скорректируйте параметры под ваш рынок.
- При `FixedVolume = 0` для расчёта объёма необходим ненулевой стоп-лосс. Иначе объём становится нулевым, и заявка не отправляется.

