# Стратегия History Downloader

## Обзор
**History Downloader Strategy** — перенос советника `HistoryDownloader.mq4` на платформу StockSharp. Оригинальная версия в
MetaTrader имитировала нажатия клавиши `HOME` в окне графика и использовала дополнительный индикатор для публикации текущих
характеристик графика через глобальные переменные. Перевод на C# избавляется от платформенных хитростей: стратегия напрямую
использует высокоуровневый API StockSharp для запроса свечей до тех пор, пока не будет достигнута указанная дата. Торговые заявки
не отправляются — инструмент служит для подготовки исторических данных перед тестированием или анализом.

## Как работает
1. При старте происходит подписка на свечи выбранного таймфрейма (`CandleType`) для инструмента, указанного в `Strategy.Security`.
2. Каждая завершённая свеча обновляет внутреннюю статистику:
   - `_receivedCandles` считает количество полученных баров;
   - `_earliestCandleTime` хранит самую раннюю дату `OpenTime`;
   - `_lastUpdateTime` фиксирует момент последнего обновления, чтобы контрольный таймер знал, что данные поступают.
3. Встроенный `Strategy.Timer` заменяет цикл ожидания из MQL. Каждые `RequestTimeout` секунд он проверяет, появились ли новые
   данные:
   - если свечи пришли, счётчик таймаутов сбрасывается;
   - если нет, счётчик увеличивается, и после `MaxFailures` безуспешных интервалов загрузка прерывается — полный аналог
     параметра `MaxFailsInARow`.
4. На каждую свечу в журнал (`LogInfo`) пишется сообщение о прогрессе, аналогичное `Comment` на графике MetaTrader. Метод
   `FormatDuration` преобразует прошедшее время в строку вида `Xh Ym Zs`, повторяя функцию `FormatTime` из исходника.
5. Как только самая ранняя свеча становится не позднее `TargetDate`, стратегия считает задачу выполненной, снимает подписку и
   останавливается. Итоговое сообщение включает число полученных баров, минимальную дату и затраченное время.

## Контроль и журналирование
- `LogInfo` отображает прогресс: количество баров, минимальное время и длительность работы.
- `LogWarning` сообщает о простоях и показывает номер текущего таймаута.
- `LogError` используется при принудительном завершении после превышения `MaxFailures`.
- Поскольку стратегия не торгует, показатели `PnL`, позиция и заявки остаются неизменными.

## Параметры
| Имя | Тип | Значение по умолчанию | Аналог в MetaTrader | Описание |
| --- | --- | --- | --- | --- |
| `CandleType` | `DataType` | таймфрейм 1 минута | Период графика | Какой временной интервал нужно загрузить из источника данных. |
| `TargetDate` | `DateTimeOffset` | 2009-01-01 00:00:00Z | `ToDate` | Минимально допустимое время открытия свечи; достижение порога означает успешную загрузку. |
| `RequestTimeout` | `TimeSpan` | 1 секунда | `Timeout` (мс) | Максимальная пауза между обновлениями до фиксации одного таймаута. |
| `MaxFailures` | `int` | 10 | `MaxFailsInARow` | Количество подряд идущих таймаутов, после которого процесс останавливается с ошибкой. |

## Отличия от оригинального советника
- Вместо вызовов `PostMessage` и эмуляции клавиатуры используется штатная подписка на свечи.
- Индикатор `HistoryDownloaderI.mq4` больше не нужен: вся статистика ведётся внутри стратегии.
- Глобальные переменные терминала заменены на системные метки времени и таймер-наблюдатель, что делает прогресс повторяемым и
  детерминированным.
- Статус завершения выводится через журнал стратегии, а не через модальные окна, поэтому инструмент удобно использовать в
  автоматизированных пайплайнах.

## Рекомендации по использованию
- Перед запуском назначьте стратегии рабочий инструмент, портфель и коннектор — без этого провайдер не сможет передать историю.
- Подбирайте `RequestTimeout` с учётом задержек вашего источника данных; для медленных архивов интервал лучше увеличить.
- Увеличьте `MaxFailures`, если поставщик отдаёт данные порциями или обслуживает большие запросы с паузами.
- Стратегия автоматически завершает работу после успеха или ошибки, поэтому её удобно запускать по расписанию в процессах подготовки исторических данных.
