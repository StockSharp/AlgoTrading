# Стратегия Magic Number Wise EA Profit/Loss Dashboard (C#)

В каталоге представлена StockSharp-версия утилиты MetaTrader 5 **Magic-Number-wise-EA-Profit-Loss-Live-Dashboard_v1**. Исходный советник перебирает историю сделок, группирует их по magic number и рисует таблицу на графике. Перенос сохраняет периодическую агрегацию, но выводит данные в журнал стратегии, что позволяет наблюдать таблицу в Designer или любом другом хосте StockSharp.

## Возможности

* Отслеживает все заявки и сделки, проходящие через портфель стратегии.
* Поддерживает табличное представление с группировкой по идентификатору:
  * По умолчанию используется `Order.UserOrderId` — именно сюда в MT традиционно записывается magic number.
  * При необходимости идентификатором может служить комментарий заявки, что удобно для брокеров, не пробрасывающих `UserOrderId`.
* Для каждой группы хранится:
  * Количество совершённых сделок.
  * Суммарный реализованный PnL, который StockSharp возвращает для каждого `MyTrade`.
  * Последний известный инструмент (по сделке или по заявке).
  * Опциональный плавающий PnL, считанный из соответствующей позиции в `Portfolio.Positions`.
* С заданной периодичностью печатает форматированную строку с заголовком `Magic Id | Deals | Closed P/L | Floating P/L | Symbol | Comment`, полностью повторяя вид MT5-панели.

StockSharp работает с чистой позицией на инструмент, поэтому плавающий PnL сопоставляется по символу. Такое соответствие совпадает с логикой оригинального скрипта, если один magic number управляет одним инструментом — именно так обычно настроены MT-хеджевые счета.

## Параметры

Все параметры создаются через `Param()`, что позволяет настраивать их в Designer и использовать оптимизацию.

| Параметр | Описание |
|----------|----------|
| `RefreshInterval` | Интервал обновления отчётной таблицы (по умолчанию 5 секунд). |
| `GroupByComment` | При значении `true` группировка выполняется по `Order.Comment`, а не по `Order.UserOrderId`. Актуально для шлюзов, которые не передают пользовательский идентификатор. |
| `IncludeOpenPositions` | Добавляет в таблицу плавающий PnL из `Portfolio.Positions`. |

## Алгоритм работы

1. При запуске стратегия проверяет корректность интервала и создаёт `System.Threading.Timer`, который сразу формирует первый отчёт.
2. Обработчики `OnOrderRegistered` и `OnOrderChanged` регистрируют новые идентификаторы и запоминают символ/комментарий сразу после появления заявки.
3. `OnNewMyTrade` увеличивает счётчик сделок и суммирует реализованный PnL, который предоставляет StockSharp.
4. Каждое срабатывание таймера:
   * Обнуляет значения плавающего PnL и при необходимости синхронизирует их с актуальными позициями портфеля.
   * Формирует неизменяемые снимки, сортирует их по идентификатору и печатает выровненную таблицу в лог.

Таким образом, порт полностью повторяет информативность MT5-панели, но не привязан к графическому интерфейсу и одинаково ведёт себя в бэктесте и на реальном счёте.

## Практические рекомендации

1. Подключите стратегию к счёту, который нужно мониторить (подписка на рынок не требуется).
2. Если мост записывает идентификатор советника в комментарий заявки, включите `GroupByComment`.
3. Оставьте `IncludeOpenPositions` активным, чтобы видеть плавающий PnL рядом с реализованным; если адаптер пока не заполняет `Position.PnL`, опцию можно отключить.
4. Контролируйте журнал: каждая строка таймера — это актуальная таблица, идентичная MT5-варианту.

## Файлы

* `CS/MagicNumberWiseEaProfitLossDashboardStrategy.cs` – реализация стратегии.
* `README.md` – документация на английском языке.
* `README_cn.md` – краткое описание на китайском.
* `README_ru.md` – русскоязычная документация.
