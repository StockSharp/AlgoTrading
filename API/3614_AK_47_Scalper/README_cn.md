# AK-47 剥头皮策略

本策略基于 MetaTrader 5 专家顾问 **“AK-47 Scalper EA”（版本 44883）** 重写，实现于 StockSharp 的高级策略框架中。

算法会在允许的交易时间段内始终保持一个卖出止损挂单。挂单被触发后会立刻附加止损和止盈保护订单。随着市场波动，挂单价格以及保护性止损都会被动态收紧。

## 核心流程

1. 根据品种的最小跳动值计算点值（对于 5 位小数品种，点值会放大 10 倍以匹配 MT5 行为）。
2. 评估交易时间窗口，启用时间过滤时只有在起止时间之间才允许开仓，窗口可以跨越午夜。
3. 检查当前点差是否超过阈值，点差过大时不会下单。
4. 计算下单手数：
   - 可以直接使用固定手数（`Base Lot` 参数），或
   - 使用账户权益的 `Risk Percent` 百分比换算出手数，并按照交易所的最小/最大/步长规则对齐。
5. 在买价下方 `SL/2` 点处放置卖出止损订单，同时预先计算好在买价上方 `SL/2` 点的止损价和低于入场 `TP` 点的止盈价。
6. 挂单等待期间持续使用 `ReRegisterOrder` 调整价格，使其始终与买价保持 `SL/2` 点的间距，并更新计划中的保护价格。
7. 挂单成交后：
   - 依据计划价格注册买入止损（止损）和买入限价（止盈）订单。
   - 每根 K 线收盘时，将止损保持在买价上方 `SL` 点的位置，如果价格继续向盈利方向移动会同步下移。
   - 止盈价保持不变。
8. 仓位清空时撤销所有保护订单，等待新的交易机会。

## 参数说明

| 参数 | 含义 |
|------|------|
| **Use Risk Percent** | 切换为使用权益百分比计算手数。 |
| **Risk Percent** | 以权益百分比计算手数时使用的比例。 |
| **Base Lot** | 固定手数，同时也是风险模式的对齐步长。 |
| **Stop Loss (pips)** | 止损距离，挂单价格会使用其中一半的距离。 |
| **Take Profit (pips)** | 止盈距离，设为 0 可关闭止盈。 |
| **Max Spread (points)** | 允许的最大点差（以 MT5 点表示）。 |
| **Use Time Filter** | 是否启用交易时间过滤。 |
| **Start Hour / Minute** | 交易窗口起始时间。 |
| **End Hour / Minute** | 交易窗口结束时间。 |
| **Candle Type** | 用于驱动策略逻辑的 K 线数据类型。 |

## 其他说明

- 策略只会进行卖出方向的交易，与原始 EA 相同。
- 为了兼容 StockSharp 高级 API，所有的跟踪止损都在 K 线收盘时执行。
- 保护订单通过 `ReRegisterOrder` 进行改价，请确认目标撮合环境支持订单改价功能。
- 原 EA 中的终端注释未迁移，策略改为依赖日志输出。
