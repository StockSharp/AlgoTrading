# Стратегия Two MA Four Level
[English](README.md) | [中文](README_cn.md)

Стратегия в точности повторяет логику советника MetaTrader "2MA_4Level", но реализована на высокоуровневом API StockSharp. Используются две сглаженные скользящие средние (SMMA) по медианной цене свечи. Сигналы формируются при пробое быстрой средней через медленную не только по базовой линии, но и через четыре дополнительные зоны, смещённые на заданное количество пунктов. Новая сделка открывается только при отсутствии позиции, а выход осуществляется стоп-лоссом и тейк-профитом в пунктах.

## Логика работы

- Рассчитываются две SMMA: быстрая и медленная (по умолчанию 50 и 130 периодов).
- На каждой завершённой свече сравниваются значения скользящих на текущей и предыдущей свече.
- Проводится пять проверок пересечения быстрой и медленной SMA:
  1. базовая линия без смещения;
  2. медленная SMA + `MostTopLevel` пунктов;
  3. медленная SMA + `TopLevel` пунктов;
  4. медленная SMA − `LowermostLevel` пунктов;
  5. медленная SMA − `LowerLevel` пунктов.
- Если быстрая SMA пересекает одну из линий снизу вверх — открывается длинная позиция (только если позиция отсутствует). Пересечение сверху вниз запускает короткую сделку.
- Функция `StartProtection` автоматически навешивает стоп и тейк, рассчитанные через шаг цены инструмента (`Security.PriceStep`).

Стратегия не наращивает позицию: новая сделка возможна только после полного закрытия предыдущей (по стопу или по цели).

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `FastPeriod` | 50 | Период быстрой SMMA. Должен быть меньше `SlowPeriod`. |
| `SlowPeriod` | 130 | Период медленной SMMA. |
| `MostTopLevel` | 500 | Верхний уровень (в пунктах) для самого широкого подтверждения сигнала. Должен быть больше `TopLevel`. |
| `TopLevel` | 250 | Второй верхний уровень (в пунктах) для подтверждения сигнала. |
| `LowerLevel` | 250 | Второй нижний уровень (в пунктах). Должен быть меньше `LowermostLevel`. |
| `LowermostLevel` | 500 | Самый нижний уровень (в пунктах) для подтверждения сигнала. |
| `TakeProfitPips` | 55 | Расстояние до тейк-профита в пунктах. |
| `StopLossPips` | 260 | Расстояние до стоп-лосса в пунктах. |
| `CandleType` | 15-минутные свечи | Таймфрейм, на котором вычисляются индикаторы и принимаются решения. |

## Особенности реализации

- Используется медианная цена (`(High + Low) / 2`), что соответствует настройке `PRICE_MEDIAN` в MT5.
- Пересечения анализируются только на закрытых свечах, что исключает влияние незавершённых баров.
- `StartProtection` вызывается один раз при запуске, поэтому каждая заявка автоматически получает заданные уровни риска.
- В `OnStarted` предусмотрены проверки корректности параметров; при ошибке стратегия пишет сообщение в лог и останавливается.

## Рекомендации по применению

1. Убедитесь, что у инструмента задан шаг цены (`PriceStep`). Если данных нет, по умолчанию берётся значение `1`, что может исказить расчёт пунктов.
2. Для MT5 стратегия рассчитана на хеджинговые счета; в StockSharp соблюдается то же ограничение — в рынке может быть только одна позиция.
3. Для `FastPeriod` и `SlowPeriod` включены флаги оптимизации (`SetCanOptimize`), что позволяет использовать стандартный оптимизатор StockSharp.
4. Поскольку выход возможен только по стоп-лоссу или тейк-профиту, внимательно подбирайте размеры уровней с учётом волатильности инструмента.

## Файлы

- `CS/TwoMaFourLevelStrategy.cs` — реализация стратегии на C#.
- `README.md` — документация на английском языке.
- `README_cn.md` — документация на китайском языке.
