# Стратегия SurefireThing

## Обзор
SurefireThing — это реализация на StockSharp высокоуровневого API экспертной системы MetaTrader 4 *Surefirething*. Стратегия работает только с закрытыми свечами, вычисляет уровни отложенных заявок по диапазону предыдущей сессии и обнуляет позицию при смене торгового дня. Основная идея заключается в постановке симметричных лимитных заявок вокруг цены закрытия предыдущего дня, чтобы воспользоваться возможным возвратом к среднему.

## Логика торговли
- При обнаружении нового торгового дня стратегия пытается закрыть открытую позицию и снимает активные отложенные заявки.
- Для последней завершённой свечи предыдущего дня рассчитывается диапазон `(High - Low)` и умножается на `RangeMultiplier` (по умолчанию 1.1 — как в оригинальном советнике).
- Половина скорректированного диапазона прибавляется к цене закрытия для определения уровня sell limit. Та же величина вычитается из цены закрытия для постановки buy limit.
- Параметры StopLoss и TakeProfit задаются в шагах цены. Если у инструмента определён `Security.Step`, значения автоматически переводятся в абсолютные расстояния и обрабатываются через `StartProtection`, чтобы при исполнении позиций автоматически выставлялись защитные ордера.
- Заявки выставляются один раз в сутки. При исполнении выход из позиции происходит за счёт защитных ордеров, иначе лимитные заявки остаются активными до следующей дневной перезагрузки.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `OrderVolume` | Объём каждой отложенной заявки. | `0.1` |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены. При наличии `Security.Step` переводится в абсолютное значение. | `10` |
| `StopLossPoints` | Дистанция стоп-лосса в шагах цены. Переводится аналогично тейк-профиту. | `15` |
| `RangeMultiplier` | Коэффициент, которым масштабируется диапазон предыдущей свечи. | `1.1` |
| `CandleType` | Основной таймфрейм, используемый стратегией. По умолчанию — минутные свечи, но может быть изменён под исходный график. | `TimeSpan.FromMinutes(1)` |

## Особенности реализации
- **Высокоуровневый API**: подписка на свечи осуществляется через `SubscribeCandles(CandleType)`, обработчик `ProcessCandle` работает только с завершёнными свечами.
- **Суточный сброс**: функция `CloseForNewDay` следит за сменой календарного дня по времени открытия свечи, закрывает позицию и отменяет заявки.
- **Защитные ордера**: `ConfigureProtection` преобразует точечные параметры риска в объекты `Unit` и активирует `StartProtection`, чтобы стопы и тейки автоматически переустанавливались после сделок.
- **Управление жизненным циклом ордеров**: ссылки на лимитные заявки хранятся в `_buyLimitOrder` и `_sellLimitOrder`, очищаются через `CancelPendingOrder` и `OnOrderChanged` при завершении или отмене.
- **Нормализация цен**: перед отправкой ордеров цены округляются до шага инструмента функцией `Security.ShrinkPrice`.

## Рекомендации по использованию
- Подберите `CandleType` под таймфрейм, который использовался в оригинальном советнике, чтобы расчёты выполнялись по тем же свечам.
- При изменении волатильности инструмента корректируйте `RangeMultiplier`, чтобы расстояние до лимитных заявок оставалось адекватным.
- Если брокер ограничивает минимальные расстояния до стопов, убедитесь, что `TakeProfitPoints` и `StopLossPoints` после пересчёта соответствуют правилам площадки.
- Стратегия предполагает непрерывные внутридневные данные. При гэпах (выходные, праздники) следующая доступная свеча всё равно инициирует сброс и постановку новых ордеров на основе последнего наблюдаемого бара.
