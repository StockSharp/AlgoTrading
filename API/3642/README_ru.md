# Стратегия Martingale Trade Simulator

## Обзор

**Martingale Trade Simulator Strategy** — это перенос ручного эксперта MetaTrader 5 "Martingale Trade Simulator" на высокоуровневый API StockSharp. Стратегия открывает первый рыночный ордер в выбранном пользователем направлении и далее полностью управляет позицией:

- Добавляет усредняющие ступени, когда цена проходит против позиции заданное расстояние.
- Пересчитывает общий тейк-профит, чтобы закрыть весь портфель около точки безубыточности с небольшим запасом.
- Активирует блок трейлинг-стопа по образцу оригинального советника.
- Работает на свечах любого таймфрейма, задаваемого параметром `CandleType`.

Конвертация сохраняет ключевые элементы управления рисками и сопровождение сделок из исходной утилиты тестера, но переносит их в экосистему StockSharp.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `InitialVolume` | Базовый объём первого ордера. | `0.01` |
| `StopLossPips` | Расстояние защитного стоп-лосса в пунктах от средней цены входа. | `500` |
| `TakeProfitPips` | Расстояние тейк-профита, используемое пока открыта только одна позиция. | `500` |
| `TrailingStopPips` | Дистанция активации трейлинг-стопа при росте прибыли. | `50` |
| `TrailingStepPips` | Шаг перемещения трейлинга после активации. | `20` |
| `LotMultiplier` | Множитель объёма для каждой новой усредняющей ступени. | `1.2` |
| `StepPips` | Минимальный ход цены против позиции (в пунктах) перед добавлением новой ступени. | `150` |
| `TakeProfitOffsetPips` | Альтернативный тейк-профит, используемый при наличии нескольких ступеней. | `50` |
| `EnableMartingale` | Включает или отключает добавление усредняющих ордеров. | `true` |
| `EnableTrailing` | Включает или отключает управление трейлинг-стопом. | `true` |
| `InitialDirection` | Направление первого ордера (`None`, `Buy`, `Sell`). | `None` |
| `CandleType` | Тип свечей, на которых выполняются расчёты. | `1 минута` |

## Логика торговли

1. **Первичный вход** – при запуске стратегия отправляет рыночный ордер в направлении `InitialDirection`. Если выбран `None`, первый вход можно сделать вручную.
2. **Мартиингейл** – когда цена проходит против позиции на `StepPips`, создаётся новый ордер с объёмом, умноженным на `LotMultiplier^n`. После каждой ступени целевой тейк-профит сдвигается на `TakeProfitOffsetPips`.
3. **Трейлинг-стоп** – после движения цены в прибыль на `TrailingStopPips` стоп подтягивается и затем перемещается шагами `TrailingStepPips`.
4. **Выход** – стратегия отслеживает синтетические уровни стоп-лосса и тейк-профита для всего портфеля и закрывает позиции при достижении любого из уровней.

## Рекомендации по использованию

- Алгоритм рассчитан на неттинговые счета, где по инструменту держится одна совокупная позиция. Он повторяет модель тестера MetaTrader, поэтому подходит прежде всего для экспериментов.
- Убедитесь, что у инструмента корректно заданы `PriceStep`, `VolumeStep`, `VolumeMin` и `VolumeMax`, поскольку эти значения используются для нормализации объёмов и ценовых смещений.
- Параметр `CandleType` можно менять на любой таймфрейм: короткие интервалы имитируют работу по тикам, длинные уменьшают частоту действий.

## Визуализация

При наличии области графика стратегия выводит выбранные свечи и помечает сделки, что повторяет визуальную часть оригинального инструмента.

## Особенности конверсии

- Кнопки панели тестера заменены параметром `InitialDirection`.
- Проверки объёма и маржи из MQL реализованы через нормализацию объёмов StockSharp.
- Логика усреднения и трейлинга адаптирована под совокупную позицию, которую ведёт стратегия StockSharp.
