# Стратегия Bull vs Medved
[English](README.md) | [中文](README_cn.md)

Bull vs Medved — лимитная стратегия, перенесённая из MetaTrader 5. Алгоритм следит за тремя последними завершёнными свечами и разрешает сделки только в шести пятиминутных торговых окнах в течение суток. При появлении нужной бычьей или медвежьей комбинации свечей стратегия выставляет отложенный ордер со смещением от текущего спреда и сопровождает позицию симметричными стоп-лоссом и тейк-профитом.

## Логика торговли

1. **Торговые окна** – анализ выполняется только когда текущее время попадает в одно из шести настраиваемых окон (по умолчанию 00:05, 04:05, 08:05, 12:05, 16:05, 20:05) и не вышло за пределы длительности окна (5 минут). Выход за пределы окна сбрасывает блокировку «один ордер на окно».
2. **Необходимые данные** – стратегия ждёт минимум три завершённые свечи. Все расчёты выполняются по трём последним закрытым свечам.
3. **Бычьи сигналы**:
   - **Обычный бык**: свеча с индексом -3 закрылась выше открытия второй свечи, вторая свеча имеет минимум 1 пункт бычьего тела, а последняя свеча имеет бычий диапазон больше порога `CandleSizePips`.
   - **Фильтр «плохой бык»**: если все три свечи формируют крупные бычьи тела, сигнал игнорируется, чтобы избежать входа в перегретое движение.
   - **«Прохладный бык»**: после сильного медвежьего отката (вторая свеча закрылась минимум на 2 пункта ниже открытия) последняя свеча должна перекрыть откат и иметь тело не меньше 40% от `CandleSizePips`. Сигнал long принимается либо по обычному быку без фильтра, либо по «прохладному быку».
   - При валидном сигнале выставляется **buy limit** ниже лучшего ask на величину `IndentUpPips` (в пересчёте в цену инструмента).
4. **Медвежий сигнал**:
   - Если последняя свеча имеет медвежье тело больше `CandleSizePips`, выставляется **sell limit** выше лучшего bid на `IndentDownPips`.
5. **Управление рисками** – после открытия позиции автоматически добавляются стоп-лосс и тейк-профит с заданными расстояниями.
6. **Управление ордерами** – в каждом окне допускается только один ордер; новые заявки не отправляются, пока активен предыдущий лимитный ордер по тому же инструменту.

## Параметры

- `OrderVolume` – объём лимитных ордеров.
- `CandleSizePips` – минимальный размер тела последней свечи.
- `StopLossPips` – расстояние стоп-лосса от цены входа.
- `TakeProfitPips` – расстояние тейк-профита.
- `IndentUpPips` – смещение buy limit относительно лучшего ask.
- `IndentDownPips` – смещение sell limit относительно лучшего bid.
- `EntryWindowMinutes` – длительность каждого торгового окна.
- `CandleType` – таймфрейм свечей для расчётов.
- `StartTime0` … `StartTime5` – времена начала шести торговых окон.

## Дополнительно

- Стратегия подписывается на стакан, чтобы получать актуальные bid/ask для точного размещения лимитных ордеров. При отсутствии данных используется цена закрытия последней свечи.
- Смещения автоматически переводятся в пипсы с учётом трёх- и пятизнаковых котировок.
- Stop-loss и take-profit выставляются через `StartProtection`, поэтому их уровни привязываются к фактической цене исполнения лимитного ордера.
