# Стратегия JS Sistem 2

## Обзор
JS Sistem 2 — трендовая система, изначально написанная для MetaTrader 5. Порт на StockSharp сохраняет блок многофакторного подтверждения из исходного советника и работает только по закрытым свечам выбранного таймфрейма. Сделки открываются фиксированным объёмом, а при падении стоимости портфеля ниже заданного порога можно заблокировать новые входы. Управление риском реализовано через стоп-лосс и тейк-профит в пунктах, дополненные адаптивным трейлингом по теням свечей.

## Индикаторы и фильтры
- **EMA(55), EMA(89), EMA(144)** — формируют направленный фильтр. Для покупок требуется расположение EMA55 выше EMA89 и EMA89 выше EMA144, при этом разброс между EMA55 и EMA144 должен быть меньше параметра `MinDifferencePips`.
- **Гистограмма MACD (OsMA)** — использует те же периоды быстрого, медленного и сигнального EMA, что и оригинальная версия на MQL. Для покупок гистограмма должна быть положительной, для продаж — отрицательной.
- **Relative Vigor Index (RVI)** — рассчитывается с периодом `RviPeriod` и дополнительно сглаживается простой скользящей средней длиной `RviSignalLength`. Покупки разрешены, когда значение RVI выше сигнальной линии и сама сигнальная линия находится не ниже `RviMax`. Для продаж условия зеркальны и задействуют порог `RviMin`.
- **Индикаторы Highest/Lowest** — отслеживают максимум и минимум за `VolatilityPeriod` свечей. Эти значения управляют трейлинг-стопом и повторяют механику «по теням» из исходного советника.

## Логика торговли
1. Обработка выполняется только на закрытых свечах типа `CandleType`.
2. Перед поиском новых сигналов стратегия обновляет трейлинг-стоп по актуальным экстремумам и проверяет, не были ли достигнуты уровни стопа или тейка внутри свечи.
3. Условия для входа в покупку:
   - Текущая стоимость портфеля выше `MinBalance`.
   - EMA55 > EMA89 > EMA144 и разница между EMA55 и EMA144 (переведённая в цену через размер пункта инструмента) меньше `MinDifferencePips`.
   - Значение гистограммы MACD (`macdLine`) положительное.
   - RVI выше сигнальной линии, а сигнальная линия достигла или превысила `RviMax`.
   - Отсутствует открытая длинная позиция (`Position <= 0`). При наличии короткой позиции она закрывается перед открытием покупки.
4. Условия для входа в продажу симметричны и используют порог `RviMin`.
5. После открытия позиции фиксируется цена закрытия свечи, рассчитываются уровни стоп-лосса и тейк-профита с учётом `StopLossPips` и `TakeProfitPips`, сбрасывается состояние трейлинга.

## Управление позицией и трейлинг
- **Жёсткий стоп-лосс / тейк-профит:** Если диапазон свечи достигает сохранённого уровня стопа либо цели, позиция закрывается полностью.
- **Трейлинг-стоп:** При включённом параметре `TrailingEnabled` стоп подтягивается в сторону прибыли. Для покупок стоп переносится на минимум из последних `VolatilityPeriod` свечей, когда этот минимум находится выше цены входа и предыдущего стопа минимум на `TrailingIndentPips`. Для продаж применяется зеркальное правило через максимум. Такой подход повторяет «трейлинг по теням» оригинального алгоритма и защищает прибыль без преждевременного срабатывания.
- **Контроль баланса:** Когда текущая стоимость портфеля опускается ниже `MinBalance`, стратегия перестаёт открывать новые сделки, но продолжает сопровождать уже открытые позиции и обновлять трейлинг-стоп.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `MinBalance` | Минимальная стоимость портфеля для разрешения новых входов. | 100 |
| `Volume` | Объём заявки при открытии позиции. | 1 |
| `StopLossPips` | Дистанция стоп-лосса в пунктах (0 — отключить). | 35 |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах (0 — отключить). | 40 |
| `MinDifferencePips` | Максимально допустимый разрыв между быстрой и медленной EMA в пунктах. | 28 |
| `VolatilityPeriod` | Количество свечей для расчёта экстремумов в трейлинг-стопе. | 15 |
| `TrailingEnabled` | Включение механизма трейлинг-стопа. | true |
| `TrailingIndentPips` | Минимальный зазор между ценой, входом и стопом при обновлении трейлинга. | 1 |
| `MaFastPeriod` | Период быстрой EMA. | 55 |
| `MaMediumPeriod` | Период средней EMA. | 89 |
| `MaSlowPeriod` | Период медленной EMA. | 144 |
| `OsmaFastPeriod` | Период быстрого EMA для гистограммы MACD. | 13 |
| `OsmaSlowPeriod` | Период медленного EMA для гистограммы MACD. | 55 |
| `OsmaSignalPeriod` | Период сигнального EMA для гистограммы MACD. | 21 |
| `RviPeriod` | Период индикатора Relative Vigor Index. | 44 |
| `RviSignalLength` | Длина SMA, сглаживающей сигнал RVI. | 4 |
| `RviMax` | Верхний порог сигнальной линии RVI для разрешения покупок. | 0.04 |
| `RviMin` | Нижний порог сигнальной линии RVI для разрешения продаж. | -0.04 |
| `CandleType` | Таймфрейм свечей, используемых в расчётах. | 5 минут |

## Особенности реализации
- Размер пункта определяется по шагу цены инструмента. Для инструментов с 3 или 5 знаками после запятой пункт равен десяти шагам цены, что соответствует исходной MQL-реализации.
- Стопы и тейки обрабатываются внутри стратегии, потому что в шаблоне StockSharp они не выставляются как серверные заявки автоматически.
- При запуске вызывается `StartProtection()`, чтобы базовый класс контролировал нештатные ситуации и зависшие позиции.
