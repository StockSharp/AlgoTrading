# Стратегия ColorXPWMA Digit MMRec

## Общее описание
**ColorXPWMA Digit MMRec** — это адаптация советника `Exp_ColorXPWMA_Digit_MMRec` под платформу StockSharp. Стратегия использует индикатор ColorXPWMA Digit для поиска точек разворота тренда и повторяет оригинальную схему управления объёмом (MM recounter). Индикатор строит степенную взвешенную среднюю (Power Weighted Moving Average) с дополнительным сглаживанием выбранным методом. Знак наклона сглаженной линии кодируется тремя состояниями: `2` — восходящий наклон, `0` — нисходящий, `1` — нейтральный участок.

Решения принимаются после анализа буфера цветов на заданном историческом баре (`SignalBar`). Если цвет на баре `SignalBar + 1` был бычьим (`2`), но на баре `SignalBar` он перестал быть `2`, стратегия закрывает шорты и, при разрешении, открывает новую длинную позицию. Аналогично, если цвет `SignalBar + 1` равен `0`, а `SignalBar` уже не `0`, закрываются лонги и, при необходимости, открывается шорт.

## Логика индикатора
- **Power Weighted Moving Average** — каждому бару назначается вес `(period - index)^power`, что усиливает вклад последних значений.
- **Сглаживание** — взвешенный ряд передаётся на дополнительную скользящую среднюю. Доступны методы SMA, EMA, SMMA, LWMA, Jurik, T3 и Kaufman AMA. Для JurX, ParMa и VIDYA используется экспоненциальное приближение из-за отсутствия готовых реализаций в StockSharp.
- **Цветовой буфер** — знак разности между текущим и предыдущим значением определяет цвет, который и служит источником торговых сигналов.
- **Округление** — итоговое значение может быть округлено до указанного числа знаков (`Digit`).

## Правила торговли
1. **Сбой продолжения роста**
   - Условие: цвет на баре `SignalBar + 1` равен `2`, а на баре `SignalBar` уже не `2`.
   - Действие: закрыть открытые шорты; если разрешено, открыть новый лонг с объёмом по пересчёту MM.
2. **Сбой продолжения падения**
   - Условие: цвет на баре `SignalBar + 1` равен `0`, а на баре `SignalBar` уже не `0`.
   - Действие: закрыть лонги; при разрешении открыть шорт с пересчитанным объёмом.

Заявки выставляются на закрытии свечи, породившей сигнал. При смене направления стратегия закрывает противоположную позицию и сразу открывает новую одним рыночным ордером.

## Управление объёмом (MM Recounter)
Перед открытием новой сделки стратегия анализирует последние результаты:

- Для лонгов берутся `BuyTotalTrigger` последних сделок. Если число убыточных ≥ `BuyLossTrigger`, объём снижается до `ReducedVolume`.
- Для шортов аналогично используются `SellTotalTrigger` и `SellLossTrigger`.

Таким образом воспроизводится логика функций `BuyTradeMMRecounterS` и `SellTradeMMRecounterS` из оригинального MQL5-советника.

## Параметры
| Группа | Параметр | Описание |
| --- | --- | --- |
| General | `CandleType` | Таймфрейм свечей для расчётов и сигналов. |
| Indicator | `IndicatorPeriod` | Период степенной взвешенной средней. |
| Indicator | `IndicatorPower` | Степень веса: чем выше, тем сильнее акцент на последних барах. |
| Indicator | `SmoothingMethod` | Метод дополнительного сглаживания (JurX, ParMa и Vidya аппроксимируются EMA). |
| Indicator | `SmoothingLength` | Длина сглаживающей скользящей средней. |
| Indicator | `SmoothingPhase` | Параметр фазы для совместимых методов. |
| Indicator | `AppliedPrice` | Источник цены (close, open, high, low и т.д.). |
| Indicator | `RoundingDigits` | Количество знаков округления индикатора. |
| Logic | `SignalBar` | Смещение (в барах) для чтения цветового буфера. |
| Permissions | `EnableBuyEntries` / `EnableSellEntries` | Разрешение на открытие лонгов/шортов. |
| Permissions | `EnableBuyExits` / `EnableSellExits` | Разрешение на закрытие лонгов/шортов. |
| Money Management | `NormalVolume` | Базовый объём сделки. |
| Money Management | `ReducedVolume` | Уменьшенный объём после серии убытков. |
| Money Management | `BuyTotalTrigger`, `BuyLossTrigger` | Количество последних длинных сделок и порог убытков для смены объёма. |
| Money Management | `SellTotalTrigger`, `SellLossTrigger` | Аналогичные параметры для коротких сделок. |
| Risk Management | `StopLossPoints`, `TakeProfitPoints` | Защитные дистанции в пунктах, подключаются через `StartProtection`, если заданы. |

## Практические советы
- Значение `SignalBar = 1` соответствует настройкам оригинального советника и гарантирует работу по закрытым свечам.
- История результатов хранится в пределах, необходимых для пересчёта MM, что исключает рост памяти.
- Из-за асинхронного исполнения в StockSharp результаты сделок оцениваются по цене закрытия свечи, как это делал советник в тестере.
- Методы JurX, ParMa и Vidya представлены экспоненциальным приближением. Для точного воспроизведения можно реализовать собственные индикаторы и заменить их в коде стратегии.

