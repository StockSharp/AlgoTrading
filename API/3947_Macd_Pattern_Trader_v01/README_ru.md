# Стратегия MacdPatternTraderv01

## Общее описание

`MacdPatternTraderV01Strategy` — это точная конверсия эксперта MetaTrader 4 "MacdPatternTraderv01" от журнала FORTRADER в экосистему StockSharp. Алгоритм отслеживает так называемые MACD-хуки: после резкого ухода основного значения MACD от нулевой линии он ждёт возврата к ней и только затем открывает сделку в направлении ожидаемого разворота. В портированной версии сохранены все особенности оригинала: поиск экстремумов для стопов и тейков, ступенчатое фиксирование позиции и фильтры по скользящим средним.

Для обработки данных используется высокоуровневое подключение к свечам (`SubscribeCandles`). Внутри стратегия задействует индикаторы `MACD`, экспоненциальные и простые средние. Значения MACD хранятся в сдвиговом регистре из трёх элементов, что позволяет повторить обращение к буферам `iMACD(..., shift)` из MQL.

## Логика входа

1. **Подготовка к продаже**: как только MACD становится выше `BearishThreshold`, стратегия запоминает потенциальную возможность для шорта. Флаг сбрасывается, если MACD падает ниже нуля.
2. **Подготовка к покупке**: при снижении MACD ниже `BullishThreshold` активируется ожидание лонга. Флаг обнуляется, когда MACD возвращается в положительную область.
3. **Подтверждение хука**:
   - Шорт открывается, когда выполняются условия `macd₀ < BearishThreshold`, `macd₀ < macd₁`, `macd₁ > macd₂`, при этом предыдущий экстремум всё ещё выше порога, а текущее значение MACD остаётся положительным.
   - Лонг активируется, если `macd₀ > BullishThreshold`, `macd₀ > macd₁`, `macd₁ < macd₂`, старые значения продолжают находиться ниже `BullishThreshold`, а текущий MACD отрицателен.
4. **Отправка заявки**: при выполнении условий регистрируется рыночная заявка объёмом `OrderVolume`, а вычисленные уровни стоп-лосса и тейк-профита сохраняются для дальнейшего сопровождения.

## Управление рисками

### Стоп-лосс

- Для коротких позиций берётся максимум из `StopLossBars` прошедших свечей (без текущей) и к нему прибавляется `OffsetPoints * PriceStep`.
- Для длинных позиций аналогично вычисляется минимум и вычитается смещение.

### Тейк-профит

Реализована рекурсивная процедура из исходного MQL:

1. Рассматривается блок из `TakeProfitBars` последних значений (включая текущую свечу).
2. Если минимум/максимум следующего блока глубже/выше, окно смещается ещё на `TakeProfitBars` баров назад.
3. Процесс повторяется, пока экстремум улучшается. Как только улучшения нет, найденное значение становится целевым уровнем.

### Частичное закрытие

- Стратегия отслеживает точку входа и первоначальный объём.
- Частичное закрытие разрешено только после достижения плавающей прибыли `ProfitThreshold` (пересчёт по `PriceStep` и `StepPrice`).
- Для лонга закрывается треть позиции, когда закрытие свечи выше `EmaMediumPeriod`, и половина остатка при пробое средней `(SMA + EMA Long)/2`. Для шорта — зеркально вниз.
- Перед проверкой частичных выходов всегда контролируются условия жёстких стопов и тейков.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `StopLossBars` | 6 | Глубина поиска экстремума для стоп-лосса. |
| `TakeProfitBars` | 20 | Размер блока при рекурсивном расчёте тейк-профита. |
| `OffsetPoints` | 10 | Смещение стопа в пунктах. |
| `MacdFastPeriod` | 5 | Быстрая EMA в MACD. |
| `MacdSlowPeriod` | 13 | Медленная EMA в MACD. |
| `MacdSignalPeriod` | 1 | EMA сигнальной линии. |
| `BearishThreshold` | 0.0045 | Порог положительного MACD для подготовки шорта. |
| `BullishThreshold` | -0.0045 | Порог отрицательного MACD для подготовки лонга. |
| `OrderVolume` | 1 | Объём рыночного ордера. |
| `EmaShortPeriod` | 7 | EMA для первого условия частичного выхода. |
| `EmaMediumPeriod` | 21 | EMA средней длины, используемая и как фильтр, и как триггер. |
| `SmaPeriod` | 98 | SMA в формуле второго выхода. |
| `EmaLongPeriod` | 365 | Длинная EMA в той же формуле. |
| `ProfitThreshold` | 5 | Минимальная плавающая прибыль для масштабирования. |
| `CandleType` | 1 час | Таймфрейм свечей. |

## Особенности реализации

- Все настройки оформлены через `StrategyParam<T>` с возможностью оптимизации там, где это оправдано.
- История максимумов/минимумов ограничена 1000 значениями, что воспроизводит работу MQL и не расходует лишнюю память.
- Плавающий PnL рассчитывается на основе `PriceStep` и `StepPrice`, поэтому порог прибыли остаётся корректным для любых инструментов.
- В коде присутствуют подробные комментарии на английском языке, поясняющие каждый блок, который был портирован из MQL.

## Запуск

1. Создайте экземпляр `MacdPatternTraderV01Strategy`, назначьте инструмент, портфель и коннектор.
2. При необходимости измените параметры (например, `CandleType`, `StopLossBars`, `OrderVolume`).
3. Запустите стратегию — она автоматически подпишется на свечи, отобразит MACD и сделки на графике и будет управлять позициями в режиме реального времени.
