# 楼梯策略

**楼梯策略** 完全复刻了最初的 MetaTrader 专家顾问。策略先在当前卖价上下放置对称的止损挂单，然后始终围绕最近一次成交重新搭建网格。未实现利润按照价格跳动（点）累积，而不按照成交量加权，这与源码的做法一致。当达到利润目标时，策略会通过市价单平掉全部仓位，删除所有挂单并重新开始。

## 交易逻辑

1. 当没有持仓时，在当前卖价之上和之下 `ChannelSteps / 2` 个最小价位处分别挂出买入止损和卖出止损单。
2. 首单成交后围绕成交价重建网格：
   - 如果激活的止损挂单不足两张，就取消旧单。
   - 只要当前买价仍在距最后成交价一半通道距离内，就重新在 `ChannelSteps` 的距离外放置买入止损和卖出止损单。
   - 当 `AddLots` 为真时，每次成交后都会在下一组挂单中叠加初始手数。
3. 维护多头和空头持仓列表，以重现 MT4 版本使用的对冲式仓位篮子。
4. 在每根收盘 K 线处，使用最佳买价计算多头利润，使用最佳卖价计算空头利润，并按照品种的最小价格跳动归一化距离，从而精确复刻原始的点值计算。
5. 当以下任一阈值被突破时触发总清仓：
   - `ProfitSteps` – 仅统计当前品种产生的利润。
   - `CommonProfitSteps` – 统计整个仓位篮子的利润。
6. 清仓时分别发送市价单平掉所有多头和空头头寸，并在仓位归零后撤销剩余的止损挂单。

> **注意**：原始脚本在挂单时附加了止损价位。StockSharp 的高级 API 无法针对单笔挂单附加保护性止损，因此移植版完全依赖上述利润条件来退出交易。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `ChannelSteps` | 对称止损挂单之间的距离，单位为最小价格跳动。 | `1000` |
| `ProfitSteps` | 达到该点数增益后平掉当前品种的仓位篮子。 | `1500` |
| `CommonProfitSteps` | 全部仓位篮子的全局利润阈值，超过后强制清仓。 | `1000` |
| `AddLots` | 若为真，每次成交后在下一组挂单中追加初始手数。 | `true` |
| `BaseVolume` | 第一组止损挂单的下单手数。 | `0.1m` |
| `CandleType` | 订阅及管理所使用的时间框架。 | `1 minute` |

## 实现说明

- 通过 `SubscribeCandles()` 与 `Bind()` 使用 StockSharp 的高级 API，仅处理收盘后的 K 线。
- 在 `OnOwnTradeReceived` 中跟踪单笔成交，以便利润计算能够复现 MQL 版本的对冲逻辑。
- 利润阈值完全基于价格跳动距离，不与成交量相乘，与 MT4 脚本的点值累加方式保持一致。
- 通过 `BuyStop` 和 `SellStop` 创建所有挂单，并使用市价单执行平仓，从而保证跨数据源的可移植性。
