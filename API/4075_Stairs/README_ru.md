# Стратегия Stairs

**Stairs Strategy** полностью повторяет логику оригинального советника MetaTrader. Алгоритм начинает работу с размещения симметричных стоп-заявок вокруг текущей цены ask и дальше постоянно перестраивает сетку вокруг последней сделки. Нереализованная прибыль суммируется в шагах цены (пунктах) без учета объема, как в исходном коде. При достижении целевых уровней прибыльности стратегия закрывает весь портфель рыночными заявками, снимает отложенные ордера и запускает цикл заново.

## Логика работы

1. При отсутствии позиций размещается стоп на покупку и стоп на продажу на расстоянии `ChannelSteps / 2` минимальных шагов цены выше и ниже текущего ask.
2. После первой сделки сетка перестраивается вокруг цены исполнения:
   - Если активных стоп-заявок меньше двух, предыдущие заявки удаляются.
   - Пока текущий bid находится не дальше половины канала от последней сделки, регистрируются новые стопы на расстоянии `ChannelSteps` от цены входа.
   - При включенном параметре `AddLots` объём следующей пары заявок увеличивается на базовый лот.
3. Для воспроизведения хеджирующей корзины из MT4 ведутся списки всех длинных и коротких позиций.
4. На каждой завершенной свече вычисляется нереализованная прибыль: для лонгов используется лучший bid, для шортов — лучший ask. Расстояния нормируются на шаг цены, что соответствует подсчету пунктов в оригинале.
5. Полная ликвидация запускается при превышении одного из порогов:
   - `ProfitSteps` — прибыль только по текущему инструменту.
   - `CommonProfitSteps` — суммарная прибыль всей корзины.
6. При ликвидации отправляются рыночные заявки на закрытие всех длинных и коротких позиций; оставшиеся стопы снимаются после выхода в ноль.

> **Важно**: исходный советник подвязывал к заявкам уровни стоп-лосса. Высокоуровневый API StockSharp не поддерживает индивидуальные защитные уровни для отложенных ордеров, поэтому порт закрывает позиции исключительно по описанным условиям прибыли.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `ChannelSteps` | Расстояние между симметричными стоп-заявками в шагах цены. | `1000` |
| `ProfitSteps` | Порог прибыли (в шагах цены) для закрытия корзины по текущему инструменту. | `1500` |
| `CommonProfitSteps` | Глобальный порог прибыли (в шагах цены), при превышении которого закрывается вся корзина. | `1000` |
| `AddLots` | При значении `true` увеличивает объём следующей пары стопов на базовый лот. | `true` |
| `BaseVolume` | Объём первой пары стоп-заявок. | `0.1m` |
| `CandleType` | Таймфрейм, по которому подписываются свечи и ведётся управление сделками. | `1 minute` |

## Особенности реализации

- Используется высокоуровневый API StockSharp: свечи обрабатываются через `SubscribeCandles()` и `Bind()` только после их завершения.
- Обработчик `OnOwnTradeReceived` отслеживает каждую сделку, что позволяет повторить хеджирующую схему расчёта прибыли, принятую в MQL-версии.
- Пороговые условия работают с «чистыми» шагами цены без умножения на объём, полностью повторяя сложение пунктов в MetaTrader.
- Все входы выполняются через `BuyStop` и `SellStop`, выходы — рыночными заявками, что делает стратегию совместимой с разными поставщиками данных.
