# Стратегия Dealers Trade MACD MQL4
[English](README.md) | [中文](README_cn.md)

Стратегия Dealers Trade MACD MQL4 представляет собой прямую конвертацию советника «Dealers Trade v7.74» для MetaTrader 4. В StockSharp сохранены пирамидальный мани-менеджмент и логика наклона линии MACD, но обработка позиций адаптирована к неттинговой модели. Стратегия рассчитана на свинг-торговлю по графикам H4 и D1 и наращивает позицию в направлении тренда, пока импульс соответствует показаниям MACD.

## Как работает стратегия

- **Определение сигнала**. Подписка на свечи выбранного таймфрейма и расчёт классического MACD (быстрая EMA, медленная EMA, сигнальная EMA). Рост основного значения MACD относительно предыдущей свечи трактуется как восходящий импульс, падение — как нисходящий. Параметр `ReverseCondition` позволяет инвертировать направление для контртрендовой торговли.
- **Шаг пирамидинга**. В каждый момент активна только одна корзина сделок. При сигнале на покупку открывается базовый ордер Buy, дальнейшие покупки отправляются лишь тогда, когда цена ушла вниз минимум на `SpacingPips * PriceStep` от цены последней покупки. Для коротких позиций действует зеркальная логика.
- **Размер лота**. Используется либо фиксированный объём `FixedVolume`, либо (если `UseRiskSizing` включён) значение, рассчитанное от баланса портфеля и `RiskPercent`. Параметр `IsStandardAccount` имитирует настройку «Account is normal» и делит лоты на 10 для мини-счётов. Каждый дополнительный ордер умножается на `LotMultiplier`, но ограничивается `MaxVolume`.
- **Управление рисками**. На каждую сделку устанавливаются стоп-лосс и тейк-профит согласно `StopLossPips` и `TakeProfitPips`. Когда прибыль превышает `TrailingStopPips + SpacingPips`, стоп подтягивается на расстояние `TrailingStopPips`, что воспроизводит трейлинг из исходного советника.
- **Защита счёта**. При достижении `MaxTrades - OrdersToProtect` открытых ордеров и превышении суммарной нереализованной прибыли `SecureProfit` закрывается последняя сделка. Это повторяет блок «AccountProtection» из оригинальной реализации.

## Параметры

| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | H4 | Таймфрейм для расчёта MACD и сигналов. |
| `FixedVolume` | 0.1 | Базовый лот при отключённом управлении риском. |
| `UseRiskSizing` | true | Включает расчёт объёма от баланса. |
| `RiskPercent` | 2 | Процент капитала, используемый при расчёте объёма. |
| `IsStandardAccount` | true | false для мини-счёта (деление лота на 10). |
| `MaxVolume` | 5 | Максимальный объём одной сделки. |
| `LotMultiplier` | 1.5 | Множитель объёма для каждого дополнительного ордера. |
| `MaxTrades` | 5 | Максимальное число одновременно открытых сделок. |
| `SpacingPips` | 4 | Минимальная дистанция в пунктах между сделками. |
| `OrdersToProtect` | 3 | Число сделок, которые сохраняются при срабатывании защиты. |
| `AccountProtection` | true | Включает блок защиты прибыли. |
| `SecureProfit` | 50 | Порог нереализованной прибыли (в валюте счёта) для защиты. |
| `TakeProfitPips` | 30 | Тейк-профит в пунктах для каждой сделки. |
| `StopLossPips` | 90 | Стоп-лосс в пунктах для каждой сделки. |
| `TrailingStopPips` | 15 | Размер трейлинг-стопа после активации. |
| `ReverseCondition` | false | Инвертирует интерпретацию наклона MACD. |
| `MacdFast` | 14 | Период быстрой EMA в MACD. |
| `MacdSlow` | 26 | Период медленной EMA в MACD. |
| `MacdSignal` | 1 | Период сигнальной EMA в MACD. |

## Примечания и ограничения

- В StockSharp используется неттинговый учёт позиций, поэтому одновременно держать лонг и шорт по одному инструменту нельзя. При смене направления противоположная корзина закрывается.
- Логика защиты счёта использует `PriceStep` и `StepPrice`. Если инструмент не содержит этих данных, применяется шаг 0.0001 и стоимость шага 1, поэтому параметры прибыли стоит адаптировать.
- Управление риском требует положительного значения `StopLossPips`. При нулевом стопе объём не рассчитывается и новые сделки игнорируются.
- Стратегия анализирует только закрытые свечи. Внутридневные сигналы MACD из MetaTrader могут появляться на одну свечу позже, что делает тестирование более стабильным.
