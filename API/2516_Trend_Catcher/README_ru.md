# Стратегия Trend Catcher

## Обзор
Trend Catcher — это конвертация эксперта MetaTrader 5 «Trend_Catcher_v2». Стратегия объединяет три экспоненциальные скользящие средние и индикатор Parabolic SAR для поиска разворотных точек и продолжений тренда. Алгоритм работает по одному инструменту и таймфрейму, анализируя только закрытые свечи. Такой подход упрощает тестирование в StockSharp Designer и позволяет запускать стратегию через любые приложения на базе StockSharp API.

## Индикаторы и фильтры
- **Parabolic SAR** — определяет смену направления (flip), указывающую на потенциальный разворот.
- **Медленная EMA** — основной фильтр тренда старшего порядка.
- **Быстрая EMA** — подтверждает направление текущего импульса.
- **Триггерная EMA** — контролирует расстояние до цены и отфильтровывает запоздалые входы.
- **Фильтр по дням недели** — позволяет отключать торговлю в выбранные будни.

## Торговые правила
### Условия для покупок
1. Цена закрытия находится выше текущего значения Parabolic SAR.
2. Предыдущая свеча закрылась ниже предыдущего значения Parabolic SAR (бычий flip).
3. Быстрая EMA выше медленной EMA, подтверждая восходящий тренд.
4. Цена закрытия выше триггерной EMA, что исключает контртрендовые сигналы.
5. Позиция отсутствует и в текущей свече ещё не было закрытий.

### Условия для продаж
Условия зеркальные:
1. Цена закрытия ниже текущего Parabolic SAR.
2. Предыдущая свеча закрылась выше предыдущего значения Parabolic SAR (медвежий flip).
3. Быстрая EMA ниже медленной EMA.
4. Цена закрытия ниже триггерной EMA.
5. Позиция отсутствует и в текущей свече ещё не было закрытий.

При активации параметра **Reverse Signals** логика входов зеркально инвертируется, что позволяет торговать сигналы в противоположную сторону.

## Сопровождение позиции
- **Авто-стоп** — расстояние до стоп-лосса рассчитывается как модуль разницы между ценой и Parabolic SAR, умноженный на `StopLossCoefficient`, и ограничивается диапазоном `MinStopLoss`–`MaxStopLoss`.
- **Авто-таргет** — тейк-профит определяется умножением стопа на `TakeProfitCoefficient`. При отключении автоматического режима используются фиксированные значения `ManualStopLoss` и `ManualTakeProfit`.
- **Расчёт объёма по риску** — размер позиции вычисляется на основе капитала портфеля и параметра `RiskPercent`. Если последняя сделка закрылась с убытком и включён **Use Martingale**, объём умножается на `MartingaleMultiplier`.
- **Перевод в безубыток и трейлинг** — после достижения прибыли `BreakevenTrigger` стоп переносится в точку входа плюс `BreakevenOffset` (для продаж — минус). При дальнейшем росте прибыли до `TrailingTrigger` стоп следует за ценой на расстоянии `TrailingStep`.
- **Закрытие по противоположному сигналу** — при активном флаге `CloseOnOppositeSignal` позиция закрывается сразу после появления обратного сигнала.
- **Ограничение «одна сделка на свечу»** — время последнего выхода сохраняется, и новые входы разрешаются только после открытия следующей свечи.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Таймфрейм, на котором строятся свечи и индикаторы. | 15 минут |
| `CloseOnOppositeSignal` | Закрывать позицию при противоположном сигнале. | `true` |
| `ReverseSignals` | Инвертировать условия для покупок и продаж. | `false` |
| `TradeMonday` … `TradeFriday` | Разрешение торговли по дням недели. | `true` |
| `SlowMaPeriod` | Период медленной EMA. | `200` |
| `FastMaPeriod` | Период быстрой EMA. | `50` |
| `FastFilterPeriod` | Период триггерной EMA. | `25` |
| `SarStep` | Шаг ускорения Parabolic SAR. | `0.004` |
| `SarMax` | Максимальное ускорение Parabolic SAR. | `0.2` |
| `AutoStopLoss` | Включить автоматический расчёт стоп-лосса. | `true` |
| `AutoTakeProfit` | Включить автоматический расчёт тейк-профита. | `true` |
| `MinStopLoss` / `MaxStopLoss` | Минимальная и максимальная дистанция стопа. | `0.001` / `0.2` |
| `StopLossCoefficient` | Множитель для расчёта стопа по SAR. | `1` |
| `TakeProfitCoefficient` | Множитель для расчёта тейк-профита. | `1` |
| `ManualStopLoss` | Фиксированный стоп-лосс при ручном режиме. | `0.002` |
| `ManualTakeProfit` | Фиксированный тейк-профит при ручном режиме. | `0.02` |
| `RiskPercent` | Процент капитала под риск на сделку. | `2` |
| `UseMartingale` | Увеличивать объём после убыточной сделки. | `true` |
| `MartingaleMultiplier` | Множитель мартингейла. | `2` |
| `BreakevenTrigger` | Прибыль для перевода в безубыток. | `0.005` |
| `BreakevenOffset` | Запас при переносе стопа в безубыток. | `0.0001` |
| `TrailingTrigger` | Прибыль для включения трейлинга. | `0.005` |
| `TrailingStep` | Расстояние трейлинг-стопа. | `0.001` |

## Рекомендации по использованию
- Стратегия отправляет рыночные заявки; контроль проскальзывания следует реализовывать на уровне брокерского адаптера.
- Поскольку расчёт выполняется по закрытым свечам, точность тестирования зависит от используемого таймфрейма и качества исторических данных.
- Все параметры доступны через `StrategyParam`, поэтому стратегию можно оптимизировать в Designer или автоматизировать подбор настроек.
