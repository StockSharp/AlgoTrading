# Стратегия Twenty Pips Price Channel

## Обзор

Twenty Pips Price Channel — это конвертация советника MetaTrader *20 pips*, сочетающего ценовой канал по типу Дончиана с простыми скользящими средними. Алгоритм ищет моменты, когда свеча открывается в противоположную сторону по отношению к предыдущей, проверяет направление по средней на типичной цене и сопровождает позицию фиксированным тейк-профитом в 20 пунктов и каналом, подтягивающим защитный стоп.

При переносе на StockSharp сохранена логика оригинала, но управление заявками адаптировано под высокоуровневый API. Сделки открываются и закрываются рыночными ордерами, тейк-профит контролируется внутри стратегии, а модификация стоп-ордера моделируется через условия по каналу.

## Логика торговли

1. **Набор индикаторов**
   - Однопериодная простая средняя от типичной цены (High + Low + Close) / 3 отображает значение типичной цены предыдущей свечи.
   - Медленная простая средняя с настраиваемым периодом (по умолчанию 20) рассчитывается по закрытиям и соответствует `MA_Low` из исходного кода.
   - Индикаторы Highest и Lowest с тем же периодом, что и канал, воспроизводят буферы пользовательского индикатора Price Channel.

2. **Условия входа**
   - Покупка: предыдущее значение быстрой средней выше медленной **и** текущая свеча открылась ниже открытия предыдущей. После убыточной сделки объём умножается на коэффициент восстановления (по умолчанию 2). Цена входа запоминается для расчёта результата.
   - Продажа: предыдущее значение быстрой средней ниже медленной **и** текущая свеча открылась выше предыдущей. Масштабирование объёма выполняется по тем же правилам.

3. **Сопровождение позиции**
   - При открытии выставляется целевой уровень на расстоянии `TakeProfitPips`, умноженном на шаг цены инструмента.
   - Трейлинг-стоп моделирует вызов `OrderModify`: когда минимум (или максимум) предыдущей свечи выходит за границы канала (в оригинале использовался сдвиг на две свечи), стоп подтягивается к экстремуму ± `TrailingOffsetPips` пунктов. Если следующая свеча открывается за пределами экстремума, позиция закрывается по цене открытия.
   - Все выходы выполняются рыночными ордерами. Фактическая цена выхода используется, чтобы определить была ли последняя сделка прибыльной для последующего масштабирования объёма.

4. **Восстановление после убытков**
   - После каждой убыточной сделки объём следующего входа умножается на `RecoveryMultiplier`. Прибыльная сделка возвращает объём к базовому значению.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип свечей для расчётов. | Часовые свечи |
| `ChannelPeriod` | Период ценового канала. | 20 |
| `SlowMaPeriod` | Период медленной средней. | 20 |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | 20 |
| `TrailingOffsetPips` | Смещение при подтягивании стопа. | 10 |
| `RecoveryMultiplier` | Множитель объёма после убытка. | 2 |
| `Volume` | Базовый торговый объём. | 0.1 |

## Рекомендации

- Стратегия предполагает, что `Security.PriceStep` соответствует размеру пункта по инструменту. При необходимости скорректируйте параметры `TakeProfitPips` и `TrailingOffsetPips`.
- Использование рыночных ордеров вместо лимитных и стоповых может давать отличия по проскальзыванию относительно MT4, но целевые уровни соответствуют оригиналу.
- Значения канала сдвинуты на две свечи для имитации вызова `iCustom` с `shift = 2`, как в исходнике.
- Чтобы отключить мартингейл, установите `RecoveryMultiplier` равным 1.
