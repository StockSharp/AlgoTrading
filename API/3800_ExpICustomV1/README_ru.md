# Стратегия ExpICustomV1

## Краткое описание

**ExpICustomV1** — порт советника MetaTrader `exp_iCustom_v1` на платформу StockSharp. Стратегия получает торговые сигналы из настраиваемого индикатора и открывает позиции при появлении ненулевых значений в выбранных буферах: ненулевой buy-буфер запускает длинную позицию, sell-буфер — короткую. Стоп-лосс, тейк-профит, трейлинг и перевод в безубыток повторяют логику оригинального эксперта.

> **Важно:** реализована только C# версия. Python-вариант пока отсутствует.

## Логика торговли

1. Подписываемся на основной таймфрейм из параметра **Тип свечей** и работаем только с закрытыми свечами.
2. Создаём индикатор, указанный в **Имя индикатора**, применяем параметры из строки **Параметры индикатора** (поддерживаются записи `Имя=Значение` и упорядоченные числа).
3. Сохраняем финальные значения индикатора в истории, чтобы обращаться к ним с нужным сдвигом.
4. Если значение buy-буфера со сдвигом **Сдвиг индикатора** отлично от нуля — открываем/удерживаем длинную позицию; если ненулевой sell-буфер — открываем/удерживаем короткую позицию.
5. При одновременном появлении buy и sell сигналов они взаимно отменяются, исключая неопределённость.
6. Опция **Закрывать при развороте** закрывает текущую позицию до обработки обратного сигнала.
7. Механизм «сна» ограничивает частоту входов в одном направлении, а параметр **Сбрасывать сон** позволяет обнулить таймер при противоположном сигнале.
8. Управление риском осуществляется через стоп-лосс, тейк-профит, трейлинг-стоп и перевод в безубыток (все расстояния задаются в пунктах).

## Настройка индикатора

* **Имя индикатора** — полное имя типа или сокращённое название индикатора StockSharp (`SMA`, `MACD`, `BollingerBands` и т.д.).
* **Параметры индикатора** — строка с параметрами, разделёнными слешем. Поддерживаются варианты `Length=14/Width=2` и просто `14/2/0.7`.
* **Блоки переопределения** — до пяти замен параметров по индексу, аналог входных параметров `Opt_X` в исходном советнике. Индексация начинается с нуля.

## Управление рисками и капиталом

* **Базовый объём** — объём каждой рыночной заявки.
* **Стоп-лосс / Тейк-профит** — расстояние от цены входа в пунктах.
* **Трейлинг-стоп** — активируется при достижении прибыли и удерживает заданный разрыв.
* **Перевод в безубыток** — переносит стоп ближе к цене входа после фиксированного профита и может дополнительно фиксировать пункты.

## Параметры

| Параметр | Назначение |
|----------|------------|
| Тип свечей | Таймфрейм, используемый для расчёта индикатора и сигналов. |
| Имя индикатора | Тип создаваемого индикатора. |
| Параметры индикатора | Список параметров, разделённых слешем. |
| Буфер Buy / Sell | Индексы буферов с сигналами на покупку/продажу. |
| Сдвиг индикатора | Глубина истории при чтении буфера. |
| Блоки переопределения | Замена значений в списке параметров по индексу. |
| Свечей сна | Минимальное число свечей между повторными входами в одном направлении. |
| Сбрасывать сон | Сбрасывать таймер сна при обратном сигнале. |
| Закрывать при развороте | Закрывать текущую позицию перед разворотом. |
| Макс. ордеров / Макс. Buy / Макс. Sell | Ограничения на количество одновременно открытых позиций. |
| Стоп-лосс / Тейк-профит | Дистанция в пунктах для защитных уровней. |
| Настройки трейлинга | Управление активацией и шагом трейлинг-стопа. |
| Настройки безубытка | Управление активацией и фиксацией прибыли при переводе в безубыток. |
| Базовый объём | Объём одной заявки. |

## Как использовать

1. Добавьте стратегию в контейнер, назначьте **Инструмент** и **Портфель**.
2. Настройте **Имя индикатора** и **Параметры индикатора** в соответствии с нужным пользовательским индикатором.
3. Подберите параметры управления рисками (стоп, тейк, трейлинг, безубыток) и базовый объём.
4. Запустите стратегию. Она подпишется на выбранный таймфрейм, вычислит буферы индикатора и отправит рыночные заявки при выполнении условий.

## Ограничения

* Использовать можно только индикаторы, реализованные в StockSharp. Загружать бинарные индикаторы MetaTrader невозможно.
* Сложные режимы мани-менеджмента, зависящие от свободной маржи, упрощены до фиксированного объёма сделки.
