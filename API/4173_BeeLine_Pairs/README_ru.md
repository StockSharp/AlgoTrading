# Стратегия BeeLine Pairs

**BeeLine Pairs Strategy** — это система возврата к среднему, конвертированная из оригинального эксперта MQL5. Она торгует двумя коррелированными инструментами, постоянно пересчитывает коэффициент сжатия цены между ними и входит в рынок, когда синтетический спред отклоняется от динамического порога. Вместо открытия двух ног стратегия при необходимости может использовать одиночный кросс-инструмент, представляющий пару.

## Основные идеи

- **Коэффициент сжатия** — пересчёт соотношения между инструментами по экстремумам за последний диапазон `TrainingRange`.
- **Отслеживание отклонения** — измерение спреда в пунктах базового инструмента и масштабирование объёма входа по числу стандартных отклонений.
- **Торговля кроссом** — при наличии кросс-инструмента сигнал может инвертироваться в зависимости от флага `UseDirectCrossRate`.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `SecondSecurity` | Второй инструмент пары. Обязательно указывается перед запуском. | `None` |
| `CrossSecurity` | Необязательный кросс, который заменяет две ноги. | `None` |
| `UseDirectCrossRate` | Использовать сигнал напрямую (`true`) или инвертировать его (`false`). | `true` |
| `TrainingRange` | Количество завершённых свечей для оценки сжатия и ширины сигнала. | `640` |
| `ProfitPercent` | Закрыть все позиции при достижении указанной прибыли портфеля. | `3` |
| `SignalCorrection` | Множитель, который сжимает найденное максимальное отклонение. | `0.7` |
| `DistanceMultiplier` | Во сколько раз расширяется окно поиска максимального отклонения. | `1.2` |
| `RetrainInterval` | Количество свечей между пересчётами коэффициента сжатия. | `120` |
| `MaxDeals` | Максимальный коэффициент масштабирования базового объёма. | `3` |
| `CloseCorrection` | Закрытие при сжатии отклонения ниже указанной доли от сигнала. | `0.618034` |
| `Correlation` | Тип связи между инструментами (`1` — положительная, `-1` — обратная). | `1` |
| `CandleType` | Таймфрейм для расчётов. | `5 минут` |

## Логика торговли

1. Подписаться на выбранный таймфрейм для обоих инструментов и синхронизировать свечи по времени открытия.
2. После накопления данных пересчитать коэффициент сжатия и окно максимального отклонения. Верхняя граница сигнала равна максимальному абсолютному отклонению, умноженному на `SignalCorrection`.
3. Сохранять отклонение каждой завершённой свечи. Сигнал возникает, если:
   - Абсолютное отклонение превышает границу сигнала.
   - Значение отклонения начало сокращаться относительно предыдущей свечи.
   - Стратегия не исчерпала лимит `MaxDeals` на масштабирование объёма.
4. При появлении сигнала:
   - **Положительная корреляция (`Correlation = 1`)** — продать базовый инструмент и купить второй при положительном отклонении, иначе выполнить обратную комбинацию.
   - **Отрицательная корреляция (`Correlation = -1`)** — открыть обе позиции в одном направлении, чтобы использовать обратную зависимость.
   - **Настроен кросс** — торговать кросс-инструментом, при необходимости инвертируя сигнал согласно `UseDirectCrossRate`.
5. Закрыть позиции, когда выполняется одно из условий:
   - Отклонение пересекает ноль с учётом правил корреляции.
   - Отклонение уменьшается ниже `CloseCorrection * MaxDeviation`.
   - Прирост капитала портфеля достигает `ProfitPercent` от стартового значения.

## Практические замечания

- Убедитесь, что для обоих инструментов заданы корректные `PriceStep`, `StepPrice` и параметры объёмов — они используются для нормализации отклонений и объёмов сделок.
- Стратегия хранит последние значения отклонения, чтобы перестраивать границу сигнала после каждого пересчёта, и автоматически ограничивает размер истории.
- При торговле кроссом вторичный инструмент остаётся без позиции; необходимо правильно настроить отображение кросса в коннекторе.
- Перед отправкой рыночных заявок объёмы нормализуются под биржевые ограничения каждого инструмента.
