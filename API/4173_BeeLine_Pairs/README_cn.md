# BeeLine Pairs 策略

**BeeLine Pairs Strategy** 源自原始的 MQL5 专家顾问，是一套均值回归系统。它同时跟踪两只相关资产，不断重新计算它们之间的价格压缩系数，并在合成价差偏离动态阈值时入场。若提供了交叉品种，策略也可以只交易该交叉合约而不是两条腿。

## 核心思想

- **价格压缩**：依据最近 `TrainingRange` 根 K 线的高低点重新估计两只资产之间的比率。
- **偏差监控**：将价差转换为主交易品种的点数，根据标准差的倍数放大或缩小下单手数。
- **交叉品种执行**：当设置了 `CrossSecurity` 时，可根据 `UseDirectCrossRate` 参数决定是否反向使用信号。

## 参数

| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `SecondSecurity` | 与主交易品种成对的第二个品种，启动前必须指定。 | `None` |
| `CrossSecurity` | 可选的交叉品种，用来替代双腿交易。 | `None` |
| `UseDirectCrossRate` | 为 `true` 时直接使用信号，为 `false` 时对信号取反。 | `true` |
| `TrainingRange` | 用于估算压缩系数和信号带宽的已完成 K 线数量。 | `640` |
| `ProfitPercent` | 当投资组合收益达到该百分比时平掉全部仓位。 | `3` |
| `SignalCorrection` | 乘在最大偏差上的校正系数，用于收紧信号阈值。 | `0.7` |
| `DistanceMultiplier` | 搜索最大偏差时使用的历史窗口倍数。 | `1.2` |
| `RetrainInterval` | 相邻两次重新估算压缩系数之间所需的已完成 K 线数量。 | `120` |
| `MaxDeals` | 允许在基础手数上叠加的最大倍数。 | `3` |
| `CloseCorrection` | 当偏差低于该比例的信号宽度时触发保护性平仓。 | `0.618034` |
| `Correlation` | 品种之间的相关性，`1` 表示正相关，`-1` 表示反相关。 | `1` |
| `CandleType` | 计算所用的 K 线类型。 | `5 分钟` |

## 交易逻辑

1. 订阅两个品种的 K 线，并按开盘时间对齐。
2. 在积累到足够数据后，重新计算压缩系数与最大偏差窗口。将获得的最大绝对偏差乘以 `SignalCorrection` 即为当前的信号阈值。
3. 记录每根已完成 K 线的偏差。只有在以下条件同时满足时才生成信号：
   - 当前绝对偏差大于信号阈值；
   - 偏差相较上一根 K 线开始收敛；
   - 尚未超过 `MaxDeals` 指定的最大加仓倍数。
4. 信号成立后：
   - **正相关 (`Correlation = 1`)**：当偏差为正时卖出主品种并买入第二品种，偏差为负时执行相反操作。
   - **反相关 (`Correlation = -1`)**：两条腿在同一方向开仓，以捕捉反向联动。
   - **设置了交叉品种**：仅交易交叉合约，如有需要根据 `UseDirectCrossRate` 反向信号。
5. 满足以下任一条件即平仓：
   - 偏差根据相关性规则穿越零值；
   - 偏差下降到 `CloseCorrection * MaxDeviation` 以下；
   - 投资组合收益达到 `ProfitPercent` 的目标。

## 实践提示

- 请确保两个品种都提供了有效的 `PriceStep`、`StepPrice` 以及成交量步长，这些信息用于偏差换算和手数归一化。
- 策略保留最近的偏差数据，以便在每次重新估算后立即恢复信号阈值，并自动限制历史长度。
- 交易交叉合约时，二号品种不会持仓；请在连接器端正确映射交叉品种代码。
- 下单前会根据各自交易所的要求对成交量进行归一化处理。
