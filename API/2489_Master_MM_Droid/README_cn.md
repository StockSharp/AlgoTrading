# Master MM Droid 策略

## 概述
Master MM Droid 是将 MetaTrader 5 专家顾问迁移到 StockSharp 平台的多模块策略。实现完全基于高层 API：通过订阅蜡烛、绑定指标以及使用高层下单方法复制原有 EA 的结构。四个资金管理模块可以单独启用/禁用，从而自由组合动量入场、时间盒突破与周度缺口交易。

## 模块说明
1. **RSI 模块**
   - 在所选蜡烛类型上计算 14 周期 RSI。
   - RSI 从超卖区向上穿越触发做多，从超买区向下穿越触发做空。
   - 支持按固定点差叠加仓位，并可限制最大叠加次数。
   - 进入后立即设置初始止损，并交由跟踪止损管理。
2. **箱体突破模块**
   - 每日三次重新计算箱体范围（默认平移后的 6、12、20 点）。
   - 在箱体高点上方和低点下方按照设定偏移放置 Buy Stop / Sell Stop。
   - 在 0、10、16 点重置时取消所有挂单并平仓，保持与原版 EA 相同的节奏。
3. **周度突破模块**
   - 记录周一开始阶段的最高价与最低价。
   - 在 `StartHour` 到 `WeeklySetupEndHour` 的窗口内放置对称的止损突破单，以 OCO 方式打开新的一周。
   - 周五晚间强制平仓并撤单，避免周末持仓风险。
4. **缺口模块**
   - 对比新交易日的开盘价与前一日的最高/最低价（同样应用时区平移）。
   - 当开盘价低于前日最低价时买入，开盘价高于前日最高价时卖出。
   - 以点差参数计算保护性止损，并交由公共跟踪模块继续管理。

## 参数总览
| 参数 | 说明 |
| ---- | ---- |
| `CandleType` | 指标与时间调度使用的蜡烛类型。 |
| `TimeShiftHours` | 相对于 UTC 的时间平移，用于对齐交易时段。 |
| `StartHour` | 周度模块的基础起始小时（尚未平移前的值）。 |
| `Enable*Module` | 控制四个模块的启用状态。 |
| `Rsi*` | RSI 周期、阈值以及加仓逻辑。 |
| `BoxEntryPoints`、`BoxTrailingPoints` | 箱体突破的偏移与跟踪距离。 |
| `WeeklyEntryPoints`、`WeeklySetupEndHour`、`WeeklyTrailingPoints` | 周度突破的触发设置。 |
| `GapStopLossPoints`、`GapTrailingPoints` | 缺口交易的初始止损与跟踪距离。 |

所有以“点”为单位的参数都会乘以品种的 `TickSize`，从而适配不同报价精度。

## 交易逻辑
- **指标绑定**：将 RSI 指标绑定到蜡烛订阅，`ProcessCandle` 在每根完整蜡烛结束时调用四个模块。
- **日内状态**：维护当前日期的开盘价、最高价、最低价以及前一天的区间，为缺口与周度模块提供数据。
- **下单流程**：统一使用 `BuyMarket`、`SellMarket`、`BuyStop`、`SellStop` 等高层方法；在重新布置箱体或周度挂单前会取消旧挂单。
- **跟踪止损**：`_activeTrailingPoints` 保存最新的跟踪距离，只允许止损朝有利方向移动。

## 风险控制
- RSI 与缺口模块在开仓时立即给出固定点差的初始止损。
- 箱体和周度突破交由跟踪止损管理，可根据需要叠加额外的组合风控。
- 使用 `ClosePosition()` 平仓，便于与 StockSharp 的风险保护功能集成。

## 使用建议
- 策略针对单一标的，订单数量取自全局 `Volume`。若需按资产比例控制仓位，请结合组合级风控使用。
- 所有时间判断均在应用 `TimeShiftHours` 后执行。例如默认值为 2，箱体在“0 点”重置实为服务器时间 02:00。
- StockSharp 采用净持仓模式，与 MT5 的对冲账户不同，因此无法同时保持方向相反的多个仓位。这是相对于原策略的主要差异。

## 监控
- `_boxOrdersPlaced`、`_weeklyOrdersPlaced` 等标志可帮助定位当前活动的模块。
- 如需更丰富的可视化或日志，可使用 StockSharp 自带的图表与日志工具进行扩展。
