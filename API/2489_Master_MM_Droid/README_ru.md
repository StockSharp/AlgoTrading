# Master MM Droid Strategy

## Обзор
Master MM Droid — это перенос советника MetaTrader 5 в экосистему StockSharp. Стратегия сохраняет четырёхблочную структуру управления позицией, но использует высокоуровневые подписки на свечи, индикаторы и методы размещения заявок из StockSharp. Каждый блок можно включать или выключать, комбинируя импульсные входы, таймовые пробои и отработку гэпов.

## Модули
1. **RSI**
   - Рассчитывает RSI с периодом 14 на выбранном таймфрейме.
   - Покупает при выходе индикатора из перепроданности и продаёт при выходе из перекупленности.
   - Поддерживает наращивание позиции с фиксированным шагом в пунктах и ограничением по количеству доливок.
   - Сразу выставляет первоначальный стоп и включает трейлинг после открытия позиции.
2. **Пробой коробки**
   - Формирует уровни три раза в сутки (по сдвинутому времени: 6, 12 и 20 часов).
   - Ставит отложенные Buy Stop и Sell Stop с заданным отступом от минимума/максимума.
   - Полностью очищает заявки и позиции в моменты сброса (0, 10 и 16 часов), как и оригинальный советник.
3. **Недельный пробой**
   - Накопительно фиксирует максимум и минимум понедельника до окончания окна `StartHour` – `WeeklySetupEndHour`.
   - Размещает симметричные стоп-заявки, открывая неделю через OCO-пробой.
   - Закрывает позиции и отменяет заявки в пятницу вечером для ухода из рынка перед выходными.
4. **Гэп-блок**
   - Сравнивает новое дневное открытие с максимумом/минимумом предыдущего дня с учётом часового сдвига.
   - Покупает глубокие гэпы вниз и продаёт гэпы вверх.
   - Выставляет защитный стоп по расстоянию в пунктах и передаёт сопровождение модулю трейлинга.

## Параметры
| Имя | Описание |
| --- | -------- |
| `CandleType` | Таймфрейм свечей, с которыми работают индикаторы и расписание модулей. |
| `TimeShiftHours` | Сдвиг торговой сессии относительно UTC для корректного расписания. |
| `StartHour` | Базовый стартовый час понедельника для недельного модуля (до учёта сдвига). |
| Переключатели `Enable*Module` | Включение/отключение каждого блока. |
| Параметры `Rsi*` | Настройки индикатора RSI и логики доливок. |
| `BoxEntryPoints`, `BoxTrailingPoints` | Отступы и трейлинг для пробоя коробки. |
| `WeeklyEntryPoints`, `WeeklySetupEndHour`, `WeeklyTrailingPoints` | Конфигурация недельных заявок. |
| `GapStopLossPoints`, `GapTrailingPoints` | Защитный стоп и трейлинг для торговли гэпов. |

Все величины в пунктах автоматически масштабируются через `TickSize` инструмента.

## Логика торговли
- **Индикатор**: к подписке на свечи привязан один RSI, значения которого передаются во все блоки.
- **Суточная статистика**: стратегия отслеживает открытие, максимум и минимум каждого сдвинутого дня, чтобы корректно обрабатывать гэпы и понедельничные диапазоны.
- **Заявки**: используются методы `BuyMarket`, `SellMarket`, `BuyStop`, `SellStop`. Перед повторной установкой коробок и недельных стопов стратегия отменяет активные заявки, предотвращая дубли.
- **Трейлинг**: модуль хранит текущее расстояние `_activeTrailingPoints` и подтягивает защитный стоп только в сторону прибыли.

## Управление риском
- Для сделок RSI и гэпов сразу выставляется фиксированный стоп на заданном расстоянии.
- Пробойные блоки переводятся на трейлинг после активации; при необходимости их можно дополнить внешними ограничителями риска.
- Функция `ClosePosition()` используется для принудительного выхода и совместима с защитой портфеля StockSharp.

## Особенности эксплуатации
- Стратегия работает с одним инструментом и использует глобальный `Volume` для расчёта объёма. Если нужна индивидуальная доля риска, настройте портфельный риск-менеджер.
- Все контрольные часы интерпретируются после применения `TimeShiftHours`.
- Net-позиция StockSharp объединяет все сделки, поэтому одновременные длинные и короткие позиции (возможные в MT5 с хеджированием) сводятся к одной. Это ключевое отличие от оригинального робота.

## Мониторинг
- Флаги `_boxOrdersPlaced`, `_weeklyOrdersPlaced` и стоповые уровни позволяют понять, какой модуль активен.
- При необходимости можно добавить визуализацию или расширенное логирование средствами платформы.
