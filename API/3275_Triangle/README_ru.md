# Стратегия Triangle
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник **Triangle v1** из MetaTrader на высокоуровневый API StockSharp. В оригинале используются взвешенные скользящие средние на старшем таймфрейме, импульсный фильтр Momentum и долгосрочный MACD перед открытием сделок. В портированной версии сохранена много таймфреймная логика, а денежное сопровождение заменено защитными заявками, работающими по завершённым свечам.

## Как это работает

1. **Много таймфреймов.** Рабочий таймфрейм (`CandleType`, по умолчанию 15 минут) отвечает за сделки. Трендовый и импульсный фильтры считаются на старшем таймфрейме (`TrendCandleType`, по умолчанию 1 час), что повторяет использование переменной `T` в MQL.
2. **Фильтр LWMA.** Быстрая и медленная взвешенные скользящие должны быть направлены в сторону сделки. Для покупок быстрая LWMA должна быть выше медленной, для продаж – ниже.
3. **Отклонение Momentum.** Импульс с периодом 14 на старшем таймфрейме должен хотя бы на одном из трёх последних значений отклоняться от уровня 100 больше, чем `MomentumThreshold`, что воспроизводит проверки `MomLevelB/MomLevelS`.
4. **Подтверждение MACD.** MACD на очень большом таймфрейме (`MacdCandleType`, по умолчанию свечи длительностью 30 дней ≈ месяц) должен показывать, что основная линия находится по нужную сторону от сигнальной, как в условиях `MacdMAIN0` и `MacdSIGNAL0`.
5. **Выходы по стопам.** Дистанции стоп-лосса и тейк-профита задаются в шагах цены. При достижении уровня на закрытой свече позиция закрывается рыночным ордером.

## Параметры

| Параметр | Описание |
| --- | --- |
| `FastMaPeriod`, `SlowMaPeriod` | Периоды взвешенных средних на старшем таймфрейме. |
| `MomentumPeriod` | Период индикатора Momentum на старшем таймфрейме. |
| `MomentumThreshold` | Минимальное абсолютное отклонение от уровня 100 на любом из трёх последних значений Momentum. 0 отключает фильтр. |
| `MacdFastLength`, `MacdSlowLength`, `MacdSignalLength` | Параметры MACD на таймфрейме `MacdCandleType`. |
| `StopLossSteps`, `TakeProfitSteps` | Дистанции до стоп-лосса и тейк-профита в шагах цены инструмента. 0 — отключить. |
| `CandleType` | Рабочий таймфрейм для исполнения сделок. |
| `TrendCandleType` | Старший таймфрейм для LWMA и Momentum. |
| `MacdCandleType` | Таймфрейм для фильтра MACD. |

## Использование

1. Выберите инструмент и задайте таймфреймы `CandleType`, `TrendCandleType` и `MacdCandleType` под свой анализ.
2. При необходимости измените периоды MA, Momentum и MACD, чтобы адаптировать стратегию к волатильности рынка.
3. Настройте `StopLossSteps` и `TakeProfitSteps` с учётом шага цены инструмента — стратегия автоматически переводит шаги в абсолютные значения.
4. Запустите стратегию. Она оформит необходимые подписки на свечи, обновит индикаторы через `Bind` и будет управлять позицией по достижению стопа или цели.

## Отличия от оригинального советника

- Денежные и процентные выходы (`Use_TP_In_Money`, `Use_TP_In_percent`) и блок защиты капитала не портированы, так как в StockSharp работа идёт в шагах цены. Эквивалент можно получить подбором `StopLossSteps`/`TakeProfitSteps`.
- Логика трейлинга, безубытка и equity-stop в MQL опиралась на тиковые события и модификации ордеров MetaTrader. В портированной версии оставлены фиксированные уровни для наглядности; при желании можно расширить `UpdatePositionState` своими правилами.
- Ручные трендовые линии (`TREND`/`TRENDLOW`) и фракталы применялись как субъективные фильтры. Они убраны, чтобы стратегия была полностью алгоритмической.
- В StockSharp поддерживается только одна чистая позиция, что соответствует типичному использованию советника, несмотря на параметр `Max_Trades`.

Подбирайте пороги и таймфреймы под торгуемый инструмент. На волатильных рынках обычно требуются более широкие значения, чтобы шум Momentum не блокировал сигналы.
