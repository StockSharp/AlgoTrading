# FT CCI MA (порт на StockSharp)

## Обзор
Стратегия является прямым портом советника MetaTrader "FT CCI MA". Торговые решения принимаются на закрытии каждой свечи, используя линейно-взвешенную скользящую среднюю (LWMA) в сочетании с порогами индикатора CCI и необязательным фильтром торговой сессии. Реализация на StockSharp сохраняет исходные параметры и их значения по умолчанию, но опирается на высокоуровневый API (подписка на свечи, привязка индикаторов, управление защитой позиции).

Особенности реализации:
- LWMA рассчитывается по взвешенной цене `(High + Low + 2 * Close) / 4`, что соответствует режиму `PRICE_WEIGHTED` в MetaTrader.
- CCI использует типичную цену `(High + Low + Close) / 3`, как в `PRICE_TYPICAL`.
- Сигналы оцениваются по завершённой свече — то же поведение, что и в оригинале, где сделки открывались в начале следующей свечи на данных предыдущей.
- Защитные ордера воспроизводят тейк-профит и стоп-лосс в пипсах.

## Правила торговли
1. **Вход в длинную позицию**
   - Цена закрытия выше LWMA и CCI ниже `CciLevelBuy` (по умолчанию -100), *или*
   - Цена закрытия ниже LWMA и CCI ниже `CciLevelDown` (по умолчанию -200).
   - Сделка возможна только при нулевой или короткой текущей позиции.
2. **Вход в короткую позицию**
   - Цена закрытия ниже LWMA и CCI выше `CciLevelSell` (по умолчанию 100), *или*
   - Цена закрытия выше LWMA и CCI выше `CciLevelUp` (по умолчанию 200).
   - Сделка возможна только при нулевой или длинной текущей позиции.
3. **Фильтр по времени**
   - При включенном `UseTimeFilter` стратегия проверяет час из `candle.CloseTime`.
   - Если текущий час вне допустимого интервала, все позиции и активные заявки немедленно закрываются.
4. **Управление рисками**
   - `StartProtection` задаёт абсолютные уровни стоп-лосса и тейк-профита, переводя пипсы в цену через `Security.PriceStep`.
   - Объём ордера учитывает текущую нетто-позицию, поэтому разворот автоматически закрывает противоположную сторону.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `OrderVolume` | Торговый объём в лотах. | `1` |
| `StopLossPips` | Дистанция стоп-лосса в пипсах (0 отключает). | `150` |
| `TakeProfitPips` | Дистанция тейк-профита в пипсах (0 отключает). | `150` |
| `UseTimeFilter` | Включает фильтр торговой сессии. | `true` |
| `StartHour` | Час начала торговли (0–23). | `10` |
| `EndHour` | Час окончания торговли (0–23). При значении меньше `StartHour` интервал пересекает полночь. | `5` |
| `CciPeriod` | Период индикатора CCI. | `14` |
| `CciLevelUp` | Верхний порог для агрессивных продаж (+200). | `200` |
| `CciLevelDown` | Нижний порог для агрессивных покупок (-200). | `-200` |
| `CciLevelBuy` | Мягкий порог для покупок, когда цена выше MA (-100). | `-100` |
| `CciLevelSell` | Мягкий порог для продаж, когда цена ниже MA (+100). | `100` |
| `MaPeriod` | Период LWMA. | `200` |
| `MaShift` | Горизонтальный сдвиг LWMA в барах; используется значение `MaShift` баров назад. | `0` |
| `CandleType` | Тип/таймфрейм свечей для расчётов. | `1 час` |

## Детали реализации
- **Пипсы** – Базовый размер шага берётся из `Security.PriceStep`. Для инструментов с 3 или 5 знаками размер умножается на 10, чтобы привести 0.00001 к 0.0001, как в MetaTrader.
- **Фильтр сессии** – Учтены оба сценария из исходного кода: внутридневной (`StartHour < EndHour`) и ночной (`StartHour > EndHour`). При равных значениях торговля отключается, как и в оригинале.
- **Привязка индикаторов** – Используется `SubscribeCandles().Bind(...)`, поэтому дополнительные буферы не требуются; история LWMA хранится только ради опционального сдвига.
- **Управление ордерами** – Перед открытием позиции вызывается `CancelActiveOrders()`, что соответствует очистке стакана заявок в MQL-версии.
- **Python-версии нет** – В каталоге присутствует только C#-реализация.

## Использование
1. Подключите стратегию к инструменту и задайте `CandleType` с нужным таймфреймом.
2. Настройте объём и параметры в пипсах с учётом спецификаций брокера.
3. При необходимости включите фильтр торговых часов.
4. Запустите стратегию — она самостоятельно подпишется на свечи, применит логику входов и выставит защитные уровни.

