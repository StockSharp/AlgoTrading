# Стратегия Lavika100 (StockSharp)

## Обзор
**Lavika100** — это точная адаптация советника MetaTrader 5 «Lavika  cent». Алгоритм комбинирует RAVI-фильтр на таймфреймах H1 и H4, чтобы отбирать моменты входа. В версии для StockSharp сохранены все ключевые опции оригинала: выбор управления капиталом (фиксированный лот или процент от депозита), работа только с одной позицией, инверсия сигналов и автоматическая постановка стоп-приказов. Реализация целиком построена на высокоуровневом API: свечные подписки управляют жизненным циклом, индикаторы подключаются через `Bind`, защитные уровни настраиваются методом `StartProtection`.

## Схема работы
1. **Свечные подписки** – H1 используется как рабочий таймфрейм, H4 выполняет роль трендового фильтра. Индикатор `SimpleMovingAverage` применяется к ценам открытия, повторяя вызовы `iMA(..., PRICE_OPEN)` из МТ5.
2. **Расчёт RAVI** – на каждом таймфрейме строятся две скользящие средние (быстрая и медленная). Значение RAVI вычисляется по формуле `(fast - slow) / slow * 100`. Пока RAVI на H1 не станет положительным, сделки не рассматриваются.
3. **Паттерны тренда** – анализируются четыре последних значения RAVI на H4:
   - последовательность роста (`r0 > r1`, `r1 < r2`, `r2 < r3`) формирует сигнал на покупку;
   - последовательность падения (`r0 < r1`, `r1 > r2`, `r2 > r3`) формирует сигнал на продажу. Поведение соответствует исходнику, где реальное направление часто задавалось переключателем «Reverse».
4. **Инверсия и зачистка позиции** – параметры `ReverseSignals` и `CloseOpposite` определяют, будет ли сделка открыта по сигналу или в противоположную сторону и закрывается ли встречная позиция заранее.
5. **Управление капиталом** – объём берётся из `FixedVolume` или пересчитывается по проценту риска (`RiskPercent`) с учётом размера стопа.
6. **Защита** – стоп-лосс, тейк-профит, трейлинг и шаг трейлинга активируются через `StartProtection` сразу после старта, если задано ненулевое расстояние.

## Правила торговли
- **Покупка** – RAVI на H1 положительный, RAVI на H4 формирует восходящую последовательность. При `CloseOpposite=true` перед входом закрывается шорт.
- **Продажа** – RAVI на H1 положительный, RAVI на H4 формирует нисходящую последовательность. Параметр `ReverseSignals=true` зеркалит направление, повторяя настройку MT5 «Reverse».
- **Одна позиция** – при `OnlyOnePosition=true` наличие открытой позиции блокирует новые заявки до её закрытия.
- **Расчёт объёма** – режим риска использует связку `PriceStep`/`StepPrice` для перевода ценового расстояния в деньги и учитывает `VolumeStep`, `VolumeMin`, `VolumeMax` инструмента.

## Параметры
| Название | Описание |
| --- | --- |
| `H1CandleType` | Таймфрейм рабочей логики (по умолчанию 1 час). |
| `H4CandleType` | Старший таймфрейм для трендового фильтра (по умолчанию 4 часа). |
| `H1FastPeriod` / `H1SlowPeriod` | Периоды SMA для расчёта RAVI на H1. |
| `H4FastPeriod` / `H4SlowPeriod` | Периоды SMA для расчёта RAVI на H4. |
| `StopLossPoints` | Размер стоп-лосса в пунктах (pip-подобных единицах). |
| `TakeProfitPoints` | Размер тейк-профита в тех же пунктах. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа (0 отключает функцию). |
| `TrailingStepPoints` | Минимальный шаг подтягивания стопа; должен быть > 0 при активном трейлинге. |
| `FixedVolume` | Лот в режиме фиксированного объёма. |
| `RiskPercent` | Процент депозита под риск при выборе `RiskPercent`. |
| `MoneyMode` | Переключатель между `FixedLot` и `RiskPercent`. |
| `OnlyOnePosition` | Разрешить только одну открытую позицию. |
| `ReverseSignals` | Инвертировать направления сделок (по умолчанию true, как в советнике). |
| `CloseOpposite` | Закрывать встречную позицию перед постановкой новой. |

## Особенности портирования
- Пересчёт пунктов повторяет МТ5-логику: для котировок с 3 и 5 знаками `PriceStep` умножается на десять.
- История RAVI хранится в четырёх полях без собственных коллекций, что соответствует запрету на ручные буферы в `AGENTS.md`.
- Управление капиталом не использует запрещённые вызовы индикаторов и опирается на рыночные метаданные StockSharp.
- `StartProtection` вызывается только при наличии хотя бы одного ненулевого защитного расстояния — это безопасно для тестов и торговли.

## Рекомендации по применению
- Используйте инструмент с корректно заданными `PriceStep`, `StepPrice`, `VolumeStep`, `VolumeMin`, `VolumeMax`.
- В режиме процентного риска обязательно задайте `StopLossPoints`, иначе расчётный объём окажется нулевым.
- В оригинале существовала особенность: обе ветки сигнала активировали покупку. Чтобы полностью повторить поведение, оставьте `ReverseSignals=true`.
