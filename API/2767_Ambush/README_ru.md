# Стратегия Ambush
[English](README.md) | [中文](README_cn.md)

Стратегия Ambush постоянно окружает рынок парой отложенных ордеров Buy Stop и Sell Stop. Заявки ставятся на заданном отступе от
лучших Ask и Bid, а также проверяются на минимально допустимое расстояние, зависящее от текущего спреда. Как только один ордер
исполняется, стратегия сразу восстанавливает оба стоп-ордера, поэтому рынок остаётся «в засаде» с двух сторон. Дополнительно
реализован эквити-фильтр, который закрывает открытую позицию при достижении целевой прибыли или допустимого убытка.

Данный перевод воспроизводит оригинальный эксперт MetaTrader 5 от Zuzabush. Алгоритм работает только с котировками уровня Level 1,
не требует свечей и индикаторов, поэтому особенно хорошо подходит для ликвидных инструментов с узким спредом.

## Логика работы

1. **Получение данных**
   - Подписка на изменения Level 1 и хранение последних значений лучшего Bid и Ask.
   - Пока один из котировок отсутствует или торговля запрещена, расчёты не выполняются.
2. **Эквити-фильтры**
   - Складываются реализованная прибыль (`PnL`) и плавающий результат, рассчитанный через `PositionPrice` и текущие Bid/Ask.
   - При превышении `EquityTakeProfit` либо снижении ниже `-EquityStopLoss` открытая позиция закрывается рыночным ордером.
     Отложенные заявки специально не отменяются, что полностью повторяет поведение исходного советника.
3. **Выставление отложенных ордеров**
   - Расчёт текущего спреда в ценовых единицах и сравнение с `MaxSpreadPoints`. Если спред выше порога, новые заявки не
     выставляются.
   - В противном случае вычисляется расстояние `max(IndentationPoints * шаг, спред * 3)`. Оно повторяет MT5-логику: берётся либо
     пользовательский отступ, либо тройной спред при нулевом `StopsLevel` брокера.
   - Buy Stop размещается по цене `Ask + расстояние`, Sell Stop — `Bid - расстояние`. Значения нормализуются по размеру тика.
     Одновременно может существовать только по одной активной заявке каждого типа; выполненные или отменённые ордера очищаются.
4. **Трейлинг отложенных ордеров**
   - Если `TrailingStopPoints` больше нуля, стратегия не чаще чем раз в интервал `Pause` пересчитывает дистанцию `max((TrailingStopPoints
     + TrailingStepPoints) * шаг, спред * 3)` и перевыставляет ордера, когда изменение превышает половину тика.
   - Трейлинг удерживает стоп-заявки вблизи рынка, но при этом соблюдает минимальное расстояние, исключая случайные срабатывания.

В итоге получается симметричный пробойный движок, который постоянно ожидает решительного импульса цены.

## Параметры

| Параметр | Описание |
|----------|----------|
| `IndentationPoints` | Базовый отступ в пунктах между рынком и каждым отложенным ордером. |
| `MaxSpreadPoints` | Максимально допустимый спред в пунктах. Пока спред выше, новые заявки не выставляются. |
| `TrailingStopPoints` | Базовое расстояние трейлинга отложенных заявок. Ноль отключает трейлинг. |
| `TrailingStepPoints` | Дополнительный шаг, который прибавляется к базовому расстоянию трейлинга. |
| `Pause` | Минимальный интервал между двумя пересчётами трейлинга. Значение по умолчанию соответствует паузе в MT5 (1 секунда). |
| `EquityTakeProfit` | Эквити-прибыль в валюте счёта, при которой позиция закрывается. |
| `EquityStopLoss` | Допустимая просадка эквити перед принудительным закрытием позиции. |
| `Volume` | Размер ордера, унаследованный от базового класса `Strategy`. Для повторения MT5 имеет смысл использовать минимальный лот. |

Все отступы в пунктах переводятся в реальные ценовые значения через `Security.PriceStep`. Если тик не задан, используется значение 1.

## Практические замечания

- Стратегия не требует свечей и индикаторов, поэтому легко тестируется на потоке Level 1, даже если история свечей недоступна.
- При наличии у брокера ненулевого `StopsLevel` следует подобрать `IndentationPoints` так, чтобы конечное расстояние удовлетворяло
  требованиям площадки. Тройной спред служит дополнительной страховкой.
- Эквити-фильтр не отменяет отложенные ордера — это сделано намеренно, чтобы сразу возобновить торговлю после закрытия позиции.
- Контроль проскальзывания и допустимых отклонений полностью зависит от брокера или тестового движка. Параметры и `Volume`
  необходимо адаптировать под волатильность инструмента.

Документация составлена максимально подробно, чтобы трейдер мог полностью понять перенос стратегии и адаптировать её под свою
торговую площадку.
