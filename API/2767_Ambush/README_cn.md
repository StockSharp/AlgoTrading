# Ambush 策略
[English](README.md) | [Русский](README_ru.md)

Ambush 策略会持续在市场两侧放置一对 Buy Stop 和 Sell Stop 挂单。挂单距离当前最优报价一定的点数，同时根据当前
点差设置最小距离限制。一旦任意方向被触发，策略会立即重新构建两侧的挂单，让市场始终处于「埋伏圈」。此外
还提供基于权益的风控：当盈亏超过设定阈值时会立刻平掉现有仓位。

本转换版本完整复刻了 Zuzabush 编写的 MT5 专家顾问，只依赖 Level 1 行情，不需要蜡烛或指标，非常适合点差较小、
成交活跃的品种。

## 交易逻辑

1. **行情采集**
   - 订阅 Level 1 更新，保存最新的买一与卖一价格。
   - 在任意一侧缺失或策略不允许交易时，停止后续计算。
2. **权益保护**
   - 实现盈亏 (`PnL`) 与根据 `PositionPrice`、当前买卖价计算出的浮动盈亏相加得到总权益。
   - 当权益达到 `EquityTakeProfit` 或跌破 `-EquityStopLoss` 时，通过市价单平掉当前净头寸。挂单保持不变，与原顾问一致。
3. **挂单布局**
   - 将当前点差（价格单位）与 `MaxSpreadPoints` 比较，若点差过大则暂不下单。
   - 否则计算 `max(IndentationPoints * 最小跳动, 点差 * 3)` 的距离，重现 MT5 中 `StopsLevel` 为零时使用三倍点差的逻辑。
   - 在 `ask + 距离` 放置 Buy Stop，在 `bid - 距离` 放置 Sell Stop，并按最小跳动归一化价格。每侧仅保留一个活动挂单，
     已完成或失败的订单会被清理。
4. **挂单跟踪**
   - 当 `TrailingStopPoints` 大于 0 时，策略在不短于 `Pause` 的间隔后重新计算 `max((TrailingStopPoints + TrailingStepPoints)
     * 最小跳动, 点差 * 3)`，若新价格与原价差异超过半个跳动，则取消并重新下单。
   - 这种方式既能让挂单紧跟市场，也能避免距离过近导致的误触发。

最终形成一个对称的突破引擎，始终等待价格向任意方向的突破。

## 参数说明

| 参数 | 说明 |
|------|------|
| `IndentationPoints` | 挂单与市场之间的基础点数距离。 |
| `MaxSpreadPoints` | 允许的最大点差，点差更大时暂停下单。 |
| `TrailingStopPoints` | 对现有挂单应用的基础跟踪距离，0 表示禁用。 |
| `TrailingStepPoints` | 叠加在基础距离上的额外跟踪步长。 |
| `Pause` | 两次跟踪计算之间的最小时间间隔，默认 1 秒，与原 MT5 顾问一致。 |
| `EquityTakeProfit` | 账户权益达到该利润时立即平仓。 |
| `EquityStopLoss` | 账户权益回撤到该数值时立即平仓。 |
| `Volume` | 下单手数，继承自 `Strategy` 基类，可设置为券商允许的最小手数。 |

所有以点数表示的偏移都会通过 `Security.PriceStep` 转换为真实价格单位；若品种没有提供最小跳动，则使用 1 作为后备。

## 使用提示

- 策略完全基于挂单，可在没有蜡烛历史的回测环境中运行，只要能够获得 Level 1 行情即可。
- 如果券商要求非零的 `StopsLevel`，应适当增大 `IndentationPoints`，保证最终距离满足交易所规则，三倍点差机制
  可作为附加保护。
- 权益风控不会取消挂单，以便在平仓后立即继续等待机会，这一行为符合原始 Ambush 顾问。
- 滑点和撮合由实际券商或仿真撮合器决定，请结合目标市场波动性调整参数与下单数量。

本文档刻意提供尽可能详细的信息，帮助交易员全面了解转换细节并根据自身交易场景做进一步定制。
