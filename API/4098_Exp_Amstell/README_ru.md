# Стратегия Exp Amstell

## Обзор
**Exp Amstell** — это сеточная торговая система, портированная из исходного советника MetaTrader 4 `exp_Amstell.mq4`. Она непрерывно размещает рыночные заявки на покупку и продажу, как только цена отходит от последней сделки на заданное количество пунктов. Каждая позиция ведётся отдельно: когда рынок проходит дистанцию тейк-профита, стратегия отправляет встречную заявку и фиксирует прибыль именно по этой ступени сетки.

В отличие от трендовых алгоритмов Exp Amstell всегда остаётся активной. Она не ожидает сигналов от индикаторов и вместо этого наращивает позиции в обе стороны при колебаниях рынка. Поэтому ключевую роль играют параметры дистанций и размер каждой заявки.

## Логика торговли
- **Обработка по тикам.** Стратегия подписывается на Level1 и реагирует на каждое изменение лучших цен Bid/Ask — аналогично функции `start()` в MQL.
- **Независимые стеки лонгов и шортов.** Покупка разрешена, если нет открытых длинных сделок или если Ask опустился минимум на расстояние повторного входа относительно последней покупки. Продажи используют зеркальное условие по Bid.
- **Тейк-профит для каждой ступени.** Открытые слои отслеживаются по отдельности. Когда Bid (для лонгов) или Ask (для шортов) проходит заданное число пунктов, закрывается только соответствующий слой, остальные остаются нетронутыми.
- **Эмуляция FIFO.** Исполненные сделки записываются в порядке поступления, что имитирует тикетную систему MetaTrader и гарантирует списание объёма с самых ранних позиций при частичном закрытии.
- **Учёт неттинга.** В StockSharp позиции неттингуются. Если новая покупка перекрывает активный шорт, стратегия сначала уменьшает объём шортового стека и лишь затем добавляет остаток как новый лонг.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `TradeVolume` | `decimal` | `0.1` | Объём каждой рыночной заявки при открытии нового слоя сетки. |
| `TakeProfitPoints` | `int` | `30` | Расстояние в пунктах MetaTrader, которое должна пройти цена для закрытия отдельного слоя. |
| `ReentryDistancePoints` | `int` | `10` | Минимальная дистанция от последней сделки перед добавлением следующей заявки в ту же сторону. |

Стратегия автоматически переводит пункты в реальные шаги цены через `PriceStep`. Для трёх- и пятизнаковых котировок применяется метатрейдеровский множитель, чтобы `1 пункт` соответствовал `0.0001` (или `0.01` для инструментов типа JPY).

## Особенности реализации
- Достаточно данных Level1; свечи не используются. Метод `GetWorkingSecurities()` запрашивает `(Security, DataType.Level1)`.
- В `OnStarted` вызывается `StartProtection()`, чтобы платформа закрыла оставшиеся позиции при аварийной остановке стратегии.
- Все комментарии в исходнике написаны на английском языке согласно правилам репозитория.
- Из-за неттинга StockSharp порт не может одновременно удерживать разнонаправленные позиции. Если сделки противоположных направлений приходят подряд, новая заявка сначала закроет текущую экспозицию, а затем откроет свежий слой.

## Практические рекомендации
1. **Тщательно подбирайте дистанции.** Малые значения делают сетку плотнее и повышают нагрузку в волатильных режимах. Большие значения снижают частоту сделок, но увеличивают просадку на слой.
2. **Осторожно выбирайте объём.** Сеточные системы быстро наращивают позицию. Начинайте с консервативных величин и тестируйте стратегию в Designer или Backtester.
3. **Добавьте внешние ограничения риска.** В оригинальном советнике нет глобального стоп-лосса. Используйте портфельные защиты, чтобы ограничить хвостовые риски.
4. **Следите за качеством исполнения.** Алгоритм предполагает исполнение по лучшим ценам Bid/Ask. Проскальзывание напрямую влияет на достижение тейк-профита.

## Источник
Преобразовано из `MQL/9027/exp_Amstell.mq4`.
