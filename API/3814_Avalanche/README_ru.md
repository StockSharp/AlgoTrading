# Стратегия Avalanche

## Описание

Avalanche — это сеточная стратегия возврата к среднему, основанная на оригинальном советнике Avalanche v1.2 для MetaTrader. В основе лежит анализ расположения цены относительно опорной средней (ERP), рассчитываемой как простая скользящая на более высоком таймфрейме. Если цена находится ниже ERP, стратегия ожидает возврат вверх и наращивает длинные позиции. Когда цена поднимается выше ERP, система набирает короткие позиции. Каждое добавление позиции происходит через заданный шаг и сопровождается индивидуальными уровнями стоп-лосса и тейк-профита.

В данной реализации StockSharp воспроизводится «toward»-ветка оригинального алгоритма. «Away»-ордера, направленные против ERP, не реализованы, так как стратегии в StockSharp оперируют одной чистой позицией. Тем не менее логика сеточного накопления, буферов и раздельного сопровождения сделок полностью сохранена.

## Алгоритм работы

1. Подписка на два потока свечей: рабочий таймфрейм для торговли и отдельный таймфрейм для вычисления ERP.
2. Расчёт ERP с помощью индикатора SMA и определение, находится ли цена выше или ниже средней. Параметр `ErpChangeBuffer` предотвращает ложные переключения направления.
3. При смене положения относительно ERP существующая сетка закрывается и ожидание начинается заново.
4. Если разрешён параметр `OpenStartingOrders`, первая позиция открывается сразу после появления сигнала (покупка при цене ниже ERP, продажа — при цене выше).
5. При движении цены в прибыльную сторону ещё на `IntervalToward` пунктов выполняется дополнительная покупка/продажа.
6. При неблагоприятном движении на `IntervalToward + StackBufferToward` пунктов добавляется усредняющая сделка.
7. Каждая позиция сопровождается собственными уровнями `TakeProfitToward` и `StopLossToward`, что позволяет закрывать прибыльные части сетки независимо от остальных.

## Настройки

| Параметр | Назначение |
| --- | --- |
| `BaseVolume` | Базовый объём заявки до применения множителей. |
| `TowardMultiplier` | Множитель объёма для стандартных сделок по направлению к ERP. |
| `TowardInterestMultiplier` | Множитель объёма при положительном свопе в торговом направлении. |
| `IntervalToward` | Шаг (в пунктах) между последовательными сделками при движении в прибыльную сторону. |
| `StackBufferToward` | Дополнительный буфер (в пунктах) при усреднении против движения. |
| `TakeProfitToward` | Дистанция тейк-профита для каждой сделки; `0` отключает цель. |
| `StopLossToward` | Дистанция стоп-лосса для каждой сделки; `0` отключает защиту. |
| `ErpPeriod` | Период SMA, используемой как ERP. |
| `ErpChangeBuffer` | Буфер вокруг ERP перед сменой направления. |
| `CandleType` | Таймфрейм, по которому принимаются торговые решения. |
| `ErpCandleType` | Таймфрейм для расчёта ERP. |
| `OpenStartingOrders` | Автоматически открывать стартовую позицию после появления сигнала. |

## Отличия от оригинального эксперта

- Не используются встречные «away»-ордера — стратегия работает только в сторону предполагаемого возврата к ERP.
- Сделки выполняются рыночными заявками, а не отложенными стоп-ордерами.
- Сохраняется логика определения направления положительного свопа для выбора множителя объёма.

## Рекомендации по применению

- Подбирайте значения `IntervalToward` и `StackBufferToward` в зависимости от волатильности инструмента, чтобы контролировать скорость набора сетки.
- Следите за величиной совокупной позиции: сеточные стратегии способны быстро накапливать риск.
- Используйте дополнительные фильтры — ограничения по времени торгов, лимиты по просадке, внешние стопы по капиталу.
