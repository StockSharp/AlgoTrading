# Semilong WWW Forex Instruments Info 策略

## 概述
该策略复刻了 MetaTrader 专家顾问 “Semilong” 的交易逻辑。它同时观测当前买价与两个历史收盘价之间的距离，这两个收盘价之间相隔可配置的 K 线数量。当当前价格足够大幅度地低于（或高于）较新的参考收盘价，并且该收盘价又明显脱离更久远的收盘价时，策略会开仓做多或做空。头寸管理完全参照原始脚本，支持自定义止盈、止损、可选的移动止损，以及在连续亏损后自动降低仓位的自动手数模块。

## 信号生成
- **历史偏移**：`ShiftOne` 决定第一个比较收盘价向前追溯多少根已完成的 K 线，`ShiftTwo` 在此基础上再增加额外的偏移量以获得第二个收盘价。
- **偏离阈值**：`MoveOnePoints` 规定当前买价需要相对第一个收盘价偏离多少点，`MoveTwoPoints` 衡量两个历史收盘价之间的距离。
- **多头条件**：当当前买价至少比第一个收盘价低 `MoveOnePoints` 点，且第一个收盘价又至少比第二个收盘价高 `MoveTwoPoints` 点时触发。
- **空头条件**：当当前买价至少比第一个收盘价高 `MoveOnePoints` 点，且第一个收盘价至少比第二个收盘价低 `MoveTwoPoints` 点时触发。
- 策略仅在 K 线收盘后评估信号；如果存在未完成的订单或可用保证金不足，则忽略信号。

## 头寸管理
- **初始保护**：策略不直接挂出止盈止损单，而是追踪入场价格，当价格朝有利方向运行 `ProfitPoints`（额外加上实时点差）或不利方向运行 `LossPoints` 时立即平仓。
- **移动止损**：`TrailingPoints` 大于零时，策略会记录入场后的最佳价位，一旦价格回撤超过该距离便退出头寸。
- **单一持仓**：任意时刻只允许持有一个方向的头寸；在平仓订单成交前不会响应新的开仓信号。

## 仓位管理
- **固定手数**：当 `UseAutoLot` 关闭时，每笔交易使用 `FixedVolume` 手，并根据交易品种的最小/步长/最大手数自动调整。
- **自动手数**：开启自动手数后，会将自由保证金除以 `AutoMarginDivider * 1000` 并四舍五入到最近的整数手。如果出现至少两次连续亏损，则按照 `lossStreak / DecreaseFactor` 的比例减少下单手数，从而模拟原始 EA 的递减逻辑。
- 计算出的手数会被限制在 `FixedVolume` 与 99 手之间，并对齐到品种支持的手数步长范围。

## 其他说明
- 策略实时读取最佳买卖价计算点差，并在多空止盈目标中加上该点差，保持与原脚本一致的收益判定。
- 自由保证金依据账户的 `CurrentValue - BlockedValue` 估算，当缺少保证金信息时退回到当前权益。
- 未额外添加日志或图表，策略可直接在 StockSharp 设计器中优化或在 API 项目里运行。
