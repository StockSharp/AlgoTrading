# Стратегия Alliheik Trader
[English](README.md) | [中文](README_cn.md)

Конвертация советника MetaTrader 4 **alliheik.mq4**. Стратегия сочетает двойное сглаживание свечей Heiken Ashi с линией челюсти аллигатора, смещённой вперёд. Входы формируются на пересечении сглаженных буферов Heiken Ashi, а выходы зависят от пересечения цены с челюстью, фиксированных целей и трейлинг-стопа.

## Логика торговли

- **Построение Heiken Ashi**
  - Сглаживаем исходные значения Open/High/Low/Close с помощью параметров `PreSmoothMethod` / `PreSmoothPeriod`.
  - Формируем классические свечи Heiken Ashi по сглаженным данным.
  - В зависимости от цвета свечи меняем местами буферы High/Low (бычьи свечи сохраняют Low/High, медвежьи — High/Low).
  - Применяем второе сглаживание (`PostSmoothMethod` / `PostSmoothPeriod`) к условным буферам. Именно эти значения сравниваются в правилах сигналов.
- **Определение сигналов**
  - **Покупка**: текущий нижний буфер находится ниже верхнего, а на предыдущем баре соотношение было противоположным или равным.
  - **Продажа**: текущий нижний буфер находится выше верхнего, а на предыдущем баре соотношение было противоположным или равным.
- **Фильтр челюсти и трейлинг**
  - Челюсть аллигатора — скользящая средняя длиной `JawsPeriod`, смещённая вперёд на `JawsShift` баров и построенная по цене `JawsPrice`.
  - Значение `Close[6]` (шесть баров назад) должно пересечь челюсть, прежде чем позицию можно автоматически закрыть.
  - Когда расстояние между `Close[6]` и челюстью достигает восьми пунктов и цена возвращается через челюсть, позиция закрывается.
  - При `TrailingStopPoints > 0` стоп подтягивается за `Close[6]`, если соответствующая свеча находится по прибыльную сторону от челюсти.
- **Стопы и цели**
  - `StopLossPoints` и `TakeProfitPoints` — необязательные фиксированные расстояния в пунктах, задаваемые при входе.
  - Трейлинг-стоп при необходимости заменяет исходный стоп-лосс, как только цена продвинулась в прибыль.

## Параметры по умолчанию

| Параметр | Значение | Описание |
|----------|----------|----------|
| `CandleType` | `TimeSpan.FromHours(1).TimeFrame()` | Таймфрейм для расчётов. |
| `JawsPeriod` | 144 | Длина скользящей средней челюсти. |
| `JawsShift` | 8 | Смещение челюсти вперёд (в барах). |
| `JawsMethod` | Simple | Тип скользящей средней для челюсти (Simple, Exponential, Smoothed, Weighted). |
| `JawsPrice` | Close | Цена, подаваемая в расчёт челюсти (Close/Open/High/Low/Median/Typical/Weighted). |
| `PreSmoothMethod` | Exponential | Тип сглаживания исходных цен OHLC перед построением Heiken Ashi. |
| `PreSmoothPeriod` | 21 | Период сглаживающих средних. |
| `PostSmoothMethod` | Weighted | Тип сглаживания условных буферов Heiken Ashi. |
| `PostSmoothPeriod` | 1 | Период второго сглаживания (1 оставляет значения без изменений). |
| `StopLossPoints` | 0 | Фиксированный стоп-лосс в пунктах (0 — без стопа). |
| `TrailingStopPoints` | 0 | Дистанция трейлинг-стопа на основе `Close[6]` (0 — отключено). |
| `TakeProfitPoints` | 225 | Фиксированная цель в пунктах (0 — без цели). |
| `OrderVolume` | 0.1 | Лотность при входах. |

## Используемые индикаторы

- Сглаженные MA для каждой из серий Open/High/Low/Close.
- Конструкция Heiken Ashi на основе сглаженных цен.
- Дополнительное сглаживание условных буферов, формирующих сигналы.
- Скользящая средняя челюсти аллигатора с настраиваемым типом, смещением и ценой.

## Правила входа и выхода

- **Вход в лонг** — нижний буфер пересекает верхний снизу вверх, а на предыдущем баре пересечения не было в пользу быков.
- **Выход из лонга** при выполнении одного из условий:
  - `Close[6]` возвращается ниже челюсти после нахождения выше неё, а расстояние достигло ≥ 8 пунктов;
  - срабатывает `TakeProfitPoints`;
  - цена достигает `StopLossPoints` или трейлинг-стопа.
- **Вход в шорт** — нижний буфер пересекает верхний сверху вниз, а на предыдущем баре условия для медведей не выполнялись.
- **Выход из шорта** при выполнении одного из условий:
  - `Close[6]` возвращается выше челюсти после нахождения ниже неё, а расстояние достигло ≥ 8 пунктов;
  - срабатывает `TakeProfitPoints`;
  - цена достигает `StopLossPoints` или трейлинг-стопа.

## Особенности конвертации

- За счёт хранения времени последней сделки стратегия разрешает только один вход на бар, повторяя поведение `isOrderAllowed()` из оригинала.
- Стопы и тейки моделируются внутри стратегии, поскольку в StockSharp нельзя полагаться на серверные заявки MT4.
- История значений челюсти хранится с учётом смещения, чтобы воспроизвести работу `iMA` с параметром `ma_shift = JawsShift`.
- Используются типовые индикаторы StockSharp и работа через high-level API в соответствии с требованиями проекта.

## Рекомендации по применению

- Стратегия работает в обе стороны (лонг/шорт) по одному инструменту.
- Наиболее эффективно на трендовых участках, где сглаженные свечи и смещённая челюсть помогают фильтровать шум.
- Подбирайте `TrailingStopPoints` и `TakeProfitPoints` в соответствии с волатильностью инструмента.
- Перед использованием на реальном счёте выполните полноценное тестирование и прогон на демо.
