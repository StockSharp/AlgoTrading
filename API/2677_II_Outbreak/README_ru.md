# Стратегия II Outbreak

## Обзор
II Outbreak — высокочастотная пробойная стратегия, изначально написанная для MetaTrader 4. Она объединяет фирменный осциллятор тайминга с индикатором волатильности для поиска импульсных движений и сопровождает позиции с помощью адаптивного трейлинг-стопа и пирамидинга. Эта конвертация переносит исходную логику на высокоуровневый API StockSharp, сохраняя фильтры по спреду, волатильности и календарю.

## Логика, перенесённая в StockSharp
### Осциллятор тайминга
* Каждая новая свеча M1 добавляет «типичную цену» (среднее High/Low/Close × 100) в каскад сглаживаний исходного робота.
* Каскад восстанавливает цепочку экспоненциальных сглаживаний (буферы dtemp/atemp), формируя тайминговое значение в диапазоне от 0 до 100.
* Сигнал на покупку: значение переходит вверх через предыдущий уровень (buffer[0] > buffer[1] и buffer[1] ≤ buffer[2]).
* Сигнал на продажу: значение переходит вниз (buffer[0] < buffer[1] и buffer[1] ≥ buffer[2]).

### Фильтр волатильности
* Стандартное отклонение с периодом 10 по ценам закрытия должно оставаться ниже `StdDevLimit`. Превышение порога запрещает новые входы и при включённом `WarningAlerts` выводит предупреждение в журнал.
* Дополнительно рассчитывается исходный показатель давления волатильности: совокупность перекрытия двух минутных свечей и средней «плотности тиков» (объём / время). Значение должно превысить `VolatilityThreshold`.

### Правила входа
* Стратегия работает с одной связкой инструмент/таймфрейм, задаваемой параметром `CandleType` (по умолчанию 1-минутные свечи).
* При отсутствии позиции и разрешении календарного фильтра пересчитывается рабочий объём через `CalculateOrderVolume()` и проверяется текущий спред относительно `SpreadThreshold` (используются заявки лучшего Bid/Ask).
* Длинная позиция открывается при одновременном появлении сигнала осциллятора и подтверждённой волатильности. Короткая позиция — зеркально. При входе ставится статический стоп на расстоянии, равном удвоенному `TrailStopPoints`.

### Пирамидинг и трейлинг
* Трейлинг активируется, когда суммарная позиция достигает прибыли не менее `TrailStopPoints + int(Commission) + SpreadThreshold` пунктов.
* Стоп подтягивается на `TrailStopPoints` позади последней цены закрытия (отдельно для лонга и шорта). Любое улучшение больше одного пункта обновляет уровень стопа.
* Пока соблюдаются условия по волатильности, таймингу и спреду, стратегия добавляет ордера через каждые `max(10, SpreadThreshold + 1)` пунктов дополнительной прибыли. После первой доливки статический стоп отключается и остаётся только трейлинг.

### Управление рисками и капиталом
* Размер позиции пересчитывается перед каждой заявкой: `баланс × MaximumRisk ÷ (500000 / AccountLeverage)` с округлением к шагу объёма. При отсутствии данных по балансу используется значение `Volume` или минимальный лот инструмента.
* Проверка маржи приближённо повторяет логику MetaTrader: `volume × price / leverage × (1 + MaximumRisk × 190)`. Если портфель не покрывает требуемую сумму, заявка игнорируется.
* После активации пирамидинга контролируется плавающий убыток. Если просадка превышает `TotalEquityRisk` процентов от стоимости счёта, все позиции закрываются.

### Календарь и контроль спреда
* Торговля останавливается по пятницам после 23:00 серверного времени и в последние торговые дни года (дни 358, 359, 365 или 366) после 16:00.
* Каждый вход и доливка проверяют текущий спред и пропускают сделку при превышении допустимого порога.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `Commission` | 4 | Комиссия за круговой лот в пунктах; участвует в расчёте активации трейлинга. |
| `SpreadThreshold` | 6 | Максимальный допустимый спред в пунктах для входа и пирамидинга. |
| `TrailStopPoints` | 20 | Дистанция трейлинг-стопа в пунктах; стартовый стоп ставится вдвое дальше. |
| `TotalEquityRisk` | 0.5 | Допустимая просадка счёта (в процентах), после которой все позиции принудительно закрываются. |
| `MaximumRisk` | 0.1 | Доля капитала, выделяемая под одну заявку при расчёте объёма. |
| `StdDevLimit` | 0.002 | Максимальное значение стандартного отклонения (10 периодов), допускающее новые входы. |
| `VolatilityThreshold` | 800 | Минимальный показатель волатильности (амплитуда × плотность тиков) для торговли. |
| `AccountLeverage` | 100 | Плечо счёта, используемое при оценке маржи и объёма. |
| `WarningAlerts` | true | Включает вывод предупреждений при блокировке сделок фильтром StdDev. |
| `CandleType` | 1 минута | Тип свечей, используемый во всех расчётах. |

## Индикаторы
* `StandardDeviation(Length = 10)` по ценам закрытия для фильтра волатильности.
* Встроенный осциллятор тайминга, воссозданный по формулам исходного эксперта.

## Особенности реализации
* Для фильтрации по спреду необходим поток котировок уровня 1 (`Security.BestBid` / `BestAsk`). При отсутствии данных предполагается нулевой спред.
* Проверки маржи и капитала являются приближенными: в MetaTrader использовались специфические параметры счёта и размеры контрактов. При необходимости корректируйте `AccountLeverage`, `MaximumRisk` или `Volume` под условия брокера.
* Конвертация выполнена с использованием высокоуровневого API StockSharp (`SubscribeCandles` + `Bind`). Все комментарии в коде оставлены на английском языке. Python-версия стратегии не создавалась.
