# Стратегия Volatility HFT EA
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник **Volatility HFT EA** из MetaTrader 5 на высокоуровневый API StockSharp. Повторяется исходная логика: покупка выполняется, когда цена закрытия значительно превышает быстрое скользящее среднее, после чего позиция удерживается до отката обратно к этому среднему. Генерация заявок, работа с индикатором и защитные выходы реализованы в соответствии с требованиями `AGENTS.md` и максимально приближены к поведению MQL-версии.

## Как работает стратегия

1. **Индикатор** – рассчитывается одно простое скользящее среднее (по умолчанию период 5) на таймфрейме, заданном параметром `CandleType`.
2. **Определение нового бара** – обработка выполняется только после завершения свечи (`CandleStates.Finished`), что повторяет проверки `IsNewBar` в советнике.
3. **Прогрев** – перед оценкой сигналов стратегия ждёт 60 завершённых свечей, как и исходная проверка `Bars < 60` в MQL.
4. **Фильтр входа** – длинный сигнал появляется, когда последнее закрытие минимум на `MaDifferencePips` пунктов выше SMA (разница переводится в цену через размер пункта инструмента), а текущее значение SMA превышает значение двух баров назад. В оригинале применялись условия `val[0] < -0.0015` и `MA_Val1[0] > MA_Val1[2]`; в портированной версии используются те же сравнения без ручного хранения массивов.
5. **Одна позиция за раз** – реализованы только покупки, потому что блок продаж в файле был закомментирован. При открытой позиции новые сигналы игнорируются.

## Управление рисками

- **Стоп-лосс** – опциональный защитный стоп в пунктах. Размер пункта определяется по `Security.PriceStep`; если у инструмента 3 или 5 знаков после запятой, шаг умножается на 10, что повторяет масштабирование `_Digits` в MetaTrader.
- **Тейк-профит** – цель фиксируется на значении SMA в момент входа (`mrequest.tp = MA_Val1[0];`). Закрытие позиции происходит, когда минимум свечи касается сохранённого уровня SMA, что имитирует лимитную заявку на скользящем среднем.

## Параметры

| Параметр | Описание |
| --- | --- |
| `OrderVolume` | Объём для каждой рыночной заявки. |
| `FastMaLength` | Период быстрого простого скользящего среднего (по умолчанию 5). |
| `StopLossPips` | Дистанция стоп-лосса в пунктах; значение `0` отключает уровень. |
| `MaDifferencePips` | Минимальное расстояние (в пунктах) между ценой закрытия и SMA для открытия длинной позиции. |
| `CandleType` | Таймфрейм, на котором запрашиваются свечи и считается индикатор. |

`MinimumBars` – внутренний константный параметр, равный `60`, полностью повторяющий требование советника к глубине истории.

## Как использовать

1. Подключите стратегию к нужному инструменту и задайте подходящий `CandleType` (например, минутные свечи для высокочастотной торговли).
2. Настройте `FastMaLength`, `MaDifferencePips` и `StopLossPips` под волатильность инструмента. Параметры в пунктах автоматически пересчитываются через определённый размер пункта, поэтому стандартные значения подходят как для четырёх-, так и для пятизнаковых валютных пар.
3. Укажите `OrderVolume` в соответствии с правилами управления капиталом. Стратегия отправляет только рыночные заявки и не наращивает позицию сериями входов.
4. Запустите стратегию. Она подпишется на выбранные свечи, сформирует SMA, дождётся 60 баров прогрева и начнёт анализировать сигналы после закрытия каждой свечи.
5. Следите за сопровождением сделок: выход выполняется либо при касании SMA, либо при достижении стоп-уровня, рассчитанного при входе.

## Примечания и отличия от исходного советника

- В MQL-версии объём брался как минимальный лот через `SymbolInfoDouble(Symbol(), SYMBOL_VOLUME_MIN)`. Здесь параметр `OrderVolume` сделан настраиваемым, чтобы стратегию можно было использовать с разными брокерами и классами активов.
- Условия для продаж не перенесены, потому что в файле `Volatility_HFT_EA.mq5` они закомментированы. Таким образом, поведение полностью соответствует опубликованной версии советника.
- Закрытие по тейк-профиту реализовано через проверку минимума свечи относительно уровня SMA вместо регистрации лимитной заявки, что надёжно работает в инфраструктуре StockSharp и сохраняет исходный замысел.
- Ручная работа с массивами (`CopyRates`, `CopyBuffer`, `ArraySetAsSeries`) заменена на привязку индикаторов StockSharp. Это уменьшает объём кода и при этом оставляет все исходные пороговые значения и проверки наклона.
- Расчёты выполняются только по завершённым свечам; обращений к буферам индикаторов через `GetValue` нет, что соответствует правилам репозитория.
