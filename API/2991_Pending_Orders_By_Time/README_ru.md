# Стратегия Pending Orders By Time 2

## Обзор
Стратегия воспроизводит логику советника MetaTrader «Pending orders by time 2», размещая отложенные ордера на пробой в фиксированное время. В начале торговой сессии выставляются одновременно Buy Stop выше текущей цены спроса и Sell Stop ниже текущей цены предложения. Для каждого ордера заранее рассчитываются стоп-лосс и тейк-профит в шагах цены инструмента, а после активации позиция сопровождается трейлинг-стопом и взаимно исключающими защитными ордерами. Реализация использует высокоуровневый API StockSharp и соответствует внутренним требованиям по стилю (отступы табами, параметры через `Param()` и т. д.).

## Последовательность работы в течение дня
1. **Сброс состояния** – При появлении первой завершённой свечи нового торгового дня стратегия очищает флаги, чтобы позднее можно было выставить свежую пару отложенных ордеров.
2. **Выставление в час открытия** – Когда час свечи совпадает с параметром `OpeningHour` и ордера ещё не выставлялись сегодня, вычисляются цены пробоя относительно последних лучших bid/ask (при отсутствии котировок используется цена закрытия свечи). Затем отправляются два ордера: Buy Stop и Sell Stop.
3. **Сопровождение в течение дня** – Пока сессия активна, стратегия подтягивает защитный стоп для открытой позиции, не отменяет противоположный отложенный ордер (что позволяет развернуться при пробое в другую сторону) и ждёт срабатывания трейлинг-стопа, фиксированного тейк-профита либо противоположного ордера.
4. **Завершение в час закрытия** – Как только час свечи совпадает с `ClosingHour`, все невыполненные отложенные ордера снимаются, позиция закрывается рыночным ордером, и таким образом исключается перенос позиций через ночь.

## Расчёт цен для ордеров
- **Параметры расстояний** – Значения `DistanceTicks`, `StopLossTicks` и `TakeProfitTicks` трактуются как количество шагов цены (`Security.PriceStep`). Цена Buy Stop равна `bestAsk + DistanceTicks * step`, стоп-лосс ставится на `StopLossTicks` шагов ниже цены входа, тейк-профит — на такое же расстояние выше. Для Sell Stop логика симметрична.
- **Работа с котировками** – Стратегия подписывается на стакан заявок и запоминает последние лучшие bid/ask. Если котировок ещё нет, используется цена закрытия текущей завершённой свечи, чтобы избежать вычислений с нулевыми значениями.
- **Хранение ссылок** – Ссылки на отправленные отложенные ордера сохраняются, что позволяет корректно отменять их при смене сессии или наступлении часа закрытия.

## Управление позицией и риском
- **Защитные ордера** – При исполнении одного из отложенных ордеров (обнаруживается в `OnOwnTradeReceived`) стратегия немедленно выставляет пару защитных ордеров на тот же объём: для длинной позиции это `SellStop` + `SellLimit`, для короткой — `BuyStop` + `BuyLimit`. При появлении новых защитных заявок предыдущая пара отменяется автоматически.
- **Трейлинг-стоп** – Параметры `TrailingStopTicks` и `TrailingStepTicks` определяют расстояние до стопа и минимальный шаг его подтягивания. Как только плавающая прибыль превышает сумму `TrailingStop + TrailingStep`, рассчитывается более выгодный уровень стопа, старый ордер отменяется и выставляется новый, причём уровень никогда не отдаляется от текущей цены.
- **Выход в час закрытия** – В момент `ClosingHour` стратегия снимает оба защитных ордера и отправляет рыночную заявку на величину абсолютной позиции, полностью фиксируя результат.

## Настраиваемые параметры
- `OpeningHour` – Час (0–23), в который выставляются отложенные ордера.
- `ClosingHour` – Час (0–23), в который отложенные ордера снимаются и позиция закрывается.
- `DistanceTicks` – Отступ от текущих bid/ask для уровня пробоя в шагах цены.
- `StopLossTicks` – Исходное расстояние до стоп-лосса в шагах цены.
- `TakeProfitTicks` – Расстояние до тейк-профита в шагах цены.
- `TrailingStopTicks` – Постоянное расстояние, на которое удерживается трейлинг-стоп после активации.
- `TrailingStepTicks` – Минимальное дополнительное движение цены, после которого стоп подтягивается вновь.
- `Volume` – Объём ордеров на вход.
- `CandleType` – Тип и таймфрейм свечей, по которым контролируется расписание (по умолчанию 15 минут).

## Особенности реализации
- Используется только высокоуровневый API (`SubscribeCandles`, `SubscribeOrderBook`, рыночные методы `BuyStop`, `SellStop` и т. д.), что упрощает поддержку и соответствует требованиям по конвертации.
- Метод `OnOwnTradeReceived` синхронизирует защитные ордера с фактическим исполнением и очищает ссылки при закрытии позиции по стопу или тейку.
- Трейлинг реализован без обращения к `GetValue` индикаторов, оперирует только данными свечи и внутренним состоянием.
- Все расстояния рассчитываются через шаг цены, что повторяет исходную работу с «пунктами» в MQL и делает стратегию независимой от точности котировок.
- В соответствии с заданием Python-версия не создавалась; в каталоге присутствует только реализация на C#.
