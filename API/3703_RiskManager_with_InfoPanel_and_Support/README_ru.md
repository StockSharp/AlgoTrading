# Risk Manager with Info Panel and Support

## Обзор

`RiskManagerWithInfoPanelAndSupportStrategy` — вспомогательная стратегия, портированная с MQL5‑скрипта **RiskManager_with_InfoPanel_and_Support_noDLL**. Она не совершает сделок автоматически. Вместо этого стратегия через равные промежутки времени формирует подробный отчёт в журнале Designer, повторяя содержимое оригинальной панели на графике и сохраняя сообщение кнопки поддержки.

Инструмент рассчитывает рекомендуемый объём позиции при заданном риске, оценивает соотношение риск/прибыль и контролирует дневной результат относительно лимита потерь. При превышении лимита в журнал выводится предупреждение о необходимости остановить торговлю, что соответствует поведению версии для MetaTrader.

## Как работает стратегия

1. При запуске проверяется наличие подключённого портфеля и создаётся `System.Threading.Timer`. Первый запуск выполняется немедленно, далее обработчик вызывается каждые `UpdateIntervalSeconds` секунд.
2. В момент срабатывания считываются текущие значения портфеля (баланс, эквити, плавающий P/L) и параметры входа: цена, проценты стоп‑лосса и тейк‑профита.
3. С помощью `StringBuilder` конструируется текст панели и записывается в журнал. Параметры расположения, шрифта и цветов также выводятся, чтобы сохранить настройку панели даже без графического интерфейса.
4. Если включена панель поддержки, к отчёту добавляется текст кнопки и ссылка Bybit, имитирующие исходное всплывающее окно.
5. Для оценки дневного результата сохраняется значение PnL в момент первого срабатывания после смены даты. Текущее PnL минус базовое значение образует показатель Daily P/L в отчёте.

Стратегия служит исключительно информационным помощником. Её можно запускать параллельно с ручной торговлей или другими стратегиями StockSharp, отвечающими за выставление заявок.

## Основные вычисления

- **Риск на сделку** = `PortfolioValue * RiskPercent / 100`. В качестве `PortfolioValue` используется `Portfolio.CurrentValue`, а при его отсутствии — `Portfolio.BeginValue`.
- **Цена стоп‑лосса** = `EntryPrice - EntryPrice * (StopLossPercent / 100)`.
- **Цена тейк‑профита** = `EntryPrice + EntryPrice * (TakeProfitPercent / 100)`.
- **Рекомендуемый объём** = `RiskAmount / (StopDistanceInSteps * StepPrice)` с округлением вверх до шага `VolumeStep`, чтобы объём всегда соответствовал требованиям брокера.
- **Соотношение риск/прибыль** рассчитывается через расстояния в шагах цены между входом, стопом и целью.
- **Дневная прибыль** = `PnL - DailyPnLBase`. База обнуляется при смене календарного дня или при любом обновлении PnL.
- **Дневной лимит риска** = `Equity * MaxDailyRiskPercent / 100`. Если дневной результат опускается ниже отрицательного лимита, в отчёт добавляется предупреждение.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `RiskPercent` | 1 | Доля капитала, которой трейдер готов рискнуть в одной сделке. |
| `EntryPrice` | 1.1000 | Расчётная цена входа. |
| `StopLossPercent` | 0.2 | Процентная дистанция до стоп‑лосса. |
| `TakeProfitPercent` | 0.5 | Процентная дистанция до тейк‑профита. |
| `MaxDailyRiskPercent` | 2 | Допустимая дневная просадка в процентах от эквити. |
| `UpdateIntervalSeconds` | 10 | Период обновления отчёта в секундах. |
| `InfoPanelXDistance` | 10 | Виртуальное смещение панели по оси X (фиксируется в журнале). |
| `InfoPanelYDistance` | 10 | Виртуальное смещение панели по оси Y. |
| `InfoPanelWidth` | 350 | Виртуальная ширина панели. |
| `InfoPanelHeight` | 300 | Виртуальная высота панели. |
| `InfoPanelFontSize` | 12 | Размер шрифта панели (информационный параметр). |
| `InfoPanelFontName` | Arial | Шрифт панели. |
| `InfoPanelFontColor` | White | Цвет шрифта панели. |
| `InfoPanelBackColor` | DarkGray | Цвет фона панели. |
| `UseSupportPanel` | true | Выводить ли информацию о панели поддержки. |
| `SupportPanelText` | Need trading support? Contact us! | Текст панели поддержки. |
| `SupportPanelFontColor` | Red | Цвет шрифта панели поддержки. |
| `SupportPanelFontSize` | 10 | Размер шрифта панели поддержки. |
| `SupportPanelFontName` | Arial | Шрифт панели поддержки. |
| `SupportPanelXDistance` | 10 | Виртуальное смещение кнопки поддержки по оси X. |
| `SupportPanelYDistance` | 320 | Виртуальное смещение кнопки поддержки по оси Y. |
| `SupportPanelXSize` | 250 | Виртуальная ширина кнопки поддержки. |
| `SupportPanelYSize` | 30 | Виртуальная высота кнопки поддержки. |

## Рекомендации по использованию

- Подключайте стратегию к портфелю, в котором доступны `CurrentValue` или `BeginValue`, иначе расчёт риска и лота будет равен нулю.
- Перед каждой сделкой обновляйте `EntryPrice`, `StopLossPercent` и `TakeProfitPercent`, чтобы получить актуальную рекомендацию по объёму.
- Значение `UpdateIntervalSeconds` должно быть положительным. Слишком маленький интервал приведёт к чрезмерному количеству записей в журнале; значение 10 секунд повторяет оригинал.
- Инструмент не открывает позиции — он предназначен для мониторинга. Торговые действия следует выполнять вручную или через отдельные стратегии.
- Ссылка поддержки Bybit выводится как текст в журнале, интерактивной кнопки в Designer нет.

## Отличия от версии MQL5

- В StockSharp информация выводится только в журнал, без создания графических объектов на чарте.
- Таймер реализован через `System.Threading.Timer`, используется защита от параллельных запусков обработчика.
- Обновление дневной базы PnL происходит автоматически при смене даты или при поступлении новых значений, чтобы отчёт соответствовал фактическому состоянию счёта.
- Расчёт объёма учитывает `VolumeStep`, поэтому рекомендация всегда совместима с брокерскими ограничениями.
