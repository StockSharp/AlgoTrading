# 1H Bollinger Bands 策略

## 概述
**1H Bollinger Bands Strategy** 将 MetaTrader 指标“1H Bolinger Bands”迁移到 StockSharp 高级 API。核心思想是在小时级别顺势交易，利用日线 Bollinger Bands 的回归信号，并通过月线 MACD 进行宏观方向过滤。默认基础周期为 H1，策略还会订阅更高周期的数据以完成确认。

## 交易逻辑
- **趋势过滤：** 在基础周期上计算 250 和 500 周期的线性加权均线（LWMA），只有当快速 LWMA 位于慢速之上（做多）或之下（做空）时才允许进场。
- **回归形态：** 在高一级周期（默认日线）检测：前一根已完成 K 线的最低价跌破下轨且下一根开盘价回到下轨之上（做空信号为高点突破上轨后开盘回到下轨之下）。
- **动量确认：** 在高周期上计算 14 周期动量，并记录最近三次对 100 的绝对偏离值；至少有一次偏离需超过设定阈值（默认 0.3）。
- **MACD 过滤：** 月线 MACD(12/26/9) 需要与方向一致——做多时 MACD 主线高于信号线，做空则相反。
- **入场：** 条件全部满足后以市价下单。如果当前持有反向头寸，将首先平掉原仓并翻转方向。

## 仓位管理
策略内部使用以“点数（pips）”定义的距离，并通过 `Security.PriceStep` 自动换算成价格偏移：
- **止损：** 价格向不利方向运行指定点数时立即离场。
- **止盈：** 价格触及目标点差后锁定利润。
- **跟踪止损（可选）：** 达到跟踪距离后建立一条内部止损线，若价格回撤触及该线则平仓。
- **保本移动（可选）：** 获利达到触发点后，将止损移动到入场价加上（或减去）配置的保本偏移，一旦回落到该价位便退出。

原始 EA 中的资金收益目标、权益止损等功能未迁移，以保持 StockSharp 版本的通用性。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 信号计算所用的基础周期。 | 1 小时蜡烛 |
| `HigherTimeFrame` | 计算 Bollinger 与动量的高周期。 | 1 天蜡烛 |
| `MacdTimeFrame` | MACD 确认使用的周期。 | 30 天蜡烛 |
| `FastMaPeriod` / `SlowMaPeriod` | 基础周期上的快/慢 LWMA 长度。 | 6 / 85 |
| `TrendFastPeriod` / `TrendSlowPeriod` | 长周期趋势过滤。 | 250 / 500 |
| `MomentumPeriod` | 高周期动量的回看长度。 | 14 |
| `MomentumThreshold` | 动量相对 100 的最小偏差。 | 0.3 |
| `BollingerPeriod` / `BollingerWidth` | 日线 Bollinger 参数。 | 20 / 2.0 |
| `TradeVolume` | 单次下单的基础数量。 | 1 |
| `StopLossPips` / `TakeProfitPips` | 止损与止盈点差。 | 20 / 50 |
| `EnableTrailing` / `TrailingStopPips` | 启用跟踪止损及其距离。 | true / 40 |
| `EnableBreakEven` / `BreakEvenTriggerPips` / `BreakEvenOffsetPips` | 启用保本、触发阈值与偏移。 | true / 30 / 30 |

所有参数通过 `StrategyParam<T>` 暴露，可在 Designer/Runner 中进行优化。

## 实现细节
- 同时订阅三个蜡烛流：基础周期、用于 Bollinger/动量的高周期以及用于 MACD 的更高周期。
- 动量指标使用 StockSharp 标准实现，并保留最近三次偏差以复现 MQL 行为。
- 保护性规则依赖 `PriceStep` 将点差转换为价格；如果证券缺少该字段，止损/止盈将不会触发。
- StockSharp 采用净头寸模型，原策略中基于 `Max_Trades` 的加仓逻辑在此版本被简化为单一净仓。
- 省略了原 EA 的邮件、推送通知以及基于账户余额的风控，保持平台无关性。

## 使用方法
1. 将策略绑定到能够提供小时、日线及月线蜡烛的标的（或根据数据可用性调整参数）。
2. 确认标的设置了 `PriceStep`，以便正确换算点差。
3. 在启动前配置交易数量与风险参数。
4. 启动策略，系统会自动订阅数据、在收盘价基础上判定信号，并按设定管理仓位。

## 与 MQL 版本的差异
- 未实现资金目标、权益止损等功能，仅保留价格型风险控制。
- 忽略了邮件、通知等附加服务功能。
- 由于净头寸模型，不再维护多笔独立订单；信号出现时直接调整整体仓位。

这些改动使策略更加符合 StockSharp 的架构，同时保留了原策略的核心交易思路。
