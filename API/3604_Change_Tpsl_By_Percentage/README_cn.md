# Change TPSL By Percentage 策略

## 概述
该策略重现了 MetaTrader 中用于动态调整止盈止损的脚本逻辑。StockSharp 版本不会修改已有委托，而是订阅 Level1 行情，在浮动盈亏达到由账户余额、已用保证金和设定杠杆系数计算出的目标时，立即用市价单平掉当前仓位。

策略本身不会产生新的入场信号，更适合作为已有手动或程序化仓位的保护层。当计算出的阈值被突破时，仓位将被一次性市价平仓。

## 参数
- **Profit Percentage** – 以账户余额百分比表示的目标收益，默认使用当前余额的 40%。
- **Stop-loss Percentage** – 以账户余额百分比表示的最大允许亏损，默认使用当前余额的 90%。
- **Symbol Leverage** – 将百分比目标转换为价格距离的杠杆系数。例如杠杆 1:200 时填写 `0.5`，与原脚本一致。

## 目标价格的计算方法
1. 读取投资组合当前价值以及已被占用的保证金（BlockedValue/Margin）。
2. 计算货币形式的盈利目标与亏损阈值：`balance × percentage ÷ 100`。
3. 将上述金额除以已用保证金，得到达到目标所需的价格变动倍数。
4. 乘以杠杆系数并转换成具体价格：
   - 多单止盈价 = `开仓价 × (1 + leverage × profitMultiplier ÷ 100)`
   - 多单止损价 = `开仓价 × (1 − leverage × stopMultiplier ÷ 100)`
   - 空单止盈价 = `开仓价 × (1 − leverage × profitMultiplier ÷ 100)`
   - 空单止损价 = `开仓价 × (1 + leverage × stopMultiplier ÷ 100)`
5. 每当 Level1 行情更新时重新计算这些阈值，使策略能够跟随余额或保证金的变化。

## 执行流程
1. 订阅 Level1 数据以获得最新的买一/卖一价格。
2. 等待策略进入在线状态，并确认存在持仓及有效的余额、保证金信息。
3. 对多头仓位监控买一价，对空头仓位监控卖一价。
4. 当价格触及计算出的止盈或止损水平时，发送市价单平掉全部仓位。
5. 仓位被关闭后，策略会停止计算，直到出现新的仓位。

## 使用说明
- 仅在单一标的上运行该策略；原始脚本也仅支持单品种管理。
- 如果连接端无法提供保证金数据，则逻辑会保持空闲状态，这与 MetaTrader 在 `AccountMargin()` 返回 0 时的表现一致。
- 计算得到的止损价格若小于 0 会被截断为 0，以避免提交无效价格。
- 平仓使用市价单，剧烈波动时可能出现滑点。
- 策略仅负责风控管理，需要配合其他交易系统产生入场信号。
