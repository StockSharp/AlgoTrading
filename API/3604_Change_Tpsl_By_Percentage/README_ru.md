# Стратегия Change TPSL By Percentage

## Общее описание
Стратегия повторяет логику утилиты MetaTrader, которая постоянно пересчитывает уровни тейк-профита и стоп-лосса для всех открытых позиций по одному инструменту. Вместо модификации заявок в стакане версия для StockSharp отслеживает поток котировок Level1 и закрывает позиции рыночными заявками, как только плавающая прибыль или убыток достигают уровней, рассчитанных по балансу счёта, использованной марже и заданному коэффициенту кредитного плеча.

Стратегия не открывает сделки самостоятельно. Её задача — быть защитной надстройкой над существующими ручными или алгоритмическими позициями. При превышении расчётных порогов вся позиция ликвидируется одной рыночной заявкой.

## Параметры
- **Profit Percentage** — процент от баланса счёта для расчёта цели по прибыли. По умолчанию 40% текущего баланса.
- **Stop-loss Percentage** — процент от баланса счёта, определяющий максимально допустимый убыток. По умолчанию 90% текущего баланса.
- **Symbol Leverage** — коэффициент плеча, переводящий целевые проценты в смещение цены. Для плеча 1:200 укажите `0.5`, как в оригинальном скрипте.

## Как вычисляются уровни
1. Берётся текущая стоимость портфеля и заблокированная маржа по открытому инструменту.
2. Рассчитываются денежные цели по прибыли и убытку: `balance × percentage ÷ 100`.
3. Денежные цели делятся на использованную маржу, формируя множители требуемого ценового движения.
4. Множители умножаются на коэффициент плеча и преобразуются в ценовые уровни:
   - Тейк-профит для лонга = `цена входа × (1 + leverage × profitMultiplier ÷ 100)`
   - Стоп-лосс для лонга = `цена входа × (1 − leverage × stopMultiplier ÷ 100)`
   - Тейк-профит для шорта = `цена входа × (1 − leverage × profitMultiplier ÷ 100)`
   - Стоп-лосс для шорта = `цена входа × (1 + leverage × stopMultiplier ÷ 100)`
5. При каждом новом обновлении Level1 уровни пересчитываются, чтобы изменения баланса или маржи моментально учитывались.

## Последовательность работы
1. Подписаться на поток Level1 и получать лучшие цены bid/ask.
2. Ждать, пока стратегия не перейдёт в состояние online и не появится открытая позиция вместе с данными по балансу и марже.
3. Для лонга контролировать цену bid, для шорта — цену ask.
4. При пересечении расчётного тейк-профита или стоп-лосса отправить рыночную заявку на полное закрытие позиции.
5. После закрытия позиция не пересчитывается до появления следующей открытой позиции.

## Важные замечания
- Стратегию следует использовать на одном инструменте — оригинальный код тоже не поддерживал мультисимвольную работу.
- Если брокер не предоставляет информацию о марже, логика будет бездействовать, аналогично тому, как `AccountMargin()` в MetaTrader возвращает ноль.
- Негативные значения стоп-уровней обрезаются до нуля, чтобы не отправлять цены ниже минимально допустимых.
- Закрытие выполняется рыночными заявками, поэтому возможны проскальзывания при высокой волатильности.
- Стратегия дополняет другие системы входа и сама по себе сигналы не генерирует.
