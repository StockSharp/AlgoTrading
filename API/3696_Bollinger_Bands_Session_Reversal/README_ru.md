# Стратегия разворота по полосам Боллинджера

Стратегия является портом эксперт-советника **BollingerBandsEA (ver. 3.0)** с платформы MetaTrader. Она ищет возврат к среднему после экстремальных выходов цены за полосы Боллинджера внутри активной сессии.

## Логика торговли

1. Подписывается на основную внутридневную серию свечей (по умолчанию 15 минут) и на дневные свечи для трендового фильтра.
2. Рассчитывает полосы Боллинджера (период 20, множитель 2.0) на внутридневных данных и простую среднюю с периодом 100 на дневных закрытиях.
3. Отслеживает текущие и предыдущие дневные экстремумы, а также сохраняет значения полос с предыдущей свечи.
4. Открывает сделки только в торговом окне: с момента `SessionStartOffsetMinutes` минут после открытия рынка до `SessionEndOffsetMinutes` минут до закрытия.
5. Прекращает открывать новые позиции, когда суммарный результат за текущий день (включая плавающий PnL) становится положительным.
6. Условия для продажи: предыдущая свеча медвежья, закрылась выше верхней полосы, текущая цена остаётся выше полосы, ширина полос достаточна, цена ниже дневной SMA, и цена обновляет текущий или предыдущий дневной максимум.
7. Условия для покупки: предыдущая свеча бычья, закрылась ниже нижней полосы, текущая цена остаётся ниже полосы, ширина полос достаточна, цена выше дневной SMA, и цена обновляет текущий или предыдущий дневной минимум.
8. Размер позиции может быть фиксированным или рассчитываться по заданному проценту риска с учётом дистанции до стоп-лосса в пунктах.
9. Выход из позиции контролируется стоп-лоссом, тейк-профитом, опциональным закрытием на средней полосе, трейлинг-стопом, переходом в безубыток и принудительным закрытием убыточных позиций по истечении заданного времени.

## Параметры

| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей для основной логики. |
| `BollingerLength` | Период расчёта полос Боллинджера. |
| `BollingerWidth` | Множитель ширины полос. |
| `DailyMaLength` | Период дневной SMA для фильтра тренда. |
| `StopLossPoints` | Дистанция стоп-лосса в пунктах. |
| `UseRiskVolume` | Использовать ли риск-ориентированный размер позиции. |
| `RiskPercent` | Доля капитала, которой рискнет сделка. |
| `FixedVolume` | Фиксированный объём при отключённом риск-менеджменте. |
| `SessionStartOffsetMinutes` | Количество минут после открытия рынка, когда разрешены входы. |
| `SessionEndOffsetMinutes` | Количество минут до закрытия рынка, когда входы запрещены. |
| `CloseOnMiddleBand` | Закрывать позицию при пересечении средней полосы. |
| `EnableTrailing` | Включить трейлинг-стоп. |
| `TrailingFactor` | Требуемое движение (в кратных стопу) для активации трейлинга. |
| `EnableBreakEven` | Переносить ли стоп в безубыток. |
| `BreakEvenFactor` | Необходимый профит (в кратных стопу) для перехода в безубыток. |
| `CloseLosingAfterMinutes` | Время в минутах до принудительного закрытия убыточной позиции. |

## Дополнительно

- Стоп-лосс и тейк-профит моделируются по экстремумам свечей. При необходимости можно добавить регистрацию реальных защитных заявок.
- Расчёт риск-объёма требует корректных `Security.Step` и `Security.StepPrice`. При их отсутствии стратегия использует фиксированный объём.
- Ограничение дневной прибыли основано на PnL стратегии, поэтому важно соответствие валюты портфеля и параметров риска.
