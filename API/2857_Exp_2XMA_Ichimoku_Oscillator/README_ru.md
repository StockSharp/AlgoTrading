# Стратегия Exp 2XMA Ichimoku Oscillator

Стратегия повторяет работу советника MetaTrader «Exp_2XMA_Ichimoku_Oscillator». Она строит две средние линии в стиле Ichimoku, сглаживает их выбранными скользящими средними и анализирует разницу между ними, используя возможности высокоуровневого API StockSharp.

## Основная идея

1. На выбранном таймфрейме вычисляются два «дончиановских» середины:
   - **Быстрая середина** — среднее значения максимума и минимума за `UpPeriod1` и `DownPeriod1` свечей.
   - **Медленная середина** — аналогичное среднее за `UpPeriod2` и `DownPeriod2` свечей.
2. Каждая середина дополнительно сглаживается скользящей средней (`Method1`, `Method2`) с периодами `XLength1` и `XLength2`. Доступны типы: простая, экспоненциальная, сглаженная и линейно-взвешенная.
3. Осциллятор равен разности между двумя сглаженными сериями. Для описания поведения используются цветовые состояния:
   - `PositiveRising` (0) — осциллятор выше нуля и растёт.
   - `PositiveFalling` (1) — выше нуля, но замедляется.
   - `NegativeRising` (3) — ниже нуля, но поднимается к нулю.
   - `NegativeFalling` (4) — ниже нуля и продолжает снижаться.
   - `Neutral` (2) — фаза инициализации без сигнала.
4. Для определения сигналов анализируются цвета свечи с индексом `SignalBar` и предыдущей (`SignalBar + 1`), что полностью совпадает с логикой смещения буферов в версии MQL.

## Правила торговли

- **Открытие лонга** (`EnableBuyOpen = true`): если более старая свеча (`SignalBar + 1`) имела растущий цвет (0 или 3), а последняя завершённая свеча (`SignalBar`) изменила цвет на падающий (1 или 4), стратегия закрывает короткую позицию при разрешённом `EnableSellClose` и открывает/увеличивает длинную позицию объёмом `Volume + |Position|`.
- **Открытие шорта** (`EnableSellOpen = true`): если старшая свеча показывала падение (1 или 4), а свежая свеча сменила цвет на рост (0 или 3), то при активном `EnableBuyClose` закрывается лонг и открывается/увеличивается короткая позиция тем же объёмом.
- Все сделки выполняются рыночными ордерами на закрытии сигнальной свечи. Дополнительных стоп-лоссов и тейк-профитов нет — выходы основаны только на смене цвета.
- В методе `OnStarted` вызывается `StartProtection()`, что активирует стандартную защиту позиций StockSharp.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| -------- | -------- | ---------------------- |
| `CandleType` | Таймфрейм для расчётов. | 4 часа |
| `UpPeriod1`, `DownPeriod1` | Окна поиска экстремумов для быстрой линии. | 6, 6 |
| `UpPeriod2`, `DownPeriod2` | Окна поиска экстремумов для медленной линии. | 9, 9 |
| `XLength1`, `XLength2` | Периоды сглаживающих скользящих. | 25, 80 |
| `Method1`, `Method2` | Типы скользящих (простая, экспоненциальная, сглаженная, взвешенная). | Простая |
| `SignalBar` | Смещение по истории для чтения цветов. | 1 |
| `EnableBuyOpen`, `EnableSellOpen` | Разрешение на открытие лонга/шорта. | true |
| `EnableBuyClose`, `EnableSellClose` | Разрешение на закрытие лонга/шорта. | true |
| `Volume` | Базовый размер позиции; при развороте к нему прибавляется текущий объём. | 1 |

## Рекомендации

- Оригинальный XMA с управлением фазой недоступен в StockSharp, поэтому используются стандартные типы сглаживания, наиболее близкие по поведению.
- Значение `SignalBar = 1` соответствует задержке в одну свечу, как и в эксперте MetaTrader. При необходимости дополнительного подтверждения увеличьте параметр.
- Поскольку выходы зависят исключительно от смены цвета осциллятора, рекомендуется дополнить стратегию внешними механизмами риск-менеджмента при работе на реальном счёте.
