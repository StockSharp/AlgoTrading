# Стратегия MACD Power

## Общее описание
MACD Power — многофреймовая импульсная стратегия, перенесённая из оригинального советника MetaTrader. Логика использует пару линейно взвешенных средних (LWMA) по типичной цене свечи, два варианта MACD, фильтр Momentum на старшем таймфрейме и месячный MACD в роли долгосрочного фильтра. Сделки открываются, когда импульс и старший тренд показывают согласованное движение.

## Основные элементы
- **LWMA по типичной цене**. Быстрая и медленная LWMA рассчитываются по формуле \((High + Low + Close) / 3\). Сигналы рассматриваются только тогда, когда быстрая средняя находится ниже медленной (для покупок/продаж), как и в исходном советнике, который ждал отката в пределах доминирующего тренда.
- **Двойной MACD**. Два индикатора MACD с параметрами `(12, 26, 1)` и `(6, 13, 1)` должны одновременно быть выше нуля для лонга и ниже нуля для шорта. Эти значения соответствуют условиям `MacdMAIN1` и `MacdMAIN2` из MQL и отражают краткосрочное ускорение цены.
- **Фильтр Momentum**. Индикатор Momentum (период 14) рассчитывается на более высоком таймфрейме, автоматически подбираемом относительно основного (например, для 15‑минутного графика берётся часовой Momentum). Анализируется абсолютное отклонение от уровня 100 за три последние точки; хотя бы одно из значений должно превышать порог `MomentumBuyThreshold`/`MomentumSellThreshold`.
- **Месячный MACD**. MACD с параметрами `(12, 26, 9)` на месячных свечах должен иметь основную линию выше сигнальной для лонга и ниже сигнальной для шорта. Это позволяет торговать только в сторону долгосрочного тренда.

## Управление позицией
- **Размер позиции** определяется параметром `OrderVolume`. При развороте система автоматически добавляет объём встречной позиции, чтобы сменить направление одной рыночной заявкой.
- **Тейк‑профит и стоп‑лосс** задаются в пунктах инструмента и переводятся в цену через `Security.PriceStep` (с защитным значением `1`, если шаг цены не задан).
- **Трейлинг‑стоп** активируется после достижения прибыли, заданной в `TrailingActivationPoints`, и сопровождает экстремум цены с отступом `TrailingOffsetPoints`.
- **Безубыток**. При достижении `BreakEvenTriggerPoints` уровень защиты переносится в точку входа с учётом отступа `BreakEvenOffsetPoints`. Возврат цены к этому уровню закрывает позицию.
- **Лимит сделок**. Параметр `MaxTrades` ограничивает количество новых входов в рамках одного запуска стратегии.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Основной таймфрейм стратегии. | Свечи 15 минут |
| `FastMaLength` | Период быстрой LWMA (типичная цена). | 6 |
| `SlowMaLength` | Период медленной LWMA (типичная цена). | 85 |
| `MomentumLength` | Длина окна Momentum на старшем таймфрейме. | 14 |
| `MomentumBuyThreshold` | Минимальное отклонение Momentum от 100 для покупок. | 0.3 |
| `MomentumSellThreshold` | Минимальное отклонение Momentum от 100 для продаж. | 0.3 |
| `TakeProfitPoints` | Тейк‑профит в пунктах. | 50 |
| `StopLossPoints` | Стоп‑лосс в пунктах. | 20 |
| `TrailingActivationPoints` | Прибыль (в пунктах), после которой включается трейлинг. | 40 |
| `TrailingOffsetPoints` | Отступ трейлинг‑стопа от экстремума. | 40 |
| `BreakEvenTriggerPoints` | Прибыль (в пунктах), активирующая защиту безубытком. | 30 |
| `BreakEvenOffsetPoints` | Отступ при переносе стопа в безубыток. | 30 |
| `MaxTrades` | Максимальное число сделок за запуск. | 10 |
| `OrderVolume` | Базовый объём сделки. | 1 |

## Отличия от версии MQL
- Используется высокоуровневый API StockSharp (`SubscribeCandles`, `Bind`, `BindEx`), поэтому расчёты выполняются по завершённым свечам без ручного опроса тиков.
- Денежный трейлинг и контроль просадки счёта из MQL не переносились: в экосистеме StockSharp эти задачи обычно решаются внешними модулями риск‑менеджмента. Оставлены пунктовые стопы, трейлинг и безубыток, соответствующие базовой логике эксперта.
- Сообщения, почтовые уведомления и вспомогательные функции модификации ордеров убраны — стратегия работает только через рыночные заявки API.

## Рекомендации по использованию
1. Подберите основной таймфрейм через `CandleType`. Вспомогательный таймфрейм для Momentum и месячный MACD подбираются автоматически.
2. Настройте значения `TakeProfitPoints`, `StopLossPoints` и других риск‑параметров под шаг цены конкретного инструмента.
3. При тестировании контролируйте лимит `MaxTrades`. Увеличьте его, если требуется разрешить множественные последовательные входы.
4. Для визуального анализа включите отображение свечей и LWMA на графике — стратегия рисует их автоматически при наличии области графика.

