# Стратегия New FSCEA

## Общее описание
Стратегия New FSCEA — это порт с MT4-советника `new_fscea.mq4`. Алгоритм относится к трендовым системам на основе MACD и использует подтверждение наклона EMA, фиксированное тейк-профит целевое расстояние и плавающий трейлинг-стоп. В рынке всегда находится только одна позиция, как и в оригинальной реализации.

## Логика работы
### Условия входа в покупки
- Линия MACD находится ниже нуля и на текущей закрывшейся свече пересекает сигнальную линию снизу вверх.
- На предыдущей свече MACD оставался ниже сигнальной линии (подтверждение факта пересечения).
- Абсолютное значение MACD превышает порог `OpenLevelPoints`, приведённый к цене через шаг цены.
- Наклон смещённой EMA положительный (`EMA_shifted_now > EMA_shifted_previous`).
- Открытых позиций нет.

### Условия входа в продажи
- Линия MACD находится выше нуля и на текущей закрывшейся свече пересекает сигнальную линию сверху вниз.
- На предыдущей свече MACD оставался выше сигнальной линии.
- Значение MACD превышает порог `OpenLevelPoints`, пересчитанный в цену.
- Наклон смещённой EMA отрицательный (`EMA_shifted_now < EMA_shifted_previous`).
- Открытых позиций нет.

### Закрытие длинной позиции
- MACD пересекает сигнальную линию сверху вниз в положительной зоне и величина индикатора превышает `CloseLevelPoints`.
- Или максимум свечи достигает виртуального тейк-профита (`entry + TakeProfitPoints * priceStep`).
- Или минимум свечи достигает текущего уровня трейлинг-стопа (уровень подтягивается по мере роста прибыли).

### Закрытие короткой позиции
- MACD пересекает сигнальную линию снизу вверх в отрицательной зоне и абсолютное значение индикатора превышает `CloseLevelPoints`.
- Или минимум свечи достигает виртуального тейк-профита (`entry - TakeProfitPoints * priceStep`).
- Или максимум свечи достигает трейлинг-стопа (уровень опускается вслед за прибылью).

## Управление рисками
- Тейк-профит задаётся в пунктах и переводится в цену через `Security.PriceStep`.
- Трейлинг-стоп также выражен в пунктах; активируется только при достаточной плавающей прибыли.
- В каждый момент времени разрешена только одна позиция, что полностью повторяет поведение MT4-советника.
- Метод `StartProtection()` включает защитные механизмы платформы.

## Используемые индикаторы
- **MACD (12, 26, 9)** — основной источник сигналов. Пересечение и амплитуда задают условия входа и выхода.
- **EMA (TrendPeriod)** — вычисляется по цене закрытия. Сдвиг `TrendShift` имитирует параметр `ma_shift` в MT4 и позволяет сравнивать наклон линии.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TakeProfitPoints` | 300 | Расстояние до тейк-профита в пунктах (конвертируется в цену через шаг цены). |
| `TrailingStopPoints` | 20 | Размер трейлинг-стопа в пунктах. Уровень подтягивается после превышения прибыли над этим значением. |
| `OpenLevelPoints` | 3 | Минимальная величина MACD (в пунктах) для допуска к открытию позиции. |
| `CloseLevelPoints` | 2 | Порог MACD (в пунктах) для закрытия позиции по сигналу индикатора. |
| `TrendPeriod` | 10 | Длина EMA, используемой как фильтр направления. |
| `TrendShift` | 2 | Горизонтальный сдвиг EMA в барах. Чем выше значение, тем позднее подтверждается тренд. |
| `TradeVolume` | 0.1 | Базовый объём рыночных заявок. |
| `CandleType` | Таймфрейм 1 час | Тип свечей, используемых для расчётов (можно изменить). |

## Особенности реализации в StockSharp
- Обрабатываются только завершённые свечи, чтобы логика совпадала с MT4-версией.
- Сдвиг EMA реализован через внутренний буфер: сравниваются значения, разделённые `TrendShift` барами.
- Тейк-профит и трейлинг-стоп ведутся виртуально, без выставления реальных лимитных/стоп заявок, что соответствует требованиям high-level API.
- Подписка на данные выполняется через `SubscribeCandles().BindEx(...)`, полностью соблюдая стандарты проекта.
