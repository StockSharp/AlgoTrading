# Стратегия «Previous Candle Breakdown»

## Обзор
Стратегия повторяет логику одноимённого советника из MetaTrader. Она отслеживает пробой предыдущей свечи: при выходе цены выше максимума или ниже минимума прошлой свечи с заданным отступом в шагах цены отправляется рыночная заявка. Реализация использует высокоуровневые API StockSharp — подписку на свечи для расчёта уровней и подписку на сделки для принятия решений.

## Логика работы
1. После закрытия каждой опорной свечи (по умолчанию 4 часа) запоминается максимум и минимум предыдущей свечи, к которым добавляется/вычитается отступ `IndentSteps * Security.PriceStep`.
2. По данным тиковых сделок контролируется достижение уровней. Достижение верхней границы открывает длинную позицию, пробой нижней — короткую.
3. Дополнительный фильтр по скользящим средним требует, чтобы быстрая SMA (с учётом возможного сдвига) была выше медленной для лонгов и ниже для шортов. Нулевой период любой SMA отключает фильтр.
4. Торговля разрешена только внутри временного окна между `StartTime` и `EndTime`; поддерживаются сессии, которые переходят через полночь.
5. Фиксация риска выполняется непрерывно: стоп-лосс, тейк-профит и трейлинг-стоп могут закрыть позицию раньше, чем появится сигнал на разворот.

## Управление риском
- **StopLossSteps / TakeProfitSteps** — расстояние до стоп-лосса и тейк-профита в шагах цены (`distance = steps * Security.PriceStep`).
- **TrailingStopSteps / TrailingStepSteps** — включают трейлинг-стоп. После прохождения цены на величину трейлинга стоп активируется и сдвигается при каждом дополнительном движении не меньше указанного шага.
- **ProfitClose** — закрывает все позиции, если плавающая прибыль `Position * (последняя цена - PositionPrice)` превышает порог (0 — отключено).
- **MaxNetPosition** — ограничивает абсолютное значение суммарной позиции. Величину сделки задаёт свойство `Volume` у стратегии.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Таймфрейм свечей для расчёта уровней. |
| `IndentSteps` | Отступ от максимума/минимума предыдущей свечи в шагах цены. |
| `FastMaPeriod` / `FastMaShift` | Период и сдвиг быстрой SMA. |
| `SlowMaPeriod` / `SlowMaShift` | Период и сдвиг медленной SMA. |
| `StopLossSteps` | Расстояние до стоп-лосса. |
| `TakeProfitSteps` | Расстояние до тейк-профита. |
| `TrailingStopSteps` | Размер трейлинг-стопа (0 — отключён). |
| `TrailingStepSteps` | Минимальный дополнительный профит для переноса трейлинг-стопа; при включённом трейлинге должен быть > 0. |
| `ProfitClose` | Порог плавающей прибыли для полного закрытия. |
| `MaxNetPosition` | Максимально допустимая нетто-позиция. |
| `StartTime` / `EndTime` | Временные границы торговли. |

## Рекомендации по использованию
- Управляйте размером заявок через свойство `Volume`. Перенос расчёта лота по риску из MQL-версии не выполнялся.
- В расчётах используются простые скользящие средние (SMA). При необходимости можно добавить другие типы усреднения.
- Порог `ProfitClose` измеряется в ценовых единицах (объём × изменение цены); подберите значение под конкретный инструмент.
- Стратегия работает в неттинговом режиме: встречные сделки автоматически закрывают текущую позицию перед открытием новой.
- При включённом трейлинг-стопе параметр `TrailingStepSteps` должен быть положительным, иначе стратегия не запустится.

## Отличия от оригинального MQL-советника
- Не реализовано управление объёмом по фиксированным лотам или проценту риска; в StockSharp за это отвечает `Volume` или внешние модули.
- Поддерживаются только SMA; выбор метода сглаживания, доступный в MetaTrader, не перенесён.
- Закрытие по прибыли использует плавающий PnL на основе средней цены позиции — комиссии и свапы брокера не учитываются.
- Сообщения о результатах сделок упрощены и делегированы стандартному логированию StockSharp.
