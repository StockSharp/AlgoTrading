# 跟踪止盈策略

## 概述
该策略移植自 MetaTrader 的跟踪止盈 EA。本策略不会寻找进场信号，而是专注于管理已有仓位：在指定距离挂出止盈限价单，并在行情回落时逐步把止盈价位向当前价格靠近，从而保护浮动盈利，同时为趋势继续发展保留空间。

## 工作流程
1. 当出现新的仓位（多头或空头）时，策略立即按照入场价 ± `TakeProfitPoints`（换算成价格单位）挂出止盈限价单。
2. 通过 Level1 订阅接收买卖价更新，并据此重新计算理想的止盈位置。
3. 如果新的目标价相比当前挂单至少收缩了 `TrailingStepPoints`（价格步长），策略会撤掉原有挂单并在新的位置重新挂出限价单。
4. 如果未启用 `TrailInLossZone`，止盈不会被调整到 `BreakevenPoints` 对应的保本价位以下，从而保证始终锁定最小利润。
5. 每次调整都会检查 `SpreadMultiplier × 价格步长` 对应的最小止损距离，以避免触犯交易所或券商的最小距离限制。
6. 当仓位归零时，所有挂出的止盈单都会自动撤销。

策略只会处理 `Strategy.Security` 指定标的上的自有仓位。人工交易或其他策略产生的净仓位变化都会被自动接管并开始跟踪止盈。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `TakeProfitPoints` | 初始止盈距离，单位为价格步长。 | `100` |
| `TrailingStepPoints` | 每次调整止盈所需的最小回撤幅度（价格步长）。 | `10` |
| `TrailInLossZone` | 启用后允许止盈价进入亏损区域，否则止盈价会被限制在保本价以上/以下。 | `false` |
| `BreakevenPoints` | 跟踪时需要保留的最小利润，对应保本价的偏移量（价格步长）。 | `6` |
| `SpreadMultiplier` | 乘以价格步长得到最小止损距离，用于满足交易限制。 | `2` |
| `PositionType` | 指定需要管理的仓位方向：全部、多头或空头。 | `All` |

## 数据需求
* 需要订阅 Level1 数据获取买一/卖一价格，否则无法执行跟踪逻辑。
* 证券必须提供 `MinPriceStep`（或 `PriceStep`），用于将点值参数换算成实际价格。

## 使用步骤
1. 将策略绑定到组合与标的，确保标的已经配置了正确的价格步长。
2. 根据需求调整参数，定义止盈距离和跟踪灵敏度。
3. 启动策略后，可手动或由其他系统开仓。本策略会自动挂出止盈限价单并在行情回撤时进行调整。
4. 关闭策略或平仓即可自动撤销剩余止盈挂单。

## 备注
* 只有当行情逆向移动超过 `TrailingStepPoints` 时才会收紧止盈；顺势上涨/下跌不会把止盈拉得更远。
* 挂单数量始终与当前净仓位匹配，若外部平仓则挂单会立即撤销。
* 策略不提供止损功能，如需止损可结合 `StartProtection` 或其他风险管理措施。
