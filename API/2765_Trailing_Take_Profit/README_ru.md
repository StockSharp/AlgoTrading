# Стратегия Trailing Take Profit

## Обзор
Эта стратегия переносит функциональность советника Trailing Take Profit из MetaTrader. Она не ищет точки входа, а управляет уже открытой позицией: размещает лимитную заявку на фиксированном расстоянии от цены входа и постепенно подтягивает ее ближе к текущей цене при откате рынка. Такой подход позволяет сохранить накопленную прибыль и при этом не мешает продолжению тренда.

## Как работает алгоритм
1. При появлении новой позиции (лонг или шорт) стратегия сразу выставляет лимитную заявку на закрытие по цене входа ± `TakeProfitPoints`, пересчитанной в денежные единицы.
2. Через подписку Level1 поступают обновления bid/ask. Каждое обновление приводит к пересчету желаемого уровня take profit.
3. Если новый уровень оказался как минимум на `TrailingStepPoints` (в шагах цены) ближе к рынку, текущая лимитная заявка снимается и переставляется на новое значение.
4. Пока параметр `TrailInLossZone` выключен, целевая цена не может опуститься ниже уровня безубыточности, заданного `BreakevenPoints`.
5. Дополнительно контролируется минимальная дистанция до рынка: целевой уровень должен находиться не ближе, чем `SpreadMultiplier × шаг цены`, чтобы не нарушать биржевые ограничения.
6. Когда позиция закрывается, связанные лимитные заявки автоматически отменяются.

Стратегия управляет только инструментом, указанным в `Strategy.Security`. Любые внешние сделки, изменяющие чистую позицию, будут автоматически взяты под контроль и начнут сопровождаться trailing take profit.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TakeProfitPoints` | Начальное расстояние до take profit в шагах цены. | `100` |
| `TrailingStepPoints` | Минимальный откат (в шагах цены), после которого take profit сдвигается. | `10` |
| `TrailInLossZone` | Разрешить ли смещение цели в убыточную зону. При значении `false` take profit ограничен уровнем безубыточности. | `false` |
| `BreakevenPoints` | Размер «подушки» прибыли, которую нужно сохранить. Используется для расчета уровня безубыточности. | `6` |
| `SpreadMultiplier` | Множитель шага цены, определяющий минимально допустимое расстояние до рынка. | `2` |
| `PositionType` | Какими позициями управлять: всеми, только лонгами или только шортами. | `All` |

## Требования к данным
* Нужна подписка на Level1, чтобы получать лучшие bid/ask и корректно обновлять трал.
* У инструмента должен быть задан `MinPriceStep` (или `PriceStep`), поскольку параметры измеряются в шагах цены.

## Использование
1. Подключите стратегию к нужному инструменту и портфелю, убедитесь, что шаг цены настроен верно.
2. Настройте параметры под свою торговую модель (расстояние take profit, чувствительность трала и т.д.).
3. Запустите стратегию и открывайте позиции вручную или другим роботом. Стратегия автоматически выставит лимитный take profit и будет подтягивать его по мере движения рынка.
4. При остановке стратегии или закрытии позиции связанные лимитные заявки снимаются.

## Примечания
* Take profit подтягивается только при движении цены против позиции. Если цена продолжает тренд, уровень остается на месте.
* Объем лимитной заявки всегда соответствует текущей чистой позиции. Если позицию закрыли извне, заявка будет отменена.
* Стратегия не выставляет стоп-заявки. При необходимости используйте `StartProtection` или сторонние инструменты риск-менеджмента.
