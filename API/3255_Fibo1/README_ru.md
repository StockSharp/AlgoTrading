# Стратегия FIBO1 (конвертация MQL 24845)

## Обзор

**FIBO1 Strategy** переносит торговую логику эксперта `FIBO1.mq4` автора Aharon Tzadik
в инфраструктуру StockSharp. Стратегия работает с одним инструментом и сочетает три
группы фильтров:

1. **Трендовый фильтр** – быстрая и медленная линейно-взвешенные скользящие (LWMA)
   по типичной цене. Для покупок быстрая LWMA должна быть выше медленной, для продаж –
   наоборот.
2. **Подтверждение моментума** – три последовательных значения индикатора Momentum
   сравниваются с порогами на покупку и продажу. В расчёте используется абсолютное
   отклонение от уровня 100, как и в оригинале.
3. **Фильтр MACD** – на старшем таймфрейме MACD подтверждает направление сделки. В
   реализации сохранены настройки 12/26/9 и проверка взаимного положения основной и
   сигнальной линий.

После открытия позиции стратегия воспроизводит расширенный блок сопровождения из
`FIBO1.mq4`:

- Стоп-лосс и тейк-профит в пунктах.
- Денежный и процентный тейк-профит + денежное трейлинг-сопровождение.
- Трейлинг по экстремумам последних свечей с отступом (аналог параметра PAD AMOUNT).
- Классический трейлинг по фиксированному расстоянию.
- Перевод в безубыток с заданным отступом.
- Эквити-стоп по просадке от максимального значения капитала.

> **Важно.** В живой торговле MQL-версия использовала вручную нанесённую линию "FIBO"
> на графике. StockSharp не имеет доступа к графическим объектам терминала, поэтому
> стратегия всегда работает по ветке тестера (без фильтра по линиям Фибо). Остальные
> возможности полностью перенесены и описаны ниже.

## Логика торговли

1. **Поиск сигнала**
   - Ожидаем закрытую свечу на рабочем таймфрейме.
   - Проверяем, что быстрая LWMA находится выше/ниже медленной в зависимости от
     направления сделки.
   - Сравниваем экстремумы предыдущих свечей (`Low[2] < High[1]` для лонгов и
     `Low[1] < High[2]` для шортов).
   - Вычисляем максимум абсолютного отклонения трёх последних значений Momentum от
     уровня 100. Если он превышает заданный порог, фильтр пропускает сигнал.
   - Убеждаемся, что на старшем таймфрейме линия MACD находится выше/ниже сигнальной.
   - При выполнении всех условий стратегия закрывает встречную позицию и открывает
     рыночную сделку требуемого объёма.

2. **Управление рисками**
   - Каждая новая позиция сразу получает защитные ордера стоп-лосса и тейк-профита.
   - При достижении заданной прибыли стоп переносится в безубыток с указанным отступом.
   - Трейлинг может работать по минимумам/максимумам свечей либо по фиксированному
     расстоянию в пунктах.
   - Денежные цели отслеживают плавающую прибыль, процент от стартового equity и
     реализуют трейлинг в валюте счёта.
   - Эквити-стоп следит за просадкой относительно исторического максимума equity и
     закрывает все позиции при превышении допустимого значения.

## Параметры

| Название | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `UseMoneyTakeProfit` | `false` | Закрывать позиции при достижении `MoneyTakeProfit` в валюте счёта. |
| `MoneyTakeProfit` | `10` | Денежный тейк-профит. Работает только если `UseMoneyTakeProfit = true`. |
| `UsePercentTakeProfit` | `false` | Включить тейк-профит в процентах от стартового equity. |
| `PercentTakeProfit` | `10` | Процент прибыли от стартового equity. |
| `EnableMoneyTrailing` | `true` | Активировать денежный трейлинг после достижения `MoneyTrailTarget`. |
| `MoneyTrailTarget` | `40` | Минимальная плавающая прибыль для запуска денежного трейлинга. |
| `MoneyTrailStop` | `10` | Допустимый откат прибыли (в валюте счёта) после активации денежного трейлинга. |
| `UseEquityStop` | `true` | Включить защиту по просадке equity. |
| `EquityRiskPercent` | `1` | Максимальная просадка (в % от пика equity), при которой закрываются все позиции. |
| `TradeVolume` | `1` | Базовый объём рыночных сделок. |
| `FastMaPeriod` | `20` | Период быстрой LWMA по типичной цене. |
| `SlowMaPeriod` | `100` | Период медленной LWMA по типичной цене. |
| `MomentumPeriod` | `14` | Период индикатора Momentum. |
| `MomentumBuyThreshold` | `0.3` | Минимальное отклонение Momentum от 100 для входа в лонг. |
| `MomentumSellThreshold` | `0.3` | Минимальное отклонение Momentum от 100 для входа в шорт. |
| `MacdFastPeriod` | `12` | Период быстрой EMA внутри MACD. |
| `MacdSlowPeriod` | `26` | Период медленной EMA внутри MACD. |
| `MacdSignalPeriod` | `9` | Период сигнальной EMA внутри MACD. |
| `TakeProfitPips` | `50` | Расстояние тейк-профита в пунктах. |
| `StopLossPips` | `20` | Расстояние стоп-лосса в пунктах. |
| `TrailingActivationPips` | `40` | Прибыль (в пунктах), необходимая для запуска ценового трейлинга. |
| `TrailingDistancePips` | `40` | Расстояние, поддерживаемое ценовым трейлингом. |
| `UseCandleTrailing` | `true` | Использовать трейлинг по экстремумам свечей вместо фиксированного расстояния. |
| `CandleTrailingLength` | `3` | Количество закрытых свечей для расчёта экстремума трейлинга. |
| `CandleTrailingOffsetPips` | `3` | Дополнительный отступ (в пунктах) к цене трейлинга по свечам. |
| `MoveToBreakEven` | `true` | Переводить позицию в безубыток. |
| `BreakEvenActivationPips` | `30` | Прибыль (в пунктах), после которой стоп переносится в безубыток. |
| `BreakEvenOffsetPips` | `30` | Отступ (в пунктах) при переносе стопа в безубыток. |
| `CandleType` | `15m` | Основной поток свечей для сигналов. |
| `MomentumCandleType` | `15m` | Таймфрейм для расчёта Momentum. |
| `MacdCandleType` | `1d` | Старший таймфрейм для MACD. |

## Особенности использования

- Значения таймфреймов подобраны по аналогии с MQL-экспертом: рабочий и моментумный
  потоки совпадают, MACD берёт данные со старшего таймфрейма (по умолчанию дневного).
- Пересчёт пунктов автоматически учитывает 3/5-знаковые форекс-тикеры, умножая шаг цены
  на 10. Для других инструментов используется исходный `PriceStep`.
- Стратегия работает только с закрытыми свечами. Поставщик данных обязан публиковать
  состояние свечи (Finished), иначе условия не выполнятся.
- В режиме неттинга разворот позиции осуществляется через закрытие противоположного
  объёма и открытие новой сделки, что соответствует поведению оригинальной версии.

## Отличия от оригинального эксперта

- Проверка линии "FIBO" отсутствует из-за невозможности читать графические объекты
  MT4. Стратегия всегда работает по тестовой ветке кода.
- Параметры управления объёмом (`Lots`, `LotExponent`, `Max_Trades`) заменены одним
  свойством `TradeVolume`, поскольку StockSharp ведёт агрегированную позицию. Масштаб
  объёма можно реализовать внешним оптимизатором.
- Удалены все уведомления (`Alert`, `SendMail`, `SendNotification`), чтобы стратегия
  оставалась самодостаточной внутри StockSharp.

Порт сохраняет ключевые торговые идеи `FIBO1.mq4` и обеспечивает подробную настройку
через параметры StockSharp.
