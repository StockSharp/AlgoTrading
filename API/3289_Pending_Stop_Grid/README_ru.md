# Стратегия Pending Stop Grid

## Обзор
**Pending Stop Grid Strategy** — это прямой перенос эксперта MetaTrader 4 `new.mq4`. Стратегия одновременно поддерживает две симметричные лестницы отложенных заявок:

- Лесенку buy stop выше текущей цены ask;
- Лесенку sell stop ниже текущей цены bid.

На каждом уровне расстояние до рынка и торговый объём увеличиваются пропорционально номеру ступени. Для каждой заявки отдельно задаются уровни стоп-лосса и тейк-профита.

## Логика работы
1. Стратегия подписывается на поток Level 1 и непрерывно отслеживает последние значения лучшего bid и ask.
2. После получения котировок и разрешения на торговлю вычисляется размер пункта на основе минимального шага цены (для инструментов с тремя или пятью знаками выполняется автоматическая нормализация).
3. Перед постановкой заявок проверяется, что базовый объём соответствует ограничениям по минимальному и максимальному объёму инструмента.
4. Для каждого индекса `i` от 1 до `NumberOfTrades` выполняется:
   - Расчёт объёма `BaseVolume * i` с округлением к ближайшему допустимому шагу объёма;
   - Постановка buy stop по цене `Ask + DistancePips * i * pipSize` с заданными стопом и профитом;
   - Постановка sell stop по цене `Bid - DistancePips * i * pipSize` с зеркальными параметрами стопа и профита.
5. При исполнении, отмене или отказе любой заявки соответствующее место в лестнице освобождается и оперативно заполняется новой заявкой, когда это позволяет рынок.
6. В методе `OnStarted` вызывается `StartProtection()` для активации встроенной защиты платформы.

## Параметры
| Название | Описание | Значение по умолчанию |
| --- | --- | --- |
| `BaseVolume` | Объём первой заявки. Каждый следующий уровень умножает базовый объём на номер ступени. | `0.1` |
| `NumberOfTrades` | Количество одновременно поддерживаемых buy stop и sell stop заявок. | `10` |
| `DistancePips` | Расстояние в пунктах от текущей цены до каждой заявки. | `10` |
| `StopLossPips` | Расстояние стоп-лосса для каждой заявки. Ноль отключает постановку стопа. | `10` |
| `TakeProfitPips` | Расстояние тейк-профита для каждой заявки. Ноль отключает тейк-профит. | `10` |

Все параметры оформлены как оптимизируемые параметры стратегии и защищены проверками от недопустимых значений.

## Дополнительные замечания
- Объёмы округляются к ближайшему разрешённому шагу и ограничиваются биржевыми минимальными и максимальными значениями.
- Цены нормализуются через `Security.ShrinkPrice`, чтобы соблюдать шаг цены инструмента.
- Стратегия не хранит устойчивое состояние: при сбросе или изменении прав весь набор заявок формируется заново.
- Логика целиком построена на высокоуровневом API StockSharp, что соответствует требованиям проекта по конвертации.
