# TakeProfitTimeGuardStrategy

## Описание

`TakeProfitTimeGuardStrategy` повторяет логику советника MetaTrader `Exp_GTakeProfit_Tm`, контролируя прибыль всего счёта и принудительно закрывая позиции вне заданного временного окна. Стратегия не генерирует новые сделки — она служит уровнем риск-менеджмента поверх основной торговой логики и следит за тем, чтобы портфель оставался без позиций после достижения целевой прибыли или по окончании торговой сессии.

## Ключевые идеи

- Подписывается на поток свечей с настраиваемым таймфреймом (по умолчанию 1 минута) и вычисляет как реализованную, так и плавающую прибыль по цене закрытия последней свечи.
- Под плавающей прибылью понимается произведение текущей позиции на разницу между ценой закрытия и средней ценой позиции (`Strategy.PositionPrice`).
- Прибыль ниже нуля игнорируется, пока торговое окно открыто — поведение полностью соответствует оригиналу на MQL5.
- Когда целевое значение прибыли достигнуто, стратегия устанавливает внутренний флаг `_stop` и инициирует серию рыночных ордеров на закрытие текущей позиции до полного обнуления портфеля. Флаг сбрасывается после выхода в ноль.
- При активированном временном фильтре стратегия применяет тот же сценарий закрытия при выходе из торгового интервала, даже если целевая прибыль не достигнута.

## Параметры

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `CandleType` | `DataType` | 1-минутные свечи | Серия свечей, по которой вычисляются условия стратегии. |
| `TargetMode` | `ProfitTargetMode` (`Percent` / `Currency`) | `Percent` | Режим интерпретации `TakeProfitValue`: процент от капитала или абсолютное значение в валюте счёта. |
| `TakeProfitValue` | `decimal` | `100` | Целевой уровень прибыли. Должен быть больше нуля. |
| `UseTradingWindow` | `bool` | `true` | Включает или отключает контроль по времени. |
| `StartTime` | `TimeSpan` | `00:00:00` | Начало торгового окна (включительно). |
| `EndTime` | `TimeSpan` | `23:59:00` | Конец торгового окна. Если начало позже конца, окно продолжается через полночь. |

## Поведение

1. Начальное значение капитала считывается при запуске (или на первом обновлении, если изначально оно было нулевым) и используется как база для процентной цели.
2. Для вычисления плавающей прибыли используется цена закрытия последней полученной свечи, поэтому частота свечей напрямую влияет на скорость реакции.
3. При достижении целевой прибыли стратегия логирует событие и многократно отправляет рыночные заявки на закрытие, пока позиция не станет равной нулю.
4. Если активирован временной фильтр и текущее время выходит за пределы окна, происходит принудительное закрытие аналогично режиму достижения цели.
5. Флаг `_stop` автоматически очищается только после полного закрытия позиции, что предотвращает повторный запуск закрытия до завершения операции.

## Отличия от версии MQL

- Используется высокоуровневый API StockSharp (`SubscribeCandles`) вместо обработки каждого тика.
- Плавающая прибыль рассчитывается через `Strategy.PositionPrice`, а не через прямой доступ к позициям терминала.
- Добавлены информативные сообщения в журнал о срабатывании целевой прибыли.
- Сравнение времени основано на `CloseTime` полученных свечей.

## Рекомендации по использованию

- Запускайте стратегию вместе с основной торговой логикой на том же портфеле, чтобы обеспечить дополнительный уровень контроля прибыли.
- Подбирайте таймфрейм свечей исходя из требуемой скорости реакции: чем короче свеча, тем быстрее сработает защита.
- Убедитесь, что в портфеле доступно значение `CurrentValue`, иначе процентный режим не сможет корректно определить базу капитала.
- При необходимости комбинируйте стратегию с другими инструментами риск-менеджмента StockSharp (например, `StartProtection`).
