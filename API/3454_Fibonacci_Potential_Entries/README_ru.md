# Стратегия Fibonacci Potential Entries

## Обзор
**Fibonacci Potential Entries Strategy** повторяет эксперт `EA_PUB_FibonacciPotentialEntries` для MetaTrader. Стратегия подписывается на стакан уровня 1, после получения положительных бид/аск размещает две отложенные заявки возле заданных уровней Фибоначчи. При достижении общего целевого уровня каждая позиция сокращается на 50%, а стоп-приказ переносится в безубыток для оставшегося объёма.

## Соответствие оригиналу
- **Размещение заявок**:
  - *Первая заявка*: лимит на уровне 50% (`P50Level`). В бычьем режиме стоп ставится на три спреда ниже уровня 61%, в медвежьем — на три спреда выше.
  - *Вторая заявка*: лимит на уровне 61% (`P61Level`) со стопом в трёх спредах от середины между уровнями 61% и 100%.
- **Направление** – параметр `bType` преобразован в `MarketBias` (`Bull` для покупок, `Bear` для продаж).
- **Распределение риска** – первая сделка всегда использует риск `0.7%` от капитала, вторая берёт остаток `max(RiskPercent - 0.7, 0)` в точном соответствии с MQL-реализацией.
- **Расчёт объёма** – риск переводится в объём через `Portfolio.CurrentValue` (с резервом на `CurrentBalance` и `BeginValue`) и характеристики инструмента: шаг цены, стоимость шага, мультипликатор.
- **Частичная фиксация** – при пробое `TargetLevel` по каждой ноге отправляется рыночная заявка на закрытие половины объёма. После этого стоп перемещается на цену входа, что повторяет последовательность `OrderClose` + `OrderModify` оригинального эксперта.

## Параметры
| Название | Описание |
| --- | --- |
| `P50Level` | Цена уровня Фибоначчи 50%. |
| `P61Level` | Цена уровня Фибоначчи 61.8%. |
| `P100Level` | Цена уровня Фибоначчи 100% (используется при расчёте второго стопа). |
| `TargetLevel` | Общий уровень фиксации прибыли. |
| `RiskPercent` | Суммарный риск в процентах от капитала (не меньше 0.7). |
| `MarketBias` | Режим торговли: `Bull` (покупки) или `Bear` (продажи). |

## Последовательность работы
1. Выполняется подписка на `SubscribeLevel1()` и ожидание валидных котировок bid/ask.
2. После расчёта спреда, стопов и объёмов заявки выставляются по одному разу за запуск, как и в MetaTrader.
3. При исполнении заявок фиксируется средняя цена входа, размещается соответствующий стоп и ведётся учёт объёма по каждой ноге.
4. При достижении `TargetLevel` по каждой ноге отправляется рыночный приказ на закрытие половины позиции, затем стоп переносится в точку входа.
5. Стоп-заявки снимаются при закрытии объёма либо при остановке стратегии.

## Замечания
- Стоп-приказ переоформляется при каждом изменении объёма. Если биржа отклоняет заявку, проверьте права адаптера и специфику инструмента.
- Отдельная заявка take-profit не используется – выход управляется в онлайне, что отражает поведение исходного советника.
- Для повторной постановки отложенных заявок после изменения параметров требуется перезапуск стратегии, аналогично MetaTrader.
