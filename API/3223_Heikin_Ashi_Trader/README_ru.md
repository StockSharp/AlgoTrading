# Стратегия Heikin Ashi Trader
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник MetaTrader 4 «Heikin Ashi Trader» в StockSharp. Логика подтверждения сигналов несколькими индикаторами сохранена и реализована через высокоуровневый API подписки на свечи, поэтому решения принимаются только по закрытым барам.

## Подробности
- **Индикаторы**:
  - Свечи Heikin-Ashi, рассчитанные на рабочем таймфрейме.
  - Две линейно-взвешенные скользящие средние (LWMA) по типичной цене свечи.
  - Стохастик с настраиваемыми периодами `%K/%D/Smooth`.
  - Индикатор Momentum (расстояние от уровня 100).
  - MACD.
- **Условия входа**:
  - **Покупка**: последняя свеча Heikin-Ashi бычья, хотя бы одно из трёх последних значений стохастика превышает уровень перекупленности, быстрая LWMA выше медленной, модуль отклонения Momentum от 100 больше порога для покупок, линия MACD выше сигнальной.
  - **Продажа**: зеркальные условия – медвежья Heikin-Ashi, стохастик ниже уровня перепроданности, быстрая LWMA ниже медленной, отклонение Momentum больше порога для продаж, линия MACD ниже сигнальной.
  - Опционально перед входом закрывается противоположная позиция (`CloseOppositePositions`).
- **Управление позицией**:
  - Фиксированный стоп-лосс и тейк-профит в пипсах (переводятся через шаг цены инструмента).
  - Опциональный трейлинг-стоп, который подтягивается за ценой при движении на `TrailingStopPips`.
  - Перевод в безубыток: стоп переносится на `Entry ± BreakEvenOffsetPips`, когда цена проходит `BreakEvenTriggerPips` в нужную сторону.
  - Флаг `ForceExit` принудительно закрывает все позиции на следующей свече.
- **Отличия от версии MT4**:
  - Исходный советник считал Momentum на более высоком таймфрейме. Здесь все индикаторы работают на основном потоке свечей, чтобы остаться в рамках высокоуровневого API. Пороговые параметры можно подстроить для подражания исходной чувствительности.
  - Денежные стопы из кода MT4 не реализованы. Управление рисками осуществляется через ценовые стопы и модуль безубытка.

## Параметры
| Имя | Описание |
| --- | --- |
| `CandleType` | Таймфрейм (или тип свечей), используемый для расчётов и торговли. |
| `FastMaPeriod`, `SlowMaPeriod` | Периоды быстрых и медленных LWMA по типичной цене. |
| `StochasticKPeriod`, `StochasticDPeriod`, `StochasticSlowing` | Параметры стохастика. |
| `StochasticOverbought`, `StochasticOversold` | Уровни перекупленности/перепроданности, которые должны быть достигнуты за три последние значения. |
| `MomentumPeriod` | Длина индикатора Momentum. |
| `MomentumBuyThreshold`, `MomentumSellThreshold` | Минимальное абсолютное отклонение от 100 для сделок в лонг/шорт. |
| `MacdFastPeriod`, `MacdSlowPeriod`, `MacdSignalPeriod` | Настройки MACD. |
| `CloseOppositePositions` | Закрывать противоположные позиции перед входом. |
| `MaxPositions` | Максимальный чистый объём по направлению (`0` = без ограничений). |
| `TradeVolume` | Объём каждой новой заявки и значение `Strategy.Volume`. |
| `UseStopLoss`, `StopLossPips` | Включение и размер стоп-лосса в пипсах. |
| `UseTakeProfit`, `TakeProfitPips` | Включение и размер тейк-профита. |
| `UseTrailingStop`, `TrailingStopPips` | Включение трейлинг-стопа и его расстояние. |
| `UseBreakEven`, `BreakEvenTriggerPips`, `BreakEvenOffsetPips` | Настройки перевода в безубыток. |
| `ForceExit` | При `true` все позиции закрываются на следующей свече. |

## Особенности реализации
- Подписка на свечи выполняется через `SubscribeCandles().BindEx(...)`, поэтому индикаторы получают готовые значения и не требуется прямое обращение к `GetValue()`.
- Пересчёт пипсов выполняется на основе `PriceStep`. Для инструментов с дробными пипсами необходимо корректно настроить шаг цены.
- Трейлинг и безубыток смещают стоп только в сторону снижения риска. Состояние стопов и целей очищается при закрытии позиций, чтобы новые сделки начинались с чистых настроек.
