# Evening Star Reversal 策略

## 概述
该策略是 **EveningStar.mq5**（MQL5 编号 18507）专家顾问的直接移植版本。算法会追踪经典的“黄昏之星”三烛形态，并在下一根蜡烛开始交易时立即执行。全部逻辑基于 StockSharp 的高级 API 重新实现，同时保留了原始的风控与过滤条件。

## 交易逻辑
1. 策略订阅由 `CandleType` 参数指定的时间框架，只处理已经完成的蜡烛。
2. 每根蜡烛收盘时都会缓存最近的蜡烛快照，以便根据 `Shift` 参数检查连续三根蜡烛。
3. 满足以下条件时判定为黄昏之星：
   - 第 *N-2* 根蜡烛（最旧）为阳线（`open < close`）。
   - 第 *N-1* 根蜡烛（中间）符合 `Candle2Bullish` 设定（默认要求为阳线）。
   - 第 *N* 根蜡烛（最新）为阴线（`open > close`）。
   - 如果启用 `CheckCandleSizes`，中间蜡烛的实体必须是三根中最小的。
   - 如果启用 `ConsiderGap`，蜡烛实体之间必须存在缺口，缺口大小等于一个按价格步长换算的点值，与原策略完全一致。
4. 模式成立后，根据 `Direction` 参数确定下单方向：
   - `Short`（默认）开立空头仓位，对应经典的黄昏之星信号。
   - `Long` 允许进行反向操作（保留该选项以兼容原版 MQL 策略）。
5. 若 `CloseOppositePositions` 为 `true`，在开仓前会先平掉相反方向的持仓。
6. `StopLossPips` 和 `TakeProfitPips` 以点数表示，策略在计算止损/止盈价格时会根据 3/5 位报价对点值做和 MetaTrader 相同的调整。
7. 头寸规模根据当前投资组合价值和 `RiskPercent` 计算。如果结果小于最小可交易数量则忽略该信号。

## 仓位管理
- 持有多头时，每根新蜡烛都会检查低点是否触发止损或高点是否触及止盈，一旦满足任一条件就以市价平仓。
- 持有空头时执行同样的逻辑，但比较方向相反。
- 如果组合价值或止损距离为零，无法计算下单数量，因此跳过该信号。

## 参数
| 名称 | 默认值 | 说明 |
| ---- | ------ | ---- |
| `Direction` | `Short` | 形态出现时要建立的仓位方向。 |
| `TakeProfitPips` | `150` | 止盈距离（点）。设置为 0 可关闭止盈。 |
| `StopLossPips` | `50` | 止损距离（点）。小于等于 0 将阻止入场。 |
| `RiskPercent` | `5` | 单笔交易愿意承担的组合资金百分比，用于计算下单数量。 |
| `Shift` | `1` | 在评估形态前跳过的最新蜡烛数量。 |
| `ConsiderGap` | `true` | 要求蜡烛之间存在缺口，与原 EA 一致。 |
| `Candle2Bullish` | `true` | 要求第二根蜡烛为阳线，关闭后则要求阴线。 |
| `CheckCandleSizes` | `true` | 检查第二根蜡烛实体是否最小。 |
| `CloseOppositePositions` | `true` | 在开新仓之前平掉反向仓位。 |
| `CandleType` | `1H` 时间框架 | 用于分析的蜡烛序列。 |

## 说明
- 点值根据品种的价格步长计算。对于三位或五位报价的外汇品种，一个点等于十个最小价格步，与原版 EA 完全一致。
- 当 `StopLossPips` 为零时无法估算风险，策略会忽略该信号以避免无限风险暴露。
- 蜡烛缓存会自动截断到所需长度，因此长时间运行也不会导致内存占用持续增长。
