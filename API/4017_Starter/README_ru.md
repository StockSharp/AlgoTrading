# Стратегия Starter 2005

## Обзор
**Starter 2005 Strategy** — это перенос на высокоуровневый API StockSharp классического эксперта MetaTrader 4 `Starter.mq4` (2005 год). Оригинальный алгоритм сочетает осциллятор Laguerre, фильтр наклона экспоненциальной средней и подтверждение по CCI. Конверсия сохраняет структуру принятия решений, адаптируя управление капиталом и исполнение к архитектуре StockSharp:

- Прокси Laguerre RSI воссоздаёт буфер `iCustom("Laguerre")`, колеблющийся в диапазоне 0–1.
- EMA с периодом 5 на медианной цене обеспечивает ту же проверку растущего/падающего наклона, что и в MT4.
- CCI с периодом 14 по ценам закрытия фильтрует слабые сигналы аналогично переменной `Alpha`.
- Процедура подбора объёма повторяет логику `LotsOptimized()`, включая уменьшение лота после серии убыточных сделок.
- Выход из позиции происходит при развороте Laguerre из экстремальной зоны либо при достижении ценой целевого расстояния `Point * Stop`.

## Торговая логика
1. **Подготовка индикаторов**
   - Laguerre RSI вычисляется через четырёхступенчатый фильтр Laguerre с настраиваемым `Gamma`.
   - EMA длиной 5 рассчитывается по формуле `(High + Low) / 2`, что соответствует `PRICE_MEDIAN` в MQL4.
   - CCI с периодом 14 использует цены закрытия; низкий порог `±5` сохранён для максимальной идентичности.
2. **Условия для покупки**
   - Laguerre находится вблизи нуля (`LaguerreEntryTolerance` имитирует жёсткое сравнение `== 0`).
   - EMA растёт относительно предыдущей завершённой свечи.
   - CCI падает ниже `-CciThreshold`.
3. **Условия для продажи**
   - Laguerre находится вблизи единицы (`1 - LaguerreEntryTolerance` приближает условие `== 1`).
   - EMA снижается.
   - CCI поднимается выше `+CciThreshold`.
4. **Выходы**
   - Лонг закрывается при росте Laguerre выше `LaguerreExitHigh` (по умолчанию `0.9`) либо при прибыли `TakeProfitPoints * PriceStep`.
   - Шорт закрывается при падении Laguerre ниже `LaguerreExitLow` (по умолчанию `0.1`) либо при аналогичном движении цены вниз.
   - Любое внешнее закрытие позиции сбрасывает внутренние переменные, чтобы исключить повторное использование устаревших данных.

## Управление капиталом
Функция `CalculateOrderVolume` повторяет работу MT4-функции `LotsOptimized()`:

1. **Расчёт по риску** — капитал (`equity * MaximumRisk`) делится на `RiskDivider` (по умолчанию 500, как в формуле `AccountFreeMargin() * MaximumRisk / 500`). Полученное значение переводится в объём через деление на текущую цену.
2. **Базовый лот** — если риск-формула даёт меньший объём, используется `BaseVolume`.
3. **Снижение после серии убытков** — начиная со второго отрицательного результата объём уменьшается на `volume * losses / DecreaseFactor`, полностью повторяя оригинальный цикл по истории сделок.
4. **Нормализация** — объём приводится к `VolumeStep` инструмента и ограничивается диапазоном `MinVolume`–`MaxVolume`.

Счётчик убыточных сделок сбрасывается после любой прибыльной сделки и увеличивается после убыточной; нулевой результат оставляет значение без изменений, как и в MQL4-версии.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `BaseVolume` | `decimal` | `1.2` | Минимальный объём, используемый при недостаточном рисковом объёме. |
| `MaximumRisk` | `decimal` | `0.036` | Доля капитала, вовлекаемая в сделку до применения делителя. |
| `RiskDivider` | `decimal` | `500` | Делитель риск-капитала, воспроизводящий правило `/500`. |
| `DecreaseFactor` | `decimal` | `2` | Коэффициент уменьшения объёма после серии убытков. |
| `MaPeriod` | `int` | `5` | Период EMA по медианной цене свечи. |
| `CciPeriod` | `int` | `14` | Период CCI. |
| `CciThreshold` | `decimal` | `5` | Абсолютный порог CCI для входа. |
| `LaguerreGamma` | `decimal` | `0.66` | Параметр сглаживания фильтра Laguerre. |
| `LaguerreEntryTolerance` | `decimal` | `0.02` | Допуск вокруг 0/1 для имитации строгих сравнений. |
| `LaguerreExitHigh` | `decimal` | `0.9` | Уровень выхода для длинных позиций. |
| `LaguerreExitLow` | `decimal` | `0.1` | Уровень выхода для коротких позиций. |
| `TakeProfitPoints` | `decimal` | `10` | Целевое расстояние в ценовых пунктах (`Point * Stop`). |
| `CandleType` | `DataType` | `TimeFrame(5m)` | Тип свечей, обрабатываемых стратегией. |

## Особенности реализации
- Laguerre RSI реализован непосредственно в стратегии по формуле четырёхуровневого фильтра, без вызовов `GetValue()`.
- EMA и CCI обновляются вручную внутри обработчика свечей, чтобы гарантировать использование медианной цены, как в MQL4.
- Перед открытием позиций проверяются флаги `AllowLong()` / `AllowShort()` и отсутствие активных заявок — стратегия всегда держит не более одной позиции.
- Для оценки результата сделки используется актуальная торговая цена (последняя, цена закрытия или открытия), что позволяет корректно вести счётчик убыточных серий.
- Все ключевые блоки снабжены комментариями на английском языке для упрощения сопровождения.

## Рекомендации по использованию
- Исходный эксперт ориентирован на внутридневные валютные пары; выбирайте инструменты с мелким шагом цены, чтобы целевые 10 пунктов соответствовали одному пипсу.
- Запускайте стратегию в условиях, где маловероятны частичные исполнения и конкурирующие заявки (тестирование в истории или высоколиквидный рынок).
- Если Laguerre редко достигает значений 0 или 1, увеличьте `LaguerreEntryTolerance`.
- Настраивайте `RiskDivider` и `DecreaseFactor` совместно, чтобы сбалансировать рост риска и защиту капитала.
