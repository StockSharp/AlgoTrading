# Kloss Simple Strategy
[English](README.md) | [中文](README_cn.md)

**Kloss Simple Strategy** — это точная конверсия советника MetaTrader 4 `Kloss_.mq4` на платформу StockSharp. Логика полностью соответствует оригиналу: используются экспоненциальная скользящая средняя по взвешенной цене закрытия, индикатор CCI и осциллятор Stochastic. Все сигналы рассчитываются по предыдущей завершённой свече, что повторяет смещение индикаторов на один бар в исходном коде MQL. Размер позиции может задаваться как фиксированным объёмом, так и процентом от стоимости портфеля, аналогично режиму «динамического лота».

## Основная идея

1. Отслеживать контекст импульса с помощью порогов **CCI** и **Stochastic** вокруг нейтральных уровней.
2. Подтверждать сигналы краткосрочной **EMA** по взвешенной цене закрытия.
3. Входить в позицию только тогда, когда условия выполнены на предыдущей свече, исключая сделки по неполным данным.
4. Разрешать несколько сделок в одном направлении с ограничением `MaxOrders`, как и в оригинальном советнике.

## Настройки индикаторов

- **EMA (MaPeriod)**: использует взвешенное закрытие `(Close * 2 + High + Low) / 4`, что соответствует режиму `PRICE_WEIGHTED` в MetaTrader и работает как фильтр тренда.
- **CCI (CciPeriod)**: измеряет отклонение цены от средней. Порог `±CciLevel` задаёт силу сигнала.
- **Stochastic (StochasticKPeriod / DPeriod / Smooth)**: анализирует линию %K относительно нейтрального уровня 50. Допуск задаётся параметром `StochasticLevel`.

Все индикаторы обновляются только на завершённых свечах выбранного типа `CandleType`, что обеспечивает стабильность в тестах и в реальной торговле.

## Логика торговли

### Условия для покупки

1. Закрытие предыдущей свечи выше предыдущего значения EMA.
2. Предыдущее значение CCI ниже `-CciLevel` — признак перепроданности.
3. Предыдущее значение Stochastic %K ниже `50 - StochasticLevel`.
4. При выполнении условий закрываются короткие позиции и открывается новая длинная, если количество позиций меньше `MaxOrders`.

### Условия для продажи

1. Закрытие предыдущей свечи ниже предыдущего значения EMA.
2. Предыдущее значение CCI выше `+CciLevel` — признак перекупленности.
3. Предыдущее значение Stochastic %K выше `50 + StochasticLevel`.
4. При выполнении условий закрываются длинные позиции и открывается новая короткая при соблюдении лимита `MaxOrders`.

### Управление выходом

- **Stop Loss / Take Profit**: задаются в пунктах. При положительных значениях активируется встроенная защита позиций StockSharp.
- **Обратный сигнал**: перед входом в противоположную сторону текущая позиция закрывается, что повторяет поведение MQL-версии.

## Управление объёмом

- **OrderVolume**: базовый фиксированный объём, соответствующий параметру `Lots`.
- **RiskPercentage**: при значении больше нуля объём рассчитывается как доля от стоимости портфеля с учётом маржинальных требований инструмента либо его цены, что воспроизводит режим `Lots == 0` в MQL.
- **MaxOrders**: ограничивает совокупный объём в одном направлении величиной `MaxOrders * OrderVolume`.

## Параметры

| Параметр | Описание |
|----------|----------|
| `OrderVolume` | Базовый объём ордера при фиксированном лоте. |
| `MaPeriod` | Период EMA по взвешенной цене закрытия. |
| `CciPeriod` | Количество баров в расчёте CCI. |
| `CciLevel` | Абсолютный порог CCI для генерации сигналов. |
| `StochasticKPeriod` | Период расчёта линии %K. |
| `StochasticDPeriod` | Период сглаживания линии %D. |
| `StochasticSmooth` | Дополнительное сглаживание %K. |
| `StochasticLevel` | Отклонение от 50 для определения зон перекупленности/перепроданности. |
| `MaxOrders` | Максимальное число одновременных позиций в одном направлении. |
| `StopLossPoints` | Расстояние стоп-лосса в пунктах. |
| `TakeProfitPoints` | Расстояние тейк-профита в пунктах. |
| `RiskPercentage` | Процент капитала для динамического расчёта объёма. |
| `CandleType` | Тип свечей, используемый в расчётах. |

## Практические рекомендации

- Стратегия показывает наибольшую эффективность на внутридневных данных с выраженными колебаниями.
- Взвешенное закрытие делает EMA чувствительной и одновременно учитывает диапазон свечи.
- Использование предыдущих значений индикаторов исключает перерисовку и делает результаты тестов детерминированными.
- Следите за соответствием `OrderVolume` и `MaxOrders` спецификациям брокера, чтобы рассчитанный объём мог быть исполнен на счёте.
