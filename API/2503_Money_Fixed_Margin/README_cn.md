# 固定保证金资金管理策略
[English](README.md) | [Русский](README_ru.md)

该策略将 MetaTrader 中的 “Money Fixed Margin” 示例移植到 StockSharp 高级 API。它演示如何按照账户权益的固定百分比来确定持仓手数，并把以点数表示的止损距离换算成绝对价格偏移。策略仅做多，重点在于阐释资金管理流程，而不是预测买卖信号。

## 细节

- **入场条件**：
  - **做多**：每当已完成的K线数量达到 `Check Interval`（默认每 980 根K线）时，按市价买入。止损计算以触发K线的收盘价为基准。
- **多空方向**：仅做多。
- **离场条件**：
  - 通过 `StartProtection` 自动附加止损，距离来源于 `Stop Loss (pips)` 参数。
  - 不设置止盈；仓位仅由止损或人工干预退出。
- **止损类型**：只有止损。
- **默认参数**：
  - `Stop Loss (pips)` = 25
  - `Risk Percent` = 10
  - `Check Interval` = 980
  - `Candle Type` = 1 分钟周期
- **筛选标签**：
  - 类别：风险管理
  - 方向：多头
  - 指标：无
  - 止损：是（止损单）
  - 复杂度：基础
  - 周期：日内（可通过 `Candle Type` 配置）
  - 季节性：否
  - 神经网络：否
  - 背离：否
  - 风险等级：中等（取决于 `Risk Percent`）

## 仓位计算逻辑

1. 读取 `Security.PriceStep` 与 `Security.Decimals` 来判断点值。对于 3 或 5 位小数的品种，乘以 10 以匹配 MetaTrader 对点的定义。
2. 将 `Stop Loss (pips)` 与点值相乘得到绝对止损距离 (`ExtStopLoss`)，与 MQL5 代码保持一致。
3. 使用 `Portfolio.CurrentValue`（若不可用则使用 `Portfolio.BeginValue`）乘以 `Risk Percent / 100` 计算每笔交易的风险金额。
4. 通过止损距离、对应的价格步数以及 `Security.StepPrice`（若可用）求出 1 手的风险金额；若缺少 `StepPrice` 则退化为直接使用价格距离。
5. 用风险金额除以单手风险得到目标手数，再根据 `VolumeStep` 进行归一化，并限制在最小/最大手数之间，同时写入日志。另会记录在无止损情况下的计算结果，以说明没有保护性止损时资金管理会拒绝交易。

## 工作流程

1. 启动时订阅设定的K线序列，计算点值，并使用绝对止损距离调用 `StartProtection`。
2. 每根收盘的K线都会累加内部计数器；当计数达到 `Check Interval` 时，策略计算仓位规模、输出诊断信息并重置计数器。
3. 若得到的手数大于零，则按市价买入。保护机制会把止损放在 `Close - ExtStopLoss`。若出现价格为零或缺少元数据等问题，则不会下单。
4. 随后策略等待下一轮计数周期，强调资金管理而非信号频率。

## 使用提示

- 连接真实账户时请将 `Risk Percent` 调整到保守水平；默认的 10% 仅用于复现原始示例，实际交易中风险较高。
- 请确认标的提供有效的 `PriceStep` 和 `StepPrice`。若缺失这些信息，策略会以价格单位估算风险，精度会降低。
- 策略故意不做空，以保持与原示例一致；如需双向交易，可自行扩展 `BuyMarket` / `SellMarket` 调用。
- 资金管理逻辑可以复用：将策略代码中的仓位计算方法集成到其他信号模块即可。
