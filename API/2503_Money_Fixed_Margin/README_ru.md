# Стратегия Money Fixed Margin
[English](README.md) | [中文](README_cn.md)

Стратегия переносит пример MetaTrader «Money Fixed Margin» на высокоуровневый API StockSharp. Она показывает, как рассчитывать объём позиции, рискуя фиксированным процентом от портфеля и переводя стоп-лосс, заданный в пунктах, в абсолютное ценовое смещение. Сделки открываются только в лонг; цель примера — продемонстрировать работу мани-менеджмента, а не генерацию торгового сигнала.

## Детали

- **Условия входа**:
  - **Лонг**: рыночная покупка выполняется каждый раз, когда количество завершённых свечей достигает значения параметра `Check Interval` (по умолчанию каждая 980-я свеча). Для расчёта риска используется цена закрытия свечи, инициировавшей сделку.
- **Направление**: только покупки.
- **Условия выхода**:
  - Защитный стоп-лосс автоматически выставляется через `StartProtection` на расстоянии, вычисленном из параметра `Stop Loss (pips)`.
  - Тейк-профит не используется; позиция закрывается по стоп-лоссу или вручную.
- **Стоп-приказы**: только стоп-лосс.
- **Параметры по умолчанию**:
  - `Stop Loss (pips)` = 25
  - `Risk Percent` = 10
  - `Check Interval` = 980
  - `Candle Type` = таймфрейм 1 минута
- **Фильтры**:
  - Категория: Управление рисками
  - Направление: Лонг
  - Индикаторы: Нет
  - Стопы: Да (стоп-лосс)
  - Сложность: Базовая
  - Таймфрейм: Внутридневной (настраивается через `Candle Type`)
  - Сезонность: Нет
  - Нейросети: Нет
  - Дивергенция: Нет
  - Уровень риска: Средний (зависит от `Risk Percent`)

## Логика расчёта позиции

1. Стратегия считывает `Security.PriceStep` и `Security.Decimals`, чтобы определить размер пункта. Для инструментов с 3 или 5 знаками после запятой применяется множитель 10, как в MetaTrader.
2. Значение `Stop Loss (pips)` умножается на размер пункта, формируя абсолютное смещение (`ExtStopLoss`) — аналогично коду MQL5.
3. Текущая стоимость портфеля (`Portfolio.CurrentValue`, либо `Portfolio.BeginValue`, если текущая недоступна) умножается на `Risk Percent / 100`, что задаёт сумму риска на сделку.
4. Риск на один лот вычисляется через произведение расстояния до стопа, количества ценовых шагов в этом расстоянии и `Security.StepPrice` (если значение известно). При отсутствии `StepPrice` используется само ценовое смещение.
5. Деление величины риска на риск одного лота даёт требуемый объём. Результат нормируется по `VolumeStep`, ограничивается минимумом и максимумом инструмента, и выводится в лог. Дополнительно вычисляется объём при нулевом стопе — это подчёркивает, почему менеджер денег отвергает сделки без защитного ордера.

## Последовательность работы

1. При старте стратегия подписывается на выбранную серию свечей, рассчитывает размер пункта и активирует `StartProtection` с найденным абсолютным стоп-лоссом.
2. Каждая завершённая свеча увеличивает внутренний счётчик. Когда счётчик достигает `Check Interval`, стратегия вычисляет объём, пишет диагностические сообщения и обнуляет счётчик.
3. Если рассчитанный объём положителен, отправляется рыночная покупка. Защита автоматически прикрепляет стоп-лосс на уровне `Close - ExtStopLoss`. Ошибки (например, нулевая цена или отсутствие метаданных) отменяют размещение заявки.
4. Далее стратегия ждёт следующего полного интервала свечей, что позволяет сосредоточиться на демонстрации управления риском, а не частоте сигналов.

## Замечания по использованию

- При работе с реальным счётом выбирайте консервативное значение `Risk Percent`. Значение 10% соответствует примеру MQL, но считается агрессивным.
- Убедитесь, что инструмент предоставляет осмысленные `PriceStep` и `StepPrice`. Если данные недоступны, расчёт риска выполняется в ценовых единицах, что снижает точность.
- Стратегия сознательно не использует шорты, чтобы соответствовать исходному примеру. При необходимости можно дополнить логику короткими сделками.
- Модуль управления капиталом легко повторно использовать: перенесите метод расчёта объёма из кода стратегии в собственные торговые системы.
