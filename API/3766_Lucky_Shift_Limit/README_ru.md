# Стратегия Lucky Shift Limit
[English](README.md) | [中文](README_cn.md)

**Lucky Shift Limit** — это точная конверсия эксперта MetaTrader 4 `Lucky_acnl6p6j89zn91fa.mq4`. Стратегия отслеживает лучшие цены Bid и Ask в режиме реального времени и реагирует на резкие скачки, измеряемые в метатрейдеровских пунктах. Если Ask ускоряется вверх на заданное расстояние, открывается продажа против движения; если Bid резко падает, выполняется покупка. Каждая позиция контролируется по прибыли и убытку: сделки закрываются либо при появлении положительного результата, либо при достижении допустимого просадочного лимита — точь‑в‑точь как в MQ4.

## Требования к данным и исполнению

- **Рыночные данные** — необходима только лента Level 1 (лучшие Bid/Ask); свечи и стакан не используются.
- **Тип исполнения** — все входы и выходы выполняются рыночными заявками, имитируя моментальные `OrderSend`/`OrderClose` из MetaTrader.
- **Режим счёта** — подходит для хеджевого и неттингового учёта. В неттинге экспозиция накапливается в одной позиции, а модуль выхода полностью её закрывает.
- **Размер лота** — базовый объём берётся из `Strategy.Volume`, но при наличии данных по портфелю повторяет формулу `AccountFreeMargin/10000`, используемую в исходном советнике.

## Параметры

| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `Shift points` | 3 | Минимальное количество пунктов между соседними котировками, при котором формируется новая сделка. Большое значение фильтрует шум, малое делает стратегию чувствительнее. |
| `Limit points` | 18 | Максимальная допустимая просадка позиции. Если цена уходит против сделки больше чем на указанное число пунктов, позиция принудительно закрывается. |

Оба параметра задаются в пунктах MetaTrader и внутри стратегии переводятся в абсолютные ценовые смещения согласно шагу цены инструмента. Диапазоны оптимизации соответствуют практическим значениям оригинального эксперта.

## Логика торговли

1. **Инициализация**
   - Переводит параметры в ценовые смещения, используя `Security.PriceStep`.
   - Сбрасывает кеш предыдущих котировок и запускает подписку Level 1 через высокоуровневый метод `Bind`.
2. **Условия входа**
   - Если Ask вырос как минимум на `Shift points` по сравнению с предыдущим значением, отправляется рыночная продажа (fade-логика) с логированием причины.
   - Если Bid упал на такую же величину, стратегия покупает рынком.
   - Сигналы могут срабатывать последовательно, как и в MQ4, где не было ограничения на количество одновременных позиций.
3. **Выход из позиции**
   - На каждом тиковом обновлении вызывается `TryClosePosition()`. Длинные позиции закрываются, когда Bid становится выше средней цены входа (фиксируется прибыль), либо когда Ask уходит ниже входа на `Limit points` (ограничение убытка).
   - Короткие позиции зеркально закрываются по прибыльным значениям Ask или при превышении лимита убытка по Bid.
   - Все выходы осуществляются рыночными заявками, что гарантирует закрытие позиции на том же тике.
4. **Расчёт объёма**
   - При наличии оценки капитала портфеля объём рассчитывается как `equity / 10000`, округлённый до десятых лота — полностью повторяя функцию `GetLots()` из MetaTrader.
   - Если данные об капитале недоступны, используется значение `Strategy.Volume`.

## Особенности реализации

- Используется только высокоуровневый API StockSharp: `SubscribeLevel1().Bind(ProcessLevel1)` избавляет от ручной обработки котировок.
- Внутри не создаются коллекции; предыдущие значения Bid/Ask хранятся в nullable-переменных, что соответствует требованиям из AGENTS.md.
- Просадочный лимит учитывает шаг цены инструмента, поэтому корректно работает с пятизнаками и дробными тиками.
- При изменении параметров во время работы пороги пересчитываются по новым значениям.
- Подробные сообщения в логах помогают анализировать каждую сделку в тестировании и реальной торговле.

## Рекомендации по использованию

- Наилучшие результаты достигаются на ликвидных валютных парах и индексах с частыми всплесками спреда.
- При необходимости расширяйте защиту портфеля (например, через `StartProtection`), чтобы добавить стоп-лосс или ограничения по просадке.
- Увеличивайте `Shift points`, если поток котировок слишком шумный, или уменьшайте его для сверхкоротких реакций.
- Стратегия по своей природе контртрендовая; для работы по пробоям комбинируйте её с фильтрами или повышайте минимальное смещение.
