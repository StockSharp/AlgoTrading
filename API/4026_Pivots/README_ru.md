# 4026 – Стратегия Pivots

## Обзор

Стратегия переносит файлы MetaTrader 4 из каталога `MQL/8550` (индикатор **Pivots** и эксперта `Pivots_test`) в высокоуровневый API `Strategy` платформы StockSharp. Реализовано исходное поведение: вычисление дневных уровней классических пивотов, поддержание пары противоположных отложенных заявок на центральном уровне и сопровождение каждой позиции фиксированными стоп- и тейк-профитами с трейлинг-стопом.

## Расчёт пивотов

1. Стратегия подписывается на настраиваемый таймфрейм (`PivotCandleType`, по умолчанию дневные свечи).
2. После завершения свечи рассчитываются уровни по формулам классических floor-pivot:
   - `Pivot = (High + Low + Close) / 3`
   - `R1 = 2 × Pivot − Low`
   - `S1 = 2 × Pivot − High`
   - `R2 = Pivot + (High − Low)`, `S2 = Pivot − (High − Low)`
   - `R3 = 2 × Pivot + High − 2 × Low`, `S3 = 2 × Pivot − (2 × High − Low)`
3. Новые уровни активируются с открытия следующей торговой сессии. В этот момент значения выводятся в лог через `AddInfoLog` (пример: `Pivot levels for 2024-04-05: P=1.0924, R1=1.0956, …`).

## Работа с отложенными заявками

После активации уровней стратегия гарантирует присутствие двух заявок на цене Pivot:

- **Buy Limit** по цене `Pivot` с защитой `SellStop` на `S2` (стоп-лосс) и `SellLimit` на `R2` (тейк-профит).
- **Sell Stop** по цене `Pivot` с защитой `BuyStop` на `R2` и `BuyLimit` на `S2`.

Регистрация ведётся только через высокоуровневые методы `BuyLimit`, `SellStop`, `SellLimit`, `BuyStop`. При исполнении заявки пересчитывается средняя цена входа по направлению, отменяются старые защитные ордера и выставляется новая пара стоп/тейк на весь текущий объём – полностью повторяя логику MetaTrader, где каждая позиция использует уровни S2/R2. При срабатывании стопа или тейка вспомогательные ордера очищаются автоматически.

StockSharp работает с нетто-позицией, поэтому встречные сделки взаимоудаляются (в MT4 с хеджингом тикеты существовали отдельно). Это единственное осознанное отличие от оригинального эксперта.

## Трейлинг-стоп

- Параметр `TrailingStopPoints` задаёт расстояние в пунктах (умножается на `PriceStep`).
- Для лонга трейлинг активируется, когда цена ушла выше средней входной цены больше чем на указанное расстояние, после чего `SellStop` подтягивается ближе к рынку.
- Для шорта выполняется зеркальная логика с `BuyStop`.
- Обновления трейлинга происходят на основе внутридневного таймфрейма `CandleType` (по умолчанию 15-минутные свечи).

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `OrderVolume` | Объём каждой отложенной заявки (лоты/контракты). | `0.1` |
| `TrailingStopPoints` | Размер трейлинг-стопа в пунктах (`0` отключает механизм). | `30` |
| `CandleType` | Внутридневные свечи для трейлинга и контроля сессии. | Таймфрейм 15 минут |
| `PivotCandleType` | Таймфрейм для расчёта пивотов. | Таймфрейм 1 день |
| `LogPivotUpdates` | Логировать ли обновления уровней. | `true` |

Все числовые настройки созданы через `StrategyParam<T>`, поэтому их можно оптимизировать средствами StockSharp.

## Логи и диагностика

- Обновления уровней выводятся методом `AddInfoLog`, заменяя комментарии и подписи MT4.
- Управление позициями и ордерами реализовано исключительно высокоуровневыми вызовами без прямой работы с буферами или низкоуровневой регистрацией заявок.

## Использование

1. Подключите стратегию к источнику данных, предоставляющему дневные и внутридневные свечи по инструменту.
2. При необходимости уточните шаг цены инструмента (`PriceStep` определяется автоматически, резервное значение – `0.0001`).
3. Настройте `OrderVolume`, `TrailingStopPoints` и типы свечей в соответствии с исходной конфигурацией MT4.

По запросу Python-версия не создавалась.
