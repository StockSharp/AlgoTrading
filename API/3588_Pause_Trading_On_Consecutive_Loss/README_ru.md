# Стратегия «Пауза после серии убытков»

**Стратегия «Пауза после серии убытков»** переносит на StockSharp логику советника MetaTrader 4 *Pause Trading On Consecutive Loss*. Исходный код анализировал историю сделок, находил последнюю последовательность убыточных ордеров и блокировал открытие новых позиций, если серия достигала заданной длины за ограниченный промежуток времени. В порте сохранён тот же принцип, но вокруг него построена минимальная модель входа по импульсу, чтобы механизм паузы можно было тестировать отдельно от других систем.

## Алгоритм работы

1. Стратегия подписывается на свечи типа `CandleType`. Для каждой завершённой свечи закрытие сравнивается с предыдущим закрытием: рост провоцирует покупку, падение — продажу. Если у бычьей позиции появляется свеча с закрытием ниже открытия, она закрывается; для короткой позиции действует зеркальное правило.
2. После полного закрытия позиции анализируется реализованный результат (`PnLManager.RealizedPnL`). Отрицательные значения добавляют время закрытия в очередь FIFO, хранящую только последовательные убытки. Положительные или нулевые результаты очищают очередь — аналогично тому, как MQL-версия прекращала просмотр истории при первом неубыточном ордере.
3. Когда длина очереди достигает `ConsecutiveLosses`, вычисляется разница между самой ранней и самой поздней убыточной сделкой. Если она не превышает `WithinMinutes`, стратегия ставит торговлю на паузу на `PauseMinutes` минут, отсчитывая их от времени последнего закрытия. Во время паузы новые заявки не отправляются, но существующие позиции могут закрываться по обычным правилам.
4. После истечения паузы очередь сбрасывается, и торговля автоматически возобновляется. Таким образом воспроизводится поведение функций `CheckLastNLossDifference` и `lastOrderCloseTime` без повторного обхода всей истории ордеров.

Стратегия использует высокоуровневую подписку на свечи (`SubscribeCandles`) и встроенный менеджер прибыли StockSharp для отслеживания реализованного результата. Очередь `Queue<DateTimeOffset>` хранит временные метки серии убытков, что позволяет обойтись без ручного опроса истории сделок.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|------------------------|----------|
| `CandleType` | Свечи с периодом 5 минут | Тип и таймфрейм свечей, на которых формируется импульсный сигнал. |
| `OrderVolume` | `0.1` | Объём заявки для входа и выхода из позиции. |
| `ConsecutiveLosses` | `3` | Число последовательных убытков, необходимое для запуска паузы. |
| `WithinMinutes` | `20` | Максимальное количество минут между первой и последней убыточной сделкой в серии (0 — отключить проверку). |
| `PauseMinutes` | `20` | Длительность паузы после срабатывания фильтра. |

## Дополнительные детали

- Очередь пополняется только тогда, когда стратегия полностью выходит из позиции с отрицательным результатом. Частичные фиксации и прибыльные сделки не продлевают серию и не вызывают ложных срабатываний.
- Проверка на окончание паузы выполняется при обработке каждой завершённой свечи. Если `PauseMinutes` истекли в период простоя, следующая свеча моментально разблокирует торговлю.
- В варианте StockSharp используется неттинговая позиция, поэтому величина реализованной прибыли берётся как прирост `PnLManager.RealizedPnL`. Это повторяет логику MQL без многократного обращения к истории ордеров.
