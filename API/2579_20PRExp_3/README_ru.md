# Стратегия 20PRExp-3
[English](README.md) | [中文](README_cn.md)

Стратегия 20PRExp-3 — это пробойная система, которая сравнивает текущую сессию с экстремумами текущего дня и следит за расширением объёма. Канал строится по завершённым пятиминутным свечам, фильтрация выполняется по отношению объёма на 30-минутном таймфрейме, а входы осуществляются только при выходе цены за обновлённые границы диапазона. После открытия позиции алгоритм повторяет оригинального советника MetaTrader 5: контролирует Parabolic SAR, подтягивает стоп в соответствии с прогрессом и рассчитывает объём исходя из заданного риска.

## Идея
- **Дневной канал**: на каждом баре сохраняются максимум, минимум и середина текущего торгового дня.
- **Подтверждение пробоя**: новая позиция открывается только если закрытие свечи находится за пределами канала и ширина диапазона превышает `GapPoints * PriceStep`.
- **Расширение объёма**: сравниваются два последних завершённых 30-минутных бара, требуется увеличение тикового объёма минимум в 1.5 раза.
- **Временной фильтр**: новые сделки разрешены только после указанного часа (`SessionStartHour`), чтобы избежать ночных ложных движений.
- **Симметрия риска**: для лонга стоп — дневной минимум, для шорта — дневной максимум. Тейк и трал измеряются в ценовых пунктах.

## Используемые данные
- Пятиминутные свечи для расчёта сигналов и индикатора Parabolic SAR.
- Тридцатиминутные свечи для оценки отношения тикового объёма.
- Статистика дневного диапазона вычисляется динамически, отдельная подписка на дневные свечи не нужна.

## Правила входа
1. Дождаться завершённой пятиминутной свечи после разрешённого часа.
2. Обновить максимум, минимум, середину и ширину текущего дня.
3. Проверить, что ширина диапазона превышает `GapPoints * PriceStep`.
4. Рассчитать отношение объёмов = последний завершённый 30-минутный объём / предыдущий 30-минутный объём и убедиться, что оно больше 1.5.
5. **Лонг**: закрытие свечи находится на уровне или выше текущего дневного максимума → открыть покупку.
6. **Шорт**: закрытие свечи находится на уровне или ниже текущего дневного минимума → открыть продажу.
7. Пока позиция активна, новых входов нет (одна позиция одновременно).

## Управление позицией
- **Начальный стоп**: для покупок — дневной минимум, для продаж — дневной максимум, зафиксированные в момент входа.
- **Тейк-профит**: опционально, на расстоянии `TakeProfitPoints * PriceStep` от цены входа.
- **Разворот Parabolic SAR**: закрывает позицию, если значение SAR пересекает закрытие предыдущей свечи (как в MQL-советнике).
- **Трейлинг-стоп**: активируется, когда прибыль превышает `TrailingStopPoints * PriceStep` и переносится только при дополнительном прогрессе не менее `TrailingStepPoints * PriceStep`.
- **Зеркальный тейк**: при переносе трейлинг-стопа тейк-профит перемещается симметрично относительно текущего закрытия.

## Управление риском
- Объём рассчитывается из `RiskPercent`: берётся доля текущей стоимости портфеля и делится на расстояние до стоп-уровня.
- Если стоимость портфеля недоступна, используется `Volume + |Position|`, при необходимости стратегия торгует минимальным объёмом в 1 контракт.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|------------------------|----------|
| `CandleType` | Пятиминутные свечи | Основной таймфрейм для сигналов и Parabolic SAR. |
| `VolumeCandleType` | Тридцатиминутные свечи | Таймфрейм для оценки расширения тикового объёма. |
| `TakeProfitPoints` | 20 | Дистанция до тейк-профита в пунктах. 0 — отключить тейк. |
| `TrailingStopPoints` | 10 | Дистанция в пунктах для активации трейлинг-стопа. |
| `TrailingStepPoints` | 10 | Минимальное дополнительное движение (в пунктах) перед переносом трейлинг-стопа. |
| `RiskPercent` | 5 | Процент от капитала, который допускается потерять в одной сделке. |
| `GapPoints` | 50 | Минимальная ширина дневного диапазона, разрешающая пробой. |
| `SessionStartHour` | 7 | Час (0–23), после которого разрешено открывать новые позиции. |

## Дополнения
- Параметры Parabolic SAR (шаг 0.005, максимум 0.01) совпадают с исходным MQL-советником.
- Значение средней линии сохраняется для визуализации, при необходимости его можно вывести на график.
- Фильтр объёма использует только завершённые 30-минутные бары, что обеспечивает стабильность как в реальной торговле, так и в тестах.
- Все комментарии в коде оставлены на английском языке согласно требованиям репозитория.
