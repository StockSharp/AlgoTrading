# 20PRExp-3 突破策略
[English](README.md) | [Русский](README_ru.md)

20PRExp-3 是一个基于日内通道的突破策略。它在每根完成的 5 分钟K线上重新计算当日的最高价、最低价与中线，并利用 30 分钟周期的成交量放大来确认动能。只有当价格有效突破最新通道边界时才会开仓。进场后策略继续跟踪 Parabolic SAR、动态跟踪止损以及基于风险百分比的仓位管理，与原始的 MetaTrader 5 EA 保持一致。

## 思路概述
- **日内通道**：持续维护当日的最高、最低及中间价位。
- **突破确认**：仅当收盘价位于通道外侧且日内振幅超过 `GapPoints * PriceStep` 时考虑进场。
- **成交量过滤**：比较最近两根完成的 30 分钟K线的tick成交量，必须放大到至少 1.5 倍。
- **时间过滤**：`SessionStartHour` 之前不允许开新仓，以规避夜间低流动性波动。
- **风险对称**：多头止损设置在当日低点，空头止损设置在当日高点。止盈与追踪止损的距离均以价格点数衡量。

## 所需数据
- 5 分钟K线：用于生成交易信号并计算 Parabolic SAR。
- 30 分钟K线：用于成交量放大过滤。
- 日内高低点通过 5 分钟数据实时计算，无需单独订阅日线。

## 入场规则
1. 等待一根完成的 5 分钟K线且当前时间已经过启动小时。
2. 更新当日高点、低点、中线以及通道宽度。
3. 检查通道宽度是否大于 `GapPoints * PriceStep`。
4. 计算成交量比例 = 最近完成的 30 分钟成交量 / 前一根 30 分钟成交量，要求大于 1.5。
5. **做多**：收盘价位于或高于当前日高 → 开多仓。
6. **做空**：收盘价位于或低于当前日低 → 开空仓。
7. 同一时间只允许一笔持仓，已有持仓时不再开新仓。

## 仓位管理
- **初始止损**：多头使用日内低点，空头使用日内高点（在进场时锁定）。
- **止盈**：可选，距离为 `TakeProfitPoints * PriceStep`。
- **Parabolic SAR 反转**：当 SAR 穿越上一根K线的收盘价时立即平仓。
- **追踪止损**：在浮盈超过 `TrailingStopPoints * PriceStep` 后启动，仅当价格进一步前进 `TrailingStepPoints * PriceStep` 时才上移。
- **镜像式止盈**：每次上移追踪止损时，同时将止盈调整到距离当前收盘价相同的另一侧。

## 风险控制
- 通过 `RiskPercent` 根据账户当前权益和止损距离计算下单量。
- 如无法获得账户权益，则退化为使用 `Volume + |Position|`，若仍不可用则最少交易 1 手。

## 参数说明
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `CandleType` | 5 分钟K线 | 信号与 Parabolic SAR 的主时间框架。 |
| `VolumeCandleType` | 30 分钟K线 | 用于成交量过滤的时间框架。 |
| `TakeProfitPoints` | 20 | 止盈距离（点）。设为 0 可关闭止盈。 |
| `TrailingStopPoints` | 10 | 启动追踪止损所需的点数。 |
| `TrailingStepPoints` | 10 | 再次上调追踪止损所需的额外点数。 |
| `RiskPercent` | 5 | 每笔交易可承受的权益百分比损失。 |
| `GapPoints` | 50 | 开启突破交易所需的最小日内通道宽度。 |
| `SessionStartHour` | 7 | 允许开仓的最早小时（0–23）。 |

## 额外说明
- Parabolic SAR 的加速因子（0.005）与最大值（0.01）保持与原EA一致。
- 计算中的日内中线可用于图表展示，帮助观察价格在通道中的位置。
- 成交量过滤依赖已完成的 30 分钟数据，因此在回测和实时环境中都具有稳定性。
- 代码内的注释均使用英文，符合仓库规范。
