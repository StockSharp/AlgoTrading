# Стратегия Vortex Indicator Duplex

Стратегия является переносом советника **Exp_VortexIndicator_Duplex** из MetaTrader в высокоуровневый API StockSharp. Логика разделена на два независимых потока индикатора Vortex: один отвечает за длинные сделки, второй — за короткие. Для каждого потока задаётся собственный таймфрейм, период индикатора и смещение по закрытым свечам, поэтому поведение покупок и продаж можно настраивать отдельно.

## Принцип работы

1. Открываются две подписки на свечи в соответствии с параметрами `LongCandleType` и `ShortCandleType`. Каждая подписка обновляет свой экземпляр `VortexIndicator`.
2. После закрытия каждой свечи сохраняются значения VI+ и VI-. Параметры `LongSignalBar` и `ShortSignalBar` определяют, какую закрытую свечу использовать для расчёта сигнала, что полностью повторяет вход `SignalBar` в MetaTrader.
3. **Вход в покупку** (`AllowLongEntries = true`): подаётся рыночная заявка, если текущий VI+ длинного потока выше VI-, а на предыдущем отсчёте VI+ был меньше или равен VI-. При наличии короткой позиции она закрывается перед открытием новой длинной.
4. **Выход из покупки** (`AllowLongExits = true`): позиция закрывается, когда VI- длинного потока поднимается выше VI+. Дополнительно контролируются защитные расстояния `LongStopLossSteps` и `LongTakeProfitSteps` (в шагах цены). Достижение любого из уровней приводит к закрытию позиции.
5. **Вход в продажу** (`AllowShortEntries = true`): выполняется, когда VI+ короткого потока опускается ниже VI- после того, как ранее находился выше. Текущая длинная позиция при этом закрывается.
6. **Выход из продажи** (`AllowShortExits = true`): короткая позиция закрывается, когда VI+ снова становится выше VI-. Также учитываются защитные расстояния `ShortStopLossSteps` и `ShortTakeProfitSteps`.
7. Объём сделок задаётся параметром `TradeVolume`. Для перевода шагов цены в абсолютное расстояние используется `Security.PriceStep`. Нулевое значение любого защитного параметра отключает соответствующее правило.

Проверка стопов и тейк-профитов выполняется на каждой закрытой свече обоих таймфреймов. При отсутствии позиции внутренние данные о точке входа очищаются, как и в оригинальном советнике.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `LongCandleType` | H4 | Таймфрейм для расчёта длинного Vortex. |
| `ShortCandleType` | H4 | Таймфрейм для расчёта короткого Vortex. |
| `LongLength` | 14 | Период VI+ / VI- для длинного потока. |
| `ShortLength` | 14 | Период для короткого потока. |
| `LongSignalBar` | 1 | Смещение по закрытым свечам для длинного сигнала (0 — последняя закрытая свеча). |
| `ShortSignalBar` | 1 | Смещение по закрытым свечам для короткого сигнала. |
| `AllowLongEntries` | true | Разрешает открывать длинные позиции. |
| `AllowLongExits` | true | Разрешает закрывать длинные позиции. |
| `AllowShortEntries` | true | Разрешает открывать короткие позиции. |
| `AllowShortExits` | true | Разрешает закрывать короткие позиции. |
| `LongStopLossSteps` | 1000 | Стоп-лосс для длинных сделок в шагах цены. |
| `LongTakeProfitSteps` | 2000 | Тейк-профит для длинных сделок в шагах цены. |
| `ShortStopLossSteps` | 1000 | Стоп-лосс для коротких сделок в шагах цены. |
| `ShortTakeProfitSteps` | 2000 | Тейк-профит для коротких сделок в шагах цены. |
| `TradeVolume` | 1 | Базовый объём рыночных заявок. |

## Особенности запуска

- Перед открытием новой позиции стратегия закрывает противоположное плечо, что соответствует механизму «магических» номеров в MT5.
- Расстояния в шагах переводятся формулой `distance = steps * Security.PriceStep`. Если у инструмента не задан шаг цены, используется значение 1.
- Чтобы отключить конкретный защитный уровень, установите его значение равным нулю.
- Поскольку обе подписки могут инициировать защитные срабатывания, подбирайте `TradeVolume` с учётом ликвидности инструмента.
