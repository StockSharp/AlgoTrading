# Reverse Strategy

## 概述
**Reverse Strategy** 是对 KimIV 编写的 MetaTrader 4 脚本 `Reverse.mq4` 的 StockSharp 移植版本。原脚本用于“一键反手”：先平掉所
有持仓，然后立刻以相同手数开立反向仓位，同时可以附带止损和止盈。StockSharp 版本同样适用于连接的账户，方便手动交易
者或程序化流程在需要时快速反转当前敞口。

## 工作流程
1. 启动后策略会确定需要处理的持仓。默认情况下只针对 `Strategy.Security` 指定的标的，如果将 `CurrentSymbolOnly` 设置为
   `false`，则会遍历投资组合中的所有持仓。
2. 对于每个多头持仓，策略会发送两笔市价卖单：第一笔用于平仓，第二笔按相同数量建立新的空头。对于空头持仓同样发送两
   笔市价买单完成反手。
3. 若未启用 `MarketWatchMode`，在建立新仓位后策略会立即布置保护性订单。止损、止盈以点数表示，并通过合约的 `PriceStep`
   或 `MinStep` 转换为绝对价格，分别使用 `SellStop`/`BuyStop` 与 `SellLimit`/`BuyLimit` 实现。
4. 每笔市价单都包裹在可配置的重试循环内，以复现原脚本的容错逻辑。当出现异常时会记录日志并重新尝试，最多执行
   `RetryCount` 次。
5. 当所有选定的标的处理完毕后策略会自行停止，保护性订单会继续在交易系统中等待触发，与 MT4 中的脚本行为保持一致。

## 与 MQL 版本的差异
- StockSharp 会将同一标的的多笔交易聚合为一个仓位，因此反手操作针对的是净持仓，而不是逐一处理每张单据。最终结果与
  按原脚本逐单反手相同。
- 由于 StockSharp 的市价单无法直接附加止损/止盈，保护性订单以独立委托的形式提交，相当于原脚本中 `OrderSend` 之后的
  `ModifyOrder` 操作。
- `SlippagePoints` 参数仅为兼容性保留，目前只作为日志/界面中的参考值，实际成交价格由连接器决定。
- `MarketWatchMode` 还原了部分经纪商禁止在市价单中附加保护性价格的限制；启用后策略不会自动下达止损和止盈。
- `RetryCount` 对应原脚本的 `NumberOfTry`，每次重试都会直接再次调用高层 API，由连接器决定是否接受订单。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `StopLossPips` | `30` | 距离开仓价的止损点数，填 `0` 表示不使用止损。 |
| `TakeProfitPips` | `50` | 距离开仓价的止盈点数，填 `0` 表示不设置止盈。 |
| `CurrentSymbolOnly` | `true` | `true` 时仅处理策略标的，`false` 时遍历整个投资组合。 |
| `MarketWatchMode` | `false` | 不自动下达保护性订单，适用于需要手动设置止损/止盈的经纪商。 |
| `SlippagePoints` | `3` | 仅用于显示预计滑点的保留参数。 |
| `RetryCount` | `3` | 当下单抛出异常时允许的最大重试次数。 |

## 使用建议
- 请确认策略关联的投资组合和标的与实际持仓使用同一连接器，否则无法找到需要反手的仓位。
- 只有在存在持仓时才需要运行策略；没有仓位时策略会立即退出而不执行任何操作。
- 如果标的没有配置 `PriceStep` 或 `MinStep`，将无法计算止损和止盈的绝对价格，即便点数为正也会跳过保护性订单。
- 保护性委托以反手后的全部仓位数量提交，如需调整仓位请手动修改或撤销这些订单。

## 关联文件
- 原始脚本：[`MQL/8756/Reverse.mq4`](../../MQL/8756/Reverse.mq4)
- C# 策略实现：[`CS/ReverseStrategy.cs`](CS/ReverseStrategy.cs)
