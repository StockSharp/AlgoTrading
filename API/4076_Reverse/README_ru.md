# Reverse Strategy

## Обзор
**Reverse Strategy** — это порт на StockSharp утилиты MetaTrader 4 `Reverse.mq4`, написанной KimIV. Оригинальный скрипт служил
«кнопкой» реверса: он закрывал все текущие сделки и тут же открывал новую позицию в противоположную сторону, сохраняя объём и
опциональные уровни стоп-лосса/тейк-профита. Версия для StockSharp позволяет выполнить такую же «перевёртку» портфеля для
подключённого счёта, что удобно для ручной торговли и для алгоритмов, которым нужно быстро инвертировать текущую экспозицию.

## Логика работы
1. При запуске стратегия определяет, какие позиции следует обработать. По умолчанию она работает только с инструментом,
   указанным в `Strategy.Security`, но параметр `CurrentSymbolOnly = false` заставляет её пройтись по всему портфелю.
2. Для каждого лонга отправляются две рыночные заявки на продажу: первая закрывает текущий объём, а вторая открывает новый шорт
   такого же размера. Для шортов выполняется зеркальная последовательность из двух рыночных покупок.
3. Если `MarketWatchMode` выключен, сразу после открытия новой позиции стратегия размещает защитные заявки. Стоп-лосс и
   тейк-профит задаются в пунктах, переводятся в абсолютные цены через `PriceStep` или `MinStep` инструмента и оформляются как
   `SellStop`/`BuyStop` и `SellLimit`/`BuyLimit` соответственно.
4. Отправка каждой рыночной заявки обёрнута в цикл повторных попыток, который воспроизводит проверки оригинального скрипта.
   Исключения логируются, после чего заявка отправляется повторно, максимум `RetryCount` раз.
5. После обработки всех выбранных инструментов стратегия останавливает сама себя. Выставленные защитные заявки продолжают
   работать на сервере — полностью аналогично метатрейдеровской реализации.

## Отличия от версии MQL
- StockSharp агрегирует сделки по инструменту, поэтому реверс выполняется для совокупной позиции, а не по каждому тикету
  отдельно. Итоговый объём совпадает с последовательным закрытием/открытием всех ордеров из оригинального скрипта.
- Стоп-лосс и тейк-профит выставляются отдельными заявками, так как в StockSharp нельзя добавить их прямо в рыночный ордер.
  Это эквивалентно вызову `ModifyOrder` после `OrderSend` в исходном коде.
- Параметр `SlippagePoints` сохранён ради совместимости, но используется только как справочная величина. Фактическое проскальзывание
  определяется коннектором.
- `MarketWatchMode` повторяет ограничение брокеров, запрещающих указывать стопы внутри рыночной заявки: при включении защитные
  ордера не ставятся автоматически.
- `RetryCount` заменяет поле `NumberOfTry` — каждая попытка просто повторно вызывает высокоуровневый API StockSharp.

## Параметры
| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `StopLossPips` | `30` | Расстояние в пунктах от входа до стоп-лосса. `0` отключает защитный стоп. |
| `TakeProfitPips` | `50` | Расстояние в пунктах от входа до тейк-профита. `0` выключает целевую заявку. |
| `CurrentSymbolOnly` | `true` | При `true` реверс выполняется только для инструмента стратегии. При `false` обрабатываются все позиции портфеля. |
| `MarketWatchMode` | `false` | Не выставлять защитные ордера автоматически. Полезно для брокеров с режимом Market Watch. |
| `SlippagePoints` | `3` | Зарезервированный параметр для отображения ожидаемого проскальзывания. |
| `RetryCount` | `3` | Максимальное число попыток отправить рыночную заявку при возникновении исключения. |

## Рекомендации по использованию
- Убедитесь, что портфель и инструмент стратегии привязаны к тому же коннектору, где открыты позиции для реверса.
- Запускайте стратегию только при наличии открытых позиций — иначе она ничего не сделает и сразу завершится.
- Если для инструмента не настроен `PriceStep` или `MinStep`, вычислить защитные уровни невозможно и стопы/тейки будут
  пропущены даже при положительных значениях в пунктах.
- Защитные заявки выставляются на полный перевёрнутый объём. Если после реверса объём меняется, скорректируйте или отмените
  ордера вручную.

## Связанные файлы
- Оригинал: [`MQL/8756/Reverse.mq4`](../../MQL/8756/Reverse.mq4)
- Стратегия на C#: [`CS/ReverseStrategy.cs`](CS/ReverseStrategy.cs)
