# Стратегия Trailing Stop Manager

## Обзор
**Trailing Stop Manager** — это перенос MetaTrader-советника `Trailing Sl.mq5` на платформу StockSharp. Исходный эксперт не
открывал новые позиции самостоятельно, а отслеживал уже существующие сделки с нужным *magic number*, подтягивая уровень стоп-
лосса при движении цены в выгодную сторону. Вариант на C# реализован с использованием высокоуровневого API StockSharp и
предоставляет прозрачное управление трейлинг-стопом для любых инструментов, поддерживаемых платформой.

## Логика сопровождения
1. Подписывается на стакан, чтобы получать актуальные лучшие цены Bid и Ask.
2. Определяет текущее направление чистой позиции (лонг или шорт).
3. Считает плавающую прибыль по соответствующей стороне рынка (Bid для лонгов, Ask для шортов).
4. Активирует режим трейлинга, когда прибыль превышает значение `TriggerPoints` (переведённое в цену через `PriceStep`).
5. Выставляет трейлинг-стоп на расстоянии `TrailingPoints` от текущей котировки.
6. Двигает стоп только в сторону наращивания прибыли, блокируя возврат к худшим значениям.
7. При касании лучшей цены уровня трейлинг-стопа отправляет рыночную заявку для закрытия всей позиции.

## Управление ордерами и рисками
- Стратегия **не** создаёт входящие ордера, а лишь сопровождает уже открытую позицию (ручную или от другой системы).
- Закрытие выполняется через `BuyMarket`/`SellMarket`, что эквивалентно вызовам `PositionModify` в оригинальном коде MQL.
- Расстояние трейлинга автоматически масштабируется относительно `PriceStep`, сохраняя точечную настройку из MetaTrader.
- После полного закрытия позиции внутреннее состояние очищается и готово к работе с новой позицией.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `TrailingPoints` | `int` | `1000` | Дистанция от текущей цены до трейлинг-стопа в шагах цены. |
| `TriggerPoints` | `int` | `1500` | Минимальная плавающая прибыль в шагах цены, необходимая для включения трейлинга. |

## Рекомендации по использованию
- Подключите стратегию к инструменту, позицию по которому требуется сопровождать: сопровождение начнётся сразу после старта.
- Установите начальный объём `Volume`, соответствующий размеру текущей позиции. В режиме неттинга StockSharp закроет весь
  объём одной заявкой при срабатывании трейлинга.
- При крупном шаге цены увеличьте `TrailingPoints` и `TriggerPoints`, чтобы избежать преждевременных выходов.
- Все расчёты ведутся внутри StockSharp, поэтому стратегию легко комбинировать с любыми решениями, использующими StockSharp как
  движок исполнения.

## Отличия от оригинального эксперта MetaTrader
- В MetaTrader каждая сделка имеет собственный *magic number*; в StockSharp используется единая неттинговая позиция, поэтому
  фильтрация по билетам не требуется.
- Параметры `Setloss`, `TakeProfit` и `Lots` в исходнике не участвовали в логике и опущены в переносе, чтобы сфокусироваться на
  трейлинг-стопе.
- Вместо модификации ордеров применяются прямые рыночные выходы, что соответствует философии управления позициями в StockSharp.
