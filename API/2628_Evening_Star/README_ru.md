# Стратегия Evening Star

## Общее описание
Стратегия является прямой конверсией советника **EveningStar.mq5** (MQL5 id 18507). Алгоритм отслеживает классическую свечную модель "вечерняя звезда" и открывает сделку сразу после появления новой свечи. Вся логика переписана под высокоуровневый API StockSharp с сохранением исходных фильтров и управления рисками.

## Логика торговли
1. Подписка выполняется на таймфрейм, выбранный параметром `CandleType`. Обработка ведётся только по закрытым свечам.
2. После закрытия каждой свечи сохраняется локальное окно, чтобы можно было проанализировать три свечи согласно сдвигу `Shift`.
3. Модель считается сформированной, если соблюдаются условия:
   - Свеча *N-2* (самая старая) бычья (`open < close`).
   - Свеча *N-1* (средняя) соответствует параметру `Candle2Bullish` (по умолчанию тоже бычья).
   - Свеча *N* (самая новая) медвежья (`open > close`).
   - При включённом `CheckCandleSizes` тело средней свечи должно быть самым маленьким из трёх.
   - При включённом `ConsiderGap` между телами свечей обязателен разрыв – расстояние такое же, как в оригинальном роботе (один пункт, рассчитанный по шагу цены инструмента).
4. После подтверждения модели проверяется выбранное направление `Direction`:
   - Значение `Short` (по умолчанию) открывает короткую позицию, что соответствует классической интерпретации вечерней звезды.
   - Значение `Long` позволяет торговать противоположную сторону (опция сохранена для функционального соответствия MQL-версии).
5. Перед открытием позиции стратегия при необходимости закрывает встречную позицию, если `CloseOppositePositions = true`.
6. Stop-loss и take-profit рассчитываются по расстояниям в пунктах (`StopLossPips`, `TakeProfitPips`) с тем же корректирующим коэффициентом для инструментов с 3/5 знаками после запятой.
7. Объём позиции определяется из текущей стоимости портфеля и параметра `RiskPercent`. Если рассчитанный объём меньше минимально допустимого, сигнал пропускается.

## Управление позицией
- При открытой длинной позиции каждая новая свеча проверяется: если минимум пробивает стоп или максимум достигает цели, вся позиция закрывается по рынку.
- Для короткой позиции действует тот же принцип, но с зеркальными условиями.
- Если стоимость портфеля или расстояние до стопа равны нулю, объём рассчитать невозможно и сделка игнорируется.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --------------------- | -------- |
| `Direction` | `Short` | Выбор направления сделки при появлении модели. |
| `TakeProfitPips` | `150` | Расстояние до цели в пунктах. Ноль отключает take-profit. |
| `StopLossPips` | `50` | Расстояние до защитного стопа в пунктах. Неположительное значение блокирует вход. |
| `RiskPercent` | `5` | Доля капитала, которая рискуется в одной сделке, используется при расчёте объёма. |
| `Shift` | `1` | Количество баров, пропускаемых от последней свечи перед проверкой модели. |
| `ConsiderGap` | `true` | Требует ценовой разрыв между свечами, как в оригинальном советнике. |
| `Candle2Bullish` | `true` | Требует бычью среднюю свечу. При отключении ожидается медвежья свеча. |
| `CheckCandleSizes` | `true` | Контролирует, что средняя свеча имеет минимальное тело. |
| `CloseOppositePositions` | `true` | Закрывает противоположную позицию перед открытием новой. |
| `CandleType` | таймфрейм `1H` | Свечной источник данных для анализа. |

## Примечания
- Размер пункта вычисляется из шага цены. Для инструментов с 3 или 5 знаками после запятой один пункт равен десяти шагам цены, что повторяет поведение MQL5.
- Если `StopLossPips` равно нулю, объём позиции не рассчитывается, и сигнал игнорируется, чтобы избежать неограниченного риска.
- Буфер свечей автоматически обрезается до необходимой длины, поэтому потребление памяти остаётся стабильным во время длительной работы.
