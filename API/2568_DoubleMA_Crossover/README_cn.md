# 双均线突破策略

## 概览

该策略将 MetaTrader 平台中的“DoubleMA Crossover”专家顾问移植到 StockSharp 框架。策略同时监控快慢两条简单移动平均线，等待出现方向性交叉后，再根据设定的突破距离确认入场。算法一次只允许持有一笔仓位，并保留原版本的三种可选移动止损模式。

## 工作流程

1. **信号识别**：在选定的 K 线序列上计算两条简单均线（默认周期分别为 2 和 5）。当快线向上穿越慢线时触发看多信号，反之则触发看空信号。
2. **突破确认**：信号出现后，策略根据 `BreakoutPips` 将突破价位记录下来，只有当后续 K 线触及该价位时才会开仓，行为等同于在服务器挂入市价止损单。
3. **仓位管理**：策略严格限制单笔持仓，持仓期间会根据止损、止盈以及所选的移动止损模式跟踪风险。内部变量模拟券商侧的执行逻辑，使回测结果更可复现。
4. **交易时段过滤**：可以通过 `StartHour` 与 `StopHour` 限制允许产生新信号的时间区间。过滤器仅影响新的突破机会，已持有的仓位仍然会被监控与管理。
5. **移动止损**：支持三种模式——立即跟踪原始止损距离、自定义距离触发的跟踪、以及原 EA 中的三级移动止损逻辑。

## 参数说明

| 参数 | 说明 |
|------|------|
| `FastMaPeriod`, `SlowMaPeriod` | 快慢两条简单均线的周期。 |
| `BreakoutPips` | 信号产生后加在收盘价上的突破距离，单位为价格步长。 |
| `StopLossPips`, `TakeProfitPips` | 止损与止盈的距离（价格步长）。将止盈设为 0 可关闭此功能。 |
| `UseTrailingStop` | 是否启用移动止损。 |
| `TrailingMode` | 移动止损类型：Type1 使用原始止损距离，Type2 使用 `TrailingStopPips`，Type3 还原原 EA 的三级逻辑。 |
| `TrailingStopPips` | Type2 模式的固定跟踪距离。 |
| `Level1TriggerPips`, `Level1OffsetPips` | Type3 的第一层触发阈值与偏移量（默认移动至保本）。 |
| `Level2TriggerPips`, `Level2OffsetPips` | Type3 的第二层触发阈值与偏移量。 |
| `Level3TriggerPips`, `Level3OffsetPips` | Type3 的第三层触发阈值与偏移量，随后转化为跟随当前价格的移动止损。 |
| `UseTimeLimit`, `StartHour`, `StopHour` | 是否启用交易时段过滤及对应的起止小时。 |
| `CandleType` | 计算信号所使用的 K 线类型。 |
| `TradeVolume` | 下单手数。 |

## 移动止损模式

- **Type1**：当价格向有利方向运行到原始止损距离时，止损同步向前移动同样的距离。
- **Type2**：当价格累计运行 `TrailingStopPips` 指定的距离后才开始移动止损，并始终保持该固定距离。
- **Type3**：按照三个触发层级依次移动止损，前两层可用于保本或锁定利润，第三层将止损转换成跟随当前价格的动态距离。

## 使用建议

- 根据标的物最小跳动价位设置 `BreakoutPips`，以保持与 MetaTrader EA 相同的入场行为。
- 如需全天候交易，可将 `UseTimeLimit` 设为 `false`；若需要日内时段，可调整 `StartHour` 与 `StopHour`。
- 使用 Type3 模式时请确保偏移量不大于触发阈值，否则止损可能无法推进至盈亏平衡附近。
- 策略内部不叠加仓位，如需网格或加仓逻辑需另行扩展。
