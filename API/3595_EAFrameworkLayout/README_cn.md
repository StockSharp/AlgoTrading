# EA框架布局（持仓管理）

## 概述

本策略是 MQL5 专家顾问“EA框架布局”的 StockSharp 版本。原始 EA 不负责发出入场信号，而是管理已经建立的仓位，控制持仓时间并在条件不满足时强制平仓。移植后的策略延续相同的理念：它订阅一组蜡烛（默认 1 小时），计算 2、4、6、8、12、16 期的六条指数移动平均线，并在每根蜡烛收盘后检查是否需要关闭仓位。

## 运行逻辑

1. **仓位跟踪**：当出现新的仓位或方向发生改变时，策略会重置内部计数器，使管理窗口从最新的进场开始计算。
2. **方向过滤**：可以将管理模式限制为仅做多或仅做空。如果现有仓位不符合允许的方向，将立即以市价单平仓。
3. **均线排序检查**：最近的两根已完成蜡烛（位移 1 和 2）必须让六条 EMA 保持严格的顺序并同向倾斜。一旦排序被破坏，就会触发平仓。这一逻辑对应原框架中的 `MA_Direction` 检测。
4. **时间止盈/止损**：`AutoCloseAfterXH1` 参数定义了自进场以来最多可以持有多少根 H1 蜡烛。每次蜡烛收盘都会递增计数器，一旦达到阈值即通过市价单离场。
5. **人工入场**：策略本身不会开仓，假定仓位由人工或其它模块建立。`TradeInitLots` 等参数仍然保留，以便将来扩展加仓或反手功能。

## 参数说明

| 名称 | 说明 |
| --- | --- |
| `LotAmplifier` | 手数放大系数，保持与原 EA 一致，目前逻辑未使用。 |
| `TradeInitLots` | 基础手数，策略启动时会将 `Volume` 设置为该值。 |
| `AutoCloseAfterXH1` | 自动离场前允许经过的 H1 蜡烛数量。 |
| `IsReverse` | 原版中的反手开关，在当前移植中保留但未启用。 |
| `DirectionAllow` | 允许持有的方向（同时、仅多或仅空）。 |
| `UsTimeLeftBound` / `UsTimeRightBound` | 美盘活跃区间（小时，小数代表分钟），用于保持与原 EA 的一致性。 |
| `NonUsTimeLeftBound` / `NonUsTimeRightBound` | 额外时段的起止时间。 |
| `CandleType` | 用于计算指标的蜡烛类型（默认 1 小时）。 |

## 使用注意

* 该策略适用于已经存在的仓位管理，不会主动发送开仓指令。
* 时间管理基于完成的蜡烛数量，因此为了复现原始行为，建议使用默认的 1 小时周期。
* 在至少获得两根已完成蜡烛之前，均线排序逻辑不会触发，以避免在指标尚未准备好时误判。
* 会话时间判断函数 `IsInDealTime` 被保留，可供用户自行扩展限制交易时段。

## 移植要点

移植过程中使用了 StockSharp 的高级 API：通过 `SubscribeCandles` 订阅蜡烛并绑定指标，在回调中直接获得 EMA 数值，无需手动拉取历史数据。原始框架里的 `MA_Direction` 方法被改写为 C# 版本，用以在不创建大型集合的情况下判断六条均线是否同向。
