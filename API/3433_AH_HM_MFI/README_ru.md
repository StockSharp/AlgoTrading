# Стратегия AH HM MFI

## Краткое описание

Стратегия AH HM MFI торгует свечными моделями «молот» и «повешенный», подтверждёнными индикатором Money Flow Index (MFI). Если после локального нисходящего движения появляется «молот», а MFI остаётся ниже порога перепроданности, открывается длинная позиция. Когда в восходящем тренде формируется «повешенный» и MFI превышает порог перекупленности, стратегия открывает короткую позицию. Выходы выполняются при пересечении MFI заранее заданных границ.

## Логика работы

1. Подписка на свечи выбранного таймфрейма и расчёт двух индикаторов:
   - **Money Flow Index** с настраиваемым периодом (по умолчанию 47).
   - **Простая скользящая средняя** по ценам закрытия для оценки тренда (период по умолчанию 5).
2. Поиск моделей **молот** и **повешенный**:
   - Тело свечи расположено в верхней трети диапазона.
   - Длинная нижняя тень относительно тела.
   - Разрыв в сторону тренда относительно предыдущей свечи.
   - Подтверждение тренда через сравнение средней точки предыдущей свечи и значения скользящей средней.
3. Подтверждение входов через уровни MFI:
    - Покупка, если найден «молот» и MFI не превышает порог перепроданности (по умолчанию 40).
    - Продажа, если обнаружен «повешенный» и MFI не опускается ниже порога перекупленности (по умолчанию 60).
4. Управление выходами по пересечениям MFI:
   - Короткие позиции закрываются при пробое MFI вверх выше нижней или верхней границ (по умолчанию 30 и 70).
   - Длинные позиции закрываются при пробое MFI вверх выше верхней границы или при падении ниже нижней.
5. Запуск встроенной защиты `StartProtection` для обработки аварийных ситуаций.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип и таймфрейм свечей для анализа паттернов. | 30-минутные свечи |
| `MfiPeriod` | Период расчёта индикатора MFI. | 47 |
| `MaPeriod` | Период SMA по ценам закрытия для фильтра тренда. | 5 |
| `HammerEntryThreshold` | Максимальное значение MFI для входа по сигналу «молот». | 40 |
| `HangingEntryThreshold` | Минимальное значение MFI для входа по сигналу «повешенный». | 60 |
| `MfiUpperExitLevel` | Верхняя граница MFI, пробой которой закрывает позицию. | 70 |
| `MfiLowerExitLevel` | Нижняя граница MFI: пробой вниз закрывает лонг, пробой вверх — шорт. | 30 |

## Примечания

- В расчёт принимаются только завершённые свечи, чтобы не реагировать на незавершённые данные.
- Проверка паттернов требует и длинной тени, и расположения тела в верхней части свечи, что снижает количество ложных сигналов.
- Скользящая средняя заменяет фильтр `CloseAvg` из оригинального советника MetaTrader 5 и обеспечивает согласованность сигналов с направлением тренда.
