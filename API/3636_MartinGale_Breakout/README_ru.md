# Стратегия MartinGale Breakout

## Общее описание
**MartinGale Breakout Strategy** — это портированный в StockSharp советник MetaTrader 4 *MartinGaleBreakout*. Алгоритм отслеживает аномальные свечи и после их появления открывает позицию по направлению пробоя. При достижении определённого убытка включается режим восстановления: целевой профит увеличивается так, чтобы компенсировать предыдущие потери, что воспроизводит мартингейл-подход оригинала.

Стратегия анализирует выбранный таймфрейм (по умолчанию 15-минутные свечи) и хранит последние 11 завершённых свечей. Если диапазон текущей свечи превышает средний диапазон предыдущих десяти свечей более чем в три раза и цена закрытия находится в доминирующей половине диапазона, формируется сигнал на вход. Далее рассчитывается объём позиции, необходимый для достижения денежной цели по профиту, при соблюдении ограничений по доступной части баланса.

## Логика работы
1. Подписка на поток свечей заданного типа.
2. Накопление 11 завершённых свечей и пересчёт среднего диапазона для определения аномальности.
3. Определение бычьего пробоя, если свеча закрылась в верхней половине диапазона и в три раза больше среднего диапазона.
4. Определение медвежьего пробоя при зеркальных условиях.
5. Открытие рыночной позиции только при отсутствии открытых позиций и если требуемый капитал не превышает заданный процент от баланса.
6. Контроль плавающей прибыли/убытка по текущей позиции и принудительное закрытие при достижении целей по прибыли или убытку.
7. При срабатывании стоп-лосса:
   - Позиция закрывается рыночным ордером.
   - Цель по прибыли увеличивается на величину понесённого убытка.
   - Лимит по убытку устанавливается в максимальное значение и активируется режим восстановления.
8. После успешного выхода из восстановления параметры цели и стоп-лосса сбрасываются к исходным значениям.

## Настройки
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TakeProfitPoints` | Базовое расстояние до тейк-профита в пунктах инструмента. | `50` |
| `BalancePercentageAvailable` | Максимальная доля баланса, доступная для открытия новой позиции. | `50%` |
| `TakeProfitBalancePercent` | Целевой профит в процентах от баланса. | `0.1%` |
| `StopLossBalancePercent` | Предельная просадка перед переходом к восстановлению. | `10%` |
| `StartRecoveryFactor` | Доля стоп-лосса, при которой активируется режим восстановления. | `0.2` |
| `TakeProfitPointsMultiplier` | Множитель расстояния до тейк-профита во время восстановления. | `1` |
| `CandleType` | Тип свечей, используемых для поиска пробоя. | `15 минут` |

## Управление рисками
- Объём сделки рассчитывается через тик-размер и тик-стоимость, чтобы получить заданную денежную прибыль при достижении цели.
- Объём корректируется с учётом шага, минимального и максимального значения объёма, заданных биржей.
- Перед открытием позиции оценивается требуемый капитал; если он превышает допустимую долю баланса, вход игнорируется.
- Восстановление после стоп-лосса увеличивает дистанцию тейк-профита, имитируя мартингейл, но количество одновременно открытых позиций ограничено одной.

## Дополнительные замечания
- Для корректной работы необходимо, чтобы у стратегии был доступ к актуальной информации о портфеле.
- Комиссии учитываются косвенно — через расчёт плавающего результата по текущей позиции.
- Используются только рыночные ордера, отложенные заявки не формируются.
