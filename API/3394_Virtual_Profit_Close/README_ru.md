# Стратегия Virtual Profit Close

## Описание

Virtual Profit Close — это перенос эксперта MetaTrader 4 `Virtual_Profit_Close.mq4` на платформу StockSharp. Стратегия следит за
текущей позицией по выбранному инструменту и закрывает её, как только достигается заданная виртуальная прибыль. В отличие от обычного
тейк-профита, уровень выхода хранится внутри стратегии и не выставляется в виде заявки. Дополнительно доступен трейлинг-стоп, который
подтягивает точку выхода по мере роста прибыли. Для тестов предусмотрен демонстрационный режим автоматического открытия сделок.

## Особенности портирования

- Подписка на тиковые сделки (`SubscribeTrades().Bind(ProcessTrade).Start()`) обеспечивает поведение, аналогичное обработчику `OnTick`.
- Пересчёт «поинтов» MetaTrader выполнен через `Security.PriceStep` с поправкой на трёх- и пятизнаковые инструменты.
- Для расчёта прибыли используются цены Bid (для лонгов) и Ask (для шортов), как и в оригинальном скрипте.
- Трейлинг-стоп активируется после достижения заданного порога и удерживает стоп на фиксированном расстоянии от рынка, имитируя
  последовательные вызовы `OrderModify`.
- Демонстрационный режим заменяет функцию `SendTest`: стратегия открывает рыночные сделки выбранного направления и при необходимости
  ставит защитный стоп через `SetStopLoss`.

## Параметры

| Параметр | Описание |
|----------|----------|
| `ProfitPips` | Виртуальный тейк-профит в пипсах MetaTrader. При достижении позиция закрывается. |
| `UseTrailingStop` | Включает или отключает трейлинг-стоп. |
| `TrailingOffsetPips` | Расстояние между ценой и трейлинг-стопом после его активации. |
| `TrailingActivationPips` | Минимальная прибыль в пипсах для запуска трейлинга. |
| `EnableDemoMode` | Автоматически открывает демонстрационные сделки при отсутствии позиции. |
| `DemoOrderDirection` | Направление демо-сделок (Buy или Sell). |
| `DemoOrderVolume` | Объём демонстрационной сделки. |
| `DemoStopPips` | Необязательный защитный стоп для демо-режима (в пипсах). |

## Логика работы

1. При старте вычисляются размер пипса и все необходимые расстояния (прибыль, трейлинг, демо-стоп).
2. Каждый тик обрабатывается в методе `ProcessTrade`:
   - Лонг закрывается, когда цена Bid приносит требуемую прибыль.
   - Шорт закрывается, когда цена Ask проходит заданное расстояние.
3. Если трейлинг включён и условие активации выполнено, стоп подтягивается вслед за ценой. При возврате цены за уровень стопа позиция
   закрывается рыночной заявкой.
4. В демо-режиме стратегия автоматически открывает новую сделку всякий раз, когда позиция становится нулевой, что повторяет поведение
   оригинального эксперта в тестере.

## Требования

- Для корректной работы нужна тиковая лента сделок.
- Стратегия рассчитана на один инструмент и не управляет несколькими символами одновременно.
