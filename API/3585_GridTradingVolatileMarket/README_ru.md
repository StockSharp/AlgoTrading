# Сетка для волатильного рынка

## Обзор
Стратегия повторяет эксперта MetaTrader «Gridtrading_at_volatile_market.mq4» на высокоуровневом API StockSharp. Она отслеживает касания каналов Дончиана на старшем таймфрейме и подтверждает входы поглощениями на рабочем таймфрейме. После запуска сетки стратегия усредняет позицию при движении цены на кратные значения ATR и закрывает все сделки по целевому профиту либо при превышении допустимой просадки портфеля.

## Логика работы
1. Используются два потока свечей: выбранный торговый таймфрейм и автоматически подобранный старший таймфрейм (M1→M5→M15→M30→H1→H4→D1).
2. На старшем таймфрейме рассчитываются:
   - `ATR(20)` — шаг между уровнями сетки;
   - `SMA(SlowMaLength)` — трендовый фильтр в паре с RSI;
   - `DonchianChannels(20)` — динамические уровни поддержки и сопротивления.
3. На рабочем таймфрейме анализируются две последние завершённые свечи для поиска бычьего или медвежьего поглощения.
4. Лонговая сетка стартует, когда предыдущая свеча касается нижней границы Дончиана, формирует бычье поглощение, а RSI указывает на перепроданность (`RSI < 35` при закрытии выше старшего SMA). Шортовая сетка строится зеркально относительно верхней границы и условия `RSI > 65`.
5. После первой рыночной сделки стратегия фиксирует цену запуска и при движении против позиции на `2 * ATR` (для текущего шага) выставляет следующий ордер с объёмом, умноженным на `GridMultiplier`.
6. Все позиции закрываются и заявки отменяются, если выполняется одно из условий:
   - суммарный (реализованный + нереализованный) результат превышает `TakeProfitFactor * общий объём сетки`;
   - просадка опускается ниже `-MaxDrawdownFraction * стартовая стоимость портфеля`.

## Параметры
- **TakeProfitFactor** — множитель целевого профита относительно суммарного объёма сетки (по умолчанию `0.1`).
- **SlowMaLength** — период SMA на старшем таймфрейме для фильтрации (по умолчанию `50`).
- **GridMultiplier** — геометрический коэффициент для каждого дополнительного ордера (по умолчанию `1.5`).
- **BaseOrderVolume** — объём первого ордера сетки (по умолчанию `0.1`).
- **MaxDrawdownFraction** — допустимая доля просадки от начальной стоимости портфеля (по умолчанию `0.8`).
- **CandleType** — рабочий таймфрейм. Старший таймфрейм определяется автоматически.

## Примечания
- Обрабатываются только закрытые свечи, что исключает перерисовку.
- Для оценки открытой прибыли используются котировки bid/ask; при отсутствии стакана расчёт основан на цене последней сделки и может быть менее точным.
- Если данные по портфелю недоступны, защита по просадке игнорируется, и сетка будет работать до достижения целевого профита либо ручного вмешательства.
