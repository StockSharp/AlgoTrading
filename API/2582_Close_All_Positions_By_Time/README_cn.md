# 按时平仓策略

## 概述
该策略复刻了 MetaTrader 专家顾问 *Exp_CloseAllPositionsByTime* 的行为。当烛图时间达到预设的截止时间后，它会立即平掉策略所管理的全部持仓。实现完全基于 StockSharp 的高级 API，仅使用一个可配置的 K 线订阅作为时间触发器。

## 交易逻辑
1. 订阅一个可配置的 K 线序列（默认 1 分钟），用于持续获取时间戳。
2. 一旦收到的完成 K 线的开盘时间大于或等于目标截止时间，就切换到“停止”状态。
3. 在停止状态下，遍历策略及其子策略持有的所有头寸，对每个标的发送反向市价单以实现平仓。
4. 只要仍有剩余头寸，就在后续的完成 K 线上重复发送平仓指令；全部平仓后清除内部标记，避免重复提交订单。

策略不会开立新仓，专门用于在指定时间之后将账户完全降至空仓状态，可作为日终风控或紧急“熔断”组件。

## 参数
| 名称 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | `TimeSpan.FromMinutes(1).TimeFrame()` | 驱动时间检查的 K 线类型。 |
| `StopTime` | `DateTimeOffset` | `2030-01-01 23:59:00 +00:00` | 触发全平仓的时间点。 |

### 行为说明
- 只有在 K 线收盘且 `CandleStates.Finished` 时才会触发检查，避免因未完成的 K 线导致提前平仓。
- 时间比较使用 K 线的开盘时间。回测时请确保数据时间戳与目标市场时区一致。
- 通过遍历 `Positions` 集合来识别所有标的，以确保子策略交易的合约也会被一并平仓。

## 使用建议
- 将策略连接到可能持有多个品种的组合账户，它会自动从 `Positions` 中发现所有敞口并依次平仓。
- 若用于日内风控，请将 `StopTime` 设为本地交易时段结束时间（例如 `2024-05-01 16:00`）。
- 如果需要更快响应，可保持较短的 K 线间隔；延长间隔会降低时间精度。
- 可以与其他策略同时运行，只要共享同一个投资组合即可实现集中式止盈止损。

## 转换说明
- 原始 MQL5 脚本通过循环 `PositionsTotal()` 并发送反向市价单实现平仓，同时使用滑点容忍参数。StockSharp 版本直接调用 `BuyMarket`/`SellMarket`，无需手动构造请求。
- 保留了 MQL 脚本中的 `Stop` 逻辑：一旦超过截止时间就进入关闭模式，直到所有头寸归零。
- 与原版一致，本策略只处理净头寸，不会主动取消挂单，如有需要需手动处理。

## 运行要求
- 已配置好的 StockSharp 环境，以及包含目标证券的投资组合。
- 能够持续接收所选时间框架的 K 线，以驱动时间检查。

## 限制
- 若市场流动性不足，部分平仓单可能只成交一部分；策略会在下一根完成 K 线上继续尝试。
- 策略不会取消仍在排队的限价单，仅负责平掉已成交形成的净头寸。
