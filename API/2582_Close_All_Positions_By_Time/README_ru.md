# Стратегия «Закрыть все позиции по времени»

## Общее описание
Стратегия повторяет работу эксперт-советника MetaTrader *Exp_CloseAllPositionsByTime*. После наступления заданного момента времени она закрывает все открытые позиции, которыми управляет стратегия, используя возможности высокоуровневого API StockSharp. Подписка на свечи служит только для получения регулярных отметок времени.

## Логика работы
1. Подписаться на настраиваемый поток свечей (по умолчанию — 1 минута), чтобы регулярно получать метки времени.
2. Как только завершённая свеча имеет время открытия больше либо равно целевому моменту, стратегия переходит в состояние остановки.
3. Находясь в этом состоянии, стратегия обходит все позиции (основной инструмент и дочерние стратегии) и отправляет встречные рыночные заявки для их закрытия.
4. Пока в портфеле остаются позиции, на каждой следующей завершённой свече стратегия повторяет закрывающие заявки. После полного выхода из всех позиций внутренний флаг сбрасывается, чтобы не отправлять лишние ордера.

Стратегия не открывает новых сделок — она служит защитным «рубильником» для полного обнуления позиций в заданное время (например, в конце торговой сессии).

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | `TimeSpan.FromMinutes(1).TimeFrame()` | Тип свечей, используемых для контроля времени. |
| `StopTime` | `DateTimeOffset` | `2030-01-01 23:59:00 +00:00` | Момент, после которого все позиции должны быть закрыты. |

### Особенности поведения
- Проверка выполняется только по завершённым свечам (`CandleStates.Finished`), чтобы не закрывать позиции преждевременно.
- Сравнение времени ведётся по моменту открытия свечи. В тестах убедитесь, что временная зона данных соответствует биржевой.
- Использование коллекции `Positions` позволяет закрывать инструменты дочерних стратегий, а не только основной тикер.

## Рекомендации по применению
- Подключайте стратегию к портфелю, где может быть несколько инструментов: она автоматически найдёт их через `Positions` и закроет по очереди.
- Для внутридневного контроля установите `StopTime` на время окончания торговой сессии (например, `2024-05-01 16:00`).
- Короткий таймфрейм (1 минута) даёт более точную реакцию по времени. Увеличение интервала замедляет срабатывание.
- Стратегия может работать параллельно с другими алгоритмами, если они используют тот же портфель, тем самым обеспечивая централизованный выход из позиции.

## Особенности конверсии
- В оригинальном MQL5-скрипте использовались циклы по `PositionsTotal()` и отправка противоположных рыночных ордеров с учётом допустимого проскальзывания. В версии StockSharp применяются вызовы `BuyMarket`/`SellMarket`, поэтому нет необходимости вручную формировать запросы.
- Логика флага `Stop` сохранена: после наступления времени стратегия остаётся в режиме закрытия до полного обнуления позиций.
- Стратегия не отменяет выставленные лимитные ордера — только закрывает чистую позицию, как и оригинальный эксперт.

## Требования
- Настроенное окружение StockSharp с доступом к целевому портфелю и инструментам.
- Поступление свечей выбранного таймфрейма, чтобы запускать проверки времени.

## Ограничения
- При низкой ликвидности некоторые заявки могут исполняться частично. Стратегия продолжит попытки на следующей завершённой свече.
- Лимитные ордера остаются активными; при необходимости отменяйте их вручную.
