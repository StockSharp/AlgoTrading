# Стратегия Momo Trades V3

## Обзор
Momo Trades V3 — порт MetaTrader-советника в экосистему StockSharp. Стратегия остаётся верной оригиналу: она сочетает сложный набор условий по основной линии MACD с фильтром на базе смещённой экспоненциальной средней и включает опциональный перевод позиции в безубыток. Дополнительно реализован режим автоматического расчёта объёма, повторяющий логику автолотности исходного эксперта.

## Логика входов
1. **Паттерны MACD.** Используется стандартный набор параметров `(12, 26, 9)` и дополнительный сдвиг (`MacdShift`). Для длинных сделок допустимы два сценария:
   - Последовательность возрастающих значений, где третье по счёту равно нулю, а два следующих продолжают рост.
   - Пересечение уровня ноль вверх: текущие и последующие значения положительные, а предыдущие находятся в отрицательной зоне.
   Для коротких позиций условия зеркально разворачиваются.
2. **Фильтр расстояния до EMA.** Цена закрытия смещённой свечи (`MaShift`) должна отстоять от EMA минимум на `PriceShiftPoints` метатрейдеровских пунктов: выше средней для покупок и ниже для продаж. Это защищает от сделок вблизи средней линии.
3. **Одна позиция одновременно.** Новая сделка открывается только при нулевой позиции. Сигналы, возникающие во время активной сделки, игнорируются.
4. **Закрытие в конце дня.** При включённом `CloseEndDay` позиция закрывается в 23:00 серверного времени (в пятницу — в 21:00), чтобы исключить перенос на ночь.
5. **Безубыток.** Если активирован `UseBreakeven`, как только цена позволяет перенести стоп на уровень открытия плюс `BreakevenOffsetPoints`, стратегия запоминает этот уровень. При возврате цены к нему позиция закрывается по рынку.

## Управление рисками
- **Стартовая защита.** Значения `StopLossPoints` и `TakeProfitPoints` переводятся в абсолютные ценовые расстояния через шаг цены инструмента и передаются в `StartProtection`, поэтому защитные заявки выставляются автоматически.
- **Автоматический объём.** При `UseAutoVolume = true` размер ордера рассчитывается как доля капитала `RiskFraction`, делённая на стоимость контракта (`цена × размер лота`). Результат нормируется по шагу объёма и ограничивается диапазоном `VolumeMin`/`VolumeMax`. Если автолот отключён, используется фиксированный `TradeVolume`.

## Индикаторы
- **MACD** — формирует основной сигнал импульса, анализируется по истории со смещением.
- **EMA** — выступает в роли трендового фильтра.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
|-----|-----|-----------------------|----------|
| `CandleType` | `DataType` | `TimeFrame(15m)` | Таймфрейм, по которому строятся сигналы. |
| `MaPeriod` | `int` | `22` | Период EMA для фильтра. |
| `MaShift` | `int` | `1` | Сдвиг по завершённым свечам при выборке цены и EMA. |
| `FastPeriod` | `int` | `12` | Быстрая средняя в MACD. |
| `SlowPeriod` | `int` | `26` | Медленная средняя в MACD. |
| `SignalPeriod` | `int` | `9` | Параметр сигнальной EMA MACD. |
| `MacdShift` | `int` | `1` | Дополнительный сдвиг при оценке паттернов MACD. |
| `PriceShiftPoints` | `decimal` | `10` | Минимальное расстояние (в пунктах MetaTrader) между смещённым закрытием и EMA. |
| `TradeVolume` | `decimal` | `0.1` | Базовый объём сделки при выключенном автолоте. |
| `RiskFraction` | `decimal` | `0.1` | Доля капитала для расчёта объёма при `UseAutoVolume = true`. |
| `UseAutoVolume` | `bool` | `false` | Включает риск-ориентированное определение объёма. |
| `StopLossPoints` | `decimal` | `100` | Дистанция начального стоп-лосса в пунктах MetaTrader. `0` — без стопа. |
| `TakeProfitPoints` | `decimal` | `0` | Дистанция тейк-профита. `0` отключает цель. |
| `CloseEndDay` | `bool` | `true` | Принудительно закрывает позиции в конце торгового дня. |
| `UseBreakeven` | `bool` | `false` | Активирует перенос стопа в безубыток. |
| `BreakevenOffsetPoints` | `decimal` | `0` | Прибавка к цене входа при переносе в безубыток. |

## Рекомендации по использованию
- Убедитесь, что у инструмента задан `PriceStep`. При отсутствии данных стратегия использует значение `0.0001` для пересчёта пунктов в цену.
- Обработка сигналов ведётся только по завершённым свечам, что соответствует работе оригинального эксперта.
- Поскольку стратегия держит только одну позицию, риск на сделку определяется исключительно выбранным объёмом (`TradeVolume` или автоматическим эквивалентом).
