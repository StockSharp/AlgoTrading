# Стратегия Diff TF MA

## Обзор
- Стратегия представляет собой порт советника MetaTrader «Diff_TF_MA_EA» на платформу StockSharp.
- Сигналы формируются сравнением простой скользящей средней (SMA) на старшем таймфрейме и SMA, пересчитанной под рабочий таймфрейм.
- Обрабатываются только закрытые свечи, полностью сохранена логика пересечений и закрываются встречные позиции перед открытием новых.

## Параметры
| Название | Описание |
| --- | --- |
| `MaPeriod` | Длина SMA на старшем таймфрейме. |
| `CandleType` | Рабочий таймфрейм, по которому генерируются сделки. |
| `HigherCandleType` | Старший таймфрейм, задающий эталонную SMA. |
| `ReverseSignals` | Инвертирует правила: покупка по медвежьему пересечению и продажа по бычьему. |
| `Volume` | Торговый объём стратегии, задаётся через свойство `Strategy.Volume`. |

## Логика торговли
1. Подписаться на свечи рабочего (`CandleType`) и старшего (`HigherCandleType`) таймфреймов.  
2. Рассчитать SMA длиной `MaPeriod` на старшем таймфрейме.  
3. Пересчитать длину под рабочий таймфрейм через отношение длительностей и запустить вторую SMA на рабочих свечах.  
4. Хранить по два последних значения обеих SMA и проверять пересечения после закрытия каждой рабочей свечи.  
5. Если старшая SMA пересекает рабочую снизу вверх (и `ReverseSignals` отключён), открыть или развернуть позицию в лонг.  
6. Если старшая SMA пересекает рабочую сверху вниз (и `ReverseSignals` отключён), открыть или развернуть позицию в шорт.  
7. Объём заявок автоматически включает компенсацию текущей позиции, чтобы плавно закрыть противоположное плечо.  

## Рекомендации по использованию
- Выбирайте таймфреймы так, чтобы старший был существенно больше рабочего — тогда пересчёт периода будет корректным.
- По умолчанию объём равен `1`; при необходимости измените `Strategy.Volume` перед запуском.
- Встроенные в исходный советник стоп-лосс и тейк-профит не перенесены, при необходимости добавьте защиту через механизмы StockSharp.
- При активации `ReverseSignals` условия на покупку и продажу меняются местами, остальная логика сохраняется.
