# 趋势发现者策略

## 概述
趋势发现者（Trend Finder）策略基于原始的 **TREND FINDER.mq4** 专家顾问改写，使用 StockSharp 的高级 API 重构核心逻辑。策略通过多周期的线性加权移动平均线、动量和 MACD 共振来识别突破行情，力求在价格突破并得到高周期趋势验证时顺势入场。

## 市场数据与指标
- **基础周期 (`CandleType`)**：用于识别形态和执行交易的主图周期。线性加权均线基于该周期的典型价（高+低+收/3）计算。
- **动量周期 (`MomentumCandleType`)**：更高周期的 K 线，用于计算动量指标与 100 的偏离值。最近三个动量值中至少有一个必须超过阈值才能允许交易。
- **MACD 周期 (`MacdCandleType`)**：长周期 K 线用于计算 MACD。只有在 MACD 与信号线形成多头/空头排列时，才会触发对应方向的信号。

## 入场逻辑
1. **趋势突破判定**：在历史最多 100 根、排除最近三根的 K 线中寻找最高点或最低点。若当前 K 线开盘价高于历史高点且最近三根中至少一根的高点仍低于该水平，则判定为多头突破；空头逻辑相反。
2. **均线方向一致**：多头需要快速 LWMA 高于慢速 LWMA，空头则要求相反。
3. **近期价格结构**：多头要求两根前的最低价低于上一根的最高价 (`Low[2] < High[1]`)；空头要求上一根的最低价低于两根前的最高价 (`Low[1] < High[2]`)，保留原策略的结构确认。
4. **动量确认**：在更高周期上计算的 |动量 − 100| 中，最近三值至少有一个超过对应的买入或卖出阈值。
5. **MACD 确认**：长周期 MACD 值必须高于信号线（多头）或低于信号线（空头）。
6. **仓位过滤**：仅在当前仓位≤0 时建立多头，仓位≥0 时建立空头。下单数量等于 `Volume + |Position|`，方便快速反手。

## 风险与仓位管理
- **止损 (`StopLoss`)**：入场后固定的价格距离，用于限制亏损。
- **止盈 (`TakeProfit`)**：达到设定的利润距离时立即平仓。
- **移动止损 (`TrailingStop`)**：多头跟踪最高价、空头跟踪最低价，在每根已完成的 K 线后更新。
- **保本 (`BreakEvenTrigger`, `BreakEvenOffset`)**：当价格向有利方向运行超过触发距离时，将保护价移动至入场价加/减偏移量，锁定利润。
- **自动平仓**：辅助方法一次性平掉全部仓位，并重置内部跟踪变量。本实现不做部分平仓。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 识别形态与执行交易的基础周期。 | 15 分钟 |
| `MomentumCandleType` | 用于动量确认的高周期。 | 1 小时 |
| `MacdCandleType` | MACD 计算使用的周期（默认约 30 天）。 | 30 天 |
| `FastMaLength` | 快速线性加权均线长度。 | 6 |
| `SlowMaLength` | 慢速线性加权均线长度。 | 85 |
| `MomentumPeriod` | 动量计算所需的历史 K 线数量。 | 14 |
| `MomentumThresholdBuy` | 允许做多所需的最小 |动量 − 100|。 | 0.3 |
| `MomentumThresholdSell` | 允许做空所需的最小 |动量 − 100|。 | 0.3 |
| `MacdShortLength` | MACD 快速 EMA 长度。 | 12 |
| `MacdLongLength` | MACD 慢速 EMA 长度。 | 26 |
| `MacdSignalLength` | MACD 信号线 EMA 长度。 | 9 |
| `StopLoss` | 以价格单位表示的固定止损距离。 | 0.0020 |
| `TakeProfit` | 以价格单位表示的固定止盈距离。 | 0.0050 |
| `TrailingStop` | 跟踪止损的价格距离。 | 0.0040 |
| `BreakEvenTrigger` | 激活保本机制所需的利润距离。 | 0.0030 |
| `BreakEvenOffset` | 保本触发后在入场价基础上的偏移量。 | 0.0010 |

> **提示：** 启动策略前请设置 `Strategy.Volume` 作为下单手数。所有风险参数均以绝对价格表示，应根据标的的最小跳动值进行调整。

## 使用建议
1. 绑定目标 `Security`，设置好 `Portfolio` 与 `Volume`。
2. 确认行情源能够提供全部三个所需周期的 K 线，否则动量与 MACD 过滤条件将无法满足。
3. 根据标的波动性调节风险参数；若用于股票、期货或加密资产，需按价格尺度重新设定。
4. 可利用策略自动创建的图表区域观察价格、成交以及两条均线。
5. 策略使用 `BuyMarket` / `SellMarket` 市价单，请关注日志与成交回报。

## 与原始 EA 的差异
- 未移植原始脚本中的权益止损、收益达成即平仓以及邮件/推送通知功能，以保持逻辑简洁并契合 StockSharp 高级 API。
- 仓位管理简化为单一净仓模式，订单规模由 `Volume` 控制。
- 原脚本按账户货币计算的资金管理选项未包含在此版本中，取而代之的是基于价格的止损/止盈/保本机制。

## 建议的扩展方向
- 若需要多标的同时交易，可增加组合层面的风险控制。
- 可加入交易时段或波动率过滤，避免流动性不足时进场。
- 如需记录权益曲线或外部分析，可接入额外的绩效统计模块。

