# Стратегия Rubberbands 3

Стратегия представляет собой порт эксперта MetaTrader 4 **RUBBERBANDS_3** на платформу StockSharp. Алгоритм отслеживает два экстремума цены, наращивает позицию при расширении диапазона на заданное число пунктов и полностью закрывает серию ордеров при обратном движении. После фиксации профита стратегия может перевернуться и начать набор позиций в противоположном направлении. Одновременно ведётся контроль суммарной прибыли и убытка в пределах торговой сессии.

> **Важно:** в StockSharp позиции неттингуются. В оригинальном советнике могли одновременно существовать покупки и продажи. В портированной версии серия ордеров в одном направлении закрывается перед открытием противоположных сделок. Логика «растягивания резинки» и закрытия на откате при этом сохраняется.

## Логика работы

1. При старте сохраняются текущие максимальное и минимальное значения цены закрытия (либо используются значения `InitialMax` и `InitialMin`).
2. Если цена поднимается выше максимума на величину `PipStep`, выставляется рыночная покупка объёмом `OrderVolume`, а максимум обновляется.
3. Если цена опускается ниже минимума на `PipStep`, выставляется рыночная продажа объёмом `OrderVolume`, минимум обновляется.
4. При обратном движении на `BackStep` пунктов вся серия сделок текущего направления закрывается. Как только позиции обнулены, стратегия готовится открыть сделки противоположного направления.
5. Реализован контроль сессионных результатов: при достижении `SessionTakeProfit × OrderVolume` все позиции закрываются. Если во время переворота плавающий убыток превышает `SessionStopLoss × OrderVolume`, серия также принудительно закрывается.
6. Флаг `QuiesceNow` переводит стратегию в «тихий» режим после закрытия всех позиций. `StopNow` полностью приостанавливает логику, `CloseNow` инициирует немедленное закрытие всех ордеров.

Обработка сигналов выполняется по завершённым свечам типа `CandleType`. По умолчанию используется минутный таймфрейм, что соответствует первоначальному советнику, срабатывавшему в начале каждой минуты.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `OrderVolume` | Базовый объём каждой рыночной заявки. | `0.02` |
| `MaxOrders` | Максимальное число одновременно открытых ордеров в одном направлении. | `10` |
| `PipStep` | Расстояние в пунктах, при котором добавляется новый ордер. | `100` |
| `BackStep` | Откат в пунктах, при котором серия закрывается и готовится разворот. | `20` |
| `QuiesceNow` | При `true` стратегия не открывает новые сделки, находясь без позиций. | `false` |
| `DoNow` | Принудительно открывает первую сделку (покупку) сразу после запуска. | `false` |
| `StopNow` | Полностью приостанавливает торговую логику без закрытия текущих сделок. | `false` |
| `CloseNow` | Запрашивает немедленное закрытие всех позиций по рыночным ценам. | `false` |
| `UseSessionTakeProfit` | Включает контроль суммарного профита сессии. | `true` |
| `SessionTakeProfit` | Сессионный тейк-профит в валюте счёта на один лот. | `2000` |
| `UseSessionStopLoss` | Включает сессионный стоп-лосс. | `true` |
| `SessionStopLoss` | Максимально допустимый убыток на один лот при перевороте. | `4000` |
| `UseInitialValues` | Использовать сохранённые экстремумы при перезапуске стратегии. | `false` |
| `InitialMax` | Сохранённый максимум, применяется при `UseInitialValues = true`. | `0` |
| `InitialMin` | Сохранённый минимум, применяется при `UseInitialValues = true`. | `0` |
| `CandleType` | Тип свечей, по которым ведётся расчёт. | `TimeFrame(1m)` |

## Управление сессией

- **Агрегация прибыли.** После каждого полного закрытия серии фиксированный результат добавляется к накопленной прибыли `_realizedProfit`. Плавающий результат рассчитывается по средневзвешенным ценам открытых позиций.
- **Сессионный тейк-профит.** При достижении целевого значения вся серия закрывается, экстремумы сбрасываются.
- **Сессионный стоп-лосс.** Во время переворота отслеживается текущий убыток. Если он превышает порог `SessionStopLoss`, позиции закрываются и торговая сессия начинается заново.

## Рекомендации по использованию

- Для корректного пересчёта пунктов необходимо заполнить `Security.PriceStep`. При отсутствии данных используется резервное значение `0.0001`.
- Из-за неттинга обратное направление открывается только после полного закрытия предыдущей серии. Учтите это при сравнении отчётов с оригинальной версией.
- Флаг `DoNow` влияет только на первое открытие. Дальнейшие сделки выполняются по правилам расширения диапазона.
- `QuiesceNow` полезен, если нужно оставить стратегию запущенной, но не позволять ей начинать новые циклы после закрытия позиций.

