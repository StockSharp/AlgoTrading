# Стратегия Auto TP Manager

## Общее описание
**Auto TP Manager Strategy** — это перенос советника MetaTrader 5 *Auto Tp.mq5* на платформу StockSharp. Стратегия не открывает сделки самостоятельно. Её задача — отслеживать текущую позицию по выбранному инструменту и автоматически подвязывать к ней тейк-профит и стоп-лосс. Дополнительно реализованы трейлинг-стоп по точкам и защита по просадке счёта.

Решение предназначено для ситуаций, когда сделки открываются вручную или внешними алгоритмами. Как только стратегия обнаруживает ненулевую позицию, она рассчитывает уровни защиты и регистрирует соответствующие заявки через высокоуровневый API StockSharp.

## Ключевые особенности
- Отслеживание внешних сделок и установка защитных ордеров при каждом изменении позиции.
- Постановка тейк-профита на фиксированном расстоянии в пунктах от средней цены входа.
- Опциональная постановка стоп-лосса с автоматической синхронизацией объёма и цены входа.
- Подтягивание стоп-лосса при достижении заданной прибыли (трейлинг-стоп).
- Контроль эквити портфеля и принудительное закрытие позиции при падении ниже допустимого процента.
- Снятие всех защитных ордеров после полного закрытия позиции.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `TakeProfitPips` | Расстояние до тейк-профита в пунктах от средней цены входа. | `25` |
| `UseStopLoss` | Включает/отключает постановку стоп-лосса. | `false` |
| `StopLossPips` | Первоначальное расстояние стоп-лосса в пунктах. Работает только при `UseStopLoss = true`. | `12` |
| `UseTrailingStop` | Включает трейлинг-стоп (требуется включенный стоп-лосс). | `false` |
| `TrailingStopPips` | Расстояние, поддерживаемое трейлинг-стопом, в пунктах. | `15` |
| `UseEquityProtection` | Включает защиту по эквити. | `false` |
| `MinEquityPercent` | Минимально допустимое значение эквити в процентах от стартового баланса. | `20` |
| `Slippage` | Параметр сохранён ради совместимости с оригинальным советником и в логике не используется. | `3` |

Точность пункта определяется автоматически по `PriceStep` инструмента. Для пятизначных валютных котировок шаг умножается на десять, что полностью повторяет поведение MQL-версии.

## Логика трейлинг-стопа
При активных `UseTrailingStop` и `UseStopLoss` стоп начинает подтягиваться, как только цена проходит заданное расстояние в прибыль. Для длинных позиций используется лучшая цена Bid, для коротких — лучшая цена Ask. Стоп никогда не отодвигается назад и всегда сохраняет заданный зазор.

## Защита по эквити
Контроль просадки выполняется по значениям `Portfolio.BeginValue` (стартовый баланс) и `Portfolio.CurrentValue` (текущая стоимость портфеля). Если текущая эквити опускается ниже доли, заданной `MinEquityPercent`, стратегия вызывает `ClosePosition()` и полностью выходит из рынка.

## Рекомендации по использованию
1. Привяжите стратегию к нужному инструменту и портфелю и запустите её до начала ручной торговли.
2. Убедитесь, что брокер поддерживает стоп- и лимитные заявки, поскольку стратегия выставляет оба типа.
3. Для работы трейлинг-стопа необходимы данные уровня Level1 (лучшая цена Bid/Ask).
4. Значение `Slippage` оставлено для совместимости; фактическое управление проскальзыванием выполняется на стороне торгового шлюза.

## Детали переноса
- Исходник: `MQL/61119/Auto_Tp.mq5`.
- Используемая технология: высокоуровневый API StockSharp и подписка `SubscribeLevel1()`.
- Дополнения: защита по эквити, расширенные описания параметров, подробные комментарии в коде.

Стратегия сохраняет исходную торговую логику и полностью соответствует требованиям к оформлению и структуре проектов StockSharp.
