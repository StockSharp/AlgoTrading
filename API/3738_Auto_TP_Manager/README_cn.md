# Auto TP 管理策略

## 概述
**Auto TP 管理策略** 将 MetaTrader 5 专家顾问 *Auto Tp.mq5* 移植到 StockSharp 平台。策略本身不会主动下单，而是监控所选品种的净头寸，并自动为人工或外部系统开立的交易附加止盈、止损订单。还可以启用基于点值的移动止损以及按权益百分比触发的强制平仓保护。

策略适用于人工交易或多系统协同场景。当检测到当前头寸不为零时，它会按照配置的点距计算保护价格，并通过 StockSharp 高级 API 注册相应的止损/止盈订单。

## 核心行为
- 侦测外部开仓，一旦仓位发生变化即重新部署保护性订单。
- 在入场均价附近按固定点距挂出止盈限价单。
- 可选地生成止损单，并在仓位规模或均价变化时自动同步。
- 当浮盈超过设定的点距后，支持向盈利方向移动止损。
- 跟踪账户权益，当权益跌破初始余额的一定比例时强制平仓。
- 当仓位归零时撤销所有挂出的保护性订单。

## 参数
| 名称 | 说明 | 默认值 |
|------|------|--------|
| `TakeProfitPips` | 相对入场均价的止盈点距。 | `25` |
| `UseStopLoss` | 是否启用止损模块。 | `false` |
| `StopLossPips` | 初始止损点距，仅在启用止损时生效。 | `12` |
| `UseTrailingStop` | 是否启用移动止损，需要同时启用止损。 | `false` |
| `TrailingStopPips` | 移动止损与价格之间保持的点距。 | `15` |
| `UseEquityProtection` | 是否启用权益保护逻辑。 | `false` |
| `MinEquityPercent` | 允许的最低权益百分比，跌破后立即平仓。 | `20` |
| `Slippage` | 为兼容原始 EA 保留的参数，策略内部未直接使用。 | `3` |

策略会根据品种的 `PriceStep` 自动计算点值。在常见的 5 位报价外汇品种上，会将最小跳动乘以 10，以复现 MQL 的定义。

## 移动止损逻辑
当同时启用 `UseTrailingStop` 与 `UseStopLoss` 后，只要市场朝有利方向移动超过设定点距，策略就开始移动止损。多头使用最优买价，空头使用最优卖价作为参考。新的止损价始终向盈利方向推进，不会回退。

## 权益保护
策略使用 `Portfolio.BeginValue` 作为初始权益基准，`Portfolio.CurrentValue` 作为实时权益值。当实时权益低于 `MinEquityPercent` 指定的比例时，调用 `ClosePosition()` 平掉当前净头寸，避免进一步亏损。

## 使用建议
1. 将策略绑定到目标证券和投资组合，并在手动交易前启动策略。
2. 确保账户支持止损单与限价单，因为策略会同时注册两种订单类型。
3. 移动止损依赖 Level1 数据（最优买/卖），需要保证行情源能提供相关字段。
4. 由于移植自 MQL，保留了 `Slippage` 参数；实际滑点控制需在券商或网关侧完成。

## 转换细节
- 源文件：`MQL/61119/Auto_Tp.mq5`。
- 平台：基于 StockSharp 高级 API，使用 `SubscribeLevel1()` 订阅行情。
- 增强项：补充了权益保护、参数元数据以及更易读的注释说明。

该移植版本严格遵循原有交易逻辑，同时符合 StockSharp 关于参数、绑定及风险控制的开发规范。
