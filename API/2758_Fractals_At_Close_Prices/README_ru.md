# Стратегия «Fractals at Close Prices»
[English](README.md) | [中文](README_cn.md)

## Общее описание
Эта стратегия представляет собой порт советника MetaTrader 5 **«Fractals at Close prices»** автора Владимира Карпутова на платформу StockSharp. Она анализирует последовательность из пяти подряд закрытий и строит фракталы Билла Вильямса именно по ценам закрытия, без использования максимумов и минимумов. Для определения направления тренда сравниваются два последних бычьих и два последних медвежьих фрактала. Если новый бычий фрактал появился выше предыдущего, открывается длинная позиция. Если новый медвежий фрактал сформировался ниже предыдущего, открывается короткая позиция. Перед входом противоположная позиция закрывается, поэтому стратегия всегда находится только в одном направлении.

Сделки разрешены лишь в заданном часовом диапазоне. Если текущий час выходит за рамки интервала, все позиции закрываются немедленно — так же поступает оригинальный эксперт. Фильтр времени поддерживает внутридневную торговлю (start < end), переход через полночь (start > end) и круглосуточный режим (start == end).

## Логика индикатора
* Каждая завершённая свеча добавляется в скользящее окно из пяти последних закрытий.
* Как только окно заполнено, анализируется средняя цена (две свечи назад):
  * Бычий фрактал фиксируется, если средняя цена строго выше двух более старых закрытий и не ниже двух более новых.
  * Медвежий фрактал фиксируется, если средняя цена строго ниже двух более старых закрытий и не выше двух более новых.
* Сохраняются последние и предпоследние значения бычьих и медвежьих фракталов для последующего сравнения.
* Если новый бычий фрактал выше предыдущего, определяется восходящий тренд. Если новый медвежий фрактал ниже предыдущего, считается, что тренд нисходящий.

## Торговые правила
1. **Лонг**
   * Закрыть все активные короткие позиции по рынку.
   * Если длинной позиции нет, купить `OrderVolume` по рынку на закрытии, подтвердившем бычью последовательность фракталов.
2. **Шорт**
   * Закрыть все активные длинные позиции по рынку.
   * Если короткой позиции нет, продать `OrderVolume` по рынку при подтверждении медвежьей последовательности фракталов.
3. **Контроль сессии**
   * Перед обработкой сигналов проверяется, попадает ли `candle.OpenTime.Hour` в разрешённый диапазон. Если нет, вызывается `CloseAllPositions`, и текущая свеча игнорируется.

## Управление рисками
* Стоп-лосс и тейк-профит задаются в пунктах. Реализована логика MT5: значение шага цены умножается на десять, если инструмент имеет 3 или 5 знаков после запятой, и полученный «пункт» домножается на выбранные расстояния.
* При входе уровни стоп-лосса и тейк-профита сохраняются во внутренних переменных. Поскольку StockSharp не сопровождает защитные ордера MT5 автоматически, стратегия отслеживает завершённые свечи и закрывает позицию по рынку, когда диапазон цены касается соответствующего уровня.
* Трейлинг-стоп повторяет правила советника: новый стоп равен `close ± TrailingStop`, когда прибыль превышает `TrailingStop + TrailingStep`. Стоп смещается только если прирост относительно предыдущего уровня не меньше `TrailingStep`.
* По окончании торгового окна все позиции закрываются независимо от состояния трейлинга, полностью копируя поведение оригинала.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `OrderVolume` | Объём каждой рыночной сделки. | `0.1` |
| `StartHour` | Час (0–23), начиная с которого разрешена торговля. При равенстве с `EndHour` торговля ведётся весь день. | `10` |
| `EndHour` | Час (0–23), после которого сигналы не отрабатываются. | `22` |
| `StopLossPips` | Расстояние стоп-лосса в пунктах. Значение `0` отключает стоп. | `30` |
| `TakeProfitPips` | Расстояние тейк-профита в пунктах. Значение `0` отключает тейк. | `50` |
| `TrailingStopPips` | Базовое расстояние трейлинг-стопа в пунктах. Значение `0` отключает трейлинг. | `15` |
| `TrailingStepPips` | Дополнительный профит в пунктах, необходимый для переноса трейлинг-стопа. | `5` |
| `CandleType` | Тип свечей, на которые подписывается стратегия. По умолчанию — часовые свечи. | `1 hour TimeFrame` |

## Особенности реализации
* Используется высокоуровневый API `SubscribeCandles`; индикаторы вручную не регистрируются, что соответствует требованиям репозитория.
* Защитные выходы (стоп, тейк, трейлинг) исполняются рыночными ордерами после закрытия свечи, поскольку StockSharp не управляет ими автоматически, как MT5.
* Фильтр торговых часов, поиск фракталов и логика трейлинга повторяют структуру советника, включая принудительное закрытие позиций вне торгового окна.
* Масштабирование пунктов полностью совпадает с MT5 благодаря умножению шага цены на десять для инструментов с 3 или 5 знаками.

## Практические рекомендации
1. Привяжите стратегию к нужному инструменту и задайте подходящий `OrderVolume`.
2. Выберите тип свечей, соответствующий таймфрейму, на котором запускался советник в MetaTrader 5.
3. Настройте временное окно торговли под сессию брокера или желаемые часы работы.
4. Подберите расстояния в пунктах под волатильность инструмента. Большие `TrailingStepPips` замедляют перенос стопа, меньшие заставляют его следовать за ценой плотнее.
5. Отслеживайте сообщения в логах и визуализацию сделок на графике, чтобы контролировать работу стратегии.
