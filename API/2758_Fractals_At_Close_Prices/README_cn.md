# Fractals at Close Prices 策略
[English](README.md) | [Русский](README_ru.md)

## 概述
该策略是 MetaTrader 5 专家顾问 **“Fractals at Close prices”**（作者 Vladimir Karputov）的 StockSharp 版本。策略跟踪连续五根K线的收盘价，并仅使用收盘价来构建 Bill Williams 风格的分形。当最新的多头分形位于上一个多头分形之上时，视为趋势向上；当最新的空头分形位于上一个空头分形之下时，视为趋势向下。在执行新的方向信号前，会先平掉相反方向的仓位，因此策略同一时间只持有多头或空头。

交易只允许发生在可配置的开始小时与结束小时之间。如果当前小时不在时间窗内，策略会立即平掉所有仓位，这与原始EA的行为一致。时间过滤器支持日内区间（start < end）、跨越午夜的区间（start > end）以及全天交易（start == end）。

## 分形判定逻辑
* 每根收盘完成的K线都会被加入一个包含五个元素的滚动队列。
* 当窗口被填满时，会评估中间的收盘价（即两根K线之前的收盘）：
  * 若中间值严格大于两根更早的收盘价，并且大于或等于两根更新的收盘价，则记录一个多头分形。
  * 若中间值严格小于两根更早的收盘价，并且小于或等于两根更新的收盘价，则记录一个空头分形。
* 保存最近与上一个多头分形，以及最近与上一个空头分形，供后续比较。
* 若最新的多头分形高于上一个多头分形，则视为多头趋势；若最新的空头分形低于上一个空头分形，则视为空头趋势。

## 交易规则
1. **开多**
   * 先以市价平掉所有空头仓位。
   * 如果当前没有多头仓位，则在确认多头分形序列的收盘价处买入 `OrderVolume`。
2. **开空**
   * 先以市价平掉所有多头仓位。
   * 如果当前没有空头仓位，则在确认空头分形序列时卖出 `OrderVolume`。
3. **交易时段控制**
   * 在处理信号之前，策略会检查 `candle.OpenTime.Hour` 是否位于时间窗口内。如果不满足条件，则调用 `CloseAllPositions` 并忽略该根K线。

## 风险控制
* 止损和止盈距离以“点”（pip）表示，实现方式与 MT5 相同：当品种具有 3 或 5 位小数时，会将价格最小变动乘以10，再与设置的点数相乘得到真实价格距离。
* 开仓时会把初始止损和止盈价保存在内部变量中。由于 StockSharp 不会像 MT5 那样自动管理保护性订单，策略会在每根K线收盘后检查是否触及这些价格，一旦触及便以市价平仓。
* 移动止损沿用原 EA 的逻辑：当浮动利润超过 `TrailingStop + TrailingStep` 时，将新的止损设为 `close ± TrailingStop`，且仅当新止损与旧止损的距离至少为 `TrailingStep` 时才会更新。
* 当当前时间超出交易窗口时，不论移动止损状态如何，都会立即平掉全部仓位。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `OrderVolume` | 每次市价单的交易量。 | `0.1` |
| `StartHour` | 允许开仓的起始小时（0-23）。若与 `EndHour` 相等则表示全天交易。 | `10` |
| `EndHour` | 停止开仓的小时（0-23）。 | `22` |
| `StopLossPips` | 止损距离（点）。为 `0` 时关闭止损。 | `30` |
| `TakeProfitPips` | 止盈距离（点）。为 `0` 时关闭止盈。 | `50` |
| `TrailingStopPips` | 移动止损的基础距离（点）。为 `0` 时关闭移动止损。 | `15` |
| `TrailingStepPips` | 移动止损每次调整所需的额外利润（点）。 | `5` |
| `CandleType` | 策略订阅的K线类型，默认使用1小时周期。 | `1 hour TimeFrame` |

## 实现说明
* 策略使用高阶 API `SubscribeCandles`，不直接向 `Indicators` 集合注册指标，符合项目约定。
* 止损、止盈和移动止损通过在K线收盘后发送市价单来执行，以模拟 MT5 中的保护性订单行为。
* 时间过滤、分形判定与移动止损逻辑均遵循原始 EA 的结构，包括在时间窗口外强制平仓。
* 点值转换完全复制 MT5 方案：当小数位为 3 或 5 时，将价格步长乘以10，以获得等价的价格距离。

## 使用建议
1. 将策略绑定到目标品种，并设置合适的 `OrderVolume`。
2. 选择与 MT5 中相同的时间周期，以便获得可比的信号。
3. 根据经纪商交易时段或个人需求调整时间窗口。
4. 根据品种波动性调整各项点值参数。较大的 `TrailingStepPips` 会降低移动止损调整频率，较小的数值则会更紧密地跟随价格。
5. 关注日志与可选的图表绘制，以便及时验证策略行为。
