# Стратегия Move Stop Loss

## Обзор
**Move Stop Loss Strategy** — высокоуровневой порт советника `MoveStopLoss.mq5`. Её единственная задача — сопровождать уже открытые позиции, подтягивая защитный стоп-лосс вслед за ценой. Стратегия анализирует завершённые свечи, оценивает волатильность и переносит стоп, когда прибыль превышает заданный порог.

Модуль не открывает новых сделок. Его следует подключать к счёту или другой стратегии, которая выполняет входы. Как только позиция выходит в плюс, стоп-лосс передвигается таким образом, чтобы зафиксировать часть прибыли и одновременно оставить цене пространство для колебаний.

## Источник и особенности конверсии
* Исходный MQL-файл: `MQL/43794/MoveStopLoss.mq5`.
* В MetaTrader перенос стопа выполнялся на каждом тике. Версия StockSharp повторяет проверку по завершённым свечам выбранного таймфрейма (по умолчанию 15 минут, но параметр можно изменить).
* Дистанция трейлинга рассчитывается автоматически по экстремуму ATR или задаётся вручную в «пунктах» инструмента — полностью как в оригинале.
* Вместо графической подписи из MetaTrader используются стандартные привязки к графику и свойство `CurrentTrailingDistance` для диагностики.

## Логика стратегии
1. Подписка на выбранный тип свечей и расчёт ATR с периодом 7.
2. Поддержание скользящего максимума последних 30 значений ATR и умножение пикового значения на коэффициент 0.85 (автоматический режим).
3. При отключённом авто-режиме применяется ручная дистанция в пунктах символа, аналогичная параметру `Distance2Trail` в MQL.
4. Для длинных позиций стоп переносится на уровень `close - distance`, когда цена закрытия выше цены входа и новый стоп лучше предыдущего.
5. Для коротких позиций стоп переносится на уровень `close + distance`, когда цена закрытия ниже цены входа и новый стоп уменьшает риск.
6. Значения стопа выравниваются по шагу цены инструмента, чтобы исключить недопустимые котировки. Внутренние переменные гарантируют, что стоп двигается только в сторону прибыли.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| **AutoTrail** | Включает расчёт дистанции на основе ATR. При `false` используется `ManualDistancePoints`. | `true` |
| **ManualDistancePoints** | Ручная дистанция трейлинга в пунктах символа (300 пунктов ≈ 30 пунктов на пятизнаке). | `300` |
| **AtrPeriod** | Количество свечей в расчёте Average True Range. | `7` |
| **AtrLookback** | Количество последних значений ATR, по которым ищется максимум. | `30` |
| **AtrMultiplier** | Множитель для максимального ATR при вычислении дистанции. | `0.85` |
| **CandleType** | Таймфрейм свечей, используемый в вычислениях. | `15m` |

## Рекомендации по применению
* Подключайте стратегию к инструменту, позиции по которому необходимо защищать. Она работает с агрегированной позицией и средней ценой (`Position`, `PositionPrice`).
* Убедитесь, что автоторговля разрешена и брокер принимает стоп-заявки.
* Комбинируйте модуль с другими стратегиями или ручными входами. Трейлинг включится только после выхода сделки в прибыль.
* Подбирайте `CandleType`, `AtrPeriod` и `AtrLookback` под характер рынка и стиль торговли.
* Метод `StartProtection()` задействует встроенную механику защитных ордеров. Проверьте поддержку стопов на стороне брокера/биржи.

## Диагностика
* Свойство `CurrentTrailingDistance` отображает последнюю применённую дистанцию (в ценовых единицах). Если позиция отсутствует, возвращается `null`.
* На графике отображаются свечи и кривая ATR, что помогает визуально контролировать работу алгоритма.

## Ограничения
* Работа по закрытиям свечей делает перенос стопа менее частым по сравнению с тиковым режимом MetaTrader. При необходимости используйте более мелкий таймфрейм.
* Стратегия предполагает одну совокупную позицию и не управляет частичными ордерами отдельно.
* Ручная дистанция должна быть положительной и всегда приводится к шагу цены.
