# Move Stop Loss 策略

## 概述
**Move Stop Loss Strategy** 是 `MoveStopLoss.mq5` 的 StockSharp 高级 API 移植版本。策略的唯一目的在于为已有头寸提供风控：当交易获得盈利时自动上移（或下移）止损价位。系统只处理已经收盘的 K 线，评估近期波动性，然后在满足条件时向有利方向调整保护性止损。

与大多数交易策略不同，该模块**不会**自行开仓。它适用于已经由其他程序或人工下单的账户，当仓位盈利时，会自动锁定部分收益，同时保留足够的波动空间。

## 来源与转换说明
* 原始 MQL 文件：`MQL/43794/MoveStopLoss.mq5`。
* MQL 版本在每个 tick 上调整止损；本移植版改为在所选周期的收盘时执行同样的检查，默认周期为 15 分钟，可通过参数修改。
* 可选择基于 ATR 峰值自动计算止损距离，或直接输入手动点数（与原始输入 `Distance2Trail` 完全一致）。
* MetaTrader 中的文本标签改为标准图表绑定，同时提供 `CurrentTrailingDistance` 属性用于诊断。

## 策略逻辑
1. 订阅指定类型的 K 线，并计算周期为 7 的 ATR。
2. 跟踪最近 30 个 ATR 值的最高值，在自动模式下乘以 0.85 得到追踪距离。
3. 关闭自动模式时，使用手动输入的点数，直接换算成价格距离。
4. 当多头仓位的收盘价高于建仓价且新的止损高于旧值时，将止损设置为 `close - distance`。
5. 当空头仓位的收盘价低于建仓价且新的止损低于旧值时，将止损设置为 `close + distance`。
6. 所有价格都会按照合约最小变动价位对齐，确保发送的指令有效；内部缓存避免止损向不利方向移动。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| **AutoTrail** | 是否基于 ATR 自动计算追踪距离。关闭后使用 `ManualDistancePoints`。 | `true` |
| **ManualDistancePoints** | 手动追踪距离，单位为品种最小报价点。例如 300 点 ≈ 五位报价中的 30 点（3 个基点）。 | `300` |
| **AtrPeriod** | 计算 ATR 时使用的周期长度。 | `7` |
| **AtrLookback** | 查找 ATR 最大值时保留的历史数量。 | `30` |
| **AtrMultiplier** | 作用于最大 ATR 的乘数，用于得到最终追踪距离。 | `0.85` |
| **CandleType** | 执行分析的 K 线类型（时间框架）。 | `15m` |

## 使用建议
* 将策略附加到需要保护的交易品种，模块会使用聚合的 `Position` 和 `PositionPrice` 信息。
* 确保宿主应用允许自动交易，并且经纪商支持止损指令。
* 可与其他做单策略或人工交易组合使用；只有在仓位盈利时，系统才会移动止损。
* 根据市场波动调整 `CandleType`、`AtrPeriod` 和 `AtrLookback`，以匹配不同的交易风格。
* 通过 `StartProtection()` 启动平台内置的保护机制，使用前请确认账户支持相应的止损委托。

## 诊断
* `CurrentTrailingDistance` 属性返回最近一次应用的追踪距离（价格单位），当没有持仓时返回 `null`。
* 图表上绘制 K 线与 ATR 曲线，便于观察止损随波动的变化。

## 限制
* 由于策略基于收盘价运行，追踪频率可能低于原始 tick 级实现。若需要更细的控制，可以选择更短的时间框架。
* 模块假设账户只有一个净头寸，不会单独管理多个部分仓位。
* 手动距离必须大于零，并会自动对齐到交易品种的最小价位变动。
