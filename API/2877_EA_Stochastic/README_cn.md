# EA Stochastic 策略
[English](README.md) | [Русский](README_ru.md)

这是 MetaTrader「EA Stochastic」专家顾问的 StockSharp 高级 API 版本。策略订阅单一的 K 线序列，读取随机指标数值，
并且始终只保持一笔仓位。当随机指标的主线在多根 K 线中持续位于同一侧阈值时触发开仓。止损、止盈与跟踪止损按点
数实现，尽量还原原始 MQL 逻辑。

## 策略概览

- **指标**：经典随机指标（可设置 %K、%D 周期及最终平滑）
- **方向**：多、空双向
- **持仓**：任意时刻最多一笔仓位（如果已有平仓指令在途，则忽略新的信号）
- **委托类型**：使用固定手数的市价单
- **数据源**：单一用户自选的蜡烛序列（默认 15 分钟）

## 入场逻辑

1. 每根收盘蜡烛都会保存最新的随机指标主线值。
2. 当缓存数量达到 `ComparedBar` 时，将当前值与 `ComparedBar - 1` 根之前的值进行比较。
3. **做多**：当前值和对比值都低于 `UpperLevel`，对应原 EA 只有在随机指标持续低于上限时才买入。
4. **做空**：当前值和对比值都高于 `LowerLevel`，对应原 EA 在随机指标持续高于下限时卖出。
5. 若已有仓位或已经发出平仓指令，则忽略新的入场信号。

## 出场与风控

- **止损**：可选的点数距离，按入场价计算。多单使用蜡烛最低价，空单使用最高价判断触发。
- **止盈**：可选的固定点数目标，利用最高价/最低价模拟 MetaTrader 中的止盈委托行为。
- **跟踪止损**：当浮盈大于 `(TrailingStopPips + TrailingStepPips)` 点时启动，新的止损价位距离最新极值
  `TrailingStopPips` 点，同时必须超过 `TrailingStepPips` 的增量，完全复刻原 EA 的条件。
- **平仓方式**：通过 `SellMarket` / `BuyMarket` 市价单实现。利用标志位避免在仓位尚未确认平掉时重复发送
  指令。

## 参数说明

- `StopLossPips`（默认 **50**）：初始止损距离，0 表示禁用。
- `TakeProfitPips`（默认 **150**）：止盈距离，0 表示禁用。
- `TrailingStopPips`（默认 **15**）：跟踪止损距离，启用跟踪时必须大于 0。
- `TrailingStepPips`（默认 **5**）：每次移动跟踪止损所需的最小盈利增量，若为 0 则禁止开启跟踪。
- `Volume`（默认 **1**）：多空两侧共用的市价单手数。
- `KPeriod`（默认 **5**）：%K 计算周期。
- `DPeriod`（默认 **3**）：%D 平滑周期。
- `Slowing`（默认 **3**）：%K 最终平滑周期。
- `UpperLevel`（默认 **80**）：验证做多信号的阈值。
- `LowerLevel`（默认 **20**）：验证做空信号的阈值。
- `ComparedBar`（默认 **3**）：比较用的蜡烛数量（至少为 1）。
- `CandleType`（默认 **15 分钟蜡烛**）：策略订阅的蜡烛类型。

## 实现细节

- 点值由 `Security.PriceStep` 推算，若步长小于 `0.001`，会乘以 10 以模拟 MetaTrader 中对 3/5 位小数的处理。
- 在启动阶段验证跟踪止损参数，避免出现 `TrailingStop > 0` 且 `TrailingStep = 0` 的配置错误。
- StockSharp 的随机指标采用默认的高/低价范围与简单平滑方式，与 EA 的设置对应。
- 原版 EA 支持按风险百分比计算手数。本移植版本保留固定 `Volume`，需要时可自行扩展。
- 策略会在图表上绘制蜡烛、指标与成交，方便调试与回测分析。

## 使用建议

- 适用于日内到波段级别的周期，请根据品种调整 `CandleType` 与随机指标参数。
- 调整 `UpperLevel`、`LowerLevel` 与 `ComparedBar` 以适配震荡或趋势行情。
- 实盘时建议结合券商端风控，因为策略通过蜡烛收盘后发送市价单来离场。
