# Стратегия Crypto Analysis

## Обзор
Это порт советника MetaTrader 4 «Crypto Analysis» на StockSharp. Алгоритм отслеживает пробои после касания ценой внешней полосы Боллинджера на рабочем таймфрейме при сохранении нисходящей структуры (быстрая LWMA ниже медленной). Сделки разрешаются только при согласии импульса старшего таймфрейма и месячного MACD. Управление позицией включает те же уровни защиты, что и в исходном советнике: стопы по пунктам, денежный трейлинг, перевод в безубыток и контроль просадки портфеля.

## Логика торговли
- **Рабочий таймфрейм:** задаётся параметром (по умолчанию M15). Все правила входа/выхода оцениваются на этих свечах.
- **Триггер волатильности:** минимум предыдущей свечи должен коснуться или пробить нижнюю полосу Боллинджера (20, 2) для подготовки лонга; максимум — верхнюю полосу для шорта.
- **Фильтр тренда:** быстрая LWMA (по умолчанию 6) должна находиться ниже медленной LWMA (85), что повторяет проверку «медвежьего» уклона в MQL-коде.
- **Подтверждение RSI:** RSI(14) выше 50 для покупок и ниже 50 для продаж.
- **Импульс:** максимальное модульное отклонение трёх последних значений Momentum(14) со старшего таймфрейма от уровня 100 должно превышать порог для покупок/продаж.
- **Месячный MACD:** отдельные свечи (по умолчанию 30-дневные) рассчитывают MACD (12, 26, 9); для лонга требуется MACD выше сигнальной линии, для шорта — ниже.
- **Исполнение:** при совпадении всех фильтров открывается рыночная заявка. Противоположная позиция закрывается, чтобы стратегия всегда оставалась в одном нетто-направлении, как и оригинальный советник.

## Управление позицией
- **Первичные уровни:** расстояния стоп-лосса и тейк-профита в пунктах пересчитываются из шага цены с учётом 5- и 3-значных котировок (`0.00001` и `0.001` умножаются на 10).
- **Трейлинг-стоп:** после обновления максимума/минимума стоп подтягивается на расстояние `TrailingStopPips`, причём сохраняется лучший уровень.
- **Безубыток:** при достижении `BreakEvenTriggerPips` стоп переносится на цену входа плюс/минус `BreakEvenOffsetPips`.
- **Денежные цели:** абсолютные и процентные цели закрывают позицию, как только плавающая прибыль достигает заданных уровней.
- **Денежный трейлинг:** после превышения `MoneyTrailTarget` фиксируется максимум прибыли; при откате на `MoneyTrailStop` позиция закрывается.
- **Эквити-стоп:** отслеживается текущее значение портфеля плюс плавающий результат; если просадка от пика превышает `EquityRiskPercent`, позиция закрывается.

## Многотаймфреймовые данные
Стратегия автоматически подписывается на три источника данных:
1. Основной ряд свечей для правил Боллинджера/LWMA/RSI.
2. Старший таймфрейм для фильтра Momentum (по умолчанию H1).
3. Месячные свечи для подтверждения MACD (по умолчанию 30-дневные бары).

## Параметры
| Параметр | Описание |
|----------|----------|
| `OrderVolume` | Базовый объём сделки. Перед сменой направления противоположная позиция закрывается. |
| `UseMoneyTakeProfit` | Включает денежный тейк-профит. |
| `MoneyTakeProfit` | Прибыль в валюте портфеля, при достижении которой позиция закрывается. |
| `UsePercentTakeProfit` | Включает процентный тейк-профит от начального капитала. |
| `PercentTakeProfit` | Процент прибыли, необходимый для закрытия позиции при активном процентном таргете. |
| `EnableMoneyTrailing` | Активирует денежный трейлинг. |
| `MoneyTrailTarget` | Порог прибыли для запуска трейлинга. |
| `MoneyTrailStop` | Допустимый откат прибыли после активации трейлинга. |
| `StopLossPips` | Стоп-лосс в пунктах. |
| `TakeProfitPips` | Тейк-профит в пунктах. |
| `TrailingStopPips` | Дистанция трейлинг-стопа в пунктах. |
| `UseBreakEven` | Включает перевод в безубыток. |
| `BreakEvenTriggerPips` | Количество пунктов прибыли перед переносом стопа. |
| `BreakEvenOffsetPips` | Дополнительные пункты к цене входа при переносе стопа. |
| `FastMaPeriod` | Длина быстрой LWMA по типичной цене. |
| `SlowMaPeriod` | Длина медленной LWMA по типичной цене. |
| `MomentumPeriod` | Период Momentum на старшем таймфрейме. |
| `MomentumBuyThreshold` | Минимальное отклонение Momentum для покупок. |
| `MomentumSellThreshold` | Минимальное отклонение Momentum для продаж. |
| `MacdFastLength` | Быстрая EMA в MACD фильтре. |
| `MacdSlowLength` | Медленная EMA в MACD фильтре. |
| `MacdSignalLength` | Сигнальная EMA в MACD фильтре. |
| `UseEquityStop` | Включает защиту по просадке портфеля. |
| `EquityRiskPercent` | Допустимый процент просадки капитала до принудительного закрытия. |
| `CandleType` | Основной таймфрейм. |
| `MomentumCandleType` | Таймфрейм для Momentum. |
| `MacdCandleType` | Таймфрейм для MACD. |

## Примечания
- Порт StockSharp поддерживает только одну нетто-позицию, аналогично оригинальному советнику, который закрывал противоположные ордера перед открытием новых.
- Все правила защиты рассчитываются на закрытии свечи, повторяя обработку «нового бара» из MQL.
- Для инструментов с нестандартным шагом цены скорректируйте параметры в пунктах под спецификацию биржи.
