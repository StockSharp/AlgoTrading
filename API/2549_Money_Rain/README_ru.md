# Стратегия Money Rain

## Обзор
- Конвертация оригинального эксперта **MoneyRain (редакция barabashkakvn)** с MQL5 на высокоуровневый API StockSharp.
- Направление выбирается по осциллятору DeMarker: значения выше 0.5 открывают длинные позиции, значения 0.5 и ниже — короткие.
- Одновременно поддерживается только одна позиция, фиксация прибыли и убытка выполняется по фиксированным отступам в пунктах.

## Данные и индикаторы
- Подписка на тип свечей `CandleType` (по умолчанию 30-минутные бары).
- Расчёт индикатора `DeMarker` с параметром `DeMarkerPeriod` (по умолчанию 31).
- Дополнительная подписка на поток Level 1 для оценки текущего спреда — он нужен блоку адаптивного мани-менеджмента.

## Торговая логика
1. Обрабатываются только завершённые свечи, что соответствует исходной проверке `iTime(0)` в MQL.
2. Пока позиция открыта, стратегия сравнивает максимум/минимум свечи с заранее рассчитанными уровнями стоп-лосса и тейк-профита. При касании уровень закрывает позицию рыночной заявкой и помечает сделку как прибыльную или убыточную.
3. Когда позиций нет и лимит подряд идущих убытков не превышен, вычисляется рабочий объём сделки.
4. Условие входа: `DeMarker > 0.5` — покупка, иначе — продажа. Перед отправкой рыночного ордера отменяются все активные заявки.

## Управление капиталом
- Восстановлена логика `getLots()` из MQL за счёт отслеживания:
  - `_lossesVolume` — суммарный объём последних убыточных сделок, нормированный на базовый лот.
  - `_consecutiveLosses` и `_consecutiveProfits` — счётчики серий, позволяющие сбрасывать накопленный объём после нескольких прибыльных сделок.
- Если после серии убытков появляется первая прибыль (`_consecutiveProfits == 0`), следующий объём увеличивается по формуле:
  \[
  \text{volume} = \text{BaseVolume} \times \frac{_lossesVolume \times (\text{StopLossPoints} + \text{spread})}{\text{TakeProfitPoints} - \text{spread}}
  \]
- Спред оценивается по лучшим bid/ask (в пунктах). Если котировки Level 1 ещё не получены, спред равен нулю.
- Параметр `FastOptimize = true` отключает адаптивное изменение объёма и всегда использует базовый лот.

## Риск-менеджмент
- `StopLossPoints` и `TakeProfitPoints` переводятся в абсолютную цену через шаг цены инструмента. При 3- или 5-знаковом котировании добавляется множитель 10 (как и в оригинале через `digits_adjust`).
- `LossLimit` останавливает торговлю, если количество подряд идущих убыточных сделок превышает заданный порог (по умолчанию практический «бесконечный» лимит 1 000 000).

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `DeMarkerPeriod` | Период сглаживания индикатора DeMarker. | 31 |
| `TakeProfitPoints` | Отступ тейк-профита в пунктах. | 5 |
| `StopLossPoints` | Отступ стоп-лосса в пунктах. | 20 |
| `BaseVolume` | Базовый объём заявки (лот). | 0.01 |
| `LossLimit` | Максимум подряд идущих убытков перед остановкой. | 1 000 000 |
| `FastOptimize` | При `true` отключает адаптивное изменение объёма. | `false` |
| `CandleType` | Тип свечей для расчётов. | 30-минутные свечи |

## Особенности реализации
- Уровни стопа и тейка контролируются по диапазону свечи. Порядок касания внутри бара восстановить невозможно, поэтому в случае одновременного достижения уровней приоритет отдаётся стоп-лоссу (консервативная оценка).
- Метод `OnOwnTradeReceived` позволяет отследить завершение защитного выхода и обновить счётчики серий и накопленный объём.
- Код придерживается табуляции и содержит комментарии только на английском языке согласно требованиям репозитория.

## Состав каталога
- `CS/MoneyRainStrategy.cs` — реализация стратегии.
- `README.md` / `README_ru.md` / `README_cn.md` — документация на трёх языках.

## Отличия от версии MQL
- Защитные ордера брокера заменены рыночными выходами, которые проверяются по диапазону свечи.
- Спред берётся из Level 1, а не из свойств символа терминала MetaTrader.
- Исключены отправка почты и прямые проверки `IsTradeAllowed` — в инфраструктуре StockSharp за это отвечает среда исполнения.
