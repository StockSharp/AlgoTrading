# Стратегия MARE5.1

## Обзор
MARE5.1 — порт оригинального советника MetaTrader 4 `MARE5_1.mq4` на платформу StockSharp. Базовый алгоритм работал на минутных данных, сравнивал две скользящие средние на нескольких исторических сдвигах и по смене доминирующего направления открывал сделку. В C#-версии все ключевые параметры вынесены в свойства стратегии, добавлена привязка защитных приказов в «пунктах» MetaTrader и реализован гибкий фильтр торговых часов.

## Логика торговли
1. **Рыночные данные**
   - Подписка ведётся на один тип свечей, задаваемый параметром `CandleType` (по умолчанию — 1 минута).
   - Обработка выполняется только по завершённым свечам, чтобы исключить влияние незакрытых баров.
2. **Индикаторы**
   - Используются две `SimpleMovingAverage`: быстрая (`FastPeriod`) и медленная (`SlowPeriod`).
   - Обе кривые сдвигаются вперёд на количество баров `MovingAverageShift` — это точный аналог параметра `ma_shift` функции `iMA` в MQL4.
   - Дополнительно рассчитываются значения со сдвигами `MovingAverageShift + 2` и `MovingAverageShift + 5`, что соответствует вызовам `iMA(..., shift=2/5)` в оригинальном коде.
3. **Формирование сигналов**
   - Разница между кривыми должна быть не меньше одного шага цены инструмента (`Point` в терминологии MetaTrader). Если у инструмента `PriceStep` равен нулю, достаточно любого положительного разрыва.
   - **Продажа:**
     - Предыдущая свеча медвежья (`Close < Open`).
     - Текущее сдвинутое значение медленной средней выше быстрой.
     - На расстоянии двух и пяти свечей назад быстрая средняя всё ещё была выше медленной, что указывает на смену доминирующего тренда.
   - **Покупка:**
     - Предыдущая свеча бычья (`Close > Open`).
     - Текущее сдвинутое значение быстрой средней выше медленной.
     - На расстоянии двух и пяти свечей назад медленная средняя доминировала, что подтверждает переход от нисходящего к восходящему движению.
   - Одновременно допускается только одна открытая позиция — аналог условия `OrdersTotal() < 1` в MetaTrader.
4. **Торговое окно**
   - Свеча рассматривается только если час её закрытия попадает в интервал `[TimeOpenHour, TimeCloseHour]`.
   - Если значение `TimeCloseHour` меньше `TimeOpenHour`, окно трактуется как ночное (например, с `22` до `5` часов).

## Управление рисками
- Метод `StartProtection` привязывает стоп-лосс и тейк-профит, переводя указанные в «пунктах» расстояния (`StopLossPoints`, `TakeProfitPoints`) в абсолютные цены через `PriceStep` инструмента.
- Параметр `TrailingStop` из исходного советника намеренно не реализован, поскольку в MQL-коде он не использовался.
- Стратегия всегда выставляет фиксированный объём `TradeVolume` и не наращивает позиции.

## Параметры
| Имя | Описание | Значение по умолчанию | Примечания |
| --- | --- | --- | --- |
| `TradeVolume` | Лот для рыночных заявок. | `7.8` | Корректируется коннектором в соответствии с биржевыми ограничениями. |
| `FastPeriod` | Период быстрой простой скользящей средней. | `13` | Отвечает за чувствительность к изменениям цены. |
| `SlowPeriod` | Период медленной простой скользящей средней. | `55` | Формирует долгосрочный фон. |
| `MovingAverageShift` | Прямой сдвиг, применяемый к обеим средним. | `2` | Полный аналог `ma_shift` в функции `iMA`. |
| `StopLossPoints` | Расстояние до стоп-лосса в пунктах MetaTrader. | `80` | Умножается на шаг цены, чтобы получить абсолютный офсет. |
| `TakeProfitPoints` | Расстояние до тейк-профита в пунктах MetaTrader. | `110` | Значение `0` отключает тейк-профит. |
| `TimeOpenHour` | Час начала торгового окна (0–23). | `8` | Сравнивается с часом закрытия свечи. |
| `TimeCloseHour` | Час окончания торгового окна (0–23). | `14` | Может быть меньше `TimeOpenHour` для ночных сессий. |
| `CandleType` | Таймфрейм подписки на свечи. | `1 минута` | Можно указать любой другой `TimeFrame()`. |

## Особенности реализации
- Для воспроизведения исторических сдвигов используется индикатор `Shift`, что избавляет от прямой работы с буферами индикатора.
- Функция `IsDifferenceSatisfied` инкапсулирует проверку порога в пунктах и делает логику устойчивой к различным шагам цены.
- Проверка торгового окна опирается на время закрытия свечи — это наиболее близкий аналог функции `Hour()` при работе только с завершёнными барами.
- Код полностью построен на высокоуровневом API (`SubscribeCandles().Bind(...)`) и снабжён комментариями на английском языке согласно требованиям репозитория.

## Отличия от версии на MQL
- Сигналы вычисляются по закрытым свечам, что исключает возможные перерисовки, возникавшие на тиках в MetaTrader.
- Защитные приказы управляются `StartProtection`, а не устанавливаются вручную в каждом вызове `OrderSend`.
- Неиспользуемый параметр `TrailingStop` исключён, чтобы не вводить в заблуждение пользователя.
- Логика торгового окна поддерживает ночные промежутки, тогда как исходный код подразумевал `TimeOpen <= TimeClose`.
