# Стратегия SaveTicks
[English](README.md) | [中文](README_cn.md)

Периодически сохраняет лучшие цены Bid/Ask и последнюю цену сделки для выбранных инструментов в файлы CSV и BIN. Предназначена для построения архивов тиковых данных и не выполняет торговых операций.

## Подробности

- **Назначение**: циклически записывать лучшие котировки и цену последней сделки для заданного списка инструментов.
- **Источники данных**: подписка Level1 на каждый инструмент, обеспечивающая поток котировок и последнюю цену сделки.
- **Планировщик**: внутренний таймер с периодом `Recording Interval` инициирует запись актуального снимка в файлы.
- **Результаты работы**:
  - Отдельный CSV-файл на каждый инструмент со столбцами: метка времени, bid, ask, last.
  - Необязательный бинарный файл с теми же полями и флагами наличия значений.
  - Вспомогательный список всех инструментов `AllSymbols_<StrategyName>.txt`.
- **Поддерживаемые списки**: основной инструмент стратегии, вручную заданный список или идентификаторы из текстового файла.
- **Торговая активность**: отсутствует — стратегия только получает маркет-данные.

## Параметры

- **Recording Interval** (`TimeSpan`, по умолчанию 500 мс)
  - Период между снимками. Должен быть больше нуля.
- **Symbol Selection** (`MainSecurity` | `ManualList` | `FromFile`)
  - Определяет, каким образом формируется список инструментов.
    - `MainSecurity`: записывать только инструмент, назначенный стратегии.
    - `ManualList`: использовать строку `Symbols List` (значения через запятую, точку с запятой, пробел или перевод строки). Основной инструмент добавляется автоматически.
    - `FromFile`: загрузить идентификаторы из файла `Symbols File`.
- **Symbols List** (`string`)
  - Дополнительные тикеры для режима `ManualList`.
- **Symbols File** (`string`, по умолчанию `InputSymbolList.txt`)
  - Путь к текстовому файлу: первая строка — количество инструментов, далее по одному идентификатору на строку. Относительные пути сначала ищутся в папке выгрузки, затем в текущем каталоге.
- **Recording Format** (`Csv` | `Binary` | `All`)
  - Включает запись только в CSV, только в BIN или одновременно в оба формата.
- **Time Format** (`Server` | `Local`)
  - Выбор между серверной и локальной меткой времени в файлах.
- **Output Directory** (`string`, по умолчанию `<рабочий каталог>/ticks`)
  - Папка для сохранения файлов. Создаётся автоматически.

## Последовательность работы

1. Сформировать перечень инструментов согласно настройке `Symbol Selection` (при необходимости через `SecurityProvider.LookupById`).
2. Проверить, что `Recording Interval` > 0 и список инструментов не пуст.
3. Создать директорию вывода и записать файл-список `AllSymbols_<StrategyName>.txt`.
4. Открыть файловые потоки для каждого инструмента по шаблону `<symbol>_<strategy>.csv` / `.bin`.
5. Подписаться на Level1 и обновлять внутренний снимок при каждом изменении Bid, Ask или Last.
6. Таймер с заданным периодом записывает накопленный снимок в файлы, используя выбранный формат времени.
7. При остановке или сбросе таймер и файловые дескрипторы закрываются корректно.

## Рекомендации

- Убедитесь, что коннектор поставляет поток Level1 для всех инструментов, иначе данные не будут записаны.
- Бинарный формат содержит отметку времени в миллисекундах Unix и флаги наличия Bid/Ask/Last, что облегчает последующий разбор.
- Формат файла со списком инструментов соответствует оригинальному скрипту MQL: число строк и список тикеров.
- Стратегию можно запускать параллельно с торговыми алгоритмами для накопления данных без вмешательства в торговлю.
- В именах файлов все недопустимые символы заменяются на подчёркивания.
