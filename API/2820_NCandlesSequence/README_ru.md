# Стратегия последовательности N свечей

## Обзор
Стратегия последовательности N свечей повторяет логику советника MetaTrader «N-_Candles_v7», но реализована на высокоуровневом API StockSharp. Она анализирует завершённые свечи, ищет заданное количество подряд идущих бычьих или медвежьих тел и при появлении такого паттерна открывает позицию в сторону серии. Управление позицией выполняется с помощью параметров стоп-лосса, тейк-профита, трейлинг-стопа, фильтра торговых часов и ограничения по плавающей прибыли.

## Логика торговли
- Каждую завершённую свечу стратегия классифицирует как бычью, медвежью или нейтральную (доджи). Доджи сбрасывает счётчик и может активировать «black sheep» обработку.
- Ведётся подсчёт подряд идущих свечей одного направления. Когда количество достигает значения `ConsecutiveCandles`, текущий знак становится активным паттерном.
- При активной бычьей серии открывается длинная позиция, при медвежьей — короткая. Одновременно удерживается только одна нетто-позиция.
- Если появляется свеча, нарушающая однородность ("black sheep"), выполняется выбранный сценарий закрытия: закрыть все позиции, закрыть только противоположные или закрыть позиции в направлении серии.
- При включённом фильтре торговых часов сделки допускаются только между `StartHour` и `EndHour` (включительно).
- Во время удержания позиции контролируются тейк-профит, стоп-лосс, обновление трейлинг-стопа и порог `MinProfit` по плавающей прибыли.

## Управление рисками
- Стоп-лосс и тейк-профит рассчитываются в пунктах и преобразуются в цену через `PriceStep` инструмента. Значения пересчитываются при каждом входе.
- Трейлинг-стоп повторяет механику оригинального советника: после прохождения ценой расстояния `TrailingStop + TrailingStep` стоп переносится, сохраняя исходный отступ.
- Порог `MinProfit` закрывает позицию, когда плавающая прибыль достигает указанного уровня.
- `MaxPositionVolume` не позволяет разместить заявку, если объём превышает лимит. Параметр `MaxPositions` защищает от повторного входа, пока уже есть открытая позиция (реализация использует неттинг).
- Закрытия выполняются рыночными ордерами, что соответствует неттинговой модели StockSharp.

## Параметры
| Имя | Описание |
| --- | --- |
| `ConsecutiveCandles` | Число подряд идущих однонаправленных свечей, необходимое для сигнала. |
| `OrderVolume` | Объём рыночной заявки при входе и выходе. |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах (0 — отключить). |
| `StopLossPips` | Дистанция стоп-лосса в пунктах (0 — отключить). |
| `TrailingStopPips` | Базовая дистанция трейлинг-стопа (0 — отключить). |
| `TrailingStepPips` | Дополнительный шаг перед переносом трейлинг-стопа. |
| `MaxPositions` | Максимальное число одновременных входов (держится одна нетто-позиция). |
| `MaxPositionVolume` | Максимально допустимый объём позиции. |
| `UseTradeHours` / `StartHour` / `EndHour` | Включение и настройка торгового окна (часы включительно). |
| `MinProfit` | Порог плавающей прибыли, при достижении которого позиция закрывается. |
| `ClosingBehavior` | Поведение при появлении "black sheep" свечи. |
| `CandleType` | Тип свечей для расчётов. |

## Примечания
- В отличие от оригинального эксперта, стратегия оперирует единственной нетто-позицией и не открывает несколько хеджирующих ордеров.
- Плавающая прибыль оценивается как `(текущая цена - цена входа) * объём` для длинных позиций и обратная формула для коротких.
- Для преобразования пунктов используется `PriceStep`. Если шаг цены не задан, применяется значение 0.0001.
- По требованию Python-версия и соответствующая папка не создавались.
