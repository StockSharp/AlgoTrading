# N根同向K线策略

## 概述
N根同向K线策略复刻了 MetaTrader 专家顾问 “N-_Candles_v7” 的核心逻辑，并基于 StockSharp 高阶 API 重新实现。策略在每根K线收盘后统计连续的多头或空头实体数量，当连续数量达到设定阈值时，在同方向开仓，并结合止盈、止损、跟踪止损、交易时段过滤以及浮动盈亏保护进行仓位管理。

## 交易逻辑
- 对每根已收盘K线进行分类：看涨、看跌或十字星。十字星会重置计数，并可能触发“黑羊”处理逻辑。
- 维护连续同向K线的计数器，一旦达到设定的 `ConsecutiveCandles` 值，就认为出现有效的趋势模式。
- 在看涨序列有效时尝试开多头仓位；看跌序列有效时尝试开空头仓位。策略始终只持有一个净头寸。
- 当出现破坏序列方向的“黑羊”K线时，根据 `ClosingBehavior` 的设置执行不同的平仓方案：全部平仓、仅平掉与序列方向相反的仓位或仅平掉顺势仓位。
- 可选地启用交易时段过滤，仅在 `StartHour` 与 `EndHour`（含端点）之间允许入场。
- 持仓期间持续监测止盈、止损、跟踪止损，以及 `MinProfit` 配置的浮动盈利阈值。

## 风险与仓位管理
- 止损与止盈距离以“点”（pip）为单位，并结合品种的 `PriceStep` 换算成价格距离，每次开仓时重新计算。
- 跟踪止损规则与原版EA一致：当价格前进超过“跟踪距离 + 跟踪步长”时，将止损上移/下移以保持既定距离。
- 浮动盈利守护 (`MinProfit`) 在未实现盈亏超过阈值时立即平掉全部仓位。
- `MaxPositionVolume` 限制下单手数，`MaxPositions` 防止在已有净仓位时再次开仓（本实现采用净仓机制）。
- 所有离场动作均通过市价单完成，以适配 StockSharp 的净持仓模型。

## 参数说明
| 参数 | 说明 |
| --- | --- |
| `ConsecutiveCandles` | 触发信号所需的连续同方向K线数量。 |
| `OrderVolume` | 每次下单的手数。 |
| `TakeProfitPips` | 止盈距离（pip），设为0则关闭止盈。 |
| `StopLossPips` | 止损距离（pip），设为0则关闭止损。 |
| `TrailingStopPips` | 跟踪止损的基础距离，设为0则关闭跟踪。 |
| `TrailingStepPips` | 触发更新跟踪止损所需的额外距离。 |
| `MaxPositions` | 同一方向允许的最大净仓位数（策略保持单一净仓位）。 |
| `MaxPositionVolume` | 可接受的最大净手数。 |
| `UseTradeHours` / `StartHour` / `EndHour` | 是否启用及设置交易时段（含起止小时）。 |
| `MinProfit` | 达到该浮动盈利后立即平仓。 |
| `ClosingBehavior` | “黑羊”出现时的平仓方式。 |
| `CandleType` | 用于计算的K线类型。 |

## 说明与假设
- 策略仅使用净仓位，无法像原EA那样在同一方向叠加多笔对冲仓位。
- 浮动盈亏按 `(当前价格 - 入场价格) * 手数`（多头）或反向公式（空头）估算。
- 点值转换依赖于品种的 `PriceStep`。若未提供最小跳动，则默认使用 0.0001。
- 按要求本次仅提供 C# 版本，未创建 Python 版本或目录。
