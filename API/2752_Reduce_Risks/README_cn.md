# Reduce Risks 策略

## 概述
Reduce Risks 策略源自 MetaTrader 专家顾问“Reduce_risks.mq5”，并移植到 StockSharp 高级 API。策略以 1 分钟蜡烛图为核心，辅以 15 分钟和 1 小时的趋势过滤，旨在在波动较低、结构明确的阶段参与趋势行情。推荐应用于流动性充足、点值明确的外汇品种，例如 EURUSD、USDCHF、USDJPY。

## 时间框架与适用市场
- **主周期：** 1 分钟 K 线用于触发交易。
- **确认周期：** 15 分钟 K 线用于判断波段位置。
- **趋势过滤：** 1 小时 K 线验证更大级别方向。
- **推荐市场：** 点值与主流外汇类似的品种，必要时需调整点值参数。

## 指标与数据
- M1：SMA(5)、SMA(8)、SMA(13)、SMA(60)，按典型价格 (高+低+收)/3 计算。
- M15：SMA(4)、SMA(5)、SMA(8) ，同样使用典型价格。
- H1：SMA(24) 作为趋势均线。
- 蜡烛结构统计：包括实体长度、影线、区间等。
- 记录入场后的最高价/最低价，用于实现原始 MQL 策略的回撤退出逻辑。

## 入场条件
### 做多
1. M1、M15 最近三根蜡烛的波动必须低于 20/30 点，且 M15 近三根的整体区间不超过 30 点。
2. 当前价格突破前一根 M1 与 M15 的高点，同时前一根 M1 蜡烛的区间大于 1.1 倍但小于 3 倍倒数第二根蜡烛。
3. 均线层级呈多头排列：SMA5 > SMA8 > SMA13，SMA60 上升，收盘价位于全部均线之上。
4. M15 的 SMA4 上升且高于 SMA8；当前价格高于 SMA4(M15) 及 SMA24(H1)。
5. 波段确认：SMA8(M1) 在过去三根任意一根蜡烛范围内交叉，SMA5(M15) 位于上一根 M15 蜡烛范围内。
6. 结构过滤：上一根 M1、M15 蜡烛实体大于整体区间一半，并形成更高的高点，回调不超过区间的 25%，且存在影线。
7. 所有条件同时满足且无持仓时，执行市价买入。

### 做空
条件与做多完全对称：价格向下突破支撑，均线呈空头排列 (SMA5 < SMA8 < SMA13，SMA60 下降)，价格低于所有均线，上一根 M1、M15 蜡烛显示出明显的空头结构 (更低的低点、实体大、回调小、有影线)。满足条件后执行市价卖出。

## 平仓规则
- StopLossPips 与 TakeProfitPips 对应的保护性止损/止盈通过 StartProtection 自动下达。
- 额外的退出逻辑复刻原策略：
  - 做多：若当前 M1 蜡烛从开盘价下跌 ≥10 点，或开仓超过 1 分钟后出现强烈下跌蜡烛，则平仓。
  - 做多：盈利 ≥10 点时可提前获利；若出现从入场后最高价回撤 ≥20 点且该高点高于入场价，也会触发退出。
  - 做多：若浮亏 ≥20 点，或权益跌破风险阈值，也立即平仓。做空规则取镜像处理。

## 风险管理
- 当投资组合权益 ≤ `InitialDeposit * (1 - RiskPercent/100)` 时，策略会阻止新的入场，并在达到阈值时强制平掉持仓。
- 原版中关于终端连接、交易权限的检测在 StockSharp 中无需重复实现。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `StopLossPips` | 止损点数。 | `30` |
| `TakeProfitPips` | 止盈点数。 | `60` |
| `InitialDeposit` | 用于计算风险阈值的基准资金。 | `10000` |
| `RiskPercent` | 相对于基准资金的最大允许回撤百分比。 | `5` |
| `M1CandleType` | 主周期 M1 数据类型。 | 1 分钟 |
| `M15CandleType` | 15 分钟确认周期的数据类型。 | 15 分钟 |
| `H1CandleType` | 1 小时趋势过滤的数据类型。 | 1 小时 |

## 其他说明
- 若标的点值不同，请相应调整基于点数的参数。
- 仅提供 C# 版本，依照要求未创建 Python 版本及其目录。
