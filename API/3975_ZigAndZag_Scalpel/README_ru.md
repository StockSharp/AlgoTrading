# Стратегия ZigAndZag Scalpel

## Описание
ZigAndZagScalpelStrategy — это порт комплекта MetaTrader 4 "ZigAndZag" (папка 8304) на StockSharp.
В оригинал входят индикатор и советник. Используются два ZigZag:

* **KeelOver** — долгий диапазон, формирующий тренд.
* **Slalom** — короткий диапазон, задающий точки входа.

Когда длинный ZigZag разворачивается вверх, стратегия отслеживает ближайший минимум Slalom и ждёт,
когда цена поднимется на заданное количество пунктов выше поворотной точки. После пробоя открывается
покупка. Зеркальное условие открывает продажу: тренд KeelOver вниз, Slalom печатает новый максимум и
цена падает ниже него. Позиция может быть закрыта при появлении противоположного Slalom-пивота, что
повторяет удаление стрелок лимит-ордеров в индикаторе.

Сохранён суточный лимитер сделок из советника. За торговый день разрешено не более заданного числа
входов, счётчик автоматически сбрасывается в полночь (временная зона площадки), как и флаг `newday`
в MQL.

## Как работает стратегия
1. Подписываемся на основной поток свечей `CandleType`.
2. Запускаем два `ZigZagIndicator`:
   * Глубина = `KeelOverLength` для определения тренда.
   * Глубина = `SlalomLength` для точек входа.
3. Последний пивот KeelOver задаёт направление тренда: минимум — рост, максимум — падение.
4. При появлении нового пивота Slalom активируется ожидание пробоя в его сторону.
5. Считается взвешенная цена `(5×Close + 2×Open + High + Low) / 9`. Если цена уходит дальше, чем
   `BreakoutDistancePoints` (переведённые в цену), и тренд подтверждает движение, выставляется
   рыночный ордер.
6. Текущая позиция закрывается при смене глобального тренда или при противоположном пивоте Slalom,
   если `CloseOnOppositePivot = true`.
7. Суточный счётчик сделок обновляется при каждой смене календарного дня.

Параметры `DeviationPoints` и `Backstep` общие для обоих ZigZag, поэтому структура пивотов совпадает
с буферами индикатора MetaTrader.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --------------------- | -------- |
| `CandleType` | `15m` | Таймфрейм свечей для обоих ZigZag. |
| `KeelOverLength` | `55` | Длина ZigZag, формирующего тренд (параметр KeelOver). |
| `SlalomLength` | `17` | Длина ZigZag, формирующего вход (параметр Slalom). |
| `DeviationPoints` | `5` | Минимальное движение в пунктах для фиксации нового пивота. |
| `Backstep` | `3` | Минимальное число баров между соседними пивотами. |
| `BreakoutDistancePoints` | `2` | Отступ от пивота в пунктах перед открытием сделки. |
| `MaxTradesPerDay` | `1` | Максимум сделок в сутки. Аналог флага `newday`. |
| `CloseOnOppositePivot` | `true` | Закрывать позицию при противоположном пивоте Slalom. |

Все параметры в пунктах умножаются на `Security.PriceStep`. Если шаг цены не задан, используется `1`
для упрощённого тестирования.

## Практические замечания
* Сделки открываются рыночными ордерами (`BuyMarket` / `SellMarket`). Добавьте собственные стопы и
  сопровождение при необходимости.
* Оба ZigZag используют одинаковые свечи. Убедитесь, что поставщик данных поддерживает выбранный
  `CandleType`.
* Значение `MaxTradesPerDay = 1` полностью копирует поведение оригинала. Увеличьте лимит для
  многократных входов в течение дня.
* Установите `CloseOnOppositePivot = false`, если хотите держать позицию до смены глобального тренда
  и игнорировать мелкие колебания.

## Отличия от советника MT4
* MetaTrader выставлял отложенные лимит-ордера. В StockSharp используется немедленный вход по рынку,
  чтобы остаться в рамках High Level API.
* Управление рисками (стопы, часть объёма) не переносилось. Используйте стандартные компоненты
  StockSharp для управления капиталом.
* Буферы индикатора заменены прямой логикой стратегии и отрисовкой через `DrawIndicator` и
  `DrawOwnTrades`.

## Возможные расширения
* Добавьте параметры стоп-лосса/тейк-профита на основе ATR или последних пивотов ZigZag.
* Для визуального сравнения выставьте `BreakoutDistancePoints = 0`, чтобы видеть чистую лестницу
  пивотов.
* Совместите стратегию с фильтром торговых сессий (`IsFormedAndOnlineAndAllowTrading`).
