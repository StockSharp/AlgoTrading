# Стратегия «Один ценовой уровень для SL/TP»
[English](README.md) | [中文](README_cn.md)

Утилита воспроизводит скрипт MetaTrader «One Price SL TP» в экосистеме StockSharp. Стратегия не открывает сделки самостоятельно, а наблюдает за текущей позицией по выбранному инструменту и следит, чтобы обе защитные заявки соответствовали единому целевому уровню, заданному пользователем.

Как только параметр **`ZenPrice`** принимает положительное значение, стратегия сравнивает его с актуальными котировками:

- Для **длинной** позиции: если `ZenPrice` выше ask, выставляется лимитная заявка take-profit на указанной цене; если `ZenPrice` ниже bid, размещается стоп-заявка stop-loss.
- Для **короткой** позиции: если `ZenPrice` ниже bid, на этой цене размещается лимитный take-profit; если `ZenPrice` выше ask, уровень используется как стоповый stop-loss.

Если уровень попадает между bid и ask, никаких действий не выполняется, и существующая защита сохраняется. После закрытия позиции или возврата параметра к нулю все защитные заявки автоматически снимаются.

## Алгоритм работы

1. Подписывается на поток Level1, чтобы получать свежие значения bid/ask, необходимые для проверки направлений.
2. Отслеживает объём и направление текущей позиции. Предполагается, что входы совершаются вручную либо другими стратегиями.
3. При каждом обновлении котировки, позиции или собственной сделки определяет, к какой стороне рынка относится `ZenPrice`, и подбирает соответствующий тип защитной заявки.
4. Приводит цену к шагу цены инструмента и округляет объём в рамках биржевых ограничений перед отправкой запроса в коннектор.
5. Использует `ReRegisterOrder` для изменения уже активных защитных заявок без их отмены, что повторяет механизм MetaTrader по модификации ордеров на месте.

## Параметр

- **`ZenPrice`** – абсолютный ценовой уровень, который нужно использовать как stop-loss или take-profit. Значение `0` отключает автоматизацию. Значение по умолчанию: `0`.

## Практические замечания

- Стратегия никогда не подаёт заявки на вход в рынок, поэтому её можно запускать параллельно с ручной торговлей или другими роботами.
- Защитные заявки формируются только после получения первого снимка Level1 с обеими котировками bid и ask. До этого момента алгоритм ждёт, аналогично исходному MQL-скрипту.
- Если условие выполняется только для одной стороны (например, `ZenPrice` выше ask, но не ниже bid), противоположная защитная заявка отменяется, чтобы не оставлять устаревшие уровни.
- Все комментарии в коде написаны на английском языке, тогда как документация доступна на нескольких языках в соответствии с требованиями проекта.

## Отличия от скрипта MetaTrader

- Оригинальный скрипт изменяет поля stop-loss и take-profit у существующей позиции. В StockSharp защитные уровни представляются отдельными стоповыми и лимитными заявками, поэтому конвертация управляет именно биржевыми ордерами.
- В MetaTrader цена автоматически приводится к точности брокера. Здесь аналогичный эффект достигается через `NormalizePrice`, который использует шаг цены и количество знаков инструмента.
- Перед отправкой защитные заявки получают объём, округлённый до допустимого шага лота, что обеспечивает совместимость с площадками, требующими фиксированные размеры контрактов.
