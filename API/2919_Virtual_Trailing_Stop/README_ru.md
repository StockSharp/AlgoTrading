# Стратегия «Виртуальный трейлинг-стоп»

## Общее описание
**Виртуальный трейлинг-стоп** — портирование эксперта MetaTrader `Virtual Trailing Stop.mq5` (MQL ID 21362) на платформу StockSharp. Исходный советник не открывал сделки, а лишь сопровождал уже существующие позиции, рассчитывая «виртуальные» стоп-приказы. Версия на C# повторяет этот подход: стратегия отслеживает лучшие котировки bid/ask и закрывает позицию рыночными заявками при срабатывании стоп-лосса, тейк-профита или трейлинг-стопа.

Стратегия никогда не инициирует входов. Её задача — обеспечить автоматическое сопровождение позиций, созданных вручную или другими модулями, но в инфраструктуре StockSharp (Designer, Shell, Runner).

## Логика работы
1. **Подписка на Level1** – стратегия получает поток лучших цен и сохраняет последние значения bid/ask.
2. **Перевод параметров в цену** – все входы задаются в пипсах. Значение умножается на `PriceStep`. Для инструментов с 3 и 5 знаками после запятой используется дополнительный множитель ×10, чтобы соответствовать определению pip в MetaTrader.
3. **Контроль стоп-лосса** – длинная позиция закрывается, если bid ≤ `цена входа − StopLoss`, короткая – если ask ≥ `цена входа + StopLoss`.
4. **Контроль тейк-профита** – длинная позиция закрывается при bid ≥ `цена входа + TakeProfit`, короткая – при ask ≤ `цена входа − TakeProfit`.
5. **Активация трейлинга** – как только плавающая прибыль достигла `TrailingStart` пипсов, формируется виртуальный уровень трейлинг-стопа (`bid − TrailingStop` для long, `ask + TrailingStop` для short).
6. **Сдвиг трейлинга** – при увеличении прибыли минимум на `TrailingStep` пипсов уровень сдвигается вслед за ценой. Нулевое значение означает непрерывный трейлинг.
7. **Выход по трейлингу** – позиция закрывается, когда цена касается уровня трейлинга и сделка остаётся прибыльной (аналог проверки `Profit()>0` в исходном коде).

Никакие стоп-ордера на биржу не отправляются — выход всегда осуществляется рыночной заявкой, сохраняя «виртуальный» характер сопровождения.

## Параметры
| Параметр | Назначение | Значение по умолчанию |
| --- | --- | --- |
| `StopLossPips` | Расстояние до стоп-лосса в пипсах. `0` отключает жёсткий стоп. | `0` |
| `TakeProfitPips` | Расстояние до тейк-профита в пипсах. `0` отключает тейк-профит. | `0` |
| `TrailingStopPips` | Дистанция между ценой и трейлинг-уровнем в пипсах. | `5` |
| `TrailingStartPips` | Минимальная прибыль (в пипсах) для запуска трейлинга. | `5` |
| `TrailingStepPips` | Минимальный шаг обновления трейлинга (в пипсах). `0` — обновление при каждом выгодном тике. | `1` |

Параметры реализованы через `StrategyParam`, поэтому доступны для оптимизации.

## Особенности реализации
- Используются только данные уровня 1 (`DataType.Level1`); графические объекты из MetaTrader не переносятся.
- Перевод пипсов в цену зависит от `Security.PriceStep` и `Security.Decimals`. При отсутствии информации по тик-сайзу применяется значение 1.
- Для длинных и коротких позиций поддерживаются отдельные переменные трейлинг-уровня.
- Автоматическое открытие тестовых позиций, присутствовавшее в исходном советнике, опущено, так как в StockSharp используется учёт чистой позиции.

## Рекомендации по использованию
- Запускайте стратегию на инструменте, по которому уже есть открытые сделки или они появятся от других стратегий/ручных действий.
- Комбинируйте с собственными модулями входа, чтобы получать знакомый по MetaTrader функционал сопровождения в продуктах StockSharp.
- Для инструментов с крупным тиком подбирайте значения в пипсах в соответствии с `PriceStep`; при `TrailingStopPips = 1` трейлинг сдвигается на один шаг цены.

## Состав поставки
- `CS/VirtualTrailingStopStrategy.cs` — исходный код стратегии.
- `README.md`, `README_cn.md`, `README_ru.md` — документация на английском, китайском и русском языках.
