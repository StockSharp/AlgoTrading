# 虚拟移动止损策略

## 概述
**虚拟移动止损策略** 是 MetaTrader 专家顾问 `Virtual Trailing Stop.mq5`（MQL ID 21362）的 C# 版本。原始 EA 只负责管理已经存在的仓位的止损与止盈。本策略在 StockSharp 高级 API 上重现了同样的逻辑：实时监听买一/卖一价格，并在触发止损、止盈或追踪止损条件时通过市价单平仓。

与开仓型策略不同，本实现永远不会主动开立新头寸。它适合与其他自动化开仓模块或人工交易结合使用，在 StockSharp 环境中复制 MetaTrader 风格的“虚拟”移动止损。

## 交易逻辑
1. **Level1 行情** – 订阅 level1 数据并持续保存最新的买价和卖价。
2. **点值换算** – 用户输入均以“点”(pip) 表示。策略将其乘以 `PriceStep`，对于 3 或 5 位小数的外汇品种额外乘以 10，以匹配 MetaTrader 对 pip 的定义。
3. **止损检查** – 多头：若买价跌破 `开仓价 − 止损`；空头：若卖价升破 `开仓价 + 止损`，立即平仓。
4. **止盈检查** – 多头：若买价升破 `开仓价 + 止盈`；空头：若卖价跌破 `开仓价 − 止盈`，立即平仓。
5. **追踪启动** – 当浮盈达到 `TrailingStart` 点时，建立追踪止损水平（多头：`买价 − TrailingStop`，空头：`卖价 + TrailingStop`）。
6. **追踪更新** – 每当浮盈至少增加 `TrailingStep` 点时，追踪价格随之移动；将该参数设为 0 表示每个有利跳动都会更新。
7. **追踪离场** – 当价格触及追踪价并且交易仍为盈利状态时（对应源代码中的 `Profit()>0` 判断），立即平仓。

策略不会挂出真正的止损/止盈委托，所有离场均通过市价单完成，以保持“虚拟”止损的概念。

## 参数
| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `StopLossPips` | 止损距离（pip）。设置为 `0` 可关闭硬止损。 | `0` |
| `TakeProfitPips` | 止盈距离（pip）。设置为 `0` 可关闭止盈。 | `0` |
| `TrailingStopPips` | 当前价格与追踪价之间的距离（pip）。 | `5` |
| `TrailingStartPips` | 启动追踪所需的最小浮盈（pip）。 | `5` |
| `TrailingStepPips` | 每次移动追踪价所需的最小增幅（pip）。设为 `0` 表示连续追踪。 | `1` |

所有参数均基于 `StrategyParam` 实现，可用于优化。

## 实现细节
- 仅依赖 level1 数据 (`DataType.Level1`)，不创建 MetaTrader 式的图形对象。
- 点值换算依赖 `Security.PriceStep` 与 `Security.Decimals`，若交易所未提供这些元数据则退化为点值 1。
- 多头与空头分别维护独立的追踪价格，保证对称性。
- 原 EA 在测试模式下会自动开多空测试仓位，StockSharp 版本由于采用净头寸模型，故省略该功能。

## 使用建议
- 绑定到已经持仓或将由其他模块建仓的证券/投资组合上。
- 与人工交易或其他策略的入场逻辑组合，便于在 Designer、Shell 或 Runner 中复现 MetaTrader 式的仓位管理。
- 交易非外汇资产时，应根据最小跳动价调整 pip 参数；例如将 `TrailingStopPips = 1` 可以实现一步价差的追踪。

## 文件说明
- `CS/VirtualTrailingStopStrategy.cs` – 策略源码。
- `README.md`、`README_cn.md`、`README_ru.md` – 多语言文档。
