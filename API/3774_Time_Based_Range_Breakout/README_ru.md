# Стратегия прорыва дневного диапазона по времени

## Обзор
Стратегия представляет собой порт эксперта MetaTrader 4 `Tttttt_www_forex-instruments_info.mq4`. Она один раз в день, в заданный час и минуту, фиксирует максимум и минимум текущей сессии, рассчитывает диапазон по историческим данным и строит уровни пробоя. При закрытии свечи за этими уровнями открывается позиция по направлению пробоя, а выход осуществляется по динамическим целям прибыли и убытка.

## Логика работы
1. **Ежедневный снимок** – в момент `CheckHour:CheckMinute` стратегия фиксирует дневные High/Low и закрывает открытые позиции.
2. **Средний диапазон** – агрегируются показатели за последние `DaysToCheck` дней:
   - *CheckMode = 1*: используется полный диапазон (High − Low) каждого завершенного дня.
   - *CheckMode = 2*: используется модуль разницы между закрытиями в момент замера для соседних дней.
3. **Построение уровней** – среднее значение делится на `OffsetFactor`, образуя верхний и нижний коридор вокруг текущих High/Low. По тем же данным вычисляются целевые расстояния для прибыли (`ProfitFactor`) и убытка (`LossFactor`).
4. **Окно входа** – после расчета уровней стратегия отслеживает закрытия свечей до 23:00. Пробой верхнего уровня при отсутствии позиции ведет к покупке, пробой нижнего – к продаже. Количество сделок за день ограничено параметром `TradesPerDay`.
5. **Управление выходом** – находясь в позиции, стратегия сравнивает цену закрытия с средней ценой входа (`Strategy.PositionPrice`). Как только движение достигает заданных расстояний прибыли или убытка, позиция закрывается рыночным ордером. Если `CloseMode = 2`, то при смене календарного дня остаточная позиция тоже закрывается.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CheckHour` | Час (0-23), когда выполняется дневной замер. | `8` |
| `CheckMinute` | Минута (0-59) замера. | `0` |
| `DaysToCheck` | Число исторических дней для усреднения. | `7` |
| `CheckMode` | `1` = диапазон High/Low, `2` = абсолютная разница закрытий. | `1` |
| `ProfitFactor` | Делитель для расчета дистанции тейк-профита. | `2` |
| `LossFactor` | Делитель для расчета дистанции стоп-лосса. | `2` |
| `OffsetFactor` | Делитель для расчета смещения уровней пробоя. | `2` |
| `CloseMode` | `1` = допускается перенос позиций, `2` = закрытие при смене дня. | `1` |
| `TradesPerDay` | Максимальное количество сделок в сутки. | `1` |
| `CandleType` | Тип свечей для расчётов (по умолчанию 15-минутные). | таймфрейм 15 минут |

Все параметры заданы через `Strategy.Param`, поэтому доступны для оптимизации.

## Отличия от MQL-версии
- В MetaTrader плавающая прибыль доступна напрямую; в портированной версии она вычисляется через `Position` и `PositionPrice` на закрытии свечи.
- В оригинале количество сделок контролировалось подсчётом ордеров по тикетам. Здесь используется ограничение `TradesPerDay` вместе с совокупной позицией.
- Скрипт MT4 опирался на индикаторные буферы (`Highest`, `Lowest`). В портированной стратегии статистика хранится в собственных структурах, что соответствует требованиям высокоуровневого API.
- На MT4 заявки сопровождались встроенными стопами и тейками. В StockSharp их заменяет логика рыночного выхода при достижении целевых расстояний.

## Рекомендации по использованию
- Работайте на том же таймфрейме, что и оригинальная система (для примера использовались 15-минутные свечи).
- Перед запуском подгрузите минимум `DaysToCheck` завершенных дней, иначе уровни пробоя не будут активированы.
- При оптимизации удерживайте коэффициенты положительными, чтобы смещения и цели сохраняли смысл.
