# 基于时间的区间突破策略

## 概述
本策略移植自 MetaTrader 4 智能交易程序 `Tttttt_www_forex-instruments_info.mq4`。它在每天的指定时间截取当日的最高价和最低价，依据历史区间的平均值构建上下突破带。之后若收盘价突破这些带，则顺势开仓，并按照动态盈亏目标在蜡烛收盘时平仓。

## 核心逻辑
1. **每日快照时间**：在 `CheckHour:CheckMinute` 时刻冻结当天的最高/最低价，并关闭所有已有持仓。
2. **平均区间计算**：聚合最近 `DaysToCheck` 天的数据：
   - *CheckMode = 1*：使用每个完整交易日的最高价减最低价。
   - *CheckMode = 2*：使用相邻两个交易日在快照时间的收盘价绝对差。
3. **构建突破带**：把平均值除以 `OffsetFactor`，得到围绕当日高低点的上下偏移，同时用 `ProfitFactor` 与 `LossFactor` 把同一平均值转换为盈利/亏损目标距离。
4. **入场窗口**：快照之后直到 23:00，只要收盘价向上突破上轨且当前无仓位，就买入；向下突破下轨则卖出。每天允许的入场次数由 `TradesPerDay` 限制。
5. **离场管理**：持仓期间通过 `Strategy.PositionPrice` 估算平均持仓价，当收盘价相对该价格的变动达到盈利或亏损阈值时，立即以市价对冲平仓。如果 `CloseMode = 2`，跨日时也会强制平仓。

## 参数
| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `CheckHour` | 进行区间快照的小时 (0-23)。 | `8` |
| `CheckMinute` | 进行区间快照的分钟 (0-59)。 | `0` |
| `DaysToCheck` | 参与平均的历史天数。 | `7` |
| `CheckMode` | `1` = 使用每日高低区间，`2` = 使用相邻收盘价差。 | `1` |
| `ProfitFactor` | 把平均值换算为盈利目标距离时的除数。 | `2` |
| `LossFactor` | 把平均值换算为亏损阈值时的除数。 | `2` |
| `OffsetFactor` | 把平均值换算为突破带偏移量时的除数。 | `2` |
| `CloseMode` | `1` = 允许隔夜持仓，`2` = 跨日即平仓。 | `1` |
| `TradesPerDay` | 每天允许的最大开仓次数。 | `1` |
| `CandleType` | 计算所用的蜡烛周期（默认 15 分钟）。 | `15m` 时间框架 |

所有参数均通过 `Strategy.Param` 创建，可直接用于优化。

## 与 MQL 版本的差异
- MQL 通过交易核心直接获取浮动盈亏；移植版利用 `Position` 和 `PositionPrice` 在蜡烛收盘时自行估算。
- 原程序用订单循环统计未平仓单数量；移植版结合 `TradesPerDay` 与净头寸，实现每日交易次数限制。
- 原始脚本依赖 `Highest`、`Lowest` 等历史缓冲区；移植版在策略内部维护每日统计，避免了显式缓冲并符合高阶 API 规范。
- MQL 下单时同时设置止损止盈；移植版通过监控蜡烛收盘并在达到阈值时发送市价单来复现相同的风险控制。

## 使用提示
- 建议使用与原始脚本一致的周期（参考文件使用 15 分钟 K 线）。
- 在启动前至少准备 `DaysToCheck` 个完整交易日的历史数据，否则突破带不会激活。
- 优化参数时保持因子为正值，以保证突破带和风险阈值具备实际意义。
