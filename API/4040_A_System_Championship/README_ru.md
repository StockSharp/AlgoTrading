# Стратегия A System Championship

## Обзор
- Конвертация экспертного советника MetaTrader 4 «A System: Championship Strategy Final Edit» (файл `ACB6.MQ4`).
- Ищет пробои на выбранном старшем таймфрейме и подтверждает импульс актуальными ценами bid/ask.
- Второй таймфрейм воспроизводит «потоки» исходного робота и используется для расчёта дистанции трейлинг-стопа.
- Реализованы глобальный эквити-стоп, пауза между сделками и адаптивное управление риском, присутствующие в оригинальном коде.

## Источники данных
- Подписка на две серии свечей (`PrimaryTimeFrame`, `SecondaryTimeFrame`) для восстановления диапазонов, из которых строятся цели и трейлинг.
- Подписка на Level 1-данные необходима для отслеживания лучшего бид/аск, запускающих входы, стопы, тейки и выход по откату.

## Условия входа
1. Дождаться закрытия свечи старшего таймфрейма и умножить её диапазон на `TakeFactor`.
2. Открыть покупку, если:
   - Свеча закрылась выше своего середины.
   - Текущая цена ask пробивает максимум свечи.
   - Разница между бидом и минимумом свечи превышает `MinStopDistance`.
3. Продажа открывается при зеркальных условиях для нисходящего пробоя.
4. Сигнал игнорируется, если рассчитанный тейк меньше минимально допустимой дистанции до стопа.

## Управление позицией
- **Начальные уровни**: стоп устанавливается на минимум/максимум предыдущей свечи, тейк равен цене входа ± диапазон * `TakeFactor`.
- **Выход по откату** (`FallLimit`/`FallFactor`):
  - Хранится максимальное благоприятное движение цены.
  - Если текущее движение упало ниже `FallLimit * maxMove`, но при этом достигло `FallFactor * target`, позиция закрывается по рынку.
- **Трейлинг-стоп** (`TrailFactor`):
  - Дистанция равна диапазону вторичного таймфрейма, умноженному на `TrailFactor`.
  - Стоп смещается только в сторону прибыли и не пересекает уровень тейк-профита или минимальную дистанцию до стопа.
- **Жёсткие стоп/тейк**: при касании соответствующего уровня позиция немедленно закрывается рыночной заявкой.

## Управление рисками
- **Динамический объём**: `RiskPerTrade` умножается на стоимость пункта (берётся из `StepSize`/`StepPrice`), результат приводится к биржевым ограничениям и не опускается ниже `BaseVolume`.
- **Статистическая поправка**: отношение `LossesExpected/TradesExpected` сравнивается с фактической долей убыточных сделок и корректирует риск.
- **Эквити-стоп** (`SystemStop`): фиксирует максимум equity и запрещает новые сделки, если значение опускается ниже `SystemStop * максимум`. Логи информируют о срабатывании и восстановлении.
- **Пауза между сделками** (`TradePause`): после каждой рыночной заявки запускается таймер, как и в версии для MT4.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `PrimaryTimeFrame` | 1 день | Таймфрейм, на котором ищется пробой. |
| `SecondaryTimeFrame` | 4 часа | Таймфрейм для расчёта трейлинг-стопа. |
| `TakeFactor` | 0.8 | Множитель диапазона основной свечи для тейк-профита. |
| `TrailFactor` | 10 | Множитель диапазона вторичной свечи для трейлинга. |
| `FallLimit` | 0.5 | Доля от максимальной прибыли, разрешающая выход по откату. |
| `FallFactor` | 0.4 | Минимальная доля целевого хода, необходимая для откатного выхода. |
| `RiskPerTrade` | 0.02 | Базовая доля капитала, выделяемая на сделку. |
| `BaseVolume` | 1 | Минимальный объём, используемый при недостатке рассчитанного риска. |
| `MinStopDistance` | 0 | Минимальная дистанция до стопа в ценовых единицах. |
| `TradePause` | 5 минут | Время ожидания после исполнения ордера. |
| `SystemStop` | 0.8 | Коэффициент эквити-стопа (0.8 = допустимо до 20% просадки). |
| `LossesExpected` | 20 | Ожидаемое количество убыточных сделок. |
| `TradesExpected` | 85 | Ожидаемое общее количество сделок. |

## Особенности реализации
- Блоки блокировки/хеджирования из MQL не перенесены: в StockSharp стратегия оперирует чистой позицией, а трейлинг и защита капитала обеспечивают аналогичный эффект.
- Уровни стоп/тейк отслеживаются внутри стратегии, чтобы корректно работать в тестере без дополнительных заявок.
- Для корректной работы нужен инструмент с заданными `StepSize`, `StepPrice`, `MinVolume`, `VolumeStep`, иначе объём будет равен `BaseVolume`.
- Желательно получать поток Level 1 в реальном времени, иначе реакции на стоп/тейк будут происходить только по факту закрытия свечей.
