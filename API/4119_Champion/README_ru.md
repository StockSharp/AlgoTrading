# 4119 Стратегия Champion

## Общее описание
Стратегия является переносом эксперта MetaTrader из файла `MQL/919/champion.mq5` на C# с использованием высокоуровневого API StockSharp. В исходном советнике после появления сигнала RSI выставляются три стоп-заявки в сторону предполагаемого пробоя, для каждой заявки сразу задаются уровни стоп-лосса и тейк-профита, а стоп-лосс подтягивается при движении цены в прибыль. Перенос сохраняет эту логику и использует только высокоуровневые вызовы (`SubscribeCandles`, `Bind`, `BuyStop`, `SellStop` и т.д.).

Настройки по умолчанию рассчитаны на валютные пары, где значение MetaTrader point совпадает с `PriceStep` (например, 0.0001 для EURUSD). Тип свечей задаётся параметром, поэтому стратегию можно запускать на любом таймфрейме при наличии котировок best bid/ask и, по возможности, данных о стоп-уровне брокера.

## Логика работы
1. **Формирование сигнала**
   - RSI заданной длины рассчитывается на завершённых свечах.
   - Используется значение RSI предыдущей (закрытой) свечи и симметричный порог `RsiLevel`.
   - Если RSI < `RsiLevel`, готовится серия покупок; если RSI > `100 - RsiLevel`, готовится серия продаж.
2. **Выставление стоп-заявок**
   - При отсутствии позиции и активных заявок стратегии размещаются три стоп-заявки в сторону сигнала.
   - Покупки размещаются выше лучшей цены ask, продажи ниже лучшей цены bid. Расстояние соответствует stop level брокера (если он передаётся) или параметру `MinOrderDistancePoints`.
   - Объём рассчитывается динамически: доступная стоимость портфеля делится на `BalancePerLot`, результат ограничивается диапазоном 0.1–15 лотов и округляется до двух знаков. Каждая заявка получает треть от рассчитанного объёма.
3. **Первичное страхование позиции**
   - После первой сделки выставляются агрегированные защитные заявки: стоп-лосс на уровне `entry ± StopLossPoints`, тейк-профит на `entry ± TakeProfitPoints` (MetaTrader points переводятся в цену через `PriceStep`).
   - Если `TakeProfitPoints = 0`, тейк-профит не выставляется.
4. **Подтягивание стоп-лосса**
   - Во время открытия позиции стоп-лосс пересчитывается по каждому событию level-1.
   - Для длинной позиции новый уровень равен `max(entry + spread, bid - StopLoss)`, для короткой — `min(entry - spread, ask + StopLoss)`.
   - Стоп-лосс подтягивается только тогда, когда цена прошла минимум `(StopLevel + spread)` пунктов в прибыльную сторону — так же, как в оригинальном советнике.
5. **Сопровождение стоп-заявок**
   - Если цена активации buy stop отстаёт от текущего ask более чем на `RepriceDistancePoints`, заявка снимается и выставляется ближе к рынку; для sell stop используется та же логика относительно bid.
   - При пересчёте всегда берётся максимум между `RepriceDistancePoints` и фактическим стоп-уровнем брокера.
6. **Выход из позиции**
   - Позиция закрывается защитными заявками или вручную. Когда позиция снова становится нулевой, стратегия снимает оставшиеся защитные ордера и ждёт нового сигнала RSI.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TakeProfitPoints` | Тейк-профит в MetaTrader points относительно цены входа. Значение `0` отключает тейк-профит. |
| `StopLossPoints` | Стоп-лосс в points, также используемый при расчёте трейлинг-стопа. |
| `RsiPeriod` | Период RSI в количестве свечей. |
| `RsiLevel` | Симметричный порог: значения ниже порога готовят покупки, выше `100 - RsiLevel` — продажи. |
| `BalancePerLot` | Сумма средств в валюте счёта, соответствующая одному стандартному лоту при расчёте объёма. |
| `MinOrderDistancePoints` | Резервное минимальное расстояние (в points) до стоп-заявок, если брокер не передаёт stop level. |
| `RepriceDistancePoints` | Расстояние (в points), при превышении которого стоп-заявки перерегистрируются. |
| `CandleType` | Тип свечей, на которых рассчитывается RSI. |

## Рекомендации по использованию
- Для работы необходимы свечи и поток level-1 (лучший bid/ask). Без level-1 трейлинг и сопровождение заявок отключаются.
- Если торговый сервер передаёт stop level/stop distance в потоке level-1, стратегия автоматически будет соблюдать это ограничение. В противном случае задайте корректное значение `MinOrderDistancePoints` вручную.
- При отсутствии данных по портфелю или отрицательном результате расчёта объёма стратегия использует значение `Strategy.Volume` как фиксированный объём.
- Стратегия всегда размещает три стоп-заявки одновременно. Ненужные заявки можно удалить вручную — оставшиеся будут сопровождаться автоматически.

## Управление рисками
- Стоп-лосс и тейк-профит выставляются в виде реальных ордеров, полностью повторяя поведение MetaTrader. После закрытия позиции защитные ордера снимаются.
- Трейлинг-стоп движется только в сторону прибыли и никогда не расширяет первоначальный риск. Условие активации — движение цены минимум на `(StopLevel + spread)` пунктов от точки входа.
- Логика перестановки стоп-заявок позволяет избежать ситуаций, когда после резкого движения остаются сильно отстающие от рынка ордера.
