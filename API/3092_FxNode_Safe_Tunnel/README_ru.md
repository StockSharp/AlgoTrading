# Стратегия FxNode Safe Tunnel

## Описание

Эта стратегия — порт советника MetaTrader 4 *FxNode - Safe Tunnel* на платформу StockSharp. Алгоритм строит «тоннель» из двух трендовых линий по последним экстремумам ZigZag: верхняя линия соединяет последние пики, нижняя — впадины. Сделка открывается, когда цена касается одной из границ тоннеля в пределах допустимого коридора и выполнены все проверки безопасности.

Особенности реализации:

- Вся логика запускается по полностью сформированным свечам выбранного таймфрейма.
- Пара индикаторов `Highest`/`Lowest` имитирует работу ZigZag и позволяет рассчитывать наклон трендовых линий в режиме реального времени.
- Индикатор `AverageTrueRange` воспроизводит исходный расчёт `ATRCheck() * 10`, который использовался для постановки защитного стоп-лосса.
- Обновления котировок Level1 применяются для контроля максимального спреда перед постановкой новой сделки.

## Условия входа

1. По каждой свече пересчитываются экстремумы ZigZag с заданной глубиной, отклонением в пипсах и минимальным числом баров между вершинами.
2. На основе двух последних максимумов и минимумов строятся текущие значения верхней и нижней трендовых линий, а также высота тоннеля.
3. Сигнал на покупку формируется, если лучшая цена предложения находится выше нижней линии, но не дальше `TouchDistanceBuyPips`. Для продаж используется зеркальное условие относительно верхней линии и лучшей цены спроса.
4. Дополнительный фильтр времени (по умолчанию — интервал 00:00–06:00) должен разрешать торговлю. В соответствии с оригиналом сделки запрещены в пятницу, субботу и воскресенье.
5. Фактический спред (ask − bid) не должен превышать значение `MaxSpreadPips`, если доступны котировки.
6. Параметр `MaxOpenPositions` ограничивает суммарную нетто-позицию. В среде StockSharp это именно ограничение на общий объём, а не на количество отдельных ордеров.

## Условия выхода

- **Стоп-лосс.** Рассчитывается как `ATR * 10` с учётом верхнего ограничения `MaxStopLossPips`.
- **Тейк-профит.** Базовое значение равно высоте тоннеля; при необходимости ограничивается параметром `TakeProfitPips`.
- **Фиксированная прибыль.** Если `FixedTakeProfitPips > 0`, позиция закрывается при достижении указанного результата в пипсах.
- **Трейлинг-стоп.** После прохождения ценой расстояния `TrailingStopPips` в прибыльную сторону стоп подтягивается вслед за ценой.
- **Выход перед выходными.** При включённом флаге `CloseBeforeWeekend` позиция закрывается после 23:50 по пятницам.

Закрытие сделок выполняется рыночными ордерами, как и в исходном советнике.

## Управление рисками и объёмом

1. Пытаемся посчитать объём исходя из `RiskPercentage` от стоимости портфеля, если известны шаг цены и стоимость шага.
2. При невозможности расчёта используется фиксированный объём `StaticVolume`.
3. Итоговый объём ограничивается диапазоном `MinVolume`–`MaxVolume`.

Из-за неттинговой модели учёт `MaxOpenPositions` трактуется как ограничение на суммарный объём позиции, а не на количество отдельных заявок.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `CandleType` | Свечи 30 минут | Таймфрейм анализа и торговли. |
| `TrendPreference` | Обе стороны | Направление торговли: только покупки, только продажи или симметричный режим. |
| `TakeProfitPips` | 800 | Максимальная дистанция тейк-профита в пипсах (0 — без ограничений). |
| `MaxStopLossPips` | 200 | Максимальная дистанция стоп-лосса в пипсах (0 — без ограничений). |
| `FixedTakeProfitPips` | 0 | Фиксация прибыли при достижении указанного результата в пипсах. |
| `TouchDistanceBuyPips` | 20 | Допуск цены выше нижней линии для входа в лонг. |
| `TouchDistanceSellPips` | 20 | Допуск цены ниже верхней линии для входа в шорт. |
| `TrailingStopPips` | 50 | Дистанция трейлинг-стопа. |
| `StaticVolume` | 1 | Резервный объём заявки. |
| `MinVolume` / `MaxVolume` | 0.02 / 10 | Нижняя и верхняя границы объёма. |
| `MaxSpreadPips` | 15 | Предельно допустимый спред для открытия новой позиции. |
| `RiskPercentage` | 30 | Процент капитала, которым можно рискнуть в одной сделке. |
| `MaxOpenPositions` | 1 | Максимальная суммарная нетто-позиция (в объёмах текущих сделок). |
| `UseTimeFilter` | true | Включить/выключить торговый интервал. |
| `SessionStart` / `SessionEnd` | 00:00 / 06:00 | Временное окно торговли. Если начало позже окончания, окно пересекает полночь. |
| `CloseBeforeWeekend` | true | Закрывать позиции вечером в пятницу. |
| `AtrPeriod` | 14 | Период ATR. |
| `ZigZagDepth` | 5 | Глубина поиска экстремумов. |
| `ZigZagDeviationPips` | 3 | Минимальное отклонение между соседними экстремумами в пипсах. |
| `ZigZagBackstep` | 1 | Минимальное число баров между экстремумами. |
| `ZigZagHistory` | 10 | Количество запоминаемых экстремумов для построения трендовых линий. |

## Замечания

- Восстановление ZigZag повторяет оригинал, однако параметры могут потребовать подстройки под конкретный инструмент и торговую сессию.
- Фильтр по спреду работает только при наличии котировок bid/ask. В бэктестах по свечам ограничение будет пропускаться.
- В модуле StockSharp используется неттинг, поэтому для учёта отдельных позиций необходимо расширить стратегию самостоятельным учётом сделок.
- Строковые параметры времени из MT4 заменены типом `TimeSpan`. Чтобы задать ночную сессию, укажите время начала больше времени окончания (например, 23:30–05:30).

## Как использовать

1. Подключите стратегию к инструменту, задайте таймфрейм свечей и параметры.
2. Убедитесь, что поток Level1 или стакан включён, чтобы корректно контролировать спред.
3. Перед реальной торговлей протестируйте стратегию и убедитесь в допустимом уровне риска.
