# Стратегия Record Spread Stop Freeze Level
[English](README.md) | [中文](README_cn.md)

Стратегия Record Spread Stop Freeze Level — это утилита для периодического сохранения показателей микроструктуры рынка для одного или нескольких инструментов. Она повторяет логику оригинального эксперта MetaTrader, фиксируя спрэд, минимальный уровень стоп-заявок и freeze-уровень, и записывает данные в текстовый файл для последующего анализа.

## Детали

- **Назначение**: инструмент мониторинга, формирующий временные ряды спрэда, stop- и freeze-уровней
- **Источники данных**:
  - Котировки Level1 по каждому отслеживаемому инструменту (лучший бид/аск и дополнительная информация провайдера)
  - Состояние коннектора для определения серверного времени и статуса соединения
- **Интервал логирования**: настраиваемый таймер в минутах (по умолчанию 1 минута)
- **Инструменты**:
  - Возможность включать основной инструмент стратегии
  - Поддержка списка дополнительных `Security`, которые отслеживаются параллельно
- **Выходные данные**:
  - Текстовый файл в формате CSV, размещённый в каталоге `Logs`
  - Автоматическое архивирование предыдущего лога в подпапку `Logs/BUP` перед стартом новой сессии

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `RecordPeriodMinutes` | Интервал (в минутах) между срабатываниями таймера, запускающими запись строки. Должен быть больше нуля. | `1` |
| `LogFilePrefix` | Префикс, добавляемый к имени создаваемого файла лога. | `"MktData"` |
| `IncludePrimarySecurity` | При значении `true` основной инструмент стратегии добавляется в список мониторинга. | `true` |
| `AdditionalSecurities` | Дополнительные инструменты, которые нужно отслеживать вместе с основным. | пусто |

## Структура файла

- **Путь**: `<рабочая папка>/Logs/<prefix>_Acc_<account>.csv`
  - `<рабочая папка>` соответствует `AppDomain.CurrentDomain.BaseDirectory`
  - `<account>` берётся из имени привязанного портфеля, при отсутствии используется идентификатор стратегии
- **Архив**: перед записью предыдущий файл копируется в `Logs/BUP/<prefix>_Acc_<account>.csv`
- **Заголовок**:
  - `TimeLocal;TimeServer;IsConnected;SYMBOL_Spread;SYMBOL_StopLevel;SYMBOL_FreezeLevel;...`
  - `SYMBOL` формируется из `Security.Id` и очищается от недопустимых символов
- **Строки данных**:
  - `TimeLocal`: локальное время рабочего места в формате ISO-8601 (`DateTimeOffset.Now`)
  - `TimeServer`: время коннектора (`Strategy.CurrentTime`) в формате ISO-8601
  - `IsConnected`: `True`, если коннектор сообщает активное соединение, иначе `False`
  - `Spread`: рассчитывается как `BestAsk - BestBid`, если доступны обе цены; иначе `N/A`
  - `StopLevel` / `FreezeLevel`: заполняются только при наличии соответствующих полей Level1 от провайдера данных; при отсутствии записывается `N/A`

## Рекомендации по использованию

1. Назначьте стратегии портфель/коннектор, который публикует данные Level1 по каждому отслеживаемому инструменту.
2. Настройте параметр `AdditionalSecurities`, указав инструменты, которые нужно логировать совместно.
3. При необходимости измените префикс файла и интервал записи, чтобы удовлетворить требованиям отчётности.
4. Запустите стратегию: она подпишется на потоки Level1, подготовит новый файл лога и будет добавлять строки при каждом срабатывании таймера.
5. Анализируйте сформированный файл в каталоге `Logs`. Каждое новое включение предварительно архивирует предыдущую версию.

## Ограничения

- Значения stop- и freeze-уровней зависят от брокера. Если провайдер не передаёт соответствующие поля Level1, в таблице будут стоять `N/A`.
- Таймер работает с минутной точностью; для более частого опроса необходимо уменьшить параметр и убедиться, что инфраструктура выдерживает выбранную частоту.
- Стратегия не выставляет заявки и не управляет позициями — это инструмент диагностики и сбора данных.
