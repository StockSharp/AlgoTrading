# Стратегия Moving Average Trade System (2518)

## Обзор

Стратегия представляет собой перенос эксперта MetaTrader "Moving Average Trade System" на платформу StockSharp. Для определения тренда используются четыре простые скользящие средние (SMA), рассчитанные по медианной цене свечи. Система ждёт подтверждённого пересечения среднесрочной и долгосрочной средних при условии, что более быстрые средние подтверждают направление тренда. После появления сигнала стратегия переворачивает позицию в сторону нового тренда и управляет рисками с помощью фиксированных уровней тейк‑профита, стоп‑лосса и трейлинг‑стопа, задаваемых в шагах цены.

## Логика торговли

1. **Индикаторы**
   - `SMA(5)` — быстрая средняя по медианной цене.
   - `SMA(20)` — средняя по медианной цене.
   - `SMA(40)` — сигнальная средняя по медианной цене.
   - `SMA(60)` — медленная средняя по медианной цене.

2. **Вход в лонг**
   - `SMA(5) > SMA(20) > SMA(40)`.
   - `SMA(40)` находится выше `SMA(60)` минимум на `SlopeThresholdSteps` шагов цены.
   - На текущей свече `SMA(40)` пересекла `SMA(60)` снизу вверх (значение на предыдущей свече было меньше или равно `SMA(60)`).
   - Если открыта короткая позиция, стратегия покупает объём, достаточный для закрытия шорта и открытия целевой длинной позиции.

3. **Вход в шорт**
   - `SMA(5) < SMA(20) < SMA(40)`.
   - `SMA(40)` находится ниже `SMA(60)` минимум на `SlopeThresholdSteps` шагов цены.
   - На текущей свече `SMA(40)` пересекла `SMA(60)` сверху вниз (значение на предыдущей свече было больше или равно `SMA(60)`).
   - Если открыта длинная позиция, стратегия продаёт объём, достаточный для закрытия лонга и открытия целевого шорта.

4. **Управление позицией** (выполняется только если на свече не было нового входа):
   - **Разворот тренда:** закрыть лонг, если `SMA(40) <= SMA(60)`, и закрыть шорт, если `SMA(40) >= SMA(60)`.
   - **Тейк‑профит:** закрыть позицию при достижении цены, удалённой от входа на `TakeProfitSteps` шагов цены.
   - **Стоп‑лосс:** закрыть позицию, если цена прошла против позиции `StopLossSteps` шагов цены.
   - **Трейлинг‑стоп:** после движения в прибыль подтягивать защитный уровень на `TrailingStopSteps` шагов, используя максимум (для лонга) или минимум (для шорта), достигнутый после входа.

Все расстояния задаются в **шагах цены** (`PriceStep`). Если инструмент не предоставляет значение шага цены, используется значение `1`.

## Параметры

| Параметр | Описание | Значение по умолчанию | Оптимизация |
| --- | --- | --- | --- |
| `Volume` | Объём заявок при открытии новой позиции. | `1` | Нет |
| `TakeProfitSteps` | Дистанция до тейк‑профита в шагах цены. | `50` | Да |
| `StopLossSteps` | Дистанция до стоп‑лосса в шагах цены. | `50` | Да |
| `TrailingStopSteps` | Смещение трейлинг‑стопа в шагах цены (`0` отключает трейлинг). | `11` | Да |
| `SlopeThresholdSteps` | Минимальный разрыв между `SMA(40)` и `SMA(60)` для фильтрации ложных сигналов. | `1` | Да |
| `FastPeriod` | Период быстрой SMA. | `5` | Да |
| `MediumPeriod` | Период средней SMA. | `20` | Да |
| `SignalPeriod` | Период сигнальной SMA (сравнивается с медленной). | `40` | Да |
| `SlowPeriod` | Период медленной SMA, задающей фон тренда. | `60` | Да |
| `CandleType` | Тип свечей для расчёта индикаторов. | `1 час` | Нет |

## Особенности реализации

- Индикаторы подключены через высокоуровневый метод `Bind`, поэтому расчёты выполняются событийно, без ручного доступа к буферам индикаторов.
- Использование медианной цены полностью повторяет поведение оригинального советника MetaTrader.
- Фактическая цена входа фиксируется в обработчике `OnNewMyTrade`, что позволяет переустанавливать уровни тейк‑профита, стоп‑лосса и трейлинг‑стопа после каждой сделки.
- При развороте позиции отправляется одна рыночная заявка, которая одновременно закрывает текущую позицию и открывает новую, что соответствует работе оригинальной стратегии на хеджинговых счетах.
- Все комментарии в исходном коде написаны на английском языке в соответствии с требованиями репозитория.

## Рекомендации по использованию

- Подберите параметр `Volume` с учётом шага изменения позиции или минимального лота инструмента.
- Изменяйте уровни стопа и тейка в зависимости от волатильности инструмента (значения по умолчанию соответствуют 50 пунктам стопа/тейка и 11 пунктам трейлинг‑стопа для валютных пар).
- Если требуется более чувствительная реакция на пересечения, установите `SlopeThresholdSteps = 0`, чтобы отключить дополнительный фильтр по расстоянию.
- Перед запуском убедитесь, что инструмент предоставляет корректный `PriceStep`; иначе стратегия будет считать, что один шаг цены равен единице цены.
