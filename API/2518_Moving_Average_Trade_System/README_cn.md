# 移动平均交易系统策略 (2518)

## 概述

该策略是 MetaTrader "Moving Average Trade System" 智能交易系统的 StockSharp 版本。策略使用四条基于 K 线中位价的简单移动平均线（SMA）来判断趋势。当中期与长期均线完成确认交叉，同时快速均线给出趋势一致的信号后，策略会按新趋势方向建立或翻转仓位，并通过以价格步长为单位的止盈、止损和移动止损进行风险控制。

## 交易逻辑

1. **指标**
   - `SMA(5)`：快速均线，使用中位价。
   - `SMA(20)`：中速均线，使用中位价。
   - `SMA(40)`：信号均线，使用中位价。
   - `SMA(60)`：慢速均线，使用中位价。

2. **开多条件**
   - `SMA(5) > SMA(20) > SMA(40)`。
   - `SMA(40)` 比 `SMA(60)` 至少高出 `SlopeThresholdSteps` 个价格步长。
   - 当前柱 `SMA(40)` 向上穿越 `SMA(60)`（上一柱 `SMA(40)` 小于或等于慢速均线）。
   - 如果当前持有空头，策略会一次性买入足够数量以平空并建立目标多头仓位。

3. **开空条件**
   - `SMA(5) < SMA(20) < SMA(40)`。
   - `SMA(40)` 比 `SMA(60)` 至少低出 `SlopeThresholdSteps` 个价格步长。
   - 当前柱 `SMA(40)` 向下穿越 `SMA(60)`（上一柱 `SMA(40)` 大于或等于慢速均线）。
   - 如果当前持有多头，策略会一次性卖出足够数量以平多并建立目标空头仓位。

4. **风险管理**（仅在当前柱没有新入场信号时评估）：
   - **趋势反向退出**：当 `SMA(40) <= SMA(60)` 时平掉多头；当 `SMA(40) >= SMA(60)` 时平掉空头。
   - **止盈**：价格达到入场价加/减 `TakeProfitSteps` 个价格步长时离场。
   - **止损**：价格向不利方向波动 `StopLossSteps` 个价格步长时离场。
   - **移动止损**：价格有利运行后，以 `TrailingStopSteps` 个价格步长跟踪保护，针对多头使用入场后最高价，空头使用入场后最低价。

所有止盈、止损与移动止损的距离均以 **价格步长（PriceStep）** 为单位。如果标的未提供价格步长，策略会默认使用 `1`。

## 参数

| 参数 | 说明 | 默认值 | 可优化 |
| --- | --- | --- | --- |
| `Volume` | 建仓时使用的下单数量。 | `1` | 否 |
| `TakeProfitSteps` | 止盈距离（按价格步长计）。 | `50` | 是 |
| `StopLossSteps` | 止损距离（按价格步长计）。 | `50` | 是 |
| `TrailingStopSteps` | 移动止损偏移量（价格步长，`0` 表示关闭移动止损）。 | `11` | 是 |
| `SlopeThresholdSteps` | `SMA(40)` 与 `SMA(60)` 之间的最小间距，用于过滤噪声（按价格步长计）。 | `1` | 是 |
| `FastPeriod` | 快速 SMA 的周期。 | `5` | 是 |
| `MediumPeriod` | 中速 SMA 的周期。 | `20` | 是 |
| `SignalPeriod` | 与慢速均线比较的信号 SMA 周期。 | `40` | 是 |
| `SlowPeriod` | 描述背景趋势的慢速 SMA 周期。 | `60` | 是 |
| `CandleType` | 计算指标使用的 K 线类型。 | `1 小时` | 否 |

## 实现细节

- 通过高阶 `Bind` API 绑定指标，实现事件驱动的计算方式，无需直接访问指标缓冲区。
- 所有 SMA 均使用中位价，完全贴合原始 MetaTrader 算法的设定。
- 在 `OnNewMyTrade` 中记录成交价，用于实时更新止盈、止损和移动止损水平。
- 当需要反向持仓时，策略发送一笔市场单，同时完成平仓与开仓，复制了原始 EA 在对冲账户上的行为。
- C# 源码中的所有注释均为英文，以满足仓库规范。

## 使用建议

- 根据标的合约规模或最小交易量调整 `Volume` 参数。
- 依据市场波动性调整止盈止损距离（默认值对应外汇中 50 点止盈/止损以及 11 点移动止损）。
- 将 `SlopeThresholdSteps` 设为 `0` 可去掉额外的距离过滤，使策略对任何 `SMA(40)` 与 `SMA(60)` 的交叉作出反应。
- 在回测或实时交易前，请确保标的提供有效的 `PriceStep`；若无，策略会默认把 1 个价格单位视为一个步长。
