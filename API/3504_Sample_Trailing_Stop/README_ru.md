# Стратегия Sample Trailing Stop

## Обзор

**SampleTrailingStopStrategy** — это порт советника MetaTrader `SampleTrailingstop.mq4` на платформу StockSharp. Стратегия не открывает позиции самостоятельно, а следит за уже существующими сделками и поддерживает защитные заявки стоп-лосс и тейк-профит. Логика полностью повторяет оригинал: передвигает стоп по мере роста прибыли и учитывает брокерские ограничения по stop level и freeze level.

Когда длинная позиция становится прибыльной и лучшая цена Bid отходит от цены входа достаточно далеко, стратегия сначала переносит стоп-лосс на минимально допустимое расстояние под Bid. После этого стоп тянется за ценой на заданное количество пунктов с учётом брокерских буферов. Для коротких позиций применяется зеркальный алгоритм — стоп размещается над Ask. При каждом обновлении дополнительно пересчитывается целевой уровень тейк-профита (если он включён).

## Поток данных

* Подписка на поток Level1 для получения лучших цен Bid/Ask.
* Использование встроенного API стратегии для доступа к средней цене текущей позиции.
* Повторная регистрация защитных заявок при каждом пересчёте новых уровней.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TrailingStopPoints` | `200` | Расстояние от рынка до трейлинг-стопа в пунктах. Добавляется к брокерским буферам при вычислениях. |
| `TakeProfitPoints` | `1000` | Расстояние до тейк-профита в пунктах. Значение `0` отключает управление тейк-профитом. |
| `StopLevelPoints` | `0` | Минимальный stop level брокера в пунктах. Прибавляется к расстоянию трейлинга, чтобы заявка была валидна. |
| `FreezeLevelPoints` | `0` | Freeze level брокера в пунктах. Трейлинг активируется только после выхода цены за этот буфер от цены входа. |

Все расстояния переводятся в денежные значения с помощью минимального шага цены инструмента, что соответствует константе `_Point` в MetaTrader.

## Алгоритм работы

1. **Проверка позиции** — трейлинг выполняется только при наличии позиции и актуальных котировок Bid/Ask.
2. **Контроль прибыли** — для лонга требуется `Bid > цена входа`, для шорта — `Ask < цена входа`, а также выход цены за freeze level.
3. **Первичный перенос** — если трейлинг ещё не активен, при достаточном удалении цены стоп переносится к рынку на минимально допустимое расстояние.
4. **Подтягивание стопа** — пока позиция прибыльна, стоп перемещается следом за ценой на величину `TrailingStopPoints` плюс брокерские буферы. Тейк-профит обновляется при каждом шаге.
5. **Обслуживание заявок** — защитные заявки создаются, перерегистрируются или отменяются через высокоуровневые методы, чтобы брокер всегда видел актуальные значения.

## Рекомендации по использованию

* Запускайте стратегию вместе с другим модулем, который открывает сделки, либо используйте её для сопровождения вручную открытых позиций.
* Убедитесь, что у инструмента корректно заданы шаг цены и объёма — стратегия нормализует значения согласно биржевым требованиям.
* При смене направления позиции старые защитные заявки удаляются, после чего трейлинг запускается заново для нового направления.
