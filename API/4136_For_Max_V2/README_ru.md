# For Max V2

## Обзор
For Max V2 — порт советника MetaTrader 4 `for_max_v2.mq4`. Стратегия отслеживает два варианта свечного паттерна «поглощение» и после его появления ставит симметричные отложенные ордера Buy Stop и Sell Stop вокруг последней закрывшейся свечи. Как только пробой срабатывает, противоположный ордер удаляется, а позиция сопровождается фиксированным стопом, необязательным тейк-профитом и трейлингом, который сначала переносит защиту в зону небольшого профита, а затем следует за ценой.

## Логика стратегии
### Обнаружение паттерна
В оригинальном советнике реализовано два блока входов, оба сохранены:
* **Сценарий типа 1** — просматривает завершённые свечи в количестве `Max Search` (без текущей). Если минимум или максимум диапазона пришёлся на свечу два бара назад и эта свеча поглотила следующую (более высокий максимум и более низкий минимум), формируется страддл вокруг последней свечи.
* **Сценарий типа 2** — аналогично сканирует `Max Search` свечей, но требует, чтобы экстремум появился на предыдущем баре, который также поглощает ещё более раннюю свечу. После этого ордера выставляются относительно последней свечи. Оба сценария могут существовать параллельно и ведут собственные ордера и время жизни.

### Размещение отложенных ордеров
* **Цены входа** — Buy Stop ставится на максимум предыдущей свечи плюс `Gap Points`, Sell Stop — на минимум минус `Gap Points`.
* **Стоп-лоссы** — для типа 1 лонг защищается минимумом свечи два бара назад (минус зазор), шорт — максимумом той же свечи (плюс зазор). Тип 2 использует экстремумы предыдущей свечи.
* **Тейк-профиты** — опционально. Лонговая цель добавляет `Gap Points + Buy Take Profit Points` к предыдущему максимуму, шортовая вычитает `Gap Points + Sell Take Profit Points` из предыдущего минимума. Значение `0` отключает тейк-профит.
* **Срок действия** — каждая пара ордеров получает время истечения: `Order Expiry (bars)` умножается на выбранный таймфрейм свечи. После истечения оба ордера удаляются, если ещё не исполнены.

### Сопровождение позиции
* После исполнения Buy Stop все остающиеся Sell Stop (из обоих сценариев) отменяются; при открытии шорта действует зеркальное правило.
* Стопы и тейки контролируются на закрытых свечах. Если минимум свечи достигает стоп-лосса по лонгу (или максимум касается стопа по шорту), позиция закрывается рыночным ордером. Для тейк-профитов применяется та же логика.
* Блок безубыточности (`Break-even Trigger` и `Break-even Offset`) переносит стоп на уровень входа плюс/минус заданное смещение, когда прибыль достигает порога.
* Трейлинг удерживает стоп на расстоянии `Long/Short Trailing Buffer` пунктов от лучшего движения и, при необходимости, активируется только после выхода позиции в прибыль. Параметр `Trailing Step` задаёт минимальный шаг улучшения, без которого стоп не двигается.

## Параметры
* **Volume** — объём ордера для каждой пары отложенных заявок.
* **Buy Take Profit (points)** — расстояние до тейк-профита для лонгов (0 — отключить).
* **Sell Take Profit (points)** — расстояние до тейк-профита для шортов (0 — отключить).
* **Gap (points)** — дополнительный зазор, прибавляемый к экстремумам и участвующий в расчёте тейк-профита.
* **Search Depth** — количество завершённых свечей, используемых для поиска паттерна типов 1 и 2.
* **Order Expiry (bars)** — число свечей, в течение которых страддл остаётся активным.
* **Break-even Trigger (points)** — прибыль, необходимая для перевода стопа в безубыток.
* **Break-even Offset (points)** — смещение стопа относительно цены входа при переходе в безубыток.
* **Long Trailing Buffer (points)** — расстояние трейлинг-стопа от максимума движения в лонге.
* **Short Trailing Buffer (points)** — расстояние трейлинг-стопа от минимума движения в шорте.
* **Trailing Step (points)** — минимальный шаг улучшения, позволяющий подтянуть трейлинг-стоп.
* **Trail Only After Profit** — если включено, трейлинг активируется только после появления прибыли выше буфера.
* **Candle Type** — таймфрейм свечей, используемых для анализа, истечения ордеров и контроля выходов.

## Дополнительная информация
* Все значения в пунктах опираются на `PriceStep` инструмента. Для пятого и третьего знака после запятой преобразование совпадает с логикой MetaTrader.
* Стопы и тейки исполняются рыночными заявками внутри стратегии, что повторяет поведение оригинального советника, работавшего по закрытым свечам.
* Неиспользуемая функция `vhod_3` из исходника не переносилась — реализованы только два задействованных блока входа.
* В набор входит только реализация на C#, версия на Python не поставляется.
