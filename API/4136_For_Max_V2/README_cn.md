# For Max V2

## 概览
For Max V2 是 MetaTrader 4 智能交易系统 `for_max_v2.mq4` 的移植版本。策略等待特定的两根 K 线吞没形态出现，然后在最新一根收盘 K 线的上下方同时挂出买入止损和卖出止损订单。一旦突破方向被触发，反向挂单会被撤销，持仓则由固定止损、可选止盈以及一套先锁定保本、再跟随价格的拖尾机制进行管理。

## 策略逻辑
### 吞没形态识别
原始 EA 提供了两个入场模块，本移植完整保留：
* **类型 1 形态** —— 在排除当前 K 线后，扫描最近 `Max Search` 根已完成 K 线。当最低点出现在两根之前，**或**最高点出现在两根之前，同时该 K 线必须吞没后一根 K 线（更高的高点和更低的低点），则触发类型 1 条件。此时在最新收盘 K 线上下构建对冲挂单。
* **类型 2 形态** —— 同样扫描最近 `Max Search` 根 K 线，但要求极值出现在前一根 K 线上，且前一根 K 线必须吞没其前一根。满足条件后，同样在最新收盘 K 线上下挂出对冲订单。两个形态可以同时存在，各自维护独立的挂单和到期计时。

### 挂单规则
* **入场价格** —— 买入止损挂在前一根 K 线的最高价加上 `Gap Points`，卖出止损挂在前一根 K 线的最低价减去 `Gap Points`。
* **止损** —— 类型 1 的多头止损位于两根之前的最低价减去间隙，空头止损位于同一根 K 线的最高价加上间隙；类型 2 则统一使用前一根 K 线的极值。
* **止盈** —— 可选。多头止盈距离为 `Gap Points + Buy Take Profit Points`，加在前一根高点之上；空头止盈距离为 `Gap Points + Sell Take Profit Points`，减在前一根低点之下。将止盈参数设为 `0` 即可关闭对应方向的目标。
* **到期处理** —— 每组对冲挂单都携带到期时间，等于 `Order Expiry (bars)` 乘以所选 K 线周期。当达到时间点时，仍未成交的挂单会被全部取消。

### 持仓管理
* 买入止损成交后，所有仍未撤销的卖出止损挂单都会被删除；空头成交时执行对称逻辑。
* 策略在每根完成的 K 线上检查止损和止盈。如果多头的最低价触及止损（或空头的最高价触及止损），则通过市价单平仓；止盈同理。
* 保本模块使用 `Break-even Trigger` 与 `Break-even Offset` 两个参数，在盈利达到触发值后，将止损移动到入场价附近并留出自定义缓冲。
* 拖尾模块在价格走出 `Long/Short Trailing Buffer` 点之后开始工作（可选地仅在持仓已盈利时启动），并保持止损与最佳运行价之间的固定距离。`Trailing Step` 要求止损每次移动前，价格必须至少前进指定的最小增量，避免过度调整。

## 参数说明
* **Volume** —— 每笔挂单的下单量。
* **Buy Take Profit (points)** —— 多头止盈距离（点），设为 `0` 关闭多头止盈。
* **Sell Take Profit (points)** —— 空头止盈距离（点），设为 `0` 关闭空头止盈。
* **Gap (points)** —— 在极值外侧额外添加的缓冲点数，同时计入止盈距离。
* **Search Depth** —— 识别类型 1 与类型 2 吞没形态时回溯的 K 线数量。
* **Order Expiry (bars)** —— 挂单最长保留的 K 线数量，到期后两侧挂单会同时撤销。
* **Break-even Trigger (points)** —— 启动保本止损所需的盈利点数。
* **Break-even Offset (points)** —— 保本止损相对入场价的偏移量。
* **Long Trailing Buffer (points)** —— 多头拖尾止损与最佳价之间的距离。
* **Short Trailing Buffer (points)** —— 空头拖尾止损与最佳价之间的距离。
* **Trailing Step (points)** —— 更新拖尾止损前，价格至少需要前进的点数。
* **Trail Only After Profit** —— 仅在持仓已处于盈利状态时才启动拖尾功能。
* **Candle Type** —— 用于形态识别、挂单到期以及出场判断的 K 线周期。

## 其他说明
* 所有“点”相关参数都依赖于品种的 `PriceStep`。对于 5 位或 3 位小数报价的货币对，点值会自动映射为 MT4 中的标准 pip。
* 为了贴合原始 EA 在收盘价上管理仓位的方式，止损与止盈在策略内部通过市价单执行。
* 原代码中未启用的 `vhod_3` 函数未被移植，仅保留两个实际使用的入场模块。
* 本目录仅包含 C# 实现，暂不提供 Python 版本。
