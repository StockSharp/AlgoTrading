# N Candles v3 策略

## 概述
该策略会监控最近收盘的蜡烛线，只要连续 *N* 根蜡烛具有相同方向（全部阳线或全部阴线），就顺势开仓。同时它限制同向持仓的数量，避免超过 `Max Positions` 指定的上限。本实现将 MetaTrader 5 平台上的专家顾问迁移到了 StockSharp 的高级 API。

## 交易逻辑
- 订阅配置的蜡烛类型，只处理已经收盘的蜡烛。
- 对每根蜡烛判断实体方向：收盘价高于开盘价视为阳线，低于开盘价视为阴线，相等则视为十字星。
- 出现十字星时重置计数；否则只要当前蜡烛方向与前一根相同就继续累加。当计数达到 `Identical Candles` 参数时发出新的交易信号。
- 多头信号会先平掉现有空头，再在不超过 `Max Positions * Volume` 的前提下加仓多头。
- 空头信号与其对称运作，用于连续阴线的情况。

## 风险控制
- 每次成交后都会根据当前平均持仓价重新下达止损和止盈委托。
- 止盈与止损距离都以品种的 `PriceStep` 为单位：`Take Profit Points` 与 `Stop Loss Points` 分别表示需要乘以多少个最小价格步长。
- 当价格朝持仓方向运行超过 `Trailing Stop Points` 指定的距离时，启用阶梯式跟踪止损；只有当价格比上一档跟踪价格进一步推进 `Trailing Step Points` 时才会上移/下移保护价位。

## 参数
- **Candle Type** – 要分析的时间框架或蜡烛源。
- **Identical Candles** – 触发信号所需的连续同向蜡烛数量。
- **Volume** – 每次加仓的下单数量，单位为标的资产数量。
- **Max Positions** – 同一方向允许持有的最大加仓次数。
- **Take Profit Points** – 止盈距离，按最小价格步长的倍数表示。
- **Stop Loss Points** – 止损距离，按最小价格步长的倍数表示。
- **Trailing Stop Points** – 启用跟踪止损时与价格之间保持的基础距离，为 0 时关闭跟踪止损。
- **Trailing Step Points** – 每次移动跟踪止损前所需的额外价格推进距离。

## 其他说明
- 策略以净头寸方式工作：出现反向信号时会先平掉旧仓，再建立新的方向。
- 每次成交都会重新创建保护性委托，使其数量与当前持仓保持一致。
- 若合约没有提供有效的 `PriceStep`，策略会默认使用 1 作为价格步长。
