# Стратегия N Candles v3

## Общее описание
Стратегия анализирует последние закрытые свечи и ищет последовательность, в которой *N* баров подряд имеют одинаковое направление (все бычьи или все медвежьи). При появлении такой серии открывается позиция в сторону движения с учётом ограничения на максимальное количество одновременных входов. Данный код переносит оригинального советника MetaTrader 5 на высокоуровневый API StockSharp.

## Логика торговли
- Подписка оформляется на выбранный тип свечей, обрабатываются только полностью сформированные бары.
- Для каждой свечи определяется направление тела: закрытие выше открытия — бычья свеча, ниже — медвежья, равенство трактуется как доджи.
- Доджи сбрасывает счётчик. В противном случае при совпадении направления счётчик увеличивается. Как только его значение достигает параметра `Identical Candles`, генерируется новый торговый сигнал.
- Для длинных сигналов сначала закрываются текущие короткие позиции, после чего добавляется лот до тех пор, пока суммарный объём не превысит `Max Positions * Volume`.
- Короткие сигналы работают зеркально для серий из медвежьих свечей.

## Управление рисками
- После каждого исполнения заявок стратегия пересоздаёт защитные ордера стоп-лосс и тейк-профит, основываясь на средней цене текущей позиции.
- Расстояния измеряются в шагах цены инструмента: параметры `Take Profit Points` и `Stop Loss Points` умножаются на `PriceStep` для расчёта уровней защиты.
- Следящий стоп активируется, когда цена проходит в прибыльную сторону расстояние `Trailing Stop Points`. Перенос стопа выполняется только при дополнительном движении минимум на `Trailing Step Points` сверх предыдущего уровня.

## Параметры
- **Candle Type** – тип и таймфрейм свечей для анализа.
- **Identical Candles** – количество однонаправленных свечей, необходимое для открытия позиции.
- **Volume** – объём одной заявки в единицах актива.
- **Max Positions** – максимальное число входов в одном направлении одновременно.
- **Take Profit Points** – расстояние до тейк-профита в шагах цены.
- **Stop Loss Points** – расстояние до стоп-лосса в шагах цены.
- **Trailing Stop Points** – базовое расстояние для следящего стопа; ноль отключает функцию.
- **Trailing Step Points** – дополнительное движение в шагах цены, необходимое перед переносом стопа.

## Дополнительные замечания
- Стратегия работает в неттинговом режиме: при появлении сигнала противоположного направления существующие позиции закрываются, затем открывается новая сделка.
- Объёмы защитных ордеров синхронизируются с фактической позицией после каждого исполнения.
- Если инструмент не предоставляет ненулевого значения `PriceStep`, используется значение 1 по умолчанию.
