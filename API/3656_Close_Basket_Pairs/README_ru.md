# Стратегия Close Basket Pairs

**Close Basket Pairs Strategy** переносит одноимённый скрипт MetaTrader в экосистему StockSharp. Она непрерывно отслеживает корзину валютных пар вместе с направлением позиции, которую следует контролировать. Как только плавающий результат по соответствующей позиции достигает заданного уровня прибыли или убытка, стратегия отправляет рыночную заявку противоположного направления и полностью закрывает экспозицию.

В отличие от исходного скрипта, который выполнялся единоразово, версия для StockSharp работает постоянно и пересматривает корзину каждую секунду. Это полезно для трейдеров, управляющих коррелированными корзинами и желающих автоматизировать фиксацию прибыли или ограничение убытков без постоянного контроля терминала.

## Алгоритм работы

1. Трейдер задаёт список элементов корзины в формате `СИМВОЛ|НАПРАВЛЕНИЕ`, например `EURUSD|BUY,GBPUSD|SELL`.
2. При запуске стратегия разбирает строку, проверяет корректность каждого элемента и сопоставляет их с позициями, доступными в подключённом портфеле.
3. Каждую секунду выполняется сканирование портфеля:
   - Если позиция совпадает с описанием (тот же инструмент и знак объёма) и плавающая прибыль **не меньше** значения `ProfitThreshold`, отправляется рыночная заявка для фиксации результата.
   - Если плавающий результат **не выше** отрицательного значения параметра `LossThreshold` (параметр следует задавать отрицательным), позиция закрывается для ограничения убытка.
4. Одновременно активна только одна защитная заявка на инструмент. Уже выставленные ордера не дублируются.

Если оба порога оставлены равными `0`, стратегия автоматически завершает работу, потому что контролировать нечего.

## Параметры

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `BasketPairs` | Определение корзины через запятую. Каждый элемент должен иметь вид `СИМВОЛ|SIDE`, где `SIDE` — `BUY` или `SELL`. | `EURUSD|BUY,GBPUSD|SELL,USDJPY|BUY` |
| `ProfitThreshold` | Минимальная плавающая прибыль (в валюте портфеля) для закрытия позиции. Ноль отключает фиксацию по прибыли. | `0` |
| `LossThreshold` | Отрицательное значение плавающего убытка (в валюте портфеля), при достижении которого позиция закрывается. Используйте отрицательные числа, например `-150`. Ноль отключает фиксацию по убытку. | `0` |

## Рекомендации по использованию

- Символы в `BasketPairs` должны в точности совпадать с идентификаторами инструментов вашего брокера или поставщика данных. Сначала проверяется полный идентификатор, затем короткий код.
- Если необходима только фиксация прибыли или только ограничение убытка, оставьте ненужный порог равным нулю.
- Перед запуском убедитесь, что портфель имеет торговые права по всем инструментам корзины — стратегия использует рыночные заявки.
- Стратегия не снимает существующие защитные ордера. Если стоп уже выставлен вручную, дополнительная заявка не появится.

## Отличия от скрипта MetaTrader

- Версия для StockSharp работает непрерывно и оценивает позиции каждую секунду, а не один раз в момент запуска.
- Встроена расширенная проверка входной строки с подробными сообщениями об ошибках при некорректном формате.
- Для закрытия позиций используются высокоуровневые методы StockSharp (`BuyMarket` / `SellMarket`), при этом логика срабатывания порогов сохранена.
