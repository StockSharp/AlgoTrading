# Close Basket Pairs 策略

**Close Basket Pairs Strategy** 将 MetaTrader 的同名脚本移植到 StockSharp 平台。策略会持续监控一个包含多个交易品种及其方向的“篮子”，一旦篮子中某个方向的持仓达到指定的浮动盈利或亏损阈值，就会自动发送反向市价单来平仓。

与一次性运行的脚本不同，StockSharp 版本常驻运行，并且每秒检查一次当前仓位，非常适合希望自动锁定利润或限制回撤的篮子交易者。

## 工作流程

1. 通过逗号分隔的字符串定义篮子，例如 `EURUSD|BUY,GBPUSD|SELL`。格式必须为 `品种|方向`，方向取 `BUY` 或 `SELL`。
2. 启动后策略会解析字符串、验证格式，并在投资组合中查找相应的仓位。
3. 每秒执行一次检查：
   - 如果某个仓位与篮子定义相匹配（相同品种且方向一致），并且浮动盈利 **大于等于** `ProfitThreshold`，策略会立刻提交市价单锁定利润。
   - 如果浮动盈利 **小于等于** 参数 `LossThreshold` 的绝对值（该参数必须设置为负数），则发送市价单止损离场。
4. 为避免重复操作，每个品种同时最多只有一个平仓订单处于活动状态。

当两个阈值都保持默认的 `0` 时，策略会自动停止，因为无需监控任何仓位。

## 参数说明

| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| `BasketPairs` | 用逗号分隔的篮子定义，格式为 `品种|方向`，方向只能是 `BUY` 或 `SELL`。 | `EURUSD|BUY,GBPUSD|SELL,USDJPY|BUY` |
| `ProfitThreshold` | 触发平仓所需的最小浮动盈利（账户货币）。设置为 `0` 表示关闭盈利保护。 | `0` |
| `LossThreshold` | 触发平仓所需的浮动亏损（账户货币）。请使用负值，例如 `-150`；设置为 `0` 表示关闭亏损保护。 | `0` |

## 使用建议

- 确保篮子中的品种名称与数据源或券商的标识完全一致。策略会先尝试匹配完整的 `SecurityId`，如果失败则使用简短代码。
- 只想开启其中一侧保护时，将另一个阈值保持为 `0` 即可。
- 策略发送的是市价单，请确认投资组合拥有所有相关品种的交易权限。
- 已经存在的保护性订单不会被撤销，策略只是避免重复提交平仓指令。

## 与 MetaTrader 脚本的差异

- StockSharp 版本以守护方式运行并每秒评估仓位，而不是像脚本那样仅执行一次。
- 新增了详细的输入校验，如果某个篮子元素格式错误会在日志中给出提示。
- 使用 StockSharp 的高层 API (`BuyMarket` / `SellMarket`) 来提交平仓订单，同时保留原有的盈利 / 亏损触发逻辑。
