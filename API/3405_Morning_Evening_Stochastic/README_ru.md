# Стратегия Morning Evening Stochastic
[English](README.md) | [中文](README_cn.md)

Стратегия переносит эксперт MetaTrader 5 **Expert_AMS_ES_Stoch** (паттерны Утренняя/Вечерняя звезда с подтверждением стохастиком) в экосистему StockSharp. Логика распознавания свечных моделей и фильтрация по стохастику воспроизводятся из оригинала, при этом используется высокоуровневый API подписки на свечи, поэтому решения принимаются только по завершённым барам.

## Логика работы
- **Индикаторы**
  - Классический стохастический осциллятор с настраиваемыми периодами `%K`, `%D` и параметром замедления.
  - Простое скользящее среднее от абсолютной величины тела свечи (`|open-close|`) для классификации свечей как длинных или малых — аналог функции `AvgBody()` в MQL.
- **Вход в лонг**
  - Свечной паттерн «Утренняя звезда» на последних трёх закрытых барах:
    1. Две свечи назад — длинное медвежье тело, превышающее средний размер.
    2. Предыдущая свеча — малое тело с открытием и закрытием ниже тела первой свечи.
    3. Текущая свеча — бычье закрытие выше середины тела первой свечи.
  - Линия сигнала стохастика (`%D`) ниже уровня перепроданности (по умолчанию `30`).
  - Перед открытием лонга закрывается любая открытая короткая позиция.
- **Вход в шорт**
  - Паттерн «Вечерняя звезда» (зеркало описанных выше правил).
  - `%D` выше уровня перекупленности (по умолчанию `70`).
  - Открытые лонги закрываются перед открытием шорта.
- **Выход из позиции**
  - Шорты закрываются при пробое `%D` вверх через уровень быстрого восстановления (`20`) или экстремальный уровень (`80`).
  - Лонги закрываются при пробое `%D` вниз через `80` или `20`.
  - Эти условия повторяют логику закрытия из модуля сигналов MQL.

## Параметры
| Имя | Описание |
| --- | --- |
| `CandleType` | Таймфрейм (или иной `DataType`), по которому анализируются свечи и рассчитываются индикаторы. |
| `StochasticKPeriod`, `StochasticDPeriod`, `StochasticSlowing` | Периоды `%K`, `%D` и замедление стохастика. |
| `StochasticOverbought`, `StochasticOversold` | Пороговые значения `%D` для подтверждения входа по паттерну Evening/Morning Star. |
| `PatternAveragePeriod` | Количество завершённых свечей для усреднения размеров тел. |
| `ShortExitLevel`, `LongExitLevel` | Уровни `%D`, которые инициируют выход из шорта/лонга при пробое в противоположную сторону. |

## Особенности реализации
- Используется `SubscribeCandles().BindEx(...)`, индикаторы получают только завершённые данные, обращений к `GetValue()` нет.
- Среднее тело свечи рассчитывается индикатором `SimpleMovingAverage`, который получает абсолютные значения тела свечи — полностью соответствует подходу MQL.
- Проверка паттернов выделена в отдельные методы для читаемости и точного воспроизведения правил из `CCandlePattern`.
- Перед открытием позиции в противоположную сторону стратегия закрывает текущую экспозицию, как это делал оригинальный эксперт (однонаправленная торговля).

## Отличия от версии MQL5
- Система управления капиталом, трейлинг-стоп и фиксированный лот из MetaTrader не переносятся; объём ордеров задаётся свойством `Volume` стратегии.
  - При необходимости риск-менеджмент можно добавить средствами StockSharp (например, через `StartProtection`).
- Используется реализация стохастика из StockSharp; при необходимости уровни можно подстроить, если в исходной среде индикатор давал немного иные значения.
- Логирование (на английском языке) подробно описывает каждое открытие и закрытие позиции, что упрощает тестирование и отладку.
