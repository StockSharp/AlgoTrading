# 晨星暮星配合随机指标策略
[English](README.md) | [Русский](README_ru.md)

本策略将 MetaTrader 5 专家顾问 **Expert_AMS_ES_Stoch**（晨星/暮星形态结合随机指标确认）移植到 StockSharp。代码沿用了原始的蜡烛形态识别与随机指标过滤规则，并利用高级的蜡烛订阅 API，确保所有决策都基于已经收盘的K线。

## 策略逻辑
- **指标**
  - 标准随机振荡指标，`%K`、`%D` 以及平滑参数均可配置。
  - 对蜡烛实体长度（`|open-close|`）计算的简单移动平均，用于区分长实体与小实体，复现 MQL 中的 `AvgBody()` 功能。
- **做多条件**
  - 最近三根完成K线形成晨星形态：
    1. 两根之前为长阴线，实体长度大于平均值。
    2. 前一根为小实体蜡烛，开盘价与收盘价都低于第一根。
    3. 当前蜡烛收盘价高于第一根实体的中点并收阳。
  - 随机指标信号线 `%D` 低于超卖阈值（默认 `30`）。
  - 在开多前会平掉现有空头仓位。
- **做空条件**
  - 最近三根K线形成暮星形态（与上面镜像）。
  - `%D` 高于超买阈值（默认 `70`）。
  - 在开空前会先平掉已有多头仓位。
- **离场条件**
  - 当 `%D` 上穿恢复阈值 `20` 或极值 `80` 时平掉空单。
  - 当 `%D` 下穿 `80` 或 `20` 时平掉多单。
  - 上述规则对应 MQL 信号模块中的平仓逻辑。

## 参数
| 名称 | 说明 |
| --- | --- |
| `CandleType` | 用于分析的K线类型或时间框架。|
| `StochasticKPeriod`, `StochasticDPeriod`, `StochasticSlowing` | 随机指标 `%K`、`%D` 与平滑周期。|
| `StochasticOverbought`, `StochasticOversold` | 确认晨星/暮星入场时使用的 `%D` 阈值。|
| `PatternAveragePeriod` | 计算蜡烛实体平均长度所用的K线数量。|
| `ShortExitLevel`, `LongExitLevel` | `%D` 穿越这些水平时触发空头/多头平仓。|

## 实现说明
- 通过 `SubscribeCandles().BindEx(...)` 订阅蜡烛，指标准确接收已完成的K线数据，代码中不会调用 `GetValue()`。
- 采用 `SimpleMovingAverage` 对实体长度求平均值，等价于原始 MQL 库中的体型计算。
- 晨星与暮星的判定封装在独立方法中，便于阅读，同时保持与 `CCandlePattern` 的规则一致。
- 策略在方向反转前会先平掉当前持仓，以模拟原专家顾问一次只持有单方向仓位的行为。

## 与 MQL5 版本的差异
- 未移植 MetaTrader 框架中的资金管理、追踪止损或固定手数设置；在 StockSharp 中通过策略的 `Volume` 属性控制下单手数。
- 随机指标使用 StockSharp 的实现，如需对齐原平台，可自行调整阈值。
- 日志（英文）详细记录每次开仓和平仓，方便回测与调试。
