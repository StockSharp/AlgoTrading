# CCI MACD Scalper

## Обзор
CCI MACD Scalper — это порт советника MetaTrader 5 «CCI + MACD Scalper» на высокоуровневый API StockSharp. В конверсии сохранён исходный набор индикаторов: EMA в качестве фильтра тренда, CCI для нулевого пробоя и MACD для подтверждения импульса. Логика управления капиталом адаптирована к StockSharp: объём рассчитывается от капитала портфеля, слишком короткие стопы отклоняются, а опциональный трейлинг-стоп может зафиксировать часть прибыли при первом переносе. Пятиизначный «таймер» реализован через паузу в пять свечей после каждой сделки — точно так же, как `EventSetTimer` в MQL.

## Логика стратегии
### Индикаторы и подготовка данных
* **Свечи** — все вычисления ведутся по одной настраиваемой серии свечей. Стратегия анализирует только закрытые свечи, чтобы исключить перерисовку сигналов.
* **EMA(34)** — экспоненциальная средняя закрытия выступает трендовым фильтром. Для покупки требуется закрытие выше предыдущего значения EMA, для продажи — ниже.
* **CCI(50)** — служит триггером импульса. Ожидается пересечение нулевой линии, которое произошло на двух последних завершённых свечах (текущая свеча лишь подтверждает условия и не участвует в сравнении).
* **MACD(12,26,9)** — главная линия и сигнальная линия должны оставаться по одну сторону от нуля на двух предыдущих свечах. Дополнительно требуется пересечение сигнальной линии через основную между этими свечами (снизу вверх для лонга, сверху вниз для шорта).
* **Буферы экстремумов** — последние пять завершённых максимумов и минимумов определяют уровни стоп-лосса. Для лонга используется минимум, для шорта — максимум, что полностью повторяет вызовы `iLowest/iHighest` со смещением в одну свечу.

### Условия входа
* **Торговое окно** — сделки открываются только если время закрытия свечи попадает в диапазон `[MinHour, MaxHour]` локального времени терминала.
* **Пауза после сделки** — после открытия позиции стратегия ждёт пять длительностей выбранного таймфрейма перед новой попыткой входа, полностью повторяя MQL-таймер.
* **Длинные позиции**
  * Чистая позиция не должна быть длиннее нуля (`Position <= 0`).
  * Цена закрытия выше предыдущего значения EMA.
  * CCI пересёк ноль снизу вверх на двух последних закрытых свечах.
  * MACD зафиксировал «бычье» пересечение сигнальной линии под нулём за те же две свечи.
  * Стоп-лосс на последнем минимуме удовлетворяет ограничению по минимальной дистанции.
* **Короткие позиции**
  * Чистая позиция не должна быть короче нуля (`Position >= 0`).
  * Цена закрытия ниже предыдущего значения EMA.
  * CCI пересёк ноль сверху вниз на двух последних свечах.
  * MACD показал «медвежье» пересечение сигнальной линии над нулём.
  * Стоп-лосс на последнем максимуме проходит проверку минимальной дистанции.

### Управление риском и сделками
* **Динамический объём** — размер позиции вычисляется от параметра `RiskPercent` и текущей стоимости портфеля. Денежный риск на единицу объёма находится через расстояние до стопа, шаг цены и стоимость шага. Итог округляется к шагу объёма инструмента и ограничивается минимальными/максимальными значениями площадки.
* **Стоп и тейк-профит** — стоп-лосс располагается на выбранном экстремуме и отклоняется, если расстояние меньше `MinimalStopLossPoints`. Тейк-профит рассчитывается как `entry ± RiskReward × stopDistance`, аналогично оригинальному советнику.
* **Трейлинг-стоп (опционально)** — при включении стоп смещается на `TrailingStopPoints`, как только цена закрытия проходит дальше предыдущего стопа. Первый перенос сопровождается частичной фиксацией половины исходного объёма, что повторяет поведение функции `PositionClosePartial` в MetaTrader.
* **Принудительные выходы** — в лонге позиция закрывается при пробое стопа (минимум свечи) или достижении тейка (максимум). Для шорта используется симметричная проверка максимумов и минимумов.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Таймфрейм, по которому ведутся расчёты. | Свечи 15 минут |
| `RiskPercent` | Процент капитала портфеля, задействованный в расчёте объёма. | 2% |
| `RiskReward` | Коэффициент «прибыль/риск» для тейк-профита. | 1.5 |
| `EmaPeriod` | Период EMA для фильтра тренда. | 34 |
| `CciPeriod` | Период Commodity Channel Index. | 50 |
| `MinHour` | Нижняя граница часа (включительно) для открытия сделок. | 0 |
| `MaxHour` | Верхняя граница часа (включительно) для открытия сделок. | 24 |
| `MinimalStopLossPoints` | Минимально допустимое расстояние от входа до стопа в пунктах. | 100 |
| `UseTrailingStop` | Включает модуль трейлинг-стопа и частичную фиксацию. | Выкл. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа в пунктах. | 100 |

## Дополнительные замечания
* Пересчёт пунктов в цену использует `PriceStep` инструмента. Если шаг цены неизвестен, применяется единичное значение.
* Стоимость портфеля берётся из `Portfolio.CurrentValue` с резервом на `BeginValue`. При отсутствии обеих величин стратегия возвращается к базовому значению `Volume`.
* Python-реализация не предусмотрена — в пакете присутствует только версия на C#.
