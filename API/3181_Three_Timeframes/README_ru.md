# Стратегия Three Timeframes

## Общее описание
**Three Timeframes Strategy** переносит эксперта MetaTrader `Three timeframes.mq5` на платформу StockSharp с использованием высокоуровневого API. Алгоритм объединяет сигналы с трёх таймфреймов:

- **MACD (M5)** — отслеживает краткосрочные развороты импульса на рабочем таймфрейме.
- **Alligator (H4)** — подтверждает направление тренда на старшем таймфрейме.
- **RSI (H1)** — проверяет, поддерживает ли средний таймфрейм движение.
- Дополнительный **фильтр торговой сессии** ограничивает работу стратегии указанными часами.

Каждая сделка сопровождается уровнем стоп-лосса и тейк-профита в пунктах. После появления прибыли опциональный трейлинг подтягивает защитный ордер, когда цена проходит расстояние `TrailingStopPips + TrailingStepPips`.

## Логика сигналов
1. Стратегия подписывается на три потока свечей: рабочие M5, старшие H4 для Аллигатора и промежуточные H1 для RSI.
2. Условия покупки:
   - Линия MACD на предыдущей свече находится ниже сигнальной, а на свече до неё — выше сигнальной, что повторяет правило оригинального эксперта.
   - Значение RSI на H1 превышает 50.
   - На последней завершённой H4 свече линии Alligator упорядочены как Jaw > Teeth > Lips.
3. Продажа зеркальна: MACD пересекает сигнальную линию вверх, RSI ниже 50, а линии Alligator упорядочены как Lips > Teeth > Jaw.
4. При наличии противоположной позиции стратегия сначала закрывает её встречным рыночным ордером, затем открывает новый вход по направлению сигнала.
5. После входа выставляются стоп-лосс и тейк-профит. Трейлинг обновляет защитный уровень, когда прибыль превышает сумму дистанции и шага трейлинга.

Фильтр торговых часов полностью повторяет реализацию MetaTrader: если начало меньше конца, то торгуем только внутри диапазона; если начало больше конца, окно работы охватывает вечер и ночные часы, переходя через полночь.

## Управление рисками
- **Стоп-лосс / тейк-профит** — задаются в пунктах и переводятся в цену через `Security.PriceStep` с учётом трёх- и пятизнаковых котировок.
- **Трейлинг-стоп** — активируется после прохождения «дистанция + шаг» и переносит стоп-ордер на `цена − дистанция` (лонг) или `цена + дистанция` (шорт).
- **Объём сделки** — определяет базовый размер рыночных заявок. При смене направления позиция закрывается автоматически.

## Отличия от версии MetaTrader
- Во StockSharp нет необходимости отслеживать флаги ожидания транзакций (`m_waiting_transaction`): методы `BuyMarket` и `SellMarket` сами обрабатывают подтверждения.
- Настройки проскальзывания, режима маржи и типа исполнения из MQL скрыты платформой и не дублируются в .NET реализации.
- Индикатор Alligator собран из трёх сглаженных скользящих средних и хранит значения в буферах, чтобы сохранить сдвиг линий, характерный для MetaTrader.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `TradeVolume` | Объём рыночной сделки. | `1` |
| `StopLossPips` | Начальная дистанция стоп-лосса (пункты). | `50` |
| `TakeProfitPips` | Начальная дистанция тейк-профита (пункты). | `140` |
| `TrailingStopPips` | Дистанция трейлинг-стопа (пункты). | `5` |
| `TrailingStepPips` | Дополнительный шаг перед обновлением трейлинга. | `5` |
| `MacdFastPeriod` | Быстрый период MACD. | `13` |
| `MacdSlowPeriod` | Медленный период MACD. | `26` |
| `MacdSignalPeriod` | Период сигнальной линии MACD. | `10` |
| `JawPeriod`, `TeethPeriod`, `LipsPeriod` | Периоды SMA для линий Аллигатора. | `13`, `8`, `5` |
| `JawShift`, `TeethShift`, `LipsShift` | Сдвиг линий Аллигатора. | `8`, `5`, `3` |
| `RsiPeriod` | Период RSI на среднем таймфрейме. | `14` |
| `CandleType` | Рабочий таймфрейм (по умолчанию 5 минут). | `M5` |
| `AlligatorCandleType` | Таймфрейм для Аллигатора (по умолчанию 4 часа). | `H4` |
| `RsiCandleType` | Таймфрейм для RSI (по умолчанию 1 час). | `H1` |
| `UseTimeFilter` | Включение фильтра торговых часов. | `true` |
| `StartHour` | Час начала сессии (включительно). | `10` |
| `EndHour` | Час окончания сессии (исключая). | `15` |

## Рекомендации по использованию
- Убедитесь, что выбранный инструмент предоставляет свечи всех трёх таймфреймов (M5, H1, H4). Метод `GetWorkingSecurities()` автоматически запрашивает необходимые подписки.
- Пересчёт пунктов опирается на `Security.PriceStep`. Для инструментов с нетипичным шагом цены скорректируйте параметры риска вручную.
- Для отключения трейлинга достаточно установить `TrailingStopPips` или `TrailingStepPips` в ноль — поведение полностью соответствует оригинальному MQL эксперту.
