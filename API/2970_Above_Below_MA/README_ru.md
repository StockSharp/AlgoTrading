# Стратегия Above Below MA
[English](README.md) | [中文](README_cn.md)

Стратегия Above Below MA повторяет логику советника MetaTrader *Above Below MA (barabashkakvn's edition)*. Она оценивает, насколько далеко текущая цена находится по «неправильную» сторону от настраиваемой скользящей средней, и допускает сделки только если цена удалена от средней не меньше заданного порога и сама средняя разворачивается в ожидаемом направлении. Реализация использует высокоуровневый API StockSharp и работает исключительно по завершённым свечам.

## Общая информация

- **Рынки**: Инструменты, склонные возвращаться к скользящей средней перед продолжением тренда.
- **Инструменты**: Любые, поддерживаемые подключением StockSharp. Наибольшую пользу получают валютные пары, так как исходная версия измеряла расстояние в пунктах.
- **Таймфрейм**: Настраивается параметром *Candle Type* (по умолчанию минутные свечи).
- **Направления**: Разрешены длинные и короткие позиции, но одновременно может существовать только одна чистая позиция.

## Логика работы

1. Рассчитывается скользящая средняя по выбранной серии свечей. Тип усреднения (SMA, EMA, SMMA, WMA), источник цены (close, open, high, low, median, typical, weighted) и смещение полностью повторяют параметры MetaTrader.
2. Минимальная дистанция в пунктах переводится в цену через `PriceStep` инструмента. Если шаг цены недоступен, фильтр автоматически отключается.
3. Для каждой завершённой свечи выполняются проверки:
   - **Сигнал на покупку**:
     - Цена открытия и закрытия свечи находятся не ближе заданной дистанции ниже смещённой средней.
     - Текущее значение средней выше предыдущего (средняя растёт).
   - **Сигнал на продажу**:
     - Открытие и закрытие располагаются минимум на заданную дистанцию выше смещённой средней.
     - Текущее значение средней ниже предыдущего (средняя снижается).
4. Перед открытием новой сделки стратегия закрывает противоположную позицию и отправляет рыночный ордер в направлении сигнала.

Все решения принимаются только по закрытым свечам, чтобы исключить многократные входы внутри формирующегося бара. Заявки отправляются методами `BuyMarket` и `SellMarket` с установленным объёмом.

## Параметры

| Параметр | Описание |
|----------|----------|
| `MaPeriod` | Период скользящей средней. По умолчанию 6.
| `MaShift` | Смещение средней вперёд на *n* свечей. 0 — текущее значение, `n` — значение `n` свечей назад. По умолчанию 0.
| `MaMethod` | Тип средней: `Simple`, `Exponential`, `Smoothed`, `Weighted`. По умолчанию `Exponential`.
| `AppliedPrice` | Источник цены: close, open, high, low, median, typical или weighted. По умолчанию `Typical`.
| `MinimumDistancePips` | Минимальная дистанция в пунктах между ценой свечи и средней. Переводится через `PriceStep`. По умолчанию 5.
| `CandleType` | Тип свечей, по которым выполняются расчёты. По умолчанию минутные свечи.
| `TradeVolume` | Объём новой позиции. По умолчанию 1.

## Дополнительные замечания

- В стратегию не встроены стоп-лосс и тейк-профит. Управление рисками следует реализовывать отдельными механизмами.
- Буфер для смещения средней хранит только необходимые значения и не нарушает требование «без собственных коллекций».
- Если `PriceStep` отсутствует, фильтр по дистанции игнорируется, и решения принимаются только по наклону и положению средней.
- При наличии окна графика отображаются свечи, сама скользящая средняя и сделки стратегии.
