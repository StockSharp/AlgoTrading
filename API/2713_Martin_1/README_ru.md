# Стратегия Martin 1
[English](README.md) | [中文](README_cn.md)

Конвертация советника MetaTrader 5 «Martin 1» на высокоуровневый API StockSharp. Алгоритм постоянно поддерживает позицию и использует хеджирующие мартингейл-шаги для выхода из просадок, одновременно наращивая прибыльные тренды пирамидингом.

## Логика торговли

1. **Начальная позиция** – при отсутствии открытых сделок стратегия немедленно открывает позицию в направлении `StartDirection` независимо от фильтра времени. Базовый объём берётся из `InitialVolume` и округляется вниз до шага объёма инструмента.
2. **Временное окно** – при включённом `UseTradingHours` пирамидинг и хеджирование выполняются только между `StartHour` и `EndHour` включительно, используя биржевое время из свечей.
3. **Пирамидинг прибыли** – каждая открытая позиция оценивается на закрытии свечи. Если плавающая прибыль по лонгу превышает дистанцию тейк-профита и остаётся положительной, отправляется дополнительный рыночный ордер тем же объёмом. Шортовые позиции работают зеркально. Цена исполнения принимается равной цене закрытия текущей свечи.
4. **Хеджирующий мартингейл** – если начальное направление лонг и убыток по позиции превышает `(StopLossPips × размер пункта × (текущий шаг + 1))`, открывается противоположный шорт. Перед выставлением объём умножается на `LotMultiplier`, округляется по шагу и счётчик шагов увеличивается. Аналогичное правило действует для стартового шорта. Хеджирование прекращается при достижении `MaxMultiplications` шагов.
5. **Глобальная цель прибыли** – нереализованная прибыль всех открытых позиций переводится в деньги через `PriceStep`/`StepPrice`. Если сумма превышает `MinProfit`, каждая позиция закрывается встречным рыночным ордером, а состояние мартингейла сбрасывается.

## Риск-менеджмент и мани-менеджмент

- Размер пункта вычисляется из шага цены инструмента. Для трёх- и пятизнаковых котировок шаг умножается на десять, что повторяет поведение оригинального робота.
- Объёмы округляются вниз до ближайшего `VolumeStep`. Если результат меньше шага, ордер не отправляется.
- Счётчик мартингейла и текущий объём сбрасываются при полном закрытии позиций естественным путём либо после достижения глобальной цели по прибыли.
- Прибыль оценивается без учёта комиссий и свопов, аналогично оригинальной реализации, которая опиралась только на плавающий PnL.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Тип свечей, на основе которых принимаются решения. | 1 минута |
| `UseTradingHours` | Включение фильтра торговых часов. | `true` |
| `StartHour` | Час, начиная с которого разрешены хеджирование и пирамидинг. | 2 |
| `EndHour` | Час, после которого новые сделки не открываются. | 21 |
| `LotMultiplier` | Множитель объёма перед открытием хеджа. | 1.6 |
| `MaxMultiplications` | Максимальное количество мартингейл-шагов. | 5 |
| `StartDirection` | Направление первой позиции после выхода в ноль. | Buy |
| `MinProfit` | Требуемая плавающая прибыль (в деньгах) для полного закрытия. | 1.5 |
| `InitialVolume` | Базовый объём стартовой сделки и состояния после сброса. | 0.1 |
| `StopLossPips` | Дистанция в пунктах, запускающая следующий хедж. | 40 |
| `TakeProfitPips` | Дистанция в пунктах для пирамидинга. | 100 |

## Особенности реализации

- Метод `ProcessCandle` использует высокоуровневую подписку `SubscribeCandles().Bind(...)` и обрабатывает только закрытые свечи, что соответствует требованиям платформы.
- Хеджированные позиции отслеживаются во внутренних списках FIFO, поэтому стратегия имитирует поведение MetaTrader даже на неттинговых счетах.
- Пересчёт прибыли опирается на `Security.PriceStep` и `Security.StepPrice`. При их отсутствии используется произведение разницы цены на объём как запасной вариант.
- Стратегия работает непрерывно; отключение фильтра времени или расширение торговых часов делает её поведение идентичным оригинальному советнику, работающему без пауз.
