# Martin 1 策略
[English](README.md) | [Русский](README_ru.md)

将 MetaTrader 5 的 "Martin 1" 智能交易程序移植到 StockSharp 高级策略 API。算法始终保持持仓，通过对冲式马丁格尔步骤在回撤中对冲，同时在顺势行情中做金字塔加仓。

## 交易逻辑

1. **初始持仓**：当账户为空仓时，无论时间过滤是否启用，都会立即按照 `StartDirection` 指定的方向开仓。基础下单量来源于 `InitialVolume`，并向下取整到交易所允许的 `VolumeStep`。
2. **时间窗口过滤**：启用 `UseTradingHours` 后，仅在 `StartHour` 到 `EndHour`（含两端）的交易所时间内允许做加仓或对冲操作。
3. **盈利加仓**：每根已完成的 K 线都会评估现有持仓。如果多头持仓的浮动盈利超过设定的止盈距离且仍为正值，则再开一笔同样手数的多单；空头持仓采用对称逻辑。成交价视为当前 K 线的收盘价。
4. **对冲马丁格尔**：当起始方向为多头且浮亏超过 `(StopLossPips × 点值 × (当前加倍次数 + 1))` 时，会按 `LotMultiplier` 放大当前手数（向下取整到步长）并开出新的空头作为对冲，同时递增马丁格尔计数。若起始方向为空头，则执行镜像逻辑。达到 `MaxMultiplications` 次后不再继续加倍对冲。
5. **全局盈利目标**：计算所有剩余持仓的未实现盈亏，使用 `PriceStep` 和 `StepPrice` 将价差转换为货币。若总额超过 `MinProfit`，则全部平仓并重置马丁格尔状态。

## 风险与资金管理

- 点值基于品种的最小报价步长计算；对于三位或五位报价，会额外乘以 10，以模拟原始 EA 的点值调整。
- 委托数量总是向下取整到最近的 `VolumeStep`，若结果低于步长则放弃下单。
- 只要仓位被完全平掉（无论是自然平仓还是达成目标盈利），马丁格尔计数与当前手数都会被重置。
- 浮动盈利估算不考虑佣金与隔夜利息，与原程序一样仅依赖未实现 PnL。

## 参数

| 名称 | 说明 | 默认值 |
| --- | --- | --- |
| `CandleType` | 用于驱动策略的 K 线类型。 | 1 分钟 |
| `UseTradingHours` | 是否启用交易时间过滤。 | `true` |
| `StartHour` | 允许执行加仓或对冲的起始小时。 | 2 |
| `EndHour` | 停止执行加仓或对冲的截止小时。 | 21 |
| `LotMultiplier` | 每次触发对冲前对手数的放大倍数。 | 1.6 |
| `MaxMultiplications` | 最多允许的马丁格尔加倍次数。 | 5 |
| `StartDirection` | 空仓后首次建仓的方向。 | Buy |
| `MinProfit` | 触发一键平仓的浮动盈利（货币单位）。 | 1.5 |
| `InitialVolume` | 初次建仓和重置时使用的基础手数。 | 0.1 |
| `StopLossPips` | 触发下一次对冲的点数距离。 | 40 |
| `TakeProfitPips` | 触发顺势加仓的点数距离。 | 100 |

## 实现说明

- `ProcessCandle` 通过高阶的 `SubscribeCandles().Bind(...)` 管线，只处理已完成的 K 线，符合平台指南。
- 策略内部维护两个先进先出列表来跟踪多、空持仓，从而在净持仓账户上模拟 MetaTrader 的对冲行为。
- 盈亏换算优先使用 `Security.PriceStep` 与 `Security.StepPrice`；若无可用数据，则回退为价差乘以成交量。
- 策略持续运行；若关闭时间过滤或放宽交易时段，其行为将与原始全天候运行的 EA 相同。
