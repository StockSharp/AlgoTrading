# Стратегия Divergence MACD Stochastic

Стратегия переносит советник MetaTrader 5 **«Divergence EA pip sl tp»** в экосистему StockSharp. Алгоритм отслеживает классические дивергенции между ценой и гистограммой MACD и подтверждает сигналы фильтром стохастического осциллятора, прежде чем открыть разворотную позицию.

## Логика торговли

1. Подписка на свечи таймфрейма, заданного параметром `CandleType`.
2. На каждой завершённой свече рассчитываются гистограмма MACD (`MACD - Signal`) и значения стохастика %K/%D.
3. Хранятся последние два экстремума цены и гистограммы для определения дивергенций.
4. **Медвежья дивергенция** — новый максимум цены при меньшем пике гистограммы и %K выше `StochasticUpperLevel` инициирует короткую позицию или разворот из лонга.
5. **Бычья дивергенция** — новый минимум цены при более высокой впадине гистограммы и %K ниже `StochasticLowerLevel` открывает или переворачивает стратегию в лонг.
6. Необязательные `TakeProfitSteps` и `StopLossSteps` преобразуются в шаги цены и запускают встроенную защиту при старте стратегии.

## Особенности реализации

- Используется высокоуровневый API StockSharp с одной подпиской на свечи, связанной с индикаторами `MovingAverageConvergenceDivergenceSignal` и `StochasticOscillator`.
- Состояние дивергенции хранится во внутренних переменных без обращения к `GetValue`, что соответствует требованиям конвертации.
- При наличии области графика отображаются свечи, MACD и стохастик, а также сделки стратегии.
- При подтверждённом сигнале стратегия переворачивает позицию, добавляя абсолютное значение текущего объёма к базовому `Volume`.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `CandleType` | Таймфрейм для расчёта дивергенций. | Свечи 1 часа |
| `MacdFastLength`, `MacdSlowLength`, `MacdSignalLength` | Длины EMA индикатора MACD. | 12 / 26 / 9 |
| `MacdDivergenceThreshold` | Минимальная разница гистограммы между экстремумами для подтверждения дивергенции. | 0.0005 |
| `StochasticLength` | Быстрый период %K стохастика. | 50 |
| `StochasticSlowK`, `StochasticSlowD` | Дополнительные сглаживания %K и %D. | 9 / 9 |
| `StochasticUpperLevel`, `StochasticLowerLevel` | Уровни перекупленности и перепроданности для фильтрации сигналов. | 80 / 20 |
| `TakeProfitSteps`, `StopLossSteps` | Необязательные расстояния защитных ордеров в шагах цены (0 отключает уровень). | 50 |

## Использование

1. Привяжите стратегию к подключению StockSharp с инструментом, поддерживающим выбранный таймфрейм.
2. Настройте торговый объём через свойство `Volume` и при необходимости скорректируйте параметры индикаторов.
3. Запустите стратегию — при выполнении условий дивергенции и стохастика ордера будут выставляться автоматически.
