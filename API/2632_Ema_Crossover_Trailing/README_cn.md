# EMA 交叉移动止损策略

## 概览
该策略是 MQL5 专家顾问 **“Intersection 2 iMA”** 的 StockSharp 版本。策略在选定的 K 线序列上计算两条指数移动平均线（EMA），仅在完全收盘的 K 线上检测交叉信号。原始 EA 支持根据资金动态计算手数，本移植版本改为通过参数控制下单量，同时完整保留均线交叉与阶梯式移动止损的核心逻辑。

## 交易规则
1. **信号判定**
   - 在订阅的 K 线上分别计算快、慢 EMA。
   - 若上一根已完成 K 线上快 EMA 低于或等于慢 EMA，而当前数值出现快 EMA 上穿慢 EMA，则生成做多信号。
   - 若上一根已完成 K 线上快 EMA 高于或等于慢 EMA，而当前数值出现快 EMA 下穿慢 EMA，则生成做空信号。
2. **下单执行**
   - 出现做多信号且当前没有多头仓位时，发送市价买单。
   - 出现做空信号且当前没有空头仓位时，发送市价卖单。
   - 如果存在反向仓位，会在下单量中加入当前持仓的绝对值，从而先平掉旧仓再建立新仓，与原始 EA 先平仓再开仓的行为一致。
3. **移动止损**
   - 通过一个可配置的“点数”与品种 `PriceStep` 相乘，得到止损与价格之间的固定距离。
   - 只有当价格向盈利方向推进超过设定的“阶梯步长”时，才会更新止损位置，避免频繁修改。
   - 当价格触及移动止损时，使用市价单立即平仓。

## 参数说明
| 参数 | 含义 | 默认值 |
| --- | --- | --- |
| `FastPeriod` | 快速 EMA 的周期长度。 | 4 |
| `SlowPeriod` | 慢速 EMA 的周期长度。 | 18 |
| `TrailingStopPoints` | 移动止损与当前价格的距离，单位为价格步长（点）。设为 `0` 表示关闭移动止损。 | 20 |
| `TrailingStepPoints` | 更新移动止损前，价格至少需要向有利方向推进的点数。 | 5 |
| `CandleType` | 用于计算的 K 线类型或时间框架。 | 15 分钟 |
| `TradeVolume` | 每次下单的固定手数。 | 1 |

## 实现要点
- 使用高层 API `SubscribeCandles().Bind(...)` 将 K 线与 EMA 指标绑定，无需手动管理指标缓存。
- 移植时保留了原始 EA 中对 3/5 位数品种的“点值调整”思路：通过品种的 `PriceStep` 将点数转换为真实价格距离。
- StockSharp 不提供 `PositionModify` 的直接等价方法，因此移动止损以市价平仓实现；行为与原策略一致，只是实现方式不同。
- 所有关键参数均通过 `StrategyParam<T>` 暴露，方便在 Designer 中优化或在界面上调整。

## 使用建议
- 根据实际交易或回测的时间周期设置 `CandleType`，确保 EMA 计算一致。
- 对于 tick 很小的品种，请适当调整 `TrailingStopPoints` 与 `TrailingStepPoints`，实际价格距离等于 “点数 × PriceStep”。
- 通过 `TradeVolume` 参数设定合适的交易手数；策略会在反向信号出现时自动扩大下单量以一次性反手。

## 与原 EA 的差异
- 原策略使用 `MoneyFixedMargin` 计算动态手数，移植版本提供固定下单量参数，复杂的资金管理可以在外部完成。
- 源代码中的 `InpCloseHalf` 输入没有被实际使用，因此在移植中被省略。
- 移植后移动止损改为内部逻辑控制市价平仓，不再尝试修改已有止损单，便于在 StockSharp 环境中运行。
