# Стратегия EMA Crossover Trailing

## Обзор
Стратегия представляет собой перенос MQL5-советника **«Intersection 2 iMA»** в среду StockSharp. Логика основана на двух экспоненциальных скользящих средних (EMA), которые анализируются только на полностью сформированных свечах. В оригинале объём вычислялся через `MoneyFixedMargin`, поэтому в версии StockSharp он вынесен в отдельный параметр, а механика пересечения и трейлинг-стопа сохранена без изменений.

## Правила торговли
1. **Формирование сигналов**
   - Рассчитываются быстрая и медленная EMA на выбранном свечном таймфрейме.
   - **Покупка**: на предыдущей свече быстрая EMA была ниже или равна медленной, а на текущей закрытой свече быстрая EMA поднялась выше медленной.
   - **Продажа**: противоположное условие — быстрая EMA была выше или равна медленной и опустилась ниже неё на текущей свече.
2. **Исполнение сделок**
   - При сигнале на покупку и отсутствии длинной позиции отправляется рыночная заявка на покупку.
   - При сигнале на продажу и отсутствии короткой позиции отправляется рыночная заявка на продажу.
   - Если есть открытая позиция противоположного направления, заявка увеличивается на величину текущего объёма, чтобы закрыть её и мгновенно открыть новую, повторяя поведение исходного советника.
3. **Трейлинг-стоп**
   - Расстояние от цены до стопа задаётся в «пунктах» и умножается на `PriceStep`, что имитирует поправку на количество знаков после запятой в MQL5.
   - Стоп передвигается только после прохождения ценой заданного минимального шага, благодаря чему исключаются постоянные модификации.
   - При касании трейлинг-уровня позиция немедленно закрывается рыночным ордером.

## Параметры
| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `FastPeriod` | Период быстрой EMA. | 4 |
| `SlowPeriod` | Период медленной EMA. | 18 |
| `TrailingStopPoints` | Расстояние от цены до трейлинг-стопа в шагах цены. `0` отключает сопровождение. | 20 |
| `TrailingStepPoints` | Минимальный шаг, на который цена должна продвинуться в прибыльном направлении, прежде чем стоп будет передвинут. | 5 |
| `CandleType` | Тип (таймфрейм) свечей, используемых в расчётах. | 15 минут |
| `TradeVolume` | Фиксированный объём рыночных заявок. | 1 |

## Особенности реализации
- Для подписки на данные и индикаторы используется высокоуровневый вызов `SubscribeCandles().Bind(...)`, что избавляет от ручной работы с буферами, аналогичными `CopyBuffer` в MetaTrader.
- Функция `CalculateDistance` переводит введённое количество пунктов в реальное ценовое расстояние с учётом шага цены инструмента.
- В StockSharp отсутствует прямой аналог `PositionModify`, поэтому вместо модификации стоп-заявок применяется закрытие позиции рыночным ордером при достижении уровня стопа — поведенчески результат тот же.
- Все настройки оформлены через `StrategyParam<T>`, их можно изменять и оптимизировать в Designer.

## Рекомендации по использованию
- Подбирайте `CandleType` в соответствии с тем таймфреймом, на котором проводилась оптимизация исходного советника.
- При торговле инструментами с мелким шагом цены уменьшайте `TrailingStopPoints` и `TrailingStepPoints`, чтобы расстояние в деньгах соответствовало ожиданиям (формула: пункты × PriceStep).
- Значение `TradeVolume` можно связать с внешней системой управления капиталом: стратегия корректно отрабатывает переворот позиции при смене сигнала.

## Отличия от оригинального советника
- Динамическое определение лота через `MoneyFixedMargin` заменено на параметр фиксированного объёма. Продвинутые методы мани-менеджмента рекомендуется реализовывать во внешнем коде.
- В исходнике присутствовал флаг `InpCloseHalf`, но он нигде не использовался. В переносе он опущен.
- Логика трейлинг-стопа перенесена внутрь стратегии и реализована через рыночные выходы, что надёжнее для экосистемы StockSharp и не меняет торговый смысл.
