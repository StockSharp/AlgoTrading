# Percentage Crossover Channel 策略

## 概述
Percentage Crossover Channel 策略源自 MetaTrader 5 的 *Percentage_Crossover_Channel_EA* 智能交易程序。它在选定价格附近构建一个动态通道，并根据价格对通道边界或中线的触碰/交叉发出信号。本版本基于 StockSharp 高级 API，只处理已经收盘的K线数据。

## 通道构建
该自定义指标按照以下步骤生成价格通道：

1. 根据 **Applied Price** 参数选择基础价格（默认使用收盘价）。
2. 对基础价格应用长度为 1 的简单移动平均，得到短期参考值。
3. 使用 **Percent** 参数（例如 50 → ±0.5%）计算新的上下界限。
4. 将上一根K线的中轨值限制在新界限内，从而得到当前的中轨值。
5. 通过将中轨乘以 ±percent 系数得到上轨和下轨。

这种递归方式使得通道在趋势行情中逐步扩张，在盘整时保持紧凑，与 MQL5 指标的表现完全一致。

## 交易逻辑
策略提供两种信号模式：

- **触碰边界（默认）**
  - 做多：倒数第二根K线的最低价高于下轨，而最后一根收盘K线触及或跌破下轨。
  - 做空：倒数第二根K线的最高价低于上轨，而最后一根收盘K线触及或突破上轨。
- **穿越中线（TradeOnMiddleCross = true）**
  - 做多：价格从上向下穿越通道中线。
  - 做空：价格从下向上穿越通道中线。

开启 **ReverseSignals** 时，上述多空条件互换。出现新信号时，策略会以一笔市价单同时平仓并反向建仓，订单量等于配置的 **OrderVolume** 加上当前持仓的绝对值。

## 风险管理
策略提供与原始 EA 相同的可选止损/止盈设置：

- **StopLossPoints**：按交易品种的价格步长计算的止损距离（多单减去、空单加上）。
- **TakeProfitPoints**：按价格步长计算的止盈距离（多单加上、空单减去）。

当参数为 0 时，对应的保护功能被禁用。策略在每根收盘K线上根据最高价和最低价检测是否触发止损或止盈，不包含追踪止损逻辑。

## 参数说明
| 参数 | 含义 |
|------|------|
| `CandleType` | 订阅和处理的K线类型，默认 15 分钟。 |
| `Percent` | 通道宽度百分比，内部转换为 ±percent/100 系数。 |
| `PriceMode` | 通道所用价格：Close、Open、High、Low、Median (H+L)/2、Typical (H+L+C)/3、Weighted (H+L+2C)/4、Average (O+H+L+C)/4。 |
| `TradeOnMiddleCross` | 在边界触碰与中线交叉两种信号模式之间切换。 |
| `ReverseSignals` | 颠倒多空条件。 |
| `StopLossPoints` | 以价格步长表示的止损距离。 |
| `TakeProfitPoints` | 以价格步长表示的止盈距离。 |
| `OrderVolume` | 基础下单数量；在需要反向时会加上当前仓位的绝对值。 |

## 实现说明
- 策略只在K线收盘后下单，与原始 MT5 程序在下一根K线开盘执行交易的逻辑保持一致。
- 通道算法直接在策略内部实现，不创建额外的数据集合，只保留必要的标量状态。
- 止损和止盈由策略手动监控，用于模拟 MetaTrader 中的附加保护单。
- 使用前请确认交易品种提供有效的 `PriceStep`，否则止损/止盈距离无法计算。
