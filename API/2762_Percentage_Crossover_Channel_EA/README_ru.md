# Стратегия Percentage Crossover Channel

## Обзор
Percentage Crossover Channel — это стратегия, перенесённая из MetaTrader 5 (советник *Percentage_Crossover_Channel_EA*). Она строит динамический канал вокруг выбранной цены и реагирует либо на касания границ, либо на пересечения средней линии. Реализация на StockSharp повторяет исходную логику, обрабатывая только завершённые свечи через высокоуровневый API.

## Построение канала
Индикатор формирует канал согласно следующему алгоритму:

1. Вычисляется базовая цена по выбранному режиму **Applied Price** (по умолчанию Close).
2. На цену накладывается скользящая средняя длиной 1 для получения эталонного значения.
3. По параметру **Percent** (например, 50 → ±0,5%) рассчитываются верхняя и нижняя границы для допустимого положения средней линии.
4. Предыдущее значение средней линии «зажимается» в пределах новых границ, чтобы сформировать текущую среднюю.
5. Верхняя и нижняя линии канала равны среднему значению, умноженному на коэффициенты ±percent.

Такая рекурсия позволяет каналу расширяться во время тренда и сужаться в фазах консолидации, что точно соответствует поведению индикатора в MQL5.

## Торговая логика
Поддерживаются два режима сигналов:

- **Касание границы (значение по умолчанию):**
  - Покупка, если минимум предпоследней свечи находился выше нижней границы, а последняя завершённая свеча касается или пробивает нижнюю линию.
  - Продажа, если максимум предпоследней свечи был ниже верхней границы, а последняя свеча касается или пробивает верхнюю линию.
- **Пересечение средней (TradeOnMiddleCross = true):**
  - Покупка при переходе цены через среднюю линию сверху вниз.
  - Продажа при пересечении средней снизу вверх.

Флаг **ReverseSignals** меняет местами условия для длинных и коротких позиций. При появлении нового сигнала стратегия закрывает и разворачивает открытую позицию одной рыночной заявкой объёмом **OrderVolume** плюс абсолютное значение текущей позиции.

## Управление рисками
Опциональные защитные уровни повторяют настройки стоп-лосса и тейк-профита из оригинального советника:

- **StopLossPoints** — расстояние в шагах цены, вычитаемое (для покупок) или добавляемое (для продаж) от оценочной цены входа.
- **TakeProfitPoints** — расстояние в шагах цены, добавляемое (для покупок) или вычитаемое (для продаж) от цены входа.

Нулевое значение отключает соответствующую защиту. Проверка срабатывания выполняется на каждой завершённой свече по экстремумам High/Low. Трейлинг-стоп не используется.

## Параметры
| Параметр | Описание |
|----------|----------|
| `CandleType` | Тип свечей, которые обрабатывает стратегия (по умолчанию таймфрейм 15 минут). |
| `Percent` | Ширина канала в процентах от цены (преобразуется в коэффициенты ±percent/100). |
| `PriceMode` | Режим базовой цены: Close, Open, High, Low, Median (H+L)/2, Typical (H+L+C)/3, Weighted (H+L+2C)/4, Average (O+H+L+C)/4. |
| `TradeOnMiddleCross` | Переключение между касанием границ и пересечением средней линии. |
| `ReverseSignals` | Инверсия длинных и коротких сигналов. |
| `StopLossPoints` | Дистанция стоп-лосса в шагах цены инструмента. |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены. |
| `OrderVolume` | Базовый объём рыночных заявок; при развороте добавляется величина текущей позиции. |

## Особенности реализации
- Заявки формируются только после закрытия свечи, что соответствует логике MT5, где сделки открывались в начале следующего бара на основании данных предыдущего.
- Индикатор канала реализован в самой стратегии без хранения массивов исторических данных — используются только скалярные состояния.
- Защитные ордера моделируются вручную, чтобы воспроизвести обработку стопов и тейков из платформы MetaTrader.
- Для корректной работы стоп-уровней у инструмента должен быть задан `PriceStep`; при его отсутствии стопы и тейки игнорируются.
