# MartingailExpert v1.0 Stochastic (C#)

## Обзор

**MartingailExpert v1.0 Stochastic** — перенос советника `MartingailExpert_v1_0_Stochastic.mq4` с MetaTrader 4
на высокоуровневый API StockSharp. Стратегия анализирует линии %K и %D стохастика и открывает позицию, когда
значения предыдущей завершённой свечи подтверждают импульс выше (для покупок) или ниже (для продаж) заданных
порогов. После входа запускается мартингейл: последующие рыночные ордера увеличиваются по объёму и делят
общий тейк-профит, «привязанный» к цене последнего усреднения.

Реализация использует подписку на свечи, привязку индикатора через `BindEx`, а также стандартные методы
`BuyMarket`/`SellMarket`. Все комментарии переведены на английский язык, а табуляция соответствует требованиям
файла `AGENTS.md`.

## Логика торговли

### 1. Сигнал на вход

1. Стохастик настраивается со значениями `Length = KPeriod`, `K.Length = Slowing`, `D.Length = DPeriod` и
   обрабатывает только закрытые свечи.
2. Чтобы повторить вызов `iStochastic(..., shift = 1)`, стратегия запоминает значения %K и %D предыдущей
   свечи. Покупка открывается, если `K_prev > D_prev` и `D_prev > ZoneBuy`. Продажа — когда `K_prev < D_prev`
   и `D_prev < ZoneSell`.
3. Первое усреднение использует объём `BuyVolume` или `SellVolume` и полностью сбрасывает состояние
   противоположного направления.

### 2. Мартингейл-усреднение

1. При наличии открытого кластера (`_buyOrderCount` или `_sellOrderCount`) отслеживаются минимум свечи для
   длинных позиций и максимум — для коротких.
2. **Расстояние между ордерами**:
   * `StepMode = 0`: цена должна пройти `StepPoints × PointSize` против последнего входа.
   * `StepMode = 1`: используется формула `StepPoints + max(0, 2 × ordersCount − 2)`, полностью повторяющая
     выражение из MQL `step + OrdersTotal*2 - 2`. Результат умножается на размер пункта, рассчитанный на
     основе `Security.PriceStep` (для 3 и 5 знаков после запятой применяется множитель 10).
3. При достижении уровня триггера отправляется рыночный ордер объёмом `previousVolume × Multiplier`. Объём
   нормализуется по `VolumeStep`, ограничивается `VolumeMax` (если задан) и отбрасывается до нуля при значении
   ниже `VolumeMin`.
4. После каждой сделки общий тейк-профит обновляется до
   `lastEntryPrice ± ProfitFactorPoints × PointSize × orderCount` с учётом направления позиции.

### 3. Управление тейк-профитом

1. Кластер закрывается, как только свеча касается целевого уровня (`High >= target` для покупок,
   `Low <= target` для продаж). Дополнительно оценивается потенциальная прибыль через средневзвешенную цену
   входа, что имитирует проверку `OrderProfit()` из исходного кода.
2. Закрытие выполняется единым вызовом `SellMarket(Math.Abs(Position))` или `BuyMarket(Math.Abs(Position))`,
   после чего мартингейл-состояние сбрасывается.
3. Если позиция закрыта внешними причинами (ручное вмешательство, стоп-аут), следующая свеча с `Position == 0`
   автоматически очищает внутренние счётчики.

### 4. Дополнительные детали реализации

* Размер пункта определяется через `Security.PriceStep`; для инструментов с 3 или 5 десятичными знаками
  используется множитель 10, как в MetaTrader.
* В `OnStarted` вызывается `StartProtection()` для подключения стандартных защитных механизмов StockSharp.
* На график выводятся свечи, стохастик и собственные сделки, что облегчает анализ при тестировании.

## Параметры

| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --------------------- | -------- |
| `StepPoints` | decimal | `25` | Расстояние в пунктах перед следующим усреднением. |
| `StepMode` | int | `0` | `0` — фиксированное расстояние, `1` — фиксированное плюс `2 × ordersCount − 2`. |
| `ProfitFactorPoints` | decimal | `10` | Количество пунктов на ордер для расчёта общего тейк-профита. |
| `Multiplier` | decimal | `1.5` | Множитель объёма при очередном усреднении. |
| `BuyVolume` | decimal | `0.01` | Объём первого покупочного ордера. |
| `SellVolume` | decimal | `0.01` | Объём первого продажного ордера. |
| `KPeriod` | int | `200` | Период %K стохастика. |
| `DPeriod` | int | `20` | Период сглаживания %D. |
| `Slowing` | int | `20` | Дополнительное сглаживание %K (MetaTrader `slowing`). |
| `ZoneBuy` | decimal | `50` | Минимальное значение %D для разрешения покупок. |
| `ZoneSell` | decimal | `50` | Максимальное значение %D для разрешения продаж. |
| `CandleType` | `DataType` | `5 минут` | Тип свечей, используемый в вычислениях. |

## Структура папки

```
API/3991/
├── CS/
│   └── MartingailExpertV10StochasticStrategy.cs
├── README.md
├── README_cn.md
└── README_ru.md
```

Версия на Python намеренно отсутствует в соответствии с требованиями задачи.
