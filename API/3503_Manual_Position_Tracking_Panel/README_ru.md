# Стратегия Manual Position Tracking Panel

## Описание

Изначальный советник для MetaTrader 5 представлял собой панель управления, с помощью которой трейдер вручную работал максимум с пятью длинными и пятью короткими позициями: удалял имеющиеся тейк-профиты, пересчитывал новые уровни от цены входа и переносил их в безубыток. При портировании на StockSharp визуальный интерфейс исчез, а вся логика защиты позиций стала выполняться автоматически. Стратегия отслеживает совокупную позицию по выбранному инструменту и поддерживает защитный лимитный ордер на тейк-профит, полностью повторяя алгоритм панели.

Автоматизированные действия:

- Выставление тейк-профита на расстоянии заданного количества MetaTrader-пунктов от средней цены входа при появлении позиции.
- Перенос тейк-профита в точку безубытка, когда рынок проходит требуемое количество пунктов в благоприятную сторону.
- Учет брокерских ограничений по freeze/stop уровням из Level1-данных либо расчет защитного зазора через текущий спред и настраиваемый коэффициент.
- Отмена защитного ордера при закрытии позиции или отключении управления, что эквивалентно кнопке «Delete TP» в оригинальной панели.

Реализация использует только высокоуровневые возможности StockSharp (`SubscribeLevel1`, `SellLimit`, `BuyLimit`, `ReRegisterOrder` и т.д.) и автоматически нормализует цену/объем относительно шагов инструмента.

## Параметры

| Параметр | Назначение |
|----------|------------|
| **Take profit distance (pips)** | Расстояние от цены входа до тейк-профита в MetaTrader-пунктах. |
| **Enable entry-based take profit** | Автоматически выставлять тейк-профит от цены входа. При отключении стратегия реагирует только на перенос в безубыток. |
| **Enable break-even** | Включить перенос тейк-профита в безубыток при выполнении условия. |
| **Break-even trigger (pips)** | Минимальное благоприятное движение (в пунктах), необходимое для переноса в безубыток. Значение `0` означает немедленный перенос. |
| **Manage long positions** | Управлять длинной стороной совокупной позиции. |
| **Manage short positions** | Управлять короткой стороной позиции. |
| **Remove take profit when disabled** | Удалять защитный ордер, если условия управления не выполняются. |
| **Log management actions** | Записывать в лог каждое создание/изменение/отмену тейк-профита. |
| **Freeze distance multiplier** | Коэффициент для расчета защитного зазора по текущему спреду, когда биржа не публикует ограничения. |

## Логика работы

1. При запуске выполняется подписка на Level1-данные, чтобы отслеживать bid/ask и возможные ограничения брокера.
2. При появлении новых сделок, изменении позиции или обновлении Level1 стратегия заново рассчитывает целевой уровень защиты.
3. Если позиции нет, существующий тейк-профит отменяется.
4. При наличии позиции и разрешенной стороне алгоритм:
   - Вычисляет базовый уровень от цены входа на заданное расстояние (если включена опция).
   - При активированном безубытке и достаточном движении рынка ограничивает уровень средней ценой входа.
   - Корректирует цель с учетом freeze/stop расстояний и текущего рынка.
   - Нормализует цену/объем и регистрирует/перерегистрирует противоположный лимитный ордер.
5. Если управление стороной отключено, а параметр **Remove take profit when disabled** активен, ордер отменяется.

## Управление рисками

- Стратегия не устанавливает стоп-лоссы и не реализует трейлинг или частичное закрытие — только тейк-профит.
- Для совместимости с валютными парами автоматически вычисляется стоимость пункта на основе `PriceStep` и точности инструмента.
- При отсутствии данных о брокерских ограничениях параметр коэффициента позволяет создать буфер и избежать отказов в модификации.
- Стратегия не инициирует новые входы в рынок; предполагается, что открытия выполняются вручную или сторонними алгоритмами.

## Рекомендации по использованию

1. Подключите стратегию к нужному инструменту и убедитесь, что коннектор предоставляет Level1-данные.
2. Настройте расстояние тейк-профита, соответствующее значениям из MetaTrader.
3. Включите перенос в безубыток, если необходимо фиксировать прибыль после движения цены, при значении триггера `0` безубыток активируется сразу.
4. Отключайте управление для выбранной стороны, если хотите оставить ее под ручным контролем.
5. При включенном **Log management actions** отслеживайте сообщения в логе, чтобы убедиться в корректной работе алгоритма.

