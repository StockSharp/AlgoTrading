# Стратегия TenPips Momentum

**TenPips** — порт MetaTrader-советника "10PIPS" на высокоуровневый API StockSharp. Стратегия объединяет быстрые и медленные линейно-взвешенные скользящие средние на рабочем таймфрейме, подтверждение импульса на старшем интервале и месячный фильтр MACD. Денежный блок повторяет оригинал: фиксированные стопы/тейки в пунктах, перевод в безубыток, трейлинг, цели по прибыли и защита по просадке капитала.

## Логика сигналов

1. **Основной таймфрейм** (`CandleType`, по умолчанию 15 минут) формирует поток цен. Скользящие считаются по типичной цене `(High + Low + Close) / 3`.
2. **Импульс старшего интервала** (`MomentumCandleType`, по умолчанию 1 час) преобразует разностной индикатор StockSharp в метатрейдеровское отношение `Close / Close(period) * 100`. Абсолютное отклонение от 100 за последние три бара должно превышать `MomentumThreshold`.
3. **Месячный MACD** (`MacdCandleType`, по умолчанию 30-дневные свечи) требует, чтобы линия MACD была выше сигнальной для лонга и ниже для шорта.

Условия входа в лонг:
- предыдущая свеча закрылась выше быстрой LWMA после пробоя снизу,
- быстрая LWMA выше медленной,
- минимум одно из трёх последних импульсных значений превосходит `MomentumThreshold`,
- фильтр MACD в бычьем состоянии.

Шорт строится симметрично: закрытие ниже LWMA, быстрая ниже медленной, импульс выше порога, MACD медвежий.

StockSharp использует неттинг, поэтому открывается одна совокупная позиция в сторону сигнала. Если стратегия находится в шорте и приходит сигнал на покупку, объём заявки автоматически перекрывает шорт и формирует требуемый лонг.

## Управление рисками и капиталом

- **Фиксированные расстояния** — `StopLossPips` и `TakeProfitPips` переводят метатрейдеровские пункты в ценовые смещения через `PriceStep`. При достижении уровней позиция закрывается рыночной заявкой.
- **Трейлинг** — `TrailingStopPips` сопровождает максимум (для лонга) или минимум (для шорта) после входа.
- **Перевод в безубыток** — при включении `UseBreakEven` и достижении `BreakEvenTriggerPips` стоп переносится к цене входа с добавкой `BreakEvenOffsetPips`.
- **Денежные цели** — блок `UseMoneyTakeProfit`, `UsePercentTakeProfit`, `EnableMoneyTrailing` реализует `TP_In_Money`, `TP_In_Percent` и "денежный" трейлинг оригинала. Используется нереализованный PnL по закрытию свечи.
- **Защита капитала** — `UseEquityStop` + `EquityRiskPercent` повторяют `UseEquityStop` / `TotalEquityRisk`, закрывая позицию при превышении заданной просадки от локального максимума капитала.
- **Флаг выхода по MACD** — `UseMacdExit` отвечает параметру `Exit`, закрывая позицию при смене сигнала месячного MACD.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `TradeVolume` | `0.01` | Объём рыночных заявок (аналог лота в MetaTrader). |
| `CandleType` | 15 минут | Основной таймфрейм для расчётов и сделок. |
| `MomentumCandleType` | 1 час | Старший таймфрейм для импульса. |
| `MacdCandleType` | 30 дней | Таймфрейм для фильтра MACD (замена месячных свечей MT4). |
| `FastMaPeriod` | `8` | Период быстрой LWMA. |
| `SlowMaPeriod` | `50` | Период медленной LWMA. |
| `MomentumPeriod` | `14` | Глубина индикатора импульса. |
| `MomentumThreshold` | `0.3` | Минимальное отклонение импульса от 100 за три последних бара HTF. |
| `StopLossPips` | `20` | Стоп-лосс в пунктах. `0` отключает уровень. |
| `TakeProfitPips` | `50` | Тейк-профит в пунктах. `0` отключает уровень. |
| `TrailingStopPips` | `40` | Дистанция трейлинг-стопа в пунктах. |
| `UseBreakEven` | `true` | Включает перевод в безубыток. |
| `BreakEvenTriggerPips` | `30` | Прибыль в пунктах для активации безубытка. |
| `BreakEvenOffsetPips` | `30` | Добавка к стопу при переносе в безубыток. |
| `UseMoneyTakeProfit` | `false` | Закрыть позицию при достижении `MoneyTakeProfit`. |
| `MoneyTakeProfit` | `10` | Цель по прибыли в валюте счёта. |
| `UsePercentTakeProfit` | `false` | Закрыть позицию при наборе `PercentTakeProfit` процентов от стартового капитала. |
| `PercentTakeProfit` | `10` | Процентная цель. |
| `EnableMoneyTrailing` | `true` | Включить денежный трейлинг (`MoneyTrailTarget` / `MoneyTrailStop`). |
| `MoneyTrailTarget` | `40` | Прибыль для активации денежного трейлинга. |
| `MoneyTrailStop` | `10` | Допустимый откат после активации денежного трейлинга. |
| `UseEquityStop` | `true` | Включить защиту капитала. |
| `EquityRiskPercent` | `1` | Допустимая просадка от пика капитала в процентах. |
| `UseMacdExit` | `false` | Закрывать позицию при обратном сигнале MACD на макро-таймфрейме. |

## Особенности реализации

- Пересчёт пунктов идентичен советнику: при `PriceStep = 0.00001` или `0.001` один пункт равен десяти тикам, иначе используется чистый шаг цены.
- Индикатор Momentum в StockSharp возвращает разницу цен. Для сопоставимости значения преобразуются к отношению, принятому в MetaTrader, и только потом сравниваются с `MomentumThreshold`.
- Неттинговая модель не поддерживает мультиордерный мартингейл (`IncreaseFactor`, `LotExponent`, `Max_Trades`), поэтому объём при реверсе автоматически включает закрытие противоположной позиции.
- Все защитные операции выполняются рыночными ордерами, как и в исходном эксперт-советнике.
- При наличии графика отображаются свечи, обе LWMA, импульс и месячный MACD.

## Как использовать

1. Настройте таймфреймы `CandleType`, `MomentumCandleType`, `MacdCandleType` в соответствии с конфигурацией в MetaTrader.
2. Подберите значения `StopLossPips`, `TakeProfitPips`, `TrailingStopPips` и параметров безубытка под шаг цены выбранного инструмента.
3. Включите или отключите денежные цели, защиту капитала и досрочный выход по MACD исходя из требований риск-менеджмента.
4. Запустите стратегию — она подпишется на три потока свечей, будет открывать сделки по правилам советника и закрывать позицию при срабатывании защитных модулей.
