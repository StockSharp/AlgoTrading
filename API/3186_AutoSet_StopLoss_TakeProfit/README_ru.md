# Стратегия автоматического стоп-лосса и тейк-профита
[English](README.md) | [中文](README_cn.md)

Утилитарная стратегия автоматически выставляет защитные заявки стоп-лосса и тейк-профита для каждой открытой позиции по выбранному инструменту. Она повторяет поведение оригинального советника MetaTrader «AutoSet SL TP»: отслеживает список активных позиций и перед отправкой заявок проверяет соблюдение брокерских ограничений по расстоянию.

Стратегия не открывает сделки самостоятельно. Она наблюдает за объёмом, направлением и ценой исполнения позиций, которые созданы вручную либо другими алгоритмами. Как только появляется длинная или короткая позиция, алгоритм рассчитывает желаемые уровни стоп-лосса и тейк-профита в «метатрейдеровских» пунктах, корректирует их в соответствии с ограничениями Freeze/Stop, предоставленными торговой площадкой, и регистрирует соответствующие защитные заявки. После полного закрытия позиции выставленные стоп и тейк отменяются автоматически.

## Алгоритм работы

1. Подписывается на данные Level1, чтобы получать лучшие цены bid/ask, а также необязательные поля `StopLevel` и `FreezeLevel`, которые публикует брокер.
2. Переводит заданные расстояния в пунктах в абсолютные цены с учётом биржевого шага цены и количества знаков. Котировки с тремя и пятью знаками масштабируются в десять раз, чтобы совпасть с трактовкой пунктов в MetaTrader.
3. При каждом обновлении котировок или появлении личной сделки:
   - Игнорирует событие, если нет открытой позиции или её направление не проходит по фильтру (только buy, только sell или оба варианта).
   - Вычисляет минимально допустимое расстояние от рыночной цены до защитной заявки. Если брокер не передаёт уровни Freeze/Stop, используется запас по умолчанию — три спреда, умноженные на 1.1.
   - Определяет цены стоп-лосса и тейк-профита относительно текущего ask (для длинных позиций) либо bid (для коротких), после чего нормализует значения по шагу цены инструмента.
   - Создаёт или пере-регистрирует защитные stop/limit-заявки точно на объём позиции. Перерегистрация выполняется только при изменении целевой цены или объёма, что сокращает количество модификаций на бирже.
4. При обнулении позиции все висящие защитные заявки отменяются. Если направление позиции перестаёт подходить под фильтр, заявки также снимаются.

Благодаря тому, что алгоритм ориентируется исключительно на внешние исполнения, его можно комбинировать с ручной торговлей, панелями и другими автоматическими системами, управляющими входами, — стратегия обеспечивает единый защитный контур.

## Параметры

- **`StopLossPips`** — расстояние от текущей цены до стоп-лосса в пунктах MetaTrader. Значение `0` отключает стоп-заявку. Значение по умолчанию: `50`.
- **`TakeProfitPips`** — расстояние до тейк-профита в пунктах MetaTrader. Значение `0` отключает тейк-профит. Значение по умолчанию: `140`.
- **`DirectionFilter`** — направление позиций, для которых выставляются защиты:
  - `Buy` — защищаются только длинные позиции.
  - `Sell` — защищаются только короткие позиции.
  - `BuySell` — защищаются обе стороны (поведение, совпадающее с исходным советником).

## Практические замечания

- Защитные заявки создаются на полный объём позиции. Если брокер ограничивает минимальный или максимальный лот, стратегия предварительно округляет объём к ближайшему допустимому значению.
- Для обновления активных защитных заявок используется метод `ReRegisterOrder`, что позволяет по возможности сохранять исходный идентификатор заявки и избегать лишних отмен.
- Запас по расстоянию (спред × 3 × 1.1) предотвращает нарушение скрытых ограничений площадки, когда явные значения Freeze/Stop отсутствуют.
- Стратегию можно запускать до открытия позиций или после. Любая подходящая позиция, которая уже существует в момент запуска, будет защищена сразу после первого обновления котировок.
- «Пункты» MetaTrader отличаются от биржевого шага цены на инструментах с тремя и пятью знаками. Стратегия повторяет логику исходного советника, умножая шаг точки, чтобы значения параметров полностью совпадали с настройками MT5.

## Отличия от эксперта MetaTrader

- Вместо модификации атрибутов стоп-лосса и тейк-профита внутри позиции StockSharp размещает явные защитные stop- и limit-заявки. Это делает работу алгоритма полностью прозрачной в стакане заявок.
- Версия под StockSharp использует данные Level1 для восстановления ограничений брокера. Если провайдер публикует иные названия полей для Freeze/Stop, стратегия автоматически подбирает их из перечисления `Level1Fields`.
- Все комментарии в коде и сообщения журнала выполнены на английском языке согласно требованиям репозитория, а документация доступна на русском и китайском языках для удобства пользователей.
