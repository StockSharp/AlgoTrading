# Ytg 多重随机指标策略

## 策略来源
- 由 MetaTrader 4 专家顾问 `ytg_Multi_Stoch.mq4` 移植而来。
- 原策略在每根柱线结束时同时检查多个外汇品种的随机指标交叉情况。
- 在 StockSharp 中保留了多品种流程，并把以“点（pip）”表示的风控距离换算为价格偏移量。

## 交易逻辑
1. 按参数设置最多监控四个交易品种，使用同一根 K 线时间框架。
2. 为每个品种计算参数为 K=5、D=3、Slowing=3、简单移动平均平滑的随机振荡指标。
3. 满足以下条件时产生**做多**信号：
   - 当前 %K 低于 20（超卖）。
   - 上一根柱线的 %K 低于上一根柱线的 %D（快线在慢线之下）。
   - 当前 %K 上穿当前 %D（出现金叉）。
4. 满足以下条件时产生**做空**信号：
   - 当前 %K 高于 80（超买）。
   - 上一根柱线的 %K 高于上一根柱线的 %D。
   - 当前 %K 下穿当前 %D（出现死叉）。
5. 每个品种只允许持有一个方向的仓位，若已有仓位或未完成的保护目标则忽略新的入场信号。
6. 建仓后立即按照参数中的点数距离计算止损与止盈价格，距离基于品种的最小报价步长换算。
7. 每根完成的 K 线都会先检查止损和止盈；若达到其中任意目标，立即以市价平仓并重置内部状态。

## 风控与仓位管理
- **止损**：按照设定的点数距离，在多头时减去、空头时加上该距离得到触发价。
- **止盈**：按照设定的点数距离，在多头时加上、空头时减去该距离得到触发价。
- 将止损或止盈设置为 0 可以关闭对应的保护功能。
- 策略会自动从 `Security.PriceStep` 推导单个点的大小；对于 5 位报价等情况会自动放大到常用 pip 单位（0.0001）。

## 参数说明
| 名称 | 含义 | 默认值 |
| --- | --- | --- |
| `UseSymbol1..4` | 是否启用四个品种槽位。 | `true` |
| `Symbol1..4` | 每个槽位对应的交易品种。 | `null` |
| `TradeVolume` | 新开仓时使用的基础手数。 | `0.01` |
| `StopLossPips` | 止损距离（点数）。 | `50` |
| `TakeProfitPips` | 止盈距离（点数）。 | `10` |
| `CandleType` | 用于计算信号的 K 线周期。 | `30 分钟` |

## 多品种处理
- 通过高层 API `SubscribeCandles` 为每个启用的品种单独注册蜡烛订阅。
- 每个订阅都绑定各自的 `StochasticOscillator` 指标，并在公共回调中处理结果。
- 使用内部上下文对象分别记录每个品种的仓位方向、止损止盈及上一根 K 线的指标数值。

## 使用建议
- 在启动策略前为各个槽位指定要交易的品种，未启用的槽位可以保持空值。
- 确保所选投资组合能够交易全部品种，策略会通过 `GetPositionValue` 查询持仓量。
- 由于逻辑基于已完成的 K 线，请连接能够提供蜡烛数据的源（例如 `TimeFrameCandleBuilder`）。
- 调整止损或止盈参数后会立即影响当前持仓，因为策略在每根 K 线收盘时优先检查保护目标。

## 与 MQL 版本的差异
- StockSharp 版本使用市价单直接下单，而原始 EA 在 `OrderSend` 中同时附带止损/止盈。
- 止损止盈由策略内部逻辑模拟，不依赖券商端挂单，从而提升跨平台一致性。
- 增加了 `IsFormedAndOnlineAndAllowTrading()` 检查，只有当数据流与连接状态正常时才执行交易。
