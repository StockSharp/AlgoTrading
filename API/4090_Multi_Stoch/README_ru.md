# Стратегия Ytg Multi Stoch

## Источник
- Конвертация из советника MetaTrader 4 `ytg_Multi_Stoch.mq4`.
- Оригинальная версия анализировала несколько валютных пар на закрытии каждой свечи и искала пересечения линий стохастика в крайних зонах.
- В StockSharp сохранена мультиинструментальная логика, а значения в пунктах (pips) преобразуются в ценовые отступы.

## Логика торговли
1. Одновременно отслеживаются до четырёх инструментов, выбранных пользователем, на одном и том же таймфрейме.
2. Для каждого инструмента рассчитывается стохастический осциллятор с параметрами K=5, D=3, Slowing=3 и усреднением по простой скользящей средней.
3. **Покупка** выполняется, если выполняются условия:
   - Текущее значение %K ниже 20 (зона перепроданности).
   - Предыдущее значение %K было ниже предыдущего %D (быстрая линия находилась под сигнальной).
   - Текущее значение %K пересекло %D снизу вверх.
4. **Продажа** выполняется, если выполняются условия:
   - Текущее значение %K выше 80 (зона перекупленности).
   - Предыдущее значение %K было выше предыдущего %D.
   - Текущее значение %K пересекло %D сверху вниз.
5. По каждому инструменту допускается только одна позиция. Пока позиция или защитные уровни активны, новые сигналы игнорируются.
6. После входа рассчитываются уровни стоп-лосса и тейк-профита по заданному расстоянию в пунктах, используя шаг цены инструмента.
7. На закрытии каждой свечи сначала проверяются защитные уровни. При достижении любого из них позиция закрывается рыночным ордером, а состояние сбрасывается.

## Управление рисками и сделками
- **Стоп-лосс**: расстояние в пунктах, вычитаемое из цены входа для длинной позиции и прибавляемое для короткой.
- **Тейк-профит**: расстояние в пунктах, прибавляемое к цене входа для длинной позиции и вычитаемое для короткой.
- Любой уровень можно отключить, установив значение 0.
- Размер пункта определяется автоматически через `Security.PriceStep`. Если биржа предоставляет пятую цифру (0.00001), значение масштабируется до стандартного pip (0.0001).

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `UseSymbol1..4` | Включение каждого из четырёх слотов инструментов. | `true` |
| `Symbol1..4` | Инструменты, назначенные слотам. | `null` |
| `TradeVolume` | Объём рыночного ордера при открытии. | `0.01` |
| `StopLossPips` | Дистанция стоп-лосса в пунктах. | `50` |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | `10` |
| `CandleType` | Таймфрейм свечей для расчётов. | `30 минут` |

## Работа с несколькими инструментами
- Для каждого активного инструмента создаётся отдельная подписка через `SubscribeCandles`.
- Подписка связывается с собственным экземпляром `StochasticOscillator`, а обработчик получает результаты через высокоуровневый API.
- Внутренний контекст хранит предыдущие значения осциллятора, направление позиции и уровни защитных приказов по каждому инструменту.

## Рекомендации по использованию
- Перед запуском стратегии заполните поля инструментов, которые планируется торговать; отключённые слоты можно оставить пустыми.
- Убедитесь, что выбранный портфель поддерживает торговлю указанными инструментами. Стратегия использует `GetPositionValue` для определения объёма позиции.
- Стратегия работает по завершённым свечам, поэтому требуется источник данных, предоставляющий свечные серии (например, `TimeFrameCandleBuilder`).
- Изменения параметров стоп-лосса и тейк-профита применяются немедленно, так как проверка защитных уровней выполняется до анализа новых сигналов.

## Отличия от версии на MQL4
- В StockSharp применяется рыночный вход с явным объёмом, тогда как оригинал использовал `OrderSend` с прикреплёнными стоп/лимит приказами брокера.
- Защитные уровни исполняются логикой стратегии, что обеспечивает единое поведение независимо от торговой площадки.
- Добавлены проверки готовности подключения (`IsFormedAndOnlineAndAllowTrading()`), чтобы торги велись только при корректном состоянии соединения и данных.
