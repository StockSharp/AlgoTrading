# VQ EA

## Обзор
- Конверсия эксперта MetaTrader «VQ_EA», работающего по индикатору Volatility Quality.
- В версии StockSharp линия VQ аппроксимируется сглаженной медианной ценой, что позволяет использовать высокоуровневый API.
- Сделки открываются при смене направления сглаженной кривой, защита позиции настраивается через стоп-параметры.

## Поведение оригинального MQL-советника
1. Получает сигналы покупки и продажи из пользовательского индикатора VQ (буферы 3 и 4).
2. Открывает рыночную позицию при появлении нового сигнала, если по этому направлению ещё нет сделки.
3. При противоположном сигнале немедленно закрывает обратную позицию.
4. Дополнительно реализованы фиксированные/дробные лоты, перевод в безубыток, трейлинг, логирование и системы оповещений.

## Реализация в StockSharp
- Вместо оригинального индикатора применяется простое скользящее среднее медианной цены с дополнительным сглаживанием.
- Угол наклона этой кривой имитирует смену цвета линии VQ.
- Фильтр в пунктах подавляет незначительные колебания.
- Входы и выходы выполняются рыночными ордерами, как и в MetaTrader-версии.

### Формирование сигналов
1. Подписка на выбранный тип свечей и расчёт медианной цены для каждой завершённой свечи.
2. Применение базового сглаживания (`Length`) и, при необходимости, второго сглаживания (`Smoothing`).
3. Сравнение текущего сглаженного значения с предыдущим. Если абсолютное изменение превышает `FilterPoints` (в ценовых единицах), определяется направление.
4. Переход направления из «вниз» в «вверх» даёт сигнал на покупку, из «вверх» в «вниз» — на продажу. При открытии добавляется объём противоположной позиции для реверса.

### Управление рисками
- `StopLossPoints`, `TakeProfitPoints` и `TrailingStopPoints` переводятся в абсолютные цены с учётом шага цены инструмента (`PriceStep`).
- При включении любой защиты вызывается `StartProtection` с использованием рыночных ордеров, что повторяет механику исходного советника.
- Трейлинг активен только при `UseTrailing = true` и положительном значении шага.

## Параметры
- `Length` – базовый период сглаживания медианной цены. Значение по умолчанию: 5.
- `Smoothing` – дополнительный период сглаживания. Значение по умолчанию: 1 (выключено).
- `FilterPoints` – минимальное изменение в пунктах для подтверждения смены направления. Значение по умолчанию: 5.
- `StopLossPoints` – стоп-лосс в пунктах. Значение по умолчанию: 60 (0 отключает).
- `TakeProfitPoints` – тейк-профит в пунктах. Значение по умолчанию: 0 (отключён).
- `UseTrailing` – включение трейлинг-стопа. Значение по умолчанию: false.
- `TrailingStopPoints` – расстояние трейлинг-стопа в пунктах. Значение по умолчанию: 0 (игнорируется, если трейлинг выключен).
- `CandleType` – используемый таймфрейм. Значение по умолчанию: свечи 1 часа.
- `Volume` – наследуется от `Strategy.Volume`, по умолчанию 1 контракт и применяется к каждому входу.

## Отличия от оригинала
- Линия VQ не переносилась напрямую, используется приближение на основе медианной цены.
- Не реализованы перевод в безубыток, система оповещений, продвинутое управление лотом и ведение логов.
- Трейлинг-стоп использует стандартный механизм StockSharp без шага подстройки.

## Рекомендации по использованию
- Сигналы формируются только по закрытым свечам, что соответствует режиму «trade at close» исходного эксперта.
- Убедитесь, что инструмент имеет корректный `PriceStep`; при отсутствии данных используется значение 1.0 для перевода пунктов.
- Стратегия служит демонстрационным примером и может быть расширена дополнительными правилами управления капиталом.
