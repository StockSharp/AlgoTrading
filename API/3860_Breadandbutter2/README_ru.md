# Стратегия Breadandbutter2

## Обзор
Breadandbutter2 — конвертация советника MT4 из файла `MQL/7710/Breadandbutter2.mq4`. Стратегия анализирует часовые свечи и отслеживает три линейно-взвешенные скользящие средние (LWMA), построенные по ценам открытия. Согласованный разворот всех трёх средних трактуется как смена тренда: позиция немедленно переворачивается в новую сторону, а при продолжении тренда возможна пирамидальная доборка.

## Логика работы
1. Подписка на часовые свечи (тип можно изменить через параметр **Candle Type**).
2. Расчёт LWMA(5), LWMA(10) и LWMA(15) от цен открытия каждой свечи.
3. Бычий сигнал: на предыдущей свече выполнялось `LWMA5 < LWMA10 < LWMA15`, а на текущей `LWMA5 > LWMA10 > LWMA15`. Медвежий сигнал формируется при обратном неравенстве.
4. При бычьем пересечении целевая позиция выставляется в лонг объёмом **Volume**. При медвежьем — в шорт тем же объёмом. Текущая позиция корректируется покупкой или продажей только необходимой разницы до целевого объёма.
5. После каждой сделки счётчик **Interval** обнуляется. Если проходит указанное число завершённых свечей без нового сигнала, стратегия добавляет ещё один ордер в текущем направлении (пирамидинг) и пересчитывает защитные уровни.
6. Защитные ордера выставляются через `SetTakeProfit` и `SetStopLoss` на расстоянии **Take Profit** и **Stop Loss** (в шагах цены). Нулевое значение отключает соответствующий уровень.

## Параметры
| Параметр | По умолчанию | Описание |
| --- | --- | --- |
| **Volume** | 0.1 | Объём базового входа и каждой пирамидальной добавки (в лотах). |
| **Take Profit** | 20 | Дистанция тейк-профита в шагах цены. 0 — отключить. |
| **Stop Loss** | 20 | Дистанция стоп-лосса в шагах цены. 0 — отключить. |
| **Interval** | 4 | Количество завершённых свечей до следующей пирамидальной сделки. 0 — без пирамидинга. |
| **Cross Filter** | 1.1 | Зарезервированный параметр для возможной фильтрации по ADX (сейчас не используется). |
| **Candle Type** | Часовой таймфрейм | Источник свечей для расчёта LWMA. |

## Управление позицией
- Вспомогательный метод `AdjustPosition` доводит итоговый объём до требуемого значения после каждого разворота.
- Пирамидальные сделки открываются только в сторону существующей позиции, используя знак свойства `Position`.
- `SetTakeProfit` и `SetStopLoss` вызываются после каждой сделки, чтобы защитные уровни соответствовали актуальному объёму.

## Примечания
- В исходном коде MT4 рассчитывался ADX, но результат нигде не использовался. Параметр **Cross Filter** сохранён для совместимости и возможного расширения функциональности.
- В оригинале счётчик интервала был закомментирован. В версии для StockSharp пирамидинг работает согласно изначальной задумке — по количеству завершённых свечей.
- Метод `StartProtection()` вызывается при запуске, чтобы активировать встроенные механизмы защиты позиций.
