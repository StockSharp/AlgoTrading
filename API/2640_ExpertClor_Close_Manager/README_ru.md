# Стратегия ExpertClor Close Manager

## Обзор

ExpertClor Close Manager Strategy — это модуль управления рисками, который контролирует уже открытые позиции и закрывает их при выполнении условий выхода. Логика перенесена из оригинального эксперта MetaTrader *ExpertClor_v01*, который также отвечал только за сопровождение и не открывал новые сделки. Перенос на StockSharp сохраняет этот подход: стратегия никогда не выставляет новые заявки, а только отслеживает текущую позицию и отправляет рыночные ордера на выход.

## Основные принципы

1. **Выход по пересечению скользящих средних**  
   На каждой закрытой свече рассчитываются две настраиваемые скользящие средние. Если быстрая средняя пересекает медленную сверху вниз, закрывается длинная позиция; при пересечении снизу вверх закрывается короткая позиция. Сигнал формируется по двум предыдущим свечам, что воспроизводит логику MQL5.

2. **ATR-трейлинг StopATR_auto**  
   Используется индикатор Average True Range с настраиваемым периодом и множителем. Для лонга трейлинг определяется как `Close − ATR × множитель`, для шорта — `Close + ATR × множитель`. Уровни подтягиваются только в сторону прибыли, повторяя поведение индикатора StopATR_auto из оригинала.

3. **Перевод в безубыток**  
   После прохода заданного числа пунктов в прибыль стоп переносится на цену входа. Механизм работает отдельно для длинных и коротких позиций и совместим с ATR-трейлингом.

4. **Контроль состояния позиции**  
   Расчёты выполняются по выбранной серии свечей. При отсутствии позиции внутренние уровни стопа сбрасываются. После принудительного выхода трейлинг очищается, чтобы не использовать устаревшие значения при следующей сделке.

## Используемые индикаторы

- Быстрая скользящая средняя с выбором типа (SMA, EMA, SMMA, WMA) и источника цены.
- Медленная скользящая средняя с теми же настройками.
- Average True Range для расчёта волатильностного трейлинга.

## Настройки

| Параметр | Описание | Значение по умолчанию |
| --- | --- | --- |
| `MaCloseEnabled` | Включает/отключает выход по пересечению скользящих. | `true` |
| `AtrCloseEnabled` | Включает/отключает ATR-трейлинг. | `true` |
| `FastMaPeriod` | Период быстрой скользящей средней. | `5` |
| `FastMaMethod` | Тип быстрой скользящей (Simple, Exponential, Smoothed, Weighted). | `Exponential` |
| `FastPriceType` | Источник цены для быстрой скользящей. | `Close` |
| `SlowMaPeriod` | Период медленной скользящей средней. | `7` |
| `SlowMaMethod` | Тип медленной скользящей. | `Exponential` |
| `SlowPriceType` | Источник цены для медленной скользящей. | `Open` |
| `BreakevenPips` | Количество пунктов до перевода стопа в безубыток. | `0` |
| `AtrPeriod` | Период ATR. | `12` |
| `AtrTarget` | Множитель ATR при вычислении трейлинг-стопа. | `2.0` |
| `CandleType` | Тип свечей для расчётов. | `таймфрейм 5 минут` |

## Рекомендации по использованию

- Подключайте стратегию к инструменту, где сделки открываются внешним алгоритмом. ExpertClor Close Manager отвечает только за выход.
- Для точного соответствия исходной логике используйте свечи того же таймфрейма, что и в MQL5-версии.
- Параметр `BreakevenPips` переводится в ценовое смещение через `PriceStep`. Значение `0` отключает перенос в безубыток.
- ATR-трейлинг начинает работать только после формирования индикатора. До этого момента возможно только закрытие по пересечению средних (если включено).
- Выходы исполняются рыночными ордерами, поэтому контроль проскальзывания следует обеспечивать на стороне коннектора или брокера.

## Особенности портирования

- Индикатор StopATR_auto заменён на стандартный Average True Range с логикой подтягивания стопа.
- Перебор позиций из MQL5 заменён подпиской на свечи и использованием высокоуровневого API StockSharp.
- В коде оставлены поясняющие комментарии на английском языке для удобства сопровождения.
