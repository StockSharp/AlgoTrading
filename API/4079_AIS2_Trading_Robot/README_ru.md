# AIS2 Trading Robot 20005 (порт для StockSharp)

## Обзор

AIS2 Trading Robot 20005 — это внутридневная стратегия пробоя диапазона, изначально созданная для MetaTrader 4. Порт переносит её многофреймовую логику на высокоуровневый API StockSharp и воспроизводит ключевые элементы оригинала:

- анализ завершённых свечей старшего таймфрейма (по умолчанию 15 минут) и расчёт целевых дистанций по амплитуде свечи;
- входы по рынку при пробое середины и экстремума предыдущей свечи с учётом спрэда и брокерских ограничений;
- сопровождение позиции по виртуальному трейлинг-стопу, шаг которого задаётся диапазоном более быстрого таймфрейма (по умолчанию 1 минута).

Риск-менеджмент повторяет концепцию резервов из MQL-версии: часть капитала блокируется (`AccountReserve`), оставшаяся доля (`OrderReserve`) используется для расчёта объёма сделки. Дополнительно реализована пауза между операциями, чтобы исключить чрезмерную торговую активность.

## Логика работы

1. **Свеча старшего таймфрейма** — вычисляются середина диапазона, расстояния до стоп-лосса/тейк-профита (умножение диапазона на `StopFactor` и `TakeFactor`), минимальный шаг трейлинга и буферы стоп/фриз уровней.
2. **Условия входа** —
   - Лонг открывается, если закрытие выше середины, а ask пробивает максимум предыдущей свечи + спрэд.
   - Шорт открывается, если закрытие ниже середины, а bid пробивает минимум предыдущей свечи.
   - Сделка отклоняется, если рассчитанные стоп/тейк ближе допустимых брокером уровней.
3. **Размер позиции** — рассчитывается по текущей стоимости портфеля. При недостатке капитала или несоблюдении ограничений объём обнуляется и сигнал игнорируется.
4. **Сопровождение** — вторичный таймфрейм обновляет расстояние трейлинга. Стоп подтягивается только при устойчивом движении цены и соблюдении минимального шага.
5. **Защита** — `TradingPauseSeconds` задаёт паузу между операциями. Для оценки спрэда стратегия подписывается на стакан, но при его отсутствии использует цены закрытия свечей.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `PrimaryCandleType` | Таймфрейм для поиска сигналов. | 15-минутные свечи |
| `SecondaryCandleType` | Таймфрейм для расчёта трейлинга. | 1-минутные свечи |
| `TakeFactor` | Множитель диапазона для тейк-профита. | 1.7 |
| `StopFactor` | Множитель диапазона для стоп-лосса. | 1.7 |
| `TrailFactor` | Множитель диапазона для трейлинг-стопа. | 0.5 |
| `AccountReserve` | Доля капитала, зарезервированная от торговли. | 0.20 |
| `OrderReserve` | Доля капитала на одну сделку. | 0.04 |
| `BaseVolume` | Резервный объём при невозможности рассчитать риск. | 1 лот |
| `StopBufferTicks` | Дополнительные тики для проверки стоп-уровней. | 0 |
| `FreezeBufferTicks` | Буфер для предотвращения частых переносов стопа. | 0 |
| `TrailStepMultiplier` | Множитель спрэда при проверке шага трейлинга. | 1 |
| `TradingPauseSeconds` | Пауза между сделками. | 5 секунд |

Большинство числовых параметров подготовлены для оптимизации через `SetCanOptimize()`.

## Рекомендации по использованию

- Перед запуском убедитесь, что по инструменту доступны данные Level1/стакана, иначе расчёт спрэда и стоп-уровней будет консервативным.
- Настройте `PrimaryCandleType` и `SecondaryCandleType` в соответствии с доступными таймфреймами источника данных. Подписка выполняется через `SubscribeCandles`.
- Трейлинг-стоп реализован внутри стратегии — фактические защитные ордера не выставляются. При необходимости доработайте код и регистрируйте стоп-заявки после входа.
- Метод `StartProtection()` активирован при старте стратегии и помогает закрыть чужие позиции, которые могли остаться в портфеле.

## Отличия от MQL-реализации

- Вместо глобальных переменных MetaTrader параметры инкапсулированы в `StrategyParam`, что упрощает изменение настроек и оптимизацию.
- Вместо `OrderModify` применяются рыночные операции закрытия — это логичнее в рамках StockSharp и обеспечивает мгновенную реакцию на условия выхода.
- Расчёт капитала и риск-параметров основан на данных портфеля StockSharp, а не на балансе счёта в MT4.

## Содержимое

- `CS/Ais2TradingRobot20005Strategy.cs` — исходный код стратегии.
- `README.md` — описание на английском языке.
- `README_cn.md` — описание на китайском языке.
- `README_ru.md` — описание на русском языке (этот файл).

