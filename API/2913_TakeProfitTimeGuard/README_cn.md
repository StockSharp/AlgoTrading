# TakeProfitTimeGuardStrategy

## 概述

`TakeProfitTimeGuardStrategy` 复刻了 MetaTrader 专家 `Exp_GTakeProfit_Tm` 的核心思路：监控账户整体利润，并在达到目标或超出允许的交易时间段时强制平仓。该策略本身不会开仓，而是作为风险控制层叠加在其他交易策略之上，确保在收益受限或交易时段结束后账户能够及时回到空仓状态。

## 工作原理

- 订阅可配置的蜡烛数据（默认 1 分钟），利用最近一根蜡烛的收盘价计算已实现与未实现盈亏之和。
- 未实现盈亏通过当前持仓量与收盘价和持仓均价 (`Strategy.PositionPrice`) 的差值计算得到。
- 当交易时段仍然开启且总利润为负时，不触发止盈逻辑，与原始 MQL 策略保持一致。
- 一旦达到止盈目标，设置内部 `_stop` 标志，并持续发送市价单平掉所有剩余仓位；只有在仓位完全归零后才会重置该标志。
- 启用时间过滤后，只要当前时间不在允许区间内，也会执行同样的强制平仓流程。

## 参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `CandleType` | `DataType` | 1 分钟蜡烛 | 用于评估逻辑的蜡烛序列。 |
| `TargetMode` | `ProfitTargetMode`（`Percent` / `Currency`） | `Percent` | 控制 `TakeProfitValue` 解释为资本百分比还是绝对货币值。 |
| `TakeProfitValue` | `decimal` | `100` | 止盈阈值。必须大于零。 |
| `UseTradingWindow` | `bool` | `true` | 是否启用时间窗口过滤。 |
| `StartTime` | `TimeSpan` | `00:00:00` | 允许交易的起始时间（包含）。 |
| `EndTime` | `TimeSpan` | `23:59:00` | 允许交易的结束时间。当起始时间大于结束时间时，时间窗口跨越午夜。 |

## 行为说明

1. 启动时记录投资组合的初始价值（若初值为零，则在首次收到有效数值时记录），用于百分比模式的参考基数。
2. 由于未实现盈亏基于最新的蜡烛收盘价，所选时间框架将直接影响策略的反应速度。
3. 当利润达到目标时，策略会写入日志并持续发送平仓指令直至仓位清零。
4. 启用时间窗口后，只要当前时间不在窗口内，即使未达到止盈目标也会执行同样的平仓流程。
5. `_stop` 标志仅在仓位归零后清除，防止在平仓过程中重复触发。

## 与 MQL 版本的差异

- 使用 StockSharp 的高阶 API `SubscribeCandles`，而非逐笔处理行情。
- 通过 `Strategy.PositionPrice` 计算浮动盈亏，适配 StockSharp 的持仓模型。
- 在达到目标时输出详细日志，便于监控。
- 时间比较基于所订阅蜡烛的 `CloseTime`。

## 使用建议

- 将该策略附加在已运行的主交易策略之上，以提供额外的收益与时间控制。
- 根据需要的响应速度选择合适的蜡烛周期；周期越短，控制越及时。
- 确保投资组合提供 `CurrentValue` 数据，否则百分比模式无法正确计算参考资本。
- 可与 `StartProtection()` 等 StockSharp 内置风险控制工具配合使用，以构建完整的风控体系。
