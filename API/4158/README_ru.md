# Стратегия Casino111

## Обзор
Casino111 — это контртрендовая стратегия прорыва, перенесённая из одноимённого советника MetaTrader 4. На каждой новой свече алгоритм сравнивает текущую цену открытия с опорным диапазоном, построенным по предыдущей дневной свече. Если открытие выходит за пределы дневного диапазона (с учётом настраиваемых буферов), стратегия сразу открывает рыночную позицию в противоположном направлении и ставит симметричные стоп-лосс и тейк-профит. Порт на StockSharp сохраняет одно-позиционную модель оригинального робота и предоставляет расширенный набор параметров для тестирования и оптимизации.

## Логика входа и выхода
1. Максимум и минимум предыдущего дня считываются через отдельную подписку на дневные свечи. Смещения `UpperOffsetPoints` и `LowerOffsetPoints` (в пунктах MetaTrader) расширяют опорный коридор.
2. После закрытия каждой торговой свечи стратегия анализирует открытия текущей и предыдущей свечей:
   - Если новое открытие перепрыгивает над дневным максимумом плюс верхний буфер, открывается **короткая** позиция (игра против гэпа).
   - Если новое открытие падает ниже дневного минимума минус нижний буфер, открывается **длинная** позиция.
3. Одновременно допускается только одна позиция; пока предыдущий ордер не исполнен, новые сигналы игнорируются.
4. `StartProtection` выставляет фиксированные стоп и тейк, отстоящие от входа на `BetPoints` (значение автоматически переводится в ценовые шаги).

## Управление капиталом
- При `UseMoneyManagement = false` размер сделки фиксируется значением `BaseVolume`.
- При `UseMoneyManagement = true` включается мартингейл, повторяющий MT4-реализацию:
  - После каждой убыточной или нулевой сделки следующий объём умножается на `(BetPoints * 2) / (BetPoints - spreadPoints)`.
  - Спред оценивается по последним лучшим котировкам (best bid/ask), полученным из стакана. Если котировки пока недоступны, множитель равен `2`.
  - Прибыльные сделки возвращают объём к `BaseVolume`. Расчётные значения подгоняются под `VolumeStep` инструмента и ограничиваются параметром `MaxVolume`.

## Параметры
| Имя | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `EnableBuy` | `bool` | `true` | Разрешить длинные позиции при пробое нижней границы дневного канала. |
| `EnableSell` | `bool` | `true` | Разрешить короткие позиции при пробое верхней границы дневного канала. |
| `BetPoints` | `decimal` | `400` | Симметричный стоп-лосс и тейк-профит в пунктах MetaTrader (преобразуются в шаги цены). |
| `UpperOffsetPoints` | `decimal` | `97` | Буфер над дневным максимумом для выявления медвежьих гэпов. |
| `LowerOffsetPoints` | `decimal` | `77` | Буфер под дневным минимумом для выявления бычьих гэпов. |
| `UseMoneyManagement` | `bool` | `false` | Включить мартингейл-увеличение объёма. |
| `MaxVolume` | `decimal` | `4` | Максимально допустимый объём при активном управлении капиталом. |
| `BaseVolume` | `decimal` | `0.1` | Базовый размер сделки после прибыльной операции или при выключенном мартингейле. |
| `CandleType` | `DataType` | `H1` | Основной таймфрейм, на котором проверяются условия гэпа (по умолчанию 1 час). |
| `DailyCandleType` | `DataType` | `D1` | Таймфрейм, предоставляющий дневные экстремумы (по умолчанию 1 день). |

## Особенности реализации
- Используется высокоуровневый API StockSharp: `SubscribeCandles` обеспечивает торговые и дневные свечи, `SubscribeOrderBook` — актуальный спред для расчёта мартингейла.
- `StartProtection` управляет обоими плечами защиты, поэтому каждая сделка получает симметричный стоп и тейк сразу после открытия, как и в MT4.
- Все комментарии в коде оставлены на английском языке и отмечают ключевые точки принятия решений.
- Алгоритм не обращается к историческим значениям индикаторов — достаточно текущих значений открытия, что повторяет логику `Time[0]` / `Open[0]` в MetaTrader.

## Рекомендации по использованию
- Подбирайте торговый таймфрейм исходя из задачи исследования: по умолчанию используется часовой график, но можно указать любой поддерживаемый `DataType`.
- При активном управлении капиталом убедитесь, что `MaxVolume` соответствует ограничениям брокера; вспомогательный метод приведёт объём к `VolumeStep`, `MinVolume` и `MaxVolume` инструмента.
- Поскольку стратегия удерживает не более одной позиции, удобно отслеживать сделки на графике StockSharp с отметками входов и выходов.
- Перед подключением к реальному рынку протестируйте стратегию в режиме воспроизведения или на демо: торговля на гэпах требует стабильного спреда и быстрой ликвидности.
