# Стратегия TrueSort 1001
[English](README.md) | [中文](README_cn.md)

TrueSort 1001 — строгая трендовая система, повторяющая оригинальный экспертный советник MQL. Стратегия отслеживает пять простых скользящих средних и работает только тогда, когда они сохраняют идеальный порядок на трёх подряд закрытых свечах. Дополнительный фильтр — растущий индекс направленного движения (ADX). После входа позиция защищается трейлинг-стопом в шагах цены и закрывается сразу, как только скользящие средние теряют синхронность.

## Логика

### Фильтр тренда и импульса
- Рассчитываются пять SMA (по умолчанию периоды 10, 20, 50, 100 и 200) на выбранном таймфрейме.
- Для покупок быстрые SMA должны строго располагаться выше медленных на каждой из трёх последних завершённых свечей: `SMA10 > SMA20 > SMA50 > SMA100 > SMA200`.
- Для продаж требуется обратный порядок на тех же трёх свечах.
- ADX с периодом `AdxPeriod` должен находиться выше `AdxThreshold`, причём текущее значение должно быть больше предыдущего, что подтверждает нарастающую силу тренда.

### Условия входа
1. Открытых позиций нет.
2. Три исторические свечи удовлетворяют правилу строгой сортировки SMA.
3. Условие по ADX выполняется.
4. На закрытии текущей свечи выставляется рыночная заявка объёмом `Volume`.

### Условия выхода
- **Потеря порядка SMA.** Если текущая свеча закрывается и набор скользящих средних перестаёт строго соответствовать направлению сделки, позиция закрывается.
- **Трейлинг-стоп.** Значение `StopLossPoints` переводится в абсолютное ценовое расстояние умножением на `PriceStep` инструмента. Для лонгов стоп инициализируется на максимуме между `SMA100` и `Close - расстояние`. Для шортов — на минимуме между `SMA100` и `Close + расстояние`. После каждой свечи стоп подтягивается к цене, но никогда не отдаляется. При пересечении стопа цена закрывает позицию по рынку.

### Дополнительные особенности
- Обрабатываются только закрытые свечи; незавершённые бары игнорируются.
- Для воспроизведения логики MQL со смещениями индикаторов хранится последние три значения каждой SMA во внутренних буферах, без вызовов `GetValue()`.
- ADX обрабатывается через `BindEx`, торговля запускается только когда данные полностью сформированы и стратегия находится онлайн.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `Volume` | `0.1` | Объём каждой рыночной заявки. |
| `StopLossPoints` | `100` | Дистанция трейлинг-стопа в шагах цены. `0` отключает трейлинг. |
| `Sma10Length` | `10` | Период самой быстрой SMA. |
| `Sma20Length` | `20` | Период второй SMA. |
| `Sma50Length` | `50` | Период средней SMA. |
| `Sma100Length` | `100` | Период SMA, участвующей в фильтре и инициализации стопа. |
| `Sma200Length` | `200` | Самая медленная SMA для подтверждения тренда. |
| `AdxPeriod` | `14` | Период индикатора ADX. |
| `AdxThreshold` | `25` | Минимальный уровень ADX и требование роста для входа. |
| `CandleType` | `TimeSpan.FromHours(1).TimeFrame()` | Тип свечей для расчётов индикаторов. |

## Детали реализации
- Используется высокоуровневый API StockSharp: подписка на свечи и одновременная привязка пяти SMA и ADX в одном конвейере.
- Буферы длиной три значения сохраняют последние значения SMA, что позволяет точно повторить сдвиги из MQL без прямого обращения к истории индикаторов.
- Трейлинг-стоп ведётся вручную; при этом вызывается `StartProtection()`, чтобы стандартная инфраструктура защиты была готова к расширению.
- В коде добавлены подробные комментарии на английском языке.
