# 按时间平仓策略

## 概述
本策略移植自 MetaTrader 5 专家顾问 `Exp_ClosePositionsByTime.mq5`。原脚本会实时监控交易服务器时间，一旦到达用户设定的截止时间，就会关闭当前品种的所有仓位。StockSharp 版本沿用了相同的思想，通过监听收盘完成的K线来判断时间，并在超过截止时间后立即强制平仓。

与基于每个 tick 执行的 MQL 版本不同，移植版依赖 StockSharp 的高级蜡烛订阅 API，从而让平台负责数据流和报单细节，策略代码更加简洁。

## 交易规则
1. 订阅指定的蜡烛序列（默认 1 分钟），用于可靠追踪市场时间。
2. 每当收到一根收盘完成的蜡烛时，将其收盘时间与 `StopTime` 参数进行比较。
3. 在截止时间之前，策略保持空闲，不干预任何已有仓位。
4. 一旦超过截止时间：
   - 取消策略所有挂单，防止再次建仓；
   - 如果当前净仓位不为零，调用 `ClosePosition()`，StockSharp 会根据持仓方向自动发送市价单（多头卖出、空头买入）。
5. 持续监控后续蜡烛。若截止时间之后又出现新的持仓，策略会在下一根完成的蜡烛上再次平仓，与原始 MQL 循环逻辑一致。

## 参数
| 名称 | 类型 | 说明 |
| ---- | ---- | ---- |
| `StopTime` | `DateTimeOffset` | 绝对时间点，超过该时间必须平掉所有仓位。默认值与 MQL 脚本的 `2030-01-01 23:59` 相同。 |
| `CandleType` | `DataType` | 用于推进时间的蜡烛类型。建议选择较小的周期（例如 1 分钟），以便在截止时间后尽快触发平仓。 |

## 实现说明
- 策略代码位于 `CS/ClosePositionsByTimeStrategy.cs`，继承自 `Strategy` 类。
- 按仓库要求使用制表符进行缩进，代码中的注释全部使用英文。
- 在 `OnStarted` 中调用 `StartProtection()`，便于 StockSharp 监控强制平仓后的意外成交。
- 根据任务要求，本目录未提供 Python 版本。

## 原专家顾问的行为
原始 MQL 脚本的主要流程：
- 用户输入 `StopTime` 与 `Deviation_`（允许滑点）。
- 每个 tick 检查 `TimeCurrent()`；若当前时间晚于 `StopTime`，则遍历所有仓位，筛选出当前品种并发送反向市价单关闭仓位。
- 当所有仓位都已平掉后，重置内部 `Stop` 标志，以便未来若再开仓也能立即被关闭。

StockSharp 实现遵循同样的思路，但 `Deviation_` 在 `ClosePosition()` 中没有直接的等价参数，因此转换后使用默认的市价执行逻辑，由平台以最佳可得价格成交。

## 使用建议
- 可将本策略作为“交易时段守护”组件，与其它入场策略组合使用，在特定时间点强制结束所有仓位。
- 回测时请确保行情数据覆盖到设定的截止时间，否则策略无法收到完成的蜡烛，平仓就不会触发。
- 若需要多个时间段的平仓控制，可复制该策略或扩展代码，加入更多的时间计划。
