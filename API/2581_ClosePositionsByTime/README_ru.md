# Стратегия закрытия позиций по времени

## Обзор
Стратегия является конверсией советника MetaTrader 5 `Exp_ClosePositionsByTime.mq5`. Оригинал отслеживает серверное время и, как только оно превышает заданный порог, закрывает все позиции по инструменту графика. Версия на StockSharp сохраняет ту же логику, анализируя завершённые свечи и инициируя полное закрытие сразу после того, как время закрытия свечи перешагнуло заданный лимит.

Вместо обработки каждого тика, как в MQL, реализация на StockSharp использует высокоуровневый API подписки на свечи. Это позволяет платформе взять на себя управление потоком данных и исполнением заявок, а код стратегии остаётся компактным.

## Правила торговли
1. Подписаться на выбранный тип свечей (по умолчанию 1 минута), чтобы корректно отслеживать рыночное время.
2. Для каждой завершённой свечи сравнивать её время закрытия с параметром `StopTime`.
3. Пока стоп-время не наступило, стратегия не вмешивается в открытые позиции.
4. После наступления стоп-времени:
   - Отменить все активные заявки стратегии, чтобы исключить повторный вход.
   - Если суммарная позиция отлична от нуля, вызвать `ClosePosition()`, и StockSharp отправит соответствующий рыночный ордер (продажа для лонга, покупка для шорта).
5. Продолжать мониторинг следующих свечей. Любая новая позиция, открытая после стоп-времени, будет снова закрыта на ближайшей завершённой свече — аналогично циклу в исходном советнике.

## Параметры
| Имя | Тип | Описание |
| --- | --- | -------- |
| `StopTime` | `DateTimeOffset` | Абсолютное время, после которого все позиции должны быть закрыты. Значение по умолчанию совпадает с MQL-версией (`2030-01-01 23:59`). |
| `CandleType` | `DataType` | Тип свечей, используемый для контроля времени. Желательно выбирать небольшой интервал (например, 1 минуту), чтобы выход сработал как можно ближе к дедлайну. |

## Особенности реализации
- Код располагается в `CS/ClosePositionsByTimeStrategy.cs` и наследуется от `Strategy`.
- Используются табуляции для отступов и английские комментарии в соответствии с требованиями репозитория.
- В `OnStarted` вызывается `StartProtection()`, чтобы StockSharp отслеживал внеплановые исполнения после принудительного выхода.
- По условию задания Python-версия стратегии не создавалась.

## Поведение оригинального советника
- Пользователь задаёт `StopTime` и допустимое отклонение `Deviation_`.
- При каждом тике выполняется проверка `TimeCurrent()`. Как только текущее время превышает `StopTime`, советник перебирает все позиции, выбирает относящиеся к текущему символу и закрывает их противоположными рыночными ордерами.
- Когда позиции закрыты, флаг `Stop` сбрасывается, чтобы любая новая сделка также была ликвидирована немедленно.

В StockSharp нет прямого аналога параметру `Deviation_` при использовании рыночных заявок, поэтому применяется стандартный метод `ClosePosition()`, который отправляет ордера по лучшей доступной цене.

## Рекомендации по применению
- Используйте стратегию как «охрану сессии» совместно с любыми входными моделями, чтобы гарантированно закрывать сделки к определённому времени.
- В бэктестах убедитесь, что поток данных покрывает момент закрытия, иначе стратегия не получит завершённую свечу и не выполнит выход.
- Для нескольких контрольных интервалов можно клонировать стратегию или расширить код дополнительным расписанием.
