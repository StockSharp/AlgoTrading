# Стратегия повторных входов по Chandel Exit
[English](README.md) | [中文](README_cn.md)

Эта стратегия является переносом советника MetaTrader «Exp_ChandelExitSign_ReOpen» на высокоуровневый API StockSharp. Она торгует пробои по полосам Chandelier Exit и автоматически наращивает позицию, если тренд продолжается. Сигналы рассчитываются на настраиваемом таймфрейме, а управление риском реализовано через ATR-стоп и необязательный тейк-профит.

Основная идея — использовать Chandelier Exit одновременно как трендовый фильтр и динамический барьер. Когда нижняя полоса пересекает верхнюю, фиксируется бычий импульс; обратное пересечение даёт медвежий сигнал. Логика симметрична для покупок и продаж, причём каждый тип сигнала можно включить или отключить параметрами. После открытия позиции цена должна пройти заданное количество шагов цены (`PriceStepPoints`), прежде чем разрешено добавление. Добор копирует поведение оригинального советника и ограничивается значением `MaxAdditions`, чтобы объём не рос бесконтрольно.

## Логика работы

- **Расчёт сигналов**
  - `RangePeriod` баров (со сдвигом `Shift`) формируют максимум и минимум, по которым строятся полосы Chandelier Exit.
  - `AtrPeriod` и `AtrMultiplier` задают волатильностный буфер, смещающий полосы от цены.
  - `SignalBar` (по умолчанию 1) задерживает исполнение, чтобы работать по последней завершённой свече и повторять MT5-поведение.
- **Входы**
  - **Покупка**: срабатывает, когда нижняя полоса пересекает верхнюю (`IsUpSignal`) и `EnableBuyEntries = true`. При наличии короткой позиции робот сначала пытается закрыть её, если `EnableSellExits = true`.
  - **Продажа**: противоположный сигнал (`IsDownSignal`) при `EnableSellEntries = true`. Длинная позиция закрывается только если `EnableBuyExits = true`.
- **Выходы**
  - **Лонг** закрывается по медвежьему сигналу при `EnableBuyExits = true`, либо по защитному стопу/тейку.
  - **Шорт** закрывается по бычьему сигналу при `EnableSellExits = true`, либо по защитным уровням.
  - Когда включены и входы, и выходы, стратегия дополнительно просматривает более старые значения индикатора, чтобы гарантировать наличие сигнала закрытия даже если текущая свеча дала только вход.
- **Повторные входы**
  - После каждого открытия запоминается цена сделки. Когда цена проходит в прибыль не менее `PriceStepPoints * PriceStep`, отправляется дополнительная заявка объёмом `Volume` — но не более `MaxAdditions` раз.
  - Каждый добор пересчитывает уровни стопа и тейка от последней цены, удерживая защиту рядом с актуальной позицией.
- **Риск-менеджмент**
  - `StopLossPoints` и `TakeProfitPoints` задают расстояние в шагах цены от последней сделки. Нули отключают соответствующий уровень.
  - Защитные условия проверяются на каждой завершённой свече. Если цена внутри бара достигает стопа или тейка, позиция закрывается рыночной заявкой.

## Параметры по умолчанию

| Параметр | Значение | Назначение |
|----------|----------|------------|
| `CandleType` | `TimeSpan.FromHours(4).TimeFrame()` | Таймфрейм, на котором строится индикатор. |
| `RangePeriod` | 15 | Длина окна для максимумов и минимумов. |
| `Shift` | 1 | Количество свежих баров, пропускаемых перед расчётом диапазона. |
| `AtrPeriod` | 14 | Период ATR для волатильностного буфера. |
| `AtrMultiplier` | 4 | Множитель ATR. |
| `SignalBar` | 1 | На сколько завершённых баров назад брать сигнал. |
| `PriceStepPoints` | 300 | Минимальное движение в шагах цены перед добавлением к позиции. |
| `MaxAdditions` | 10 | Максимальное число доборов после первого входа. |
| `StopLossPoints` | 1000 | Размер стоп-лосса в шагах цены. |
| `TakeProfitPoints` | 2000 | Размер тейк-профита в шагах цены. |
| `EnableBuyEntries` / `EnableSellEntries` | `true` | Разрешить открытие лонгов/шортов по сигналам. |
| `EnableBuyExits` / `EnableSellExits` | `true` | Разрешить закрытие лонгов/шортов по противоположным сигналам. |

## Практические рекомендации

- Базовый объём сделки задаётся параметром `Volume`. Доборы используют тот же объём, поэтому для контроля риска корректируйте `Volume` или `MaxAdditions`.
- Порог `PriceStepPoints` выражен в шагах цены. Убедитесь, что у инструмента корректно настроен `PriceStep`, иначе расстояния будут искажены.
- Значение `SignalBar = 1` повторяет оригинального бота и защищает от исполнения на той же свече, которая генерирует сигнал. Установка 0 включает работу на последнем закрытом баре.
- Стратегия рассчитана на инструменты, где разрешены обе стороны торговли. При необходимости можно отключить лонговые или шортовые сигналы параметрами.
- Если графическая панель доступна, методы `DrawCandles`, `DrawIndicator` и `DrawOwnTrades` автоматически отрисуют свечи, индикатор и сделки для наглядного контроля.

## Пример сценария

1. Появляется бычий сигнал: нижняя полоса Chandelier Exit пересекает верхнюю.
2. При отсутствии позиции и включённых покупках стратегия отправляет рыночную заявку `Volume`. Стоп и тейк рассчитываются от цены входа.
3. Если цена проходит вперёд как минимум `PriceStepPoints * PriceStep`, добавляется ещё один лот (до лимита `MaxAdditions`).
4. Лонг закрывается при обратном сигнале, достижении стопа или тейка. Для шорта последовательность зеркальная.

Документация сохраняет логику MT5-советника, но использует соглашения StockSharp: параметры стратегии, подписку на свечи высокого уровня и явное управление позицией.
