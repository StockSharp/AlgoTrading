# ScalpWiz 9001 策略

## 概述
ScalpWiz 9001 是一个多层次的突破反转系统，移植自同名 MetaTrader 专家顾问。策略会评估最新 K 线的收盘价相对布林带边界的突破幅度，当出现剧烈扩张时，会在价格上下方布置多笔挂单。原版的资金管理方案得以保留：每一层挂单既可以使用固定手数，也可以按照账户权益的百分比计算风险。

当某笔挂单成交后，其余挂单立即取消，同时持仓由止损、止盈以及带缓冲区的跟踪止损保护。该策略主要用于低周期的高频交易，但在 StockSharp 支持的任何市场上都可以运行。

## 信号逻辑
1. 订阅指定的时间框架，并以 `BandsPeriod`（默认 20）和 `BandsDeviation`（默认 2）计算布林带。
2. 判断收盘价相对布林带上下轨的突破距离。当突破幅度达到第 4 层距离 `Level3Pips`（折算为价格）时，策略准备进行反向挂单：
   - 收盘高于上轨 → 在价格下方布置卖出止损挂单。
   - 收盘低于下轨 → 在价格上方布置买入止损挂单。
3. 共放置四笔挂单，使用 `Level0Pips` … `Level3Pips` 指定的逐渐增大的距离。每层挂单使用对应的固定手数或风险百分比，挂单有效期由 `ExpirationMinutes` 控制。
4. 任一挂单成交后，其余挂单会被取消。持仓由 `StopLossPips`、`TakeProfitPips` 以及 `TrailingStopPips`/`TrailingStepPips` 参数管理。跟踪止损只有在价格至少运行 `TrailingStopPips + TrailingStepPips` 之后才会开始移动。
5. 当收盘价触及保护止损或止盈时，策略通过市价单退出头寸。

## 参数说明
- **Candle Type** – 用于计算布林带的时间框架。
- **Bands Period / Bands Deviation** – 布林带设置。
- **Stop Loss (pips)** – 止损距离（点）。
- **Take Profit (pips)** – 止盈距离（点）。
- **Trailing Stop (pips)** – 跟踪止损基础距离。
- **Trailing Step (pips)** – 触发跟踪的额外缓冲距离。
- **Expiration (minutes)** – 挂单有效时间（0 表示不限）。
- **Management Mode** – `FixedVolume` 使用固定手数，`RiskPercent` 使用风险百分比。
- **Level 0-3 Value** – 各层挂单的固定手数或风险百分比。
- **Level 0-3 Pips** – 各层挂单的价格偏移（点）。

## 资金管理
在 `RiskPercent` 模式下，策略根据账户权益和止损距离计算下单手数：

```
手数 = (equity × riskPercent / 100) / (stopOffset / priceStep × stepPrice)
```

若市场数据缺少价格步长、步长价值或成交量步长，为避免异常下单，策略会将手数设为 0。选择 `FixedVolume` 模式时，直接使用配置的手数并按照成交量步长进行舍入。

## 持仓管理
- 止损与止盈价格均基于实际成交价加减点数距离计算。
- 跟踪止损完全遵循原始 EA 的实现：只有当价格额外运行一个缓冲距离后，才会把保护价移动到新的位置。
- 退出操作使用市价单执行，因此即使交易所不支持服务器端止损/止盈也可以工作。

## 使用建议
- 请根据交易品种的最小价格步长设定 `LevelXPips`，对于五位报价的外汇品种，一个点等于十个最小步长，策略会根据小数位数自动调整。
- 某些经纪商限制挂单到现价的最小距离，如有需要请增大挂单距离或有效期。
- 风险百分比模式需要有效的账户估值以及价格步长信息，否则无法计算手数。
- 策略只在 K 线收盘时决策，比原始的逐笔报价版本更加平滑稳定。
