# Стратегия ScalpWiz 9001

## Общее описание
ScalpWiz 9001 — это многоуровневая скальперская стратегия, повторяющая логику одноимённого эксперта MetaTrader. Алгоритм измеряет, насколько далеко последняя свеча закрылась за пределами полос Боллинджера, и при резком расширении волатильности разворачивает сетку отложенных стоп-заявок выше или ниже рынка. Сохраняется оригинальная система управления капиталом: для каждого уровня можно задать фиксированный объём либо долю риска от капитала.

После срабатывания одной из заявок оставшиеся отменяются, а открытая позиция сопровождается стоп-лоссом, тейк-профитом и трейлинг-блоком, который начинает работу только после прохождения дополнительного буфера. Стратегия рассчитана на агрессивные сделки на малых таймфреймах, но может применяться на любом инструменте, поддерживаемом StockSharp.

## Логика сигналов
1. Подписка на выбранный таймфрейм и расчёт полос Боллинджера с периодом `BandsPeriod` (по умолчанию 20) и множителем `BandsDeviation` (по умолчанию 2).
2. Проверка, насколько закрытие ушло от верхней или нижней полосы. Если превышение достигает расстояния уровня `Level3Pips` (переведённого в цену), стратегия готовится к контртрендовому входу:
   - Закрытие выше верхней полосы → размещаются sell stop ордера ниже текущей цены.
   - Закрытие ниже нижней полосы → размещаются buy stop ордера выше текущей цены.
3. Всего выставляются четыре отложенных ордера с нарастающими расстояниями (`Level0Pips` … `Level3Pips`). Для каждого уровня используется собственный объём или процент риска. Если `ExpirationMinutes` > 0, то ордера автоматически отменяются по истечении заданного времени.
4. После исполнения одного из ордеров остальные заявки снимаются. Позиция управляется стоп-лоссом (`StopLossPips`), тейк-профитом (`TakeProfitPips`) и трейлингом (`TrailingStopPips`, `TrailingStepPips`). Трейлинг переносит защитный стоп только после прохождения расстояния `TrailingStopPips + TrailingStepPips` от цены входа.
5. Выход из позиции выполняется рыночной заявкой при достижении стопа или цели на закрывшейся свече.

## Параметры
- **Candle Type** — таймфрейм расчёта полос Боллинджера.
- **Bands Period / Bands Deviation** — настройки индикатора.
- **Stop Loss (pips)** — расстояние защитного стопа в пунктах.
- **Take Profit (pips)** — расстояние тейк-профита в пунктах.
- **Trailing Stop (pips)** — величина трейлинг-стопа.
- **Trailing Step (pips)** — дополнительный шаг перед переносом стопа.
- **Expiration (minutes)** — время жизни отложенных ордеров (0 — без ограничения).
- **Management Mode** — режим интерпретации значений уровней (`FixedVolume` или `RiskPercent`).
- **Level 0-3 Value** — объём сделки или процент риска для каждого уровня.
- **Level 0-3 Pips** — расстояния установки ордеров в пунктах.

## Управление рисками
При выборе режима `RiskPercent` объём ордера рассчитывается из стоимости портфеля и расстояния стоп-лосса:

```
объём = (equity × riskPercent / 100) / (stopOffset / priceStep × stepPrice)
```

Если информация о шаге цены или стоимости шага недоступна, объём принудительно обнуляется для исключения некорректных сделок. В режиме `FixedVolume` используются заданные значения, округляемые к допустимому шагу объёма инструмента.

## Сопровождение позиции
- Стоп-лосс и тейк-профит задаются относительно фактической цены исполнения.
- Трейлинг полностью повторяет реализацию в MetaTrader: перенос стопа начинается только после прохождения дополнительного шага и затем удерживает расстояние `TrailingStopPips`.
- Закрытие позиции производится рыночными заявками, что обеспечивает совместимость с площадками без серверных защитных ордеров.

## Практические рекомендации
- Подбирайте значения уровней с учётом шага цены инструмента. Для пятизначных валютных пар один пункт соответствует десяти минимальным шагам — стратегия корректирует это автоматически по количеству знаков инструмента.
- Проверьте биржевые ограничения на минимальные расстояния до цены (freeze/stop level) и при необходимости увеличьте значения `LevelXPips`.
- Для режима риска необходимы актуальные данные портфеля и параметры шага цены. При их отсутствии объём будет равен нулю.
- Стратегия обрабатывает только закрывшиеся свечи, что сглаживает шум по сравнению с тиковым вариантом оригинального эксперта.
