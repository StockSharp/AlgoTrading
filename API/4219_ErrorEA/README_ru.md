# Стратегия ErrorEA

## Обзор
**ErrorEA** — это порт эксперта `errorEA.mq4` из MetaTrader на платформу StockSharp. Исходный робот сравнивал линии +DI и -DI индикатора Average Directional Index и накапливал рыночные сделки в сторону текущего тренда, одновременно устанавливая очень дальний стоп-лосс и короткий скальперский тейк-профит. Версия на C# повторяет эту логику с использованием высокоуровневого API StockSharp, добавляет удобные параметры и подробно описывает модель управления риском.

## Логика торговли
1. Подписаться на выбранный таймфрейм (`CandleType`) и передавать свечи в индикатор `AverageDirectionalIndex`.
2. Дождаться завершения свечи и получить финальное значение ADX для бара.
3. Сравнить линии +DI и -DI:
   - если +DI > -DI, фиксируется бычий сигнал;
   - если -DI > +DI, фиксируется медвежий сигнал;
   - равные значения не порождают новых сделок.
4. При бычьем сигнале:
   - закрыть текущую короткую позицию (в StockSharp используется неттинг, поэтому хеджирование не допускается);
   - если количество набранных лонговых траншей меньше `MaxTrades`, открыть ещё одну рыночную покупку объёмом, рассчитанным блоком риск-менеджмента.
5. При медвежьем сигнале:
   - закрыть открытую длинную позицию;
   - если число шортовых траншей не достигло `MaxTrades`, открыть рыночную продажу с тем же алгоритмом расчёта объёма.
6. Защитные ордера ведутся через `StartProtection`:
   - `StopLossPoints` переводится в ценовые шаги и играет роль широкого стоп-лосса (аналог параметра `StopLoss`);
   - если `EnableTakeProfit = true`, параметр `TakeProfitPoints` повторяет скальперский тейк `ScalpeProfit`, который в МТ4 устанавливался через `OrderModify`.
7. Счётчики `_longTrades` и `_shortTrades` сбрасываются, когда позиция становится нулевой или меняет знак, чтобы ограничение по `MaxTrades` соблюдалось после остановок и разворотов.

## Управление рисками и объёмом
- `BaseVolume` соответствует параметру `MiniLots` и задаёт базовый объём сделки.
- При включённом `EnableRiskControl` реализуется формула `PowerRisk`: `объём = BaseVolume * max(1, PortfolioValue / RiskDivider)` с делителем 10000, как в исходном коде.
- После расчёта значение приводится к диапазону `MinVolume`–`MaxVolume` и проверяется на ограничения площадки (`Security.MinVolume`, `Security.MaxVolume`, `Security.VolumeStep`). Это исключает регистрацию недопустимых объёмов.
- Полученный объём используется для каждой новой наращиваемой сделки до тех пор, пока направление не достигнет лимита `MaxTrades`.

## Параметры
| Имя | Тип | Значение по умолчанию | Аналог в MetaTrader | Описание |
| --- | --- | --- | --- | --- |
| `AdxPeriod` | `int` | `14` | период в `iADX` | Период усреднения индикатора ADX. |
| `CandleType` | `DataType` | таймфрейм 15 минут | текущий таймфрейм графика | Свечной поток для расчётов. |
| `MaxTrades` | `int` | `9` | `MaxTrades` | Максимум траншей в одном направлении. |
| `EnableRiskControl` | `bool` | `true` | `RiskControl` | Включает динамический расчёт лота от капитала. |
| `BaseVolume` | `decimal` | `0.15` | `MiniLots` | Базовый объём до применения множителя риска. |
| `RiskDivider` | `decimal` | `10000` | делитель в `PowerRisk` | Делит стоимость портфеля при вычислении множителя. |
| `MaxVolume` | `decimal` | `3` | `MaxLot` | Верхняя граница для рассчитанного объёма (до округления). |
| `MinVolume` | `decimal` | `0.01` | `MODE_MINLOT` | Минимальный допустимый объём заявки. |
| `StopLossPoints` | `int` | `1000` | `StopLoss` | Дистанция стоп-лосса в шагах цены (`0` отключает стоп). |
| `EnableTakeProfit` | `bool` | `true` | `ScalpeControl` | Включает короткий тейк-профит. |
| `TakeProfitPoints` | `int` | `10` | `ScalpeProfit` | Дистанция тейк-профита в шагах цены. |

## Отличия от оригинального эксперта
- В исходном коде MetaTrader переменная +DI затиралась значением -DI. Порт на StockSharp использует корректное сравнение линий, что соответствует задумке автора.
- MetaTrader позволяет держать разнонаправленные позиции. В StockSharp действует неттинг, поэтому перед открытием новых сделок противоположная позиция закрывается.
- Расчёт спрэда (`GetSlippage`) и вывод строк `Comment` удалены: платформе StockSharp они не нужны и не влияют на логику.
- Вызовы `OrderModify` заменены на `StartProtection`, который одновременно управляет стоп-лоссом и тейк-профитом с учётом биржевых ограничений.

## Рекомендации
- Убедитесь, что инструмент содержит корректные параметры `PriceStep`, `VolumeStep`, `MinVolume` и `MaxVolume`, чтобы корректно отрабатывать округление объёма.
- Настройте `BaseVolume`, `MinVolume` и `MaxVolume` под требования площадки. Конструктор также присваивает базовый объём свойству `Strategy.Volume`, благодаря чему ручные операции в интерфейсе используют тот же размер лота.
- При слишком шумных сигналах увеличьте таймфрейм или `AdxPeriod` — стратегия лучше работает на устойчивых трендах.
- Если предпочтительнее выходить только по стоп-лоссу, отключите `EnableTakeProfit`.
