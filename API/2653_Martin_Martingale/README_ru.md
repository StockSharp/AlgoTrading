# Стратегия Martin Martingale

## Общее описание
Стратегия воспроизводит логику оригинального советника "Martin" из MQL, формируя хеджированную мартингейл-сетку вокруг текущей цены. Позиции постоянно чередуются между покупкой и продажей, а объём сделки удваивается при каждом развороте до тех пор, пока суммарная прибыль всего портфеля заявок не достигнет заданной цели. Свечи используются только как источник сигналов, а исполнение заявок полностью реализовано через высокоуровневые методы StockSharp.

## Алгоритм работы
1. При запуске стратегия читает `PriceStep` инструмента и переводит параметры `EntryOffsetPoints` и `StepPoints` в абсолютные ценовые расстояния. Если шаг цены недоступен, используется значение 1.
2. Когда нет открытых позиций и активного цикла мартингейла, создаются симметричные стоп-заявки Buy Stop и Sell Stop на расстоянии `EntryOffsetPoints * PriceStep` от последней цены закрытия. Это соответствует 10 пунктам в исходном коде MQL.
3. После исполнения одной из стоп-заявок противоположная отменяется. Сделка фиксируется как первая в цепочке мартингейла: сохраняются её цена, направление и объём, а внутренний счётчик уровня устанавливается в 1.
4. На каждом закрытии свечи текущая цена сравнивается с ценой последней сделки. Если рынок прошёл против неё не менее чем на `martingaleLevel * StepPoints * PriceStep`, регистрируется рыночная заявка в противоположную сторону с объёмом, удвоенным относительно предыдущей сделки. После исполнения обновляются данные о последней заявке.
5. Нереализованная прибыль вычисляется по формуле `PnL + Position * (closePrice - PositionPrice)`. Как только агрегированная прибыль превышает параметр `ProfitTarget`, вызывается `CloseAll()` для полного закрытия корзины, отменяются оставшиеся заявки и цикл сбрасывается, чтобы можно было разместить новую пару стопов.
6. Аналогичный сброс происходит и при ручном закрытии всех позиций: внутренние счётчики очищаются, и на следующей свече появится новая пара заявок.

Такой подход сохраняет чередование сделок, характерное для оригинального советника, и полностью укладывается в рекомендованное использование высокоуровневого API StockSharp.

## Параметры
- `StepPoints` – количество шагов цены, определяющее порог разворота для следующей усредняющей сделки. Значение по умолчанию 10 и допускает оптимизацию.
- `EntryOffsetPoints` – отступ для исходных стоп-заявок в шагах цены. По умолчанию также равен 10 пунктам, как в версии MQL.
- `ProfitTarget` – абсолютная величина прибыли в валюте депозита, необходимая для закрытия всей мартингейл-сетки. После превышения этого уровня по сумме реализованной и нереализованной прибыли все позиции ликвидируются.
- `CandleType` – тип свечей, используемый для генерации сигналов. По умолчанию установлен таймфрейм 1 минута, но допускается любой доступный `DataType`.

Базовый объём берётся из свойства `Volume` стратегии. Каждый новый разворот умножает его на два, формируя классическую мартингейл-последовательность.

## Практические замечания
- Настраивайте `Volume` с учётом минимального шага объёма брокера. Из-за удвоения объёмов экспозиция растёт очень быстро, поэтому необходимо ограничивать риск на уровне портфеля.
- Поскольку решения принимаются по закрытиям свечей, резкие движения внутри свечи могут привести к более позднему срабатыванию по сравнению с тиковым вариантом на MQL. Тем не менее стоп-заявки позволяют сохранять уровни входа, близкие к исходной логике.
- На график выводятся свечи и собственные сделки стратегии для визуального контроля.
- Автоматический стоп-лосс не используется. Единственным условием выхода является достижение `ProfitTarget`, поэтому при выборе инструмента и таймфрейма необходимо учитывать риск затяжных трендов против позиции.

## Отличия от MQL-версии
- В StockSharp используется неттированная позиция, поэтому каждый разворот выполняется одной рыночной заявкой, которая одновременно закрывает прежнюю экспозицию и открывает новую. Совокупный результат совпадает с хеджированной реализацией.
- Тиковая обработка заменена анализом закрытий свечей, что соответствует рекомендациям по работе с высокоуровневым API.
- Для исключения повторной обработки частичных исполнений отслеживаются идентификаторы заявок, что обеспечивает корректное удвоение объёмов.

Благодаря этим изменениям стратегия сохраняет торговое поведение исходного советника и адаптирована для инфраструктуры StockSharp.
