# XFatlXSatlCloud Duplex

## Обзор
XFatlXSatlCloud Duplex — это конвертированная из MQL5 двунаправленная стратегия. Она использует индикатор XFatlXSatlCloud, который объединяет быстрый цифровой фильтр FATL и более медленный SATL, а затем сглаживает обе линии выбранными скользящими средними. Для длинной и короткой частей можно задавать разные таймфреймы, методы сглаживания и источники цены.

## Логика торговли
Стратегия работает только с закрытыми свечами. Для длинной и короткой стороны создаются отдельные подписки, каждая из которых рассчитывает индикатор XFatlXSatlCloud и применяет следующие правила:

- **Вход в лонг** — срабатывает, когда на свече сдвига `LongSignalBar` быстрая линия пересекает медленную снизу вверх. Если открыта короткая позиция и разрешено её закрытие (`ShortAllowClose`), она закрывается перед открытием лонга. Далее выставляется рыночная заявка объёмом `LongVolume`, а цена входа запоминается для контроля рисков.
- **Выход из лонга** — выполняется при пересечении быстрой линии ниже медленной на той же свече сдвига. Дополнительно контролируются уровни `LongStopLoss` и `LongTakeProfit`: если минимум или максимум текущей свечи пробивает заданное расстояние, позиция закрывается досрочно (при разрешённом закрытии).
- **Вход в шорт** — происходит, когда на свече `ShortSignalBar` быстрая линия пересекает медленную сверху вниз. При наличии лонга он закрывается, если это разрешено `LongAllowClose`, после чего отправляется рыночная заявка объёмом `ShortVolume`.
- **Выход из шорта** — выполняется, когда быстрая линия поднимается выше медленной на выбранном сдвиге. Параметры `ShortStopLoss` и `ShortTakeProfit` также отслеживают экстремумы свечи и закрывают позицию при достижении порога.

Все решения принимаются только после формирования свечи, что воспроизводит поведение оригинального советника.

## Управление риском
Для длинной и короткой позиций отдельно хранится цена входа. Если задан ненулевой стоп-лосс или тейк-профит и текущая свеча пересекает соответствующий уровень, позиция закрывается немедленно (при условии, что разрешено закрытие). Значения интерпретируются как абсолютные ценовые расстояния.

## Параметры
| Группа | Имя | Описание |
| --- | --- | --- |
| Trading | `LongVolume` | Объём рыночной заявки при открытии лонга ( > 0 ). |
| Trading | `ShortVolume` | Объём рыночной заявки при открытии шорта ( > 0 ). |
| Trading | `LongAllowOpen` | Разрешить открытие новых длинных позиций. |
| Trading | `LongAllowClose` | Разрешить закрытие длинных позиций (нужно для стопов и выходов по пересечению). |
| Trading | `ShortAllowOpen` | Разрешить открытие коротких позиций. |
| Trading | `ShortAllowClose` | Разрешить закрытие коротких позиций. |
| Signals | `LongSignalBar` | Количество завершённых свечей для анализа пересечения в лонг. |
| Signals | `ShortSignalBar` | Количество завершённых свечей для анализа пересечения в шорт. |
| Data | `LongCandleType` | Тип свечей (таймфрейм), используемый для длинного индикатора. |
| Data | `ShortCandleType` | Тип свечей (таймфрейм), используемый для короткого индикатора. |
| Indicators | `LongMethod1` | Метод сглаживания быстрого FATL для лонгов (SMA, EMA, SMMA, LWMA, Jurik, ZeroLag, Kaufman). |
| Indicators | `LongLength1` | Период сглаживания быстрой линии лонга. |
| Indicators | `LongPhase1` | Параметр фазы для быстрой линии (оставлен для совместимости, актуален в основном для Jurik). |
| Indicators | `LongMethod2` | Метод сглаживания медленной линии SATL для лонгов. |
| Indicators | `LongLength2` | Период сглаживания медленной линии лонга. |
| Indicators | `LongPhase2` | Параметр фазы для медленной линии лонга. |
| Indicators | `LongAppliedPrice` | Тип цены, используемой в расчёте лонгов (close, open, median, typical, weighted, simple, quarter, trend-follow, Demark). |
| Indicators | `ShortMethod1` | Метод сглаживания быстрой линии для шортов. |
| Indicators | `ShortLength1` | Период сглаживания быстрой линии шорта. |
| Indicators | `ShortPhase1` | Параметр фазы быстрой линии шорта. |
| Indicators | `ShortMethod2` | Метод сглаживания медленной линии шорта. |
| Indicators | `ShortLength2` | Период сглаживания медленной линии шорта. |
| Indicators | `ShortPhase2` | Параметр фазы медленной линии шорта. |
| Indicators | `ShortAppliedPrice` | Тип цены для короткого индикатора. |
| Risk | `LongStopLoss` | Абсолютное ценовое расстояние для стоп-лосса по лонгам (0 — отключено). |
| Risk | `LongTakeProfit` | Абсолютное ценовое расстояние для тейк-профита по лонгам (0 — отключено). |
| Risk | `ShortStopLoss` | Абсолютное ценовое расстояние для стоп-лосса по шортам (0 — отключено). |
| Risk | `ShortTakeProfit` | Абсолютное ценовое расстояние для тейк-профита по шортам (0 — отключено). |

## Особенности реализации
- Индикатор XFatlXSatlCloud реализован на высокоуровневом API StockSharp: сначала применяется оригинальный FIR-фильтр FATL/SATL, затем результат пропускается через выбранные скользящие средние.
- Поддерживаются только широко доступные типы скользящих (`Sma`, `Ema`, `Smma`, `Lwma`, `Jurik`, `ZeroLag`, `Kaufman`). Прочие варианты из MQL (Parabolic, T3 и др.) не включены.
- Параметры `LongSignalBar` и `ShortSignalBar` повторяют семантику оригинального советника: значение 1 означает использование предыдущей закрытой свечи для оценки пересечения.
- Стоп-лосс и тейк-профит измеряются в абсолютных ценах инструмента. Сравнение выполняется по high/low текущей свечи относительно сохранённой цены входа.
