# Стратегия Bands

## Обзор
Стратегия переносит эксперт MetaTrader 5 **Bands.mq5** на высокоуровневый API StockSharp. Алгоритм ждёт закрытую свечу, которая п
робивает полосу Боллинджера снаружи обратно в канал, и открывает сделку только тогда, когда наклон канала Дончиана в течение зад
анных баров остаётся неизменным. Множители среднего истинного диапазона (ATR) воссоздают исходные уровни стоп-лосса и тейк-профи
та, а диагностический блок выводит коэффициент детерминации (R-squared) по кривой капитала после каждых 100 сделок — так же, как
это делал оригинальный советник.

## Торговая логика
1. Подписаться на поток свечей и вычислить полосы Боллинджера, канал Дончиана и ATR с теми же периодами, что и в MQL-версии.
2. При отсутствии позиции анализировать **предыдущую** закрытую свечу:
   - Открывать длинную позицию, если она открылась ниже нижней полосы Боллинджера и закрылась внутри канала, а нижняя граница До
нчиана не снижалась дольше, чем `ConfirmationPeriod` баров.
   - Открывать короткую позицию, если свеча открылась выше верхней полосы и закрылась внутри, а верхняя граница Дончиана не росла
дольше, чем `ConfirmationPeriod` баров.
3. При наличии позиции закрывать её, если предыдущая свеча пересекла актуальную границу Дончиана, либо если текущая свеча наруши
ла ATR-защитные уровни по максимуму или минимуму.
4. После каждой собственной сделки сохранять значение капитала портфеля и каждые 100 сделок выводить R-squared. Отрицательный уг
ол наклона приводит к отрицательному значению коэффициента, как и в оригинале.

## Управление рисками
- Все входы выполняются рыночными ордерами объёмом `TradeVolume`.
- Стоп и тейк рассчитываются в коде без выставления отложенных заявок: сравниваются экстремумы свечи с ATR-множителями.
- При срабатывании защиты позиция полностью закрывается рыночным ордером, а рассчитанные уровни сбрасываются.

## Параметры
| Параметр | Описание |
|----------|----------|
| `TradeVolume` | Чистый объём (в лотах) каждой рыночной сделки. |
| `CandleType` | Тип/таймфрейм свечей, используемый индикаторами. |
| `BollingerPeriod` | Период расчёта полос Боллинджера. |
| `BollingerDeviation` | Множитель стандартного отклонения полос. |
| `DonchianPeriod` | Длина канала Дончиана, применяемая как фильтр тренда. |
| `ConfirmationPeriod` | Минимальное количество последовательных баров, поддерживающих наклон канала. |
| `AtrPeriod` | Период индикатора ATR. |
| `StopAtrMultiplier` | Количество ATR для стоп-лосса. |
| `TakeAtrMultiplier` | Количество ATR для тейк-профита. |

## Примечания
- Проверка наклона канала Дончиана реализована через счётчики, что избавляет от копирования буферов индикатора и соответствует т
ребованиям проекта.
- Все комментарии и логи написаны на английском языке согласно правилам репозитория.
- Функции проверки маржи и расчёта объёма из MQL-версии не реализуются; размер позиции задаётся параметром `TradeVolume`.
