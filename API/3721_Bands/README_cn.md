# Bands 策略

## 概述
该策略把 MetaTrader 5 智能交易系统 **Bands.mq5** 迁移到了 StockSharp 的高级 API。系统等待一根已经收盘的 K 线从布林带
外部重新收回到通道内部，且只有在唐奇安通道的斜率在可配置的周期内保持稳定时才会开仓。平均真实波幅（ATR）的倍数
用于重建原策略的止损与止盈距离，同时引入线性回归诊断模块，每累计 100 笔成交就输出一次权益曲线的决定系数 R-squa
red，与 MQL 版本的调试信息保持一致。

## 交易逻辑
1. 订阅单一时间框架的蜡烛数据，并计算布林带、唐奇安通道以及与原策略一致周期的 ATR。
2. 当没有持仓时，检查**上一根**完成的蜡烛：
   - 如果开盘价低于布林带下轨且收盘价重新站上轨道，同时唐奇安下轨在 `ConfirmationPeriod` 根 K 线内未下跌，则开多。
   - 如果开盘价高于布林带上轨且收盘价跌回通道，同时唐奇安上轨在 `ConfirmationPeriod` 根 K 线内未上升，则开空。
3. 当存在持仓时，如果上一根 K 线的收盘价突破了相应方向的唐奇安边界，或当前蜡烛的最高/最低价触发 ATR 倍数保护，
   则立即平仓。
4. 每当收到自己的成交回报，就记录当前投资组合权益，并在每累计 100 笔成交后打印一次回归的 R-squared。若斜率为负，
   输出同样为负值以贴合原始 EA 的处理方式。

## 风险管理
- 所有入场都以 `TradeVolume` 指定的净数量发送市价单。
- 止损与止盈不通过挂单设置，而是根据蜡烛的最高价和最低价与 ATR 倍数进行比对，在代码中自行触发。
- 当保护条件满足时，以市价单立即平掉全部仓位，并清空当前的保护价格。

## 参数
| 参数 | 说明 |
|------|------|
| `TradeVolume` | 每次下单的净手数。 |
| `CandleType` | 用于计算所有指标的蜡烛类型 / 时间框架。 |
| `BollingerPeriod` | 布林带的计算周期。 |
| `BollingerDeviation` | 布林带的标准差倍数。 |
| `DonchianPeriod` | 唐奇安通道的长度，用作趋势过滤。 |
| `ConfirmationPeriod` | 要求唐奇安斜率保持不变的最小连续根数。 |
| `AtrPeriod` | ATR 的计算周期。 |
| `StopAtrMultiplier` | 止损所使用的 ATR 倍数。 |
| `TakeAtrMultiplier` | 止盈所使用的 ATR 倍数。 |

## 说明
- 唐奇安斜率的判定通过递增计数器实现，无需复制整段指标缓冲区，既符合项目约束也能复现原策略逻辑。
- 所有代码注释和日志信息均为英文，以符合仓库的统一要求。
- 原 MQL 脚本中的资金管理与保证金校验函数未复刻，StockSharp 版本改由 `TradeVolume` 参数直接控制仓位规模。
