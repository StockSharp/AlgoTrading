# Стратегия Volume Trader V2

## Обзор
Volume Trader V2 — прямой порт советника MetaTrader `Volume_trader_v2_www_forex-instruments_info.mq4`. Оригинальная версия отслеживает, как меняется суммарный объём последних свечей, и на основе этого потока удерживает позицию в одну сторону. При переносе сохранены ключевые особенности: работа только с одной позицией, фильтр по времени и обработка сигнала один раз на каждую завершённую свечу.

Стратегия подписывается на настраиваемый поток свечей и кеширует объёмы двух последних завершённых баров. Когда формируется новая свеча, объёмы предыдущих двух баров (в терминах MetaTrader — `Volume[1]` и `Volume[2]`) сравниваются и определяется актуальное направление торговли:

- `Volume[1] < Volume[2]` — формируется **покупка**.
- `Volume[1] > Volume[2]` — формируется **продажа**.
- Равные объёмы или отключённые торговые часы приводят к закрытию позиции.

Перед отправкой нового приказа стратегия закрывает противоположную позицию, чтобы поведение в StockSharp полностью совпадало с жизненным циклом ордеров в MetaTrader.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | Таймфрейм 5 минут | Тип данных, запрашиваемый через `SubscribeCandles`. Настройте его под период исходного графика в MetaTrader. |
| `StartHour` | 8 | Начальный час (включительно), когда разрешено торговать. Вне этого окна сигналы игнорируются, позиция закрывается. |
| `EndHour` | 20 | Последний час (включительно), когда разрешено торговать. Если свеча начинается позже, стратегия остаётся вне рынка. |
| `TradeVolume` | 0.1 | Лотность, унаследованная от советника. Значение также присваивается `Strategy.Volume`, чтобы вспомогательные методы использовали тот же объём. |

Все параметры реализованы через `StrategyParam<T>`, поэтому их можно оптимизировать и отображать в пользовательском интерфейсе.

## Логика торговли
1. Обрабатываются только завершённые свечи — это гарантирует посвечный паритет с исходным советником.
2. Перед расчётом сигнала в переменные `_previousVolume` и `_twoBarsAgoVolume` сохраняются значения `Volume[1]` и `Volume[2]`.
3. Проверяется, что время открытия свечи попадает в диапазон `StartHour`–`EndHour` включительно. Если условие не выполнено, позиция закрывается и новые заявки не создаются.
4. Определяется целевое направление:
   - Лонг, если объём последней свечи меньше объёма предыдущей.
   - Шорт, если объём последней свечи больше объёма предыдущей.
   - Нейтрально во всех остальных случаях.
5. Если целевое направление отличается от текущей позиции, сначала закрывается противоположная позиция (`BuyMarket(-Position)` или `SellMarket(Position)`).
6. Новая заявка с объёмом `TradeVolume` отправляется только тогда, когда стратегия находится вне рынка или сразу после закрытия обратной позиции.
7. После обработки обновляются кешированные объёмы, чтобы в следующем цикле снова сравнивались две последние завершённые свечи.

Такой порядок действий исключает появление заявок на незавершённых свечах и обеспечивает ту же частоту принятия решений, что и MetaTrader-версия с переменной `LastBarChecked`.

## Дополнительные замечания
- В `OnStarted` вызывается `StartProtection()`, чтобы использовать встроенный механизм защиты позиции.
- Свойство `Comment` выводит те же диагностические сообщения, что и советник (`"Up trend"`, `"Down trend"`, `"No trend..."`, `"Trading paused"`), что упрощает мониторинг.
- Стратегия не создаёт дополнительных коллекций и полностью опирается на высокоуровневое API подписки на свечи, что соответствует требованиям проекта.
- Для воспроизведения результатов оригинала настройте тип свечей, инструмент и объём в соответствии с параметрами, использовавшимися в MetaTrader.
