# Стратегия Simple Profit By Periods Panel 2 Extended

## Обзор
Первоначальный советник MetaTrader только выводил статистику по прибыли за день, неделю и месяц. Перевод на StockSharp повторяет эту логику: стратегия подписывается на лёгкую свечную серию, которая используется как таймер, накапливает реализованный результат и публикует показатели в поле `Comment`, чтобы они всегда отображались в интерфейсе и журналах.

В C# версии нет графических меток. Вместо этого комментарий содержит шесть строк:

1. Дневная реализованная прибыль и процентное изменение относительно баланса в начале дня.
2. Недельная реализованная прибыль и соответствующий процент.
3. Месячная реализованная прибыль и процент изменения.
4. Количество сделок за текущий день.
5. Количество сделок за текущую неделю.
6. Количество сделок за текущий месяц.

Стратегия носит исключительно информационный характер: заявки не отправляются и позиция не изменяется.

## Возможности
- **Учёт реализованного PnL.** Каждая запись `MyTrade` обновляет историю на основе приращения `PnLManager.RealizedPnL` (либо `Strategy.PnL`, если менеджер недоступен).
- **Коррекция торгового дня.** Если календарная дата приходится на субботу или воскресенье, дневной интервал смещается на последнюю пятницу — как в исходном скрипте.
- **Диапазоны недели и месяца.** Начало недели вычисляется от скорректированного торгового дня (понедельник-пятница). Месячный результат обнуляется в первый день текущего месяца.
- **Панель через комментарий.** Все агрегированные значения выводятся в `Strategy.Comment`, что обеспечивает отображение в терминале, журналах и внешних мониторингах.
- **Автоочистка истории.** Старые записи удаляются, когда они выходят за пределы недельного окна, поэтому стратегия не расходует лишнюю память при длительной работе.

## Параметры
| Имя | Описание | Значение по умолчанию |
| --- | -------- | --------------------- |
| `CandleType` | Свечная серия, используемая как периодический триггер обновления. | `Таймфрейм 1 минута` |

## Как это работает
1. **Запуск.** `OnStarted` фиксирует текущий реализованный PnL, оформляет подписку на выбранный таймфрейм и сразу обновляет панель.
2. **Учёт сделок.** При поступлении `MyTrade` проверяется соответствие инструменту стратегии, рассчитывается приращение прибыли, сохраняются время и сумма, затем панель обновляется.
3. **Периодический пересчёт.** Каждая завершённая свеча (роль таймера) пересчитывает дневные/недельные/месячные показатели на случай изменения баланса или наступления новой недели.
4. **Проценты.** Процентные значения вычисляются как отношение текущего баланса к балансу до накопленной прибыли (`previous = current - profit`). Если исходный баланс ≤ 0, выводится `0.00%`, чтобы избежать деления на ноль.

## Рекомендации
- Для корректной работы стратегия должна быть привязана к портфелю — используется `Portfolio.CurrentValue`. Без портфеля комментарий будет показывать нулевые суммы и проценты.
- Выбирайте свечной поток, который гарантированно доступен по инструменту. Цены внутри свечей не используются, требуется только периодический сигнал.
- В статистику попадают только реализованные результаты. Плавающий PnL не отображается до тех пор, пока позиция не закрыта.
- В качестве валюты выводится валюта портфеля; если её нет — валюта инструмента; при отсутствии обеих значений сумма выводится без префикса.

## Структура файлов
- `CS/SimpleProfitByPeriodsPanel2ExtendedStrategy.cs` — код стратегии.
- `README.md` — описание на английском языке.
- `README_cn.md` — описание на китайском языке.
- `README_ru.md` — описание на русском языке (текущий файл).

## Отличия от MetaTrader
- В исходном советнике использовались текстовые метки, в StockSharp-версии применяется поле `Comment`, что упрощает реализацию и не требует отрисовки.
- StockSharp предоставляет `PnLManager`, поэтому нет необходимости вручную обходить историю счёта.
- Фильтрация сделок основана на инструменте стратегии, а не на magic number. Запускайте стратегию на том инструменте, который требуется мониторить.

## Ограничения
- Учитывается только реализованный результат; плавающая прибыль/убыток и свопы по открытым позициям не отображаются (аналогично оригиналу).
- Корректность процентов зависит от оперативного обновления `Portfolio.CurrentValue`. При задержке со стороны брокера значения могут изменяться лишь при следующем обновлении баланса.
