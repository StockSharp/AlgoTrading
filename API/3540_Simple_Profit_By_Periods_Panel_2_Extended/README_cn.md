# Simple Profit By Periods Panel 2 Extended 策略

## 概述
原始的 MetaTrader 指标只是在图表上显示每日、每周和每月的收益统计。本策略在 StockSharp 中重现该面板：订阅一个轻量级的蜡烛序列作为定时器，累计已实现盈亏，并将结果写入策略的 `Comment` 字段，方便在界面或日志中随时查看。

与 MetaTrader 版本不同，C# 版本不再创建图形标签。`Comment` 字段包含六行信息：

1. 当天已实现盈亏以及相对于当天开始时账户余额的百分比变化。
2. 当周已实现盈亏及对应百分比。
3. 当月已实现盈亏及对应百分比。
4. 当天成交次数。
5. 当周成交次数。
6. 当月成交次数。

策略仅用于统计展示，不会发送任何订单，也不会修改当前持仓。

## 主要特性
- **已实现盈亏追踪。** 通过 `PnLManager.RealizedPnL`（若不可用则回退到策略 `PnL`）的增量记录每笔成交的真实结果。
- **交易日修正。** 若当前日期为周六或周日，则“日度”统计自动回退到上一交易日（周五），与原脚本保持一致。
- **周/月区间计算。** 周度统计从修正后的交易日推算（周一至周五），月度统计在当月第一天重新开始。
- **基于 Comment 的仪表盘。** 聚合后的数值写入 `Strategy.Comment`，可直接在 StockSharp 界面、日志或外部监控脚本中查看。
- **自动清理历史。** 只保留最近的成交记录，超出一周窗口的旧数据会被移除，避免长时间运行时占用过多内存。

## 参数
| 名称 | 说明 | 默认值 |
| ---- | ---- | ------ |
| `CandleType` | 用于触发刷新流程的蜡烛序列，选择合适的时间框架即可。 | `1 分钟周期` |

## 工作流程
1. **启动阶段。** `OnStarted` 初始化已实现盈亏基准，订阅所选蜡烛序列，并立即刷新一次面板。
2. **成交入账。** 每次收到 `MyTrade` 时，若成交属于当前品种，则计算已实现盈亏增量、记录时间戳及金额，并刷新面板。
3. **定时刷新。** 每根完成的蜡烛都会重新计算日/周/月的统计，以适应账户余额变化或新的一周开始。
4. **百分比计算。** 百分比基于当前余额与“期初余额”（`previous = current - profit`）之比，如果期初余额小于等于零，则输出 `0.00%` 以避免除零。

## 使用建议
- 策略需要绑定投资组合，才能读取 `Portfolio.CurrentValue`。若未绑定组合，评论中的余额和百分比会保持为 0。
- 选择市场中始终可用的蜡烛类型，仅用于触发刷新，不依赖具体价格。
- 仅统计已实现盈亏，未平仓浮盈浮亏不会显示，直到仓位平仓为止。
- 货币符号优先使用投资组合货币；若为空，则退回到标的证券的货币；若仍为空，则直接显示数值。

## 文件结构
- `CS/SimpleProfitByPeriodsPanel2ExtendedStrategy.cs` – 策略实现。
- `README.md` – 英文说明。
- `README_cn.md` – 中文说明（当前文件）。
- `README_ru.md` – 俄文说明。

## 与 MetaTrader 版本的差异
- 原脚本通过图形标签显示信息，而本策略使用 `Comment` 字段，更轻量也无需额外绘图。
- StockSharp 直接提供 `PnLManager` 获取已实现盈亏，无需遍历账户历史。
- 过滤逻辑基于策略绑定的证券，而非魔术号；请确保策略附加到需要监控的品种。

## 限制
- 仅统计已实现结果；持仓中的浮动盈亏及掉期费用均不计入（与原脚本一致）。
- 依赖 `Portfolio.CurrentValue` 的实时更新；若券商或连接适配器更新滞后，则百分比可能延迟到下一次余额刷新。
