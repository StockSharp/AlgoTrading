# Стратегия EMA LWMA RSI

## Обзор
**EMA LWMA RSI Strategy** переносит советник MetaTrader «EMA LWMA RSI» на платформу StockSharp. Стратегия сравнивает две скользящие средние, использующие одинаковый тип цены и при необходимости смещение вперёд, а также подтверждает импульс фильтром RSI. Алгоритм реагирует только на полностью сформированные свечи выбранного таймфрейма и работает с одной совокупной позицией: перед открытием новой сделки в противоположную сторону он закрывает текущую позицию. Расстояния стоп-лосса и тейк-профита задаются в пунктах и автоматически масштабируются относительно шага цены инструмента.

## Логика торговли
1. Рассчитываются экспоненциальная (EMA) и линейно-взвешенная (LWMA) скользящие средние с отдельными периодами, но общим типом цены. Если `MaShift` больше нуля, обе средние сдвигаются вперёд на указанное количество баров, полностью повторяя параметр `shift` из MetaTrader.
2. RSI рассчитывается по собственному типу цены. Классический порог 50 отделяет бычий импульс от медвежьего.
3. После закрытия свечи:
   - **Покупка** активируется, когда EMA переходит **выше** LWMA (предыдущее значение EMA было больше LWMA, а текущее стало ниже) и значение RSI находится **выше 50**.
   - **Продажа** активируется, когда EMA переходит **ниже** LWMA (предыдущее значение EMA было ниже LWMA, а текущее стало выше) и RSI опускается **ниже 50**.
4. Сигналы выставляют внутренние флаги ожидания. Перед разворотом стратегия сначала вызывает `ClosePosition()`, чтобы ликвидировать открытую позицию. После подтверждения сделки незамедлительно отправляется рыночный ордер в требуемом направлении. Такой механизм соответствует оригинальному советнику, который ждал подтверждения транзакции.
5. Защитные ордера запускаются через `StartProtection`. Если стоп-лосс или тейк-профит отключён (значение равно нулю), соответствующая нога пропускается — поведение полностью повторяет MQL.

## Особенности реализации
- Выбор типа цены повторяет перечисление MetaTrader (Close, Open, High, Low, Median, Typical, Weighted, Average). Взвешенная цена вычисляется как `(High + Low + 2 * Close) / 4`, что соответствует `PRICE_WEIGHTED`.
- Размер «пункта» определяется автоматически: при 3- и 5-знаковых форекс-символах шаг цены умножается на 10, чтобы один pip соответствовал 10 пунктам котировки.
- Для подписки на свечи используется высокоуровневый API StockSharp. Смещение реализовано через индикаторы `Shift`, без ручного доступа к буферам.
- Логика удерживает булевы флаги ожидающих покупок/продаж. Они предотвращают повторные заявки, пока предыдущий ордер в работе, и очищаются после сделок или когда позиция уже соответствует сигналу.
- На ценовой панели отображаются свечи и обе скользящие, а RSI рисуется на отдельной области графика.

## Параметры
| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|-----------------------|----------|
| `CandleType` | `DataType` | `Таймфрейм 1 час` | Серия свечей, которую анализирует стратегия. |
| `StopLossPips` | `int` | `150` | Дистанция стоп-лосса в пунктах. `0` — отключить. |
| `TakeProfitPips` | `int` | `150` | Дистанция тейк-профита в пунктах. `0` — отключить. |
| `EmaPeriod` | `int` | `28` | Период экспоненциальной средней. |
| `LwmaPeriod` | `int` | `8` | Период линейно-взвешенной средней. |
| `MaShift` | `int` | `0` | Смещение (в барах), применяемое к обеим средним. |
| `RsiPeriod` | `int` | `14` | Период усреднения RSI. |
| `MaAppliedPrice` | `AppliedPriceType` | `Weighted` | Тип цены для EMA и LWMA. |
| `RsiAppliedPrice` | `AppliedPriceType` | `Weighted` | Тип цены для RSI. |

## Использование
1. Привяжите стратегию к нужному инструменту и задайте `CandleType`, совпадающий с таймфреймом оригинального советника.
2. При необходимости скорректируйте защитные дистанции в пунктах и параметры индикаторов под условия брокера.
3. После запуска подписки включите торговлю. Стратегия всегда поддерживает только одну позицию и использует `ClosePosition()` перед сменой направления.

Python-версия стратегии пока отсутствует.
