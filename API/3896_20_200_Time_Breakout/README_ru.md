# Twenty200 Time Breakout

Стратегия представляет собой порт советника MetaTrader **20/200 expert v4.2 (AntS)**. Каждый день в заданный час она сравнивает два значения цены открытия прошлых часовых свечей (по умолчанию 6 и 2 бара назад). Если более дальняя свеча открылась выше ближней на величину, превышающую `Short Delta` пунктов, открывается короткая позиция. Обратное соотношение, превышающее `Long Delta`, приводит к покупке.

## Логика торговли

- Подписка ведётся на часовые свечи (тип задаётся параметром `Candle Type`).
- В сутки допускается только одна сделка. Заявки отправляются, когда активируется свеча с часом, равным `Trade Hour`.
- Сигналы используют цену открытия свечей `LookbackFar` и `LookbackNear` баров назад.
  - **Продажа:** `Open[t1] - Open[t2] > Short Delta × пункт`.
  - **Покупка:** `Open[t2] - Open[t1] > Long Delta × пункт`.
- После появления сигнала выставляется рыночный ордер вычисленного объёма. Стоп-лосс и тейк-профит копируют значения советника и задаются в пунктах; стратегия переводит их в цену через `Security.PriceStep`.
- Пока позиция открыта, новых входов не происходит. На следующей календарной дате торговля возобновляется.

## Управление позицией

- Стоп-лосс и тейк-профит контролируются на каждом обновлении свечи по её максимуму и минимуму.
- Параметр `Max Open Hours` принудительно закрывает позицию по рынку, если её жизнь превышает заданное количество часов (по умолчанию 504). Нулевое значение отключает ограничение.

## Управление капиталом

- `Fixed Volume` — базовый объём сделки, используемый при выключенном авто-лоте или отсутствии данных о балансе.
- При включённом `Use Auto Lot` размер позиции повторяет огромную таблицу из MT4. В StockSharp она аппроксимирована формулой `volume = round(balance × Auto Lot Factor, 2)` с коэффициентом `0.000038`, что даёт ту же лесенку лотов в диапазоне от 300 до 270 000+ USD.
- Если текущая стоимость портфеля опускается ниже последнего зафиксированного значения, следующий вход умножается на `Big Lot Multiplier`, что соответствует режиму «Big Lot» оригинального советника.
- Объёмы приводятся к `Security.VolumeStep` и ограничиваются диапазоном `MinVolume`/`MaxVolume`, если он задан.

## Отличия от оригинала

- В MT4 вручную перечислено более тысячи порогов для авто-лота. В порте используется линейный коэффициент (`Auto Lot Factor`), воспроизводящий ту же ступенчатую зависимость. При необходимости точного совпадения для другого брокера скорректируйте коэффициент.
- Стоп и тейк реализованы как рыночные закрытия при достижении уровней свечой, что обеспечивает одинаковое поведение в тестах и на реале без биржевых стоп-заявок.
- Глобальные переменные `globalBalans` и `globalPosic` заменены на состояние в памяти, дополнительная инфраструктура не требуется.

## Параметры

| Параметр | Описание |
|----------|----------|
| Long/Short Take Profit | Дистанция тейк-профита в пунктах. |
| Long/Short Stop Loss | Дистанция стоп-лосса в пунктах. |
| Trade Hour | Час (0–23), когда разрешены входы. |
| Far/Near Lookback | Количество баров для выборки двух цен открытия. |
| Long/Short Delta | Требуемый разрыв в пунктах для входа. |
| Max Open Hours | Максимальная продолжительность позиции в часах (0 отключает). |
| Fixed Volume | Базовый объём при выключенном авто-лоте. |
| Use Auto Lot | Включение авто-расчёта объёма по балансу. |
| Auto Lot Factor | Множитель для аппроксимации MT4-таблицы лотов. |
| Big Lot Multiplier | Множитель объёма после просадки счёта. |
| Candle Type | Таймфрейм свечей для сигналов. |
