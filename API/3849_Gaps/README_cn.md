# Gaps 策略

## 概述

**Gaps 策略** 是 MetaTrader 4 专家顾问 `gaps.mq4` 的直接移植版本。系统监控 15 分钟蜡烛图，并寻找在上一根蜡烛高低区间之外开盘的缺口。一旦出现缺口，策略立即建立仓位，期待价格向缺口方向回补。

StockSharp 版本遵循原始逻辑，完全基于高级蜡烛订阅 API 实现。和 MQL 代码一样，所有交易都通过市价单执行，不会自动放置固定的止损或止盈订单。

## 交易规则

1. 订阅 15 分钟蜡烛（可通过 `CandleType` 参数调整）。
2. 保存上一根已完成蜡烛的最高价和最低价。
3. 当新蜡烛开始时：
   - 计算缺口缓冲区：`(MinGapSize + spreadInSteps) * pointValue`。
   - 如果开盘价 **高于** `previousHigh + gapBuffer`，则开立 **空单**。
   - 如果开盘价 **低于** `previousLow - gapBuffer`，则开立 **多单**。
4. 每根蜡烛最多只允许一次交易。下单后必须等待下一根蜡烛才能生成新的信号。

当可用时，策略使用实时买价/卖价计算点差；若没有报价数据，则退回到单个价格步长作为保守的缓冲设置。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MinGapSize` | `1` | 触发交易所需的最小缺口大小（以价格步长表示）。 |
| `GapVolume` | `0.1` | 缺口信号触发时下单的交易量。 |
| `CandleType` | `15m TimeFrame` | 用于计算的蜡烛类型（默认 15 分钟）。 |

所有参数都通过 `StrategyParam<T>` 注册，可在 StockSharp Designer 等工具中进行优化。

## 实现细节

- 使用 `SubscribeCandles` + `Bind` 组合，仅处理已完成的蜡烛。
- 持续保存上一根蜡烛的价格范围，避免在内存中维护额外数据序列。
- 通过记录触发交易的蜡烛开盘时间，阻止同一根蜡烛出现重复下单。
- 图表输出会绘制订阅的蜡烛以及策略交易，方便快速可视化检查。

## 与 MQL 版本的差异

- 原始 EA 中的止盈/止损参数传递位置错误，因此实际运行时相当于没有保护单。移植版保持这一行为，不会自动设置保护订单。
- 点差处理逻辑改为优先使用实时买卖报价，在无法获取报价时再退回到最小价格步长。

## 使用要求

- 需要具备 StockSharp API 以及对应品种的蜡烛数据。
- Level1 报价不是必须项，但会提升点差估计的准确度。
