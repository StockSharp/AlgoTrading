# 动态止损

## 概述
原版 MetaTrader 专家顾问“Dynamic Stop Loss”并不会自行开仓，而是监控已有持仓。一旦出现新的 K 线，就把保护性止损重新放置在距离最新价格固定的距离处。StockSharp 版本保持相同的行为：每根完成的 K 线都会为当前持仓方向重新计算止损价位；当没有仓位时，策略保持空闲直到检测到新的仓位。

## 工作原理
1. 策略根据 `Candle Type` 参数订阅蜡烛（默认 1 分钟）。
2. 蜡烛收盘时读取收盘价，并将用户设置的点数距离转换成绝对价格差。转换过程中优先使用 `Security.PriceStep`，若缺失则退回 `Security.Step`，最后再退回常数 `1`。
3. 持有多头仓位时，策略取消已有的止损单，并在 `Close - Distance` 位置挂出新的卖出止损单。
4. 持有空头仓位时，策略在 `Close + Distance` 位置挂出买入止损单。
5. 当仓位被手动或止损单平掉后，会立即撤销剩余的保护性订单，避免留存的挂单。

因此止损始终围绕最新价格移动，与 MQL 版本一样，价格向不利方向波动时止损也会随之后退。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `StopLossPoints` | `800` | 市价与止损之间的距离，单位为 MetaTrader 点。该数值会乘以 `Security.PriceStep`（缺省时依次退回 `Security.Step` 与 `1`）后再作用于收盘价。设为 `0` 可停用止损管理。 |
| `CandleType` | `TimeFrameCandle(00:01:00)` | 触发止损重算的蜡烛类型，应与 MetaTrader 中使用的周期保持一致。 |

## 使用说明
- 策略只负责管理止损，开仓动作需由其它策略或人工完成。
- 请确保证券的元数据（`PriceStep`、`Step`、交易量信息）已正确填写，否则点值换算会偏离经纪商的最小报价步长。对于带有小数点报价的外汇品种尤其重要。
- 由于每根完成的 K 线都会重新计算止损，即使行情朝不利方向波动，止损仍会跟随价格移动，这与原始脚本中使用 `OrderModify` 的方式一致。
- 每次计算出的价格都会替换旧的止损单，以确保交易平台与最新的保护价保持同步。
