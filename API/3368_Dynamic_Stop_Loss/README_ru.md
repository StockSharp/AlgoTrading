# Динамический стоп-лосс

## Обзор
Оригинальный советник MetaTrader "Dynamic Stop Loss" не открывает сделки самостоятельно. Его задача — отслеживать уже существующие позиции и при появлении новой свечи переставлять защитный стоп-лосс на фиксированное расстояние от актуальной цены. Порт на StockSharp повторяет это поведение: каждая завершённая свеча инициирует перерасчёт защитного стопа для текущего направления. Если позиции нет, стратегия просто ждёт появления новой.

## Как это работает
1. Стратегия подписывается на свечи, заданные параметром `Candle Type` (по умолчанию таймфрейм 1 минута).
2. После закрытия свечи берётся её цена закрытия и умножается на выбранное расстояние в пунктах. Значение переводится из метатрейдеровских пунктов в абсолютную цену через `Security.PriceStep` (при отсутствии шага — через `Security.Step`, далее используется значение `1`).
3. При наличии длинной позиции предыдущий стоп отменяется, а новый продающий стоп выставляется на уровне `Close - Distance`.
4. При короткой позиции стоп переносится на `Close + Distance` путём регистрации покупающего стоп-ордера.
5. Когда позиция закрывается вручную или по стопу, остаточный защитный ордер снимается, чтобы не оставлять висящие заявки.

Таким образом стоп постоянно «привязан» к текущей цене и может смещаться как ближе, так и дальше, полностью повторяя логику MQL.

## Параметры
| Название | Значение по умолчанию | Описание |
| --- | --- | --- |
| `StopLossPoints` | `800` | Расстояние между рынком и стопом в пунктах MetaTrader. Перед применением значение умножается на `Security.PriceStep` (при его отсутствии используется `Security.Step`, затем `1`). Ноль отключает сопровождение стопа. |
| `CandleType` | `TimeFrameCandle(00:01:00)` | Тип свечей, по закрытию которых пересчитывается стоп. Выберите таймфрейм, соответствующий графику в MetaTrader. |

## Рекомендации по использованию
- Стратегия не инициирует входы — она только сопровождает уже открытые позиции. Открытие сделок следует выполнять вручную или другими алгоритмами.
- Убедитесь, что в описании инструмента заполнены `PriceStep`, `Step` и объёмные параметры. Без корректного шага цены перевод пунктов в абсолютные значения будет некорректным, особенно для инструментов с дробными пипсами.
- Стоп пересчитывается на каждой закрытой свече, поэтому при неблагоприятном движении он также смещается вслед за ценой — это соответствует вызову `OrderModify` в оригинальном коде.
- Каждый новый уровень полностью заменяет предыдущий стоп-ордер, чтобы торговая система всегда отражала актуальную защиту.
