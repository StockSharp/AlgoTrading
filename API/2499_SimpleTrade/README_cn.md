# Simple Trade 策略

## 概述
该策略是 MetaTrader 5 智能交易系统 “SimpleTrade (barabashkakvn's edition)” 的 C# 版本。策略比较当前K线的开盘价与三根之前K线的开盘价：若当前开盘价更高，则做多；否则做空。每一笔交易只持有一个完整的K线周期，并使用以点值（pip）表示的固定止损距离进行保护。

在 StockSharp 中，策略通过高级 API 订阅所选的K线序列，仅在收到收盘状态的K线后才进行决策，确保信号基于已经完成的数据。当出现下一根K线或当前K线触及止损价位时，仓位都会被关闭。

## 交易逻辑
- **开仓**
  - 每当一根K线收盘时，记录该K线的开盘价，并维护最近四个开盘价的滚动历史。
  - 当没有持仓并且已经记录了至少四个开盘价时，将最新的开盘价与三根之前的开盘价进行比较。
  - 如果当前开盘价高于三根之前的开盘价，则买入做多；否则卖出做空。
- **平仓**
  - 每笔交易都会根据 *StopLossPips × 点值* 相对于开仓价计算出固定止损水平。
  - 下一根K线到来时，无论盈亏都会主动平仓，以复现原始EA“一根K线持仓”的规则。
  - 如果在当前K线内，高点（空单）或低点（多单）突破了止损价格，策略会立即通过市价单尝试离场。

## 参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `StopLossPips` | 120 | 以点值表示的止损距离。代码遵循 MetaTrader 的处理方式：对于报价小数位为 3 或 5 的品种，将价格步长乘以 10 以获得常用的 pip 大小。 |
| `TradeVolume` | 1 | 市价单的交易手数，请根据品种合约规模进行调整。 |
| `CandleType` | 1 小时时间框架 | 指定要订阅的K线类型，应与在 MetaTrader 中使用的周期保持一致。 |

所有参数都以 `StrategyParam<T>` 暴露，可在界面中调整或用于优化。

## 实现细节
- 为符合仓库规范，开盘价历史使用简单的字段轮换，而非集合容器。
- 策略不会提交独立的止损委托，而是通过检查K线的最高价和最低价来判断止损是否被触发，并在触发时提交市价平仓。
- 鉴于 StockSharp 中持仓更新是异步的，策略在寻找新的入场信号之前会先关闭现有仓位，避免同时存在多个相反订单，行为与原始EA“先平后开”的流程一致。
- 点值由 `Security.PriceStep` 计算得出，对于 3 位或 5 位小数的品种会额外乘以 10，以匹配 MetaTrader 中对 pip 的定义。

## 使用建议
- 适用于拥有稳定最小报价单位的工具，例如主要外汇货币对，使得基于点值的止损具有可比性。
- 根据不同品种优化 `StopLossPips`，较大的数值可以提供更宽的缓冲，较小的数值则能更快响应波动。
- 确保券商连接能够提供带有最终状态的K线更新，从而获得准确的开盘价数据。

## 风险与限制
- 仅持有一根K线的设计使策略对时间框架非常敏感，需针对不同周期进行回测和参数验证。
- 使用K线极值来模拟止损执行，在波动剧烈的行情中可能产生与真实止损单不同的滑点。
- 当历史数据充足后，策略几乎始终保持在多头或空头仓位中，在盘整市场可能产生较高的交易频率。
