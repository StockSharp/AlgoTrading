# Стратегия MACD Stochastic 2
[English](README.md) | [中文](README_cn.md)

Стратегия переносит логику советника MetaTrader «MACD Stochastic 2» на высокоуровневый API StockSharp. Используется сочетание трехбарного фильтра по MACD и осциллятора Stochastic для поиска разворотных моментов возле зон перепроданности и перекупленности. Управление рисками реализовано через отдельные стопы и тейк-профиты для лонга и шорта, а также опциональный трейлинг-стоп в пунктах.

## Обзор

- Работает с любым инструментом и таймфреймом, который задается параметром `CandleType`.
- MACD анализируется по основной линии, при этом сигнальная линия и гистограмма доступны для отображения на графике.
- Входы подтверждаются значением %K Stochastic ниже 20 для покупок и выше 80 для продаж.
- Подсчет пункта имитирует исходную реализацию: берем `PriceStep` инструмента и умножаем его на 10 для котировок с 3 или 5 знаками после запятой.

## Логика торговли

### Вход в лонг

1. Значения основной линии MACD для текущей и двух предыдущих завершенных свечей находятся ниже нуля.
2. Текущее значение MACD выше предыдущего, а предыдущее меньше значения двух свечей назад (локальный минимум).
3. %K Stochastic ниже 20 (зона перепроданности).
4. Открытая короткая позиция закрывается, после чего открывается новая длинная при `Position <= 0`.

### Вход в шорт

1. Значения основной линии MACD для текущей и двух предыдущих завершенных свечей находятся выше нуля.
2. Текущее значение MACD ниже предыдущего, а предыдущее выше значения двух свечей назад (локальный максимум).
3. %K Stochastic выше 80 (зона перекупленности).
4. Открытая длинная позиция закрывается, после чего открывается новая короткая при `Position >= 0`.

### Управление позицией

- **Жесткий стоп / тейк:** Для лонга и шорта задаются отдельные расстояния в пунктах. При нуле соответствующий уровень отключается.
- **Трейлинг-стоп:** При включении активируется после прохождения ценой заданного расстояния и сдвигается только при превышении шага трейлинга, что ограничивает частые модификации.
- **Противосигнал:** При появлении обратного сигнала текущая позиция закрывается и открывается новая в противоположную сторону с заданным объемом.

## Параметры

| Параметр | По умолчанию | Описание |
|----------|--------------|----------|
| `TradeVolume` | `1` | Объем ордера для новых сделок. |
| `StopLossBuyPips` | `50` | Дистанция стоп-лосса для лонга в пунктах (0 — отключить). |
| `StopLossSellPips` | `50` | Дистанция стоп-лосса для шорта в пунктах (0 — отключить). |
| `TakeProfitBuyPips` | `50` | Дистанция тейк-профита для лонга в пунктах (0 — отключить). |
| `TakeProfitSellPips` | `50` | Дистанция тейк-профита для шорта в пунктах (0 — отключить). |
| `TrailingStopPips` | `0` | Дистанция трейлинг-стопа в пунктах. Ноль отключает трейлинг. |
| `TrailingStepPips` | `5` | Минимальный прирост в пунктах для сдвига трейлинг-стопа. При включенном трейлинге должен быть положительным. |
| `MacdFastPeriod` | `12` | Быстрая EMA в расчете MACD. |
| `MacdSlowPeriod` | `26` | Медленная EMA в расчете MACD. |
| `MacdSignalPeriod` | `9` | Период сигнальной линии MACD. |
| `StochasticKPeriod` | `5` | Длина окна для %K Stochastic. |
| `StochasticDPeriod` | `3` | Период сглаживания %D Stochastic. |
| `StochasticSlowing` | `3` | Дополнительное сглаживание %K Stochastic. |
| `CandleType` | `таймфрейм 1ч` | Тип свечей (таймфрейм) для расчета индикаторов. |

## Примечания

- Величина пункта вычисляется как `PriceStep`, умноженный на 10 для инструментов с 3 или 5 знаками после запятой, что соответствует логике оригинального советника.
- Пороговые значения Stochastic (20/80) заданы в коде константами по аналогии с исходным файлом.
- Все решения принимаются после формирования свечи, что соответствует работе советника на закрытии бара.

## Использование

1. Задайте инструмент, `CandleType` и объем перед запуском.
2. Настройте стопы, тейк-профиты и трейлинг в соответствии с волатильностью инструмента.
3. При необходимости используйте оптимизатор StockSharp для подбора параметров MACD и Stochastic.
4. На графике автоматически отображаются свечи, индикаторы и сделки стратегии (при доступности области).
