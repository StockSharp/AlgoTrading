# Стратегия Bollinger Band Squeeze

## Обзор
Стратегия представляет собой перенос советника MetaTrader 4 «BOLINGER BAND SQUEEZE» на высокоуровневый API StockSharp. Алгоритм ищет периоды сжатия полос Боллинджера на рабочем таймфрейме и входит в позиции при расширении полос, если движение подтверждается фильтрами тренда, импульса и макро-тренда. Дополнительно логика управления позициями адаптирована под инфраструктуру `Strategy`.

## Логика торговли
1. **Сжатие и расширение полос**
   - На выбранном таймфрейме рассчитываются полосы Боллинджера (по умолчанию длина 20, отклонение 2).
   - Ширина последней завершённой свечи сравнивается с шириной свечи `RetraceCandles` баров назад.
   - Если отношение ширин превышает `SqueezeRatio`, считается, что цена выходит из фазы сжатия.
2. **Фильтр тренда**
   - Две взвешенные скользящие средние по типичной цене (WMA 6 и WMA 85) определяют локальный тренд. Для покупки требуется, чтобы быстрая WMA была выше медленной, для продажи — ниже.
3. **Фильтр импульса**
   - На более старшем таймфрейме рассчитывается Momentum (длина 14). Хранится максимальное отклонение от уровня 100 за три последних завершённых свечи старшего периода.
   - Отклонение должно превышать порог `MomentumBuyThreshold`/`MomentumSellThreshold` в зависимости от направления. Крупные таймфреймы выбираются автоматически (M15→H1, H1→D1, D1→месяц, неделя также использует месячный сигнал). Если старший период недоступен, фильтр отключается.
4. **Макро-фильтр**
   - На месячном (30-дневном) таймфрейме рассчитывается MACD 12/26/9. Вход в лонг разрешён только при расположении линии MACD выше сигнальной, вход в шорт — при обратном условии.
5. **Условия входа**
   - Лонг: расширение полос, быстрая WMA выше медленной, месячный MACD бычий, импульс превышает порог, свечи имеют пересечение (`candle[-2].Low < candle[-1].High`), и текущая позиция не длинная.
   - Шорт: зеркальные условия (быстрая WMA ниже медленной, месячный MACD медвежий, импульс выше порога, условие `candle[-1].Low < candle[-2].High`).
6. **Условия выхода**
   - Позиция закрывается, когда цена закрытия достигает соответствующей внешней полосы Боллинджера (лонг — верхняя, шорт — нижняя). Это воспроизводит поведение блока `stop()` из оригинального кода.
   - Вызов `StartProtection()` позволяет легко добавить дополнительные стопы/тейки через инструменты StockSharp.

## Индикаторы и подписки
- Основной таймфрейм `CandleType`.
- Автоматически подобранный старший таймфрейм для Momentum.
- Месячные свечи (30-дневная аппроксимация) для MACD.
- Используемые индикаторы: BollingerBands, две WeightedMovingAverage по типичной цене, Momentum, MovingAverageConvergenceDivergenceSignal.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `CandleType` | 15-минутные свечи | Рабочий таймфрейм. |
| `BollingerPeriod` | 20 | Длина полос Боллинджера. |
| `BollingerWidth` | 2.0 | Множитель стандартного отклонения. |
| `SqueezeRatio` | 1.1 | Минимальное отношение текущей ширины к исторической. |
| `RetraceCandles` | 10 | Количество свечей для сравнения ширины. |
| `FastMaLength` | 6 | Длина быстрой WMA (типичная цена). |
| `SlowMaLength` | 85 | Длина медленной WMA (типичная цена). |
| `MomentumLength` | 14 | Период индикатора Momentum на старшем таймфрейме. |
| `MomentumBuyThreshold` | 0.3 | Минимальное отклонение импульса для покупки. |
| `MomentumSellThreshold` | 0.3 | Минимальное отклонение импульса для продажи. |

Все параметры реализованы через `StrategyParam<T>`, поэтому их можно оптимизировать и изменять во время работы стратегии.

## Особенности реализации
- Индикаторы подключаются через `SubscribeCandles().BindEx(...)`, что соответствует требованиям к высокоуровневому API и избавляет от ручного управления коллекциями индикаторов.
- Значения WMA обновляются внутри обработчика свечей по типичной цене, что повторяет использование LWMA в исходном советнике.
- Очередь из трёх значений Momentum имитирует обращения `iMomentum` с лагами 1–3 в MQL.
- Значения месячного MACD кэшируются в полях и доступны для каждой рабочей свечи без дополнительных запросов.
- Выход по касанию внешней полосы заменяет блоки трейлинг-стопа/безубытка, сохраняя исходную идею закрытия при сильном движении.
- Размер заявки определяется свойством `Strategy.Volume`; при развороте добавляется `Math.Abs(Position)`, чтобы закрыть противоположную позицию и открыть новую.
