# Стратегия Blau Ergodic MDI

## Общее описание
Стратегия Blau Ergodic Market Directional Indicator повторяет работу советника MetaTrader `Exp_BlauErgodicMDI`. Алгоритм получает поток свечей старшего таймфрейма (по умолчанию 4 часа), выполняет тройное сглаживание выбранной ценовой серии и формирует гистограмму момента и сигнальную линию. Торговые решения принимаются в одном из трёх режимов:

1. **Breakdown** – вход при пересечении гистограммой нулевой линии.
2. **Twist** – вход при смене направления наклона гистограммы.
3. **CloudTwist** – вход при пересечении гистограммы и сигнальной линии.

Каждый сигнал может закрывать противоположные позиции и/или открывать новые сделки в зависимости от установленных разрешений.

## Логика индикатора
1. Сгладить выбранную цену указанным типом средней с периодом `PrimaryLength`, получив базовую линию.
2. Рассчитать момент `(price - baseline) / point_value`.
3. Дважды сгладить момент периодами `FirstSmoothingLength` и `SecondSmoothingLength`, построив гистограмму.
4. Ещё раз сгладить гистограмму с периодом `SignalLength`, получив сигнальную линию.
5. Сохранить значения согласно `SignalBarShift`, чтобы анализировать только закрытые свечи.

Поддерживаются методы сглаживания EMA, SMA, SMMA/RMA и WMA. Выбор цены полностью соответствует оригинальному индикатору (close, open, high, low, median, typical, weighted, simple, quarter, trend-following варианты).

## Параметры
| Параметр | Описание |
| -------- | -------- |
| `Volume` | Объём заявки при открытии позиции. |
| `StopLossPoints` | Стоп-лосс в пунктах (0 — отключено). |
| `TakeProfitPoints` | Тейк-профит в пунктах (0 — отключено). |
| `SlippagePoints` | Допустимое отклонение цены в пунктах для рыночных заявок. |
| `AllowLongEntries` / `AllowShortEntries` | Разрешение на открытие длинных / коротких позиций. |
| `AllowLongExits` / `AllowShortExits` | Разрешение на закрытие текущих позиций встречным сигналом. |
| `Mode` | Режим генерации сигналов (Breakdown / Twist / CloudTwist). |
| `CandleType` | Таймфрейм свечей, используемых в расчётах (по умолчанию 4H). |
| `SmoothingMethod` | Семейство скользящей средней для всех этапов сглаживания. |
| `PrimaryLength` | Период сглаживания базовой цены. |
| `FirstSmoothingLength` | Период первого сглаживания момента. |
| `SecondSmoothingLength` | Период второго сглаживания (формирование гистограммы). |
| `SignalLength` | Период сглаживания гистограммы для построения сигнальной линии. |
| `AppliedPrice` | Тип цены, участвующей в расчёте. |
| `SignalBarShift` | Число закрытых баров, на основании которых подтверждается сигнал. |
| `Phase` | Зарезервированный параметр для совместимости, в текущей реализации не используется. |

## Условия сделок
* **Breakdown**
  * Покупка: гистограмма на `SignalBarShift` > 0 и на предыдущей свече ≤ 0.
  * Продажа: гистограмма на `SignalBarShift` < 0 и на предыдущей свече ≥ 0.
* **Twist**
  * Покупка: гистограмма разворачивается вверх (предыдущее значение < текущего, а значение двумя барами ранее > предыдущего).
  * Продажа: гистограмма разворачивается вниз (предыдущее значение > текущего, а значение двумя барами ранее < предыдущего).
* **CloudTwist**
  * Покупка: гистограмма пересекает сигнальную линию снизу вверх (текущее значение гистограммы > сигнального, предыдущее ≤ сигнального).
  * Продажа: гистограмма пересекает сигнальную линию сверху вниз.

При наличии разрешений сначала закрываются противоположные позиции, затем открывается новая сделка заданным объёмом.

## Управление рисками
Функция `StartProtection` активируется со стоп-лоссом и тейк-профитом, пересчитанными из пунктов в денежные значения с помощью шага цены инструмента. Если расстояние равно нулю, соответствующая защита не включается. Параметр `SlippagePoints` конвертируется аналогичным образом.

## Дополнительно
* Сигналы обрабатываются только по завершённым свечам, что повторяет поведение оригинального советника.
* `SignalBarShift` позволяет подтверждать сигналы на более старых барах, уменьшая вероятность ложных входов.
* Параметр `Phase` сохранён для совместимости и не влияет на расчёты в поддерживаемых методах сглаживания.
* Все комментарии в коде написаны на английском языке для удобства международной команды.
