# HistoryInfoEaStrategy

## Обзор
**HistoryInfoEaStrategy** переносит утилиту MT4 «HistoryInfo» на платформу StockSharp. Вместо вывода текста на график MetaTrader стратегия обрабатывает поток `OnNewMyTrade` и суммирует статистику по сделкам, подходящим под выбранный фильтр. Агрегированные значения доступны через свойство `LastSnapshot` и продублированы в журнале стратегии, что позволяет визуализировать их в любом интерфейсе.

Стратегия не выставляет собственные заявки. Её задача — анализировать чужие сделки, проходящие через выбранный счёт и инструмент. Каждая подходящая сделка увеличивает накопленные показатели.

## Параметры
| Параметр | Описание |
|----------|----------|
| `FilterType` | Режим фильтрации: `CountByUserOrderId`, `CountByComment`, `CountBySecurity`. |
| `MagicNumber` | Ожидаемое значение `Order.UserOrderId` для режима `CountByUserOrderId`. Пустая строка отключает фильтр. |
| `OrderComment` | Префикс комментария (`Order.Comment`) для режима `CountByComment`. Значение по умолчанию (`"OrdersComment"`) повторяет заглушку из MT4 и обычно не совпадает ни с одной заявкой. |
| `SecurityId` | Идентификатор инструмента (`Security.Id`) для режима `CountBySecurity`. Значение по умолчанию (`"OrdersSymbol"`) следует заменить на реальный тикер. |

## Агрегируемые метрики
`LastSnapshot` обновляется после каждой подходящей сделки и содержит:

- `FirstTrade` / `LastTrade` — время первой и последней учтённой сделки.
- `TotalVolume` — суммарный объём в единицах торгового инструмента.
- `TotalProfit` — сумма `MyTrade.PnL` за вычетом комиссии, то есть реализованная прибыль в валюте счёта.
- `TotalPips` — та же прибыль, пересчитанная в пункты на основе `Security.PriceStep`, `Security.StepPrice` и поправки на 3/5 знаков после запятой.
- `TradeCount` — количество сделок, прошедших фильтр.

Журнал стратегии выводит одну строку с теми же цифрами, имитируя строку `Comment()` оригинального советника.

## Использование
1. Запустите стратегию на том же счёте и инструменте, где торгуют остальные роботы.
2. Выберите режим `FilterType` и заполните связанный параметр (магическое число, префикс комментария или идентификатор инструмента).
3. Стартуйте стратегию. Как только появится первая подходящая сделка, данные появятся в `LastSnapshot` и в журнале.
4. При перезапуске стратегии счётчики автоматически обнуляются.

> **Важно.** Для корректного подсчёта пунктов необходимо, чтобы в инструменте были заданы `Security.PriceStep` и `Security.StepPrice`. Если хотя бы одно поле пустое, счётчик пунктов останется равным нулю, но прибыль по-прежнему будет суммироваться.

## Особенности портирования
- В MT4 цикл проходил по `OrdersHistoryTotal()` на каждом тике. В StockSharp используется реакция на `MyTrade`, поэтому данные обновляются мгновенно и не требуется опрос истории.
- В MT4 прибыль считалась как `OrderProfit + OrderCommission + OrderSwap`. В StockSharp реализованная прибыль приходит через `MyTrade.PnL`, а комиссия — отдельным полем. Стратегия вычитает комиссию из `PnL`, сохраняя совместимость с оригиналом.
- Заглушки строк (`"OrdersComment"`, `"OrdersSymbol"`) сохранены намеренно, чтобы поведение соответствовало исходному советнику. Замените их перед запуском, если ожидаете совпадений.
- Отрисовка текста на графике заменена структурированными данными (`LastSnapshot`) и сообщениями в журнале — разработчик интерфейса сам решает, как визуализировать цифры.
- Стратегия принципиально не вмешивается в торговлю: можно запускать её в «наблюдательном» режиме рядом с любым торговым алгоритмом.

## Возможные расширения
- Подписать внешний интерфейс на обновления `LastSnapshot` и отображать статистику в панели мониторинга.
- Добавить дополнительные фильтры (по портфелю, по пользовательским тегам), если адаптер поставляет такие поля.
- Организовать периодический экспорт снимков в CSV/JSON для отчётности.
