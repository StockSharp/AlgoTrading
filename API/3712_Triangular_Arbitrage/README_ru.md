# Стратегия треугольного арбитража
[English](README.md) | [中文](README_cn.md)

Стратегия переносит советник MetaTrader «Triangular Arbitrage» в инфраструктуру StockSharp. Она постоянно отслеживает три валютные пары (две базовые и прямой кросс) и открывает корзину из трёх рыночных сделок, как только подразумеваемый курс кросса отклоняется от котируемого более чем на заданный порог. Корзина закрывается сразу после достижения совокупной плавающей прибыли в валюте счёта.

## Основная идея

- Отслеживаются цены ask первой ноги (например, EURUSD), второй ноги (например, USDJPY) и прямого кросса (например, EURJPY).
- Подразумеваемый курс вычисляется как `Ask первой ноги × Ask второй ноги` и сравнивается с ask по кросс-курсу.
- При превышении относительного отклонения над `Threshold` формируется арбитражная корзина:
  - Если подразумеваемый курс выше (положительная разница), открывается покупка по кроссу и продажи по обеим ногам.
  - Если подразумеваемый курс ниже (отрицательная разница), кросс продаётся, а обе ноги покупаются.
- Все позиции закрываются, когда плавающая прибыль корзины достигает `ProfitTarget`.

## Потоки данных

- **Рыночные данные:** необходимы котировки уровня 1 для всех трёх инструментов. Стратегия считывает лучшие bid/ask из подписанных потоков.
- **Без свечей и индикаторов:** логика использует только «сырые» котировки, без исторических свечей и пользовательских буферов.

## Торговые правила

### Поиск возможности

1. Дождаться появления цен ask для всех трёх инструментов.
2. Убедиться, что эквити выбранного портфеля не ниже `MinimumBalance` (используются `Portfolio.CurrentValue` или `CurrentBalance`).
3. Рассчитать относительное отклонение `(ImpliedPrice - CrossAsk) / CrossAsk` и сравнить его с `Threshold`.

### Выставление сделок

- Размер заявок задаётся параметром `LotSize`. Перед отправкой объём приводится к `VolumeStep`, `MinVolume` и `MaxVolume` конкретного инструмента. Если брокерские ограничения не позволяют разместить нужный объём, сделки пропускаются.
- При положительном отклонении (покупка кросса / продажи ног):
  - `BuyMarket` по кросс-курсу.
  - `SellMarket` по каждой ноге.
- При отрицательном отклонении (продажа кросса / покупки ног):
  - `SellMarket` по кроссу.
  - `BuyMarket` по каждой ноге.

### Управление выходом

- Пока корзина открыта, стратегия отслеживает:
  - Реализованную прибыль с момента открытия корзины (`PnLManager.RealizedPnL`).
  - Плавающую прибыль по каждому инструменту, оцениваемую на основе средней цены входа и последнего bid/ask.
- Как только сумма реализованной и плавающей прибыли достигает `ProfitTarget`, все три позиции закрываются рыночными заявками в противоположную сторону.
- После каждой сделки пересчитываются средние цены и объёмы; когда все позиции обнулены, цикл завершается и можно искать новую возможность.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `FirstPair` | *(нет)* | Инструмент первой ноги (например, EURUSD). |
| `SecondPair` | *(нет)* | Инструмент второй ноги (например, USDJPY). |
| `CrossPair` | *(нет)* | Инструмент прямого кросса (например, EURJPY). |
| `LotSize` | `0.01` | Запрашиваемый объём каждой сделки до выравнивания брокером. |
| `ProfitTarget` | `10` | Прибыль в валюте счёта, при которой корзина закрывается. |
| `Threshold` | `0.0001` | Минимальное относительное отклонение между подразумеваемым и котируемым курсами. |
| `MinimumBalance` | `1000` | Минимальная величина эквити портфеля для открытия новой корзины. |

## Особенности реализации

- Подписки уровня 1 (`SubscribeLevel1`) полностью управляют логикой; стратегия не хранит собственных коллекций и не обращается к индикаторам, что соответствует правилам репозитория.
- Слежение за позициями выполняется в обработчике `OnNewMyTrade`, где восстанавливаются знаковые объёмы и средние цены без запросов к истории сделок.
- Оценка прибыли использует `PriceStep`/`StepPrice`, если они заданы брокером; в противном случае применяется простая формула «разница цены × объём», аналогичная поведению исходного MQL-советника при отсутствии метаданных.
- Внутренние флаги (`_hasOpenCycle`, `_closeRequested`) предотвращают повторные открытия и гарантируют один арбитражный цикл на каждую обнаруженную возможность.

## Теги и характеристики

- **Рынок:** Форекс, мультивалютная торговля.
- **Стиль:** Рыночно-нейтральный арбитраж.
- **Направление:** Длинные и короткие корзины в зависимости от знака отклонения.
- **Таймфрейм:** По тиковым данным/котировкам, без зависимости от свечей.
- **Риск-контроль:** Порог по эквити (`MinimumBalance`), немедленное закрытие при достижении `ProfitTarget`, автоматическое нормирование объёмов.
