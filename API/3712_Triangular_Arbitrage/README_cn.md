# 三角套利策略
[English](README.md) | [Русский](README_ru.md)

该策略把 MetaTrader 上的 “Triangular Arbitrage” 智能交易系统迁移到 StockSharp。它持续监控三只外汇品种（两条腿以及直接的交叉盘），一旦隐含交叉汇率与报价交叉盘之间的差异超过可配置阈值，就会同时发送三笔市价单构成套利组合；当组合的浮动盈亏达到设定的目标值时立即全部平仓。

## 核心思路

- 读取第一条腿（如 EURUSD）、第二条腿（如 USDJPY）以及交叉盘（如 EURJPY）的最优卖价。
- 计算隐含交叉价 `Leg1Ask × Leg2Ask`，并与交叉盘的卖价比较。
- 当相对差异超过 `Threshold` 时建立套利头寸：
  - 隐含价格更高（正差异）时，买入交叉盘并同时卖出两条腿。
  - 隐含价格更低（负差异）时，卖出交叉盘并同时买入两条腿。
- 当组合的浮动盈亏达到 `ProfitTarget` 时立即全部平仓。

## 数据流

- **行情来源：** 三个品种均订阅 Level 1 行情，策略仅使用最优买/卖价。
- **无指标与蜡烛图：** 逻辑完全基于即时报价，不使用历史蜡烛或自定义缓存。

## 交易规则

### 机会识别

1. 等待所有三个品种的最优卖价就绪。
2. 检查所选投资组合的权益是否大于等于 `MinimumBalance`（读取 `Portfolio.CurrentValue` 或 `CurrentBalance`）。
3. 计算 `(ImpliedPrice - CrossAsk) / CrossAsk`，并与 `Threshold` 比较。

### 下单逻辑

- `LotSize` 控制每笔订单的目标手数。提交前会按 `VolumeStep`、`MinVolume`、`MaxVolume` 自动对齐；若无法满足交易所约束则放弃下单。
- 正差异（买交叉盘、卖两条腿）：
  - 对交叉盘执行 `BuyMarket`。
  - 对两条腿分别执行 `SellMarket`。
- 负差异（卖交叉盘、买两条腿）：
  - 对交叉盘执行 `SellMarket`。
  - 对两条腿分别执行 `BuyMarket`。

### 退出管理

- 组合持仓期间持续跟踪：
  - 自开仓以来的已实现盈亏（`PnLManager.RealizedPnL`）。
  - 基于平均成交价与当前 bid/ask 估算的浮动盈亏。
- 当两者之和达到 `ProfitTarget` 时，立即使用相反方向的市价单平掉三只品种。
- 每次成交都会在 `OnNewMyTrade` 中更新平均价与净头寸；当三只品种全部归零后，套利周期结束，可等待下一次机会。

## 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `FirstPair` | *(无)* | 第一条腿的证券（如 EURUSD）。 |
| `SecondPair` | *(无)* | 第二条腿的证券（如 USDJPY）。 |
| `CrossPair` | *(无)* | 交叉盘证券（如 EURJPY）。 |
| `LotSize` | `0.01` | 每笔订单请求的手数，在对齐前的原始值。 |
| `ProfitTarget` | `10` | 套利组合达到该账户货币利润时平仓。 |
| `Threshold` | `0.0001` | 隐含交叉价与报价交叉盘之间的最小相对差异。 |
| `MinimumBalance` | `1000` | 开启新套利组合所需的最低账户权益。 |

## 实现细节

- 通过 `SubscribeLevel1` 订阅三只品种的 Level 1 行情，不创建额外集合，也不访问指标缓存，符合仓库约束。
- 使用 `OnNewMyTrade` 事件重建每个证券的净仓与平均价，无需查询历史成交。
- 估算盈亏时优先使用 `PriceStep`/`StepPrice`；若经纪商未提供相应元数据，则退化为价格差乘以数量的近似计算，与原始 MQL 脚本在缺少信息时的行为一致。
- 内部标志 `_hasOpenCycle` 和 `_closeRequested` 防止重复下单，确保每次机会只执行一个套利循环。

## 标签与特性

- **市场类型：** 外汇，多品种联动。
- **策略风格：** 市场中性套利。
- **方向：** 根据差异符号决定买入或卖出组合。
- **时间尺度：** 逐笔报价驱动，无蜡烛依赖。
- **风险控制：** `MinimumBalance` 权益门槛、`ProfitTarget` 盈利止盈、自动手数对齐。
