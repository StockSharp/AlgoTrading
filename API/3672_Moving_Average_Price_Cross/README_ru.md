# Стратегии пересечения цены и скользящей средней

## Обзор

Набор содержит две C#-стратегии, портированные из примеров MetaTrader 5 в каталоге `MQL/50198`:

* **`MovingAveragePriceCrossStrategy`** — базовая система пересечения закрытия свечи и скользящей средней, которая держит только одну позицию.
* **`MovingAverageMartingaleStrategy`** — расширенный вариант с мартингейлом, увеличивающий объём и дистанции защитных ордеров после убыточных сделок при сохранении той же логики сигналов.

Обе реализации используют высокоуровневый API StockSharp, подписываются на свечи для расчёта сигналов и предоставляют параметры в метатрейдеровских пунктах для стоп-лосса и тейк-профита.

## Файлы

| Файл | Описание |
| --- | --- |
| `CS/MovingAveragePriceCrossStrategy.cs` | Базовое пересечение цены и SMA с фиксированным объёмом и статичными защитными уровнями. |
| `CS/MovingAverageMartingaleStrategy.cs` | Вариант с мартингейлом, масштабирующий объёмы и дистанции стопов после убытков. |

## Торговая логика

### MovingAveragePriceCrossStrategy

1. Подписывается на свечи указанного таймфрейма и считает простую скользящую среднюю (`SMA`).
2. Обрабатывает только завершённые свечи, повторяя поведение эксперта MT5.
3. Анализирует пересечения закрытия свечи и SMA по двум последним свечам:
   * **Продажа**, если скользящая выше цены (цена пересекла среднюю сверху вниз).
   * **Покупка**, если скользящая ниже цены (цена пересекла среднюю снизу вверх).
4. Открывает рыночный ордер только при отсутствии открытых позиций.
5. Вызывает `StartProtection`, чтобы выставить стоп-лосс и тейк-профит, пересчитанные из пунктов MT5 в абсолютное смещение цены.

### MovingAverageMartingaleStrategy

1. Использует те же свечи и SMA для генерации сигналов.
2. Отслеживает реализованную прибыль/убыток после закрытия позиции и сохраняет результат последней сделки.
3. Когда возникает новый сигнал и позиция отсутствует:
   * При **убытке** увеличивает объём следующей сделки на `VolumeMultiplier` (с ограничением `MaxVolume`) и масштабирует дистанции стоп-лосса и тейк-профита на `TargetMultiplier`.
   * При **прибыли** возвращает объём и защитные расстояния к исходным значениям.
4. Перед отправкой рыночного ордера вызывает `StartProtection` с пересчитанными уровнями.
5. Всегда держит не более одной позиции, как и оригинальный советник.

## Управление риском

* Стопы и тейки задаются в пунктах MT5 и переводятся в абсолютные значения через размер шага цены (`PriceStep`), с умножением на 10 для инструментов с 3/5 знаками после запятой.
* Вариант с мартингейлом ограничивает множители для недопущения чрезмерных расстояний.
* Объём заявки приводится к `VolumeStep`, учитываются `MinVolume` и `MaxVolume`, чтобы заявки принимались биржей.

## Параметры

### Общие

| Параметр | Стратегия | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | обе | `1 minute` | Тип свечей, используемый для расчётов. |
| `MaPeriod` | обе | `50` | Период простой скользящей средней. |

### MovingAveragePriceCrossStrategy

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `OrderVolume` | `1` | Объём заявки, выровненный по шагу объёма инструмента. |
| `TakeProfitPoints` | `150` | Дистанция тейк-профита в пунктах MT5 (0 — без тейка). |
| `StopLossPoints` | `150` | Дистанция стоп-лосса в пунктах MT5 (0 — без стопа). |

### MovingAverageMartingaleStrategy

| Параметр | Значение по умолчанию | Описание |
| --- | --- | --- |
| `StartingVolume` | `1` | Исходный объём, восстанавливаемый после прибыльной сделки. |
| `MaxVolume` | `5` | Максимальный объём после применения множителей. |
| `TakeProfitPoints` | `100` | Начальная дистанция тейк-профита в пунктах MT5. |
| `StopLossPoints` | `300` | Начальная дистанция стоп-лосса в пунктах MT5. |
| `VolumeMultiplier` | `2` | Множитель объёма для следующей сделки после убытка. |
| `TargetMultiplier` | `2` | Множитель дистанций стоп-лосса и тейк-профита после убытка. |

## Рекомендации по использованию

* «Пункты» MT5 соответствуют одному `PriceStep` для большинства инструментов; для валют с 3/5 знаками после запятой применяется множитель 10.
* Обе стратегии игнорируют сигналы при наличии открытой позиции, что соответствует проверке `PositionsTotal()` в оригинале.
* Параметры помечены для оптимизации и могут подбираться в дизайнере StockSharp.
