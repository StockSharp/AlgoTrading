# Стратегия DeMarker Gaining Position Volume 2
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет работу эксперта MetaTrader 5 **«DeMarker gaining position volume 2»** средствами StockSharp. Она анализирует выбранный таймфрейм свечей, рассчитывает осциллятор DeMarker и открывает сделки при попадании значения в зоны перекупленности/перепроданности. Реализация сохраняет ключевые особенности оригинала: фиксированный объём, возможность инверсии сигналов, встроенные стоп-лоссы/тейк-профиты и фильтр торговой сессии.

## Поведение оригинального эксперта

* **Платформа**: MetaTrader 5.
* **Индикатор**: DeMarker с периодом 14 по умолчанию.
* **Входы**: покупка при значении ниже нижнего уровня, продажа при значении выше верхнего уровня.
* **Управление риском**: стоп-лосс и тейк-профит в пунктах, опциональный трейлинг-стоп с шагом, ограничение по времени торговли.
* **Менеджмент позиции**: не более одной сделки на свечу, перед сменой направления закрываются противоположные позиции.

Конверсия для StockSharp придерживается тех же принципов. Защитные ордера запускаются через `StartProtection`, поэтому стопы и трейлинг автоматически сопровождают позицию после открытия.

## Логика торговли

1. Подписка на указанный тип свечей (`CandleType`, по умолчанию 5 минут) и вычисление DeMarker с периодом `DeMarkerPeriod`.
2. После закрытия свечи проверяется индикатор:
   * При `ReverseSignals = false` (по умолчанию):
     * **Лонг** — `DeMarker <= LowerLevel`.
     * **Шорт** — `DeMarker >= UpperLevel`.
   * При `ReverseSignals = true` условия зеркально меняются.
3. При активном `UseTimeFilter` торговля ведётся только в интервале `SessionStart`–`SessionEnd` (поддерживаются интервалы через полночь).
4. На каждой свече допускается только один новый вход. Перед открытием сделки стратегия закрывает противоположные позиции, что повторяет оригинал.
5. Объём сделок фиксируется параметром `TradeVolume`. При наличии части позиции в нужную сторону объём доводится до требуемого.

## Управление риском

* `StopLossPoints` и `TakeProfitPoints` (в шагах цены) соответствуют точечным стопу и тейку эксперта.
* Включение `EnableTrailing` переключает стоп на `TrailingStopPoints` и активирует стандартный трейлинг с шагом `TrailingStepPoints`.
* `StartProtection` запускается с параметром `useMarketOrders = true`, поэтому защитные заявки исполняются рыночным образом, как и в MT5.

## Параметры

| Параметр | Описание |
|----------|----------|
| `DeMarkerPeriod` | Период усреднения индикатора DeMarker. |
| `UpperLevel` / `LowerLevel` | Пороговые уровни перекупленности/перепроданности. |
| `ReverseSignals` | Инвертировать логику входов. |
| `StopLossPoints` | Дистанция начального стоп-лосса в шагах цены. |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены. |
| `EnableTrailing` | Активировать блок трейлинг-стопа. |
| `TrailingStopPoints` | Дистанция трейлинг-стопа при активном сопровождении. |
| `TrailingStepPoints` | Минимальный шаг подтяжки трейлинга. |
| `UseTimeFilter` | Ограничить торговлю интервалом `SessionStart`–`SessionEnd`. |
| `SessionStart` / `SessionEnd` | Границы торговой сессии (поддерживается переход через сутки). |
| `TradeVolume` | Объём заявки при каждом сигнале. |
| `CandleType` | Анализируемый тип свечей (по умолчанию 5-минутные). |

## Особенности реализации

* В оригинале использовался параметр «активации трейлинга». В стандартном механизме StockSharp аналог отсутствует, поэтому трейлинг включается сразу при `EnableTrailing = true`.
* Проверки на корректность лота, уровни Freeze/Stops и обновление котировок выполняются инфраструктурой StockSharp, поэтому в коде не дублируются.
* Для дополнительного протоколирования можно использовать методы `LogInfo`/`LogError` базового класса `Strategy`.
