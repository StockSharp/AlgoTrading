# Стратегия Exp XBullsBearsEyes Vol

## Обзор
Стратегия представляет собой портирование MetaTrader-советника **Exp_XBullsBearsEyes_Vol** на C#. В оригинале индикатор складывает значения Bulls Power и Bears Power, умножает результат на объём свечи и окрашивает гистограмму в зависимости от силы импульса. Для лонгов и шортов ведётся по два независимых слота, что позволяет наращивать позицию по мере усиления цвета. Версия на StockSharp восстанавливает многокаскадный фильтр, логику окраски и управление позициями, опираясь на высокоуровневые методы API для заявок и риск-менеджмента.

Алгоритм подписывается на выбранный таймфрейм и обрабатывает только закрытые свечи. Он пересчитывает пользовательский индикатор XBullsBearsEyes и реагирует на смену цветов: бычьи оттенки закрывают шорты и могут открыть один или два лонговых слота, медвежьи цвета выполняют зеркальные действия. Стоп-лоссы и тейк-профиты задаются в пунктах и передаются в `StartProtection`, чтобы защитные приказы сопровождались движком риск-менеджмента.

## Логика индикатора
1. Bulls Power и Bears Power восстанавливаются по EMA периода `IndicatorPeriod`, сравнивая максимумы/минимумы свечи с сглаженной ценой закрытия.
2. Четырёхступенчатый адаптивный фильтр накапливает бычье (`CU`) и медвежье (`CD`) давление с коэффициентом `Gamma`, итоговая величина равна `CU / (CU + CD) * 100 - 50`.
3. Полученный результат умножается на тиковый либо реальный объём в зависимости от параметра `VolumeType`.
4. Произведение и сам объём дополнительно сглаживаются выбранной средней (`SmoothingMethod`, `SmoothingLength`, `SmoothingPhase`; для Jurik учитывается фаза при наличии соответствующего свойства).
5. Уровни `HighLevel1`, `HighLevel2`, `LowLevel1`, `LowLevel2` формируют зоны окраски: значения выше верхних порогов дают цвета `0` или `1`, ниже нижних — цвета `3` или `4`, иначе фиксируется нейтральный цвет `2`.
6. История цветов хранится, чтобы оценки проводились по свече с шагом `SignalBar` (по умолчанию — одна закрытая свеча назад) и сравнивались с предыдущим значением.

## Правила торговли
- Цвета `1` и `0` указывают на бычье давление. Если цвет переходит в одно из этих значений и предыдущий цвет был слабее, слот 1 (`PrimaryVolume`) или слот 2 (`SecondaryVolume`) открывает лонг. При активном `AllowShortExit` текущие шорты закрываются.
- Цвета `3` и `4` сигнализируют о медвежьем давлении. Переход к ним при более высоком предыдущем цвете открывает шорт в слоте 1 или 2 соответственно. При включенном `AllowLongExit` существующие лонги закрываются.
- Каждый слот отслеживает собственное состояние и не реагирует повторно, пока позиция не будет закрыта противоположным сигналом.
- `SignalBar` задаёт число уже завершённых свечей, которые нужно пропустить перед оценкой цвета (0 — последняя закрытая свеча). Для сравнения необходимо минимум два исторических значения.
- `StopLossPoints` и `TakeProfitPoints`, заданные в шагах цены, конвертируются с помощью `Security.PriceStep` в абсолютные расстояния и используются для запуска `StartProtection`.

## Параметры
| Параметр | Описание |
|----------|----------|
| `PrimaryVolume` | Объём первой ступени (цвета 1 / 3). |
| `SecondaryVolume` | Объём второй ступени (цвета 0 / 4). |
| `StopLossPoints` / `TakeProfitPoints` | Расстояние до стопа/тейка в шагах цены, 0 — отключено. |
| `AllowLongEntry` / `AllowShortEntry` | Разрешение на открытие позиций соответствующего направления. |
| `AllowLongExit` / `AllowShortExit` | Разрешение на автоматическое закрытие при появлении противоположного цвета. |
| `CandleType` | Таймфрейм для подписки на свечи и расчёта индикатора (по умолчанию 8 часов). |
| `IndicatorPeriod` | Период EMA для расчёта Bulls/Bears Power. |
| `Gamma` | Коэффициент адаптивного фильтра (0.0–0.999). |
| `VolumeType` | Источник объёма — тиковый или реальный. |
| `HighLevel1`, `HighLevel2`, `LowLevel1`, `LowLevel2` | Коэффициенты, определяющие границы цветовых зон. |
| `SmoothingMethod` | Тип сглаживания (SMA, EMA, SMMA, LWMA, Jurik, JurX, ParMA→EMA, T3, VIDYA→EMA, AMA). |
| `SmoothingLength` | Период сглаживающей средней. |
| `SmoothingPhase` | Параметр фазы для Jurik (ограничен диапазоном [-100, 100]). |
| `SignalBar` | Количество закрытых свечей, на которое смещается анализ цвета. |

## Рекомендации по использованию
- Стратегия работает с единственным инструментом, возвращаемым `GetWorkingSecurities()`, и выставляет рыночные заявки.
- Управление слотами ведётся по чистой позиции: дополнительные входы увеличивают текущий объём, а выход полностью закрывает направление.
- При отсутствии данных по реальному объёму выбор `VolumeType = Real` автоматически падёт на тиковые данные.
- Для методов VIDYA и Parabolic используется экспоненциальное приближение, так как в StockSharp эти реализации доступны напрямую.
- Убедитесь, что `Security.PriceStep` настроен корректно, иначе пересчёт `StopLossPoints` и `TakeProfitPoints` в абсолютные значения может отличаться от ожиданий.
