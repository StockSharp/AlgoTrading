# Dematus 策略

## 概述
Dematus 策略复刻自 MetaTrader 5 上的 "Dematus" 专家顾问。策略使用 DeMarker 指标识别动量拐点，并支持带有动态仓位规模的金字塔加仓。交易依据 `CandleType` 参数指定的 K 线类型，仅在每根完成的 K 线上评估信号。

每次评估都会同时检查最新的 DeMarker 数值以及两根 K 线前的数值。当两根前的数值低于 0.3 而当前数值重新站上 0.3 时，认为多头动量恢复；当两根前的数值高于 0.7 而当前数值跌破 0.7 时，认为空头动量增强。开仓后，如果价格相对上一次成交价移动超过设定距离，并且 DeMarker 再次触发相同方向的信号，则可以继续加仓。

## 交易逻辑
- **初次入场：**
  - 当 DeMarker 在两根 K 线前低于 0.3 而当前值升至 0.3 以上，并且当前没有持仓时，买入做多。
  - 当 DeMarker 在两根 K 线前高于 0.7 而当前值跌至 0.7 以下，并且当前没有持仓时，卖出做空。
- **加仓规则：**
  - 记录最近一次成交价。如果价格相对该价位朝不利方向移动至少 `DistancePips`（自动换算为价格单位），并且 DeMarker 在同方向再次触发交叉信号，则按既定方向再次下单。
  - 新下单的数量等于上一笔成交量乘以 `VolumeMultiplier`，随后根据标的的最小交易步长自动取整，并受交易所最小/最大数量限制。这一逻辑与原版 EA 的系数放大量一致。
- **止损与跟踪：**
  - 每笔入场都会按照 `StopLossPips` 设置固定止损，若加仓则会重新计算合并仓位的保护价位。
  - 如果启用了 `TrailingStopPips`，当浮动盈利超过 `TrailingStopPips + TrailingStepPips` 时，止损价会向有利方向收紧，仿真原 EA 的追踪止损算法。
- **权益防护：**
  - 空仓时，将虚拟权益底线设置为 `Balance - VirtualStopEquity`。
  - 一旦权益较余额增加至少 `TrailingStartEquity`，就启动权益追踪，并将底线维持在峰值权益减去 `TrailingEquity`。
  - 持仓期间若权益跌破虚拟底线，立即市价平掉所有仓位。

## 参数说明
| 参数 | 说明 |
| --- | --- |
| `InitialVolume` | 首次入场的基础下单量，完全平仓后也会回到该值。 |
| `DemarkerLength` | DeMarker 指标的计算周期。 |
| `StopLossPips` | 入场时设置的固定止损距离（以点为单位），0 表示关闭固定止损。 |
| `TrailingStopPips` | 追踪止损的基本距离，0 表示关闭追踪。 |
| `TrailingStepPips` | 在移动追踪止损前所需的额外盈利距离，启用追踪时必须为正。 |
| `DistancePips` | 与上一次成交价之间的最小距离（点），满足后才允许加仓。 |
| `TrailingEquity` | 权益追踪时，峰值权益与保护底线之间的间距。 |
| `VirtualStopEquity` | 空仓时计算虚拟权益底线所使用的缓冲值。 |
| `TrailingStartEquity` | 启动权益追踪所需的盈余阈值。 |
| `VolumeMultiplier` | 上一次成交量在加仓时的倍数系数。 |
| `ResetEntryPrice` | 若启用，在每次平仓后清除记录的最近成交价，从而阻止立即加仓。 |
| `CandleType` | 用于计算和生成信号的 K 线类型/时间框架。 |

## 实现细节
- 采用 StockSharp 高层 API 实现，使用 `SubscribeCandles` 订阅 K 线，并通过 `Bind` 直接获取 DeMarker 的十进制结果，无需手动访问缓存。
- 指标状态通过三个标量变量维护：当前值、上一值以及两根之前的值，完全对应 MQL 源码中的 `iDeMarkerGet(0)` 与 `iDeMarkerGet(2)` 调用。
- 下单数量会按照标的的 `VolumeStep` 自动取整，并检查最小/最大交易量，以避免下单被拒绝。
- 权益控制基于 `Portfolio.CurrentValue`，触发虚拟止损时使用市价单强制平仓。
- 点值依据 `Security.PriceStep` 自动推导。若标的价格精度为 3 或 5 位小数，则会乘以 10，将报价点转换成与 MQL 相同的“pip”。

## 使用建议
- 需要保证投资组合对象能够提供实时权益数据，以便权益追踪逻辑生效。
- 策略只处理状态为 `CandleStates.Finished` 的 K 线，即仅在新 K 线完成后才会评估信号，行为与原 EA 的“新柱触发”一致。
- 0.3 / 0.7 的超买超卖阈值写死在代码常量中，如需调整可以修改常量后重新编译。
- 该策略适用于实盘和回测。回测时请确认投资组合模拟器会回传权益数据，否则权益追踪功能无法正常工作。
