# Стратегия True Sort Trend
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет классический шаблон «True Sort» из MetaTrader: пять экспоненциальных скользящих средних должны выстроиться в строгом порядке. Если и текущая, и предыдущая завершённая свеча подтверждают один и тот же бычий или медвежий стек, а индикатор Average Directional Index (ADX) показывает достаточную силу тренда, стратегия открывает сделку по тренду. Управление рисками реализовано через опциональный стоп-лосс, тейк-профит и трейлинг-стоп, задаваемые в абсолютных ценовых величинах.

## Как это работает

1. Рассчитываются пять EMA (по умолчанию периоды 10, 20, 50, 100 и 200) на выбранном таймфрейме свечей.
2. ADX с настраиваемым периодом (по умолчанию 24) фильтрует сделки, требуя превышения порога силы тренда (по умолчанию 20).
3. Анализ выполняется только на закрытии свечи — сигналы на незавершённых барах игнорируются.
4. Для входа в лонг обе последние завершённые свечи должны удовлетворять условиям:
   - `EMA_fast > EMA_2 > EMA_3 > EMA_4 > EMA_slow` — идеальный бычий порядок средних.
   - `ADX > порог`, подтверждающий импульс.
5. Для шорта условия зеркальные, неравенства меняются на противоположные.
6. Сделка закрывается, когда порядок EMA нарушается, когда достигаются защитные уровни, либо когда трейлинг-стоп фиксирует часть прибыли.

Такой подход позволяет работать только в сильном тренде и уменьшает шум за счёт проверки сразу двух подряд свечей.

## Торговые правила

- **Входы**
  - **Лонг**: ADX выше порога и пять EMA выстроены по убыванию периодов на текущей и предыдущей свечах. При наличии короткой позиции она сначала закрывается, затем открывается новый лонг заданным объёмом `Volume`.
  - **Шорт**: ADX выше порога и EMA отсортированы по возрастанию периодов на двух свечах подряд. Любая длинная позиция закрывается перед открытием шорта.
- **Выходы**
  - Нарушение строгого порядка EMA приводит к немедленному закрытию позиции.
  - Дополнительные защитные условия:
    - Стоп-лосс на фиксированном расстоянии в ценовых единицах от точки входа.
    - Тейк-профит на фиксированном расстоянии от входа.
    - Трейлинг-стоп, который активируется только после движения на `TrailingStopDistance + TrailingStepDistance` и сопровождает цену на расстоянии `TrailingStopDistance`.
  - Ручные закрытия или внешние сделки также сбрасывают внутреннее состояние стратегии.

## Параметры

| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| `CandleType` | Тип свечей, на которых ведутся расчёты. | Таймфрейм 1 час |
| `FastEmaLength` | Период самой быстрой EMA. | 10 |
| `SecondEmaLength` | Период второй EMA. | 20 |
| `ThirdEmaLength` | Период третьей EMA. | 50 |
| `FourthEmaLength` | Период четвёртой EMA. | 100 |
| `SlowEmaLength` | Период самой медленной EMA. | 200 |
| `AdxPeriod` | Период усреднения ADX. | 24 |
| `AdxThreshold` | Минимальное значение ADX для разрешения сделок. | 20 |
| `StopLossDistance` | Расстояние стоп-лосса в абсолютных ценовых единицах (0 — отключено). | 0.005 |
| `TakeProfitDistance` | Расстояние тейк-профита в абсолютных ценовых единицах (0 — отключено). | 0.015 |
| `TrailingStopDistance` | Расстояние трейлинг-стопа от экстремума. | 0.0005 |
| `TrailingStepDistance` | Дополнительный шаг, который цена должна пройти до активации/сдвига трейлинг-стопа. | 0.0001 |

Все расстояния задаются в ценовых единицах. Для валют с четырьмя или пятью знаками после запятой величина `0.005` примерно соответствует 50 пунктам. Подберите значения под шаг цены выбранного инструмента.

## Рекомендации

- Наиболее эффективно на трендовых инструментах: основные валютные пары, индексы, товарные фьючерсы. Для дневных данных увеличьте периоды EMA, для скальпинга уменьшите их.
- Двойное подтверждение свечей уменьшает количество ложных входов, но делает сигналы более запаздывающими — имеет смысл оптимизировать порог ADX и периоды EMA под ваш рынок.
- Трейлинг-стоп без шага (`TrailingStepDistance = 0`) повторяет поведение оригинального советника: активация происходит сразу после прохождения базовой дистанции.
- Ордеры отправляются по рынку (`BuyMarket`, `SellMarket`). Управляйте размером позиции через свойство `Volume` или подключите внешнюю модель мани-менеджмента.
- При необходимости ограничьте торговые часы с помощью дополнительных фильтров или старших таймфреймов.

