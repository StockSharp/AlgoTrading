# True Sort 趋势策略
[English](README.md) | [Русский](README_ru.md)

该策略复刻了 MetaTrader 中著名的 “True Sort” 模板：要求五条指数移动平均线严格排序。当当前和前一根已完成 K 线都呈现相同的多头或空头顺序，同时平均趋向指数（ADX）超过阈值以确认趋势强度时，策略顺势开仓。风控部分提供可选的绝对价差止损、止盈以及只有在价格足够向有利方向移动后才会启动的跟踪止损。

## 工作流程

1. 在所选 K 线级别上计算五条 EMA（默认周期分别为 10、20、50、100、200）。
2. 计算可配置周期的 ADX（默认 24），并要求其超过阈值（默认 20）以过滤弱趋势。
3. 仅在 K 线收盘后分析指标，所有未完成的 K 线信号都会被忽略，避免过早下单。
4. 做多条件（当前和上一根收盘 K 线均需满足）：
   - `EMA_fast > EMA_2 > EMA_3 > EMA_4 > EMA_slow`，即多头排列。
   - `ADX > 阈值`，确认趋势力度。
5. 做空条件与上面完全相反，所有不等号方向互换。
6. 当 EMA 排序被破坏、保护性价差被触及，或跟踪止损回吐既定利润时，仓位将被平掉。

双重排序验证能有效筛除噪声，使策略仅参与方向明确的行情。

## 交易规则

- **入场**
  - **多头**：ADX 高于阈值，且五条 EMA 在当前和前一根已完成 K 线中都呈递减排序。若持有空头头寸，会先行平仓，再按 `Volume` 设置的数量开多。
  - **空头**：ADX 高于阈值，且五条 EMA 在两根连续 K 线上都呈递增排序。若持有多头，会先行平仓后开空。
- **出场**
  - 一旦 EMA 排列被破坏，即刻平仓。
  - 可选风控措施：
    - 在入场价下方（多头）或上方（空头）设置固定距离的止损。
    - 在入场价外侧设置固定距离的止盈。
    - 跟踪止损：只有在价格先运行 `TrailingStopDistance + TrailingStepDistance` 后才激活，随后以 `TrailingStopDistance` 的距离跟随价格。
  - 若出现手动平仓或外部成交，内部状态也会被重置。

## 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `CandleType` | 用于计算的 K 线数据类型。 | 1 小时 |
| `FastEmaLength` | 最快 EMA 的周期。 | 10 |
| `SecondEmaLength` | 第二条 EMA 的周期。 | 20 |
| `ThirdEmaLength` | 第三条 EMA 的周期。 | 50 |
| `FourthEmaLength` | 第四条 EMA 的周期。 | 100 |
| `SlowEmaLength` | 最慢 EMA 的周期。 | 200 |
| `AdxPeriod` | ADX 指标的计算周期。 | 24 |
| `AdxThreshold` | 允许交易的最小 ADX 值。 | 20 |
| `StopLossDistance` | 绝对价格止损距离（0 表示关闭）。 | 0.005 |
| `TakeProfitDistance` | 绝对价格止盈距离（0 表示关闭）。 | 0.015 |
| `TrailingStopDistance` | 跟踪止损距离。 | 0.0005 |
| `TrailingStepDistance` | 跟踪止损激活或移动前所需的额外价差。 | 0.0001 |

所有距离都以价格单位表示。对于 4/5 位小数报价的外汇品种，`0.005` 大约等于 50 个点。请根据交易品种的最小跳动调整这些数值。

## 使用建议

- 适用于外汇、指数、商品等趋势性资产。对于较长周期可适当增加 EMA 周期；用于短线时则可缩短周期。
- 两根 K 线的确认能够显著降低假突破，但也会导致信号略微滞后，可通过优化 EMA 周期和 ADX 阈值来平衡。
- 当 `TrailingStepDistance = 0` 时，跟踪止损会在价格刚好运行 `TrailingStopDistance` 后立即启动，与原始 EA 的行为一致。
- 策略使用市价单（`BuyMarket`、`SellMarket`）执行，仓位规模由 `Volume` 属性控制，可结合资金管理模块进一步扩展。
- 如需限制交易时段，可叠加会话过滤或更高周期的趋势判定。

