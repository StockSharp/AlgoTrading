# Стратегия CH2010 Structure с многотаймфреймовым пробоем

Стратегия переносит логику оригинального **ch2010structure.mq5** в StockSharp. Пять валютных пар одновременно отслеживаются на дневном и 30-минутном таймфреймах. Дневная свеча задаёт направление, а внутридневные свечи ищут пробой границ предыдущего дня и открывают позиции по тренду. Управление рисками выполнено через процентные стоп-лоссы и тейк-профиты, а также через ограничение объёмов, аналогичное MQL-функциям `DebugOrderSend`/`DebugOrderCheck`.

## Алгоритм

1. **Формирование дневной структуры**  
   - Для USDCHF, GBPUSD, AUDUSD, USDJPY и EURGBP подписываемся на дневные свечи.  
   - После закрытия свечи вычисляется направление (бычье, медвежье или нейтральное) и сохраняются High/Low/Close, а также дата сессии.  
   - Флаги сбрасываются, чтобы на следующем дне снова разрешить сигналы.

2. **Внутридневные пробои**  
   - Работают только завершённые 30-минутные свечи текущего дня.  
   - Если закрытие выше дневного High + буфер и дневной тренд не медвежий, отправляется рыночная покупка.  
   - Если закрытие ниже дневного Low - буфер и дневной тренд не бычий, отправляется рыночная продажа.  
   - Для каждого инструмента в день допускается максимум один пробой в каждую сторону.

3. **Контроль риска**  
   - Объём заявки ограничивается параметрами `MinTradeVolume`, `MaxTradeVolume` и общим пределом `MaxAggregateVolume`.  
   - Сразу после появления позиции рассчитываются цены стоп-лосса и тейк-профита как проценты от цены входа.  
   - При достижении стопа/цели позиция закрывается рыночной заявкой; флаг `ExitInProgress` защищает от повторных заявок, пока закрытие не завершено.

4. **Ведение состояния**  
   - Для каждого инструмента создан класс `InstrumentContext`, в котором хранится дневная структура, направление, последняя позиция, параметры выхода и служебные флаги.  
   - Это упрощает многосимвольную работу и повторяет идею отдельных объектов `CExp` в MQL.

## Параметры

| Параметр | Описание |
| --- | --- |
| `TradeVolume` | Базовый объём входа, на который распространяются лимиты. |
| `MinTradeVolume` / `MaxTradeVolume` | Минимальный и максимальный объём одной сделки. |
| `MaxAggregateVolume` | Суммарный лимит по модулю позиций всех инструментов. |
| `StopLossPercent` | Процентное расстояние от цены входа до стоп-лосса. |
| `TakeProfitPercent` | Процентное расстояние до тейк-профита. |
| `BreakoutBufferPercent` | Дополнительный процент от дневного диапазона для формирования уровня пробоя. |
| `DailyCandleType` / `IntradayCandleType` | Типы данных свечей для дневного и внутридневного расчёта. |
| `UsdChfSecurity` … `EurGbpSecurity` | Инструменты, участвующие в стратегии (по умолчанию основные пары из EA). |

## Требования к данным

- Дневные и 30-минутные свечи по каждому выбранному инструменту.  
- Подключение к брокеру/бирже, поддерживающее рыночные заявки по всем инструментам.  
- Портфель и коннектор StockSharp должны быть настроены до запуска.

## Порядок работы

1. Укажите значения параметров `Security` для всех пяти инструментов либо замените их на собственные.  
2. Настройте портфель, коннектор и остальные свойства стратегии.  
3. При необходимости скорректируйте параметры риска и величину буфера.  
4. Запустите стратегию. Она автоматически оформит подписки на свечи и начнёт отслеживать пробои.  
5. Используйте лог (`LogInfo`) для контроля состояния — сообщения `Daily candle captured`, `Enter Buy/Sell`, `Exit` отражают все ключевые шаги.

## Отличия от оригинала

- Вместо отложенных ордеров используются рыночные заявки в момент пробоя, что соответствует высокоуровневому API StockSharp.  
- Ограничения по объёмам и количеству заявок перенесены в настраиваемые параметры.  
- Весь код сопровождается англоязычными комментариями, что облегчает командную работу и аудит.

## Отказ от ответственности

Данный пример предназначен для обучения. Перед применением на реальном счёте обязательно протестируйте стратегию и адаптируйте параметры под свои условия торговли.
