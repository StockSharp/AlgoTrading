# CH2010 结构多周期突破策略

该策略复刻了原始 **ch2010structure.mq5** 专家顾问的核心思想，针对五个外汇货币对同时监控日线与 30 分钟线。日线用于判断当天的方向性倾向，30 分钟线负责在价格突破昨日区间并与方向一致时执行交易，并通过百分比止损与止盈来管理风险。

## 策略流程

1. **日线方向判断**  
   - 订阅 USDCHF、GBPUSD、AUDUSD、USDJPY、EURGBP 的日线数据。  
   - 每当日线收盘，比较收盘价与开盘价确定多头、空头或中性倾向。  
   - 保存日线的高点、低点、收盘价和交易日，以便在 30 分钟逻辑中校验同一交易日。

2. **30 分钟突破执行**  
   - 仅处理收盘后的 30 分钟 K 线。  
   - 若收盘价高于昨日最高价加上可调缓冲且日线倾向不是空头，则触发买入。  
   - 若收盘价低于昨日最低价减去缓冲且日线倾向不是多头，则触发卖出。  
   - 每个品种每天最多触发一次多头和一次空头突破，避免过度交易。

3. **风控与仓位限制**  
   - `TradeVolume` 在 `MinTradeVolume` 与 `MaxTradeVolume` 范围内调整，并通过 `MaxAggregateVolume` 控制所有品种的总持仓量，模拟原始 MQL 中 `DebugOrderSend` 的限制。  
   - 每次成交后立即根据 `StopLossPercent` 与 `TakeProfitPercent` 计算绝对止损、止盈价格。  
   - 当价格达到止损或止盈时，通过市价单立即退出，同时使用 `ExitInProgress` 标志防止重复发送退出委托。

4. **状态管理**  
   - 每个品种都有单独的 `InstrumentContext`，保存日线信息、突破标记、最后已知仓位及订单状态。  
   - 这样无需额外集合即可完成多品种逻辑，对应 MQL 中多个 `CExp` 实例的概念。

## 参数说明

| 参数 | 说明 |
| --- | --- |
| `TradeVolume` | 新建仓位时的基础手数。 |
| `MinTradeVolume` / `MaxTradeVolume` | 单笔仓位的上下限，用于限制交易规模。 |
| `MaxAggregateVolume` | 所有品种绝对持仓量的上限。 |
| `StopLossPercent` | 入场价百分比形式的止损距离。 |
| `TakeProfitPercent` | 入场价百分比形式的止盈距离。 |
| `BreakoutBufferPercent` | 计算突破触发价时，按昨日区间乘以该百分比后的缓冲。 |
| `DailyCandleType` / `IntradayCandleType` | 日线与 30 分钟线的数据订阅类型，可根据需要调整。 |
| `UsdChfSecurity` 等 | 五个默认交易品种，可替换为其他标的。 |

## 数据需求

- 五个交易品种的日线与 30 分钟线数据。  
- 可用于市价单下单的交易连接和投资组合。  
- 运行环境需支持 StockSharp 高级 API。

## 使用步骤

1. 在启动前为五个 `Security` 参数赋值，或替换成自定义品种。  
2. 配置好投资组合、连接器及初始仓位等通用设置。  
3. 如需调整风控或突破灵敏度，可修改对应参数。  
4. 启动策略后，系统会自动订阅双周期数据，等待符合方向的突破信号。  
5. 通过日志查看 `Daily candle captured`、`Enter Buy` 等信息确认执行过程。

## 与原始 MQL EA 的差异

- 将挂单逻辑改为突破出现后直接以市价成交，更契合 StockSharp 的高层 API。  
- 体现在 `DebugOrderSend` 中的批量限额、最小/最大手数被转化为可调参数。  
- 所有注释均为英文，便于调试与团队协作。

## 免责声明

本策略示例仅用于学习研究，真实交易前请根据自身需求重新评估参数、标的与风险管理方案。
