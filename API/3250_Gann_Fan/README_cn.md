# 江恩扇形策略

该策略在 StockSharp 高级 API 上复刻 MetaTrader 平台的 **GANN_FAN** 智能交易程序。策略通过线性加权移动均线判断趋势，结合动量振荡指标和 MACD 方向过滤，并利用分形高低点重建江恩扇形，从而确定做多或做空的倾向。风险管理部分继承了原始程序的阶梯加仓、固定止损/止盈、移动止损以及保本功能。

## 交易逻辑

1. **趋势过滤**：使用典型价 (高+低+收)/3 计算的快慢线性加权移动均线 (LWMA)。当快线位于慢线上方时允许做多，反之允许做空。
2. **动量确认**：计算 `100 * Close / Close(n)` 形式的经典动量，并在最近三个已完成K线中检测其相对 100 的偏离度。只要任一偏离值超过阈值，即认为当前方向具有足够的动能。
3. **MACD 方向**：配置化的 MACD（快 EMA、慢 EMA、信号 EMA）必须与趋势方向一致。做多要求 MACD 主线高于信号线；做空则要求主线低于信号线。
4. **江恩扇形朝向**：借助比尔·威廉姆斯分形重建江恩扇形。最近两个下分形构成看涨射线，其斜率需向上才能允许多头；最近两个上分形构成看跌射线，其斜率需向下才允许空头。
5. **分批加仓**：当满足入场条件时，策略会在不超过设定上限的前提下向原有方向加仓。每次加仓的手数都按乘方系数递增，模拟原始 MQL 程序的马丁式资金管理。

## 风险管理

- **固定止损 / 止盈**：以品种的最小价格变动单位表示，自动转换为实际价差。
- **保本移动**：开启后，当浮动盈利达到触发距离时，将止损移动到入场价附近，并加上设定偏移量。
- **移动止损**：在达到触发距离后启动。可以按照固定距离跟随，也可以读取最近若干根 K 线的最低/最高值并加上缓冲，实现蜡烛式追踪。
- **强制平仓**：将 `Force Exit` 设为 `true` 后，下一根完成的K线会立即平掉所有持仓。

## 参数说明

| 参数 | 说明 |
|------|------|
| **Volume** | 初始下单手数。 |
| **Fast LWMA / Slow LWMA** | 趋势过滤用的快慢线性加权均线周期。 |
| **Momentum Period / Threshold** | 动量计算的回溯周期与偏离阈值。 |
| **MACD Fast / Slow / Signal** | MACD 过滤所使用的 EMA 周期。 |
| **Fractal History** | 保存的有效分形数量，用于重建江恩扇形。 |
| **Max Trades** | 同方向最多允许的加仓次数。 |
| **Lot Exponent** | 每次加仓手数乘上的指数系数。 |
| **Stop Loss / Take Profit** | 以最小跳动表示的止损与止盈距离。 |
| **Enable Trailing** | 是否启用移动止损。 |
| **Trail Trigger / Distance / Padding** | 移动止损的触发距离、固定距离以及蜡烛式追踪的额外缓冲。 |
| **Use Candle Trail** | 是否开启基于蜡烛极值的追踪方式。 |
| **Trailing Candles** | 计算蜡烛式追踪时所使用的最近完成 K 线数量。 |
| **Enable Break-even** | 是否启用保本移动。 |
| **Break-even Trigger / Offset** | 保本触发距离与附加偏移量。 |
| **Use Gann Filter** | 是否必须满足江恩扇形方向过滤。 |
| **Force Exit** | 是否在下一根 K 线强制平仓。 |
| **Candle Type** | 参与计算与信号生成的 K 线类型。 |

## 其他说明

- 所有指标仅在 `SubscribeCandles` 返回的已完成 K 线上计算，完全符合 StockSharp 高级 API 推荐实践。
- 当品种未提供 `PriceStep` 时，止损、止盈、保本和追踪功能会保持等待状态，直至收到有效的最小变动值。
- 策略分别跟踪多头与空头的入场价格、追踪止损及保本价位，每当仓位方向变化时都会自动重置。
- 原始 MQL 程序中的提示音、邮件、绘图对象等外设功能被替换为基于分形的江恩扇形重构，更适合在 StockSharp 环境中运行。
