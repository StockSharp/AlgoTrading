# Стратегия Gann Fan

Стратегия переносит эксперта **GANN_FAN** с платформы MetaTrader на StockSharp и использует высокоуровневый API. Тренд определяется парой линейных взвешенных скользящих средних, подтверждается классическим осциллятором Momentum и фильтруется MACD. Направление открытия сделок дополнительно проверяется по реконструированным линиям гановского веера, которые строятся на основе подтверждённых фракталов. Управление позицией повторяет оригинал: ступенчатое наращивание объёма, фиксированные стопы, трейлинг и перенос в безубыток.

## Логика торговли

1. **Трендовый фильтр** – две LWMA по типичной цене (High+Low+Close)/3. Для покупок быстрая LWMA должна находиться выше медленной, для продаж – ниже.
2. **Подтверждение моментума** – рассчитывается показатель `100 * Close / Close(n)`. Величина отклонения от 100 анализируется на трёх последних закрытых свечах; если хотя бы одно значение превышает порог, импульс считается достаточным.
3. **Фильтр MACD** – настраиваемый MACD (fast/slow/signal) должен поддерживать текущую тенденцию. Для входа в лонг требуется `MACD > Signal`, для шорта – `MACD < Signal`.
4. **Ориентация веера Gann** – последние подтверждённые фракталы формируют восходящую и нисходящую линии веера. Для лонга наклон линии, построенной по двум последним down-фракталам, должен быть положительным; для шорта наклон линии по up-фракталам должен быть отрицательным.
5. **Наращивание позиции** – при повторном сигнале стратегия добавляет объём в сторону текущей позиции, пока не достигнут лимит сделок. Каждый новый вход умножает базовый объём на показатель Lot Exponent, что имитирует мартингейл оригинального советника.

## Управление риском

- **Стоп-лосс и тейк-профит** – задаются в шагах цены инструмента; стратегия автоматически переводит их в реальные значения, используя `Security.PriceStep`.
- **Перенос в безубыток** – после достижения заданной прибыли стоп переносится к цене входа с указанным отступом.
- **Трейлинг-стоп** – активируется после срабатывания порога. Может использовать фиксированную дистанцию от закрытия или минимум/максимум последних свечей с дополнительной подушкой.
- **Принудительное закрытие** – параметр `Force Exit` закрывает любые позиции на следующей завершённой свече.

## Параметры

| Параметр | Описание |
|----------|----------|
| **Volume** | Базовый объём первой сделки. |
| **Fast LWMA / Slow LWMA** | Периоды быстрых и медленных LWMA для фильтра тренда. |
| **Momentum Period / Threshold** | Длина расчёта Momentum и минимальное отклонение от 100. |
| **MACD Fast / Slow / Signal** | Периоды EMA в фильтре MACD. |
| **Fractal History** | Количество хранимых подтверждённых фракталов для построения веера. |
| **Max Trades** | Максимальное число добавлений в одну сторону. |
| **Lot Exponent** | Множитель, увеличивающий объём каждой последующей сделки. |
| **Stop Loss / Take Profit** | Дистанции защитных стопов в шагах цены. |
| **Enable Trailing** | Включение трейлинг-стопа. |
| **Trail Trigger / Distance / Padding** | Порог активации, расстояние трейлинга и дополнительная подушка (в шагах цены). |
| **Use Candle Trail** | Использовать ли экстремумы свечей для трейлинга. |
| **Trailing Candles** | Количество последних свечей для расчёта свечного трейлинга. |
| **Enable Break-even** | Активирует перенос стопа в безубыток. |
| **Break-even Trigger / Offset** | Порог прибыли и сдвиг стопа при переносе. |
| **Use Gann Filter** | Требовать подтверждения направлением веера. |
| **Force Exit** | Принудительно закрыть позицию на следующем баре. |
| **Candle Type** | Тип свечей, по которым ведутся расчёты и генерируются сигналы. |

## Особенности реализации

- Все расчёты выполняются только на закрытых свечах, полученных через `SubscribeCandles`, что соответствует рекомендациям по использованию высокоуровневого API StockSharp.
- Если коннектор не предоставляет `PriceStep`, защитные механизмы (стопы, трейлинг, безубыток) остаются неактивными до появления корректного значения шага цены.
- Для лонгов и шортов ведутся отдельные состояния: цена входа, уровни трейлинга и безубытка автоматически сбрасываются при смене направления позиции.
- Графические объекты и оповещения из оригинального MQL-советника заменены логикой фрактального построения веера внутри StockSharp, что делает стратегию полностью автономной.
