# Стратегия MacdPatternTrader

## Обзор
Стратегия **MacdPatternTrader** представляет собой конвертацию советника `MacdPatternTraderAll0.01` из MQL5 на высокоуровневый API StockSharp. Она подписывается на выбранную серию свечей и на каждой завершённой свече анализирует шесть независимых моделей входа на основе MACD. У каждой модели собственные параметры EMA, окна поиска стопов и уровни порогов, поэтому сигналы не конфликтуют между собой. При срабатывании любой модели отправляется рыночная заявка объёмом, рассчитанным модулем мартингейла, и сразу вычисляются защитные уровни.

Конвертация сохраняет ключевые особенности оригинального советника:

* Общий блок управления капиталом по мартингейлу удваивает рабочий объём после убыточного цикла и возвращает его к исходному значению после прибыльного закрытия.
* Стоп-лосс определяется по экстремумам последних `StopLossBars` свечей с добавлением смещения в пунктах, что полностью повторяет использование `iHighest`/`iLowest` в MQL.
* Тейк-профит расширяется сегментами по `TakeProfitBars` свечей и сдвигается дальше только если очередной сегмент обновляет экстремум в нужную сторону.
* Частичные фиксации закрывают сначала треть позиции, затем половину остатка, когда плавающая прибыль превышает пять денежных единиц и фильтры EMA/SMA подтверждают направление. Минимальный объём сокращения — 0.01.
* Дополнительный фильтр по времени ограничивает открытия окнами `(StartTime, StopTime)`, однако контроль стопов продолжается круглосуточно.

## Данные и индикаторы
* **Тип данных** — конфигурируемая серия свечей (`CandleType`). По умолчанию соответствует часовому таймфрейму H1 из оригинала.
* **Индикаторы** — шесть экземпляров `MovingAverageConvergenceDivergenceSignal` и четыре скользящие средние (EMA, EMA, SMA, EMA), используемые в блоке частичного выхода. Все индикаторы привязываются через `BindEx`, поэтому обработчик получает синхронизированные значения.
* **Исторические буферы** — компактный скользящий список свечей используется для расчёта стопов/тейков; значения MACD кэшируются, чтобы воспроизвести стадийную логику советника.

## Логика входа
Каждая модель работает автономно, поэтому даже при открытой позиции могут формироваться дополнительные сигналы — стратегия выступает агрегатором сигналов.

1. **Модель 1 – Пороговый разворот**: ищет пробой уровня `Pattern1MaxThreshold` с последующим разворотом вниз при положительном MACD для шорта и зеркальный сценарий для лонга ниже `Pattern1MinThreshold`.
2. **Модель 2 – Отбой от нулевой линии**: отслеживает фазы выше нуля и при обратном пересечении вниз формирует заготовку шорта; после отрицательной фазы ждёт восстановления выше нуля и растущего MACD для лонга.
3. **Модель 3 – Многоступенчатые вершины/впадины**: полностью воспроизводит систему счётчиков (`S3`, `stops3`, `stops13` и др.) для фиксации сложных вершин и впадин. После каждой сделки обнуляет `bars_bup`.
4. **Модель 4 – Локальные экстремумы**: определяет локальные пики и впадины MACD, когда текущая свеча возвращается внутрь диапазона, а предыдущая была экстремумом относительно двух свечей назад.
5. **Модель 5 – Прорыв нейтральной зоны**: формирует центральный диапазон нейтральными порогами и открывает сделки при немедленном выходе за пределы этого диапазона и пробое целевого уровня.
6. **Модель 6 – Подсчёт последовательных баров**: считает подряд идущие значения MACD выше/ниже порогов и разрешает сделки только когда счётчик находится между `Pattern6TriggerBars` и допустимыми пределами.

## Выход и управление рисками
* **Стоп-лосс** — для лонгов используется минимум за `StopLossBars` свечей плюс смещение, для шортов — максимум. Алгоритм поочерёдно проверяет сегменты, пока не найдёт подходящий экстремум.
* **Тейк-профит** — просматривает последовательные блоки по `TakeProfitBars` свечей и расширяет цель, если новый блок приносит более выгодную цену.
* **Частичное закрытие** — при достижении плавающей прибыли в 5 единиц закрывается треть позиции, затем половина остатка. Используются фильтры EMA/SMA и минимальный объём 0.01.
* **Мартингейл** — `InitialVolume` задаёт базовый объём. При включённом `UseMartingale` убыточный цикл удваивает `_currentVolume`, прибыльный — сбрасывает. Счётчики `_longPartialCount` и `_shortPartialCount` следят за количеством частичных выходов.
* **Временное окно** — при активном `UseTimeFilter` новые входы оцениваются только если время закрытия свечи строго между `StartTime` и `StopTime`, но стопы пересчитываются всегда.

## Параметры
| Группа | Имя | Описание |
| --- | --- | --- |
| Модель 1 | `Pattern1Enabled` | Включение модели 1. |
| Модель 1 | `Pattern1StopLossBars`, `Pattern1TakeProfitBars`, `Pattern1Offset` | Окна поиска стопов/тейков и смещение. |
| Модель 1 | `Pattern1Slow`, `Pattern1Fast` | Периоды медленной и быстрой EMA для MACD. |
| Модель 1 | `Pattern1MaxThreshold`, `Pattern1MinThreshold` | Верхний и нижний пороги MACD. |
| Модель 2 | Аналогичный набор параметров с собственными значениями. |
| Модель 3 | Дополнительные уровни `Pattern3MaxLowThreshold`, `Pattern3MinHighThreshold` для многоступенчатого алгоритма. |
| Модель 4 | Сохраняет `Pattern4AdditionalBars` (для совместимости) и задаёт дополнительные пороги. |
| Модель 5 | Использует `Pattern5MaxNeutralThreshold`, `Pattern5MinNeutralThreshold` для описания нейтральной полосы. |
| Модель 6 | Параметры `Pattern6MaxBars`, `Pattern6MinBars`, `Pattern6TriggerBars` управляют счётчиком последовательных баров. |
| Управление | `EmaPeriod1`, `EmaPeriod2`, `SmaPeriod3`, `EmaPeriod4` | Скользящие средние для блока частичного выхода. |
| Общие | `InitialVolume`, `UseTimeFilter`, `StartTime`, `StopTime`, `UseMartingale`, `CandleType` | Общие настройки и выбор данных. |

## Особенности реализации
* Используются только высокоуровневые вызовы StockSharp (`SubscribeCandles`, `BindEx`, `BuyMarket`, `SellMarket`), доступ к буферам индикаторов напрямую не требуется.
* Защитные уровни выставляются через `SetStopLoss`/`SetTakeProfit` и пересчитываются на каждой завершённой свече, что повторяет оригинал.
* Размер скользящих коллекций ограничен 1000 элементами, чтобы не накапливать бесконечную историю и одновременно сохранить идентичную логику.
* Метод `OnOwnTradeReceived` отслеживает объёмы и реализованную прибыль для оперативных решений по мартингейлу.
* В код добавлены поясняющие комментарии на английском языке для удобства сопровождения.

## Рекомендации по использованию
1. Применяйте стратегию на ликвидных инструментах с непрерывной торговлей (FX, CFD, криптовалюты).
2. Убедитесь, что таймфрейм свечей совпадает с исходным (по умолчанию H1).
3. При оптимизации под новые рынки корректируйте пороги моделей или отключайте ненужные блоки.
4. Помните, что мартингейл способен быстро нарастить позицию в серии убытков, поэтому рассчитывайте риски заранее.
