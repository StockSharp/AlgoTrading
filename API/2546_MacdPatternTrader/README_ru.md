# Стратегия MacdPatternTrader

## Описание
MacdPatternTrader — это перенос советника *MacdPatternTraderAll* с MQL на высокоуровневый API StockSharp. Стратегия обрабатывает только закрытые свечи и параллельно оценивает шесть независимых наборов правил на основе MACD. Каждый набор использует собственные периоды EMA и набор порогов, чтобы определить разворотные или трендовые конфигурации на основной линии MACD. Сигналы могут приходить одновременно, объём рыночной заявки определяется текущим коэффициентом мартингейла.

Стратегия реализует полный набор функций управления рисками: стоп-лосс рассчитывается по экстремумам последних свечей с учётом отступа, тейк-профит ищется по блокам истории так же, как это делал оригинальный код `iLowest`/`iHighest`. Открытые позиции сопровождаются частичными закрытиями, основанными на EMA/SMA фильтре и пороге нереализованной прибыли. После полного закрытия позиции объём либо сбрасывается к `InitialVolume`, либо удваивается (если включён `UseMartingale`) в случае отрицательного результата.

## Правила торговли
1. **Паттерн 1 – Реверс по порогу**: фиксирует рост MACD выше верхнего порога и последующее снижение, аналогично работает для нижнего порога.
2. **Паттерн 2 – Отбой от нуля**: требует пребывания в положительной зоне MACD, после чего отслеживает пробой уровня 0. Симметричное поведение используется для покупок.
3. **Паттерн 3 – Многоступенчатая последовательность**: воспроизводит оригинальную цепочку условий с несколькими флагами и порогами, сбрасывая счётчик `bars_bup` после сделок.
4. **Паттерн 4 – Локальные максимумы/минимумы**: ищет локальные экстремумы MACD относительно двух предыдущих значений.
5. **Паттерн 5 – Пробой нейтральной зоны**: продаёт после ухода ниже нейтральной полосы, покупает после закрепления выше верхнего уровня.
6. **Паттерн 6 – Счётчик подряд идущих баров**: учитывает число баров над/под порогами и реагирует, когда счётчик превышает `TriggerBars`, но не достигает `MaxBars`.

## Управление риском
- **Стоп-лосс**: максимумы/минимумы последних `StopLossBars` свечей плюс отступ, выраженный в шагах цены.
- **Тейк-профит**: последовательный поиск более глубоких экстремумов блоками по `TakeProfitBars` свечей.
- **Частичное закрытие**: при прибыли более 5 денежных единиц (аппроксимация через разницу цены × объём) и выполненных условиях EMA/SMA стратегия снимает треть позиции, затем половину остатка.
- **Мартингейл**: после закрытия позиции объём возвращается к `InitialVolume` при прибыли, либо удваивается при убытке (если активирован `UseMartingale`).
- **Торговое окно**: при включенном `UseTimeFilter` новые входы рассматриваются только между `StartTime` и `StopTime`. Контроль стопов выполняется всегда.

## Параметры
- Для каждого паттерна: флаг включения, количество баров для поиска стопа/тейка, величина отступа, периоды EMA, пороговые значения.
- Паттерн 3 имеет дополнительные пороги `Pattern3MaxLowThreshold` и `Pattern3MinHighThreshold`.
- Паттерн 4 сохраняет параметр `Pattern4AdditionalBars` ради совместимости.
- Паттерн 6 использует `Pattern6MaxBars`, `Pattern6MinBars`, `Pattern6TriggerBars` для контроля счётчика.
- `EmaPeriod1`, `EmaPeriod2`, `SmaPeriod3`, `EmaPeriod4` — параметры частичного выхода.
- Общие параметры: `InitialVolume`, `UseTimeFilter`, `StartTime`, `StopTime`, `UseMartingale`, `CandleType`.

## Примечания
- Реализация следует оригинальной логике, включая поиск тейк-профита блоками и схему мартингейла.
- В StockSharp нет прямого доступа к прибыли позиции, поэтому для частичных выходов используется оценка по разнице цены и объёму.
- `Pattern4AdditionalBars` оставлен без изменений, несмотря на отсутствие использования в исходном коде.
- Стопы и тейки реализованы как рыночные заявки при достижении условий, поскольку высокоуровневый API не создаёт защитные ордера автоматически.
