# Стратегия PivotEMA3RLHv4

## Обзор

PivotEMA3RLHv4 — трендовая стратегия, сочетающая дневной пивот-уровень с краткосрочными индикаторами импульса. Используются экспоненциальные скользящие средние (EMA) с периодом 3, рассчитанные по ценам открытия и закрытия, свечи Heiken Ashi для подтверждения направления и несколько ATR для проверки роста волатильности. Сделки совершаются только после закрытия рабочей свечи выбранного таймфрейма.

## Логика входа

1. **Фильтр по пивоту** — EMA(3) по ценам открытия на предыдущей свече должна находиться ниже (для покупок) или выше (для продаж) дневного пивота, а текущая EMA(3) должна пересечь уровень в сторону сделки.
2. **Подтверждение Heiken Ashi** — текущая свеча Heiken Ashi должна быть бычьей для покупок и медвежьей для продаж.
3. **Импульс** — EMA(3) по ценам закрытия должна находиться выше EMA по открытиям при лонге и ниже при шорте.
4. **Рост волатильности** — минимум одно значение среди ATR(4), ATR(8), ATR(12) и ATR(24) должно увеличиться относительно предыдущей свечи, а истинный диапазон (ATR длины 1) обязан вырасти на текущей или предыдущей свече.
5. **Управление позицией** — одновременно открыта только одна позиция. Стоп-лосс и тейк-профит рассчитываются внутри стратегии и исполняются рыночными ордерами при достижении цены.

Выход выполняется при появлении обратных условий либо по защитным механизмам — стоп-лоссу, тейк-профиту или выбранному трейлингу.

## Параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Таймфрейм рабочих свечей. |
| `StopLossPips` | Начальная дистанция стоп-лосса в пунктах. Ноль — отключение. |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. Ноль — отключение. |
| `UseTrailingStop` | Включение/выключение трейлинг-стопа. |
| `TrailingStopType` | Режим трейлинга: 1 — фиксированная дистанция, 2 — активируется после прохода `TrailingStopPips`, 3 — многоуровневая схема. |
| `TrailingStopPips` | Дистанция трейлинга для режима 2. |
| `FirstMovePips` / `FirstStopLossPips` | Триггер и итоговое смещение стопа для первой ступени режима 3. |
| `SecondMovePips` / `SecondStopLossPips` | Триггер и смещение стопа для второй ступени режима 3. |
| `ThirdMovePips` / `TrailingStop3Pips` | Триггер третьей ступени и последующая трейлинг-дистанция. |

## Режимы трейлинга

- **Тип 1** — поддерживает фиксированный отступ стопа от цены, не позволяя прибыли откатиться больше исходного риска.
- **Тип 2** — ждет проход `TrailingStopPips` и затем удерживает стоп на той же дистанции.
- **Тип 3** — три ступени: две фиксированные фиксации прибыли и заключительный динамический трейлинг.

## Дополнительно

- Для расчета пивота стратегия подписывается на дневные свечи и использует максимум, минимум и закрытие предыдущего дня.
- Все индикаторы обновляются только на закрытых барах, что обеспечивает одинаковую работу в реальном времени и в тестере.
- В оригинальной версии MetaTrader применялись серверные стоп-приказы; порт реализует их программно и закрывает позиции рыночными ордерами.
