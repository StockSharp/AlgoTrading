# Стратегия KDJ Expert Advisor

## Обзор
Стратегия полностью повторяет MetaTrader 5 эксперт "KDJ Expert Advisor" от senlin ge. Используется осциллятор KDJ — модифицированный стохастик с двойным сглаживанием линии %K. Алгоритм отслеживает разницу между линиями %K и %D (в оригинале — буфер KDC/J) и открывает только одну позицию, когда обнаруживает разворот импульса. Каждая сделка сразу получает фиксированные уровни стоп-лосса и тейк-профита, задаваемые в пунктах и автоматически переводимые в абсолютное расстояние по цене.

Реализация построена на высокоуровневом API StockSharp: подключение свечной подписки, использование встроенного индикатора `Stochastic` с параметрами, идентичными MQL5-версии, и автоматический подбор pip-значения для инструментов с 3 или 5 знаками после запятой.

## Логика индикатора
Расчёт KDJ состоит из трёх шагов:

1. **RSV** — вычисление Raw Stochastic Value за `KDJ Length` последних свечей.
2. **%K** — усреднение последних `Smooth %K` значений RSV.
3. **%D** — усреднение последних `Smooth %D` значений %K.

Далее стратегия анализирует величину `K - D` и изменение наклона %K, чтобы определить моменты разворота.

## Правила входа
Новые сделки открываются только при отсутствии текущей позиции. Сигналы проверяются на закрывшихся свечах:

- **Покупка**, если выполняется одно из условий:
  - `K - D` пересекает нулевой уровень снизу вверх;
  - `K - D` уже положительное, а %K растёт (`K_current > K_previous`).
- **Продажа**, если выполняется одно из условий:
  - `K - D` пересекает ноль сверху вниз;
  - `K - D` уже отрицательное, а %K падает (`K_current < K_previous`).

Такой набор логических условий соответствует оригинальному MQL5 коду, обеспечивая совпадение точек входа.

## Управление риском
- Для каждой сделки выставляются защитный стоп и тейк, расстояние задаётся в пунктах. Значение 0 отключает соответствующий уровень.
- Стратегия не усредняется и не наращивает позицию: после входа она ждёт, пока защитные ордера или ручное вмешательство закроют позицию.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|------------------------|
| **Candle Type** | Тип/таймфрейм свечей для расчётов. | Свечи 15 минут |
| **KDJ Length** | Длина окна для RSV. | 30 |
| **Smooth %K** | Количество RSV для сглаживания %K. | 3 |
| **Smooth %D** | Количество %K для сглаживания %D. | 6 |
| **Stop Loss (pips)** | Стоп-лосс в пунктах. 0 — отключено. | 25 |
| **Take Profit (pips)** | Тейк-профит в пунктах. 0 — отключено. | 45 |
| **Order Volume** | Объём рыночной заявки. | 1 |

Каждый параметр имеет диапазоны оптимизации, повторяющие настройки оригинального советника.

## Рекомендации по использованию
1. Настройте соединение и выберите инструмент в тестере или в рабочем подключении.
2. Установите `Candle Type` в соответствии с таймфреймом, который использовался в MetaTrader.
3. При необходимости запустите оптимизацию параметров KDJ, стоп-лосса, тейк-профита или объёма.
4. Запустите стратегию — сигналы рассчитываются только на завершённых свечах.
5. На графике автоматически отображаются свечи, индикатор KDJ и совершённые сделки для визуального контроля.

## Отличия от оригинального EA
- Используется встроенный индикатор `Stochastic`, поэтому не требуется отдельный файл индикатора.
- Управление стоп-лоссом и тейк-профитом реализовано через `StartProtection`, который отправляет рыночные ордера при срабатывании уровней.
- Объём сделок задаётся фиксированным параметром вместо алгоритма `MoneyFixedMargin`, что упрощает пример и концентрируется на торговой логике.
