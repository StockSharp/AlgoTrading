# Стратегия Trend Scalper (API/3858)

## Обзор
**TrendScalperStrategy** — порт экспертного советника MetaTrader 4 `Currencyprofits_01_1.mq4` на платформу StockSharp. Исходный робот представляет собой трендового скальпера: он проверяет пересечение быстрой EMA и медленной SMA, а затем ищет ложные проколы недавних экстремумов, чтобы войти в сделку. Переписанная версия сохраняет ту же логику, используя свечные подписки и индикаторы высокого уровня StockSharp.

## Логика торговли
1. **Индикаторы**
   - Быстрая EMA (по умолчанию 6) по ценам закрытия.
   - Медленная SMA (по умолчанию 12) по ценам закрытия.
   - Максимум и минимум за последние N свечей (по умолчанию 6) по High/Low.
2. **Условия входа**
   - **Покупка**: цена касается нижней границы (`Lowest Low`), при этом быстрая EMA выше медленной SMA. Отправляется рыночная заявка Buy с объёмом согласно выбранному режиму мани-менеджмента.
   - **Продажа**: цена касается верхней границы (`Highest High`), а быстрая EMA ниже медленной SMA. Размещается рыночная заявка Sell.
   - Пока позиция открыта, новых сделок не открываем — как и в оригинальном советнике, одновременно присутствует только один ордер.
3. **Условия выхода**
   - **Закрытие Long**: при пробое свечой верхней границы `Highest High` текущая длинная позиция закрывается по рынку.
   - **Закрытие Short**: при падении ниже `Lowest Low` короткая позиция закрывается по рынку.
   - При `StopLossPoints > 0` дополнительно активируется `StartProtection`, который привязывает защитный стоп-лосс к каждой сделке.

## Управление капиталом
Реализованы три режима из оригинального MQL-советника:

| Режим | Описание | Поведение в порте |
|-------|----------|-------------------|
| `0`   | Фиксированный объём (`LotsIfNoMM`). | Используется значение параметра `FixedVolume`. |
| `<0`  | Дробные лоты по балансу и фактору риска. | Вычисляется `ceil(balance * risk / 10000) / 10`, ограничение сверху — 100 лотов. |
| `>0`  | Целые лоты по балансу и фактору риска. | Та же формула, но результат округляется вверх до целого, минимум — 1 лот, максимум — 100. |

Баланс берётся из `Portfolio.CurrentValue` (с запасным вариантом `BeginValue`). Если значение недоступно, стратегия возвращается к фиксированному объёму, чтобы сохранить совместимость в тестах.

## Управление рисками
- **Стоп-лосс**: параметр `StopLossPoints` задаётся в пунктах. В `OnStarted` расстояние умножается на `Security.PriceStep` и передаётся в `StartProtection`, после чего платформа автоматически сопровождает защитные заявки.
- **Единственная позиция**: новая сделка отправляется только при `Position == 0`, что полностью повторяет поведение MQL-версии.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|------------------------|----------|
| `CandleType` | Таймфрейм 15 минут | Свечи, по которым считаются индикаторы и формируются сигналы. |
| `FastLength` | 6 | Период быстрой EMA. |
| `SlowLength` | 12 | Период медленной SMA. |
| `BreakoutWindow` | 6 | Количество свечей для расчёта ближайших максимумов/минимумов. |
| `FixedVolume` | 0.1 лота | Объём сделки при отключённом мани-менеджменте либо при отсутствии данных по балансу. |
| `MoneyManagementMode` | 0 | Режим расчёта объёма (фиксированный, дробный, округление до целых). |
| `MoneyManagementRisk` | 40 | Фактор риска для расчёта объёма по балансу. |
| `StopLossPoints` | 50 | Дистанция стоп-лосса в пунктах (конвертируется в абсолютную цену перед запуском `StartProtection`). |

## Особенности реализации
- Используется цепочка `SubscribeCandles().Bind(...)`, поэтому нет необходимости самостоятельно хранить историю цен.
- Все комментарии в коде написаны на английском языке в соответствии с требованиями репозитория.
- Тесты и другие файлы проекта не изменялись — задача ограничена переносом стратегии и подготовкой документации.

## Рекомендации по использованию
- Подбирайте таймфрейм в соответствии с изначальной идеей робота (короткие внутридневные интервалы для скальпинга).
- Убедитесь, что у инструмента задан корректный `PriceStep`, иначе перевод стоп-лосса из пунктов в цену будет неверным.
- Аккуратно меняйте `MoneyManagementRisk`: увеличение значения быстро наращивает объём сделки из-за формулы `ceil(balance * risk / 10000)`.
