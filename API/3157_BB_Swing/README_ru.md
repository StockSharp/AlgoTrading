# Стратегия BB Swing

## Обзор

**BB Swing** — это перенос советника MetaTrader «BB SWING» на платформу StockSharp. Алгоритм торгует откаты от границ полос Боллинджера, согласованные с направлением тренда по двум линейно-взвешенным скользящим средним (LWMA). Дополнительные фильтры — моментум старшего таймфрейма и очень медленный MACD — подтверждают силу разворота перед входом в позицию.

## Логика торговли

1. Анализируются только завершённые свечи таймфрейма `CandleType`.
2. Хранится история четырёх последних свечей для оценки экстремумов и размеров тел.
3. Быстрая LWMA должна находиться выше (для покупок) или ниже (для продаж) медленной LWMA.
4. Для лонга хотя бы один из последних трёх минимумов обязан коснуться нижней полосы Боллинджера; для шорта — один из максимумов должен коснуться верхней полосы.
5. Предыдущая свеча должна иметь тело больше, чем у ещё более ранней свечи, что указывает на импульс от границы полосы.
6. На таймфрейме `MomentumCandleType` вычисляется моментум. Используется абсолютное отклонение показаний от уровня 100; если любой из трёх последних значений превышает порог `MomentumBuyThreshold`/`MomentumSellThreshold`, фильтр допускает сделку.
7. На таймфрейме `MacdCandleType` рассчитывается MACD. Покупки разрешены, когда основная линия выше сигнальной, продажи — когда основная линия ниже сигнальной.
8. При выполнении всех условий открывается рыночная позиция с объёмом текущего шага мартингейла.

## Объём позиции и усреднение

- `InitialVolume` задаёт объём первой сделки.
- Каждое последующее добавление умножает базовый объём на `LotExponent` (`InitialVolume * LotExponent^n`).
- `MaxTrades` ограничивает количество последовательных доливок, поэтому совокупный объём не превышает `InitialVolume * MaxTrades`.

## Выходы и защита капитала

- Фиксированные значения `StopLoss` и `TakeProfit` в шагах цены.
- `EnableBreakEven` переносит стоп в безубыток (`BreakEvenOffset`) после прохождения `BreakEvenTrigger` шагов.
- `EnableTrailingStop` включает классический трейлинг-стоп с параметром `TrailingStop`.
- Модуль управления капиталом:
  - `UseMoneyTakeProfit` закрывает позицию при достижении прибыли `MoneyTakeProfit` в валюте счёта.
  - `UsePercentTakeProfit` закрывает позицию при прибыли `PercentTakeProfit` процентов от начального эквити.
  - `UseMoneyTrailing` активирует денежный трейлинг: после достижения `MoneyTrailTarget` допускается откат на `MoneyTrailStop`.
- `UseEquityStop` отслеживает просадку относительно максимального эквити и закрывает сделки при превышении `EquityRiskPercent`.
- `CloseOnMacdCross` при необходимости закрывает позицию при пересечении линий MACD против текущего направления.

Все защитные действия выполняются рыночными ордерами `BuyMarket` / `SellMarket`, полностью закрывающими позицию.

## Параметры

| Имя | Описание |
|-----|----------|
| `InitialVolume` | Базовый объём первой сделки. |
| `LotExponent` | Множитель объёма для каждой последующей доливки. |
| `MaxTrades` | Максимальное число последовательных доливок. |
| `TakeProfit` | Значение тейк-профита в шагах цены. |
| `StopLoss` | Значение стоп-лосса в шагах цены. |
| `FastMaPeriod` | Период быстрой LWMA по типичной цене. |
| `SlowMaPeriod` | Период медленной LWMA по типичной цене. |
| `MomentumLength` | Количество баров в расчёте моментума. |
| `MomentumBuyThreshold` | Минимальное отклонение моментума от 100 для допуска покупок. |
| `MomentumSellThreshold` | Минимальное отклонение моментума от 100 для допуска продаж. |
| `EnableBreakEven` | Включение перевода стопа в безубыток. |
| `BreakEvenTrigger` | Требуемое смещение цены для активации безубытка. |
| `BreakEvenOffset` | Отступ стопа после перевода в безубыток. |
| `EnableTrailingStop` | Включение трейлинг-стопа. |
| `TrailingStop` | Длина трейлинг-стопа в шагах цены. |
| `UseMoneyTakeProfit` | Включение денежного тейк-профита. |
| `MoneyTakeProfit` | Порог прибыли в валюте счёта. |
| `UsePercentTakeProfit` | Включение тейк-профита по проценту от капитала. |
| `PercentTakeProfit` | Процент начального эквити для фиксации прибыли. |
| `UseMoneyTrailing` | Включение денежного трейлинг-стопа. |
| `MoneyTrailTarget` | Прибыль, активирующая денежный трейлинг. |
| `MoneyTrailStop` | Допустимый откат прибыли после активации. |
| `UseEquityStop` | Включение защиты по просадке эквити. |
| `EquityRiskPercent` | Допустимая просадка эквити в процентах. |
| `CloseOnMacdCross` | Принудительное закрытие по пересечению MACD. |
| `CandleType` | Таймфрейм для расчёта сигналов. |
| `MomentumCandleType` | Старший таймфрейм для моментума. |
| `MacdCandleType` | Таймфрейм для медленного MACD. |

## Примечания

- Стратегия обрабатывает только закрытые свечи, сигналы внутри бара не рассматриваются.
- Все расчёты в шагах цены используют значение `PriceStep`; убедитесь в корректности настроек инструмента.
- Функции денежного и эквити-контроля опираются на статистику портфеля StockSharp. В тестере необходимо активировать поток данных по портфелю.
- В отличие от MQL-версии, данная реализация работает с агрегированной позицией: добавления увеличивают общий объём, а не создают отдельные ордера.
- Полосы Боллинджера используют фиксированные параметры: период 20 и ширина 2 стандартных отклонения на типичной цене, как и в оригинальном коде.
