# VR BUCH 移动平均策略

## 概述
**VR BUCH 移动平均策略** 是 MetaTrader 专家顾问 *VR---BUCH* 的直接移植版本。策略使用两条可配置的移动平均线和蜡烛价格过滤器来跟踪趋势反转。StockSharp 实现完全复刻原始信号流程：当出现反向条件时先平掉现有仓位，只有在净仓位归零后才考虑新的进场。

实现基于 StockSharp 的高级蜡烛订阅、原生移动平均指标以及实时下单助手。所有指标值都在蜡烛收盘后处理，为了模拟 MetaTrader 的 `ma_shift` 参数，仅使用一个用于移位的环形缓冲区，不会手动堆积历史数据。

## 交易逻辑
1. **指标计算**
   - 根据选定的蜡烛类型分别计算快线和慢线移动平均。
   - 每条移动平均都可以独立选择价格来源和算法（简单、指数、平滑、加权）。
   - 水平移位选项通过回溯指定数量的历史值来重现 MetaTrader 的 `ma_shift` 行为。
2. **信号判定**
   - 当移位后的快线高于慢线，且确认价格高于快线时产生做多信号。
   - 当移位后的快线低于慢线，且确认价格低于快线时产生做空信号。
3. **仓位管理**
   - 如果已有仓位，反向信号会先触发平仓。仅当仓位归零后，后续信号才会触发新的建仓订单。
   - 当没有仓位时，按照信号方向以配置的数量下市场单。

默认不带止损或止盈。需要风险控制时，可配合 StockSharp 的 `StartProtection` 或外部风控模块。

## 参数说明
| 参数 | 说明 |
| --- | --- |
| **Fast Period** | 快速移动平均的周期长度。 |
| **Fast Shift** | 快速移动平均向过去回溯的蜡烛数量。 |
| **Fast Price** | 快速移动平均所使用的蜡烛价格（收盘、开盘、最高、最低、中价、典型价、加权价）。 |
| **Fast Method** | 快速移动平均的算法（简单、指数、平滑、加权）。 |
| **Slow Period** | 慢速移动平均的周期长度。 |
| **Slow Shift** | 慢速移动平均向过去回溯的蜡烛数量。 |
| **Slow Price** | 慢速移动平均所使用的蜡烛价格。 |
| **Slow Method** | 慢速移动平均的算法。 |
| **Signal Price** | 用于确认信号的蜡烛价格（默认收盘价）。 |
| **Candle Type** | 计算所用的时间周期或自定义蜡烛类型。 |
| **Volume** | 新建仓时下单的数量。 |

## 使用注意事项
- 仅在蜡烛收盘时评估信号，避免盘中噪音。
- 需要保证连接器能够提供足够历史数据，以便移动平均及其移位缓冲区完成初始化。
- 加权价格的计算公式为 \((High + Low + 2 * Close) / 4\)，与 MetaTrader 的 `PRICE_WEIGHTED` 完全一致。
- 类名、命名空间遵循 StockSharp 项目约定，可直接在 `AlgoTrading` 解决方案中编译运行。

## 运行步骤
1. 将策略加载到 StockSharp 的策略容器或示例运行器中。
2. 设置目标交易品种、时间周期（`Candle Type`）和下单数量。
3. 如需与原始 MetaTrader 模板保持一致，可调整移动平均相关参数。
4. 启动策略。系统会自动订阅蜡烛数据、在图表上绘制指标（如果可用），并依据上述逻辑下达市场单。

若要在多品种或投资组合中使用，请为每个交易标的创建独立的策略实例。
