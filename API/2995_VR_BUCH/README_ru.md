# Стратегия VR BUCH на скользящих средних

## Общее описание
**Стратегия VR BUCH** — перенос эксперт-советника MetaTrader *VR---BUCH* в экосистему StockSharp. Алгоритм торгует развороты тренда, используя две настраиваемые скользящие средние и фильтрацию по цене свечи. Поведение сигналов повторяет оригинал: при появлении противоположного условия открытая позиция закрывается, и лишь после обнуления позиции рассматривается новый вход.

Реализация задействует высокоуровневые подписки на свечи, встроенные индикаторы StockSharp и вспомогательные методы для рыночных заявок. Обработка ведётся только по закрытым свечам, а для имитации параметра `ma_shift` из MetaTrader используется компактный кольцевой буфер, без накопления лишних исторических данных.

## Логика торговли
1. **Расчёт индикаторов**
   - Быстрая и медленная скользящие рассчитываются на выбранном типе свечей.
   - Для каждой средней можно отдельно выбрать источник цены и метод сглаживания (простое, экспоненциальное, сглаженное, взвешенное).
   - Горизонтальные сдвиги берут значения прошлых свечей, полностью воспроизводя `ma_shift`.
2. **Формирование сигналов**
   - Сигнал на покупку появляется, когда сдвинутая быстрая средняя выше медленной и выбранная цена подтверждения расположена выше быстрой средней.
   - Сигнал на продажу появляется, когда сдвинутая быстрая средняя ниже медленной и цена подтверждения находится ниже быстрой средней.
3. **Управление позицией**
   - При наличии открытой позиции противоположный сигнал сначала закрывает текущий объём. Новый ордер возможен только после выхода в ноль.
   - При отсутствии позиции стратегия выставляет рыночную заявку заданного объёма по направлению активного сигнала.

Встроенные стоп-лосс и тейк-профит отсутствуют. При необходимости можно подключить `StartProtection` или внешний модуль управления рисками.

## Параметры
| Параметр | Описание |
| --- | --- |
| **Fast Period** | Период быстрой скользящей средней. |
| **Fast Shift** | Количество свечей, на которое сдвигается значение быстрой средней. |
| **Fast Price** | Тип цены для расчёта быстрой средней (close, open, high, low, median, typical, weighted). |
| **Fast Method** | Метод сглаживания быстрой средней (простая, экспоненциальная, сглаженная, взвешенная). |
| **Slow Period** | Период медленной скользящей средней. |
| **Slow Shift** | Количество свечей для сдвига медленной средней. |
| **Slow Price** | Тип цены для медленной средней. |
| **Slow Method** | Метод сглаживания медленной средней. |
| **Signal Price** | Цена свечи, используемая для подтверждения входа (по умолчанию — закрытие). |
| **Candle Type** | Таймфрейм или пользовательский тип свечей для расчётов. |
| **Volume** | Объём рыночного ордера при открытии позиции. |

## Особенности использования
- Сигналы формируются только на завершённых свечах, чтобы избежать шума внутри бара.
- Коннектор должен предоставить достаточно истории для прогрева обеих скользящих и их сдвигов.
- Взвешенная цена рассчитывается как \((High + Low + 2 * Close) / 4\), что соответствует параметру `PRICE_WEIGHTED` в MetaTrader.
- Класс и пространство имён следуют стандартам StockSharp, поэтому стратегия без доработок подключается к решению `AlgoTrading`.

## Запуск
1. Добавьте стратегию в контейнер или пример StockSharp.
2. Настройте инструмент, таймфрейм (`Candle Type`) и торговый объём.
3. При необходимости подберите параметры скользящих средних под оригинальный шаблон MetaTrader.
4. Запустите стратегию — она подпишется на свечи, при наличии графика отрисует индикаторы и будет отправлять рыночные приказы согласно описанным правилам.

Для многосимвольной торговли создавайте отдельный экземпляр стратегии на каждый инструмент.
