# Стратегия Close Agent

## Обзор
Close Agent — вспомогательный модуль управления риском, являющийся портом MQL-советника CloseAgent. Стратегия не открывает новых сделок, а наблюдает за уже существующими позициями и закрывает их, когда цена выходит за пределы полос Боллинджера и RSI показывает экстремальные значения. Модуль способен отслеживать вручную открытые сделки или позиции других алгоритмов и при необходимости закрывать всё при достижении целевого профита.

## Данные и индикаторы
- **Свечи:** настраиваемый таймфрейм (по умолчанию 5 минут), служащий источником данных для индикаторов.
- **Полосы Боллинджера (период 21, ширина 2):** фиксируют выход цены за верхнюю/нижнюю границу канала.
- **RSI (период 13):** определяет состояние перекупленности (>70) или перепроданности (<30).
- **Котировки Level1:** обеспечивают актуальные bid/ask для точного выполнения рыночных закрытий.

## Параметры
- **Close Mode (`CloseMode`):** выбирает, какие позиции контролировать.
  - `Manual` – только сделки без идентификатора текущей стратегии (ручные или внешние).
  - `Auto` – только позиции, открытые текущим экземпляром стратегии.
  - `Both` – все позиции по инструменту стратегии.
- **Candle Type (`CandleType`):** таймфрейм, используемый при вычислении индикаторов.
- **Operation Mode (`OperationMode`):**
  - `LiveBar` – использовать формирующуюся свечу; быстрее реагирует, но данные могут быть незавершёнными.
  - `NewBar` – ждать закрытия свечи для формирования сигнала; безопаснее, но медленнее.
- **Close All Target (`CloseAllTarget`):** абсолютное значение `PnL`, при достижении которого все отслеживаемые позиции закрываются.
- **Enable Alerts (`EnableAlerts`):** включает вывод в лог сообщений о каждом закрытии и величине зафиксированного профита.

## Логика работы
1. Стратегия подписывается на поток Level1 и выбранный свечной таймфрейм, рассчитывая полосы Боллинджера и RSI.
2. Поддерживается небольшой буфер истории, чтобы при режиме `NewBar` использовать данные последней завершённой свечи.
3. При достижении порога `CloseAllTarget` стратегия немедленно закрывает все подходящие позиции рыночными заявками.
4. Для каждой позиции по текущему инструменту выполняются условия выхода:
   - **Длинные позиции:** закрываются, если лучшая цена Bid выше верхней полосы, RSI превышает 70, а текущая цена выше средней цены входа.
   - **Короткие позиции:** закрываются, если лучшая цена Ask ниже нижней полосы, RSI опускается ниже 30, а текущая цена ниже средней цены входа.
5. Если bid/ask недоступны, используется последняя обработанная цена закрытия свечи, чтобы не пропустить сигнал.

## Рекомендации по использованию
- Close Agent предназначен для совместной работы с другими торговыми системами и служит защитным слоем.
- Поскольку стратегия занимается только закрытием, её следует запускать параллельно с основными алгоритмами открытия позиций.
- При активированном параметре `EnableAlerts` в логе Designer появятся сообщения, аналогичные оригинальным уведомлениям MQL.
