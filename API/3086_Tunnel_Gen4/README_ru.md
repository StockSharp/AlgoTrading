# Стратегия Tunnel Gen4 Hedged Grid
[English](README.md) | [中文](README_cn.md)

Стратегия повторяет логику советника MetaTrader "Tunnel gen4" с использованием высокоуровневого API StockSharp. Она поддерживает нейтральный хедж, открывая стартовый набор из покупок и продаж, удваивает объём в направлении прорыва после прохождения ценой заданного числа пунктов и закрывает весь портфель, когда такая же дистанция пройдена за пределы второй опорной точки.

## Логика торговли

- **Начальный хедж:** Когда активных позиций нет, стратегия одновременно отправляет рыночные заявки Buy и Sell объёмом `StartVolume`. Первая сделка определяет опорную цену, относительно которой измеряются все шаги.
- **Контроль шага:** Параметр `StepPips` переводится в ценовое смещение с учётом минимального шага цены инструмента и поправки для трёх- и пятизнаковых валютных котировок. Обновления лучшей цены bid/ask из Level 1 сравниваются с этим смещением.
- **Усиление позиции:** Если лучшая цена bid выросла минимум на один шаг от первой сделки, отправляется рыночная заявка Sell объёмом в два раза больше базового. Если лучшая цена ask упала на один шаг, то отправляется Buy такого же размера. Первая сделка по этой заявке фиксирует вторую опору.
- **Завершение цикла:** После появления второй опоры любое дальнейшее смещение цены на величину шага в любую сторону запускает полное закрытие всех позиций. После закрытия обеих сторон состояние сбрасывается, и стратегия готова открыть новый хедж.
- **Проверка объёмов:** При запуске стратегия удостоверяется, что стартовый и удвоенный объёмы соответствуют ограничениям инструмента по минимуму, максимуму и шагу, чтобы каждый ордер мог быть исполнен коннектором.

## Условия входа

### Усиление покупки
- Существует хотя бы одна позиция из начального хеджа.
- Вторая опора ещё не создана.
- Текущая лучшая цена ask меньше либо равна `первая_сделка - StepPips_в_цене`.

### Усиление продажи
- Существует хотя бы одна позиция из начального хеджа.
- Вторая опора ещё не создана.
- Текущая лучшая цена bid больше либо равна `первая_сделка + StepPips_в_цене`.

## Управление выходом

- **Закрытие корзины:** После появления второй опоры, если лучшая цена bid превышает `вторая_опора + StepOffset` или лучшая цена ask опускается ниже `вторая_опора - StepOffset`, стратегия отправляет рыночные заявки для закрытия суммарного длинного и короткого объёмов. Закрывающие заявки отслеживаются до полного исполнения, чтобы сброс состоялся только после подтверждённых сделок.
- **Сброс состояния:** Когда обе стороны закрыты и активных заявок на выход нет, внутренние опоры очищаются и стратегия ожидает возможности открыть новый хедж.

## Данные и индикаторы

- Подписка Level 1 предоставляет лучшие цены bid и ask, по которым оцениваются шаги.
- Дополнительные индикаторы не используются; логика полностью базируется на потоке котировок.
- Конвертация шага цены повторяет поправку MetaTrader из point в pip, поэтому трёх- и пятизнаковые валютные пары ведут себя так же, как в исходном советнике.

## Параметры

| Параметр | Описание |
|----------|----------|
| `StartVolume` | Объём заявок Buy и Sell, формирующих первоначальный хедж. |
| `StepPips` | Дистанция в пунктах, которая запускает усиление и последующее закрытие корзины. |

## Особенности реализации

- StockSharp ведёт сводную позицию по инструменту. Стратегия хранит внутренние счётчики длинного и короткого объёмов, чтобы имитировать отдельные тики MetaTrader, и при закрытии корзины отправляет рыночные заявки на суммарные объёмы.
- Для корректной работы необходимы актуальные спреды, поэтому и в тестах, и в реальной торговле нужно предоставлять поток Level 1. При отсутствии bid/ask торговый цикл приостанавливается.
- Убедитесь, что торговый счёт поддерживает одновременные покупки и продажи одного инструмента, так как алгоритм предполагает сосуществование обеих сторон до наступления условия выхода.
