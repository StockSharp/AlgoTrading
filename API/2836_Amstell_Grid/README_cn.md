# Amstell 网格策略
[English](README.md) | [Русский](README_ru.md)

Amstell 网格策略是 MetaTrader 5 专家顾问 `exp_Amstell.mq5` 的 C# 版本，专门为 StockSharp 平台编写。策略构建对称的买入/卖出网格，并为每个仓位应用虚拟止盈。实现完全遵循 AGENTS.md 的要求，使用蜡烛数据替代 MT5 中的 `OnTick`，同时保持原始交易思路。

## 工作机制

1. **初始化**
   - 订阅所选蜡烛类型的数据，并调用 `StartProtection()` 启动仓位保护。
   - 根据证券的 `PriceStep` 和小数位数计算点值。对于 3 位或 5 位报价的品种，点值会自动乘以 10，与 MT5 的处理保持一致。

2. **首笔交易**
   - 当最后一次买入/卖出价格都为空（首次启动）时，会立即发送一笔市价买单，用来激活网格，这与原始 EA 的行为一致。

3. **网格扩展**
   - 当当前收盘价相对最后一次买入价至少下移 `StepPips` 个点时，追加一笔买单。
   - 当价格相对最后一次卖出价至少上移 `StepPips` 个点时，追加一笔卖单。
   - 策略内部维护独立的多头与空头列表。相反方向的订单会优先抵消已有仓位，剩余数量才会转化为新的网格层，从而在净头寸账户上模拟 MT5 的对冲逻辑。

4. **虚拟止盈**
   - 对每一笔多头持仓单独监控，当价格上行 `TakeProfitPips` 个点时，以相同数量市价卖出平仓。
   - 空头仓位采用镜像逻辑：当价格下行 `TakeProfitPips` 个点时，以相同数量市价买入平仓。
   - 止盈由代码触发，交易账户中不会挂出真实的 TP 订单，因此被称为“虚拟止盈”。
   - 当某一方向的仓位全部关闭而另一方向仍然存在时，对应的最后成交价会被清零，使下一次同方向下单能够立即触发，行为与原脚本一致。

5. **状态管理**
   - `OnOwnTradeReceived` 事件根据成交回报重建多空队列，可正确处理部分成交与反向操作。
   - 当两边都清仓后，最近一次买入/卖出价格依旧保留，这意味着策略会等待价格重新偏离设定的步长，再次启动网格。

## 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `Volume` | `0.1` | 每次下单的数量。 |
| `TakeProfitPips` | `50` | 单笔仓位达到多少点收益时触发虚拟止盈。 |
| `StepPips` | `15` | 同方向相邻网格之间的点数间隔。 |
| `CandleType` | `1 分钟` | 使用哪种蜡烛数据来近似原来的逐笔逻辑。 |

所有基于点数的设置都会自动转换为价格单位。例如在 5 位报价的 EURUSD 上，`StepPips = 15` 等同于 0.0015。

## 实战提示

- 若需要更细腻的反应速度，可以选择更小的蜡烛周期；策略仍然在蜡烛收盘时评估条件。
- 策略没有内置止损。与所有网格系统一样，单边强势行情可能累积较大头寸，请务必控制仓位并结合资金管理。
- 虚拟止盈会立即在策略端记录盈亏，而无需向券商提交止盈委托。
- 当网格完全平仓后，保留的最后成交价能够迫使策略等待价格重新偏离步长，再次入场，忠实复刻原策略的节奏。

## 文件列表

- `CS/AmstellGridStrategy.cs` — StockSharp 平台上的策略实现，包含详细英文注释。
- `README.md`、`README_ru.md`、`README_cn.md` — 英文、俄文、中文三种语言的完整说明。

该移植版本可作为进一步研究与扩展的基础，例如加入风险控制、优化资金分配或叠加额外过滤条件。
