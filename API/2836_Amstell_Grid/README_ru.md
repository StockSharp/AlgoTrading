# Сетка Amstell
[English](README.md) | [中文](README_cn.md)

Стратегия Amstell Grid — это порт эксперт-советника MetaTrader 5 `exp_Amstell.mq5` на C# под экосистему StockSharp. Она строит симметричную сетку из покупок и продаж и использует виртуальный тейк-профит для закрытия отдельных позиций. Реализация выполнена в соответствии с рекомендациями AGENTS.md и использует высокоуровневые подписки на свечи вместо тиковой функции `OnTick`, сохраняя при этом исходную торговую идею.

## Как работает стратегия

1. **Инициализация**
   - Подписываемся на свечи выбранного таймфрейма и запускаем защиту позиции (`StartProtection`).
   - Рассчитываем размер «пункта» по шагу цены инструмента. Для инструментов с 3 или 5 знаками после запятой шаг умножается на 10, что повторяет алгоритм MT5.

2. **Первый ордер**
   - Если нет сохранённых цен последней покупки и продажи (первый запуск), сразу отправляется рыночная покупка. Это создаёт исходную позицию сетки, как в оригинальном коде.

3. **Расширение сетки**
   - **Покупка** добавляется, если текущая цена закрытия упала минимум на `StepPips` пунктов относительно последней цены покупки.
   - **Продажа** добавляется, если цена выросла минимум на `StepPips` пунктов относительно последней цены продажи.
   - Стратегия ведёт отдельные списки длинных и коротких позиций. Вход противоположного направления сначала уменьшает встречный список (закрывает позиции), а остаток объёма добавляется как новая позиция, что имитирует хеджевую логику MT5 даже на неттинговых счетах.

4. **Виртуальный тейк-профит**
   - Каждая длинная позиция проверяется отдельно. Если цена выросла на `TakeProfitPips` пунктов, отправляется рыночная продажа ровно этого объёма.
   - Короткие позиции обрабатываются зеркально: если цена упала на нужное число пунктов, отправляется рыночная покупка соответствующего объёма.
   - Тейк-профит «виртуальный», потому что брокерских заявок с фиксированным уровнем не ставится — закрытие выполняется программно.
   - Когда, например, все покупки закрыты, а продажи остаются, цена последней покупки сбрасывается. Это позволяет следующей покупке выполниться немедленно, как и в исходной реализации.

5. **Отслеживание состояния**
   - Обработчик `OnOwnTradeReceived` пересобирает списки длинных и коротких позиций на основе фактически исполненных сделок, корректно обрабатывая частичные исполнения и реверсы.
   - Если обе стороны закрыты, последние цены не очищаются. Это сохраняет требование дождаться смещения цены на величину шага перед повторным входом.

## Параметры

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `Volume` | `0.1` | Объём каждой рыночной заявки. |
| `TakeProfitPips` | `50` | Сколько пунктов должно пройти в прибыль, чтобы закрыть отдельную позицию. |
| `StepPips` | `15` | Расстояние между соседними ордерами одной стороны в пунктах. |
| `CandleType` | `1 минута` | Таймфрейм свечей, используемый вместо тиков. |

Все значения в пунктах автоматически переводятся в цену с учётом `PriceStep` и количества знаков инструмента. Например, для EURUSD (5 знаков) `StepPips = 15` соответствует смещению 0.0015.

## Практические замечания

- Для более частого обновления условий можно уменьшить таймфрейм свечей. Логика по-прежнему ориентирована на закрытие свечи, а не на каждый тик.
- Система не содержит стоп-лосса. Как и любая сетка, стратегия способна накапливать значительную позицию при сильном тренде. Подбирайте объёмы консервативно и контролируйте риски.
- Виртуальный тейк-профит позволяет сразу фиксировать PnL без размещения заявок на сервере брокера.
- После полного обнуления позиций сохранённые последние цены позволяют дождаться нужного смещения, прежде чем сетка возобновится.

## Структура папки

- `CS/AmstellGridStrategy.cs` — реализация стратегии на StockSharp с подробными комментариями.
- `README.md`, `README_ru.md`, `README_cn.md` — документация на английском, русском и китайском языках.

Стратегия может служить базой для дальнейших экспериментов: добавления фильтров, управления риском, интеграции с другими модулями StockSharp.
