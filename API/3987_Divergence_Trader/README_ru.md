# Дивергенция Трейдер (классическая конверсия)

Эта стратегия переносит советника MetaTrader 4 **Divergence Trader** на высокоуровневый API StockSharp. Рассчитываются две простые скользящие средние по выбранной цене свечи (по умолчанию — открытие). Система отслеживает, как расстояние между быстрой и медленной средними меняется от бара к бару:

* Когда спред расширяется вверх и значение дивергенции находится между параметрами *Buy Threshold* и *Stay Out Threshold*, открывается длинная позиция либо закрывается существующая короткая.
* Когда спред расширяется вниз в зеркальном диапазоне, открывается короткая позиция либо закрывается существующая длинная.

Обрабатываются только завершённые свечи, что полностью повторяет логику оригинального советника. Управление позициями выполняется через высокоуровневые вызовы `BuyMarket` и `SellMarket`.

## Торговые правила

1. Подписаться на выбранный тип свечей и рассчитать две SMA с периодами *Fast SMA* и *Slow SMA*.
2. Вычислить текущий спред (`fast - slow`) и сравнить его с предыдущим значением для получения дивергенции.
3. Входить в покупку, если дивергенция положительная, ≥ *Buy Threshold* и ≤ *Stay Out Threshold*.
4. Входить в продажу, если дивергенция отрицательная, ≤ `-Buy Threshold` и ≥ `-Stay Out Threshold`.
5. Переворачивать позицию при появлении противоположного сигнала.
6. Ограничивать новые входы локальным временным окном между *Start Hour* и *Stop Hour* (поддерживается переход через полночь).

## Управление рисками

* Опциональные *Take Profit (pips)* и *Stop Loss (pips)* контролируются по максимуму/минимуму свечи.
* Параметр *Break-Even Trigger (pips)* переносит стоп в область безубытка `entry ± Break-Even Buffer`, когда позиция достигает заданного количества пунктов.
* *Trailing Stop (pips)* сопровождает цену при движении в прибыль. Значение 9999 отключает трейлинг, как и в оригинальном советнике.
* Управление корзиной закрывает все позиции при достижении *Basket Profit* или падении ниже `-Basket Loss` по нереализованной прибыли/убытку в валюте счёта.

## Параметры

| Параметр | Описание |
|----------|----------|
| `Order Volume` | Объём, используемый при открытии новой позиции. |
| `Fast SMA` / `Slow SMA` | Периоды двух простых скользящих средних. |
| `Applied Price` | Компонента свечи, поступающая в расчёт средних. |
| `Buy Threshold` | Нижняя граница дивергенции, позволяющая длинные сделки. |
| `Stay Out Threshold` | Верхняя граница дивергенции, выше которой входы блокируются. |
| `Take Profit (pips)` / `Stop Loss (pips)` | Жёсткие выходы, измеряемые в пунктах. |
| `Trailing Stop (pips)` | Расстояние трейлинг-стопа после выхода в прибыль. |
| `Break-Even Trigger (pips)` | Прибыль в пунктах для переноса стопа в безубыток. |
| `Break-Even Buffer (pips)` | Дополнительный буфер для стопа безубытка. |
| `Basket Profit` / `Basket Loss` | Глобальные ограничения по плавающей прибыли/убытку. |
| `Start Hour` / `Stop Hour` | Локальное торговое время. |
| `Candle Type` | Таймфрейм свечей для расчёта сигналов. |

## Рекомендации по использованию

* Привяжите стратегию к инструменту и выберите таймфрейм, соответствующий исходному графику.
* Убедитесь, что свойства инструмента `PriceStep`/`StepPrice` корректны — это необходимо для пунктовых вычислений.
* Чтобы отключить функции вроде трейлинг-стопа или переноса в безубыток, оставьте их параметры равными 9999 или нулю.
