# 一目均衡回调策略

本策略是 MetaTrader 专家顾问 **“ICHMOKU RETRACEMENT”** 的 StockSharp 版本。核心思想是在更高周期趋势中，利用价格回踩一目均衡线后的反弹/回落机会，同时结合动量偏离和月度 MACD 作为过滤条件。移植过程中完全使用 StockSharp 的高阶 API，以便在 Designer、Shell 或代码中直接复用。

## 交易逻辑

1. **趋势过滤**：通过一对线性加权移动平均线（LWMA）判定多空方向。快线高于慢线视为多头趋势，快线低于慢线视为空头趋势。
2. **一目均衡回调**：在趋势成立后，上一根 K 线必须触及任意一条一目均衡线（转折线、基准线或领先跨度），当前 K 线需要重新开在该线的趋势方向一侧，表示回调结束、趋势延续。
3. **动量确认**：使用收盘价动量比率（当前收盘价与 N 根之前收盘价之比 ×100），要求偏离 100 的幅度达到设定阈值，以避免弱势回调信号。
4. **宏观过滤**：在更大周期（默认 30 天）上计算 12/26/9 MACD。多头需要 MACD 主线高于信号线，空头则反之。
5. **仓位管理**：策略始终只保持一个净仓位，通过固定的止损/止盈（以点数计）管理风险，并在每根完成的 K 线后检查是否触发。

## 参数

| 名称 | 说明 | 默认值 |
|------|------|--------|
| `Signal Candle Type` | 用于 LWMA、一目均衡和动量的信号周期。 | 1 小时 K 线 |
| `Macro Candle Type` | 用于 MACD 过滤的更大周期。 | 30 天 K 线 |
| `Fast LWMA` | 快速线性加权移动平均线周期。 | 6 |
| `Slow LWMA` | 慢速线性加权移动平均线周期。 | 85 |
| `Tenkan Period` | 一目均衡转折线周期。 | 9 |
| `Kijun Period` | 一目均衡基准线周期。 | 26 |
| `Span B Period` | 一目均衡领先跨度 B 周期。 | 52 |
| `Momentum Period` | 动量比率的回溯长度。 | 14 |
| `Momentum Threshold` | 动量比率相对 100 的最小偏离值。 | 0.3 |
| `Take Profit (pips)` | 止盈距离（点）。 | 50 |
| `Stop Loss (pips)` | 止损距离（点）。 | 20 |

基础参数 `Volume` 控制首次下单的手数。当出现反向信号时，策略会先平掉现有仓位，再以 `Volume + |Position|` 的数量开出新的方向仓位。

## 交易规则

### 做多
- 快速 LWMA > 慢速 LWMA。
- 宏观周期 MACD 主线 > 信号线。
- 动量比率偏离值 ≥ 阈值。
- 上一根 K 线最低价触及任意一目均衡线，且当前 K 线开盘价重新站在该线之上。
- 当前净仓位为空或为空头。

### 做空
- 快速 LWMA < 慢速 LWMA。
- 宏观周期 MACD 主线 < 信号线。
- 动量比率偏离值 ≥ 阈值。
- 上一根 K 线最高价触及任意一目均衡线，且当前 K 线开盘价重新跌破该线。
- 当前净仓位为空或为多头。

### 离场
- 多头在 K 线最低价触及止损或最高价到达止盈时平仓。
- 空头在 K 线最高价触及止损或最低价到达止盈时平仓。

## 与原版 EA 的差异

- 未实现原 MQL 版本中的资金管理、加仓梯度、保本和动态追踪止损，仅保留固定止损/止盈。
- StockSharp 采用净持仓模式，因此不再使用马丁格尔式的多单叠加。
- 忽略了 MetaTrader 中的提示音、邮件和推送功能。

## 使用建议

1. 在 StockSharp Designer 或 Shell 中添加该策略，并选择目标品种。
2. 根据需要调整 `Signal Candle Type`，确保与实际回测/交易周期一致。
3. `Macro Candle Type` 支持通过 `allowBuildFromSmallerTimeFrame` 由小周期合成，请确认行情源能提供足够数据。
4. 根据品种波动性调节止损、止盈和动量阈值，以平衡胜率与盈亏比。

策略源码内附英文注释，便于后续扩展或与其他过滤条件组合。
