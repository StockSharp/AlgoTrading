# Стратегия Ma Shift Puria Method

## Общее описание
Ma Shift Puria Method — адаптация классического советника Puria под высокоуровневый API StockSharp. Стратегия объединяет две экспоненциальные скользящие средние, фильтр MACD и при необходимости динамическое сопровождение позиции по фракталам. Все решения принимаются только на закрытых свечах. Управление позицией включает фиксированные стоп-лоссы/тейк-профиты, параметризованный трейлинг и дополнительную фиксацию прибыли на основе последнего фрактального экстремума.

## Используемые индикаторы
- **Быстрая EMA (по умолчанию 14)** — отслеживает краткосрочное ускорение цены и формирует основной сигнал.
- **Медленная EMA (по умолчанию 80)** — задаёт направление тренда; сигнал считается валидным только при достаточном отрыве между средними.
- **MACD (fast 11, slow 102, signal 9)** — подтверждает импульс: линия MACD должна пересечь нулевую ось в сторону сделки, а три свечи назад находиться по противоположную сторону.
- **Фракталы (окно 5 свечей)** — используются, если активирован фрактальный трейлинг; экстремум определяется по пяти последовательным барам аналогично MetaTrader.

## Логика входа
Стратегия открывает позицию только если торговля разрешена и последняя закрывшаяся свеча удовлетворяет набору условий.

### Покупка
1. Быстрая EMA выше медленной.
2. Медленная EMA растёт относительно значения три свечи назад.
3. Быстрая EMA увеличивается (текущее значение больше предыдущего).
4. MACD находится выше нуля, а три свечи назад был ниже нуля.
5. Прирост быстрой EMA между последними барами превышает порог **Shift Minimum** в пунктах и либо усиливается, либо предыдущий прирост был неположительным.

### Продажа
1. Быстрая EMA ниже медленной.
2. Медленная EMA снижается относительно значения три свечи назад.
3. Быстрая EMA убывает (текущее значение меньше предыдущего).
4. MACD ниже нулевой линии, а три свечи назад был выше неё.
5. Снижение быстрой EMA превышает порог **Shift Minimum**, при этом ускорение сохраняется либо предыдущий сдвиг был неотрицательным.

Объём позиции формируется либо фиксированным значением (`ManualVolume`), либо динамически по доле риска (`RiskPercent`). При смене направления стратегия закрывает встречную позицию и сразу открывает новую в требуемую сторону.

## Управление позицией и рисками
- **Стоп-лосс** — указывается в пунктах от цены входа и проверяется на каждой свече; при достижении уровень закрывает позицию.
- **Тейк-профит** — аналогично стопу, фиксирует прибыль целиком.
- **Трейлинг-стоп** — активируется после прохождения ценой расстояния `TrailingStopPips + TrailingStepPips`; уровень стопа переносится на расстояние `TrailingStopPips`, если может быть улучшен минимум на `TrailingStepPips`, что повторяет оригинальный MQL-алгоритм.
- **Фрактальный трейлинг** — опция. Когда цена проходит 95% расстояния до тейк-профита, стоп может быть подтянут к последнему фрактальному минимуму (для лонга) или максимуму (для шорта), что позволяет быстрее зафиксировать прибыль около цели.
- **Риск-менеджмент** — в режиме динамического объёма рассчитывается денежный риск (доля от капитала), который делится на денежное выражение стоп-лосса и приводится к допустимому шагу лота с учётом ограничений площадки.

## Параметры
| Имя | Описание | Значение по умолчанию |
|-----|----------|-----------------------|
| `UseManualVolume` | Использовать фиксированный объём. | `true` |
| `ManualVolume` | Размер позиции при фиксированном объёме. | `0.1` |
| `RiskPercent` | Доля капитала, рискуемая в сделке (для динамического объёма). | `9` |
| `StopLossPips` | Стоп-лосс в пунктах. | `45` |
| `TakeProfitPips` | Тейк-профит в пунктах. | `75` |
| `TrailingStopPips` | Расстояние трейлинг-стопа. | `15` |
| `TrailingStepPips` | Минимальный шаг обновления трейлинг-стопа. | `5` |
| `MaxPositions` | Максимальное число добавленных единиц в одном направлении. | `1` |
| `ShiftMinPips` | Минимальный наклон быстрой EMA для сигнала. | `20` |
| `FastLength` | Период быстрой EMA. | `14` |
| `SlowLength` | Период медленной EMA. | `80` |
| `MacdFast` | Быстрый период MACD. | `11` |
| `MacdSlow` | Медленный период MACD. | `102` |
| `UseFractalTrailing` | Включить фрактальный трейлинг. | `false` |
| `CandleType` | Тип/таймфрейм свечей для расчётов. | `15 минут` |

## Особенности реализации
- Подписка на свечи и индикаторы выполняется через `SubscribeCandles().Bind(...)`, что исключает прямой доступ к буферам индикаторов.
- Для имитации сдвигов MQL хранится история трёх последних значений EMA и MACD, не используются методы `GetValue`.
- Фракталы рассчитываются во внутренних массивах из пяти баров, поэтому соответствуют классическому определению и не требуют дополнительных индикаторов.
- Стопы и тейки реализованы через рыночные ордера при достижении уровней, то есть стратегия ведёт себя как исходный советник, который модифицировал существующую позицию.
- В `OnStarted` вызывается `StartProtection()`, чтобы автоматически контролировать открытые позиции при возможных сбоях соединения.

## Рекомендации по использованию
1. Подбирайте таймфрейм, соответствующий оригинальной настройке Puria (часто 15-минутные свечи на валютных парах).
2. Корректируйте параметры в пунктах под специфику инструмента (число знаков, стоимость пункта).
3. Перед включением динамического объёма убедитесь, что данные по капиталу и шагу лота корректны, иначе расчётный объём может быть недоступен для торговли.
4. При необходимости комбинируйте стратегию с фильтрацией торговых сессий или общим портфельным управлением — реализованная логика фокусируется на сигнале и сопровождении позиции по методике Puria.
