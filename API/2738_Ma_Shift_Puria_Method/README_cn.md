# Ma Shift Puria Method 策略

## 概述
Ma Shift Puria Method 策略是经典 Puria 专家顾问在 StockSharp 高阶 API 上的复刻。算法结合多条指数移动平均线（EMA）、MACD 过滤器以及可选的分形追踪逻辑，仅在完全收盘的 K 线后进行判断。仓位管理包含固定止损/止盈、可配置的追踪止损，以及当价格接近目标时基于分形的保护机制。

## 指标与计算
- **快 EMA（默认 14）**：衡量短期动量，用于判断快速均线的斜率。
- **慢 EMA（默认 80）**：反映大趋势。快慢 EMA 之间的距离必须超过用户定义的点数阈值才能生成信号。
- **MACD（快 11、慢 102、信号线 9）**：要求主线在最新柱上穿越零轴，同时三根 K 线之前位于相反的一侧，以确认动量方向。
- **分形窗口（5 根 K 线）**：启用分形追踪时使用。策略在滚动的五根 K 线窗口中提取摆动高点和低点，与 MetaTrader 的分形定义（中心柱为局部极值）一致。

## 入场条件
策略仅在允许交易且最新收盘柱满足以下条件时开仓：

### 多头
1. 快 EMA 在慢 EMA 之上。
2. 慢 EMA 相比三根 K 线前抬升。
3. 快 EMA 呈上升斜率（当前值高于前一根）。
4. MACD 主线大于零，且三根 K 线前在零轴以下。
5. 快 EMA 在最近两根 K 线间的增幅超过 **Shift Minimum** 参数（点数），并且要么仍在加速，要么上一段增幅小于等于零。

### 空头
1. 快 EMA 在慢 EMA 之下。
2. 慢 EMA 相比三根 K 线前下降。
3. 快 EMA 呈下降斜率（当前值低于前一根）。
4. MACD 主线小于零，且三根 K 线前在零轴以上。
5. 快 EMA 在最近两根 K 线间的降幅超过 **Shift Minimum** 阈值，并且要么继续加速，要么上一段降幅大于等于零。

根据配置，策略可以按固定手数开仓，或根据账户风险动态计算下单数量。当存在反向仓位时，会一次性平掉并按当前方向重新建仓。

## 出场与风险管理
- **止损**：以点数为单位，相对于入场价格设置。若蜡烛的最低/最高触及该水平，则立即平仓。
- **止盈**：同样以点数表示，触发后全部离场。
- **追踪止损**：开启后，当浮动盈亏超过“追踪距离 + 追踪步长”时，止损会按配置距离跟随价格移动，仅在能够前进至少一个追踪步长时更新，行为与原 MQL 版本一致。
- **分形追踪**：可选功能。当价格达到止盈距离的 95% 时，可把止损上调至最近的分形低点（多头）或下调至分形高点（空头），在接近目标时锁定利润。
- **风险控制下单**：关闭手数固定时，策略按账户权益的一定百分比承担风险。风险金额除以货币化后的止损距离，并根据交易所的最小变动手数/上下限进行四舍五入。

## 参数
| 参数 | 说明 | 默认值 |
|------|------|-------|
| `UseManualVolume` | 是否使用固定手数。 | `true` |
| `ManualVolume` | 固定手数模式下的下单数量。 | `0.1` |
| `RiskPercent` | 风险百分比（当 `UseManualVolume=false` 时生效）。 | `9` |
| `StopLossPips` | 止损点数。 | `45` |
| `TakeProfitPips` | 止盈点数。 | `75` |
| `TrailingStopPips` | 追踪止损距离。 | `15` |
| `TrailingStepPips` | 更新追踪止损所需的最小点数增量。 | `5` |
| `MaxPositions` | 同方向最多累积的单位数量。 | `1` |
| `ShiftMinPips` | 判定信号所需的最小 EMA 斜率（点数）。 | `20` |
| `FastLength` | 快 EMA 长度。 | `14` |
| `SlowLength` | 慢 EMA 长度。 | `80` |
| `MacdFast` | MACD 快线周期。 | `11` |
| `MacdSlow` | MACD 慢线周期。 | `102` |
| `UseFractalTrailing` | 是否启用分形追踪止损。 | `false` |
| `CandleType` | 使用的 K 线类型/周期。 | `15 分钟` |

## 实现细节
- 通过 `SubscribeCandles().Bind(...)` 绑定 EMA 与 MACD，避免手动读取指标缓存，完全符合高阶 API 使用方式。
- 使用内部状态保存最近三根 EMA 与 MACD 数值，以模拟原始 MQL 代码中的 shift 访问。
- 分形逻辑基于 5 根窗口手工计算，不调用指标的 `GetValue` 方法，严格遵守仓库规范。
- 止损、止盈以及追踪调整通过市价单实现，与原 EA 修改持仓的效果一致。
- `StartProtection()` 在启动时调用，用于断线保护和持仓状态跟踪。

## 使用建议
1. 选择与原 Puria 策略相符的时间框架（例如 15 分钟外汇图）。
2. 根据品种的点值调节参数，算法会自动处理 5 位报价，但特殊品种仍需手动确认。
3. 启用风险下单前，请确认账户权益及交易所最小手数限制，确保计算出的数量可成交。
4. 可结合交易时段过滤、组合风控等模块使用，本策略主要复现原 EA 的信号与持仓管理逻辑。
