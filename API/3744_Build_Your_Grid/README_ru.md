# Стратегия Build Your Grid

В каталоге представлена конверсия эксперта MetaTrader **BuildYourGridEA v1.8** на высокоуровневый API StockSharp. Стратегия повторяет сеточную логику оригинала: открывает ордера в обоих направлениях, контролирует расстояние между ними, изменяет объём по заданному правилу и защищает капитал.

## Основная логика

1. **Стартовые сделки** – первый ордер(ы) открываются в разрешённых направлениях согласно параметру `OrderPlacement`.
2. **Расширение сетки** – новые ордера появляются при смещении цены на заданное количество пунктов. Шаг может оставаться постоянным, расти геометрически или удваиваться каждый раз.
3. **Управление объёмом** – лоты могут копировать первый ордер, расти по схеме «удвоение / сложение» либо удваиваться. Опция `AutoLotSize` использует формулу риска из MQL версии.
4. **Контроль риска** – вся сетка закрывается по достижении целевого профита в пунктах или валюте, либо при просадке закрываются первый ордер/все ордера, либо запускается хеджирование при превышении доли просадки от баланса.
5. **Фильтр спреда** – подписка `SubscribeLevel1()` отслеживает лучшую пару bid/ask. Пока спред больше `MaxSpread` (в пунктах), стратегия не открывает новые позиции.

## Реализация

- Используется только высокоуровневый API (`SubscribeCandles`, `SubscribeLevel1`, `BuyMarket`, `SellMarket`).
- Состояние сделок хранится в двух списках (покупки/продажи) с ценой и объёмом. Они обновляются в `OnNewMyTrade`, что имитирует список ордеров MetaTrader.
- Хеджирующий режим на неттинговом счёте приводит к сокращению противоположного объёма. Объём заявки рассчитывается как разница лотов умноженная на `MuliplierHedgeLot`, что повторяет логику EA.
- Расчёты пунктов и прибыли используют `PriceStep` и `StepPrice` инструмента. Если значения не заданы, применяются безопасные дефолты, позволяющие запускать тесты.

## Параметры

| Параметр | Описание |
| --- | --- |
| `CandleType` | Таймфрейм свечей, по которым строится сетка. |
| `OrderPlacement` | Разрешённые направления (оба, только покупки, только продажи). |
| `NextOrder` | Открывать новые ордера по тренду или против тренда. |
| `PipsForNextOrder` | Базовый шаг сетки в пунктах. |
| `StepMode` | Схема изменения шага (постоянный, геометрический, экспоненциальный). |
| `ProfitTarget` | Чем измеряется целевая прибыль (пункты или валюта). |
| `PipsCloseInProfit` | Цель в пунктах при `TargetInPips`. |
| `CurrencyCloseInProfit` | Цель в валюте при `TargetInCurrency`. |
| `LossMode` | Как реагировать на просадку. |
| `PipsForCloseInLoss` | Порог просадки в пунктах. |
| `PlaceHedgeOrder` | Включить хеджирующие сделки. |
| `LevelLossForHedge` | Процент просадки для запуска хеджа. |
| `MuliplierHedgeLot` | Множитель объёма хеджирующих сделок. |
| `AutoLotSize` | Автоматический расчёт объёма. |
| `RiskFactor` | Риск (в процентах от баланса) для авто-лота. |
| `ManualLotSize` | Начальный объём при ручном режиме. |
| `LotProgression` | Схема изменения объёма. |
| `MaxMultiplierLot` | Максимальный множитель первого лота. |
| `MaxOrders` | Максимум одновременных ордеров (0 – без лимита). |
| `MaxSpread` | Максимально допустимый спред (пункты). |

## Отличия от MQL версии

- На платформе StockSharp сделки учитываются в неттинговом режиме, поэтому хеджирующие заявки закрывают часть противоположной позиции, а не формируют независимые тикеты.
- Визуальные объекты на графике и звуковые оповещения не переносились.
- Проверка спреда выполняется по level1 котировкам; если данные недоступны, фильтр автоматически отключается.

## Как использовать

1. Выберите портфель и инструмент с доступом к свечам и level1 данным.
2. Настройте параметры стратегии.
3. Запустите стратегию – она самостоятельно будет расширять сетку, управлять объёмами и закрывать позиции согласно логике.

