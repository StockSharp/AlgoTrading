# Стратегия Multi Orders

**Multi Orders Strategy** — это точная C#-конверсия советника MetaTrader 5 `multi.mq5`. Оригинальный робот добавляет две кнопки на график для пакетного открытия сделок и одновременно запускает простую авто-логику, реагирующую на сужение спреда. Версия для StockSharp сохраняет тот же подход, используя высокоуровневую подписку на стакан котировок (Level1) и встроенную защиту позиций.

## Логика торговли
- Подписка на лучшие bid/ask через `SubscribeLevel1()` с сохранением актуальных котировок.
- Когда текущий спред меньше порога `SlippagePoints` (в шагах цены), стратегия сравнивает среднюю цену с текущими ask/bid:
  - если средняя цена выше ask — отправляется рыночный ордер на покупку;
  - если средняя цена ниже bid — отправляется рыночный ордер на продажу.
- Пакетные заявки имитируют кнопки MetaTrader. Вызовите `TriggerBuyBatch()` или `TriggerSellBatch()` из интерфейса, тестов или внешней автоматизации — серия ордеров будет поставлена в очередь и выполнится при следующем обновлении котировок.
- Защитные стопы и тейки управляются через `StartProtection` с использованием заданных расстояний в шагах цены.

## Расчёт объёма
- `RiskPercentage` задаёт долю капитала портфеля, которую стратегия готова рискнуть на сделку. Сначала используется `Portfolio.CurrentValue`, при отсутствии данных — `CurrentBalance`, затем `BeginValue`.
- Расстояние стоп-лосса берётся из `StopLossPoints` и стоимости шага `StepPrice`. Если данные недоступны, стратегия использует объём из параметра `BaseVolume`.
- Объёмы приводятся к требованиям площадки: учитываются `VolumeStep`, `MinVolume` и `MaxVolume` (если задан).

## Особенности использования
- Стратегия предполагает неттинговый счёт. Несколько ордеров в одну сторону увеличивают совокупную позицию, а не создают отдельные тикеты.
- Ручные пакетные триггеры игнорируются, пока стратегия не запущена, не подключена и ей не разрешено торговать (`IsFormedAndOnlineAndAllowTrading`).
- Подбирайте `SlippagePoints` с учётом шага цены инструмента. Слишком низкое значение заблокирует автоматические входы.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `BuyOrdersCount` | Количество рыночных ордеров на покупку в пакетном вызове. | `5` |
| `SellOrdersCount` | Количество рыночных ордеров на продажу в пакетном вызове. | `5` |
| `RiskPercentage` | Доля капитала портфеля для расчёта объёма. `0` отключает функцию. | `1` |
| `StopLossPoints` | Расстояние стоп-лосса в шагах цены и основа для риск-менеджмента. | `200` |
| `TakeProfitPoints` | Расстояние тейк-профита в шагах цены. | `400` |
| `SlippagePoints` | Максимально допустимый спред (в шагах цены) для автоматических входов. | `3` |
| `BaseVolume` | Резервный объём ордера при недоступном риск-расчёте. | `1` |

