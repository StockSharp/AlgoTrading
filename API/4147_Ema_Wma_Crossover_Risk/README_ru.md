# Стратегия EMA WMA Risk

## Обзор
- Конвертация эксперта MetaTrader 4 «EMA WMA» автора Владимира Хлыстова.
- Ищет разворотные сигналы по взаимному положению экспоненциальной (EMA) и взвешенной (WMA) скользящих средних, рассчитанных по ценам **открытия** свечей.
- Автоматически подвязывает стоп-лосс и тейк-профит через `StartProtection`, что повторяет логику MT4.
- Поддерживает риск-ориентированный расчет объёма, эквивалентный параметру `risk`, с возможностью задать фиксированный объём.

## Логика оригинального советника
- Эксперт работает на любом инструменте и таймфрейме, вычисляя сигналы один раз при появлении новой свечи (`TimeBar`).
- Индикаторы используют `PRICE_OPEN`, поэтому реагируют на цену открытия бара.
- Если EMA опускается ниже WMA при условии, что на предыдущей свече была выше, закрываются продажи и открывается покупка с заданными стопом и целью.
- Если EMA поднимается выше WMA после нахождения ниже, закрываются покупки и открывается продажа.
- Параметр `risk` определяет размер лота от свободной маржи и размера стоп-лосса.

## Правила в StockSharp
1. Подписка на выбранный тип свечей (`CandleType`, по умолчанию 30 минут). Обрабатываются только завершённые свечи.
2. Значения открытия подаются в EMA и WMA вручную, ожидаем формирования обоих индикаторов.
3. Бычий сигнал: предыдущая EMA > предыдущей WMA и текущая EMA < текущей WMA.
   - Закрываем шорты и открываем лонг с объёмом по правилам риска.
4. Медвежий сигнал: предыдущая EMA < предыдущей WMA и текущая EMA > текущей WMA.
   - Закрываем лонги и открываем шорт.
5. `StartProtection` оформляет рыночные защитные приказы, поэтому новая сделка сразу получает стоп и тейк в шагах цены.

## Управление рисками
- **RiskPercent** имитирует параметр `risk`. Объём вычисляется по текущей стоимости портфеля, величине стопа и биржевым шагам цены/цены шага.
- При отсутствии метаданных (нет `PriceStep` или `StepPrice`) используется абсолютное значение стопа.
- Если `RiskPercent` равен нулю, нужно задать положительный **OrderVolume**.
- Перед открытием новой позиции противоположная экспозиция закрывается (аналог `CLOSEORDER` → `OPENORDER`).

## Параметры
| Имя | Описание |
| --- | --- |
| `EmaPeriod` | Период экспоненциальной скользящей средней (28 по умолчанию). |
| `WmaPeriod` | Период взвешенной скользящей средней (8 по умолчанию). |
| `StopLossPoints` | Дистанция стоп-лосса в шагах цены (по умолчанию 50). |
| `TakeProfitPoints` | Дистанция тейк-профита в шагах цены (по умолчанию 50). |
| `RiskPercent` | Доля капитала под риск на сделку (по умолчанию 10%). |
| `OrderVolume` | Фиксированный объём ордера; 0 — использовать расчёт по риску. |
| `CandleType` | Тип/таймфрейм свечей для расчётов. |

## Особенности реализации
- Значения EMA и WMA обновляются через `DecimalIndicatorValue`, чтобы гарантировать использование цены открытия, как в MT4.
- Работаем по закрытым свечам: сигнал может появляться на бар позже относительно MT4, но исключает подсмотр в будущее.
- Стоп и тейк задаются в шагах цены, что соответствует переменной `Point` из MetaTrader.
- При наличии графической области отображаются свечи, обе скользящие и точки сделок.
