# Стратегия MA Cross Method PriceMode

## Обзор
**MA Cross Method PriceMode** — порт на StockSharp эксперта MetaTrader 4 «MA_cross_Method_PriceMode». Стратегия отслеживает две настраиваемые скользящие средние и реагирует каждый раз, когда быстрая средняя пересекает медленную. Обе линии полностью повторяют входные параметры MT4: период, метод сглаживания (SMA, EMA, SMMA, LWMA), тип цены (close, open, high, low, median, typical, weighted) и горизонтальный сдвиг. Стратегию можно применять к любому инструменту, который предоставляет стандартные свечи по времени.

## Индикаторы
- **Быстрая скользящая средняя** — настраиваемый период, метод и тип цены. Горизонтальный сдвиг MetaTrader реализован через буфер завершённых значений: стратегия хранит последние `FirstShift + 2` значений и возвращает значение `FirstShift` баров назад.
- **Медленная скользящая средняя** — аналогичные параметры и тот же механизм буфера для сдвига.

## Логика торговли
1. Стратегия подписывается на выбранный тип свечей и работает только с завершёнными барами, что исключает перерисовку на незакрытых свечах.
2. На каждой закрытой свече соответствующие цены подаются в обе скользящие средние.
3. После получения финальных значений рассчитываются два условия:
   - **Бычий крест** — быстрая средняя была ниже или равна медленной на предыдущем баре и поднимается выше на текущем баре.
   - **Медвежий крест** — быстрая средняя была выше или равна медленной на предыдущем баре и опускается ниже на текущем баре.
4. При бычьем кресте отправляется рыночная покупка объёмом `OrderVolume`. Если открыта короткая позиция, объём автоматически увеличивается, чтобы закрыть шорт и открыть лонг одним ордером.
5. При медвежьем кресте отправляется рыночная продажа объёмом `OrderVolume`. При наличии длинной позиции объём увеличивается так, чтобы закрыть лонг и открыть шорт.
6. Вызов `StartProtection()` позволяет дополнительно подключить стандартные защитные модули StockSharp (стоп-лосс, безубыток и т. п.).

## Параметры
| Название | Описание | Значение по умолчанию |
| --- | --- | --- |
| `FirstPeriod` | Период быстрой скользящей средней. | `3` |
| `SecondPeriod` | Период медленной скользящей средней. | `13` |
| `FirstMethod` | Метод сглаживания быстрой средней (`Simple`, `Exponential`, `Smoothed`, `LinearWeighted`). | `Simple` |
| `SecondMethod` | Метод сглаживания медленной средней. | `LinearWeighted` |
| `FirstPriceMode` | Тип цены для быстрой средней (`Close`, `Open`, `High`, `Low`, `Median`, `Typical`, `Weighted`). | `Close` |
| `SecondPriceMode` | Тип цены для медленной средней. | `Median` |
| `FirstShift` | Горизонтальный сдвиг (в барах) для быстрой средней. | `0` |
| `SecondShift` | Горизонтальный сдвиг для медленной средней. | `0` |
| `OrderVolume` | Базовый объём заявки при открытии позиции. | `0.1` |
| `CandleType` | Тип/таймфрейм свечей, обрабатываемых стратегией. | Свечи 5 минут |

## Отличия от версии MQL
- Цикл по ордерам MetaTrader (`OrdersTotal`, `OrderSelect`, `OrderClose`) заменён обращением к свойству `Strategy.Position` и отправкой рыночных ордеров подходящего объёма для реверса позиции.
- Флаг «новый бар» больше не требуется: `ProcessCandle` вызывается ровно один раз на завершённую свечу, что естественным образом повторяет поведение «один сигнал на бар» без опроса по тикам.
- Сдвиг скользящих реализован компактными буферами последнего `shift + 2` значения, что повторяет визуальное смещение MetaTrader без использования запрещённых методов обратного доступа к индикаторам (`GetValue`).
- Стратегия не задаёт фиксированных стопов и тейков при отправке ордеров; для защиты можно подключать стандартные блоки StockSharp через `StartProtection()`.

## Рекомендации по использованию
- Выбирайте таймфрейм, соответствующий исходной торговой системе (например, M5 или H1). При необходимости параметр `CandleType` можно изменить на другой интервал.
- Положительные значения `FirstShift` или `SecondShift` смещают момент входа на указанное количество закрытых баров — аналогично параметру Shift в MetaTrader.
- Режим цены `Weighted` повторяет формулу MetaTrader `(High + Low + 2 * Close) / 4`; `Median` и `Typical` соответствуют `(High + Low) / 2` и `(High + Low + Close) / 3`.
- Все сделки исполняются рыночными ордерами, поэтому заранее убедитесь, что торговый счёт допускает нужный объём и возможный проскальзывание.
