# Стратегия Ilan iMA

## Обзор
**Ilan iMA Strategy** — порт MetaTrader 5 советника `Ilan iMA.mq5` на StockSharp. В основе — сдвинутая скользящая средняя,
которая отфильтровывает направление рынка, и мартингейловая сетка усреднений. Реализация на StockSharp использует
высокоуровневый API: при подтверждении тренда по взвешенной скользящей среднй стратегии открывает рыночную позицию и добавляет
новые ордера каждый раз, когда цена проходит против позиции заданный шаг. Вся корзина закрывается при достижении профит-таргета,
срабатывании трейлинг-стопа или стоп-лосса, повторяя модель управления рисками оригинального советника.

## Логика торговли
1. Подписаться на выбранный таймфрейм (`CandleType`) и кормить индикатор скользящей средней с настраиваемыми параметрами
   (`MaMethod`, `MaPeriod`, `PriceMode`). Положительный `MaShift` сдвигает линию вперёд, поэтому стратегия анализирует значения
   прошлых баров, имитируя MT5.
2. Дождаться закрытия свечи — сигналы и защита позиции обрабатываются только на завершённых барах.
3. Определить тренд, сравнив четыре последовательных значения скользящей средней со сдвигом `MaShift`:
   - строгий спад (`ma0 < ma1 < ma2 < ma3`) означает нисходящее движение;
   - строгий рост (`ma0 > ma1 > ma2 > ma3`) сигнализирует о восходящем тренде.
4. Если корзина пуста:
   - при нисходящем тренде и закрытии выше линии MA открыть шорт объёмом `StartVolume`;
   - при восходящем тренде и закрытии ниже линии MA открыть лонг объёмом `StartVolume`.
5. Если корзина существует:
   - когда цена проходит против позиции не менее `GridStepPips`, открыть дополнительный ордер с объёмом, умноженным на
     `LotExponent`, но ограниченным `LotMaximum` и биржевыми лимитами;
   - стратегия хранит минимальную цену покупок, максимальную цену продаж и среднюю цену входа, чтобы повторить поведение MT5.
6. Условия закрытия:
   - если плавающая прибыль корзины с несколькими ордерами достигла `ProfitMinimum` (в валюте счёта), закрыть все сделки в этом
     направлении;
   - закрыть корзину при достижении `TakeProfitPips` или при убытке в `StopLossPips`;
   - трейлинг включается после движения на `TrailingStopPips + TrailingStepPips` пунктов и смещается ступенями по `TrailingStepPips`.

## Управление рисками и объёмом
- `StartVolume` соответствует параметру MT5 `StartLots`. Каждый следующий ордер умножает предыдущий объём на `LotExponent`,
  учитывая `LotMaximum` и ограничения площадки (`Security.MinVolume`, `Security.VolumeStep`, `Security.MaxVolume`).
- `ProfitMinimum` сохраняет механику «снятия лока»: как только сетка отработала просадку и показала заданную прибыль, все сделки
  соответствующего направления закрываются.
- Стоп-лосс и тейк-профит задаются в пунктах (`StopLossPips`, `TakeProfitPips`). Конвертация в цену выполняется через
  `Security.PriceStep`.
- Блок трейлинга повторяет реализацию MT5: он активируется только после превышения порога `TrailingStopPips + TrailingStepPips`
  и перемещается дискретно, чтобы избежать преждевременных подтяжек стопа.

## Параметры
| Название | Тип | Значение по умолчанию | Аналог в MT5 | Описание |
| --- | --- | --- | --- | --- |
| `MaPeriod` | `int` | `15` | `Inp_MA_ma_period` | Период фильтрующей скользящей средней. |
| `MaShift` | `int` | `5` | `Inp_MA_ma_shift` | Сдвиг линии скользящей средней вперёд. |
| `MaMethod` | `MovingAverageMethod` | `Weighted` | `Inp_MA_ma_method` | Метод усреднения (SMA, EMA, SMMA, LWMA). |
| `PriceMode` | `CandlePrice` | `Weighted` | `Inp_MA_applied_price` | Тип цены свечи для индикатора. |
| `StartVolume` | `decimal` | `1` | `InpStartLots` | Базовый объём первого ордера в корзине. |
| `GridStepPips` | `decimal` | `30` | `InpStep` | Шаг сетки усреднений в пунктах. |
| `LotExponent` | `decimal` | `1.6` | `InpLotExponent` | Множитель объёма для каждой следующей сделки. |
| `LotMaximum` | `decimal` | `15` | `InpLotMaximum` | Максимально допустимый объём одного ордера. |
| `ProfitMinimum` | `decimal` | `15` | `InpProfitMinimum` | Минимальная плавающая прибыль для закрытия корзины. |
| `StopLossPips` | `decimal` | `0` | `InpStopLoss` | Дистанция стоп-лосса в пунктах (0 отключает стоп). |
| `TakeProfitPips` | `decimal` | `100` | `InpTakeProfit` | Дистанция тейк-профита в пунктах. |
| `TrailingStopPips` | `decimal` | `15` | `InpTrailingStop` | Порог прибыли для активации трейлинга. |
| `TrailingStepPips` | `decimal` | `5` | `InpTrailingStep` | Минимальное дополнительное движение для смещения трейлинга. |
| `CandleType` | `DataType` | таймфрейм 15 минут | период графика | Таймфрейм расчёта сигналов. |

## Отличия от оригинала
- StockSharp работает в неттинговой модели, поэтому существует только одна совокупная позиция. Стратегия ведёт внутренний список
  входов и объёмов, чтобы воспроизвести MT5-подход к корзинам.
- При округлении объёмов учитываются биржевые ограничения (`MinVolume`, `VolumeStep`, `MaxVolume`), тогда как в MT5 проверка
  выполнялась вручную. Это исключает заявки, которые может отклонить коннектор.
- Стоп-лосс, тейк-профит и трейлинг реализованы через рыночные выходы, а не через модификацию ордеров, как в MT5. Функционально
  логика сохранена, но управление поручается StockSharp.

## Рекомендации
- Перед запуском убедитесь, что в инструменте заполнены параметры шага цены и объёма (`PriceStep`, `StepPrice`, `MinVolume`,
  `VolumeStep`, `MaxVolume`). Иначе пересчёт пунктов и округление объёма могут работать некорректно.
- Для инструментов с нетипичным шагом цены скорректируйте `GridStepPips`, `StopLossPips`, `TrailingStopPips`.
- Мартингейловые сетки несут повышенный риск. Обязательно протестируйте стратегию на истории и учитывайте комиссии/проскальзывание.
