# Стратегия Center Of Gravity Candle

Стратегия повторяет советник MetaTrader «Exp_CenterOfGravityCandle» с использованием высокоуровневого API StockSharp. Индикатор формирует синтетические свечи: к ценам Open/High/Low/Close применяется алгоритм центра тяжести Джона Элерса, далее результаты сглаживаются выбранной скользящей средней. Цвет синтетической свечи (бычий, медвежий или нейтральный) служит единственным торговым сигналом.

## Логика индикатора

1. Обработка выполняется только после полного закрытия биржевой свечи.
2. Для каждого ценового параметра рассчитываются две скользящие средние с периодом **Period**: простая и линейно-взвешенная.
3. Их произведение делится на минимальный шаг цены инструмента и дополнительно сглаживается методом **Ma Method** с длиной **Smooth Period**.
4. Синтетические High/Low подстраиваются так, чтобы тело свечи всегда включало синтетические Open/Close — точное соответствие реализации в MetaTrader.
5. Цвет свечи определяется сравнением синтетических Open и Close: Open < Close — бычья (цвет 2), Open > Close — медвежья (цвет 0), равны — нейтральная (цвет 1).

## Правила торговли

1. Ведётся история цветов синтетических свечей; анализируется свеча с индексом **Signal Bar** (по умолчанию предыдущая закрытая свеча).
2. Если рассматриваемая свеча стала бычьей и предыдущая не была бычьей:
   - Закрыть короткую позицию, если **Enable Sell Close** = `true`.
   - Открыть длинную позицию, если **Enable Buy Open** = `true`.
3. Если свеча стала медвежьей и предыдущая не была медвежьей:
   - Закрыть длинную позицию, если **Enable Buy Close** = `true`.
   - Открыть короткую позицию, если **Enable Sell Open** = `true`.
4. Объём заявок вычисляется по параметрам **Money Management** и **Margin Mode**. Отрицательное значение **Money Management** трактуется как фиксированный лот. В режимах, основанных на допустимом убытке, учитывается расстояние стоп-лосса.
5. `StartProtection` выставляет защитные заявки согласно значениям **Stop Loss** и **Take Profit** (в шагах цены).

## Параметры

- **Money Management** – доля капитала для расчёта объёма (отрицательное значение = фиксированный лот, поддерживает оптимизацию).
- **Margin Mode** – способ интерпретации Money Management (по equity, по балансу, по риску убытка или фиксированный лот).
- **Stop Loss** – расстояние защитного стопа в шагах цены, используется и для расчёта объёма.
- **Take Profit** – расстояние тейк-профита в шагах цены, выставляется через `StartProtection`.
- **Open Long / Open Short** – разрешение на открытие длинных/коротких позиций по сигналам.
- **Close Long / Close Short** – разрешение на закрытие длинных/коротких позиций при противоположном сигнале.
- **Candle Type** – таймфрейм свечей для расчёта индикатора.
- **Center of Gravity Period** – базовый период для SMA и LWMA, допускает оптимизацию.
- **Smoothing Period** – длина сглаживающей средней, допускает оптимизацию.
- **Smoothing Method** – тип скользящей средней (SMA, EMA, SMMA, LWMA).
- **Signal Bar** – индекс синтетической свечи, по которой формируется сигнал (0 = текущая, 1 = предыдущая и т.д.).

## Особенности

- Индикатор реализован на C#, что позволяет точно воспроизвести алгоритм MetaTrader без накопительных массивов.
- Расчёт объёма использует данные портфеля StockSharp и может незначительно отличаться от значений MetaTrader из-за различий в платформах.
- Стратегия работает только с полностью закрытыми свечами и не торгует внутри бара.
