# Center Of Gravity Candle Strategy

This strategy replicates the MetaTrader expert "Exp_CenterOfGravityCandle" using the StockSharp high level API. The expert trades synthetic candles generated by the Center of Gravity Candle indicator. Each synthetic candle is built by applying John Ehlers' Center of Gravity calculation to the open, high, low and close prices and then smoothing the results with a configurable moving average. The color of the synthetic candle (bullish, bearish or neutral) is the only trading signal.

## Indicator logic

1. Each incoming market candle is processed after it is fully closed.
2. For every price component (open, high, low, close) the strategy calculates two moving averages: a simple MA and a linear weighted MA with the period defined by **Period**.
3. The product of these two averages is divided by the instrument's price step and smoothed with the configured method (**Ma Method**) and length (**Smooth Period**).
4. The synthetic high and low are forced to include the synthetic open/close so that candle bodies stay consistent with the MetaTrader implementation.
5. The candle color is determined by comparing the synthetic open and close: open below close = bullish (color 2), open above close = bearish (color 0), otherwise neutral (color 1).

## Trading rules

1. The strategy keeps a rolling history of synthetic candle colors and inspects the bar defined by **Signal Bar** (default = previous finished bar).
2. When the inspected synthetic candle turns bullish and the previous candle was not bullish:
   - Close any existing short position if **Enable Sell Close** is `true`.
   - Open a new long position if **Enable Buy Open** is `true`.
3. When the inspected synthetic candle turns bearish and the previous candle was not bearish:
   - Close any existing long position if **Enable Buy Close** is `true`.
   - Open a new short position if **Enable Sell Open** is `true`.
4. Market entries use the volume calculated from **Money Management** and **Margin Mode**. Negative values for **Money Management** are treated as a fixed lot size. For loss-based modes the algorithm approximates risk per trade using the configured stop-loss distance.
5. `StartProtection` is activated to automatically place take-profit and stop-loss orders according to **Take Profit** and **Stop Loss** distances expressed in price steps.

## Parameters

- **Money Management** – fraction of account value used to derive order volume (negative values = fixed lot). Optimizable.
- **Margin Mode** – interpretation of the money management parameter (equity based, balance based, loss based or fixed lot).
- **Stop Loss** – stop-loss distance in price steps. Used both for protection orders and risk-based position sizing.
- **Take Profit** – take-profit distance in price steps. Applied via `StartProtection`.
- **Open Long / Open Short** – allow opening long/short positions on their respective signals.
- **Close Long / Close Short** – allow closing long/short positions when the opposite signal appears.
- **Candle Type** – timeframe of candles used for indicator calculation.
- **Center of Gravity Period** – base period for the simple and linear weighted moving averages. Optimizable.
- **Smoothing Period** – length of the smoothing moving average applied to the synthetic candles. Optimizable.
- **Smoothing Method** – moving average type used in the smoothing stage (SMA, EMA, SMMA or LWMA).
- **Signal Bar** – index of the synthetic candle used to generate signals (0 = current, 1 = previous, etc.).

## Notes

- The indicator calculation is implemented in C# to reproduce the original MetaTrader logic, avoiding manual buffers or historical collections.
- The volume calculation uses StockSharp portfolio information and may differ slightly from MetaTrader results because of platform differences.
- The strategy operates entirely on finished candles and never trades on partial bars.
