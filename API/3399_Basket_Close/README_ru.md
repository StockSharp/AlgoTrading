# Утилита Basket Close

## Обзор
Стратегия «Утилита Basket Close» повторяет работу советника MetaTrader «Basket Close 2». Она постоянно отслеживает плавающий финансовый результат всех открытых позиций в портфеле и при достижении заданной цели по прибыли или лимита по убытку отправляет рыночные заявки, чтобы полностью закрыть **все** позиции по каждому инструменту. Дополнительно можно автоматически открывать тестовую сделку, если портфель пуст, что удобно при тестировании защиты капитала.

## Параметры
| Название | Описание |
| --- | --- |
| `LossMode` | Выбор метода контроля убытка: по проценту или по денежной сумме. |
| `LossPercentage` | Порог просадки в процентах (модуль значения), при достижении которого закрываются все позиции, если выбран режим `Percentage`. |
| `LossCurrency` | Плавающий убыток в валюте счёта, который запускает закрытие при режиме `Currency`. |
| `ProfitMode` | Выбор метода фиксации прибыли: по проценту или по денежной сумме. |
| `ProfitPercentage` | Процент прибыли, при достижении которого закрываются все позиции в режиме `Percentage`. |
| `ProfitCurrency` | Плавающая прибыль в валюте счёта, при достижении которой закрываются все позиции в режиме `Currency`. |
| `CandleType` | Таймфрейм, по закрытию которого выполняются периодические проверки PnL. |
| `EnableTestOrders` | При включении автоматически отправляет рыночную покупку, когда открытых позиций нет. |
| `TestOrderVolume` | Объём ордера, используемый тестовой сделкой. |

## Логика работы
1. Подписаться на выбранный таймфрейм и выполнять проверку только после закрытия свечи, как это делал исходный советник.
2. Рассчитать суммарный плавающий PnL всех открытых позиций. Если портфель предоставляет агрегированное значение, используется оно, иначе значения позиций суммируются вручную.
3. Рассчитать процентное изменение относительно баланса счёта, зафиксированного в момент запуска стратегии.
4. Запустить защиту от убытка, когда плавающий результат достигает отрицательного порога. Запустить фиксацию прибыли, когда плавающий PnL или процент прибыли достигает заданной цели.
5. После срабатывания условий продолжать отправлять рыночные заявки, пока каждая позиция в портфеле (включая дочерние стратегии) не будет полностью закрыта.
6. Если включены тестовые ордера, после обнуления позиций снова отправить тестовую сделку, чтобы повторно проверить работу защиты.

## Примечания
- В оригинальном советнике информация выводилась на график, в StockSharp ключевые показатели фиксируются через `LogInfo`.
- Комиссии и свопы, которые в MQL добавлялись вручную, уже входят в плавающий PnL портфеля или отдельных позиций.
- Пороговые значения по проценту используют баланс, сохранённый на старте. При значительном изменении капитала корректируйте параметры.
- Тестовый ордер выставляется повторно каждый раз, когда все позиции были закрыты защитными условиями.
