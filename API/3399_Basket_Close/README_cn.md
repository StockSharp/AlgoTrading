# 篮子平仓工具

## 概述
篮子平仓工具策略还原了 MetaTrader 专家顾问“Basket Close 2”的逻辑。策略会持续监控投资组合中所有持仓的浮动盈亏，当达到设定的盈利目标或亏损阈值时，它会向涉及的每个品种发送市价单，从而完全平掉所有仓位。为了在回测中验证风控是否正常运作，还可以在账户为空仓时自动下达一笔测试订单。

## 参数
| 名称 | 说明 |
| --- | --- |
| `LossMode` | 选择按百分比还是按货币金额来判断亏损阈值。 |
| `LossPercentage` | 当 `LossMode` 为 `Percentage` 时，达到该百分比亏损（取绝对值）便会触发平仓。 |
| `LossCurrency` | 当 `LossMode` 为 `Currency` 时，浮动亏损达到该金额便会触发平仓。 |
| `ProfitMode` | 选择按百分比还是按货币金额来判断盈利目标。 |
| `ProfitPercentage` | 当 `ProfitMode` 为 `Percentage` 时，浮动盈利达到该百分比即平掉全部仓位。 |
| `ProfitCurrency` | 当 `ProfitMode` 为 `Currency` 时，浮动盈利达到该金额即平掉全部仓位。 |
| `CandleType` | 用于触发周期性检查的K线周期，与原始 EA 在收盘价上运作的方式一致。 |
| `EnableTestOrders` | 启用后，在无持仓时自动发送一笔测试性市价买单。 |
| `TestOrderVolume` | 启用测试订单时所使用的下单手数。 |

## 交易逻辑
1. 订阅指定周期的K线，只在K线收盘后执行检查，以模拟原始 EA 的“收盘触发”机制。
2. 汇总所有持仓的浮动盈亏。若投资组合对象提供汇总浮盈亏，则直接使用；否则遍历并累加每个持仓的 PnL。
3. 以策略启动时记录的账户余额为基准，计算浮动盈亏对应的百分比。
4. 当浮动 PnL 触及亏损阈值时触发亏损流程；当浮动 PnL 或百分比达到盈利目标时触发盈利流程。
5. 触发后持续发送市价单，直到投资组合中所有品种的持仓全部归零，包括由子策略开立的仓位。
6. 若启用了测试订单，则在仓位全部平掉后再次发送测试性市价单，以便在回测中反复验证策略。

## 备注
- 原始 EA 会在图表上显示文字信息，本策略改为通过 `LogInfo` 记录关键数据。
- 原脚本单独累加的掉期与佣金，在 StockSharp 中已经包含在投资组合或持仓报告的浮动盈亏里。
- 百分比阈值使用策略启动时的账户余额作为基数。若运行时间较长且权益发生较大变化，请适当调整阈值。
- 启用测试订单后，每当风控机制把仓位平掉，策略都会重新发送测试单，以保持验证流程。
