# Стратегия Daily STP Entry Frame (StockSharp)

## Общее описание
Стратегия воспроизводит логику экспертного советника MetaTrader «Daily STP Entry Frame» средствами высокоуровневого API StockSharp. На каждом новом торговом дне формируются отложенные стоп-заявки у экстремумов предыдущей сессии. Дополнительные фильтры гарантируют, что текущая цена уже находится рядом с уровнем пробоя. Алгоритм ориентирован на валютные инструменты, где под «базовым пунктом» понимается 0.0001 для пятизначных котировок.

## Последовательность работы
1. **Анализ дневного диапазона.** Подписка на дневные свечи обеспечивает хранение максимума и минимума предыдущей завершённой свечи.
2. **Контроль в реальном времени.** Данные Level1 дают оперативные значения bid/ask и последней сделки для управления позициями и времени размещения ордеров.
3. **Подготовка заявок.** В начале нового дня, если выполняются условия дистанции `ThresholdPoints` и расположения дневного открытия относительно вчерашнего экстремума, регистрируются:
   - стоп-покупка по цене `High + SpreadPoints / 2`;
   - стоп-продажа по цене `Low - SpreadPoints / 2`.
4. **Фильтрация рисков.** Новые заявки не выставляются при превышении допустимой просадки `MaximumDrawdownPercent`, при наступлении выходных, вне допустимых часов или при несоответствии фильтру по дням недели.
5. **Ведение позиции.** После активации ордера стратегия:
   - удерживает фиксированные стоп-лосс и тейк-профит в базовых пунктах;
   - может закрыть сделку по таймеру `CloseAfterSeconds`;
   - выполняет виртуальное трейлинг-сопровождение при `TrailingSlope < 1`, повторяя формулу оригинального советника.
6. **Вечернее обслуживание.** Ненужные отложенные заявки снимаются после `NoNewOrdersHour` (в пятницу — `NoNewOrdersHourFriday`) и при смене календарного дня.

## Правила входа и защиты
- **Покупка**
  - Разрешена при `SideFilter = 0` (обе стороны) или `1` (только покупки).
  - Разница между вчерашним максимумом и текущей ценой ≥ `ThresholdPoints`.
  - Сегодняшнее открытие находится ниже вчерашнего максимума.
  - Цена заявки должна быть достаточно удалена от текущего ask.
- **Продажа**
  - Разрешена при `SideFilter = 0` или `-1`.
  - Текущая цена выше вчерашнего минимума не менее чем на `ThresholdPoints`.
  - Сегодняшнее открытие выше вчерашнего минимума.
  - Цена заявки должна быть достаточно удалена от текущего bid.
- **Управление капиталом**
  - Размер заявки рассчитывается из доли накопленной прибыли (`PercentOfProfit`).
  - Объём ограничен интервалом `[MinVolume; MaxVolume]` и приводится к шагу лота инструмента.
  - При просадке свыше `MaximumDrawdownPercent` новые ордера не формируются.
- **Защитные механизмы**
  - Стоп-лосс и тейк-профит хранятся в базовых пунктах и переводятся в абсолютную цену с учётом `PriceStep`.
  - Трейлинг использует формулу оригинального советника: `Bid - StopLoss - Slope * (Bid - Entry)` для длинных позиций (и зеркально для коротких).
  - Таймер `CloseAfterSeconds` принудительно закрывает позицию по истечении заданного времени.

## Параметры
| Параметр | Назначение |
| --- | --- |
| `CandleType` | Таймфрейм свечей для расчёта дневного диапазона (по умолчанию 1 день). |
| `StopLossPoints` / `TakeProfitPoints` | Дистанция до стоп-лосса и тейк-профита в базовых пунктах. |
| `TrailingSlope` | Коэффициент трейлинга; значения ≥ 1 отключают сопровождение. |
| `SideFilter` | -1 только продажи, 0 обе стороны, 1 только покупки. |
| `ThresholdPoints` | Минимальная дистанция от текущей цены до экстремума для активации сигналов. |
| `SpreadPoints` | Добавочный сдвиг для компенсации спреда. |
| `SlippagePoints` | Дополнительный буфер при проверке минимально допустимого расстояния. |
| `NoNewOrdersHour` / `NoNewOrdersHourFriday` | Время вечернего удаления отложенных заявок. |
| `EarliestOrderHour` | Самый ранний час, когда разрешено ставить новые ордера. |
| `DayFilter` | 6 — все дни; значения 0–5 соответствуют воскресенью–пятнице. |
| `CloseAfterSeconds` | Время жизни позиции в секундах (0 отключает). |
| `PercentOfProfit` | Доля прибыли портфеля, используемая для расчёта объёма. |
| `MinVolume` / `MaxVolume` | Нижняя и верхняя границы объёма. |
| `MaximumDrawdownPercent` | Порог просадки, при котором торговля приостанавливается. |

## Особенности реализации
- Если у инструмента `Decimals` равен 3 или 5, размер базового пункта вычисляется как `PriceStep * 10`, что повторяет подход MetaTrader.
- Автоматическое снятие ордеров при смене суток предотвращает накопление старых заявок.
- Учтён отдельный пятничный дедлайн для снятия заявок.
- Почтовые уведомления об изменении Equity заменены сообщениями в журнал стратегии.
- Даже при наличии открытой позиции противоположные стоп-заявки остаются активными, как и в оригинальном советнике.

## Рекомендации по применению
- Перед боевым запуском протестируйте параметры в StockSharp Designer или Runner.
- Убедитесь, что инструмент имеет корректно настроенные `PriceStep`, `StepPrice` и `VolumeStep` — это критично для верного пересчёта базовых пунктов и объёмов.
- Используйте встроенные средства управления рисками StockSharp (лимиты портфеля, проверки заявок) для дополнительной защиты.

