# 隐藏止损止盈管理策略

## 概述
该策略复刻了 MetaTrader 专家顾问“HiddenSLandTP”的核心逻辑。它不在交易所挂出
真实的保护单，而是在内存中记录隐藏的止损和止盈。当最优买价或最优卖价触及
这些隐藏水平时，策略会立即以市价平仓。这样可以避免暴露真实的风险管理水平
给市场或经纪商。

实现基于 StockSharp 的高级策略 API：

* 持仓发生变化时重新计算隐藏止损和止盈。
* 通过订阅盘口数据读取最新的最佳买价和卖价，以逐笔精度检测是否触发。
* 一旦触发，调用 `ClosePosition()` 平掉全部仓位，并写入详细日志。
* 可选地在图表上绘制水平线，展示当前隐藏的保护价位。

## 参数
| 参数 | 说明 |
| --- | --- |
| `StopLossPoints` | 隐藏止损距离，按价格最小变动单位表示，内部乘以 `Security.PriceStep`。 |
| `TakeProfitPoints` | 隐藏止盈距离，单位同上。 |
| `ReferencePrice` | 计算基准价。`OpenPrice` 使用当前持仓的平均成交价，`MidPrice` 使用盘口中 bid/ask 的中间价（若已获取报价）。 |
| `DrawLines` | 是否在图表上绘制当前的隐藏止损与止盈水平。 |

默认参数（止损止盈均为 50 点）与原始 EA 一致，并且所有参数都可以参与优化。

## 执行流程
1. **初始化**：启动时清空内部状态并订阅盘口数据，保证能获取最新的 bid/ask。
2. **计算隐藏水平**：当净持仓不为零时，根据参数和参考价格计算隐藏止损、止盈，并按照价格步长取整。
3. **监控**：每次盘口更新都会刷新缓存的 bid/ask，并判断是否突破隐藏水平。多头使用 bid，空头使用 ask，与 MQL 版本保持一致。
4. **平仓**：触发后仅发送一次 `ClosePosition()`，在确认仓位归零前不重复发单。
5. **完成提示**：所有被跟踪的仓位关闭后，输出 “Task complete - all tracked positions have been closed.”，提示没有剩余的隐藏订单。

## 可视化
开启 `DrawLines` 时，策略会在图表上绘制两条水平线表示隐藏止损和止盈。每次
重新计算都会更新这两条线，方便实时观察保护水平。

## 日志与诊断
* 每次计算新的隐藏水平都会记录方向以及具体价位。
* 触发时会说明是止盈还是止损，并记录触发价格。
* 完成提示只会出现一次，避免重复信息。

## 注意事项
* 假设所有成交均由该策略发起，使 `Position.AveragePrice` 能正确反映入场成本。
* 如果选择 `MidPrice` 而暂时没有盘口报价，策略会先使用平均成交价，待收到报价
  后自动更新隐藏水平。
* 策略不会在交易所挂出真实的止损或限价单，因此需要稳定、低延迟的行情源以
  减少滑点风险。
