# Стратегия Hidden Stop Loss Take Profit Manager

## Обзор
Стратегия повторяет логику советника MetaTrader «HiddenSLandTP». Вместо размещения видимых
защитных заявок на бирже она хранит уровни стоп-лосса и тейк-профита в памяти. Как только
лучшая цена покупки или продажи достигает одного из скрытых уровней, позиция закрывается
рыночной заявкой. Такой подход полезен, когда нельзя раскрывать уровни защитных приказов
контрагенту или брокеру.

Используется высокоуровневый API StockSharp:

* Стратегия отслеживает текущую позицию и пересчитывает скрытые уровни при открытии или
  изменении позиции.
* Для контроля используется стакан: берутся лучшие bid/ask, что позволяет определить касание
  уровней с точностью до тика.
* При срабатывании уровня вызывается `ClosePosition()`, а в журнал записывается пояснение.
* Для наглядности по желанию рисуются горизонтальные линии скрытых уровней.

## Параметры
| Параметр | Описание |
| --- | --- |
| `StopLossPoints` | Расстояние до скрытого стоп-лосса в шагах цены (`Security.PriceStep`). |
| `TakeProfitPoints` | Расстояние до скрытого тейк-профита в шагах цены. |
| `ReferencePrice` | Базовая цена для расчёта уровней. `OpenPrice` использует среднюю цену входа, `MidPrice` — среднюю цену между лучшим bid и ask, если котировки доступны. |
| `DrawLines` | Включает отрисовку горизонтальных линий текущих скрытых уровней на графике. |

Все параметры доступны для оптимизации. Значения по умолчанию (50 пунктов на стоп и тейк)
соответствуют оригинальному советнику.

## Сценарий работы
1. **Инициализация** – при запуске очищаются кеши и оформляется подписка на стакан для получения
   актуальных лучших цен.
2. **Расчёт уровней** – когда позиция становится отличной от нуля, рассчитываются скрытые стоп и
   тейк относительно выбранной базовой цены, результаты округляются к шагу цены инструмента.
3. **Мониторинг** – при каждом обновлении стакана сверяется, не пересечены ли уровни. Для длинных
   позиций используется bid, для коротких – ask, как и в версии для MetaTrader.
4. **Закрытие** – при достижении уровня отправляется единственный вызов `ClosePosition()`. Пока
   позиция не обнулится, повторные сигналы игнорируются.
5. **Завершение** – после закрытия всех отслеживаемых сделок выводится сообщение
   «Task complete - all tracked positions have been closed.».

## Визуализация
При активном параметре `DrawLines` на графике рисуются горизонтальные линии стоп-лосса и
тейк-профита. При каждом пересчёте уровни перерисовываются, что позволяет контролировать защиту
прямо на диаграмме.

## Журнал
* Каждое пересчитывание уровней сопровождается записью с направлением позиции и значениями стопа
  и тейка.
* При срабатывании фиксируется, какой уровень был достигнут, и по какой цене закрыта позиция.
* Сообщение о завершении выводится только один раз после полного закрытия исходных позиций.

## Дополнительные замечания
* Предполагается, что все сделки проходят через стратегию, чтобы `Position.AveragePrice`
  отражала реальную цену входа.
* При выборе `MidPrice` и отсутствии котировок стратегия временно использует среднюю цену входа и
  обновит уровни после появления bid/ask.
* Реальные стопы или лимитные заявки не выставляются, поэтому необходима стабильная и быстрая
  поставка рыночных данных.
