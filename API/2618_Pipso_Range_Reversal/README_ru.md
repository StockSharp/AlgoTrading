# Стратегия Pipso Range Reversal
[English](README.md) | [中文](README_cn.md)

Эта стратегия — портирование советника Pipso с платформы MQL5 в StockSharp. Алгоритм работает как контртрендовая система: продаёт на пробое верхней границы недавнего диапазона и покупает на пробое нижней границы, ограничивая активность заданным торговым окном.

## Основная идея
- Формируется канал в стиле Дончиана из максимума и минимума последних `LookbackPeriod` завершённых свечей (по умолчанию 36).
- Верхняя граница используется для продажи против роста, нижняя — для покупок против падения.
- Сделки разрешены только тогда, когда текущая свеча стартует внутри торгового интервала, заданного параметрами `StartHour` и `EndHour`.

## Логика торговли
### Условия входа
- **Короткая позиция**: если максимум свечи достигает либо превышает предыдущий максимум канала, сначала закрывается длинная позиция, после чего (при активном торговом окне) открывается шорт объёмом `OrderVolume` по рынку. Цена входа фиксируется равной максимуму канала.
- **Длинная позиция**: если минимум свечи касается либо пробивает предыдущий минимум канала, закрывается существующий шорт и, при разрешении торгов, открывается лонг объёмом `OrderVolume` по рынку с ценой входа на уровне минимума канала.

### Условия выхода
- Позиция закрывается немедленно, когда цена касается противоположной границы канала — это повторяет поведение оригинального советника.
- Дополнительно выставляется защитный стоп на фиксированном расстоянии от цены входа. Расстояние рассчитывается как `(channelHigh - channelLow) * (1 + StopRangePercent / 100)`; при стандартном значении `StopRangePercent = 300` стоп отстоит на четыре ширины канала.
- Контроль стопа выполняется по экстремумам свечи: длинная позиция закрывается, если минимум свечи упал ниже стопа; короткая — если максимум поднялся выше стопа.

### Торговое окно
- Параметры `StartHour` и `EndHour` задаются во времени площадки. Если `StartHour < EndHour`, сделки выполняются только внутри этого дневного интервала. Если `StartHour > EndHour`, окно «заворачивается» через полночь, что позволяет торговать ночные сессии (например, с 21 до 9 часов).
- Если параметры совпадают (`StartHour == EndHour`), стратегия остаётся вне рынка.

## Параметры
- **OrderVolume** *(по умолчанию 0.1)* — торговый объём каждой заявки.
- **LookbackPeriod** *(по умолчанию 36)* — количество свечей для расчёта канала.
- **StartHour** *(по умолчанию 21)* — час (0–23), когда открывается торговое окно.
- **EndHour** *(по умолчанию 9)* — час (0–23), когда окно закрывается.
- **StopRangePercent** *(по умолчанию 300)* — дополнительный процент к ширине канала при вычислении дистанции стопа.
- **CandleType** *(по умолчанию часовые свечи)* — таймфрейм для анализа.

## Индикаторы и данные
- Используются индикаторы `Highest` и `Lowest` из StockSharp для отслеживания границ канала.
- Подходит для любых инструментов, по которым доступен непрерывный поток свечей выбранного таймфрейма.
- Оригинальный советник ориентируется на таймфрейм графика; параметр `CandleType` позволяет воспроизвести эти условия.

## Примечания
- Логика работает с завершёнными свечами, чтобы избежать внутридневного шума; в реальном времени цены входа и выхода аппроксимируют тиковое поведение версии MQL5.
- Тейк-профит не используется: фиксация прибыли происходит при возврате цены к противоположной границе или по стопу.
- Рекомендуется адаптировать торговое окно, длину канала и множитель стопа под волатильность конкретного инструмента.

