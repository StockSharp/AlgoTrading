# Стратегия Two Per Bar
[English](README.md) | [中文](README_cn.md)

## Обзор
Советник MetaTrader "Two PerBar" открывает длинную и короткую позицию в самом начале каждой новой свечи, закрывает весь пакет на следующей свече и при необходимости умножает объём по принципу мартингейла. Порт на StockSharp воспроизводит тот же ритм: обе разнонаправленные ноги учитываются явно, а обработка выполняется один раз на закрытии свечи. Все заявки отправляются через высокоуровневые методы `Strategy` и учитывают биржевые ограничения инструмента (шаг цены, шаг объёма, минимальные и максимальные лоты).

## Торговый цикл
1. **Фиксация новой свечи**. Подписка создаётся через `SubscribeCandles`. Как только приходит свеча со статусом `CandleStates.Finished`, начинается очередной цикл.
2. **Проверка тейк-профитов**. Каждая нога хранит цену входа и целевой уровень. Если максимум или минимум завершившейся свечи достигает уровня, нога немедленно закрывается рыночной заявкой и удаляется из списка.
3. **Принудительное закрытие остатка**. Все ноги, которые выжили после шага тейк-профита, ликвидируются по рынку до открытия нового пакета. Это повторяет вызов `PositionClose` в оригинале.
4. **Расчёт следующего объёма**:
   - Если в прошлом цикле остались незакрытые ноги, берётся максимальный объём среди них и умножается на `VolumeMultiplier`.
   - Если обе ноги закрылись (например, по тейк-профиту), стратегия возвращается к `InitialVolume`.
   - Метод `PrepareVolume` округляет кандидат до двух знаков, совмещает со `VolumeStep`, проверяет на `MinVolume` и сбрасывает на `InitialVolume`, если ограничение `MaxVolume` или `Security.MaxVolume` превышено.
5. **Обновление значений по умолчанию**. Рассчитанный объём сохраняется в `_lastCycleVolume` и записывается в `Strategy.Volume`, чтобы вспомогательные методы использовали ту же величину.
6. **Открытие новой пары**. `BuyMarket(volume)` создаёт длинную ногу, `SellMarket(volume)` — короткую. Для каждой ноги фиксируется цена закрывшейся свечи и абсолютный уровень тейк-профита (`entry ± TakeProfitPoints * pointSize`). Если `TakeProfitPoints <= 0`, тейк-профит отключается и закрытие происходит только на следующем баре.

Таким образом формируется непрерывный "страддл": в начале каждой свечи открывается пара позиций, в течение бара они отслеживаются на предмет тейк-профита, а к старту следующей свечи позиция всегда обнуляется.

## Управление объёмом и защита
- **Мартингейл**. Параметр `VolumeMultiplier` повторяет множитель из MetaTrader. Если какая-либо нога дожила до принудительного закрытия, следующий цикл использует объём крупнейшей ноги, умноженный на этот коэффициент. Профитный цикл (обе ноги закрыты по цели) возвращает объём к `InitialVolume`.
- **Ограничение объёма**. `MaxVolume` — жёсткий предел: как только расчёт превысил его (или `Security.MaxVolume`), объём сбрасывается к базовому значению.
- **Соответствие бирже**. Все объёмы подгоняются под `VolumeStep` и отклоняются, если меньше `MinVolume`. Убедитесь, что `InitialVolume` укладывается в требования площадки.
- **Расчёт шага цены**. Смещение тейк-профита умножает `TakeProfitPoints` на `Security.PriceStep` (или `MinPriceStep`, если основной шаг не задан). При нулевом шаге тейк-профит фактически отключается.

## Параметры
| Название | Тип | Значение по умолчанию | Описание |
| --- | --- | --- | --- |
| `CandleType` | `DataType` | Таймфрейм 1 минута | Основная свечная серия, задающая частоту входов. |
| `InitialVolume` | `decimal` | `1` | Объём первой пары, если прошлый цикл завершился без открытых ног. |
| `VolumeMultiplier` | `decimal` | `2` | Множитель для максимальной ноги предыдущего цикла. |
| `MaxVolume` | `decimal` | `10` | Верхний предел объёма перед сбросом на `InitialVolume`. |
| `TakeProfitPoints` | `int` | `50` | Дистанция в пунктах для расчёта тейк-профита каждой ноги. Значение `0` отключает тейк-профит и оставляет только принудительное закрытие на следующем баре. |

## Особенности реализации и отличия от MQL5
- Ноги портфеля хранятся во внутреннем списке `_legs`, чтобы стратегия могла различать длинную и короткую часть, даже если коннектор поддерживает только неттинг.
- Тейк-профит определяется по диапазону завершившейся свечи (High/Low), что соответствует "побарному" подходу и делает поведение детерминированным.
- Параметры `slippage` и `magic number` из MetaTrader не используются: маршрутизация заявок полностью возлагается на StockSharp.
- Заявки отправляются через `BuyMarket` и `SellMarket` без добавления индикаторов в `Strategy.Indicators`, полностью следуя рекомендациям репозитория.

## Практические рекомендации
- Подбирайте `InitialVolume` согласно шагу объёма инструмента — стратегия не нормализует параметр автоматически.
- Для инструментов с маленьким шагом цены уменьшите `TakeProfitPoints`, иначе цель может оказаться слишком далёкой.
- Стратегия одновременно открывает встречные позиции. Используйте коннекторы и счета, где разрешено хеджирование. В неттинговой среде логика `_legs` сохраняется, но фактическое исполнение брокера может отличаться.
- Добавьте стратегию на график, чтобы видеть свечи и совершённые сделки (`DrawCandles` и `DrawOwnTrades` включены в `OnStarted`).
