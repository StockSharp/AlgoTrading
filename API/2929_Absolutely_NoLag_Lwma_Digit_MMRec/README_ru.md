# Стратегия AbsolutelyNoLagLWMA Digit MMRec

## Идея

Это перенос на StockSharp советника MetaTrader *Exp_AbsolutelyNoLagLwma_Digit_NN3_MMRec*. Сохранена исходная многотаймфреймовая архитектура на основе индикатора «AbsolutelyNoLagLWMA» и правила восстановления объёма (`MMRec`). Три независимых модуля (A/B/C) анализируют свечи 12h, 4h и 2h. Каждый модуль управляет своей долей позиции, а стратегия суммирует общий результат.

Внутри каждого модуля строится двойная взвешенная скользящая средняя (WMA от WMA) выбранного ценового ряда. Полученное значение округляется до указанного количества знаков, как в исходном индикаторе. Изменение наклона сглаженной линии (значение стало расти после падения и наоборот) трактуется как смена тренда и запускает торговые действия модуля.

## Правила торговли

1. Дождаться закрытия свечи соответствующего таймфрейма.
2. Выбрать цену согласно параметру (`close`, `open`, `median`, `typical` и т.д.).
3. Передать цену через основную WMA и затем через вторую WMA, получая аналог "AbsolutelyNoLagLWMA".
4. Округлить результат до нужного количества знаков и сравнить с предыдущим значением.
5. **Рост линии** (`value > previous`):
   - Закрыть короткую долю модуля, если разрешено закрытие шортов.
   - Если включён вход в лонг и сейчас нет длинной позиции, открыть покупку текущим объёмом модуля.
   - Пересчитать уровни стоп-лосса и тейк-профита в шагах цены для длинной доли.
6. **Падение линии** (`value < previous`):
   - Закрыть длинную долю модуля, если разрешено закрытие лонгов.
   - Если разрешены продажи и короткая позиция отсутствует, открыть шорт.
   - Обновить защитные уровни для короткой доли.
7. На каждой свече модуль проверяет, пробили ли максимум/минимум текущие уровни стопа или тейка. При срабатывании позиция закрывается по соответствующей цене, а результат попадает в систему управления капиталом.
8. Денежное управление хранит результаты последних сделок для каждого направления. Если последние *N* сделок (где *N* равно триггеру) были убыточными, следующий ордер используется с уменьшенным объёмом, иначе — с нормальным. Для оценки результата берутся цена входа (запоминается при открытии) и цена выхода (стоп/тейк/закрытие по сигналу).

Входы и выходы выполняются рыночными ордерами. Для сигналов предполагается исполнение по цене закрытия свечи, а для стопов/тейков — по защитной цене.

## Параметры

Набор параметров у всех модулей одинаков; значения по умолчанию повторяют оригинал.

| Параметр | Описание |
|----------|----------|
| `ACandleType` / `BCandleType` / `CCandleType` | Таймфрейм свечей модуля (по умолчанию 12ч / 4ч / 2ч). |
| `ALength` / `BLength` / `CLength` | Период сглаживания AbsolutelyNoLagLWMA (для обеих WMA). |
| `AAppliedPrice` / `BAppliedPrice` / `CAppliedPrice` | Источник цены (close, open, high, low, median, typical, weighted, simple, quarter, TrendFollow1, TrendFollow2, Demark). |
| `ADigits` / `BDigits` / `CDigits` | Количество знаков для округления сглаженного значения. |
| Флаги `ABuyOpen`, `ASellOpen`, `ABuyClose`, `ASellClose` и аналоги для B/C | Разрешения на открытия/закрытия лонгов и шортов в модуле. |
| `ASmallVolume`, `ANormalVolume` | Уменьшенный и обычный объём заявок (используются и для покупок, и для продаж). |
| `ABuyLossTrigger`, `ASellLossTrigger` | Число подряд убыточных сделок, после которого модуль переходит на уменьшенный объём (для лонгов/шортов). |
| `AStopLossPoints`, `ATakeProfitPoints` | Стоп-лосс и тейк-профит в шагах цены для доли модуля. Аналогичные параметры есть у B и C. |

Очереди результатов очищаются, если соответствующий триггер равен нулю. Расчёт шагов цены опирается на `Security.Step`; при его отсутствии используется значение `1`.

## Особенности

- Каждый модуль ведёт собственный объём, поэтому одновременно могут существовать разнонаправленные позиции разных модулей. Итоговая позиция стратегии — сумма всех долей.
- Контроль стопов и тейков выполняется на закрытой свече по экстремумам свечи.
- Перечень значений `AppliedPrice` полностью повторяет оригинальный индикатор, включая варианты TrendFollow и формулу DeMark.
- Индикаторы не добавляются в коллекцию стратегии — всё связывается через `Bind`, что соответствует требованиям руководства.
- Сделки совершаются только при смене наклона, что предотвращает повторные ордера на последовательных барах с тем же направлением.
