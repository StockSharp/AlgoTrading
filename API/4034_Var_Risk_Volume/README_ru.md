# Стратегия VaR Risk Volume

## Обзор
Стратегия является портом скрипта MetaTrader 4 `ACB4.MQ4`, а именно функции `amd.OperationVolume`. Исходный код вычислял максимально допустимый объем позиции, чтобы потенциальный убыток при заданном расстоянии в пунктах не превышал установленный предел VaR (Value-at-Risk). Реализация на C# использует метаданные инструмента в StockSharp (минимальный объем, шаг объема, требования по марже, цена шага и стоимость шага) и воспроизводит ту же последовательность расчетов. Итоговый лот записывается в свойство `Strategy.Volume`, чтобы им могли воспользоваться другие алгоритмы.

Это вспомогательная стратегия управления риском — она не отправляет заявки, а лишь анализирует параметры инструмента и портфеля. При запуске она оценивает минимальный требуемый объем, пересчитывает лимит маржи, приводит значение к биржевому шагу и выводит подробные лог-сообщения с результатами.

## Параметры
- **VaR Limit** – максимальный допустимый убыток в валюте счета (аналог `avd.VARLimit`).
- **VaR Points** – расстояние между точкой входа и уровнем риска в пунктах (аналог `aai.VARPoints`).
- **Log Details** – включает подробный вывод всех промежуточных величин, как и `Alert` в оригинальном MQL-скрипте.

Для параметров настроены подсказки и диапазоны оптимизации, что позволяет проводить стресс-тестирование из интерфейса StockSharp.

## Последовательность расчетов
1. Считываются свойства инструмента: `MinVolume`, `VolumeStep`, `MarginBuy`/`MarginSell`, `StepPrice`, `PriceStep`, `MinPriceStep`.
2. На их основе вычисляются минимальная маржа, минимальная стоимость тика и минимальная стоимость пункта для наименьшего объема.
3. Определяется, сколько пунктов требуется, чтобы перекрыть эту маржу, и переводится значение **VaR Points** в допустимое число «позиций» внутри VaR-бюджета.
4. Рассчитывается максимальный объем исходя из маржинальных ограничений, после чего значение приводится к шагу объема и ограничивается `MaxVolume`, если биржа его предоставляет.
5. Результат сохраняется в `OperationVolume` и устанавливается в `Strategy.Volume`.

Если какой-либо из обязательных параметров отсутствует (например, брокер не выдает `MinVolume` или `StepPrice`), стратегия фиксирует недостающие поля, пишет предупреждение и устанавливает расчетный объем в ноль.

## Логирование и диагностика
При включенной опции **Log Details** стратегия выводит блок сообщений, полностью повторяющий `Alert` из MT4:
- промежуточные значения (минимальная маржа, стоимость тика, стоимость пункта, рассчитанный лимит объема);
- исходные входные данные (идентификатор инструмента, VaR limit, VaR points, валюта портфеля);
- текущая и начальная стоимость портфеля, если брокер их предоставляет.

Список отсутствующих параметров доступен через свойство `MissingFields`, что облегчает диагностику проблем с поставщиком данных.

## Использование
1. Назначьте стратегии инструмент и портфель с доступными данными по марже и тикам.
2. Настройте **VaR Limit** и **VaR Points** в соответствии с допустимым риском.
3. Запустите стратегию. Она сразу выполнит расчет, запишет результат в лог и вызовет `StartProtection()`, следуя общему шаблону примеров.
4. Считайте рекомендуемый объем из `OperationVolume` или напрямую из `Strategy.Volume` и применяйте его в собственных торговых модулях.

Если в журнале появляются предупреждения об отсутствующих данных, проверьте настройки инструмента или запросите недостающие параметры у брокера. Без полной информации по марже и тикам расчеты VaR невозможны.

## Особенности реализации
- Весь код использует табуляцию для отступов и английские комментарии, как требуется в репозитории.
- Применяется только высокоуровневый API, дополнительные коллекции не создаются.
- Подписки на свечи или тиковые данные не нужны: расчет выполняется один раз в `OnStarted`. Для пересчета достаточно сбросить или перезапустить стратегию после изменения параметров.
