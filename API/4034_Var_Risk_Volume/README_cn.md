# VaR风险仓位策略

## 概览
本策略将 MetaTrader 4 脚本 `ACB4.MQ4` 中的 `amd.OperationVolume` 计算过程移植到 StockSharp 高级 API。原始脚本会在给定点数损失的前提下，计算在 VaR（Value-at-Risk）限制内所能承担的最大下单量。C# 版本使用交易品种的元数据（最小手数、手数步长、保证金需求、最小报价变动及其货币价值），复现相同的算法，并把结果写入 `Strategy.Volume`，便于其他组件直接调用。

与传统自动化交易系统不同，该策略不会发送任何委托，而是充当风险管理助手。它在启动时读取证券信息，推导出最小保证金、最小 tick 价值、最小点值以及可承担的最大交易量，并在计算成功后将所有中间结果记录到日志中。

## 参数
- **VaR Limit** – 账户货币计价的最大允许亏损，对应 MQL 版本中的 `avd.VARLimit`。
- **VaR Points** – VaR 场景下的价格距离（点数），对应 `aai.VARPoints`。
- **Log Details** – 是否打印与原脚本 `Alert` 输出相同的详细调试信息。

所有参数均设置了优化信息，可在 StockSharp 界面中进行回测或敏感度分析。

## 计算流程
1. 读取证券属性：`MinVolume`、`VolumeStep`、`MarginBuy`/`MarginSell`、`StepPrice`、`PriceStep` 与 `MinPriceStep`。
2. 计算最小手数所需保证金、最小 tick 价值以及最小点值。
3. 根据最小点值确定抵消最小保证金所需的点数，再结合 **VaR Points** 推导 VaR 预算可承受的仓位数量。
4. 将剩余保证金转换为原始下单量，并按照交易所手数步长取整；如证券给出了 `MaxVolume`，则按上限截断。
5. 将最终结果保存到 `OperationVolume`，并写入 `Strategy.Volume`。

若某些关键参数缺失（例如券商未提供 `MinVolume` 或 `StepPrice`），策略会记录缺失字段、给出警告，并把运算结果置零。

## 日志与诊断
当 **Log Details** 为真时，策略会输出一组与 MT4 脚本完全一致的日志，包括：
- 最小保证金、最小 tick、最小点值、体积上限等中间变量；
- 输入参数（品种标识、VaR 限额、VaR 点数、投资组合货币）；
- 如可用，则输出投资组合的当前价值与初始价值。

同时，`MissingFields` 属性会列出缺失的证券属性，方便排查数据源问题。

## 使用步骤
1. 在策略上设置目标证券与投资组合，并确保券商提供保证金与 tick 信息。
2. 根据风险承受能力配置 **VaR Limit** 与 **VaR Points**。
3. 启动策略。它会立即执行计算、输出日志，并调用 `StartProtection()` 以遵循仓位保护模式。
4. 从 `OperationVolume` 或 `Strategy.Volume` 读取建议手数，并在其他自动化策略中引用。

若日志提示缺少参数，请检查证券设置或向券商申请补充数据。在缺乏完整保证金与 tick 信息的情况下，VaR 仓位管理无法正常工作。

## 实现细节
- 代码严格使用制表符缩进，内联注释仅使用英文，符合仓库规范。
- 实现完全基于高级 API，不创建额外的数据集合。
- 不需要订阅 K 线或逐笔数据；计算在 `OnStarted` 中执行一次，如需重新评估可重置或重新启动策略。
