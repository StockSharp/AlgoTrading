# Стратегия Flat Trend

## Обзор
**Flat Trend Strategy** переносит логику оригинального советника Flat Trend, объединяя многоуровневые трендовые фильтры, подтверждение силой тренда по ADX и волатильностный фильтр на основе стандартного отклонения («juice»). Цель стратегии — распознать момент выхода цены из флэта и присоединиться к зарождающемуся движению с помощью продуманного риск-менеджмента.

## Логика торговли
1. **Трендовые фильтры** – три экспоненциальные скользящие средние (EMA) с настраиваемыми периодами: триггер, первый и второй фильтр. На основе положения цены и наклона каждой EMA определяется состояние:
   - Сильный бычий сигнал – цена выше EMA, EMA растет.
   - Умеренный бычий сигнал – цена выше EMA, наклон нейтрален.
   - Сильный медвежий сигнал – цена ниже EMA, EMA падает.
   - Умеренный медвежий сигнал – цена ниже EMA, наклон нейтрален.
2. **Условия входа**
   - Покупки выполняются, когда триггер и первый фильтр дают бычьи состояния; второй фильтр можно отключить.
   - Продажи симметричны условиям для покупок.
   - При включении фильтра ADX средний направленный индекс должен превышать порог, а опция `UseDirectionalFilter` дополнительно требует согласованности линий +DI и −DI с направлением сделки.
   - Фильтр «juice» проверяет, что стандартное отклонение превышает заданный уровень, тем самым отсекая периоды низкой волатильности.
   - Доступен фильтр торговых часов, ограничивающий работу стратегии определенным интервалом суток.
3. **Условия выхода**
   - Противоположный сигнал на триггерной EMA закрывает позицию; в строгом режиме ожидается только сильный противоположный сигнал.
   - Динамический стоп сопровождает сделку и закрывает позицию при касании уровня.

## Управление рисками
- **Начальный стоп** – задается фиксированным числом пунктов или вычисляется по ATR, что приближает логику к исходному ADR-стопу.
- **Трейлинг-стоп** – тянется за максимальной/минимальной ценой с использованием произведения ATR и коэффициента.
- **Переход в безубыток** – после достижения заданной прибыли стоп переносится за цену входа с фиксацией небольшой доли профита.

## Параметры
| Параметр | Описание |
| --- | --- |
| `TriggerLength` | Период EMA-триггера. |
| `FilterLength1` | Период первой EMA-фильтра. |
| `FilterLength2` | Период второй EMA-фильтра. |
| `UseOnlyPrimaryIndicators` | Использовать только триггер и первый фильтр. |
| `IgnoreModerateForEntry` | Для входа требуются только сильные сигналы. |
| `IgnoreModerateForExit` | Для выхода требуются только сильные встречные сигналы. |
| `UseTradingHours` | Включить фильтр торговых часов. |
| `TradingHourBegin` / `TradingHourEnd` | Начало и конец торгового окна. |
| `UseJuiceFilter`, `JuicePeriod`, `JuiceThreshold` | Настройки фильтра стандартного отклонения. |
| `UseAdxFilter`, `AdxPeriod`, `AdxThreshold`, `UseDirectionalFilter` | Параметры ADX и фильтра направлений. |
| `UseAdrForStop`, `StopLossPips` | Конфигурация стартового стопа. |
| `TrailingDivisor` | Коэффициент ATR для трейлинг-стопа. |
| `BreakEvenPips`, `BreakEvenLockPips` | Дистанция до безубытка и величина фиксируемой прибыли. |
| `AtrPeriod` | Период ATR для оценки волатильности. |
| `CandleType` | Тип свечей, по которым ведутся расчеты. |

## Набор индикаторов
- **EMA** – три скользящие для оценки тренда на разных «скоростях».
- **Standard Deviation** – фильтр волатильности, аналог индикатора Juice.
- **Average True Range** – определяет дистанцию стопов и трейлинга.
- **Average Directional Index** – подтверждает силу и направление тренда.

## Рекомендации по использованию
1. Убедитесь, что у инструмента задан шаг цены (`PriceStep`). При его отсутствии стратегия применит значение по умолчанию 0.0001.
2. Входы осуществляются рыночными заявками (`BuyMarket`, `SellMarket`); при смене направления стратегия автоматически закрывает противоположные позиции.
3. Трейлинг и безубыток реализованы через внутренний контроль цены: как только рынок пересекает виртуальный стоп, позиция закрывается рыночной заявкой.
4. Комбинируйте фильтр торговых часов со строгим режимом входа, чтобы сосредоточиться на ликвидных сессиях и снизить влияние флэтовых участков.
