# Стратегия Nevalyashka

## Обзор
Nevalyashka — это порт на C# оригинального советника MetaTrader 4 `Nevalyashka.mq4`. Советник постоянно меняет направление торговли: открывает единственную рыночную позицию, дожидается её закрытия по стопу, тейку или вручную и тут же переворачивается с тем же объёмом. Реализация на StockSharp повторяет эту логику и выносит ключевые настройки в параметры стратегии.

## Логика работы
1. **Инициализация**
   - При старте стратегия вычисляет размер пункта на основе `PriceStep` инструмента. Для форекс-инструментов с 3 или 5 знаками шаг умножается на 10, чтобы соответствовать понятию «поинт» в MetaTrader.
   - Метод `StartProtection` настраивает стоп-лосс и тейк-профит: указанные в пунктах расстояния переводятся в ценовые точки и автоматически привязываются к каждой новой позиции.
   - Отправляется начальная рыночная заявка в сторону, заданную параметром `InitialDirection` (по умолчанию — короткая позиция). Объём приводится к допустимому лоту с учётом `VolumeStep`, `MinVolume` и `MaxVolume` инструмента.

2. **Отслеживание позиции**
   - Метод `OnPositionChanged` фиксирует все изменения нетто-позиции. После открытия новой позиции стратегия запоминает фактически исполненный объём и направление сделки.
   - Как только позиция полностью закрывается и размер позиции возвращается к нулю, тут же создаётся новая рыночная заявка в противоположную сторону с тем же объёмом.

3. **Обработка ошибок**
   - При отказе торговой площадки в регистрации заявки сбрасывается внутренний флаг ожидаемого направления, чтобы оператор мог повторить попытку или скорректировать параметры без накопления некорректного состояния.

Таким образом бот постоянно находится в рынке и, как «неваляшка», чередует длинные и короткие позиции с фиксированными выходами.

## Параметры
| Имя | Описание | Значение по умолчанию | Примечание |
| --- | --- | --- | --- |
| `StopLossPips` | Дистанция защитного стопа в пунктах. | `50` | Переводится в ценовые точки через расчёт пункта; `0` отключает стоп. |
| `TakeProfitPips` | Дистанция тейк-профита в пунктах. | `50` | Аналогично стоп-лоссу, значение `0` отключает тейк. |
| `Volume` | Объём для первой сделки. | `1` | После первого исполнения стратегия переиспользует фактический объём всех следующих входов. |
| `InitialDirection` | Направление стартовой заявки. | `Sell` | Можно выбрать `Buy` или `Sell` в зависимости от желаемого начального смещения. |

## Особенности реализации
- Стратегии не требуется подписка на свечи или индикаторы — она реагирует исключительно на события по позициям и результатам заявок.
- Перед каждым входом вызывается `IsFormedAndOnlineAndAllowTrading()`, чтобы убедиться, что соединение и торговля доступны.
- Приведение объёма использует округление `MidpointRounding.AwayFromZero`, благодаря чему дробные лоты приводятся к допустимому значению, а не к нулю.
- Пересчёт пунктов опирается на метаданные инструмента, поэтому стратегия корректно работает с форексом, CFD и фьючерсами с различной точностью котировок.

## Отличия от MQL-версии
- В StockSharp-варианте направление первого входа задаётся параметром, тогда как исходный советник всегда начинал с продажи.
- Защитные ордера управляются через `StartProtection`, что обеспечивает совместимость с любыми коннекторами StockSharp.
- При отказах в регистрации заявок стратегия очищает внутреннее состояние ожидания, предотвращая повторную отправку заведомо некорректных заявок.

Благодаря этим улучшениям порт сохраняет идею оригинального советника и органично вписывается в высокоуровневый API StockSharp.
