# Стратегия Moving Average Shift

## Обзор

Стратегия представляет собой порт на StockSharp классического советника **Moving Average** из MetaTrader 4. Система анализирует завершённые свечи и сравнивает их с сдвинутой простой скользящей средней (SMA), чтобы определить смену направления. Сделки совершаются рыночными заявками, в рынке одновременно может находиться только одна позиция.

## Логика торговли

1. Подписка на свечи выбранного таймфрейма (по умолчанию 5 минут) и расчёт SMA с заданным периодом.
2. Сдвиг SMA на указанное количество завершённых свечей для имитации поведения функции `iMA` из MetaTrader.
3. Анализ предыдущей завершённой свечи:
   - **Бычий пробой** (открытие ниже SMA и закрытие выше) открывает длинную позицию, если активных позиций нет.
   - **Медвежий пробой** (открытие выше и закрытие ниже SMA) открывает короткую позицию при отсутствии открытых позиций.
4. Управление выходом на тех же условиях:
   - Длинная позиция закрывается, когда последняя свеча пересекает SMA сверху вниз.
   - Короткая позиция закрывается, когда свеча пересекает SMA снизу вверх.
5. Одновременно поддерживается только одна позиция, что повторяет логику исходного советника, который последовательно чередовал покупки и продажи.

## Параметры

| Имя | Описание | Значение по умолчанию |
| --- | --- | --- |
| `CandleType` | Свечная серия для расчётов, выбирается любой таймфрейм `DataType`. | 5-минутный таймфрейм |
| `MovingPeriod` | Количество свечей в периоде SMA. | 12 |
| `MovingShift` | Сдвиг значения SMA в завершённых свечах, аналог аргумента `shift` у `iMA`. | 6 |
| `BaseVolume` | Базовый объём заявок для входа в позицию. Используется одинаково для длинных и коротких сделок. | 1 |

## Работа с индикатором

- Индикатор `SimpleMovingAverage` создаётся в `OnStarted` и связывается со свечами через высокоуровневый метод `Bind`.
- Выходные значения SMA попадают в небольшую очередь FIFO, что позволяет получить значение `MovingShift` свечей назад без ручного пересчёта индикатора.
- Очередь хранит только `MovingShift + 1` значений, поэтому объём памяти остаётся постоянным даже при большом сдвиге.

## Управление ордерами и рисками

- Заявки отправляются методами `BuyMarket`/`SellMarket`, размер задаётся параметром `BaseVolume`. При закрытии используется текущий модуль позиции, чтобы полностью выйти из сделки.
- В оригинале MetaTrader лоты менялись в зависимости от свободной маржи и серии убытков. В версии для StockSharp логика упрощена: пользователь самостоятельно задаёт объём через параметр, что избавляет от зависимости от брокерских метрик и сохраняет главные правила входа/выхода.

## Особенности конверсии

- Сигналы оцениваются по **предыдущей** свече, повторяя проверку `Volume[0] == 1` из MetaTrader, которая ждала появления нового бара.
- Обрабатываются только завершённые свечи (`CandleStates.Finished`), чтобы не реагировать на незакрытые бары.
- Стратегия использует вспомогательные методы StockSharp для отображения свечей, индикатора и сделок на графике при наличии области графика.

## Использование

1. Скомпилируйте стратегию в Designer, Shell или Runner.
2. Выберите инструмент и портфель.
3. Настройте параметры, если требуется другой таймфрейм, период или объём.
4. Запустите стратегию — она подпишется на свечи, будет отслеживать пересечения SMA и торговать по описанным правилам.

## Дополнительные идеи

- При необходимости добавить защитные стопы и цели через `StartProtection`.
- Заменить простую SMA на другой индикатор (EMA, LWMA и т.д.), сохранив текущую схему подписки.
- Реализовать масштабирование позиции, изменяя метод `GetEntryVolume`.
