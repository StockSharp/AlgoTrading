# Стратегия Multi Hedging Scheduler

## Описание
**Multi Hedging Scheduler Strategy** — это конвертация советника `MultiHedg_1.mq5` из MetaTrader 5 в инфраструктуру StockSharp. Стратегия рассчитана на счёта с поддержкой хеджирования и управляет до десяти инструментов одновременно. Она открывает позиции в заранее заданном направлении в пределах торгового окна и закрывает их либо по времени, либо при достижении заданных порогов по доходности/просадке капитала.

Для синхронизации используется поток свечей (по умолчанию минутный), который служит исключительно источником времени. Каждая завершённая свеча инициирует проверку условий на открытие и закрытие позиций, а также контроль риска по капиталу. Индикаторы не применяются.

## Логика работы
1. **Выбор инструментов.** До десяти символов могут быть включены параметрами `UseSymbolX`. Для каждого активированного инструмента стратегия ищет тикер через `SecurityProvider`, подписывается на свечи указанного таймфрейма и применяет единую логику.
2. **Торговое окно.** Когда время свечи попадает в интервал [`TradeStartTime`, `TradeStartTime + TradeDuration`), стратегия пытается открыть рыночную позицию с направлением `TradeDirection`. Если позиция в том же направлении уже есть, повторный вход не выполняется. При наличии обратной позиции объём увеличивается, чтобы развернуться в нужную сторону.
3. **Защита капитала.** При включённом `CloseByEquityPercent` стратегия сравнивает текущую стоимость портфеля с балансом на момент запуска. Превышение `PercentProfit` или просадка `PercentLoss` приводят к закрытию всех управляемых позиций.
4. **Временное закрытие.** Если активирован `UseTimeClose`, то при попадании времени в окно [`CloseTime`, `CloseTime + TradeDuration`) стратегия закрывает все позиции.
5. **Журналы.** Все действия (входы, срабатывание ограничений по капиталу, закрытие по времени) фиксируются через `LogInfo`.

## Параметры
| Параметр | Описание | Значение по умолчанию |
|----------|----------|-----------------------|
| `TradeDirection` | Направление всех сделок (`Buy` или `Sell`). | Buy |
| `TradeStartTime` | Время начала торгового окна. | 19:51 |
| `TradeDuration` | Длительность торгового и закрывающего окон. | 00:05:00 |
| `UseTimeClose` | Включает закрытие по времени. | true |
| `CloseTime` | Время начала окна закрытия. | 20:50 |
| `CloseByEquityPercent` | Включает выход по проценту капитала. | true |
| `PercentProfit` | Порог прибыли в процентах от стартового баланса. | 1.0 |
| `PercentLoss` | Порог просадки в процентах от стартового баланса. | 55.0 |
| `CandleType` | Тип свечей, используемый как таймер. | 1 минута |
| `UseSymbol0..9` | Разрешение торговли по каждому слоту. | true для 0–5, false для 6–9 |
| `Symbol0..9` | Тикер каждого слота (ID для `SecurityProvider`). | см. таблицу ниже |
| `Volume0..9` | Объём заявки для каждого слота. | 0.1–1.0 |

**Конфигурация по умолчанию**

| Слот | Вкл. | Символ | Объём |
|------|------|--------|-------|
| 0 | ✔ | EURUSD | 0.1 |
| 1 | ✔ | GBPUSD | 0.2 |
| 2 | ✔ | GBPJPY | 0.3 |
| 3 | ✔ | EURCAD | 0.4 |
| 4 | ✔ | USDCHF | 0.5 |
| 5 | ✔ | USDJPY | 0.6 |
| 6 | ✖ | USDCHF | 0.7 |
| 7 | ✖ | GBPUSD | 0.8 |
| 8 | ✖ | EURUSD | 0.9 |
| 9 | ✖ | USDJPY | 1.0 |

## Рекомендации по использованию
- Для точного воспроизведения поведения MT5 убедитесь, что торговый счёт поддерживает хеджирование. На неттинговых счетах стратегия автоматически перекрывает противоположные позиции при смене направления.
- Перед запуском проверьте, что значения `SymbolX` совпадают с идентификаторами в используемом источнике данных StockSharp (например, `EURUSD@FXCM`).
- Поток свечей служит только для синхронизации. При необходимости измените `CandleType` на другой таймфрейм.
- При перезапуске стратегия заново фиксирует стартовый баланс. Это нужно учитывать при оценке срабатывания порогов `PercentProfit` и `PercentLoss`.
- В стратегии нет индивидуальных стоп-лоссов и тейк-профитов — выходы контролируются только глобальными условиями.

## Особенности конверсии
- В MT5 советник работал на `OnTick`. В StockSharp логика привязана к завершённым свечам, что соответствует высокоуровневому API и упрощает управление подписками.
- Проверка `magic number` заменена фильтрацией списка отслеживаемых инструментов. Метод `CloseAllManagedPositions` закрывает только те позиции, которые открывала стратегия.
- Звуковые оповещения и комментарии на графике не перенесены; вместо них используется журнал `LogInfo`.
