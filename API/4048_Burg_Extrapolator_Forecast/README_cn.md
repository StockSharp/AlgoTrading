# Burg Extrapolator 策略

## 概述
Burg Extrapolator 策略是 MetaTrader 4 专家顾问“Burg Extrapolator”的 StockSharp 版本。原始脚本使用 Burg 自回归模型对一段滑动窗口的开盘价（或其动量/变化率转换）进行拟合，并生成未来价格路径的预测。交易决策来自预测路径中的极值：当预计的单向波动足够大时，策略会增加该方向的仓位；如果相反方向先出现极值，则平掉当前持仓。本移植保留了原算法结构，同时把仓位管理和资金管理改写为 StockSharp 的高层 API 风格。

## 交易逻辑
1. **数据准备**
   - 为所选 `CandleType` 收集 `PastBars + 1` 根开盘价历史。
   - 可以把原始价格转换为对数动量（默认）或百分比变化率，再输入 Burg 模型。使用原价时会减去滑动平均值，以保持与 MT4 版本一致。
2. **Burg 线性预测**
   - 通过 Burg 算法计算到 `PastBars * ModelOrder` 阶的反射系数。
   - 递归展开 AR 模型，生成未来若干步的预测值（实际覆盖到 `PastBars` 步）。必要时把预测值转换回绝对价格。
3. **信号判定**
   - 扫描预测序列，记录第一处高点和低点，再衡量两者之间的距离。若距离超过 `MaxLoss` 或 `MinProfit`（与品种 `PriceStep` 相乘换算为价格差），就生成对应的开仓或平仓指令。
   - 预测出现大幅上涨则触发 `OpenSignal = 1`，大幅下跌触发 `OpenSignal = -1`。若先出现相反的极值，则设置 `CloseSignal`，即便没有新的入场计划也会先退出当前仓位。
4. **下单与保护**
   - 保护性逻辑（止损、止盈、跟踪止损）优先执行。跟踪止损会保存自入场以来的最佳价格，当价格回撤 `TrailingStop` 个点时平仓，等同于 MT4 中移动止损的效果。
   - 若信号要求反向平仓，则根据当前净头寸发送对应数量的市价单以清仓。
   - 入场信号会按方向叠加仓位，直至达到 `MaxTrades`。单次下单量按照 `1 + existingTrades * MaxRisk` 的系数线性放大，这是对 MT4 保证金计算的简化，适合在 StockSharp 中使用。

## 数据与指标
- 订阅 `CandleType` 定义的 K 线（默认 30 分钟）。
- 内置 Burg 自回归预测模块（无需额外指标）。
- 可选的对数动量和百分比变化率转换。

## 参数
| 名称 | 默认值 | 说明 |
| --- | --- | --- |
| `CandleType` | 30 分钟 K 线 | 策略使用的主要时间框架。 |
| `MaxRisk` | 0.5 | 叠加仓位时使用的风险系数。 |
| `MaxTrades` | 5 | 单方向最多允许的仓位数。 |
| `MinProfit` | 160 | 开仓所需的最小预测利润（点数）。 |
| `MaxLoss` | 130 | 触发平仓的最大预测亏损（点数）。 |
| `TakeProfit` | 0 | 固定止盈点数（0 表示关闭）。 |
| `StopLoss` | 180 | 固定止损点数（0 表示关闭）。 |
| `TrailingStop` | 10 | 跟踪止损点数，仅在设置了止损时启用。 |
| `PastBars` | 200 | Burg 模型使用的历史长度。 |
| `ModelOrder` | 0.37 | Burg 模型阶数占 `PastBars` 的比例。 |
| `UseMomentum` | true | 是否使用对数动量。 |
| `UseRateOfChange` | false | 是否使用百分比变化率（若启用动量则忽略）。 |

所有参数都实现为 `StrategyParam<T>`，可以在 StockSharp Designer 中调节或优化。

## 实现说明
- Burg 算法按照 MT4 版本的递推关系用 C# 重写，内部计算使用 `double`，最终信号判断前再转换为 `decimal`。
- 原脚本依赖账户可用保证金计算手数。StockSharp 版本改为基于 `Volume` 和 `MaxRisk` 的线性放大：把 `Volume` 设为基础手数，后续加仓会按风险系数增量。
- 止损、止盈与跟踪止损都通过发送市价单实现，以符合 StockSharp 的高层 API，并避免在仿真环境中保留挂单状态。
  
- 调整 `PastBars` 或 `ModelOrder` 时会重新创建内部数组，因此运行中修改参数会立即影响预测模型。
- 策略默认在图表上绘制 K 线和成交，可在 Designer 中进一步添加自定义序列来展示预测曲线。
