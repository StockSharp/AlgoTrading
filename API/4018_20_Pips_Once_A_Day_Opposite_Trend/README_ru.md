# TwentyPipsOnceADayStrategy

Стратегия представляет собой перенос эксперта MetaTrader **20pipsOnceADayOppositeLastNHourTrend** на высокоуровневый API StockSharp. Алгоритм один раз в сутки (в выбранный час) открывает позицию против движения, произошедшего за последние `N` часовых свечей. Размер позиции рассчитывается по схеме мартингейла и увеличивается только после убыточных сделок. Дополнительно реализованы контроль торговой сессии, опциональный трейлинг-стоп и ограничение времени удержания позиции.

## Логика торговли

1. Подписка на свечи заданного таймфрейма (по умолчанию один час, параметр `CandleType`).
2. После закрытия очередной свечи проверяется, совпадает ли час следующей свечи с `TradingHour`:
   - Сравнивается цена закрытия последней сформированной свечи с ценой закрытия `HoursToCheckTrend` часов назад.
   - Если рынок за этот период снижался, открывается длинная позиция.
   - Если рынок рос — открывается короткая позиция.
3. Одновременно допускается только одна открытая позиция (`MaxOrders = 1`).
4. Сделка получает фиксированный тейк-профит, опциональный стоп-лосс и трейлинг-стоп (все значения задаются в пунктах и автоматически переводятся в цену).
5. Если позиция удерживается дольше `OrderMaxAgeSeconds` либо следующий час не входит в список `TradingDayHours`, позиция закрывается принудительно.

## Управление капиталом

- Параметр `FixedVolume` задаёт базовый объём. Значение `0` включает риск-ориентированный расчёт `(стоимость портфеля * RiskPercent) / 1000`, что повторяет оригинальный эксперт.
- Полученный объём ограничивается как биржевыми параметрами инструмента (`VolumeMin`, `VolumeMax`, `VolumeStep`), так и пользовательскими `MinVolume` / `MaxVolume`.
- Лестница мартингейла реагирует только на убыточные сделки:
  - `FirstMultiplier` применяется, если последняя сделка закрылась с убытком.
  - `SecondMultiplier` срабатывает, если последняя сделка прибыльная, но предпоследняя была убыточной.
  - Аналогично для `ThirdMultiplier`, `FourthMultiplier` и `FifthMultiplier` — всего пять ступеней, как в исходном коде MT4.

## Параметры

| Параметр | Описание |
|----------|----------|
| `FixedVolume` | Фиксированный объём сделки; `0` — использовать расчёт по риску. |
| `MinVolume` / `MaxVolume` | Минимальный и максимальный объём после всех вычислений. |
| `RiskPercent` | Доля портфеля, переводимая в объём при `FixedVolume = 0`. |
| `MaxOrders` | Максимум одновременно открытых позиций (по умолчанию 1). |
| `TradingHour` | Час (0-23), в который разрешается открывать новую позицию. |
| `TradingDayHours` | Разрешённые часы для сопровождения позиции. Можно указывать диапазоны, например `0-6,12-23`. |
| `HoursToCheckTrend` | Количество часовых свечей для оценки тренда. |
| `OrderMaxAgeSeconds` | Максимальное время удержания позиции в секундах. |
| `FirstMultiplier` … `FifthMultiplier` | Множители мартингейла для пяти последних убыточных сделок. |
| `StopLossPips` | Размер начального стоп-лосса в пунктах (`0` — без стопа). |
| `TrailingStopPips` | Размер трейлинг-стопа в пунктах (`0` — без трейлинга). |
| `TakeProfitPips` | Размер тейк-профита в пунктах. |
| `CandleType` | Тип свечей для расчётов (по умолчанию часовые). |

## Контроль рисков и выходы

- **Стоп-лосс / тейк-профит**: выставляются исходя из параметров `StopLossPips` и `TakeProfitPips`.
- **Трейлинг-стоп**: при достижении заданной прибыли стоп переносится вслед за ценой.
- **Лимит по времени**: по истечении `OrderMaxAgeSeconds` позиция закрывается по текущей цене свечи.
- **Фильтр по времени**: если следующий час не входит в `TradingDayHours`, позиция закрывается.

## Рекомендации по использованию

- Требуются исторические и онлайн данные по часовым свечам, а также корректно заданный `PriceStep`. При инструментах с дробным пунктом (3 или 5 знаков) размер пункта пересчитывается автоматически.
- Для воспроизведения поведения оригинального эксперта оставьте `CandleType` равным одному часу и разрешите полный диапазон `TradingDayHours` от 0 до 23.
- Лестница мартингейла хранит максимум пять последних результатов; при сбросе стратегии история очищается.
- В рамках задания реализована только версия на C#; Python-реализация не создавалась.

## Состав директории

- `CS/TwentyPipsOnceADayStrategy.cs` — исходный код стратегии.
- `README.md` — описание на английском языке.
- `README_cn.md` — описание на китайском языке.
- `README_ru.md` — русскоязычное описание (текущий файл).
