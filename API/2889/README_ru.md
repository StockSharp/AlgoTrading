# Стратегия Blau Ergodic MDI Time

## Общее описание

**Blau Ergodic MDI Time Strategy** — перенос советника MetaTrader `Exp_BlauErgodicMDI_Tm.mq5` на платформу StockSharp. Стратегия работает на свечах повышенного таймфрейма и полностью повторяет три режима генерации сигналов оригинала: **Breakdown**, **Twist** и **CloudTwist**. Вся математика индикатора реализована внутри класса стратегии через последовательность экспоненциальных скользящих средних (EMA), что позволяет сохранить логику советника и одновременно использовать высокоуровневый API StockSharp.

Пайплайн расчёта соответствует осциллятору Blau Ergodic MDI:

1. Выбранная цена свечи сглаживается EMA с периодом `BaseLength`.
2. Из исходной цены вычитается сглаженное значение, формируя ряд разностей.
3. К ряду разностей последовательно применяются три EMA с периодами `FirstSmoothingLength`, `SecondSmoothingLength`, `ThirdSmoothingLength`.
4. Полученные значения масштабируются на шаг цены инструмента. Промежуточная величина используется как гистограмма, финальная — как сигнальная линия.

## Режимы сигналов

### Breakdown

* Анализируется значение гистограммы на `SignalBar` баров назад и на один бар старше.
* Если предыдущее значение положительное, а анализируемый бар опускается в ноль или ниже, стратегия готовит вход в лонг и, при необходимости, закрывает шорт.
* Если предыдущее значение отрицательное, а анализируемый бар поднимается в ноль или выше, формируется возможность открытия шорта и закрытия лонга.

### Twist

* Оценивает изменение наклона гистограммы.
* При росте наклона (бар `SignalBar + 1` меньше бара `SignalBar + 2`) и условии, что текущий анализируемый бар выше предыдущего, формируется сигнал на покупку и закрытие коротких позиций.
* При снижении наклона (бар `SignalBar + 1` больше бара `SignalBar + 2`) и текущем баре ниже предыдущего формируется сигнал на продажу и закрытие длинных позиций.

### CloudTwist

* Использует одновременно гистограмму и сглаженную сигнальную линию.
* Если на предыдущем баре гистограмма выше сигнальной линии, но текущий анализируемый бар опускается ниже, готовится покупка и фиксация шорта.
* Если на предыдущем баре гистограмма ниже сигнальной линии, а текущий бар поднимается выше, готовится продажа и закрытие лонга.

## Торговый фильтр по времени

Стратегия повторяет тайм-фильтр советника. Параметры `UseTimeFilter`, `StartHour`, `StartMinute`, `EndHour`, `EndMinute` задают торговую сессию.

* При `Start < End` торговля разрешена внутри текущих суток.
* При равных часах границы определяются минутами и создают короткое окно.
* При `Start > End` сессия переходит через полночь.

Когда торговля запрещена фильтром, стратегия закрывает открытые позиции и не открывает новые, пока окно снова не откроется.

## Управление риском

Параметры `StopLossPoints` и `TakeProfitPoints` задают расстояние стоп-лосса и тейк-профита в шагах цены. После входа позиция получает соответствующие уровни. Каждый завершённый бар проверяет, достигла ли свеча защитных уровней, и мгновенно закрывает позицию при срабатывании.

## Источники цены

Перечень режимов `PriceMode` полностью повторяет оригинальный индикатор:

| Режим | Описание |
| ----- | -------- |
| Close | Цена закрытия. |
| Open | Цена открытия. |
| High | Максимум свечи. |
| Low | Минимум свечи. |
| Median | (High + Low) / 2. |
| Typical | (High + Low + Close) / 3. |
| Weighted | (High + Low + 2 × Close) / 4. |
| Simple | (Open + Close) / 2. |
| Quarter | (Open + High + Low + Close) / 4. |
| TrendFollow0 | High для бычьих свечей, Low для медвежьих, Close при равенстве. |
| TrendFollow1 | Среднее между Close и экстремумом в сторону движения свечи. |
| Demark | Цена Demark, взвешенная направлением свечи. |

## Параметры

| Параметр | Значение по умолчанию | Описание |
| -------- | --------------------- | -------- |
| `Mode` | Twist | Выбор режима сигналов Breakdown / Twist / CloudTwist. |
| `PriceMode` | Close | Источник цены для расчёта индикатора. |
| `BaseLength` | 20 | Период EMA исходной цены. |
| `FirstSmoothingLength` | 5 | Период первой EMA ряда разностей. |
| `SecondSmoothingLength` | 3 | Период второй EMA. |
| `ThirdSmoothingLength` | 8 | Период третьей EMA. |
| `SignalBar` | 1 | Сдвиг по барам, использующийся для проверки сигналов. |
| `AllowLongEntry` / `AllowShortEntry` | true | Разрешение на вход в лонг / шорт. |
| `AllowLongExit` / `AllowShortExit` | true | Разрешение на выход из лонга / шорта. |
| `UseTimeFilter` | true | Активация торгового окна. |
| `StartHour`, `StartMinute`, `EndHour`, `EndMinute` | 0/0/23/59 | Границы торговой сессии. |
| `StopLossPoints` | 1000 | Расстояние стоп-лосса в шагах цены (0 — отключить). |
| `TakeProfitPoints` | 2000 | Расстояние тейк-профита в шагах цены (0 — отключить). |
| `CandleType` | 4 часа | Таймфрейм свечей для расчёта. |
| `Volume` | 0.1 | Объём заявки, соответствует параметру MM в советнике. |

## Правила торговли

1. Подписаться на свечи указанного таймфрейма.
2. На каждой завершённой свече обновлять четыре стадии EMA и сохранять значения гистограммы и сигнальной линии.
3. Дождаться формирования необходимой истории (аналог MetaTrader-переменной `min_rates_total`).
4. В зависимости от режима проверить условия на баре `SignalBar` и выставить флаги открытия/закрытия.
5. В первую очередь закрывать позиции, если сработал флаг выхода либо время вне торговой сессии.
6. Открывать новую позицию только при разрешённом флаге, активном торговом окне и отсутствии позиции в том же направлении. При развороте объём автоматически учитывает текущую позицию.
7. Контролировать защитные уровни по экстремумам свечи и закрывать позицию при их достижении.

## Примечания

* Исходник следует требованиям репозитория: используются табуляции, логика написана на высокоуровневом API, не создаются лишние коллекции.
* Метод `StartProtection()` вызывается один раз при запуске для синхронизации защитных механизмов StockSharp с позицией.
* Сглаживание выполняется EMA. Для экспериментов с другими методами можно варьировать периоды, что позволит приблизить поведение к версиям JJMA/Vidya/AMA из MetaTrader.

## Как запустить

1. Добавьте класс стратегии в проект StockSharp и соберите решение.
2. Настройте параметры инструмента, таймфрейм, режим сигналов, торговое окно и уровни риска.
3. Подключите стратегию к коннектору, предоставляющему рыночные данные.
4. Запустите стратегию — она автоматически подпишется на свечи и будет управлять ордерами по описанным правилам.

