# Стратегия Forex Sky

## Обзор
**Forex Sky** — это порт советника MetaTrader `Forex_SKY.mq4`. Стратегия торгует импульсами MACD и строго придерживается исходных ограничений: не больше одной сделки на свечу и не больше одного входа в сутки. Реализация на StockSharp полностью повторяет числовые пороги и переносит логику проверки из оригинального MQL-кода.

Данные берутся из таймфрейма `CandleType` (по умолчанию 15-минутные свечи). На закрытии каждой завершённой свечи вычисляется классический MACD (периоды 12/26/9).

## Торговая логика
- **Покупка** выполняется рыночным ордером, когда выполняются условия:
  - Текущая линия MACD выше нуля;
  - Значение также превышает `+0.00009`, подтверждая наличие импульса;
  - Хотя бы одно из трёх предыдущих значений MACD было меньше либо равно нулю, что фиксирует переход индикатора из отрицательной области.
- **Продажа** происходит рыночным ордером при выполнении одного из условий:
  - MACD ниже нуля, опускается ниже `-0.0004`, хотя бы одно из трёх предыдущих значений было неотрицательным, а значение четыре свечи назад не меньше `+0.001`;
  - **Или** значение MACD четыре свечи назад достигло `≥ +0.003`, что в оригинальном советнике немедленно открывает короткую позицию.
- **Управление позицией**: стратегия не повторяет сделки в рамках одной свечи и ограничивает себя одной сделкой в сутки — это прямой аналог проверок `Time0` и `CheckTodaysOrders()` в MQL. Защитные ордера создаются через `StartProtection`, поэтому их объём автоматически синхронизируется с текущей позицией.

Закрытие позиции осуществляется защитными ордерами или вручную, как и в MetaTrader-версии.

## Параметры
| Имя | Значение по умолчанию | Описание |
|-----|-----------------------|----------|
| `FastPeriod` | 12 | Период быстрой EMA в индикаторе MACD. |
| `SlowPeriod` | 26 | Период медленной EMA в MACD. |
| `SignalPeriod` | 9 | Период сигнальной EMA в MACD. |
| `TakeProfitPoints` | 100 | Дистанция до тейк-профита в пунктах инструмента. Цена рассчитывается как `значение × Security.PriceStep`. |
| `StopLossPoints` | 3000 | Дистанция до стоп-лосса в пунктах инструмента. |
| `TradeVolume` | 0.1 | Базовый объём рыночных ордеров (в лотах). |
| `CandleType` | 15-минутный таймфрейм | Таймфрейм, по которому строятся свечи и считается MACD. |

### Перевод пунктов в цену
Параметры `TakeProfitPoints` и `StopLossPoints` полностью соответствуют переменной `Point` из MQL4. Для пятизнакового форекс-инструмента (`PriceStep = 0.00001`):
- Тейк-профит: `100 × 0.00001 = 0.001` цены;
- Стоп-лосс: `3000 × 0.00001 = 0.03` цены.

## Управление рисками
После открытия позиции функция `StartProtection` автоматически выставляет тейк-профит и стоп-лосс. При срабатывании используются рыночные ордера, что полностью соответствует поведению MetaTrader. Чтобы отключить конкретный защитный ордер, установите соответствующий параметр в `0`.

## Особенности миграции
- Значения MACD сдвигаются и хранятся в полях класса, поэтому нет необходимости обращаться к индикатору с индексами, как это делалось через `iMACD(..., shift)`.
- Дневной лимит и запрет повторного входа на одной свече реализованы напрямую, что сохраняет дисциплину оригинального советника.
- Комментарии переведены на английский язык, индикатор обрабатывается через высокоуровневый `Bind`, без низкоуровневого доступа к значениям.

## Рекомендации по применению
- Подберите `CandleType` под таймфрейм вашей торговой системы — MetaTrader-скрипт работал на периоде активного графика.
- При торговле волатильными инструментами можно увеличить пороги MACD, чтобы сохранить число сигналов на приемлемом уровне.
- Сброс дневного лимита привязан к дате открытия свечи, поэтому убедитесь, что серверное время соответствует вашей торговой сессии.
