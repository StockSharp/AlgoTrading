# Стратегия Anubis

## Обзор
Стратегия Anubis сочетает многофреймовый анализ волатильности и моментума, чтобы отлавливать развороты после мощных встречных импульсов. Исходный советник MetaTrader 5 использовал индикаторы с таймфрейма H4 для фильтрации и сигналы M15 для точного входа. В StockSharp логика сохранена, адаптирована под высокоуровневый API и дополнена расширенным мониторингом состояния.

## Логика работы
- **Таймфреймы**
  - Основной таймфрейм сигналов: настраиваемый тип свечи (по умолчанию 15 минут).
  - Старший таймфрейм подтверждения: фиксированные 4-часовые свечи для CCI и стандартных отклонений.
- **Индикаторы**
  - *CCI* на H4 определяет зоны перекупленности/перепроданности.
  - *Два стандартных отклонения* на H4 измеряют волатильность и задают дистанцию тейк-профита.
  - *MACD* на основном таймфрейме подтверждает разворот моментума.
  - *ATR* на основном таймфрейме выявляет аномальные свечи для принудительных выходов.
- **Условия входа**
  - **Лонг:** CCI опускается ниже `-CciThreshold`, основная линия MACD пересекает сигнал снизу вверх, а предыдущее значение MACD было отрицательным.
  - **Шорт:** CCI поднимается выше `+CciThreshold`, основная линия MACD пересекает сигнал сверху вниз, а предыдущее значение MACD было положительным.
  - Перед набором новой позиции стратегия закрывает противоположное направление и контролирует минимальный шаг цены между входами.
- **Управление позицией**
  - Разрешено до `MaxLongPositions` или `MaxShortPositions` доливок одинакового объема `TradeVolume`.
  - Стоп-лосс и тейк-профит пересчитываются из параметров в пипсах с учётом шага цены и волатильности старшего таймфрейма.
  - После движения на `BreakevenPips` стоп переносится в безубыток.
- **Условия выхода**
  - Жёсткие стопы: проверка stop-loss/ take-profit на закрытии каждой свечи.
  - Свечной выход: позиция закрывается, если диапазон предыдущей свечи превышает `CloseAtrMultiplier × ATR`.
  - Выход по моментуму: при достаточной прибыли позиция закрывается, если MACD разворачивается против сделки и прибыль выше `ThresholdPips`.

## Параметры
| Имя | Значение по умолчанию | Описание |
| --- | --- | --- |
| `TradeVolume` | 1 | Объём заявки при каждом входе. |
| `CciThreshold` | 80 | Абсолютный уровень CCI на H4 для определения экстремумов. |
| `CciPeriod` | 11 | Длина CCI на старшем таймфрейме. |
| `StopLossPips` | 100 | Дистанция стоп-лосса в пипсах (0 — без стопа). |
| `BreakevenPips` | 65 | Прибыль в пипсах для перевода стопа в безубыток. |
| `ThresholdPips` | 28 | Дополнительная прибыль для закрытия по сигналу MACD. |
| `TakeStdMultiplier` | 2.9 | Множитель медленного стандартного отклонения при расчёте тейк-профита. |
| `CloseAtrMultiplier` | 2 | Множитель ATR для свечного выхода. |
| `SpacingPips` | 20 | Минимальный шаг цены между последовательными входами. |
| `MaxLongPositions` | 2 | Максимум одновременно открытых лонгов. |
| `MaxShortPositions` | 2 | Максимум одновременно открытых шортов. |
| `MacdFastLength` | 20 | Период быстрой EMA в MACD. |
| `MacdSlowLength` | 50 | Период медленной EMA в MACD. |
| `MacdSignalLength` | 2 | Период сигнальной линии MACD. |
| `AtrLength` | 12 | Длина ATR на основном таймфрейме. |
| `StdFastLength` | 20 | Период быстрого стандартного отклонения (для анализа волатильности). |
| `StdSlowLength` | 30 | Период медленного стандартного отклонения, задающего тейк-профит. |
| `CandleType` | 15-минутные свечи | Основной таймфрейм для MACD и ATR. |

## Рекомендации
- Старший таймфрейм жёстко фиксирован на уровне 4 часов. При необходимости адаптируйте параметр `CandleType`, чтобы синхронизировать стратегию с выбранным рынком.
- В StockSharp позиции ведутся нетто: противоположный сигнал закроет текущую позицию перед открытием новой.
- Стандартное отклонение рассчитывается по алгоритму StockSharp. Период `StdSlowLength` приближает EMA-гладкое отклонение оригинальной реализации.
- Перед запуском убедитесь, что у инструмента задан корректный `PriceStep`, иначе параметры в пипсах некорректно переведутся в абсолютные цены.
