# Стратегия Csv Example Expert
[English](README.md) | [中文](README_cn.md)

Конвертация эксперта MetaTrader 4 `CsvExampleExpert.mq4`. Стратегия постоянно держит одну рыночную позицию в выбранную сторону
и закрывает её по фиксированным тейк-профиту и стоп-лоссу, заданным в пунктах MetaTrader. После закрытия позиция открывается
снова в том же направлении. Дополнительно реализовано сохранение результатов сделок в CSV так же, как это делал оригинальный
советник.

## Подробности

- **Вход**: как только стратегия запущена и нет активных заявок или позиции, отправляется рыночная заявка в сторону, указанную в
  параметре `TradeDirection`.
- **Выход**: цены отслеживаются через поток Level1 (лучшие bid/ask). Длинная позиция закрывается, когда цена ask достигает тейка
  или стопа относительно цены входа. Для короткой позиции используется цена bid с теми же расстояниями.
- **Управление позицией**: одновременно допускается только одна позиция. Сразу после закрытия инициируется новая заявка в ту же
  сторону, что обеспечивает непрерывное нахождение в рынке аналогично исходному эксперту.
- **Данные**: требуется только подписка на Level1, так как логика опирается исключительно на обновления bid/ask.
- **CSV-лог**: при включении `WriteCloseData` файл создаётся заново при старте, записывается заголовок, а затем добавляется строка
  на каждую закрытую сделку (`direction, gain, close price, close time, symbol, volume`). Для чисел используется инвариантная
  культура, чтобы формат совпадал с MT4.
- **Значения по умолчанию**:
  - `TradeVolume` = 0.1 лота
  - `TakePoints` = 300 пунктов
  - `StopPoints` = 300 пунктов
  - `TradeDirection` = Sell
  - `WriteCloseData` = false
  - `FileName` = `CSVexpert/CSVexample.csv`
- **Фильтры**:
  - Категория: Следование тренду
  - Направление: Одна фиксированная сторона (выбор пользователя)
  - Индикаторы: Нет
  - Стопы: Фиксированный тейк и стоп
  - Сложность: Базовая
  - Таймфрейм: Тиковые/Level1 данные
  - Сезонность: Нет
  - Нейросети: Нет
  - Дивергенции: Нет
  - Уровень риска: Средний (постоянное нахождение в рынке)

## Соответствие параметров

| Параметр MT4       | Параметр StockSharp | Описание |
|--------------------|---------------------|----------|
| `TradedLot`        | `TradeVolume`       | Объём рыночной заявки. |
| `take`             | `TakePoints`        | Дистанция до тейк-профита в пунктах MetaTrader. |
| `stop`             | `StopPoints`        | Дистанция до стоп-лосса в пунктах MetaTrader. |
| `OpType`           | `TradeDirection`    | Направление поддерживаемой позиции (Buy или Sell). |
| `WriteCloseData`   | `WriteCloseData`    | Включает запись закрытых сделок в CSV. |
| `FileName`         | `FileName`          | Путь к CSV-файлу, совпадает со значением по умолчанию в советнике. |

## Особенности реализации

- Пункты MetaTrader переводятся в абсолютное расстояние по цене через шаг цены инструмента. Если биржа не отдаёт шаг, используется
  запасное значение `0.0001`, чтобы стратегия продолжала работать.
- Для записи результата сделки применяется изменение реализованной прибыли (`PnL`), что позволяет учитывать комиссию и проскальзывание.
- При работе с относительными путями директория `CSVexpert` создаётся автоматически при первом запуске.
