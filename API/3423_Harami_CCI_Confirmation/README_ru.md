# Стратегия Harami CCI Confirmation

## Обзор
Harami CCI Confirmation — порт советника MetaTrader 5 `Expert_ABH_BH_CCI` на высокий уровень StockSharp. Исходная система торгует разворотные паттерны «бычья беременная» и «медвежья беременная». Перед входом стратегия запрашивает подтверждение от осциллятора Commodity Channel Index (CCI) и сравнивает размер тела свечи со скользящей средней, чтобы убедиться, что длинная свеча действительно доминирует. Перенос сохраняет оригинальную логику подтверждений, обрабатывает только закрытые свечи и задействует встроенный в StockSharp модуль защиты.

## Логика стратегии
### Обнаружение паттернов
* **Средний размер тела** — поддерживается скользящее среднее абсолютной величины тел свечей за последние *N* баров (по умолчанию 5). Это повторяет вспомогательный класс MetaTrader, сглаживающий размер свечи и референс тренда.
* **Бычий Harami** — предыдущая свеча должна быть бычьей, ещё одна свеча назад — медвежья с телом длиннее среднего, а бычье тело должно полностью находиться внутри диапазона медвежьей свечи. Средняя точка более ранней свечи обязана лежать ниже средней закрытия, подтверждая нисходящий тренд.
* **Медвежий Harami** — зеркальные условия: предыдущая свеча медвежья, более ранняя свеча бычья и длинная, медвежье тело расположено внутри диапазона бычьей свечи, а её середина находится выше средней закрытия, что подтверждает восходящий тренд.

### Подтверждение CCI
* **Фильтр входа** — используется значение CCI с последней закрытой свечи (смещение 1). Для покупок CCI должен быть ниже `-EntryThreshold` (по умолчанию 50), для продаж — выше `+EntryThreshold`.
* **Выходная зона** — история CCI отслеживается на предмет пересечения уровня ±`ExitBand` (по умолчанию 80). Когда индикатор поднимается выше `-ExitBand`, стратегия закрывает открытые продажи. Когда опускается ниже `+ExitBand`, закрываются покупки. Это воспроизводит «голоса» оригинального советника, которые приводят к фиксации позиции.

### Управление сделками
* **Развороты** — при появлении подтверждённого противоположного сигнала стратегия регистрирует такой объём заявок, чтобы закрыть текущую позицию и открыть новую в противоположную сторону.
* **Защита** — вызывается `StartProtection()`, поэтому пользователь может задать стоп-лосс или тейк-профит через интерфейс StockSharp. Фиксированные уровни по умолчанию не используются, что соответствует настройкам оригинального советника с ручным управлением капиталом.

## Параметры
* **Order Volume** — базовый объём рыночных заявок. Дополнительный объём автоматически добавляется при развороте позиции.
* **CCI Period** — период осциллятора Commodity Channel Index.
* **Body Average** — количество свечей для расчёта среднего тела и средней цены закрытия.
* **CCI Entry** — минимальное абсолютное значение CCI, необходимое для принятия сигнала Harami.
* **CCI Exit Band** — величина зоны, определяющей выход по пересечению CCI.
* **Candle Type** — используемый таймфрейм (по умолчанию часовые свечи).

## Дополнительные замечания
* Все расчёты выполняются только по закрытым свечам, полученным через `SubscribeCandles`, чтобы сохранить модель исполнения MetaTrader.
* Стратегия хранит компактную историю свечей и значений CCI, что позволяет повторить алгоритм без создания индикаторных буферов.
* В каталоге представлена только C#-версия стратегии, Python-вариант отсутствует.
